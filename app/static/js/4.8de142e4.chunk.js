(window.webpackJsonppretenst=window.webpackJsonppretenst||[]).push([[4],{568:function(e,t){},570:function(e,t){},8:function(e,t,n){"use strict";n.r(t);var r=n(0),a=n.n(r),i=n(1),o=n(10),c=n(62),s=n(63),l=n(16),u=n(221),h=n(29),f=n(7),d=n(18),m=n(20);var g=Object.keys(f.WorldFeature).filter((function(e){return isNaN(parseInt(e,10))})).map((function(e){return f.WorldFeature[e]}));function v(e){switch(e){case f.IntervalRole.NexusPush:return"NP";case f.IntervalRole.ColumnPush:return"CP";case f.IntervalRole.Triangle:return"TR";case f.IntervalRole.Ring:return"RI";case f.IntervalRole.Cross:return"CR";case f.IntervalRole.BowMid:return"BM";case f.IntervalRole.BowEnd:return"BE";case f.IntervalRole.RibbonPush:return"RP";case f.IntervalRole.RibbonShort:return"RS";case f.IntervalRole.RibbonLong:return"RL";case f.IntervalRole.RibbonHanger:return"RH";case f.IntervalRole.FaceConnector:return"FC";case f.IntervalRole.FaceDistancer:return"FD";case f.IntervalRole.FaceAnchor:return"FA";case f.IntervalRole.SpherePush:return"SB";case f.IntervalRole.SpherePull:return"SC";default:return"?"}}var p,b=Object.keys(f.IntervalRole).filter((function(e){switch(f.IntervalRole[e]){case f.IntervalRole.NexusPush:case f.IntervalRole.ColumnPush:case f.IntervalRole.Triangle:case f.IntervalRole.Ring:case f.IntervalRole.Cross:case f.IntervalRole.BowMid:case f.IntervalRole.BowEnd:return!0;default:return!1}})).map((function(e){return f.IntervalRole[e]}));function y(e){switch(e){case f.IntervalRole.NexusPush:case f.IntervalRole.ColumnPush:case f.IntervalRole.RibbonPush:case f.IntervalRole.SpherePush:return!0}return!1}function w(e){switch(e){case f.WorldFeature.NexusPushLength:return f.IntervalRole.NexusPush;case f.WorldFeature.ColumnPushLength:return f.IntervalRole.ColumnPush;case f.WorldFeature.TriangleLength:return f.IntervalRole.Triangle;case f.WorldFeature.RingLength:return f.IntervalRole.Ring;case f.WorldFeature.CrossLength:return f.IntervalRole.Cross;case f.WorldFeature.BowMidLength:return f.IntervalRole.BowMid;case f.WorldFeature.BowEndLength:return f.IntervalRole.BowEnd;case f.WorldFeature.RibbonPushLength:return f.IntervalRole.RibbonPush;case f.WorldFeature.RibbonShortLength:return f.IntervalRole.RibbonShort;case f.WorldFeature.RibbonLongLength:return f.IntervalRole.RibbonLong;case f.WorldFeature.RibbonHangerLength:return f.IntervalRole.RibbonHanger;default:return}}function E(e){switch(e){case f.Stage.Growing:return"Growing";case f.Stage.Shaping:return"Shaping";case f.Stage.Slack:return"Slack";case f.Stage.Pretensing:return"Pretensing";default:return"Pretenst"}}function S(){var e=location.hash;return"#bridge"===e?p.Bridge:"#gotchi"===e?p.Gotchi:e.startsWith("#sphere")?p.Sphere:p.Design}function k(e){location.hash=e,location.reload()}function P(e){var t=e.toExponential(5),n=t.indexOf("e+0");return n>0?t.substring(0,n):Math.max(t.indexOf("e-1"),t.indexOf("e-2"))>0?e.toFixed(5):Math.max(t.indexOf("e+1"),t.indexOf("e+2"))>0?e.toFixed(1):t}!function(e){e.Design="design",e.Gotchi="gotchi",e.Bridge="bridge",e.Sphere="sphere"}(p||(p={}));var x,F,j,O=Math.sqrt(2);!function(e){e[e.XP=0]="XP",e[e.XN=1]="XN",e[e.YP=2]="YP",e[e.YN=3]="YN",e[e.ZP=4]="ZP",e[e.ZN=5]="ZN"}(x||(x={})),function(e){e[e.XPA=0]="XPA",e[e.XPO=1]="XPO",e[e.XNA=2]="XNA",e[e.XNO=3]="XNO",e[e.YPA=4]="YPA",e[e.YPO=5]="YPO",e[e.YNA=6]="YNA",e[e.YNO=7]="YNO",e[e.ZPA=8]="ZPA",e[e.ZPO=9]="ZPO",e[e.ZNA=10]="ZNA",e[e.ZNO=11]="ZNO"}(F||(F={})),function(e){e[e.NNN=0]="NNN",e[e.PNN=1]="PNN",e[e.NPN=2]="NPN",e[e.NNP=3]="NNP",e[e.NPP=4]="NPP",e[e.PNP=5]="PNP",e[e.PPN=6]="PPN",e[e.PPP=7]="PPP"}(j||(j={}));var R,C=[j.NNN,j.PNN,j.NPN,j.NNP,j.NPP,j.PNP,j.PPN,j.PPP];function N(e,t){if(e.alpha.index===t.index)return e.omega;if(e.omega.index===t.index)return e.alpha;throw new Error("Other of what?")}function V(e){var t=new l.Vector3;switch(e){case x.XP:return t.setX(1);case x.XN:return t.setX(-1);case x.YP:return t.setY(1);case x.YN:return t.setY(-1);case x.ZP:return t.setZ(1);case x.ZN:return t.setZ(-1);default:return t}}function I(e,t){return V(e).multiplyScalar(O/2).addScaledVector(V(t),O/2/1.61803398875)}!function(e){e[e.NN=0]="NN",e[e.PN=1]="PN",e[e.NP=2]="NP",e[e.PP=3]="PP"}(R||(R={}));var M=[{alpha:I(x.ZN,x.XP),omega:I(x.ZP,x.XP)},{alpha:I(x.ZN,x.XN),omega:I(x.ZP,x.XN)},{alpha:I(x.XN,x.YP),omega:I(x.XP,x.YP)},{alpha:I(x.XN,x.YN),omega:I(x.XP,x.YN)},{alpha:I(x.YN,x.ZP),omega:I(x.YP,x.ZP)},{alpha:I(x.YN,x.ZN),omega:I(x.YP,x.ZN)}],A=[{name:j.NNN,opposite:j.PPP,negative:!0,ring:R.NN,pushEnds:[F.YNA,F.XNA,F.ZNA],ringMember:[R.NP,R.PN,R.PP]},{name:j.PNN,opposite:j.NPP,negative:!1,ring:R.PP,pushEnds:[F.XNA,F.YPA,F.ZNO],ringMember:[R.PN,R.NN,R.NP]},{name:j.NPN,opposite:j.PNP,negative:!1,ring:R.PN,pushEnds:[F.XNO,F.YNA,F.ZPA],ringMember:[R.PP,R.NP,R.NN]},{name:j.NNP,opposite:j.PPN,negative:!1,ring:R.NP,pushEnds:[F.XPA,F.YNO,F.ZNA],ringMember:[R.NN,R.PN,R.PP]},{name:j.NPP,opposite:j.PNN,negative:!0,ring:R.PP,pushEnds:[F.YNO,F.XPO,F.ZPA],ringMember:[R.PN,R.NP,R.NN]},{name:j.PNP,opposite:j.NPN,negative:!0,ring:R.PN,pushEnds:[F.YPO,F.XPA,F.ZNO],ringMember:[R.PP,R.NN,R.NP]},{name:j.PPN,opposite:j.NNP,negative:!0,ring:R.NP,pushEnds:[F.YPA,F.XNO,F.ZPO],ringMember:[R.NN,R.PP,R.PN]},{name:j.PPP,opposite:j.NNN,negative:!1,ring:R.NN,pushEnds:[F.XPO,F.YPO,F.ZPO],ringMember:[R.NP,R.PP,R.PN]}];function T(e){return A[e].opposite}function D(e){return e||{_:100}}function L(e){return e._/100}function W(e){return{_:100*e}}function _(e,t,n){var r=!!t.joints.find((function(t){return t.index===e.index})),a=!!n.joints.find((function(t){return t.index===e.index}));if(r&&!a)return t;if(a&&!r)return n;throw new Error("Neither contained joint")}function B(e,t,n){var r=M.reduce((function(e,t){return e.push((new l.Vector3).add(t.alpha)),e.push((new l.Vector3).add(t.omega)),e}),[]),a=T(e),i=A[a].pushEnds.map((function(e){return r[e]})).reverse(),o=i.reduce((function(e,t){return e.add(t)}),new l.Vector3).multiplyScalar(1/3),c=(new l.Vector3).subVectors(i[0],o).normalize(),s=(new l.Vector3).sub(o).normalize(),u=(new l.Vector3).crossVectors(s,c).normalize(),h=(new l.Matrix4).makeBasis(c,s,u),f=L(t),d=(new l.Matrix4).getInverse(h).setPosition(n).scale(new l.Vector3(f,f,f));return r.map((function(e){return e.applyMatrix4(d)}))}function z(e){var t=L(e);return.001*Math.pow(t,.6)}var G=function(){function e(t){Object(d.a)(this,e),this.tensegrity=t}return Object(m.a)(e,[{key:"replaceCrosses",value:function(e){var t=this,n=this.tensegrity,r=[],a=function(e){var t=n.intervals.filter((function(e){return e.isPush})).find((function(t){return t.alpha.index===e||t.omega.index===e}));if(!t)throw new Error("Cannot find ".concat(e));return{interval:t,joint:t.alpha.index===e?t.alpha:t.omega}},i=n.intervals.filter((function(e){return e.intervalRole===f.IntervalRole.Cross}));i.forEach((function(e,t){var n=e.alpha.index,o=e.omega.index,c=a(n),s=a(o),u=e.alpha.location(),h=e.omega.location(),f=u.distanceTo(h),d=(new l.Vector3).addVectors(u,h).multiplyScalar(.5);i.forEach((function(i,m){var g=i.alpha.index,v=i.omega.index;if(!(t>=m||n===g||n===v||o===g||o===v)){var p,b,y,w,E,S=a(g),k=a(v),P=function(e,t){return e.interval.index===t.interval.index};if(P(c,S))p=c.interval,b=e.alpha,y=e.omega,w=i.alpha,E=i.omega;else if(P(c,k))p=c.interval,b=e.alpha,y=e.omega,w=i.omega,E=i.alpha;else if(P(s,S))p=s.interval,b=e.omega,y=e.alpha,w=i.alpha,E=i.omega;else{if(!P(s,k))return;p=s.interval,b=e.omega,y=e.alpha,w=i.omega,E=i.alpha}var x=i.alpha.location(),F=i.omega.location(),j=x.distanceTo(F),O=(new l.Vector3).addVectors(x,F).multiplyScalar(.5),R=u.distanceTo(O)/j,C=h.distanceTo(O)/j,N=x.distanceTo(d)/f,V=F.distanceTo(d)/f,I=0,M=function(e){e<.5&&I++};if(M(R),M(C),M(N),M(V),!(I<2)){var A=p.scale;r.push({scale:A,a:b,x:y,b:w,y:E})}}}))})),r.forEach((function(r){var a=r.scale,i=r.a,o=r.x,c=r.b,s=r.y,l=z(a),u=Math.sqrt(l);n.createInterval(o,s,f.IntervalRole.BowMid,a,l,u,e);var h=n.findInterval(i,o),d=n.findInterval(i,s),m=n.findInterval(c,o),g=n.findInterval(c,s);h&&m&&d&&g?(n.removeInterval(h),n.removeInterval(g),t.tensegrity.changeIntervalRole(d,f.IntervalRole.BowEnd,a,e),t.tensegrity.changeIntervalRole(m,f.IntervalRole.BowEnd,a,e)):console.log("Cannot find intervals during optimize")}))}},{key:"stiffnessesFromStrains",value:function(e){var t=this.tensegrity.numericFeature(f.WorldFeature.PushOverPull),n=function(e,t,n){var r=e.instance.floatView,a=r.strains,i=function(e){var n=e.filter(t);return n.reduce((function(e,t){return e+a[t.index]}),0)/n.length},o=e.intervals,c=o.filter((function(e){return e.isPush})),s=i(c),l=o.filter((function(e){return!e.isPush})),u=i(l),h=(-n*s+u)/2,f=o.map((function(e){return t(e)?1+(a[e.index]*(e.isPush?-n:1)-h)/h:1})),d=r.stiffnesses.map((function(e,t){return e*f[t]})),m=r.linearDensities.map((function(e,t){return Math.sqrt(e*e*f[t])}));return{stiffnesses:d,linearDensities:m}}(this.tensegrity,e,t),r=n.stiffnesses,a=n.linearDensities;this.tensegrity.instance.restoreSnapshot(),this.tensegrity.fabric.copy_material(r,a)}}]),e}();var Z;function U(){return"'Melkvonder Ulft':("+" A(".concat(4,",MA0),")+" b(".concat(4,",MA1),")+" a(".concat(4,",MA3),")+" B(".concat(4,",MA2)")+")"+":0=anchor-(".concat(25,",").concat(9,")-").concat(5,"-").concat(110)+":1=anchor-(".concat(25,",-").concat(9,")-").concat(5,"-").concat(110)+":2=anchor-(-".concat(25,",").concat(9,")-").concat(5,"-").concat(110)+":3=anchor-(-".concat(25,",-").concat(9,")-").concat(5,"-").concat(110)}function $(e,t){switch(e){case f.WorldFeature.IntervalCountdown:return t;case f.WorldFeature.Gravity:return.03*t;case f.WorldFeature.Drag:case f.WorldFeature.ShapingStiffnessFactor:return 2*t;case f.WorldFeature.PushRadius:return 3*t;case f.WorldFeature.PullRadius:return 2*t;case f.WorldFeature.JointRadiusFactor:return.8*t;case f.WorldFeature.PretensingCountdown:return 3*t;case f.WorldFeature.VisualStrain:return t;case f.WorldFeature.PretenstFactor:return 5*t;case f.WorldFeature.StiffnessFactor:return 200*t;case f.WorldFeature.PushOverPull:return 4;default:return t}}function Y(e){for(var t=e.numericFeature(f.WorldFeature.RibbonShortLength),n=e.numericFeature(f.WorldFeature.RibbonLongLength),r=function(t,r){var a=n*(r?-.5:.5),i=new l.Vector3(t,7,a),o=e.createJoint(i),c={index:o,oppositeIndex:-1,location:function(){return e.instance.jointLocation(o)}};return e.joints.push(c),c},a=function(t,n,r){var a=D(),i=z(a),o=r===f.IntervalRole.RibbonPush?2:Math.sqrt(i);return e.createInterval(t,n,r,a,i,o,100)},i=r(0,!0),o=r(0,!1),c=[[i],[o],[i],[o]],s=1;s<7;s++){var d=s*t;c[Z.FrontLeft].push(r(d,!0)),c[Z.FrontRight].push(r(d,!1)),c[Z.BackLeft].push(r(-d,!0)),c[Z.BackRight].push(r(-d,!1))}e.instance.refreshFloatView(),a(i,o,f.IntervalRole.RibbonLong);for(var m=function(e){return[c[0][e],c[1][e],c[2][e],c[3][e]]},g=1;g<7;g++){var v=m(g-1),p=m(g);a(p[0],p[1],f.IntervalRole.RibbonLong),a(p[2],p[3],f.IntervalRole.RibbonLong);for(var b=0;b<4;b++)a(v[b],p[b],f.IntervalRole.RibbonShort)}a(c[Z.FrontLeft][1],c[Z.BackRight][1],f.IntervalRole.RibbonPush),a(c[Z.FrontRight][1],c[Z.BackLeft][1],f.IntervalRole.RibbonPush);for(var y=2;y<7;y++){var w=m(y-2),E=m(y);a(w[0],E[1],f.IntervalRole.RibbonPush),a(w[1],E[0],f.IntervalRole.RibbonPush),a(w[2],E[3],f.IntervalRole.RibbonPush),a(w[3],E[2],f.IntervalRole.RibbonPush)}for(var S=function(e,t){var n=[[],[],[],[]];e.faces.filter((function(e){return!e.removed&&e.brick.parentFace})).forEach((function(e){var t=[],r=function e(t,n){var r=A[t.triangle];n.push(r.negative?r.opposite:r.name);var a=t.brick.parentFace;return a?e(a,n):function(e){switch(e){case j.NNN:return Z.BackLeft;case j.PNN:return Z.BackRight;case j.NPP:return Z.FrontLeft;case j.PPP:return Z.FrontRight;default:throw new Error("Strange arch")}}(t.triangle)}(e,t),a=t.shift();if(!a)throw new Error("no top!");if(!a||!function(e){var t=A[e];return(t.negative?t.opposite:e)===j.PPP}(a)){var i=e.triangle,o=t.length;e.joints.forEach((function(t,c){Object(u.a)(t);var s="[".concat(r,"]:[").concat(o,":").concat(j[a],"]:{tri=").concat(j[i],":J").concat(c);n[r].push({face:e,name:s,arch:r,distance:o,group:a,triangle:i,jointIndex:c})}))}}));var r=function(e){var n=e.arch;if(e.distance>t)return!1;switch(e.triangle){case j.NPN:return n===Z.BackRight;case j.NNP:return n===Z.FrontRight;case j.PNP:return n===Z.BackLeft;case j.PPN:return n===Z.FrontLeft;default:return!1}},a=e.bricks[0].location(),i=function(e,t){var n=e.face.joints[e.jointIndex].location(),r=t.face.joints[t.jointIndex].location();return n.distanceToSquared(a)-r.distanceToSquared(a)};return[n[Z.FrontLeft].filter(r).sort(i),n[Z.FrontRight].filter(r).sort(i),n[Z.BackLeft].filter(r).sort(i),n[Z.BackRight].filter(r).sort(i)]}(e,6),k=function(t,n){var r=f.IntervalRole.RibbonHanger,a=W(t.location().distanceTo(n.location())),i=z(a),o=Math.sqrt(i);return e.createInterval(t,n,r,a,i,o,10)},P=function(e){Object(h.a)(S[e]).forEach((function(t,n){if(0!==n){var r=c[e][1+Math.floor(n/3)],a=t.face.joints[t.jointIndex];k(r,a)}}))},x=0;x<4;x++)P(x);return k(c[Z.FrontRight][0],e.joints[11]),k(c[Z.FrontLeft][0],e.joints[10]),k(c[Z.FrontRight][0],e.joints[9]),k(c[Z.FrontLeft][0],e.joints[8]),S}!function(e){e[e.FrontLeft=0]="FrontLeft",e[e.FrontRight=1]="FrontRight",e[e.BackLeft=2]="BackLeft",e[e.BackRight=3]="BackRight"}(Z||(Z={}));var X=n(23),J=n(655),H=n(49),Q=n(647),q=n(605),K=new l.Vector3(1,0,0),ee=new l.Vector3(0,0,1),te=new l.Vector3(0,1,0),ne=function(e,t,n){var r=3*t;return n?(n.set(e[r],e[r+1],e[r+2]),n):new l.Vector3(e[r],e[r+1],e[r+2])},re=function(){function e(t,n,r,a){var i=this;Object(d.a)(this,e),this.fabric=void 0,this.world=void 0,this.view=void 0,this.floatView=function(){var e=new Float32Array(0);return{jointCount:0,intervalCount:0,faceCount:0,lineGeometry:new l.BufferGeometry,faceGeometry:new l.BufferGeometry,jointLocations:e,jointVelocities:e,unitVectors:e,idealLengths:e,strains:e,strainLimits:new Float32Array(4),strainNuances:e,stiffnesses:e,linearDensities:e}}(),this.adoptFabric=void 0,this.midpoint=new l.Vector3(0,0,0),this.forward=new l.Vector3(1,0,0),this.right=new l.Vector3(0,0,1),this.left=new l.Vector3(0,0,-1),this.featuresToApply=[],this.fabricBackup=void 0,this.world=r,this.adoptFabric=function(e){return i.free(),i.fabric=e,i.view=t.View.on_fabric(e),i},this.adoptFabric(a||t.Fabric.new(n))}return Object(m.a)(e,[{key:"iterate",value:function(e){var t=this.fabric.iterate(e,this.world),n=this.featuresToApply.shift();return n&&this.world.set_float_value(n.worldFeature,n.numeric),this.refreshFloatView(),t}},{key:"showFrozen",value:function(e){this.updateFloatView(!0,e)}},{key:"snapshot",value:function(){console.log("snapshot"),this.fabricBackup=this.fabricClone}},{key:"restoreSnapshot",value:function(){console.log("restoreSnapshot");var e=this.fabricBackup;if(!e)throw new Error("Missing backup");this.adoptFabric(e.clone())}},{key:"refreshFloatView",value:function(){this.view.render(this.fabric,this.world),this.midpoint.set(this.view.midpoint_x(),this.view.midpoint_y(),this.view.midpoint_z()),this.updateFloatView(!1,!1)}},{key:"clear",value:function(){return this.fabric.clear(),this.refreshFloatView(),this}},{key:"applyFeature",value:function(e){this.featuresToApply.push(e)}},{key:"jointLocation",value:function(e){return ne(this.floatView.jointLocations,e)}},{key:"apply",value:function(e){this.fabric.apply_matrix4(new Float32Array(e.toArray()))}},{key:"unitVector",value:function(e){return ne(this.floatView.unitVectors,e)}},{key:"free",value:function(){var e=this.fabric;e&&e.free();var t=this.view;t&&t.free()}},{key:"updateFloatView",value:function(e,t){var n=this.fabric,r=this.view,a=n.get_joint_count(),i=n.get_interval_count(),o=n.get_face_count(),c=this.floatView;if(c.jointCount!==a||c.intervalCount!==i||c.faceCount!==o){c.jointCount=a,c.intervalCount=i,c.faceCount=o,c.lineGeometry.dispose(),c.lineGeometry=new l.BufferGeometry;var s=new Float32Array(3*i*2);r.copy_line_locations_to(s),c.lineGeometry.setAttribute("position",new l.Float32BufferAttribute(s,3));var u=new Float32Array(3*i*2);if(e)if(t){u.fill(0);for(var h=1;h<u.length;h+=3)u[h]=1}else u.fill(1);else r.copy_line_colors_to(u);c.lineGeometry.setAttribute("color",new l.Float32BufferAttribute(u,3)),c.faceGeometry.dispose(),c.faceGeometry=new l.BufferGeometry;var f=new Float32Array(3*o*3);r.copy_face_vertex_locations_to(f),c.faceGeometry.setAttribute("position",new l.Float32BufferAttribute(f,3));var d=new Float32Array(3*o*3);r.copy_face_normals_to(d),c.faceGeometry.setAttribute("normal",new l.Float32BufferAttribute(d,3)),c.jointLocations=new Float32Array(3*a),c.jointVelocities=new Float32Array(3*a),c.unitVectors=new Float32Array(3*i),c.idealLengths=new Float32Array(i),c.strains=new Float32Array(i),c.strainNuances=new Float32Array(i),c.stiffnesses=new Float32Array(i),c.linearDensities=new Float32Array(i)}else{var m=this.floatView.lineGeometry.attributes,g=this.floatView.faceGeometry.attributes;if(m.position){var v=m.position;r.copy_line_locations_to(v.array),v.needsUpdate=!0;var p=m.color,b=p.array;if(e)if(t){b.fill(0);for(var y=1;y<b.length;y+=3)b[y]=1}else b.fill(1);else r.copy_line_colors_to(b);p.needsUpdate=!0;var w=g.position;r.copy_face_vertex_locations_to(w.array),w.needsUpdate=!0;var E=g.normal;r.copy_face_normals_to(E.array),E.needsUpdate=!0}}r.copy_joint_locations_to(c.jointLocations),r.copy_joint_velocities_to(c.jointVelocities),r.copy_unit_vectors_to(c.unitVectors),r.copy_ideal_lengths_to(c.idealLengths),r.copy_strains_to(c.strains),r.copy_strain_limits_to(c.strainLimits),r.copy_strain_nuances_to(c.strainNuances),r.copy_stiffnesses_to(c.stiffnesses),r.copy_linear_densities_to(c.linearDensities);var S=c.jointLocations;!function(e,t,n){var r=3*e,a=3*t;n.set(S[a]-S[r],S[a+1]-S[r+1],S[a+2]-S[r+2])}(2,1,this.forward),this.forward.y=0,this.forward.normalize(),this.right.crossVectors(this.forward,te).normalize(),this.left.set(0,0,0).sub(this.right)}},{key:"fabricClone",get:function(){return this.fabric.clone()}}]),e}();var ae=[{x:0,y:0},{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1},{x:4,y:0},{x:3,y:-1},{x:2,y:-2},{x:0,y:-2},{x:-2,y:-2},{x:-3,y:-1},{x:-4,y:0},{x:-3,y:1},{x:-2,y:2},{x:0,y:2},{x:2,y:2},{x:3,y:1},{x:6,y:0},{x:5,y:-1},{x:4,y:-2},{x:3,y:-3},{x:1,y:-3},{x:-1,y:-3},{x:-3,y:-3},{x:-4,y:-2},{x:-5,y:-1},{x:-6,y:0},{x:-5,y:1},{x:-4,y:2},{x:-3,y:3},{x:-1,y:3},{x:1,y:3},{x:3,y:3},{x:4,y:2},{x:5,y:1}],ie=[{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1}],oe=Math.sin(60*Math.PI/180),ce=12.5/oe,se=ce*oe,le=1.5*ce,ue=[new l.Vector3(0,0,-ce),new l.Vector3(-oe*ce,0,-ce/2),new l.Vector3(-oe*ce,0,ce/2),new l.Vector3(0,0,ce),new l.Vector3(oe*ce,0,ce/2),new l.Vector3(oe*ce,0,-ce/2)],he=new l.Color("#4b4b4b"),fe=new l.Color("#59431e"),de=new l.Vector3(0,1,0),me=new l.Vector3(0,500,0),ge=new l.Color("#fff1d1");var ve=function(){var e=new l.Geometry;return e.vertices=function(){var e=function(){return new l.Vector3(0,0,0)},t=e(),n=e().addScaledVector(ee,1.5*-.2).addScaledVector(K,3),r=e().addScaledVector(ee,-.2).addScaledVector(K,3),a=e().addScaledVector(ee,.2).addScaledVector(K,3),i=e().addScaledVector(ee,.2*1.5).addScaledVector(K,3),o=e().addScaledVector(K,3*1.3);return[t,r,t,a,i,o,n,o,i,a,n,r]}(),e}(),pe=n(562),be=n(563),ye=n.n(be);function we(e){return e.toFixed(5).replace(/[.]/,",")}function Ee(){return(new Date).toISOString().replace(/[.].*/,"").replace(/[:T_]/g,"-")}function Se(e){var t=new ye.a;t.file("joints.csv",function(e){var t=[];return t.push(["index","x","y","z"]),e.joints.forEach((function(e){return t.push([(e.index+1).toFixed(0),we(e.x),we(e.y),we(e.z)])})),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.file("intervals.csv",function(e){var t=[];return t.push(["joints","type","strain","stiffness","linear density","role","length"]),e.intervals.forEach((function(e){t.push(['"=""'.concat(e.joints.map((function(e){return(e+1).toFixed(0)})),'"""'),e.type,we(e.strain),we(e.stiffness),we(e.linearDensity),e.role,e.length.toFixed(8)])})),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.file("submerged.csv",function(e){var t=[];return t.push(["joints"]),t.push(['"=""'.concat(e.joints.filter((function(e){return e.anchor})).map((function(e){return e.index+1})),'"""')]),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then((function(e){pe.saveAs(e,"pretenst-".concat(Ee(),".zip"))}))}function ke(e){var t=new ye.a;t.file("pretenst-".concat(Ee(),".json"),JSON.stringify(e,void 0,2)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then((function(e){pe.saveAs(e,"pretenst-".concat(Ee(),".zip"))}))}var Pe=["#fd0000","#c94f00","#d58e1c","#897c00","#6c8901","#1d6c01","#0e4e00","#007f67","#01808b","#005da3","#0015c7","#0000ff"].reverse().map((function(e){return(new l.Color).setHex(parseInt("".concat(e.substring(1)),16))})),xe=new l.MeshPhongMaterial({color:new l.Color("#181818"),side:l.DoubleSide,opacity:.5}),Fe=new l.LineBasicMaterial({vertexColors:!0}),je=new l.MeshPhongMaterial({color:new l.Color("#91934f")}),Oe=new l.MeshPhongMaterial({color:new l.Color("#343434")});Pe.map((function(e){return new l.MeshLambertMaterial({color:e})}));function Re(e){switch(e){case f.IntervalRole.NexusPush:return"#8955fa";case f.IntervalRole.ColumnPush:return"#2b38ff";case f.IntervalRole.Triangle:return"#d0c61a";case f.IntervalRole.Ring:return"#ff5c2b";case f.IntervalRole.Cross:return"#28c245";case f.IntervalRole.BowMid:case f.IntervalRole.BowEnd:return"#4393b3";case f.IntervalRole.FaceConnector:return"#fe0105";case f.IntervalRole.FaceDistancer:return"#9e9b02";case f.IntervalRole.FaceAnchor:return"#dc5bf8";default:return}}function Ce(e){var t=function(e){return new l.Color(Re(e))}(e);return new l.MeshLambertMaterial({color:t})}var Ne=new l.MeshLambertMaterial({color:"#1d1d1d"}),Ve=[new l.Vector3(0,0,-20),new l.Vector3(-17.32,0,-10),new l.Vector3(-17.32,0,10),new l.Vector3(0,0,20),new l.Vector3(17.32,0,10),new l.Vector3(17.32,0,-10)],Ie=new l.Color("tan"),Me=new l.Vector3(0,1,0);function Ae(){var e=Object(o.useMemo)((function(){return function(){var e=new l.Geometry;return function(e,t){e.push.apply(e,Object(h.a)(Ve.map((function(e){return new l.Vector3(e.x,e.y,e.z).multiplyScalar(4)})))),e.push(new l.Vector3);for(var n=0;n<6;n++){var r=(n+1)%6,a=[Me,(new l.Vector3).add(Me).addScaledVector(Ve[n],.03).normalize(),(new l.Vector3).add(Me).addScaledVector(Ve[r],.03).normalize()];t.push(new l.Face3(6,n,r,a,Ie))}}(e.vertices,e.faces),e.vertices.forEach((function(e){return e.sub(new l.Vector3(0,.01,0))})),e}()}),[]);return o.createElement("mesh",{name:"Patches",geometry:e,material:xe})}function Te(e){var t=e.tensegrity,n=Object(o.useState)(t.life$.getValue()),r=Object(X.a)(n,2),a=r[0],i=r[1];return Object(o.useEffect)((function(){var e=t.life$.subscribe(i);return function(){return e.unsubscribe()}}),[t]),o.createElement("div",{id:"view-container",style:{position:"absolute",left:0,right:0,height:"100%"}},o.createElement("div",{id:"top-middle"},E(a.stage)),o.createElement("div",{id:"bottom-right"},o.createElement(Q.a,{vertical:!1},o.createElement(q.a,{onClick:function(){return Se(t.fabricOutput)}},o.createElement(J.p,null)," ",o.createElement(J.v,null)),o.createElement(q.a,{onClick:function(){return ke(t.fabricOutput)}},o.createElement(J.p,null)," ",o.createElement(J.u,null)),o.createElement(q.a,{onClick:function(){return k(p.Design)}},o.createElement(J.P,null)))),o.createElement(H.a,{style:{backgroundColor:"black"}},o.createElement(_e,null),t?o.createElement(De,{tensegrity:t,life:a}):o.createElement("h1",null,"No bridge")))}function De(e){var t=e.tensegrity,n=e.life,r=Object(H.d)().camera,a=document.getElementById("view-container"),i=Object(H.e)((function(e){e.minPolarAngle=0,e.maxPolarAngle=Math.PI/2,e.minDistance=.1,e.maxDistance=9e3,e.zoomSpeed=.5,e.enableZoom=!0,e.target.set(0,50,0),e.update()}),[]),c=Object(o.useState)(!0),s=Object(X.a)(c,1)[0],u=Object(o.useState)(0),h=Object(X.a)(u,2),d=h[0],m=h[1],g=Object(o.useState)(!1),v=Object(X.a)(g,2),p=v[0],b=v[1],y=Object(o.useState)([]),w=Object(X.a)(y,2),E=w[0],S=w[1];return Object(H.c)((function(){var e=i.current;switch(e.target.copy(t.instance.midpoint),e.update(),t.iterate()){case f.Stage.Growing:m(d+1);break;case f.Stage.Shaping:if(n.stage===f.Stage.Growing){t.transition={stage:f.Stage.Shaping},m(0),function(e){e.bricks[0].pushes.forEach((function(t){return e.changeIntervalScale(t,2)}))}(t);break}if(d<1e3){m(d+1);break}1e3===d&&(console.log("Ribbon!"),S(Y(t)),e.autoRotate=!0,e.rotateSpeed=5,t.transition={stage:f.Stage.Slack,adoptLengths:!0},m(0));break;case f.Stage.Slack:t.transition={stage:f.Stage.Pretensing},m(0);break;case f.Stage.Pretensing:m(d+1);break;case f.Stage.Pretenst:if(n.stage===f.Stage.Pretensing){t.transition={stage:f.Stage.Pretenst},m(0);break}200===d&&(p||(b(!0),console.log("strain to stiffness",p),t.transition={stage:f.Stage.Slack,strainToStiffness:!0})),m(d+1);break;default:m(d+1)}})),o.createElement("group",null,o.createElement("orbit",{ref:i,args:[r,a]}),o.createElement("scene",null,s?o.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:Fe}):o.createElement(o.Fragment,null,t.intervals.map((function(e){var n=e.isPush?f.WorldFeature.PushRadius:f.WorldFeature.PullRadius,r=t.numericFeature(n),a=t.numericFeature(f.WorldFeature.JointRadiusFactor);return o.createElement(Le,{key:"I".concat(e.index),tensegrity:t,interval:e,radiusFactor:r,jointRadiusFactor:a})})),E.map((function(e){return e.map((function(e){return o.createElement(We,{key:e.name,hook:e})}))}))),o.createElement(Ae,null),o.createElement("ambientLight",{color:new l.Color("white"),intensity:.8}),o.createElement("directionalLight",{color:new l.Color("#FFFFFF"),intensity:2})))}function Le(e){var t=e.tensegrity,n=e.interval,r=e.radiusFactor,a=e.jointRadiusFactor,i=e.onPointerDown,c=r*t.instance.floatView.linearDensities[n.index],s=t.instance.unitVector(n.index),u=(new l.Quaternion).setFromUnitVectors(new l.Vector3(0,1,0),s),h=n.alpha.location().distanceTo(n.omega.location()),f=c*a,d=new l.Vector3(c,h+(n.isPush?2*-f:0),c),m=new l.Vector3(f,f,f);return o.createElement(o.Fragment,null,n.isPush?o.createElement(o.Fragment,null,o.createElement("mesh",{position:n.location(),rotation:(new l.Euler).setFromQuaternion(u),scale:d,onPointerDown:i},o.createElement("meshLambertMaterial",{attach:"material",color:new l.Color("#bd7b14")}),o.createElement("cylinderGeometry",{attach:"geometry",args:[.5,.5,1,6,1]})),o.createElement("mesh",{position:n.location(),rotation:(new l.Euler).setFromQuaternion(u),scale:d,matrixWorldNeedsUpdate:!0,onPointerDown:i},o.createElement("meshLambertMaterial",{attach:"material",color:new l.Color("#ec8700")}),o.createElement("cylinderGeometry",{attach:"geometry",args:[1,1,.85,12,1]})),o.createElement("mesh",{position:n.alpha.location(),scale:m,onPointerDown:i},o.createElement("sphereGeometry",{attach:"geometry",args:[1,32,8]}),o.createElement("meshPhongMaterial",{attach:"material",color:new l.Color("#2bc19d")})),o.createElement("mesh",{position:n.omega.location(),scale:m,onPointerDown:i},o.createElement("sphereGeometry",{attach:"geometry",args:[1,32,8]}),o.createElement("meshPhongMaterial",{attach:"material",color:new l.Color("#2bc19d")}))):o.createElement("mesh",{position:n.location(),rotation:(new l.Euler).setFromQuaternion(u),scale:d,onPointerDown:i},o.createElement("meshLambertMaterial",{attach:"material",color:new l.Color("#faf8f8")}),o.createElement("cylinderGeometry",{attach:"geometry",args:[1,1,1,6,1]})))}function We(e){var t=e.hook,n=new l.Vector3(.04,.04,.04),r=t.face;return o.createElement(o.Fragment,null,r.joints.map((function(e){return o.createElement("mesh",{key:"hook-".concat(e.index),position:e.location(),scale:n,matrixWorldNeedsUpdate:!0},o.createElement("sphereGeometry",{attach:"geometry",args:[1,32,8]}),o.createElement("meshPhongMaterial",{attach:"material",color:new l.Color("#43d903")}))})))}function _e(e){var t=Object(o.useRef)(),n=Object(H.d)().setDefaultCamera;return Object(o.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(35,10,30),n(e)}),[]),Object(H.c)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),o.createElement("perspectiveCamera",Object.assign({ref:t},e))}var Be=n(48);function ze(e){return.6*e}var Ge,Ze=function(){function e(t){Object(d.a)(this,e),this.tensegrity=t}return Object(m.a)(e,[{key:"createBrickAt",value:function(e,t,n){var r=B(j.PPP,n,e);if(t){var a=function(e,t){var n=function(e,t){return(new l.Vector3).subVectors(t,e).normalize()},r=n(e[4],e[5]),a=n(e[0],e[1]),i=n(e[8],e[9]),o=e.reduce((function(e,t){return e.add(t)}),new l.Vector3).multiplyScalar(1/12),c=(new l.Matrix4).makeBasis(r,a,i).setPosition(o),s=(new l.Matrix4).makeRotationZ(.275*Math.PI),u=(new l.Matrix4).makeRotationY(-t*Math.PI/3);return(new l.Matrix4).getInverse(c.multiply(s).multiply(u))}(r,this.tensegrity.rotation);r.forEach((function(e){return e.applyMatrix4(a)}))}return this.createBrick(r,j.NNN,n)}},{key:"createConnectedBrick",value:function(e,t,n){var r=e.faces[t],a=L(e.scale),i=a*L(n),o=this.createBrickOnFace(r,W(i)),c=o.faces[o.base],s=this.tensegrity.numericFeature(f.WorldFeature.IntervalCountdown);return this.connectFaces(r,c,W((a+i)/2),s),o}},{key:"checkFaceIntervals",value:function(e,t){var n=this;if(0===e.length)return e;return e.filter((function(e){if(e.connector){var r=e.alpha,a=e.omega,i=e.scaleFactor;if(r.location().distanceTo(a.location())<=10*ze(i))return function(e){var t=e.alpha,r=e.omega,a=e.scaleFactor,i=n.tensegrity.numericFeature(f.WorldFeature.IntervalCountdown);n.connectFaces(t,r,W(a),i)}(e),t(e),!1}return!0}))}},{key:"faceToOrigin",value:function(e){var t=this.tensegrity.instance;t.apply(function(e){var t=e.joints.map((function(e){return e.location()})),n=t.reduce((function(e,t){return e.add(t)}),new l.Vector3).multiplyScalar(1/3),r=(new l.Vector3).subVectors(t[1],n).normalize(),a=(new l.Vector3).subVectors(t[0],n).normalize(),i=(new l.Vector3).crossVectors(a,r).normalize();a.crossVectors(r,i).normalize();var o=(new l.Matrix4).makeBasis(r,i,a).setPosition(n);return(new l.Matrix4).getInverse(o)}(e)),t.refreshFloatView()}},{key:"createFaceIntervals",value:function(e,t){var n=this,r=function(){var t,r=n.createBrickAt((t=e.map((function(e){return e.location()}))).reduce((function(e,t){return e.add(t)}),new l.Vector3).multiplyScalar(1/t.length),!1,W(function(e){return e.reduce((function(e,t){return e+L(t.brick.scale)}),0)/e.length}(e)));return e.map((function(e){var t=r.faces.filter((function(t){var n=t.negative;return!t.removed&&n!==e.negative})).reduce((function(t,n){return t.location().distanceTo(e.location())<n.location().distanceTo(e.location())?t:n}));return t.removed=!0,n.tensegrity.createFaceConnector(t,e)}))};switch(t.action){case Ge.JoinFaces:switch(e.length){case 2:return e[0].negative===e[1].negative?r():[this.tensegrity.createFaceConnector(e[0],e[1])];case 3:return r();default:return[]}case Ge.FaceDistance:var a=t.scale;if(!a)throw new Error("Missing pull scale");var i=[];return e.forEach((function(t,r){e.forEach((function(e,o){r<=o||i.push(n.tensegrity.createFaceDistancer(t,e,a))}))})),i;default:return[]}}},{key:"createFaceAnchor",value:function(e,t){if(t.action!==Ge.Anchor)throw new Error("Anchor problem");var n=t.point,r=t.scale;if(!n||!r)throw new Error("Missing anchor point specs");return this.tensegrity.createFaceAnchor(e,n,r)}},{key:"createBrickOnFace",value:function(e,t){var n=A[e.triangle].negative,r=e.brick,a=e.triangle,i=r.faces[a].joints.map((function(e){return e.location()})),o=i.reduce((function(e,t){return e.add(t)}),new l.Vector3).multiplyScalar(1/3),c=(new l.Vector3).addVectors(i[0],i[1]).multiplyScalar(.5),s=(new l.Vector3).subVectors(c,o).normalize(),u=(new l.Vector3).subVectors(i[1],o).normalize(),h=(new l.Vector3).add(s).multiplyScalar(s.dot(u)),f=u.sub(h).normalize(),d=(new l.Vector3).crossVectors(f,s).normalize(),m=(new l.Matrix4).makeBasis(s,d,f).setPosition(o),g=B(n?j.NNN:j.PPP,t,new l.Vector3(0,0,0)).map((function(e){return e.applyMatrix4(m)})),v=n?j.PPP:j.NNN;return this.createBrick(g,v,t,e)}},{key:"createBrick",value:function(e,t,n,r){var a,i=this,o=this.tensegrity.numericFeature(f.WorldFeature.IntervalCountdown),c=z(n),s=Math.sqrt(c),d=function(e,t,n){return{parentFace:n,base:e,scale:t,joints:[],pushes:[],pulls:[],crosses:[],rings:[[],[],[],[]],faces:[],negativeAdjacent:0,postiveAdjacent:0,location:function(){return new l.Vector3}}}(t,n,r);this.tensegrity.bricks.push(d);var m=e.map((function(e,t){return i.tensegrity.createJoint(e)}));this.tensegrity.instance.refreshFloatView(),M.forEach((function(e,t){Object(u.a)(e);var r=m[2*t],a=m[2*t+1],l={index:r,oppositeIndex:a,location:function(){return i.tensegrity.instance.jointLocation(r)}},h={index:a,oppositeIndex:r,location:function(){return i.tensegrity.instance.jointLocation(a)}};d.pushes.push(i.tensegrity.createInterval(l,h,f.IntervalRole.NexusPush,n,c,s,o))})),d.pushes.forEach((function(e){return d.joints.push(e.alpha,e.omega)}));var g=d.pushes.reduce((function(e,t){return e.push(t.alpha,t.omega),e}),[]);return(a=this.tensegrity.joints).push.apply(a,Object(h.a)(g)),A.forEach((function(e){for(var t=e.pushEnds.map((function(e){return g[e]})),r=0;r<3;r++){var a=t[r],l=t[(r+1)%3],u=i.tensegrity.createInterval(a,l,f.IntervalRole.Triangle,n,c,s,o);d.pulls.push(u),d.rings[e.ringMember[r]].push(u)}})),A.forEach((function(e){var t=i.tensegrity.createFace(d,e.name);d.faces.push(t)})),this.tensegrity.instance.refreshFloatView(),d.location=function(){return d.joints.reduce((function(e,t){return e.add(t.location())}),new l.Vector3).multiplyScalar(1/d.joints.length)},d}},{key:"facesToRing",value:function(e,t){if(e.negative===t.negative)throw new Error("Polarity not opposite");var n=(new l.Vector3).subVectors(e.joints[0].location(),e.location()).normalize(),r=t.joints.map((function(e,r){return[(new l.Vector3).subVectors(e.location(),t.location()).normalize().dot(n),r]})).sort((function(e,t){return t[0]-e[0]})).pop();if(!r)throw new Error("No opposite joint");var a=[[1,0,2],[2,1,0],[0,2,1]][r[1]];return[e.joints[0],t.joints[a[0]],e.joints[1],t.joints[a[1]],e.joints[2],t.joints[a[2]]]}},{key:"connectFaces",value:function(e,t,n,r){var a=this,i=z(n),o=Math.sqrt(i);if(e.negative===t.negative)throw new Error("Same polarity!");[e,t].forEach((function(e){a.tensegrity.removeFace(e,!0),e.negative?e.brick.postiveAdjacent++:e.brick.negativeAdjacent++}));for(var c=this.facesToRing(e,t),s=function(e,t,c){return a.tensegrity.createInterval(e,t,c,n,i,o,r)},l=0;l<c.length;l++){var u=c[(l+5)%6],h=c[l],d=c[(l+1)%6];s(h,d,f.IntervalRole.Ring);var m=function(n,r){var i=a.tensegrity.joints[r.oppositeIndex];_(i,e.brick,t.brick).crosses.push(s(n,i,f.IntervalRole.Triangle))};e.negative?m(u,h):m(d,h)}[e,t].forEach((function(e){var t=e.triangle,n=e.brick,i=function(e,t){return e.filter((function(e){return!e.removed&&e.intervalRole!==t})).forEach((function(e){return a.tensegrity.changeIntervalRole(e,t,n.scale,r)}))};!function(e){return e.negativeAdjacent>1||e.postiveAdjacent>1}(n)?(i(n.rings[A[t].ring],f.IntervalRole.Ring),i(n.crosses,f.IntervalRole.Triangle),i(n.pushes,f.IntervalRole.ColumnPush)):(i(n.pulls,f.IntervalRole.Triangle),i(n.crosses,f.IntervalRole.Cross),i(n.pushes,f.IntervalRole.NexusPush))})),this.tensegrity.instance.refreshFloatView()}}]),e}();function Ue(e){return JSON.stringify(e).replace(/[_.:"]/g,"").replace(/[{]/g,"(").replace(/[}]/g,")").replace(/([ABCDabcdSM])\((\d*)\)/g,(function(e){return"".concat(arguments.length<=1?void 0:arguments[1]).concat(arguments.length<=2?void 0:arguments[2])}))}function $e(e){return"aBCDbcdA".indexOf(e)>=0}function Ye(e,t){return t["M".concat("aBCDbcdA"[e])]}function Xe(e){return"0123456789".indexOf(e)>=0}function Je(e){if(!e.match(/^\d+$/))throw new Error("Not a number: ".concat(e));return parseInt(e,10)}function He(e,t){var n=e.indexOf(","),r=n>=0;if("("!==e.charAt(0))return r?{content:e.substring(0,n),skip:n}:{content:e,skip:e.length};var a=function(e){if("("!==e.charAt(0))throw new Error('Code must start with "(": '.concat(e," ").concat(e.charAt(0)));for(var t=0,n=0;n<e.length;n++){var r=e.charAt(n);if("("===r)t++;else if(")"===r&&0===--t)return n}throw new Error("No matching end bracket: |".concat(e,"|"))}(e);return{content:t?e.substring(1,a):e.substring(0,a+1),skip:a+1}}function Qe(e,t,n){function r(e){var t=He(e,!0).content,n={};function a(e){var n=He(t.substring(e),!1),a=n.content,i=n.skip;return{codeTree:r(a),skip:i}}for(var i=0;i<t.length;i++){var o=t.charAt(i);if($e(o)){var c=a(i+1);if(!c.codeTree)throw new Error("No subtree: ".concat(t.substring(i)));n[o]=c.codeTree,i+=c.skip}else if(Xe(o)){var s=He(t,!1);n._=Je(s.content),i+=s.skip}else switch(o){case"S":var l=He(t.substring(i+1),!0);n.S={_:Je(l.content)},i+=l.skip;break;case"M":var u=t.charAt(i+1),h=He(t.substring(i+2),!0);n["M".concat(u)]={_:Je(h.content)},i+=h.skip+1;break;case",":case" ":break;default:throw new Error("Unexpected character: ".concat(o))}}return 0===Object.keys(n).length?void 0:n}try{if(!n||0===n.length)return void e("No code to parse");var a=function(e){var t=e.replace(/[\n\r\t]/g,"").split(":"),n=t.find((function(e){return e.startsWith("'")&&e.endsWith("'")})),r=t.find((function(e){return e.startsWith("(")&&e.endsWith(")")})),a={};return t.filter((function(e){return e.match(/^\d+=.*$/)})).forEach((function(e){var t=e.indexOf("="),n=Number(e.substring(0,t));a[n]=e.substring(t+1)})),{name:n?n.replace(/'/g,""):"",mainCode:r||"(0)",markCode:a}}(n),i=a.name,o=a.mainCode,c=a.markCode;if(!i.length)return;var s=r(o);if(!s)return;var u={};return Object.keys(c).forEach((function(e){var t=c[e];if(t.startsWith("subtree")){var n=r(t.substring("subtree".length));u[e]={action:Ge.Subtree,tree:n}}else if(t.startsWith("base-face"))u[e]={action:Ge.BaseFace};else if(t.startsWith("join-faces"))u[e]={action:Ge.JoinFaces};else if(t.startsWith("face-distance-")){var a={_:parseInt(t.split("-")[2],10)};u[e]={action:Ge.FaceDistance,scale:a}}else if("symmetrical"===t)u[e]={action:Ge.Symmetrical};else{var i=t.match(/anchor-\(([0-9.-]*),([0-9.-]*)\)-(\d*)-(\d*)/);if(!i)throw new Error("Unrecognized mark code: [".concat(t,"]"));var o=parseFloat(i[1]),s=parseFloat(i[2]),h=parseFloat(i[3]),f={_:parseInt(i[4],10)},d=new l.Vector3(o,-h,s);u[e]={action:Ge.Anchor,point:d,scale:f}}})),function(e,t,n,r){var a=Ue(t),i=[],o=!1;Object.keys(n).forEach((function(e){var t=n[e];switch(t.action){case Ge.Subtree:var r=t.tree;if(!r)throw new Error("Missing tree");i.push("".concat(e,"=").concat(Ue(r)));break;case Ge.BaseFace:case Ge.JoinFaces:break;case Ge.FaceDistance:if(!t.scale)throw new Error("Missing scale");i.push("".concat(e,"=face-distance-").concat(t.scale._));break;case Ge.Anchor:var a=t.point,c=t.scale;if(!a||!c)throw new Error("Bad anchor");var s=function(e){return e.toFixed(1)};i.push("".concat(e,"=anchor-(").concat(s(a.x),",").concat(s(a.z),")-").concat(-a.y,"-").concat(c._));break;case Ge.Symmetrical:o=!0,i.push("".concat(e,"=symmetrical"))}}));var c=i.length>0?":".concat(i.join(":")):"";return{name:e,tree:t,symmetrical:o,marks:n,code:"'".concat(e,"':").concat(a).concat(c),fromUrl:r}}(i,s,u,t)}catch(h){return void e(h.message)}}function qe(e){throw new Error("Unable to parse: ".concat(e))}!function(e){e[e.Subtree=0]="Subtree",e[e.BaseFace=1]="BaseFace",e[e.JoinFaces=2]="JoinFaces",e[e.FaceDistance=3]="FaceDistance",e[e.Anchor=4]="Anchor",e[e.Symmetrical=5]="Symmetrical"}(Ge||(Ge={}));var Ke,et=["'Mobiosity':(d(6,S80,MA4),C(6,S80,MA4),c(6,S80,MA3),D(6,S80,MA2),a(6,S80,MA1),b(6,S80,MA2),B(6,S80,MA1),A(6,S80,MA3))","'Zero':(0)","'One':(1)","'Six':(6)","'Axoneme':(16,S90)","'Knee':(b1,a1)","'Leg':(b3,a3)","'Nexus':(a1,b1,c1,d1)","'Tripod with Knees':(A2,B(3,b(2,S90),S80),C(3,c(2,S90),S80),D(3,d(2,S90),S80))","'Pretenst Lander':(B(5,S75),C(5,S75),D(5,S75))","'Zig Zag Loop':(a(1,MA0),c(3,b(3,d(3,c(3,b(3,d(1,MA0)))))))","'Bulge Ring':(A(8, S85, MA1), a(8, S85, MA1))","'Ring':(A(10,MA1),a(10,MA1))","'Convergence Three':(a1,b(3,S85,MA1),c(3,S85,MA1),d(3,S85,MA1))","'Convergence Ten':(a1,b(10,S85,MA1),c(10,S85,MA1),d(10,S85,MA1))","'Halo by Crane':(B(7,S80,MA1),C(2,S120,MA0),D(7,S80,MA1))","'Thick Tripod':(A1,B(3,MA1),C(3,MA1),D(3,MA1)):1=face-distance-35","'Ankh':(A(3,S90,Mb0),b(3,S90,Mb0),a(5,S80,MA1),B(5,MA1,S80)):0=face-distance-30","'Diamond':(a(2,b(2,c(2,d(1,MA1)),d(2,c(1,MA0))),c(2,d(2,b(1,MA3)),b(2,d(1,MA2))),d(2,b(2,c(1,MA5)),c(2,b(1,MA4)))),b(2,d(2,Mc3),c(2,Md4)),c(2,b(2,Md5),d(2,Mb0)),d(2,c(2,Mb1),b(2,Mc2)))","'Composed':(3,b(2,MA0),c(2,MA0),d(2,MA0)):0=subtree(b2,c2,d2)","'Minigotchi':(A(3,S90,Mb0),b(3,S90,Mb0),a(2,S90,Md0),B(2,Md0,S90)):0=face-distance-60:9=symmetrical","'Mesogotchi':(A(2,c(2,MA0)),b(2,c(2,MA0)),a(2,d(2,MA0)),B(2,d(2,MA0))):0=face-distance-115:9=symmetrical","'Gorillagotchi':(A(5,S80,Mb0),b(5,S80,Mb0),a(3,S70,Md0),B(3,Md0,S70)):0=face-distance-60:9=symmetrical","'Equus Lunae':(A(8,S90,Mb0),b(8,S90,Mb0),a(8,S90,Md0),B(8,Md0,S90)):0=face-distance-60:9=symmetrical","'Infinity':(a(5,S80,MA1),b(5,S80,MA2),B(5,S80,MA1),A(5,S80,MA2))","'Binfinity':(d(6,S80,MA4),C(6,S80,MA4),c(6,S80,MA3),D(6,S80,MA3),a(6,S80,MA1),b(6,S80,MA2),B(6,S80,MA1),A(6,S80,MA2))"].map((function(e){return Qe(qe,!1,e)}));function tt(e,t){var n=[];return e.forEach((function(e){var r=e.brick,a=e.tree,i=e.tensegrity;function o(e,t,n,r){var a,o,c=e.base===j.PPP?T(n):n,s=new Ze(i).createConnectedBrick(e,c,r);return 0===t._&&(a=s,o=t,C.forEach((function(e){var t=Ye(e,o);if(t){var n=a.base===j.NNN?a.faces[e]:a.faces[T(e)];if(n.removed)throw new Error("!! trying to use a face that was removed");n.mark=t}}))),{tree:t,brick:s,tensegrity:i}}var c=a._;if(c){var s=c-1;n.push(o(r,Object(Be.a)({},a,{_:s}),j.PPP,D(a.S)))}else C.forEach((function(e){var i=function(e,t){return t["aBCDbcdA"[e]]}(e,a),c=Ye(e,a);if(i){var s=i._?i._-1:void 0,l=Object(Be.a)({},i,{_:s});n.push(o(r,l,e,D(i.S)))}else if(c){var u=t[c._];if(u&&u.action===Ge.Subtree){var h=u.tree;if(!h)throw new Error("Missing subtree");!function(e,t){t["M".concat("aBCDbcdA"[e])]=void 0}(e,a),n.push(o(r,h,e,D(h.S)))}}}))})),n}!function(e){e.Grow="Grow",e.Shape="Shape",e.Live="Live",e.Realize="Realize",e.Frozen="Frozen"}(Ke||(Ke={}));function nt(e){return Object.keys(e.recentCode).map((function(t){var n=e.recentCode[t],r=Qe((function(e){return console.error(e)}),!1,n);if(!r)throw new Error("Unable to read recent tenscript code: ".concat(n));return r}))}function rt(e){switch(e){case f.IntervalRole.NexusPush:return f.WorldFeature.NexusPushLength;case f.IntervalRole.ColumnPush:return f.WorldFeature.ColumnPushLength;case f.IntervalRole.Triangle:return f.WorldFeature.TriangleLength;case f.IntervalRole.Ring:return f.WorldFeature.RingLength;case f.IntervalRole.Cross:return f.WorldFeature.CrossLength;case f.IntervalRole.BowMid:return f.WorldFeature.BowMidLength;case f.IntervalRole.BowEnd:return f.WorldFeature.BowEndLength;case f.IntervalRole.RibbonPush:return f.WorldFeature.RibbonPushLength;case f.IntervalRole.RibbonShort:return f.WorldFeature.RibbonShortLength;case f.IntervalRole.RibbonLong:return f.WorldFeature.RibbonLongLength;case f.IntervalRole.RibbonHanger:return f.WorldFeature.RibbonHangerLength;default:throw new Error("role?")}}function at(e,t){if(t===f.IntervalRole.FaceConnector||t===f.IntervalRole.FaceDistancer||t===f.IntervalRole.FaceAnchor)throw new Error;return e(rt(t))}function it(e,t){return Object(Be.a)({},e,{nonce:e.nonce+1},t)}function ot(e){localStorage.setItem("State",JSON.stringify(e))}function ct(e,t){var n=localStorage.getItem("State");if(n){var r=JSON.parse(n);if("2020-06-03"===r.version)return r}return function(e,t){var n=g.map(e).reduce((function(e,n){return e[n.feature]={percent:100,numeric:t(n.feature)},e}),{});return{version:"2020-06-03",nonce:0,surfaceCharacter:f.SurfaceCharacter.Frozen,featureValues:n,recentCode:{},controlTab:Ke.Grow,fullScreen:!0,polygons:!1,rotating:!1,visibleRoles:b,pushBottom:0,pushTop:1,pullBottom:0,pullTop:1}}(e,t)}function st(e){switch(e){case f.WorldFeature.Gravity:return{feature:e,name:"Gravity",percents:[0,10,25,50,100,200,500,1e3]};case f.WorldFeature.Antigravity:return{feature:e,name:"Antigravity",percents:[5,25,50,100,150,200,500]};case f.WorldFeature.ShapingDrag:return{feature:e,name:"Shaping Drag",percents:[0,10,50,100,200,500]};case f.WorldFeature.Drag:return{feature:e,name:"Drag",percents:[0,10,50,100,150,200,500,1e3]};case f.WorldFeature.ShapingPretenstFactor:return{feature:e,name:"Shaping Pretenst factor",percents:[0,1,2,3,5,10,20,50,100]};case f.WorldFeature.PretenstFactor:return{feature:e,name:"Pretenst factor",percents:[0,50,90,100,125,150,200,300,500]};case f.WorldFeature.ShapingStiffnessFactor:return{feature:e,name:"Shaping Stiffness factor",percents:[20,50,100,150,200,250,300]};case f.WorldFeature.StiffnessFactor:return{feature:e,name:"Stiffness Factor",percents:[5,25,50,100,150,200,250,300,400,500]};case f.WorldFeature.IterationsPerFrame:return{feature:e,name:"Iterations per frame",percents:[10,25,50,100,200,300,500]};case f.WorldFeature.IntervalCountdown:return{feature:e,name:"Interval Countdown",percents:[10,20,30,100,150,400,1e3]};case f.WorldFeature.PretensingCountdown:return{feature:e,name:"Slack to Pretenst countdown",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.VisualStrain:return{feature:e,name:"Visual Strain",percents:[0,10,50,100,200,300,500,1e3,2e3,3e3]};case f.WorldFeature.PushOverPull:return{feature:e,name:"Compression/Tension",percents:[10,20,30,50,100,200,300,500,1e3]};case f.WorldFeature.NexusPushLength:return{feature:e,name:"Nexus Push",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.ColumnPushLength:return{feature:e,name:"Column Push",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.TriangleLength:return{feature:e,name:"Triangle",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.RingLength:return{feature:e,name:"Ring",percents:[10,80,90,100,110,120,130]};case f.WorldFeature.CrossLength:return{feature:e,name:"Cross",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.BowMidLength:return{feature:e,name:"Bow Mid",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.BowEndLength:return{feature:e,name:"Bow End",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.RibbonPushLength:return{feature:e,name:"Rib Push",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.RibbonShortLength:return{feature:e,name:"Rib Short",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.RibbonLongLength:return{feature:e,name:"Rib Long",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.RibbonHangerLength:return{feature:e,name:"Rib Hanger",percents:[50,75,90,100,125,150,200]};case f.WorldFeature.PushRadius:return{feature:e,name:"Push Radius",percents:[5,25,50,100,150,200,300]};case f.WorldFeature.PullRadius:return{feature:e,name:"Pull Radius",percents:[5,25,50,100,150,200,300]};case f.WorldFeature.JointRadiusFactor:return{feature:e,name:"Joint Radius",percents:[5,25,50,100,150,200,300]};default:throw new Error("Feature?")}}var lt=function(){function e(t,n,r){Object(d.a)(this,e),this.config=t,this.defaultValue=n,this.value$=void 0;var a=r.getValue().featureValues[t.feature],i=void 0!==a?a:{numeric:this.defaultValue,percent:100};this.value$=new s.BehaviorSubject(i),this.value$.subscribe((function(e){var n=r.getValue(),a=Object(Be.a)({},n.featureValues);a[t.feature]=e,r.next(it(n,{featureValues:a}))}))}return Object(m.a)(e,[{key:"value",get:function(){return this.value$.getValue()}},{key:"title",get:function(){return this.config.name}},{key:"percentChoices",get:function(){return this.config.percents}},{key:"numeric",get:function(){return this.value$.getValue().numeric}},{key:"formatted",get:function(){return P(this.numeric)}},{key:"percent",get:function(){return this.value$.getValue().percent},set:function(e){this.value$.next({numeric:this.defaultValue*e/100,percent:e})}},{key:"observable",get:function(){return this.value$}},{key:"worldFeature",get:function(){return this.config.feature}}]),e}();function ut(e,t){var n={};return g.map(st).forEach((function(r){n[r.feature]=new lt(r,t(r.feature),e)})),n}var ht=function(){function e(t,n,r){Object(d.a)(this,e),this.numericFeature=t,this.tensegrity=n,this._stage=void 0,this._stage=r}return Object(m.a)(e,[{key:"executeTransition",value:function(t){return this.transition(t),this._stage=t.stage,new e(this.numericFeature,this.tensegrity,t.stage)}},{key:"transition",value:function(e){var t=e.stage,n=e.adoptLengths,r=e.strainToStiffness,a=this.tensegrity;switch(this._stage){case f.Stage.Growing:switch(t){case f.Stage.Shaping:return}break;case f.Stage.Shaping:switch(t){case f.Stage.Slack:if(n)a.fabric.adopt_lengths(),Object(h.a)(a.faceIntervals).forEach((function(e){return a.removeFaceInterval(e)})),Object(h.a)(a.faceAnchors).forEach((function(e){return a.removeFaceAnchor(e)})),a.instance.snapshot();return;case f.Stage.Pretensing:return}break;case f.Stage.Slack:switch(t){case f.Stage.Shaping:case f.Stage.Pretensing:return}break;case f.Stage.Pretensing:switch(t){case f.Stage.Pretenst:return}break;case f.Stage.Pretenst:switch(t){case f.Stage.Slack:if(r)return void new G(a).stiffnessesFromStrains((function(e){switch(e.intervalRole){case f.IntervalRole.RibbonPush:case f.IntervalRole.RibbonShort:case f.IntervalRole.RibbonLong:case f.IntervalRole.RibbonHanger:return!1;default:return!(e.alpha.location().y+e.omega.location().y<.1)}}));if(n)return a.fabric.adopt_lengths(),void a.instance.snapshot()}}throw new Error("No transition ".concat(f.Stage[this._stage]," to ").concat(f.Stage[t]))}},{key:"stage",get:function(){return this._stage}}]),e}(),ft=function(){function e(t,n,r,a,i,o,c,l){Object(d.a)(this,e),this.location=t,this.symmetrical=n,this.rotation=r,this.scale=a,this.roleDefaultLength=i,this.numericFeature=o,this.instance=c,this.tenscript=l,this.life$=void 0,this.joints=[],this.intervals=[],this.faceIntervals=[],this.faceAnchors=[],this.faces=[],this.bricks=[],this.activeTenscript=void 0,this.transitionQueue=[],this.instance.clear(),this.life$=new s.BehaviorSubject(new ht(o,this,f.Stage.Growing));var u=new Ze(this).createBrickAt(t,n,a);this.bricks=[u],this.activeTenscript=[{tree:this.tenscript.tree,brick:u,tensegrity:this}]}return Object(m.a)(e,[{key:"lifeTransition",value:function(e){var t=this.life$.getValue();e.stage!==t.stage&&this.life$.next(t.executeTransition(e))}},{key:"createJoint",value:function(e){return this.fabric.create_joint(e.x,e.y,e.z)}},{key:"createFaceConnector",value:function(e,t){return this.createFaceInterval(e,t)}},{key:"createFaceDistancer",value:function(e,t,n){return this.createFaceInterval(e,t,n)}},{key:"createFaceAnchor",value:function(e,t,n){var r=this,a=f.IntervalRole.FaceAnchor,i=this.createJoint(t);this.fabric.anchor_joint(i);var o={index:i,oppositeIndex:-1,location:function(){return r.instance.jointLocation(i)}};this.joints.push(o);var c=e.location().distanceTo(t),s=z(D()),l=-t.y*L(n),u=c*this.numericFeature(f.WorldFeature.IntervalCountdown),h={index:this.fabric.create_interval(e.index,o.index,a,c,l,s,0,u),alpha:e,omega:o,removed:!1};return this.faceAnchors.push(h),h}},{key:"removeFaceInterval",value:function(e){this.faceIntervals=this.faceIntervals.filter((function(t){return t.index!==e.index})),this.eliminateInterval(e.index),e.removed=!0}},{key:"removeFaceAnchor",value:function(e){var t=this;this.faceAnchors=this.faceAnchors.filter((function(t){return t.index!==e.index})),e.alpha.joints.forEach((function(e){return t.fabric.anchor_joint(e.index)})),this.eliminateInterval(e.index),e.removed=!0}},{key:"createInterval",value:function(e,t,n,r,a,i,o){var c=this,s=e.location().distanceTo(t.location()),u=L(r)*this.roleDefaultLength(n),h=this.fabric.create_interval(e.index,t.index,n,s,u,a,i,o),f={index:h,intervalRole:n,scale:r,alpha:e,omega:t,removed:!1,isPush:y(n),location:function(){return(new l.Vector3).addVectors(e.location(),t.location()).multiplyScalar(.5)},strainNuance:function(){return c.instance.floatView.strainNuances[h]}};return this.intervals.push(f),f}},{key:"changeIntervalScale",value:function(e,t){e.scale=W(L(e.scale)*t),this.fabric.multiply_rest_length(e.index,t,100)}},{key:"changeIntervalRole",value:function(e,t,n,r){e.intervalRole=t,this.fabric.set_interval_role(e.index,t),this.fabric.change_rest_length(e.index,L(n)*this.roleDefaultLength(t),r)}},{key:"removeInterval",value:function(e){this.intervals=this.intervals.filter((function(t){return t.index!==e.index})),this.eliminateInterval(e.index),e.removed=!0}},{key:"createFace",value:function(e,t){var n=A[t],r=n.negative,a=n.pushEnds,i=a.map((function(t){var n=e.pushes.find((function(n){var r=e.joints[t];return r.index===n.alpha.index||r.index===n.omega.index}));if(void 0===n)throw new Error;return n})),o=[0,1,2].map((function(n){return e.pulls[3*t+n]})),c=a.map((function(t){return e.joints[t]})),s={index:this.fabric.create_face(c[0].index,c[1].index,c[2].index),negative:r,removed:!1,brick:e,triangle:t,joints:c,pushes:i,pulls:o,location:function(){return c.reduce((function(e,t){return e.add(t.location())}),new l.Vector3).multiplyScalar(1/3)}};return this.faces.push(s),s}},{key:"removeFace",value:function(e,t){var n=this;this.fabric.remove_face(e.index),this.faces=this.faces.filter((function(t){return t.index!==e.index})),this.faces.forEach((function(t){t.index>e.index&&t.index--})),this.faceIntervals.forEach((function(t){t.alpha.index>e.index&&t.alpha.index--,t.omega.index>e.index&&t.omega.index--})),e.removed=!0,t&&e.pulls.forEach((function(e){return n.removeInterval(e)}))}},{key:"startTightening",value:function(e){this.faceIntervals=e}},{key:"iterate",value:function(){var e=this,t=this.transitionQueue.shift();t&&this.lifeTransition(t);var n=this.instance.iterate(this.life$.getValue().stage);if(void 0!==n){var r=this.activeTenscript,a=function(){return new Ze(e)};return r?(r.length>0&&(this.activeTenscript=tt(r,this.tenscript.marks)),0===r.length&&(this.activeTenscript=void 0,function(e,t,n){var r={};return e.forEach((function(e){if(void 0!==e.mark){var t=r[e.mark._];t?t.push(e):r[e.mark._]=[e]}})),Object.entries(r).map((function(e){var a=Object(X.a)(e,2),i=a[0],o=a[1],c=t[i],s=c||(1===o.length?{action:Ge.BaseFace}:{action:Ge.JoinFaces});return new mt(r[i],s,n)}))}(this.faces,this.tenscript.marks,a()).forEach((function(e){return e.execute()})),n===f.Stage.Growing)?this.fabric.finish_growing():f.Stage.Growing):(this.faceIntervals.length>0&&(this.faceIntervals=a().checkFaceIntervals(this.faceIntervals,(function(t){return e.removeFaceInterval(t)}))),n)}}},{key:"findInterval",value:function(e,t){return this.intervals.find((function(n){return n.alpha.index===e.index&&n.omega.index===t.index||n.alpha.index===t.index&&n.omega.index===e.index}))}},{key:"createFaceInterval",value:function(e,t,n){var r=!n,a=r?f.IntervalRole.FaceConnector:f.IntervalRole.FaceDistancer,i=e.location().distanceTo(t.location()),o=z(D()),c=(L(e.brick.scale)+L(t.brick.scale))/2,s=n?L(n)*i:ze(c),l=2*i*this.numericFeature(f.WorldFeature.IntervalCountdown),u={index:this.fabric.create_interval(e.index,t.index,a,i,s,o,0,l),alpha:e,omega:t,connector:r,scaleFactor:c,removed:!1};return this.faceIntervals.push(u),u}},{key:"eliminateInterval",value:function(e){this.fabric.remove_interval(e),this.faceIntervals.forEach((function(t){t.index>e&&t.index--})),this.faceAnchors.forEach((function(t){t.index>e&&t.index--})),this.intervals.forEach((function(t){t.index>e&&t.index--}))}},{key:"fabric",get:function(){return this.instance.fabric}},{key:"anchorJoints",get:function(){var e=this;return this.joints.filter((function(t){return e.fabric.is_anchor_joint(t.index)}))}},{key:"transition",set:function(e){if(void 0===e.stage)throw new Error("Undefined stage!");this.transitionQueue.push(e)}},{key:"fabricOutput",get:function(){var e=this;this.instance.refreshFloatView();var t=this.instance.floatView.idealLengths,n=this.instance.floatView.strains,r=this.instance.floatView.stiffnesses,a=this.instance.floatView.linearDensities;return{name:this.tenscript.name,joints:this.joints.map((function(t){var n=t.location(),r=e.instance.fabric.is_anchor_joint(t.index),a=function(e,t){var n=t.filter((function(t){return t.alpha.index===e.index||t.omega.index===e.index})),r=n.find((function(e){return e.isPush}));if(!r)return[];var a=function(t){return(new l.Vector3).subVectors(N(t,e).location(),e.location()).normalize()},i=a(r),o=n.map((function(t){return{interval:t,unit:a(t),hole:{index:0,interval:t.index,role:v(t.intervalRole),oppositeJoint:N(t,e).index,chords:[]}}})).sort((function(e,t){var n=e.unit.dot(i),r=t.unit.dot(i);return n<r?1:n>r?-1:0}));return o.forEach((function(e,t){return e.hole.index=t})),o.forEach((function(e){var t;o.filter((function(t){return t.hole.index!==e.hole.index&&t.unit.dot(e.unit)>.1})).sort((t=e.unit,function(e,n){var r=e.unit.dot(t),a=n.unit.dot(t);return r<a?1:r>a?-1:0})).forEach((function(t){var n=Math.acos(e.unit.dot(t.unit)),r=2*Math.sin(n/2);e.hole.chords.push({holeIndex:t.hole.index,length:r})}))})),o.map((function(e){return e.hole}))}(t,e.intervals);return{index:t.index,x:n.x,y:n.z,z:n.y,anchor:r,holes:a}})),intervals:this.intervals.map((function(i){var o=e.numericFeature(i.isPush?f.WorldFeature.PushRadius:f.WorldFeature.PullRadius)*L(i.scale),c=o*e.numericFeature(f.WorldFeature.JointRadiusFactor),s=i.alpha.location().distanceTo(i.omega.location())+(i.isPush?2*-c:2*c),l=i.alpha.index,u=i.omega.index;if(l>=e.joints.length||u>=e.joints.length)throw new Error("Joint not found ".concat(v(i.intervalRole),":").concat(l,",").concat(u,":").concat(e.joints.length));return{index:i.index,joints:[l,u],type:i.isPush?"Push":"Pull",strain:n[i.index],stiffness:r[i.index],linearDensity:a[i.index],role:v(i.intervalRole),idealLength:t[i.index],isPush:i.isPush,length:s,radius:o,jointRadius:c}}))}}}]),e}();var dt,mt=function(){function e(t,n,r){Object(d.a)(this,e),this.faces=t,this.mark=n,this.builder=r}return Object(m.a)(e,[{key:"execute",value:function(){switch(this.mark.action){case Ge.Subtree:break;case Ge.BaseFace:this.builder.faceToOrigin(this.faces[0]);break;case Ge.JoinFaces:case Ge.FaceDistance:this.builder.createFaceIntervals(this.faces,this.mark);break;case Ge.Anchor:this.builder.createFaceAnchor(this.faces[0],this.mark)}}}]),e}();!function(e){e.Forward="Forward",e.Left="Left",e.Right="Right",e.MusclePeriod="Attack",e.AttackPeriod="Attack",e.DecayPeriod="Decay",e.TwitchNuance="TwitchNuance",e.TicksPerSlice="TicksPerSlice"}(dt||(dt={}));var gt=Object.keys(dt).filter((function(e){return function(e){switch(e){case dt.Forward:case dt.Left:case dt.Right:return!1;case dt.MusclePeriod:case dt.AttackPeriod:case dt.DecayPeriod:case dt.TwitchNuance:case dt.TicksPerSlice:return!0}}(dt[e])})).map((function(e){return dt[e]}));function vt(){return new yt(xt,[])}function pt(e){if(0===e.length)return vt();var t=e.map((function(e){var t=e.geneName,n=e.tosses,r=e.geneString;return{geneName:t,tosses:n,dice:r.split("").map((function(e){return Et[e]})).filter((function(e){return!!e}))}}));return new yt(xt,t)}function bt(e,t){var n=t.find((function(t){var n=t.geneName;return e===n}));if(n)return n;var r={geneName:e,tosses:0,dice:[]};return t.push(r),r}var yt=function(){function e(t,n){Object(d.a)(this,e),this.roll=t,this.genes=n}return Object(m.a)(e,[{key:"createReader",value:function(e){return new Pt(bt(e,this.genes),this.roll)}},{key:"withMutations",value:function(t,n){var r=this,a=this.genes.map((function(e){return{geneName:e.geneName,tosses:e.tosses,dice:e.dice.slice()}}));(t.forEach((function(e){!function(e,t){if(0===t.dice.length)t.dice.push(e());else for(var n=Math.floor(Math.random()*t.dice.length),r=t.dice[n];t.dice[n]===r;)t.dice[n]=e();t.tosses++}((function(){return r.roll()}),bt(e,a))})),n)&&bt(n,a).tosses++;return new e(this.roll,a)}},{key:"toString",value:function(){return this.genes.map((function(e){return"(".concat(e.geneName,":").concat(e.tosses,")")})).join(", ")}},{key:"totalTwitches",get:function(){var e=this.genes.reduce((function(e,t){var n=t.tosses;return Math.max(e,n)}),0);return Math.floor(Math.pow(e,.66))+2}},{key:"geneData",get:function(){return this.genes.map((function(e){return{geneName:e.geneName,tosses:e.tosses,geneString:function(e){return e.map((function(e){return e.symbol})).join("")}(e.dice)}}))}},{key:"tosses",get:function(){return this.genes.reduce((function(e,t){return e+t.tosses}),0)}}]),e}(),wt=[{index:0,numeral:"1",symbol:"\u2680",featureDelta:1/1.1/1.1/1.1},{index:1,numeral:"2",symbol:"\u2681",featureDelta:1/1.1/1.1},{index:2,numeral:"3",symbol:"\u2682",featureDelta:1/1.1},{index:3,numeral:"4",symbol:"\u2683",featureDelta:1.1},{index:4,numeral:"5",symbol:"\u2684",featureDelta:1.1*1.1},{index:5,numeral:"6",symbol:"\u2685",featureDelta:1.1*1.1*1.1}],Et=function(){var e={};return wt.forEach((function(t){e[t.numeral]=t,e[t.symbol]=t})),e}();function St(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Math.floor(Ft(n)*e)}function kt(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Ft(n)*e}var Pt=function(){function e(t,n){Object(d.a)(this,e),this.gene=t,this.roll=n,this.cursor=0}return Object(m.a)(e,[{key:"readMuscleTwitch",value:function(e,t,n,r){var a=St(2*e.length,this.next(),this.next(),this.next()),i=a%2===0,o=e[Math.floor(a/2)];return{when:St(36,this.next(),this.next()),muscle:o,alternating:i,attack:(2+kt(6,this.next()))*t,decay:(2+kt(6,this.next()))*n,twitchNuance:r}}},{key:"modifyFeature",value:function(e){var t=e;0===this.gene.tosses&&this.gene.tosses++;for(var n=0;n<this.gene.tosses;n++)t*=.5*this.next().featureDelta+.5;return t}},{key:"next",value:function(){for(;this.gene.dice.length<this.cursor+1;)this.gene.dice.push(this.roll());return this.gene.dice[this.cursor++]}},{key:"length",get:function(){return this.gene.dice.length}}]),e}();function xt(){return wt[Math.floor(Math.random()*wt.length)]}function Ft(e){if(0===e.length)throw new Error("No dice!");return e.reduce((function(e,t){return 6*e+t.index}),0)/Math.pow(6,e.length)}var jt,Ot=function(){function e(t){var n=this;Object(d.a)(this,e),this.state=t,this.cycleCount=0,this.twitchCount=0,this.config=void 0,this.ticks=0,this.twitchCycles={};var r=this.state.genome;this.config=function(e){var t=e.createReader(dt.MusclePeriod).modifyFeature(600);return{ticksPerSlice:e.createReader(dt.TicksPerSlice).modifyFeature(4),twitchNuance:e.createReader(dt.TwitchNuance).modifyFeature(.3),musclePeriod:t,attackPeriod:e.createReader(dt.AttackPeriod).modifyFeature(t),decayPeriod:e.createReader(dt.DecayPeriod).modifyFeature(t)}}(r);var a=r.totalTwitches;It.filter((function(e){return e!==jt.Rest})).forEach((function(e){var i=Mt(e),o=r.createReader(i);n.twitchCycles[e]=new Rt(o,n.config,t.muscles,a)}))}return Object(m.a)(e,[{key:"toString",value:function(){var e=this,t=Object.keys(this.twitchCycles).map((function(t){return e.twitchCycles[t]})).map((function(e){return e.toString()})).join("\n");return"Twitcher(".concat(t,")")}},{key:"tick",value:function(e){if(this.ticks--,this.ticks<0){this.ticks=this.config.ticksPerSlice;var t=this.state;if(t.timeSlice++,t.timeSlice>=36)return t.timeSlice=0,this.cycleCount++,!0;var n=this.twitchCycles[t.direction];n&&(this.twitchCount+=n.activate(t.timeSlice,e))}return!1}}]),e}(),Rt=function(){function e(t,n,r,a){Object(d.a)(this,e),this.slices={};for(var i=Object(h.a)(r),o=function(e){i=i.filter((function(t){var n=t.faceIndex;return e.faceIndex!==n}))};a-- >0;){var c=n.attackPeriod,s=n.decayPeriod,l=n.twitchNuance,u=t.readMuscleTwitch(i,c,s,l);this.addTwitch(u.when,u),o(u.muscle);var f=Dt(u.muscle,i),m=u.alternating?(u.when+18)%36:u.when;this.addTwitch(m,Object(Be.a)({},u,{muscle:f,when:m})),o(f)}}return Object(m.a)(e,[{key:"toString",value:function(){var e=this,t=Object.keys(this.slices).map((function(t){return e.slices[t]})).map((function(e){return e.map((function(e){return"".concat(e.when,":").concat(e.muscle.faceIndex)})).join(";")})).join(",");return"Cycle(".concat(t,")")}},{key:"activate",value:function(e,t){var n=this.slices[e];return n?(n.forEach((function(e){var n=e.muscle,r=e.attack,a=e.decay,i=e.twitchNuance;return t(n,r,a,i)})),n.length):0}},{key:"addTwitch",value:function(e,t){var n=this.slices[e];n?n.push(t):this.slices[e]=[t]}}]),e}(),Ct="'Gorillagotchi':(A(4,S80,Mb0),b(4,S80,Mb0),a(2,S70,Md0),B(2,Md0,S70)):0=face-distance-60",Nt="'Satoshi Tree':(2,S85,b(4,S85,MA0),c(4,S85,MA0),d(4,S85,MA0)):0=subtree(b(3, S85),c(3, S85),d(3, S85))";!function(e){e.Rest="Rest",e.Forward="Forward",e.Left="Left",e.Right="Right"}(jt||(jt={}));var Vt,It=Object.keys(jt).map((function(e){return jt[e]}));function Mt(e){switch(e){case jt.Forward:return dt.Forward;case jt.Left:return dt.Left;case jt.Right:return dt.Right;default:throw new Error("No gene for direction ".concat(e))}}function At(e,t,n){return{patch:e,targetPatch:e.adjacent[e.rotation],instance:t,muscles:[],extremities:[],genome:n,direction:jt.Rest,directionHistory:[],autopilot:!1,timeSlice:0,reachedTarget:!1,twitchesPerCycle:30}}!function(e){e.FrontLeft="front-left",e.FrontRight="front-right",e.BackLeft="back-left",e.BackRight="back-right"}(Vt||(Vt={}));var Tt=function(){function e(t,n){Object(d.a)(this,e),this.state=t,this.embryo=n,this.shapingTime=50,this.twitcher=void 0,n||(this.twitcher=new Ot(this.state))}return Object(m.a)(e,[{key:"snapshot",value:function(){this.state.instance.snapshot()}},{key:"recycled",value:function(t,n){var r=pt(n||this.patch.storedGenes[0]);return new e(Object(Be.a)({},this.state,{instance:t,genome:r,directionHistory:[]}))}},{key:"getCycleCount",value:function(e){return this.twitcher?e?Math.floor(this.twitcher.twitchCount/this.state.twitchesPerCycle):this.twitcher.cycleCount:0}},{key:"adoptFabric",value:function(e){return this.state.instance.adoptFabric(e)}},{key:"getExtremity",value:function(e){var t=this.state.extremities.find((function(t){return t.limb===e}));if(!t)throw new Error("No extremity found");return t}},{key:"mutatedGeneData",value:function(){var e=this,t=It.map((function(t){var n=e.state.directionHistory.filter((function(e){return e===t})).length;return{dir:t,count:n}})).filter((function(e){return e.count>0})).map((function(e){return e.dir})).map(Mt),n=Math.random()>.95?gt[Math.floor(Math.random()*gt.length)]:void 0;return this.state.genome.withMutations(t,n).geneData}},{key:"getMidpoint",value:function(e){e||(e=new l.Vector3);var t=this.state.instance.view;return e.set(t.midpoint_x(),t.midpoint_y(),t.midpoint_z()),e}},{key:"iterate",value:function(e){var t=this,n=this.state,r=n.instance,a=r.view;e&&e.set(a.midpoint_x(),a.midpoint_y(),a.midpoint_z());var i=this.embryo;if(!i){if(r.iterate(f.Stage.Pretenst),this.twitcher){this.twitcher.tick((function(e,n,r,a){return t.twitch(e,n,r,a)}))&&this.state.autopilot&&(this.reachedTarget?this.direction=jt.Rest:this.checkDirection())}return!0}var o,c,s,l=i.iterate(),u=i.life$.getValue();switch(u.stage===f.Stage.Pretensing&&l===f.Stage.Pretenst?i.transition={stage:f.Stage.Pretenst}:void 0!==l&&l!==u.stage&&u.stage!==f.Stage.Pretensing&&(i.transition={stage:l}),l){case f.Stage.Shaping:if(this.shapingTime<=0)r.fabric.adopt_lengths(),Object(h.a)(i.faceIntervals).forEach((function(e){return i.removeFaceInterval(e)})),r.iterate(f.Stage.Slack),r.iterate(f.Stage.Pretensing);else this.shapingTime--;return!1;case f.Stage.Pretensing:return!0;case f.Stage.Pretenst:return o=i,c=n.muscles,s=n.extremities,o.faces.filter((function(e){return!e.removed&&e.brick.parentFace})).forEach((function(e){var t=[],n=function e(t,n){var r=A[t.triangle];n.push(r.negative?r.opposite:r.name);var a=t.brick.parentFace;return a?e(a,n):function(e){switch(e){case j.NNN:return Vt.BackLeft;case j.PNN:return Vt.BackRight;case j.NPP:return Vt.FrontLeft;case j.PPP:return Vt.FrontRight;default:throw new Error("Strange limb")}}(t.triangle)}(e,t),r=t.shift(),a=e.triangle;if(!r)throw new Error("no top!");var i=t.length,o=e.index;if(function(e){var t=A[e];return(t.negative?t.opposite:e)===j.PPP}(r)){var l="[".concat(n,"]");s.push({faceIndex:o,name:l,limb:n})}else{var u="[".concat(n,"]:[").concat(i,":").concat(j[r],"]:{tri=").concat(j[a],"}");c.push({faceIndex:o,name:u,limb:n,distance:i,group:r,triangle:a})}})),i.transition={stage:f.Stage.Pretenst},i.iterate(),this.embryo=void 0,this.twitcher=new Ot(n),!0;default:return!1}}},{key:"showFrozen",value:function(){this.instance.showFrozen(this.reachedTarget)}},{key:"checkDirection",value:function(){var e=this.state;this.reachedTarget?this.direction=jt.Rest:(e.direction=this.directionToTarget,e.directionHistory.push(e.direction))}},{key:"twitch",value:function(e,t,n,r){this.state.instance.fabric.twitch_face(e.faceIndex,t,n,r)}},{key:"quaternionForDirection",value:function(e){var t=this;return(new l.Quaternion).setFromUnitVectors(K,function(){var n=t.state.instance;switch(e){case jt.Rest:case jt.Forward:return n.forward;case jt.Left:return n.left;case jt.Right:return n.right}}())}},{key:"twitcherString",get:function(){return this.twitcher?this.twitcher.toString():"no twitcher"}},{key:"growing",get:function(){return!!this.embryo}},{key:"genome",get:function(){return this.state.genome},set:function(e){this.state.genome=e}},{key:"patch",get:function(){return this.state.patch}},{key:"instance",get:function(){return this.state.instance}},{key:"autopilot",get:function(){return this.state.autopilot},set:function(e){this.state.autopilot=e,e&&this.checkDirection()}},{key:"direction",get:function(){return this.state.direction},set:function(e){this.state.direction=e,this.autopilot=!1}},{key:"fabricClone",get:function(){return this.state.instance.fabricClone}},{key:"view",get:function(){return this.state.instance.view}},{key:"age",get:function(){return this.state.instance.fabric.age}},{key:"distanceFromTarget",get:function(){return this.getMidpoint().distanceTo(this.target)}},{key:"target",get:function(){return this.state.targetPatch.center}},{key:"showDirection",get:function(){return this.state.direction!==jt.Rest}},{key:"directionQuaternion",get:function(){return this.quaternionForDirection(this.state.direction)}},{key:"reachedTarget",get:function(){return this.distanceFromTarget<4}},{key:"topJointLocation",get:function(){var e=this.state.instance.floatView.jointLocations;return new l.Vector3(e[9],e[10],e[11])}},{key:"directionToTarget",get:function(){var e=this.toTarget,t=this.state.instance;t.refreshFloatView();var n=e.dot(t.forward),r=e.dot(t.right);return r>0?n>r?jt.Forward:jt.Right:n>-r?jt.Forward:jt.Left}},{key:"toTarget",get:function(){var e=new l.Vector3,t=this.state.instance.view,n=new l.Vector3(t.midpoint_x(),t.midpoint_y(),t.midpoint_z());return e.subVectors(this.target,n),e.y=0,e.normalize(),e}}]),e}();function Dt(e,t){var n=e.name,r=e.limb,a=e.distance,i=e.triangle,o=A[i].opposite,c=function(e){switch(e){case Vt.BackRight:return Vt.BackLeft;case Vt.BackLeft:return Vt.BackRight;case Vt.FrontRight:return Vt.FrontLeft;case Vt.FrontLeft:return Vt.FrontRight;default:throw new Error("Strange limb")}}(r),s=t.find((function(e){return e.limb===c&&e.distance===a&&e.triangle===o}));if(!s)throw new Error("Unable to find opposite muscle to ".concat(n));return s}function Lt(e,t){switch(e){case f.WorldFeature.IterationsPerFrame:return 2*t;case f.WorldFeature.Gravity:return t;case f.WorldFeature.Drag:return 5*t;case f.WorldFeature.ShapingStiffnessFactor:return 2*t;case f.WorldFeature.PushRadius:return 3*t;case f.WorldFeature.PullRadius:return 2*t;case f.WorldFeature.JointRadiusFactor:return.8*t;case f.WorldFeature.PretensingCountdown:return.5*t;case f.WorldFeature.PretenstFactor:case f.WorldFeature.StiffnessFactor:return t;case f.WorldFeature.PushOverPull:return.25;default:return t}}function Wt(e,t){switch(e){case f.WorldFeature.Gravity:return 5*t;case f.WorldFeature.IntervalCountdown:return.1*t;case f.WorldFeature.Antigravity:return.3*t;case f.WorldFeature.Drag:return 0;case f.WorldFeature.PretenstFactor:return 5*t;case f.WorldFeature.StiffnessFactor:return 8*t;case f.WorldFeature.PretensingCountdown:return.02*t;default:return t}}var _t,Bt=[5,6,7,8,9,10],zt=8,Gt=8;!function(e){e.WinnersRun="Winners run",e.ChallengersBorn="Challengers born",e.ChallengersReborn="Challengers reborn",e.ChallengersRun="Challengers run",e.WinnersStored="Winners stored",e.EvolutionAdvance="Evolution advance",e.EvolutionDone="Evolution done",e.EvolutionHarder="Evolution harder"}(_t||(_t={}));var Zt=function(){function e(t,n,r,a){if(Object(d.a)(this,e),this.evolvingGotchi=t,this.createInstance=n,this.useTwitches=r,this.cyclePattern=a,this.snapshotsSubject=new s.BehaviorSubject([]),this.winners=[],this.challengersVisible=!1,this.challengers=[],this.phase=_t.WinnersRun,this.cyclePatternIndex=void 0,this.currentCycle=0,this.currentMaxCycles=void 0,this.gotchiMidpoint=new l.Vector3,t.embryo)throw new Error("Cannot create evolution from gotchi which is not pretenst");t.checkDirection(),this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex=0];for(var i=[],o=t.patch.storedGenes;i.length<zt;)i.push(this.createAutoGotchi(pt(o[i.length%o.length])));this.winners=i.map((function(e,t){return{gotchi:e,name:Yt(t),proximityHistory:[],persisted:!0}}))}return Object(m.a)(e,[{key:"iterate",value:function(){var e=this;switch(this.phase){case _t.WinnersRun:var t=0,n=!1;if(this.winners.forEach((function(r){var a=r.gotchi,i=a.getCycleCount(e.useTwitches);i>t&&(t=i),i<e.currentMaxCycles&&(a.iterate(),n=!0)})),t>this.currentCycle&&(Ut(this.winners,this.currentCycle),this.currentCycle=t),!n)!this.winners.find((function(e){return!e.gotchi.reachedTarget}))?this.phase=_t.EvolutionDone:(this.winners.forEach((function(e){return e.gotchi.showFrozen()})),this.phase=0===this.challengers.length?_t.ChallengersBorn:_t.ChallengersReborn,this.currentCycle=0);break;case _t.ChallengersBorn:for(var r=[];r.length<Gt;){var a=pt(this.winners[r.length%this.winners.length].gotchi.genome.geneData);r.push(this.createAutoGotchi(a.withMutations([Mt(this.evolvingGotchi.direction)])))}this.challengers=r.map((function(t,n){return t.autopilot=!0,{gotchi:t,name:"".concat(Yt(n+e.winners.length)).concat(Yt(n%e.winners.length)),proximityHistory:[],persisted:!1}})),this.phase=_t.ChallengersRun;break;case _t.ChallengersReborn:var i=0;this.challengers=this.challengers.map((function(t,n){var r=i++%e.winners.length,a=e.winners[r],o=t.gotchi.adoptFabric(e.evolvingGotchi.fabricClone),c=t.gotchi.recycled(o,a.gotchi.mutatedGeneData()),s="".concat(a.name).concat(Yt(n));return c.autopilot=!0,{gotchi:c,name:s,proximityHistory:[],persisted:!1}})),this.phase=_t.ChallengersRun;break;case _t.ChallengersRun:this.challengersVisible=!0;var o=!1,c=0;if(this.challengers.forEach((function(t){var n=t.gotchi,r=(t.name,n.getCycleCount(e.useTwitches));r>c&&(c=r),r<e.currentMaxCycles&&(n.iterate(),o=!0)})),c>this.currentCycle){var s=[].concat(Object(h.a)(this.winners),Object(h.a)(this.challengers));Ut(s,this.currentCycle),this.broadcastSnapshot(s.map((function(t){return $t(t,e.currentCycle)}))),this.currentCycle=c}o||(this.phase=_t.WinnersStored);break;case _t.WinnersStored:var l=this.splitEvolvers(this.currentCycle),u=l.winners,f=l.losers;this.evolvingGotchi.patch.storedGenes=u.map((function(e){return e.gotchi.genome.geneData})),u.forEach((function(e){return e.persisted=!0})),f.forEach((function(e){return e.persisted=!1})),this.broadcastSnapshot(u.map((function(t){return $t(t,e.currentCycle)}))),this.winners=u,this.challengers=f,this.challengersVisible=!1,this.phase=_t.EvolutionAdvance;break;case _t.EvolutionAdvance:if(this.cyclePatternIndex===this.cyclePattern.length-1){var d=!this.winners.find((function(e){return!e.gotchi.reachedTarget}));this.phase=d?_t.EvolutionHarder:_t.EvolutionDone}else this.cyclePatternIndex++,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex],this.currentCycle=0,this.phase=_t.WinnersRun;break;case _t.EvolutionDone:case _t.EvolutionHarder:}return this.phase}},{key:"getMidpoint",value:function(e){var t=this;return this.winners.forEach((function(n){var r=n.gotchi;return e.add(r.getMidpoint(t.gotchiMidpoint))})),e.multiplyScalar(1/this.winners.length),e}},{key:"splitEvolvers",value:function(e){var t=[],n=[],r=[].concat(Object(h.a)(this.winners),Object(h.a)(this.challengers));return Ut(r,e),r.forEach((function(e,r){r<zt?t.push(e):n.push(e)})),{cycleCount:e,winners:t,losers:n}}},{key:"broadcastSnapshot",value:function(e){var t=this.currentCycle,n=this.cyclePatternIndex,r={cycle:t,cyclePattern:this.cyclePattern,cycleIndex:n,evolverSnapshots:e},a=this.snapshotsSubject.getValue(),i=a.findIndex((function(e){return r.cycleIndex===e.cycleIndex}));if(i<0)this.snapshotsSubject.next([].concat(Object(h.a)(a),[r]));else if(i===a.length-1){var o=Object(h.a)(a);o[i]=r,this.snapshotsSubject.next(o)}else this.snapshotsSubject.next([r])}},{key:"createAutoGotchi",value:function(e){var t=this.createInstance(!1,this.evolvingGotchi.fabricClone),n=this.evolvingGotchi.recycled(t,e.geneData);return n.autopilot=!0,n}},{key:"withReducedCyclePattern",get:function(){var t=Object(h.a)(this.cyclePattern);if(t.pop(),!(t.length<3))return new e(this.evolvingGotchi,this.createInstance,this.useTwitches,t)}},{key:"target",get:function(){return this.evolvingGotchi.target}}]),e}();function Ut(e,t){e.forEach((function(e){e.proximityHistory.length===t&&e.proximityHistory.push(e.gotchi.distanceFromTarget)})),e.sort((function(e,n){return e.proximityHistory[t]-n.proximityHistory[t]}))}function $t(e,t){var n=e.gotchi,r=e.proximityHistory,a=e.persisted,i=e.name,o=r[t];if(void 0===o)throw new Error("Cannot snapshot");var c=n.genome.tosses;return{name:i,proximity:o,reachedTarget:n.reachedTarget,tosses:c,persisted:a}}function Yt(e){return String.fromCharCode(65+e)}function Xt(e){var t=e.snapshots;return o.createElement("div",{className:"text-monospace d-inline-flex"},t.map((function(e){return o.createElement("div",{key:e.cycleIndex,className:"float-left p-1 m-1",style:{borderStyle:"solid",borderWidth:"2px"}},o.createElement(Jt,{snapshot:e}),o.createElement("div",{className:"m-2"},e.evolverSnapshots.map((function(e,t){for(var n=e.name,r=e.reachedTarget,a=e.persisted,i=e.proximity,c=e.tosses,s=[],l=n.length-1;l>0;)s.push(o.createElement(J.o,{key:"".concat(n,"-").concat(l)})),l--;var u=r?o.createElement(J.V,null):void 0;return o.createElement("div",{key:"competitor-".concat(t),style:{color:a?r?"#ffffff":"#2cd710":"#c2c2c2",backgroundColor:a?r?"#b1b1b1":"#848383":"#555454",borderRadius:"0.2em",marginBottom:"1px",padding:"2px",display:"block",whiteSpace:"nowrap"}},"".concat(Yt(t)," ").concat(i.toFixed(3)," ").concat(n).concat(c),"\xa0",s,u)}))))})))}function Jt(e){var t=e.snapshot,n=t.cyclePattern,r=t.cycleIndex,a=t.cycle;return o.createElement("div",{className:"p-1 my-2 w-100 text-center"},n.map((function(e,t){return o.createElement("span",{key:"cycle-".concat(t),style:{color:"black",backgroundColor:t===r?"#24f00f":"#cbc7c7",margin:"0.1em",padding:"0.2em",borderRadius:"0.3em",borderStyle:"solid",borderWidth:"1px"}},t===r&&a<n[r]?"".concat(a+1,"/").concat(e):e)})))}var Ht,Qt=function(){function e(t,n,r){Object(d.a)(this,e),this.island=t,this.coords=n,this.patchCharacter=r,this.gotchi=void 0,this.satoshiTree=void 0,this.center=void 0,this.name=void 0,this.adjacent=[],this.rotation=0,this.center=new l.Vector3(n.x*se,0,n.y*le),this.name="(".concat(n.x,",").concat(n.y,")")}return Object(m.a)(e,[{key:"createGotchi",value:function(e){var t=this.island.source.newGotchi(this,e,pt(this.storedGenes[0]));return this.gotchi=t,t}},{key:"createNewSatoshiTree",value:function(e){var t=this.island.source.newSatoshiTree(this,e);return this.satoshiTree=t,t}},{key:"onClick",get:function(){var e=this;return function(){e.satoshiTree?(e.satoshiTree.removeRandomInterval(),console.log("remove",e.name)):(e.rotation=(e.rotation+1)%6,console.log("rotate",e.name,e.rotation))}}},{key:"storedGenes",get:function(){var e=localStorage.getItem(this.name);return e?JSON.parse(e):[vt().geneData]},set:function(e){localStorage.setItem(this.name,JSON.stringify(e))}},{key:"positionArray",get:function(){for(var e=this,t=new Float32Array(54),n=0,r=function(r){var a=(new l.Vector3).copy(e.center).addScaledVector(r,.99),i=a.x,o=a.y,c=a.z;t[n++]=i,t[n++]=o,t[n++]=c},a=0;a<6;a++){var i=(a+1)%6;r(new l.Vector3),r(ue[a]),r(ue[i])}return t}},{key:"normalArray",get:function(){for(var e=new Float32Array(54),t=0,n=function(n){var r=n.x,a=n.y,i=n.z;e[t++]=r,e[t++]=a,e[t++]=i},r=0;r<6;r++){var a=(r+1)%6;n(de),n((new l.Vector3).add(de).addScaledVector(ue[r],.9/25).normalize()),n((new l.Vector3).add(de).addScaledVector(ue[a],.9/25).normalize())}return e}}]),e}();!function(e){e.FaunaPatch="Fauna",e.FloraPatch="Flora"}(Ht||(Ht={}));var qt,Kt=function(){function e(t,n,r){Object(d.a)(this,e),this.source=t,this.name=n,this.patches=[],this._seed=void 0,this._seed=r%2147483647,this.fill()}return Object(m.a)(e,[{key:"findPatch",value:function(e){return this.patches.find((function(t){return n=t.coords,r=e,n.x===r.x&&n.y===r.y;var n,r}))}},{key:"fill",value:function(){var e=this;this.createSurroundedPatch({x:0,y:0}),this.patches.forEach((function(t){var n=t.coords;ie.forEach((function(r){var a=r.x,i=r.y;t.adjacent.push(e.findPatch({x:a+n.x,y:i+n.y}))}))}))}},{key:"createSurroundedPatch",value:function(e){var t=this,n=this.getOrCreatePatch(e);return ae.map((function(n){return t.getOrCreatePatch((a=e,{x:(r=n).x+a.x,y:r.y+a.y}));var r,a})),n}},{key:"getOrCreatePatch",value:function(e){var t=this.findPatch(e);if(t)return t;var n=this.next()>.5?Ht.FaunaPatch:Ht.FloraPatch,r=new Qt(this,e,n);return this.patches.push(r),r}},{key:"next",value:function(){return this._seed=16807*this._seed%2147483647,(this._seed-1)/2147483646}},{key:"midpoint",get:function(){return this.patches.reduce((function(e,t){return e.add(t.center)}),new l.Vector3).multiplyScalar(1/this.patches.length)}}]),e}();function en(e){var t=e.island,n=e.satoshiTrees,r=e.happening,a=e.gotchi,i=e.evolution,c=e.evolutionPhase,s=e.countdownToEvolution,u=e.stopEvolution,h=Object(H.d)().camera,f=document.getElementById("view-container"),d=Object(o.useState)(Date.now()),m=Object(X.a)(d,2),g=m[0],v=m[1],p=Object(o.useState)(Date.now()),b=Object(X.a)(p,2),y=b[0],w=b[1],E=new l.Vector3;Object(H.c)((function(){var e=S.current,t=function(t){var n=e.object.position,r=(new l.Vector3).subVectors(n,e.target),a=t-r.length();r.normalize(),n.add(r.multiplyScalar(.003*a)),n.y+=.01*(3-n.y)};switch(r){case qt.Developing:a&&t((a.iterate(E),6));break;case qt.Resting:a&&t(function(e){return e.iterate(E),10}(a));break;case qt.Running:a&&t(function(e){return e.iterate(E),6}(a));break;case qt.Evolving:i&&(t(function(e){switch(e.iterate()){case _t.EvolutionDone:console.log("Evolution DONE"),u();break;case _t.EvolutionHarder:console.log("Evolution advance..."),u(e.withReducedCyclePattern)}return e.getMidpoint(E),15}(i)),c(i.phase))}e.target.add((new l.Vector3).subVectors(E,e.target).multiplyScalar(.01)),e.update();var o=Math.floor(Math.random()*n.length);n[o].iterate();var h=Math.floor((y-g)/1e3),f=Date.now();w(f);var d=Math.floor((f-g)/1e3);r===qt.Resting&&h<d&&s(20-d)}));var S=Object(H.e)((function(e){e.minPolarAngle=0,e.maxPolarAngle=Math.PI/2,e.minDistance=.1,e.maxDistance=9e3,e.zoomSpeed=.5,e.enableZoom=!0,e.target.set(E.x,E.y,E.z),e.update()}),[]);return Object(o.useEffect)((function(){S.current.autoRotate=r===qt.Evolving,v(Date.now()),w(Date.now())}),[r]),o.createElement("group",null,o.createElement("orbit",{ref:S,args:[h,f]}),o.createElement("scene",null,i&&r===qt.Evolving?o.createElement(tn,{evolution:i}):a?o.createElement(nn,{gotchi:a,faces:!0}):void 0,t.patches.map((function(e){var t=e.positionArray,n=e.normalArray;return o.createElement("mesh",{key:"patch-".concat(e.name),onClick:e.onClick},o.createElement("meshPhongMaterial",{attach:"material",color:e.patchCharacter===Ht.FaunaPatch?he:fe}),o.createElement("bufferGeometry",{attach:"geometry"},o.createElement("bufferAttribute",{attachObject:["attributes","position"],array:t,count:t.length/3,itemSize:3}),o.createElement("bufferAttribute",{attachObject:["attributes","normal"],array:n,count:n.length/3,itemSize:3})))})),n.map((function(e){return o.createElement(rn,{key:"tree-".concat(e.name),satoshiTree:e})})),o.createElement("pointLight",{distance:1e3,decay:.1,position:me}),o.createElement("hemisphereLight",{name:"Hemi",color:ge})))}function tn(e){var t=e.evolution,n=new l.Vector3;t.getMidpoint(n);var r=t.target;return o.createElement("group",null,t.winners.map((function(e,t){var n=e.gotchi;return o.createElement(nn,{key:"evolving-".concat(t),gotchi:n,faces:!1})})),t.challengersVisible?t.challengers.map((function(e,n){var r=e.gotchi;return o.createElement(nn,{key:"evolving-".concat(n+t.winners.length),gotchi:r,faces:!1})})):void 0,o.createElement("lineSegments",null,o.createElement("bufferGeometry",{attach:"geometry"},o.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([n.x,0,n.z,n.x,6,n.z,n.x,6,n.z,r.x,6,r.z,r.x,6,r.z,r.x,0,r.z]),count:6,itemSize:3,onUpdate:function(e){return e.needsUpdate=!0}})),o.createElement("lineBasicMaterial",{attach:"material",color:"#cace02"})))}function nn(e){var t=e.gotchi,n=e.faces,r=t.topJointLocation,a=t.target,i=t.state,c=t.showDirection,s=i.instance.floatView;return o.createElement("group",null,o.createElement("lineSegments",{geometry:s.lineGeometry,onUpdate:function(e){return e.geometry.computeBoundingSphere()}},o.createElement("lineBasicMaterial",{attach:"material",vertexColors:!0})),n?o.createElement("mesh",{geometry:s.faceGeometry,onUpdate:function(e){return e.geometry.computeBoundingSphere()}},o.createElement("meshPhongMaterial",{attach:"material",transparent:!0,side:l.DoubleSide,opacity:.6,color:"white"})):void 0,c?o.createElement("group",null,o.createElement("lineSegments",null,o.createElement("bufferGeometry",{attach:"geometry"},o.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([r.x,r.y,r.z,a.x,r.y,a.z]),count:2,itemSize:3,onUpdate:function(e){return e.needsUpdate=!0}})),o.createElement("lineBasicMaterial",{attach:"material",color:"#cecb05"})),o.createElement("lineSegments",{geometry:ve,quaternion:t.directionQuaternion,position:t.topJointLocation},o.createElement("lineBasicMaterial",{attach:"material",color:"#05cec0"}))):void 0)}function rn(e){var t=e.satoshiTree.instance.floatView;return o.createElement("mesh",{geometry:t.faceGeometry},o.createElement("meshPhongMaterial",{attach:"material",side:l.DoubleSide,color:"green"}))}function an(e){var t=e.island,n=e.homePatch,r=e.createInstance,a=Object(o.useState)((function(){return t.patches.filter((function(e){return e.patchCharacter===Ht.FloraPatch})).map((function(e){return e.createNewSatoshiTree(r(!0))}))})),i=Object(X.a)(a,1)[0],c=Object(o.useState)((function(){return n.createGotchi(r(!1))})),s=Object(X.a)(c,2),l=s[0],u=s[1],h=Object(o.useState)(qt.Developing),d=Object(X.a)(h,2),m=d[0],g=d[1],v=Object(o.useState)(!0),b=Object(X.a)(v,2),y=b[0],w=b[1],S=Object(o.useState)([]),P=Object(X.a)(S,2),x=P[0],F=P[1],j=Object(o.useState)(-1),O=Object(X.a)(j,2),R=O[0],C=O[1],N=Object(o.useState)(void 0),V=Object(X.a)(N,2),I=V[0],M=V[1],A=Object(o.useState)(_t.WinnersRun),T=Object(X.a)(A,2),D=T[0],L=T[1],W=Object(o.useState)(void 0),_=Object(X.a)(W,2),B=_[0],z=_[1];Object(o.useEffect)((function(){if(l&&l.embryo){g(qt.Developing);var e=l.embryo.life$.subscribe((function(e){e.stage===f.Stage.Pretenst&&g(qt.Resting),z(e)}));return function(){return e.unsubscribe()}}z(void 0)}),[l]),Object(o.useEffect)((function(){if(I){var e=I.snapshotsSubject.subscribe(F);return function(){return e.unsubscribe()}}}),[I]);var G=function(e,t){M(I?I.withReducedCyclePattern:new Zt(e,r,!1,t)),g(qt.Evolving)};return o.createElement("div",{id:"view-container",style:{position:"absolute",left:0,right:0,height:"100%"}},o.createElement(H.a,{key:t.name,style:{backgroundColor:"black"}},o.createElement(sn,null),o.createElement(en,{island:t,satoshiTrees:i,happening:m,gotchi:l,evolution:I,evolutionPhase:function(e){e!==D&&L(e)},countdownToEvolution:function(e){C(e),l&&0===e&&G(l,Bt)},stopEvolution:function(e){M(e),e||(u(n.createGotchi(r(!1))),g(qt.Developing))}})),l?m===qt.Developing?B?o.createElement("div",{id:"bottom-middle"},o.createElement("div",{className:"py-2 px-3 text-center"},o.createElement(J.f,null)," ",E(B.stage))):o.createElement("h1",null,"no life"):o.createElement(on,{gotchi:l,happening:m,evolutionCountdown:R,evoDetails:y,toRunning:function(){g(qt.Running),l.autopilot=!0},toEvolving:function(){g(qt.Evolving),C(-1),G(l,Bt)},toRebirth:function(){u(n.createGotchi(r(!1))),g(qt.Developing)},toRest:function(){g(qt.Resting),l.direction=jt.Rest},toggleEvoDetails:function(){return w(!y)}}):o.createElement("h1",null,"no gotchi"),I?o.createElement(o.Fragment,null,o.createElement("div",{id:"top-middle"},x.length<=0||y?o.createElement("strong",{className:"p-2"},D):o.createElement(Jt,{snapshot:x[x.length-1]})),o.createElement(cn,{happening:m,evolution:I,snapshots:x,evoDetails:y})):void 0,o.createElement("div",{id:"bottom-right"},o.createElement(Q.a,{vertical:!1,className:"w-100"},o.createElement(q.a,{onClick:function(){return k(p.Design)}},o.createElement(J.P,null)))))}function on(e){var t=e.gotchi,n=e.happening,r=e.evoDetails,a=e.evolutionCountdown,i=e.toRunning,c=e.toRest,s=e.toEvolving,l=e.toRebirth,u=e.toggleEvoDetails,h=function(){switch(n){case qt.Developing:return o.createElement("h1",null,"developing");case qt.Resting:return t?o.createElement(Q.a,{className:"w-100"},o.createElement(q.a,{color:"success",onClick:i},o.createElement(J.N,null)),o.createElement(q.a,{color:"success",onClick:s},o.createElement(J.o,null)," ",a>=0?a:""),o.createElement(q.a,{color:"success",onClick:l},o.createElement(J.f,null))):void 0;case qt.Running:return t?o.createElement(Q.a,{className:"w-100"},o.createElement(q.a,{color:"success",onClick:c},o.createElement(J.V,null)," Rest")):void 0;case qt.Evolving:return t?o.createElement(Q.a,{className:"w-100"},o.createElement(q.a,{color:"success",onClick:l},o.createElement(J.f,null)),o.createElement(q.a,{color:r?"success":"secondary",onClick:u},o.createElement(J.o,null),"\xa0",r?o.createElement(J.s,null):o.createElement(J.t,null))):void 0}}();return h?o.createElement("div",{id:"bottom-middle"},h):o.createElement("h1",null,n)}function cn(e){var t=e.happening,n=e.evolution,r=e.snapshots,a=e.evoDetails;switch(t){case qt.Developing:case qt.Running:case qt.Resting:return o.createElement("div",null);case qt.Evolving:return n&&r.length>0&&a?o.createElement("div",{id:"evolution-stats"},o.createElement(Xt,{snapshots:r})):o.createElement("div",null)}}function sn(e){var t=Object(o.useRef)(),n=Object(H.d)().setDefaultCamera;return Object(o.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(10,10,10),n(e)}),[]),Object(H.c)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),o.createElement("perspectiveCamera",Object.assign({ref:t},e))}!function(e){e[e.Developing=0]="Developing",e[e.Resting=1]="Resting",e[e.Running=2]="Running",e[e.Evolving=3]="Evolving"}(qt||(qt={}));var ln=function(){function e(t,n){Object(d.a)(this,e),this.name=t,this.tensegrity=n,this.shapingTime=60,this.deadInterval=void 0}return Object(m.a)(e,[{key:"removeRandomInterval",value:function(){this.deadInterval||this.tensegrity.life$.getValue().stage!==f.Stage.Pretenst||(this.deadInterval=this.tensegrity.intervals[Math.floor(Math.random()*this.tensegrity.intervals.length)])}},{key:"iterate",value:function(){var e=this.tensegrity.life$.getValue().stage,t=this.tensegrity.iterate();switch(e===f.Stage.Pretensing&&t===f.Stage.Pretenst?this.tensegrity.transition={stage:f.Stage.Pretenst}:void 0!==t&&t!==e&&e!==f.Stage.Pretensing&&(this.tensegrity.transition={stage:t}),this.deadInterval&&(this.tensegrity.removeInterval(this.deadInterval),this.deadInterval=void 0),t){case f.Stage.Shaping:if(this.shapingTime<=0){var n=this.instance;n.fabric.adopt_lengths(),n.iterate(f.Stage.Slack),n.iterate(f.Stage.Pretensing)}else this.shapingTime--;return!1;case f.Stage.Pretensing:case f.Stage.Pretenst:return!0;default:return!1}}},{key:"instance",get:function(){return this.tensegrity.instance}}]),e}(),un=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function hn(){if("serviceWorker"in navigator){if(new URL("/app",window.location.toString()).origin!==window.location.origin)return;window.addEventListener("load",(function(){var e="".concat("/app","/service-worker.js");un?(!function(e){fetch(e).then((function(t){404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then((function(e){e.unregister().then((function(){window.location.reload()}))})):fn(e)})).catch((function(){console.log("No internet connection found. App is running in offline mode.")}))}(e),navigator.serviceWorker.ready.then((function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")}))):fn(e)}))}}function fn(e){navigator.serviceWorker.register(e).then((function(e){e.onupdatefound=function(){var t=e.installing;t&&(t.onstatechange=function(){"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))})}})).catch((function(e){console.error("Error during service worker registration:",e)}))}function dn(e,t){switch(e){case f.WorldFeature.Drag:return.01*t;case f.WorldFeature.Gravity:return t/3;case f.WorldFeature.PretenstFactor:return 2*t;default:return t}}var mn=function(){function e(t){Object(d.a)(this,e),this.sphere=t}return Object(m.a)(e,[{key:"build",value:function(){var e=this;switch(vn.forEach((function(t){return e.sphere.vertexAt(new l.Vector3(t[0],t[1],t[2]))})),this.edgeVertexCount){case 0:this.build30Edges();break;case 1:var t=this.build60Edges();this.buildSmallFaces(t);break;default:var n=this.buildEdges();this.buildFaces(n)}return this.sphere.vertices.forEach((function(t){t.adjacent.forEach((function(n){e.sphere.pullsForAdjacent(t,n)}))})),this.sphere.fabric.set_altitude(this.sphere.location.y),this.sphere}},{key:"push",value:function(e,t,n){if(n){var r=(new l.Vector3).copy(e.location).lerp(t.location,.5),a=this.sphere.vertexAt(r);return this.sphere.pushBetween(e,a),this.sphere.pushBetween(a,t),{vertexA:e,vertexB:t,vertexMid:a}}return this.sphere.pushBetween(e,t),{vertexA:e,vertexB:t}}},{key:"build60Edges",value:function(){var e=this,t=[];return pn.forEach((function(n){var r=e.push(e.vertices[n[0]],e.vertices[n[1]],!0).vertexMid;r&&t.push(r)})),t}},{key:"build30Edges",value:function(){var e=this;pn.forEach((function(t){return e.push(e.vertices[t[0]],e.vertices[t[1]])}))}},{key:"buildEdges",value:function(){var e=this,t=[];return pn.forEach((function(n){var r,a,i=[];t.push(i);for(var o=0;o<e.edgeVertexCount;o++){a=r;var c=e.vertices[n[0]],s=e.vertices[n[1]],u=c.location,h=s.location,f=(new l.Vector3).lerpVectors(u,h,(o+1)/e.sphere.frequency);r=e.sphere.vertexAt(f),i.push(r),a?(e.push(r,a),o===e.edgeVertexCount-1&&e.push(r,s)):e.push(r,c)}})),wn.forEach((function(n){for(var r=0;r<n.length;r++){var a=(r+1)%n.length,i=1===n[r][1]?0:e.edgeVertexCount-1,o=1===n[a][1]?0:e.edgeVertexCount-1,c=t[n[r][0]][i],s=t[n[a][0]][o];e.push(c,s)}})),t}},{key:"buildSmallFaces",value:function(e){var t=this;yn.forEach((function(n){var r=e[Math.abs(n[0])],a=e[Math.abs(n[1])],i=e[Math.abs(n[2])];t.push(r,a),t.push(a,i),t.push(i,r)}))}},{key:"buildFaces",value:function(e){for(var t=[],n=0;n<this.edgeVertexCount-1;n++)t.push([]);for(var r=new l.Vector3,a=new l.Vector3,i=0;i<bn.length;i++){for(var o=this.vertices[bn[i][0]].location,c=1;c<this.edgeVertexCount;c++){var s=this.vertices[bn[i][1]];r.lerpVectors(o,s.location,c/this.sphere.frequency),r.sub(o),t[c-1]=[];for(var u=1;u<this.edgeVertexCount-c+1;u++){var h=this.vertices[bn[i][2]];a.lerpVectors(o,h.location,u/this.sphere.frequency),a.sub(o);var f=(new l.Vector3).copy(o);f.add(r),f.add(a),t[c-1].push(this.sphere.vertexAt(f))}}for(var d=0;d<t.length;d++)for(var m=0;m<t[d].length;m++)if(m<t[d].length-1&&this.push(t[d][m],t[d][m+1]),d>0){var g=t[d][m];this.push(g,t[d-1][m]),this.push(g,t[d-1][m+1])}for(var v=[],p=[],b=[],y=0;y<this.edgeVertexCount-1;y++){var w=t.length-y-1;v.push(t[yn[i][0]>=0?y:w][0]);var E=t[yn[i][1]<0?y:w];p.push(E[E.length-1]),b.push(t[0][yn[i][2]<0?y:w])}var S=[];S.push(v),S.push(p),S.push(b);for(var k=0;k<S.length;k++)for(var P=e[Math.abs(yn[i][k])],x=0;x<t.length;x++){var F=S[k][x];this.push(F,P[x]),this.push(F,P[x+1])}}}},{key:"vertices",get:function(){return this.sphere.vertices}},{key:"edgeVertexCount",get:function(){return this.sphere.frequency-1}}]),e}(),gn=.5257311121191336,vn=[[+gn,0,.85065080835204],[+gn,0,-.85065080835204],[.85065080835204,+gn,0],[-.85065080835204,+gn,0],[0,.85065080835204,+gn],[0,-.85065080835204,+gn],[-gn,0,-.85065080835204],[-gn,0,.85065080835204],[-.85065080835204,-gn,0],[.85065080835204,-gn,0],[0,-.85065080835204,-gn],[0,.85065080835204,-gn]],pn=[[0,2],[0,4],[0,5],[0,7],[0,9],[1,10],[1,11],[1,2],[1,6],[1,9],[2,11],[2,4],[2,9],[3,11],[3,4],[3,6],[3,7],[3,8],[4,11],[4,7],[5,10],[5,7],[5,8],[5,9],[6,10],[6,11],[6,8],[7,8],[8,10],[9,10]],bn=[[0,2,4],[0,2,9],[0,4,7],[0,5,7],[0,5,9],[1,2,11],[1,2,9],[1,6,10],[1,6,11],[1,9,10],[2,4,11],[3,4,11],[3,4,7],[3,6,11],[3,6,8],[3,7,8],[5,7,8],[5,8,10],[5,9,10],[6,8,10]],yn=[[0,11,-1],[0,12,-4],[1,19,-3],[2,21,-3],[2,23,-4],[7,10,-6],[7,12,-9],[8,24,-5],[8,25,-6],[9,29,-5],[11,18,-10],[14,18,-13],[14,19,-16],[15,25,-13],[15,26,-17],[16,27,-17],[21,27,-22],[22,28,-20],[23,29,-20],[26,28,-24]],wn=[[[0,1],[1,1],[3,1],[2,1],[4,1]],[[7,1],[6,1],[8,1],[5,1],[9,1]],[[10,1],[11,1],[0,-1],[12,1],[7,-1]],[[14,1],[13,1],[15,1],[17,1],[16,1]],[[18,1],[11,-1],[1,-1],[19,1],[14,-1]],[[21,1],[22,1],[20,1],[23,1],[2,-1]],[[26,1],[24,1],[8,-1],[25,1],[15,-1]],[[27,1],[16,-1],[19,-1],[3,-1],[21,-1]],[[28,1],[22,-1],[27,-1],[17,-1],[26,-1]],[[4,-1],[23,-1],[29,1],[9,-1],[12,-1]],[[28,-1],[20,-1],[29,-1],[5,-1],[24,-1]],[[6,-1],[10,-1],[18,-1],[13,-1],[25,-1]]],En=n(263),Sn=n(218),kn=n(219),Pn=-1,xn=0,Fn=1,jn=2,On=3,Rn=4,Cn=5,Nn={type:"change"},Vn={type:"start"},In={type:"end"},Mn=function(e){function t(e,n){var r;return Object(d.a)(this,t),(r=Object(En.a)(this,Object(Sn.a)(t).call(this))).object=void 0,r.element=void 0,r.window=void 0,r.enabled=void 0,r.target=void 0,r.enableZoom=void 0,r.zoomSpeed=void 0,r.minDistance=void 0,r.maxDistance=void 0,r.enableRotate=void 0,r.rotateSpeed=void 0,r.enablePan=void 0,r.keyPanSpeed=void 0,r.autoRotate=void 0,r.autoRotateSpeed=void 0,r.minZoom=void 0,r.maxZoom=void 0,r.minPolarAngle=void 0,r.maxPolarAngle=void 0,r.minAzimuthAngle=void 0,r.maxAzimuthAngle=void 0,r.keys=void 0,r.mouseButtons=void 0,r.enableDamping=void 0,r.dampingFactor=void 0,r.spherical=void 0,r.sphericalDelta=void 0,r.scale=void 0,r.target0=void 0,r.position0=void 0,r.zoom0=void 0,r.state=void 0,r.panOffset=void 0,r.zoomChanged=void 0,r.rotateStart=void 0,r.rotateEnd=void 0,r.rotateDelta=void 0,r.panStart=void 0,r.panEnd=void 0,r.panDelta=void 0,r.dollyStart=void 0,r.dollyEnd=void 0,r.dollyDelta=void 0,r.updateLastPosition=void 0,r.updateOffset=void 0,r.updateQuat=void 0,r.updateLastQuaternion=void 0,r.updateQuatInverse=void 0,r.panLeftV=void 0,r.panUpV=void 0,r.panInternalOffset=void 0,r.onMouseUp=void 0,r.onMouseDown=void 0,r.onMouseMove=void 0,r.onMouseWheel=void 0,r.onTouchStart=void 0,r.onTouchEnd=void 0,r.onTouchMove=void 0,r.object=e,r.element=n,r.window=window,r.enabled=!0,r.target=new l.Vector3,r.minDistance=0,r.maxDistance=1/0,r.minZoom=0,r.maxZoom=1/0,r.minPolarAngle=0,r.maxPolarAngle=Math.PI,r.minAzimuthAngle=-1/0,r.maxAzimuthAngle=1/0,r.enableDamping=!1,r.dampingFactor=.25,r.enableZoom=!0,r.zoomSpeed=.5,r.enableRotate=!0,r.rotateSpeed=1,r.enablePan=!0,r.keyPanSpeed=7,r.autoRotate=!1,r.autoRotateSpeed=1,r.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},r.mouseButtons={ORBIT:l.MOUSE.LEFT,ZOOM:l.MOUSE.MIDDLE,PAN:l.MOUSE.RIGHT},r.target0=r.target.clone(),r.position0=r.object.position.clone(),r.zoom0=r.object.zoom,r.updateOffset=new l.Vector3,r.updateQuat=(new l.Quaternion).setFromUnitVectors(r.object.up,new l.Vector3(0,1,0)),r.updateQuatInverse=r.updateQuat.clone().inverse(),r.updateLastPosition=new l.Vector3,r.updateLastQuaternion=new l.Quaternion,r.state=Pn,r.scale=1,r.spherical=new l.Spherical,r.sphericalDelta=new l.Spherical,r.panOffset=new l.Vector3,r.zoomChanged=!1,r.rotateStart=new l.Vector2,r.rotateEnd=new l.Vector2,r.rotateDelta=new l.Vector2,r.panStart=new l.Vector2,r.panEnd=new l.Vector2,r.panDelta=new l.Vector2,r.dollyStart=new l.Vector2,r.dollyEnd=new l.Vector2,r.dollyDelta=new l.Vector2,r.panLeftV=new l.Vector3,r.panUpV=new l.Vector3,r.panInternalOffset=new l.Vector3,r.onMouseDown=function(e){if(e.preventDefault(),r.enabled){if(e.button===r.mouseButtons.ORBIT){if(!r.enableRotate)return;r.rotateStart.set(e.clientX,e.clientY),r.state=xn}else if(e.button===r.mouseButtons.ZOOM){if(!r.enableZoom)return;r.dollyStart.set(e.clientX,e.clientY),r.state=Fn}else if(e.button===r.mouseButtons.PAN){if(!r.enablePan)return;r.panStart.set(e.clientX,e.clientY),r.state=jn}r.state!==Pn&&(document.addEventListener("mousemove",r.onMouseMove,!1),document.addEventListener("mouseup",r.onMouseUp,!1),r.dispatchEvent(Vn))}},r.onMouseMove=function(e){if(e.preventDefault(),r.enabled)if(r.state===xn){if(!r.enableRotate)return;r.rotateEnd.set(e.clientX,e.clientY),r.rotateDelta.subVectors(r.rotateEnd,r.rotateStart),r.rotateLeft(2*Math.PI*r.rotateDelta.x/r.element.clientWidth*r.rotateSpeed),r.rotateUp(2*Math.PI*r.rotateDelta.y/r.element.clientHeight*r.rotateSpeed),r.rotateStart.copy(r.rotateEnd),r.update()}else if(r.state===Fn){if(!r.enableZoom)return;r.dollyEnd.set(e.clientX,e.clientY),r.dollyDelta.subVectors(r.dollyEnd,r.dollyStart),r.dollyDelta.y>0?r.dollyIn(r.getZoomScale()):r.dollyDelta.y<0&&r.dollyOut(r.getZoomScale()),r.dollyStart.copy(r.dollyEnd),r.update()}else if(r.state===jn){if(!r.enablePan)return;r.panEnd.set(e.clientX,e.clientY),r.panDelta.subVectors(r.panEnd,r.panStart),r.pan(r.panDelta.x,r.panDelta.y),r.panStart.copy(r.panEnd),r.update()}},r.onMouseUp=function(e){e.preventDefault(),r.enabled&&(document.removeEventListener("mousemove",r.onMouseMove,!1),document.removeEventListener("mouseup",r.onMouseUp,!1),r.dispatchEvent(In),r.state=Pn)},r.onMouseWheel=function(e){e.preventDefault(),r.enabled&&r.enableZoom&&(r.state===Pn||r.state===xn)&&(e.stopPropagation(),e.deltaY<0?r.dollyOut(r.getZoomScale()):e.deltaY>0&&r.dollyIn(r.getZoomScale()),r.update(),r.dispatchEvent(Vn),r.dispatchEvent(In))},r.onTouchStart=function(e){if(e.preventDefault(),r.enabled){switch(e.touches.length){case 1:if(!r.enableRotate)return;r.rotateStart.set(e.touches[0].pageX,e.touches[0].pageY),r.state=On;break;case 2:if(!r.enableZoom)return;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+n*n);r.dollyStart.set(0,a),r.state=Rn;break;case 3:if(!r.enablePan)return;r.panStart.set(e.touches[0].pageX,e.touches[0].pageY),r.state=Cn;break;default:r.state=Pn}r.state!==Pn&&r.dispatchEvent(Vn)}},r.onTouchMove=function(e){if(e.preventDefault(),r.enabled)switch(e.touches.length){case 1:if(!r.enableRotate)return;if(r.state!==On)return;r.rotateEnd.set(e.touches[0].pageX,e.touches[0].pageY),r.rotateDelta.subVectors(r.rotateEnd,r.rotateStart),r.rotateLeft(2*Math.PI*r.rotateDelta.x/r.element.clientWidth*r.rotateSpeed),r.rotateUp(2*Math.PI*r.rotateDelta.y/r.element.clientHeight*r.rotateSpeed),r.rotateStart.copy(r.rotateEnd),r.update();break;case 2:if(!r.enableZoom)return;if(r.state!==Rn)return;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+n*n);r.dollyEnd.set(0,a),r.dollyDelta.subVectors(r.dollyEnd,r.dollyStart),r.dollyDelta.y>0?r.dollyOut(r.getZoomScale()):r.dollyDelta.y<0&&r.dollyIn(r.getZoomScale()),r.dollyStart.copy(r.dollyEnd),r.update();break;case 3:if(!r.enablePan)return;if(r.state!==Cn)return;r.panEnd.set(e.touches[0].pageX,e.touches[0].pageY),r.panDelta.subVectors(r.panEnd,r.panStart),r.pan(r.panDelta.x,r.panDelta.y),r.panStart.copy(r.panEnd),r.update();break;default:r.state=Pn}},r.onTouchEnd=function(e){e.preventDefault(),r.enabled&&(r.dispatchEvent(In),r.state=Pn)},r.element.addEventListener("mousedown",r.onMouseDown,{capture:!0}),r.element.addEventListener("wheel",r.onMouseWheel,{capture:!0}),r.element.addEventListener("touchstart",r.onTouchStart,{capture:!0}),r.element.addEventListener("touchend",r.onTouchEnd,{capture:!0}),r.element.addEventListener("touchmove",r.onTouchMove,{capture:!0}),r.update(),r}return Object(kn.a)(t,e),Object(m.a)(t,[{key:"update",value:function(){var e=this.object.position;return this.updateOffset.copy(e).sub(this.target),this.updateOffset.applyQuaternion(this.updateQuat),this.spherical.setFromVector3(this.updateOffset),this.autoRotate&&this.state===Pn&&this.rotateLeft(this.getAutoRotationAngle()),this.spherical.theta+=this.sphericalDelta.theta,this.spherical.phi+=this.sphericalDelta.phi,this.spherical.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this.spherical.theta)),this.spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this.spherical.phi)),this.spherical.makeSafe(),this.spherical.radius*=this.scale,this.spherical.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this.spherical.radius)),this.target.add(this.panOffset),this.updateOffset.setFromSpherical(this.spherical),this.updateOffset.applyQuaternion(this.updateQuatInverse),e.copy(this.target).add(this.updateOffset),this.object.lookAt(this.target),this.enableDamping?(this.sphericalDelta.theta*=1-this.dampingFactor,this.sphericalDelta.phi*=1-this.dampingFactor):this.sphericalDelta.set(0,0,0),this.scale=1,this.panOffset.set(0,0,0),!!(this.zoomChanged||this.updateLastPosition.distanceToSquared(this.object.position)>1e-6||8*(1-this.updateLastQuaternion.dot(this.object.quaternion))>1e-6)&&(this.dispatchEvent(Nn),this.updateLastPosition.copy(this.object.position),this.updateLastQuaternion.copy(this.object.quaternion),this.zoomChanged=!1,!0)}},{key:"panLeft",value:function(e,t){this.panLeftV.setFromMatrixColumn(t,0),this.panLeftV.multiplyScalar(-e),this.panOffset.add(this.panLeftV)}},{key:"panUp",value:function(e,t){this.panUpV.setFromMatrixColumn(t,1),this.panUpV.multiplyScalar(e),this.panOffset.add(this.panUpV)}},{key:"pan",value:function(e,t){var n=this.element,r=this.object.position;this.panInternalOffset.copy(r).sub(this.target);var a=this.panInternalOffset.length();a*=Math.tan(this.object.fov/2*Math.PI/180),this.panLeft(2*e*a/n.clientHeight,this.object.matrix),this.panUp(2*t*a/n.clientHeight,this.object.matrix)}},{key:"dollyIn",value:function(e){this.scale/=e}},{key:"dollyOut",value:function(e){this.scale*=e}},{key:"getAutoRotationAngle",value:function(){return 2*Math.PI/60/60*this.autoRotateSpeed}},{key:"getZoomScale",value:function(){return Math.pow(.95,this.zoomSpeed)}},{key:"rotateLeft",value:function(e){this.sphericalDelta.theta-=e}},{key:"rotateUp",value:function(e){this.sphericalDelta.phi-=e}},{key:"getPolarAngle",value:function(){return this.spherical.phi}},{key:"getAzimuthalAngle",value:function(){return this.spherical.theta}},{key:"dispose",value:function(){this.element.removeEventListener("mousedown",this.onMouseDown,!1),this.element.removeEventListener("wheel",this.onMouseWheel,!1),this.element.removeEventListener("touchstart",this.onTouchStart,!1),this.element.removeEventListener("touchend",this.onTouchEnd,!1),this.element.removeEventListener("touchmove",this.onTouchMove,!1),document.removeEventListener("mousemove",this.onMouseMove,!1),document.removeEventListener("mouseup",this.onMouseUp,!1)}},{key:"reset",value:function(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Nn),this.update(),this.state=Pn}}]),t}(l.EventDispatcher);Object(H.b)({Orbit:Mn});var An=[1,2,3,4,5,6,7,8];function Tn(e){var t=e.createSphere,n=Object(o.useState)((function(){if(location.hash.startsWith("#sphere-")){var e=parseInt(location.hash.substring("#sphere-".length),10);if(An.find((function(t){return t===e})))return e}return 1})),r=Object(X.a)(n,2),a=r[0],i=r[1],c=Object(o.useState)((function(){return t(a)})),s=Object(X.a)(c,2),l=s[0],u=s[1];return Object(o.useEffect)((function(){location.hash="sphere-".concat(l.frequency)}),[l]),Object(o.useEffect)((function(){u(t(a))}),[a]),o.createElement("div",{id:"view-container",style:{position:"absolute",left:0,right:0,height:"100%"}},o.createElement("div",{id:"bottom-middle"},o.createElement(Q.a,null,An.map((function(e){return o.createElement(q.a,{color:"info",key:"Frequency".concat(e),disabled:e===a,onClick:function(){return i(e)}},e)})))),o.createElement("div",{id:"bottom-right"},o.createElement(Q.a,null,o.createElement(q.a,{onClick:function(){return ke(l.fabricOutput)}},o.createElement(J.p,null)),o.createElement(q.a,{onClick:function(){return k(p.Design)}},o.createElement(J.P,null)))),o.createElement(H.a,{style:{backgroundColor:"black"}},o.createElement(Ln,null),l?o.createElement(Dn,{sphere:l}):o.createElement("h1",null,"No Sphere")))}function Dn(e){var t=e.sphere,n=Object(H.d)().camera,r=document.getElementById("view-container"),a=Object(H.e)((function(e){e.minPolarAngle=0,e.maxPolarAngle=Math.PI/2,e.minDistance=1,e.maxDistance=1e4,e.enableZoom=!0,e.update()}),[]),i=Object(o.useState)(0),c=Object(X.a)(i,2),s=c[0],u=c[1];return Object(H.c)((function(){var e=a.current;0===s&&e.target.copy(t.location),t.iterate();var n=(new l.Vector3).subVectors(t.instance.midpoint,e.target).multiplyScalar(.1);e.target.add(n),e.update(),u(s+1)})),o.createElement("group",null,o.createElement("orbit",{ref:a,args:[n,r]}),o.createElement("scene",null,o.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:Fe,onUpdate:function(e){return e.geometry.computeBoundingSphere()}}),o.createElement(Ae,null),o.createElement("ambientLight",{color:new l.Color("white"),intensity:.8}),o.createElement("directionalLight",{color:new l.Color("#FFFFFF"),intensity:2})))}function Ln(e){var t=Object(o.useRef)(),n=Object(H.d)().setDefaultCamera;return Object(o.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(0,1,5),n(e)}),[]),Object(H.c)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),o.createElement("perspectiveCamera",Object.assign({ref:t},e))}function Wn(e){var t=e.push;return e.reverse?t.omega:t.alpha}var _n=function(){function e(t,n,r,a,i,o){Object(d.a)(this,e),this.location=t,this.radius=n,this.frequency=r,this.twist=a,this.numericFeature=i,this.instance=o,this.joints=[],this.pushes=[],this.pulls=[],this.vertices=[],this.stage=f.Stage.Growing,this.instance.clear()}return Object(m.a)(e,[{key:"vertexAt",value:function(e){e.normalize().multiplyScalar(this.radius);var t={index:this.vertices.length,location:e,adjacent:[]};return this.vertices.push(t),t}},{key:"pushBetween",value:function(e,t){var n=(new l.Vector3).addVectors(e.location,t.location).normalize(),r=(new l.Quaternion).setFromAxisAngle(n,this.twist),a=(new l.Vector3).copy(e.location).applyQuaternion(r),i=(new l.Vector3).copy(t.location).applyQuaternion(r),o=Math.sqrt(1e-5),c=e.location.distanceTo(t.location),s=this.createJoint(a),u=this.createJoint(i),h={index:this.fabric.create_interval(s.index,u.index,f.IntervalRole.SpherePush,c,c,1e-5,o,0),alpha:s,omega:u,alphaVertex:e,omegaVertex:t};return this.pushes.push(h),e.adjacent.push({vertex:t,reverse:!1,push:h}),t.adjacent.push({vertex:e,reverse:!0,push:h}),h}},{key:"pullsForAdjacent",value:function(e,t){var n=this,r=t.push.alphaVertex.location.distanceTo(t.push.omegaVertex.location),a=.3*r,i=.7*r,o=[],c=function(e,t,r){if(!n.pullExists(e,t)){var c=Math.sqrt(1e-6),s=r?a:i,l=e.location().distanceTo(t.location()),u={index:n.fabric.create_interval(e.index,t.index,f.IntervalRole.SpherePull,l,s,1e-6,c,100),alpha:e,omega:t};o.push(u),n.pulls.push(u)}},s=Wn(this.nextAdjacent(e,t)),l=Wn(t),u=function(e){var t=e.push;return e.reverse?t.alpha:t.omega}(t);return c(l,s,!0),c(u,s,!1),o}},{key:"iterate",value:function(){var e=this.instance.iterate(this.stage);if(void 0!==e)switch(e){case f.Stage.Growing:new mn(this).build(),this.stage=this.fabric.finish_growing();break;case f.Stage.Shaping:console.log("adopt"),this.fabric.adopt_lengths(),this.stage=f.Stage.Slack;break;case f.Stage.Slack:console.log("slack"),this.stage=f.Stage.Pretensing}}},{key:"createJoint",value:function(e){var t=this,n=this.fabric.create_joint(e.x,e.y,e.z),r={index:n,oppositeIndex:-1,location:function(){return t.instance.jointLocation(n)}};return this.joints.push(r),this.instance.refreshFloatView(),r}},{key:"nextAdjacent",value:function(e,t){var n=e.location,r=t.vertex.location,a=(new l.Vector3).subVectors(r,n),i=(new l.Vector3).crossVectors(n,a).normalize();this.twist<0&&i.multiplyScalar(-1);var o=e.adjacent.filter((function(e){var r=e.vertex;return r.index!==t.vertex.index&&(new l.Vector3).subVectors(r.location,n).normalize().dot(i)>0})).sort((function(e,t){var n=e.vertex.location.distanceToSquared(r);return t.vertex.location.distanceToSquared(r)-n})).pop();if(!o)throw new Error("Couldn't find closest!");return o}},{key:"pullExists",value:function(e,t){return!!this.pulls.find((function(n){return n.alpha.index===e.index&&n.omega.index===t.index||n.alpha.index===t.index&&n.omega.index===e.index}))}},{key:"fabric",get:function(){return this.instance.fabric}},{key:"fabricOutput",get:function(){var e=this;this.instance.refreshFloatView();var t=this.instance.floatView.idealLengths,n=this.instance.floatView.strains,r=this.instance.floatView.stiffnesses,a=this.instance.floatView.linearDensities;return{name:"sphere",joints:this.joints.map((function(t){var n=t.location(),r=e.instance.fabric.is_anchor_joint(t.index);return{index:t.index,x:n.x,y:n.z,z:n.y,anchor:r}})),intervals:[].concat(Object(h.a)(this.pushes.map((function(i){var o=e.numericFeature(f.WorldFeature.PushRadius)/e.frequency,c=o*e.numericFeature(f.WorldFeature.JointRadiusFactor),s=i.alpha.location().distanceTo(i.omega.location())-2*c,l=i.alpha.index,u=i.omega.index;if(l>=e.joints.length||u>=e.joints.length)throw new Error("Joint not found ".concat(l,",").concat(u,":").concat(e.joints.length));return{index:i.index,joints:[l,u],type:"Push",strain:n[i.index],stiffness:r[i.index],linearDensity:a[i.index],role:v(f.IntervalRole.SpherePush),idealLength:t[i.index],isPush:!0,length:s,radius:o,jointRadius:c}}))),Object(h.a)(this.pulls.map((function(i){var o=e.numericFeature(f.WorldFeature.PullRadius)/e.frequency,c=o*e.numericFeature(f.WorldFeature.JointRadiusFactor),s=i.alpha.location().distanceTo(i.omega.location())+2*c,l=i.alpha.index,u=i.omega.index;if(l>=e.joints.length||u>=e.joints.length)throw new Error("Joint not found ".concat(l,",").concat(u,":").concat(e.joints.length));return{index:i.index,joints:[l,u],type:"Pull",strain:n[i.index],stiffness:r[i.index],linearDensity:a[i.index],role:v(f.IntervalRole.SpherePush),idealLength:t[i.index],isPush:!1,length:s,radius:o,jointRadius:c}}))))}}}]),e}(),Bn=n(650),zn=n(651),Gn=n(656),Zn=n(652),Un=n(653),$n=n(654),Yn=n(646);function Xn(e){var t=e.feature,n=e.disabled,r=Object(o.useState)((function(){return t.percent})),a=Object(X.a)(r,2),i=a[0],c=a[1];Object(o.useEffect)((function(){var e=t.observable.subscribe((function(e){var t=e.percent;return c(t)}));return function(){return e.unsubscribe()}}),[]);var s=Re(w(t.worldFeature)),l=s||"#919191";return o.createElement("div",{className:"my-2"},o.createElement("div",{className:"float-right",style:{color:n?"gray":"white"}},t.formatted),o.createElement("div",null,t.config.name),o.createElement(Q.a,{className:"w-100"},t.percentChoices.map((function(e){var r=i===e?"#000000":l;return o.createElement(q.a,{disabled:n,size:"sm",style:{color:"white",backgroundColor:r},key:"".concat(t.config.name,":").concat(e),onClick:function(){return t.percent=e}},function(e){return e<=100?"".concat(e,"%"):"".concat(e/100,"x")}(e))}))))}function Jn(e){var t=e.tensegrity,n=e.floatFeatures,r=e.storedState$,a=Object(o.useState)(r.getValue().polygons),i=Object(X.a)(a,2),c=i[0],s=i[1],l=Object(o.useState)(r.getValue().visibleRoles),u=Object(X.a)(l,2),d=u[0],m=u[1];return Object(o.useEffect)((function(){var e=r.subscribe((function(e){s(e.polygons),m(e.visibleRoles)}));return function(){return e.unsubscribe()}}),[]),o.createElement(o.Fragment,null,o.createElement(yr,null,o.createElement(Xn,{feature:n[f.WorldFeature.PushRadius],disabled:!c}),o.createElement(Xn,{feature:n[f.WorldFeature.PullRadius],disabled:!c}),o.createElement(Xn,{feature:n[f.WorldFeature.JointRadiusFactor],disabled:!c})),t?o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.N,null)," Take"),o.createElement(Q.a,{vertical:!1,className:"w-100 my-2"},o.createElement(q.a,{onClick:function(){return Se(t.fabricOutput)},disabled:!c},o.createElement(J.p,null)," Download CSV ",o.createElement(J.v,null)),o.createElement(q.a,{onClick:function(){return ke(t.fabricOutput)},disabled:!c},o.createElement(J.p,null)," Download JSON ",o.createElement(J.u,null)))):void 0,o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.s,null)," Show/Hide"),o.createElement("div",null,"Roles"),o.createElement(Q.a,{size:"sm",className:"w-100 my-2"},b.map((function(e){return o.createElement(q.a,{key:"viz".concat(e),style:{backgroundColor:d.indexOf(e)>=0?Re(e):"#747474"},disabled:!c,onClick:function(){d.indexOf(e)<0?r.next(it(r.getValue(),{visibleRoles:[].concat(Object(h.a)(d),[e])})):r.next(it(r.getValue(),{visibleRoles:d.filter((function(t){return t!==e}))}))}},v(e))}))),t?o.createElement(o.Fragment,null,o.createElement(Hn,{push:!0,disabled:!c,storedState$:r,strainLimits:t.instance.floatView.strainLimits}),o.createElement(Hn,{push:!1,disabled:!c,storedState$:r,strainLimits:t.instance.floatView.strainLimits})):void 0))}function Hn(e){var t=e.push,n=e.disabled,r=e.strainLimits,a=e.storedState$,i=[0,1e4],c=Object(o.useState)([1e4*(t?a.getValue().pushBottom:a.getValue().pullBottom),1e4*(t?a.getValue().pushTop:a.getValue().pullTop)]),s=Object(X.a)(c,2),l=s[0],u=s[1],h=Object(o.useState)(0),f=Object(X.a)(h,2),d=f[0],m=f[1],g=Object(o.useState)(0),v=Object(X.a)(g,2),p=v[0],b=v[1];return Object(o.useEffect)((function(){function e(e){var n=t?r[1]:r[2];return n+e*((t?r[0]:r[3])-n)}if(t){var n=l[0]/1e4;m(e(n));var i=l[1]/1e4;b(e(i)),a.next(Object(Be.a)({},a.getValue(),{pushBottom:n,pushTop:i}))}else{var o=l[0]/1e4;m(e(o));var c=l[1]/1e4;b(e(c)),a.next(Object(Be.a)({},a.getValue(),{pullBottom:o,pullTop:c}))}}),[l]),o.createElement("div",{style:{height:"4em",width:"100%"},className:"my-2"},o.createElement("div",{className:"float-right",style:{color:n?"gray":"white"}},"".concat(P(d)," ").concat(P(p))),o.createElement("div",null,t?"Push":"Pull"," Strain"),o.createElement(Yn.c,{disabled:n,mode:1,step:1,domain:i,rootStyle:ir,onChange:function(e){return u(e)},values:l},o.createElement(Yn.b,null,(function(e){var t=e.getRailProps;return o.createElement("div",Object.assign({style:{position:"absolute",width:"100%",height:14,borderRadius:7,cursor:"pointer",backgroundColor:n?er:Kn}},t()))})),o.createElement(Yn.a,null,(function(e){var t=e.handles,n=e.getHandleProps;return o.createElement("div",{className:"slider-handles"},t.map((function(e,t){return o.createElement(Qn,{key:e.id,handle:e,domain:i,getHandleProps:n,top:1===t})})))})),o.createElement(Yn.d,{right:!1},(function(e){var t=e.tracks,r=e.getTrackProps;return o.createElement("div",{className:"slider-tracks"},t.map((function(e,t){var a=e.id,i=e.source,c=e.target;return o.createElement(qn,{key:a,source:i,target:c,getTrackProps:r,color:nr(t,n)})})))}))))}function Qn(e){var t=e.domain,n=e.handle,r=e.getHandleProps,a=e.top,i=t[0],c=t[1],s=n.id,l=n.value,u=n.percent;return o.createElement("div",Object.assign({role:"slider","aria-valuemin":i,"aria-valuemax":c,"aria-valuenow":l,style:{left:"".concat(u,"%"),position:"absolute",marginLeft:"-11px",marginTop:"-6px",zIndex:2,width:24,height:24,cursor:"pointer",borderRadius:2,boxShadow:"1px 1px 1px 1px rgba(0, 0, 0, 0.2)",backgroundColor:tr(a)}},r(s)))}function qn(e){var t=e.source,n=e.target,r=e.getTrackProps,a=e.color;return o.createElement("div",Object.assign({style:{position:"absolute",height:14,zIndex:1,backgroundColor:a,borderRadius:2,cursor:"pointer",left:"".concat(t.percent,"%"),width:"".concat(n.percent-t.percent,"%")}},r()))}var Kn="#9B9B9B",er="#767676";function tr(e){return e?"#c6161690":"#597fe790"}function nr(e,t){return t?er:0===e?Kn:"white"}var rr,ar,ir={margin:"4%",position:"relative",width:"92%"};function or(e){var t=e.floatFeatures,n=e.tensegrity,r=e.storedState$,a=Object(o.useState)(n.life$.getValue()),i=Object(X.a)(a,2),c=i[0],s=i[1];Object(o.useEffect)((function(){var e=n.life$.subscribe(s);return function(){return e.unsubscribe()}}),[n]);var l=Object(o.useState)(r.getValue().polygons),u=Object(X.a)(l,2),h=u[0],d=u[1];return Object(o.useEffect)((function(){var e=r.subscribe((function(e){d(e.polygons)}));return function(){return e.unsubscribe()}}),[]),o.createElement("div",null,o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.l,null)," Time"),o.createElement(Xn,{key:"it",feature:t[f.WorldFeature.IterationsPerFrame],disabled:h}),o.createElement(Xn,{key:"ic",feature:t[f.WorldFeature.IntervalCountdown],disabled:h}),o.createElement(Xn,{key:"pc",feature:t[f.WorldFeature.PretensingCountdown],disabled:h})),o.createElement(yr,null,o.createElement(Xn,{feature:t[f.WorldFeature.VisualStrain],disabled:h})),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.w,null)," Perturb"),o.createElement(Q.a,{className:"w-100"},o.createElement(q.a,{disabled:c.stage!==f.Stage.Pretenst,onClick:function(){return n.fabric.set_altitude(1)}},o.createElement(J.A,null)," Nudge"),o.createElement(q.a,{disabled:c.stage!==f.Stage.Pretenst,onClick:function(){return n.fabric.set_altitude(10)}},o.createElement(J.I,null)," Drop"),o.createElement(q.a,{disabled:h,onClick:function(){return n.fabric.centralize()}},o.createElement(J.n,null)," Centralize"))))}function cr(e){var t=e.tensegrity,n=e.stageTransition,r=e.disabled,a=Object(o.useState)(t.life$.getValue()),i=Object(X.a)(a,2),c=i[0],s=i[1];function l(e){return!(!r&&c.stage!==f.Stage.Pretensing)||c.stage!==e}switch(Object(o.useEffect)((function(){var e=t.life$.subscribe(s);return function(){return e.unsubscribe()}}),[t]),n){case rr.CaptureLengthsToSlack:return o.createElement(q.a,{className:"my-1 w-100",disabled:l(f.Stage.Shaping),onClick:function(){return t.transition={stage:f.Stage.Slack,adoptLengths:!0}}},"Capture Lengths ",o.createElement(J.i,null),"( ",o.createElement(sr,{stage:f.Stage.Shaping})," )",o.createElement(J.d,null),"( ",o.createElement(J.f,null),o.createElement(sr,{stage:f.Stage.Slack})," ) New Slack");case rr.SlackToPretensing:return o.createElement(q.a,{className:"my-1 w-100",disabled:l(f.Stage.Slack),onClick:function(){return t.transition={stage:f.Stage.Pretensing}}},"Slack ",o.createElement(sr,{stage:f.Stage.Slack})," ",o.createElement(J.d,null)," ",o.createElement(sr,{stage:f.Stage.Pretenst})," Pretenst");case rr.SlackToShaping:return o.createElement(Q.a,{vertical:!0,className:"w-100 my-1"},o.createElement(q.a,{className:"my-1 w-100",disabled:l(f.Stage.Slack),onClick:function(){return t.transition={stage:f.Stage.Shaping}}},o.createElement(sr,{stage:f.Stage.Shaping})," Shaping ",o.createElement(J.c,null)," Slack ",o.createElement(sr,{stage:f.Stage.Slack})));case rr.CapturePretenstToSlack:return o.createElement(q.a,{className:"my-1 w-100",disabled:l(f.Stage.Pretenst),onClick:function(){return t.transition={stage:f.Stage.Slack,adoptLengths:!0}}},"Capture pretenst ",o.createElement(J.i,null)," ( ",o.createElement(sr,{stage:f.Stage.Pretenst})," ) ",o.createElement(J.d,null)," ( ",o.createElement(J.f,null),o.createElement(sr,{stage:f.Stage.Slack})," ) New Slack");case rr.CaptureStrainForStiffness:return o.createElement(q.a,{className:"my-1 w-100",disabled:l(f.Stage.Pretenst),onClick:function(){return t.transition={stage:f.Stage.Slack,strainToStiffness:!0}}},"Capture Strain ",o.createElement(J.i,null)," ( ",o.createElement(sr,{stage:f.Stage.Pretenst})," ",o.createElement(J.F,null)," ) ",o.createElement(J.d,null),"( ",o.createElement(sr,{stage:f.Stage.Slack})," ",o.createElement(J.j,null)," ) Slack Stiffness")}}function sr(e){switch(e.stage){case f.Stage.Growing:return o.createElement(J.O,null);case f.Stage.Shaping:return o.createElement(J.Q,null);case f.Stage.Slack:return o.createElement(J.V,null);case f.Stage.Pretensing:return o.createElement(J.l,null);case f.Stage.Pretenst:return o.createElement(J.B,null);default:throw new Error("Stage?")}}function lr(e){var t=e.floatFeatures,n=e.tensegrity,r=e.selectedIntervals,a=e.setFabric,i=e.shapeSelection,c=e.setShapeSelection,s=e.selectedFaces,l=e.clearSelection,u=e.storedState$,d=Object(o.useState)(!1),m=Object(X.a)(d,2),g=m[0],p=m[1];Object(o.useEffect)((function(){n.instance.world.set_push_and_pull(g)}),[g]);var y=Object(o.useState)(u.getValue().polygons),w=Object(X.a)(y,2),E=w[0],S=w[1];Object(o.useEffect)((function(){var e=[u.subscribe((function(e){return S(e.polygons)}))];return function(){return e.forEach((function(e){return e.unsubscribe()}))}}),[]);var k=Object(o.useState)(n.life$.getValue()),P=Object(X.a)(k,2),x=P[0],F=P[1];Object(o.useEffect)((function(){var e=n.life$.subscribe(F);return function(){return e.unsubscribe()}}),[n]);var j=Object(o.useState)(t[f.WorldFeature.NexusPushLength]),O=Object(X.a)(j,2),R=O[0],C=O[1],N=function(e,t,a){return function(){r&&r.forEach((function(r){r.isPush&&!t||!r.isPush&&!a||n.changeIntervalScale(r,e?1.03:1/1.03)}))}};function V(){return E||x.stage!==f.Stage.Shaping}function I(e,t){return!(!V()&&i===t)||(s.length<e||E)}return o.createElement("div",null,o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.a,null)," Phase"),o.createElement(cr,{tensegrity:n,stageTransition:rr.CaptureLengthsToSlack,disabled:E||i!==ar.None})),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.z,null)," Manual"),o.createElement(Q.a,{size:"sm",className:"w-100 my-2"},o.createElement(q.a,{color:i===ar.Faces?"warning":"secondary",disabled:E&&i===ar.None,onClick:function(){l(),c(i!==ar.Faces?ar.Faces:ar.None)}},o.createElement("span",null,o.createElement(J.z,null)," Select faces")),o.createElement(q.a,{color:i===ar.Intervals?"warning":"secondary",disabled:E&&i===ar.None||0===s.length,onClick:function(){i===ar.Intervals&&l(),c(i===ar.Intervals?ar.None:ar.Intervals)}},o.createElement("span",null,o.createElement(J.Q,null)," Make length adjustments"))),o.createElement(Q.a,{size:"sm",className:"w-100 my-2"},o.createElement(q.a,{disabled:I(1,ar.Intervals),onClick:N(!0,!0,!0)},"TC ",o.createElement(J.e,null)),o.createElement(q.a,{disabled:I(1,ar.Intervals),onClick:N(!1,!0,!0)},"TC ",o.createElement(J.b,null)),o.createElement(q.a,{disabled:I(1,ar.Intervals),onClick:N(!0,!1,!0)},"T",o.createElement(J.e,null)),o.createElement(q.a,{disabled:I(1,ar.Intervals),onClick:N(!1,!1,!0)},"T ",o.createElement(J.b,null)),o.createElement(q.a,{disabled:I(1,ar.Intervals),onClick:N(!0,!0,!1)},"C ",o.createElement(J.e,null)),o.createElement(q.a,{disabled:I(1,ar.Intervals),onClick:N(!1,!0,!1)},"C ",o.createElement(J.b,null))),o.createElement(Q.a,{size:"sm",className:"w-100 my-2"},o.createElement(q.a,{disabled:0===s.length||V()&&i!==ar.None,onClick:function(){return l()}},o.createElement(J.S,null)," Clear selection"),o.createElement(q.a,{disabled:I(1,ar.Faces),onClick:function(){new Ze(n).faceToOrigin(s[0]),n.instance.refreshFloatView(),l()}},o.createElement(J.m,null),o.createElement("span",null," Upright")),o.createElement(q.a,{disabled:I(2,ar.Faces),onClick:function(){var e,t=new Ze(n).createFaceIntervals(s,{action:Ge.JoinFaces});(e=n.faceIntervals).push.apply(e,Object(h.a)(t)),l(),c(ar.None),a(n)}},o.createElement(J.E,null),o.createElement("span",null," Connect")),o.createElement(q.a,{disabled:V(),onClick:function(){return new G(n).replaceCrosses(n.numericFeature(f.WorldFeature.IntervalCountdown))}},o.createElement(J.G,null),o.createElement("span",null," Optimize")))),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.U,null)," Adjustments"),o.createElement(Xn,{feature:t[f.WorldFeature.ShapingPretenstFactor],disabled:V()}),o.createElement(Xn,{feature:t[f.WorldFeature.ShapingDrag],disabled:V()}),o.createElement(Xn,{feature:t[f.WorldFeature.ShapingStiffnessFactor],disabled:V()}),o.createElement(Q.a,{size:"sm",className:"w-100 my-2"},o.createElement(q.a,{disabled:V(),color:g?"secondary":"success",onClick:function(){return p(!1)}},o.createElement(J.k,null),": T or C"),o.createElement(q.a,{disabled:V(),color:g?"success":"secondary",onClick:function(){return p(!0)}},o.createElement(J.q,null),": T=C"))),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.F,null)," Default Lengths"),o.createElement(Xn,{key:R.title,feature:R,disabled:V()}),o.createElement(Q.a,{className:"my-2 w-100"},b.map((function(e){return{intervalRole:e,feature:t[rt(e)]}})).map((function(e){var t=e.intervalRole,n=e.feature;return o.createElement(q.a,{size:"sm",key:"IntervalRole[".concat(t,"]"),style:{backgroundColor:Re(t),borderWidth:"3px",borderStyle:R.worldFeature===n.worldFeature?"solid":"none"},onClick:function(){return C(n)}},v(t))})))))}function ur(e){var t=e.floatFeatures,n=e.tensegrity,r=e.shapeSelection,a=e.storedState$,i=Object(o.useState)(a.getValue()),c=Object(X.a)(i,2),s=c[0],l=c[1],u=Object(o.useState)(a.getValue().polygons),h=Object(X.a)(u,2),d=h[0],m=h[1];Object(o.useEffect)((function(){var e=[a.subscribe((function(e){m(s.polygons),l(e)}))];return function(){return e.forEach((function(e){return e.unsubscribe()}))}}),[]);var g=Object(o.useState)(n.life$.getValue()),v=Object(X.a)(g,2),p=v[0],b=v[1];function y(){return d||r!==ar.None||p.stage<f.Stage.Slack}function w(){return d||r!==ar.None}return Object(o.useEffect)((function(){var e=n.life$.subscribe(b);return function(){return e.unsubscribe()}}),[n]),o.createElement("div",null,o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.a,null)," Phase"),o.createElement(cr,{tensegrity:n,stageTransition:rr.SlackToPretensing,disabled:w()}),o.createElement(cr,{tensegrity:n,stageTransition:rr.CapturePretenstToSlack,disabled:w()}),o.createElement(cr,{tensegrity:n,stageTransition:rr.SlackToShaping,disabled:w()})),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.y,null)," Environment"),o.createElement("div",null,"Surface"),o.createElement(Q.a,{size:"sm",className:"w-100"},Object.keys(f.SurfaceCharacter).map((function(e){return o.createElement(q.a,{key:"SurfaceCharacter[".concat(e,"]"),disabled:y(),active:s.surfaceCharacter===f.SurfaceCharacter[e],onClick:function(){return t={surfaceCharacter:f.SurfaceCharacter[e]},void a.next(it(a.getValue(),t));var t}},e)}))),o.createElement(Xn,{feature:t[f.WorldFeature.PretenstFactor],disabled:y()}),o.createElement(Xn,{feature:t[f.WorldFeature.StiffnessFactor],disabled:y()}),o.createElement(Xn,{feature:t[f.WorldFeature.Gravity],disabled:y()}),o.createElement(Xn,{feature:t[f.WorldFeature.Drag],disabled:y()})),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.g,null)," Compression vs Tension"),o.createElement(cr,{tensegrity:n,stageTransition:rr.CaptureStrainForStiffness,disabled:w()}),o.createElement(Xn,{feature:t[f.WorldFeature.PushOverPull],disabled:y()})))}!function(e){e[e.CaptureLengthsToSlack=0]="CaptureLengthsToSlack",e[e.SlackToPretensing=1]="SlackToPretensing",e[e.SlackToShaping=2]="SlackToShaping",e[e.CapturePretenstToSlack=3]="CapturePretenstToSlack",e[e.CaptureStrainForStiffness=4]="CaptureStrainForStiffness"}(rr||(rr={})),function(e){e[e.None=0]="None",e[e.Faces=1]="Faces",e[e.Intervals=2]="Intervals"}(ar||(ar={}));var hr=n(659),fr=n(658),dr=n(657),mr=n(648),gr=n(649);function vr(e){var t=e.rootTenscript,n=e.setRootTenscript,r=e.tensegrity,a=e.runTenscript,i=e.storedState$,c=Object(o.useState)(r&&!r.tenscript.fromUrl?r.tenscript:t),s=Object(X.a)(c,2),l=s[0],u=s[1],h=Object(o.useState)(""),f=Object(X.a)(h,2),d=f[0],m=f[1],g=Object(o.useState)(!1),v=Object(X.a)(g,2),b=v[0],y=v[1],w=Object(o.useState)(nt(i.getValue())),E=Object(X.a)(w,2),S=E[0],P=E[1],x=Object(o.useState)(!1),F=Object(X.a)(x,2),j=F[0],O=F[1];function R(e){var t=function(e,t){var n=t.code,r=t.name,a=Object(Be.a)({},e.recentCode);return a[r]=n,it(e,{recentCode:a})}(i.getValue(),e);P(nt(t)),i.next(t)}return o.createElement("div",{id:"tenscript-panel",style:{flexDirection:"column",position:"relative",backgroundColor:"rgba(0,0,0,1)",height:"100%"}},o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(J.O,null)," Tenscript"),o.createElement("div",{id:"code-and-run",style:{flexDirection:"column",height:"available"}},o.createElement(pr,{tenscript:l,setTenscript:u,error:d,setError:m}),o.createElement(Q.a,{className:"w-100 my-2"},o.createElement(q.a,{color:d.length>0?"warning":"success",disabled:d.length>0,onClick:function(){return a(l)}},0===d.length?o.createElement("span",null,"Execute ",o.createElement(J.J,null)," tenscript"):o.createElement("span",null,o.createElement(J.h,null)," ",d)))),o.createElement(Q.a,{className:"w-100 my-2"},o.createElement(q.a,{disabled:l.code===t.code,onClick:function(){n(l),R(l)}},"Save ",o.createElement(J.C,null)," for later")),0===S.length?void 0:o.createElement(hr.a,{className:"w-100 my-2",isOpen:b,toggle:function(){return y(!b)}},o.createElement(fr.a,{style:{borderRadius:"1.078em"}},b?o.createElement(J.L,null):o.createElement(J.K,null)," Recent"),o.createElement(dr.a,null,S.map((function(e,t){return o.createElement(mr.a,{key:"Recent".concat(t),onClick:function(){return a(e)}},e.name)})))),o.createElement(hr.a,{className:"w-100 my-2",isOpen:j,toggle:function(){return O(!j)}},o.createElement(fr.a,{color:"info",style:{borderRadius:"1.078em"}},"Explore ",o.createElement(J.D,null)," existing designs"),o.createElement(dr.a,null,et.map((function(e,t){return o.createElement(mr.a,{key:"Boot".concat(t),onClick:function(){return a(e)}},e.name)}))))),o.createElement(yr,null,o.createElement("h6",{className:"w-100 text-center"},"Special ",o.createElement(J.M,null)," versions"),o.createElement(Q.a,{vertical:!1,className:"w-100"},o.createElement(q.a,{onClick:function(){return k(p.Sphere)}},o.createElement(J.x,null)),o.createElement(q.a,{onClick:function(){return k(p.Bridge)}},o.createElement(J.r,null)),o.createElement(q.a,{onClick:function(){return k(p.Gotchi)}},o.createElement(J.h,null)))))}function pr(e){var t=e.tenscript,n=e.setTenscript,r=e.error,a=e.setError,i=Object(o.useState)(""),c=Object(X.a)(i,2),s=c[0],l=c[1];function u(e){l(e),function(e){var t=Qe(a,!1,e);t&&(a(""),n(t))}(e)}return Object(o.useEffect)((function(){return l(t.code)}),[]),o.createElement("div",{className:"my-2 p-2 w-100",style:{backgroundColor:"#757575",color:"#ffffff",borderStyle:"solid",borderRadius:"1em",borderColor:0===r.length?"black":"#f0ad4e",borderWidth:"2px"}},o.createElement("h6",{className:"w-100 text-center"},o.createElement("i",null,'"',t.name,'"')),o.createElement(gr.a,{style:{borderRadius:"1em",height:"17em"},type:"textarea",id:"tenscript",value:s,onChange:function(e){return u(e.target.value)}}))}function br(e){var t=e.floatFeatures,n=e.rootTenscript,r=e.setRootTenscript,a=e.shapeSelection,i=e.setShapeSelection,c=e.selectedFaces,s=e.clearSelection,l=e.selectedIntervals,u=e.tensegrity,h=e.setFabric,f=e.runTenscript,d=e.toFullScreen,m=e.storedState$,g=Object(o.useState)(u?u.life$.getValue():void 0),v=Object(X.a)(g,2),p=v[0],b=v[1];Object(o.useEffect)((function(){var e=u?u.life$.subscribe(b):void 0;return function(){e&&e.unsubscribe()}}),[u]);var y=Object(o.useState)(m.getValue().controlTab),w=Object(X.a)(y,2),E=w[0],S=w[1];function k(e){var t=e.tab;return o.createElement(Bn.a,null,o.createElement(zn.a,{active:E===t,onClick:function(){return m.next(it(m.getValue(),{controlTab:t}))}},t))}function P(e){var d=e.tab,g=o.createElement(Gn.a,{color:"warning"},"No fabric");return o.createElement(Zn.a,{id:"tab-pane",style:{height:"100%"},tabId:d},o.createElement((function(){switch(d){case Ke.Grow:return o.createElement(vr,{rootTenscript:n,setRootTenscript:r,tensegrity:u,runTenscript:f,storedState$:m});case Ke.Shape:return u?o.createElement(lr,{floatFeatures:t,tensegrity:u,setFabric:h,selectedIntervals:l,shapeSelection:a,setShapeSelection:i,selectedFaces:c,clearSelection:s,storedState$:m}):g;case Ke.Live:return u?o.createElement(or,{floatFeatures:t,tensegrity:u,storedState$:m}):g;case Ke.Realize:return u?o.createElement(ur,{floatFeatures:t,tensegrity:u,shapeSelection:a,storedState$:m}):g;case Ke.Frozen:return u?o.createElement(Jn,{tensegrity:u,floatFeatures:t,storedState$:m}):g}}),null))}return Object(o.useEffect)((function(){E!==Ke.Shape&&s()}),[E,p]),Object(o.useEffect)((function(){var e=m.subscribe((function(e){return S(e.controlTab)}));return function(){return e.unsubscribe()}}),[]),o.createElement("div",{className:"h-100"},o.createElement(Un.a,{tabs:!0,style:{backgroundColor:"#b2b2b2"}},Object.keys(Ke).map((function(e){return o.createElement(k,{key:"T".concat(e),tab:Ke[e]})}))),o.createElement($n.a,{style:{flex:1,flexFlow:"auto",height:"100%"},id:"tab-content",activeTab:E},Object.keys(Ke).map((function(e){return o.createElement(P,{key:e,tab:Ke[e]})}))),o.createElement("div",{style:{position:"absolute",top:0,height:"100%",left:"25em",zIndex:10,width:"1em"}},o.createElement((function(){return o.createElement(q.a,{style:{padding:0,margin:0,borderRadius:0,width:"1em"},className:"w-100 h-100",color:"dark",onClick:d},o.createElement(J.c,null))}),null)))}function yr(e){var t=e.children,n=e.height;return o.createElement("div",{className:"m-3 p-2",style:{height:n,borderRadius:"1em",borderStyle:"solid",borderWidth:"0.1em",borderColor:"#45782e"}},t)}Object(H.b)({Orbit:Mn});var wr=new l.SphereGeometry(1,32,8),Er=new l.CylinderGeometry(1,1,1,12,1,!1),Sr=new l.CylinderGeometry(.5,.5,1,6,1,!1),kr=new l.CylinderGeometry(1,1,.85,12,1,!1),Pr=new l.Color("#ffffff"),xr=new l.SphereGeometry(100,25,25).scale(1,1,1),Fr=new l.Vector3(0,1,0);function jr(e){var t=e.tensegrity,n=e.selectedIntervals,r=e.toggleSelectedInterval,a=e.selectedFaces,i=e.setSelectedFaces,c=e.storedState$,s=e.shapeSelection,u=e.polygons,d=document.getElementById("view-container"),m=Object(o.useState)(0),g=Object(X.a)(m,2),v=g[0],p=g[1],b=Object(H.d)().camera;if(!b)throw new Error("Wheres the camera tenseg?");var y=Object(o.useMemo)((function(){var e=(new l.TextureLoader).load("space.jpg");return new l.MeshPhongMaterial({map:e,side:l.BackSide})}),[]),w=Object(o.useState)(t.life$.getValue()),E=Object(X.a)(w,2),S=E[0],k=E[1],P=Object(o.useState)(t.instance),x=Object(X.a)(P,2),F=x[0],j=x[1];Object(o.useEffect)((function(){var e=t.life$.subscribe(k);return j(t.instance),function(){return e.unsubscribe()}}),[t]);var O=Object(o.useState)(c.getValue()),R=Object(X.a)(O,2),C=R[0],N=R[1];Object(o.useEffect)((function(){var e=c.subscribe((function(e){return N(e)}));return function(){return e.unsubscribe()}}),[]),Object(o.useEffect)((function(){V.current.autoRotate=C.rotating}),[C]);var V=Object(H.e)((function(e){var t=new l.Vector3(0,4,0);b.position.set(t.x,4,t.z+16),b.lookAt(V.current.target),b.fov=60,b.far=200,b.near=.001,e.object=b,e.minPolarAngle=-.98*Math.PI/2,e.maxPolarAngle=.8*Math.PI,e.maxDistance=90,e.zoomSpeed=.5,e.enableZoom=!0,e.target.set(t.x,t.y,t.z),e.update()}),[]);return Object(H.c)((function(){var e,n=F.view,r=a.length>0?(e=a).reduce((function(e,t){return e.add(t.location())}),new l.Vector3).multiplyScalar(1/e.length):new l.Vector3(n.midpoint_x(),n.midpoint_y(),n.midpoint_z()),i=(new l.Vector3).subVectors(r,V.current.target).multiplyScalar(.01);if(V.current.target.add(i),V.current.update(),!u&&s!==ar.Faces){var o=t.iterate();switch(S.stage===f.Stage.Pretensing&&o===f.Stage.Pretenst?t.transition={stage:f.Stage.Pretenst}:void 0!==o&&o!==S.stage&&S.stage!==f.Stage.Pretensing&&(t.transition={stage:o}),o){case f.Stage.Pretensing:case f.Stage.Pretenst:break;default:p(v+1)}}})),o.createElement("group",null,o.createElement("orbit",{ref:V,args:[b,d]}),o.createElement("scene",null,u?o.createElement(Cr,{tensegrity:t,storedState:C}):o.createElement(Vr,{tensegrity:t,selectedIntervals:n,storedState:C,toggleSelectedInterval:r}),s!==ar.Faces?void 0:o.createElement(o.Fragment,null,o.createElement(Ir,{key:"faces",tensegrity:t,stage:S.stage,selectFace:function(e){a.some((function(t){return t.index===e.index}))?i(a.filter((function(t){return t.index!==e.index}))):i([].concat(Object(h.a)(a),[e]))}}),a.map((function(e){return o.createElement(Or,{key:"Face".concat(e.index),tensegrity:t,face:e})}))),S.stage<f.Stage.Pretensing?void 0:o.createElement(Ae,null),o.createElement("mesh",{key:"space",geometry:xr,material:y}),o.createElement("ambientLight",{color:Pr,intensity:.8}),o.createElement("directionalLight",{color:new l.Color("#FFFFFF"),intensity:2})))}function Or(e){e.tensegrity;var t=e.face,n=L(t.brick.scale)/8;return o.createElement("mesh",{geometry:wr,position:t.location(),material:je,scale:new l.Vector3(n,n,n)})}function Rr(e){var t=e.tensegrity,n=e.interval,r=e.storedState,a=e.onPointerDown,i=function(e,t){if(void 0===t.visibleRoles.find((function(t){return t===e.intervalRole})))return!1;var n=e.strainNuance();return e.isPush?n>=t.pushBottom&&n<=t.pushTop:n>=t.pullBottom&&n<=t.pullTop}(n,r)?Ce(n.intervalRole):Ne,c=r.featureValues[n.isPush?f.WorldFeature.PushRadius:f.WorldFeature.PullRadius].numeric,s=t.instance.unitVector(n.index),u=(new l.Quaternion).setFromUnitVectors(Fr,s),h=n.alpha.location().distanceTo(n.omega.location()),d=c*r.featureValues[f.WorldFeature.JointRadiusFactor].numeric,m=new l.Vector3(c,h+(n.isPush?2*-d:0),c),g=new l.Vector3(d,d,d);return o.createElement(o.Fragment,null,n.isPush?o.createElement(o.Fragment,null,o.createElement("mesh",{geometry:Sr,position:n.location(),rotation:(new l.Euler).setFromQuaternion(u),scale:m,material:i,matrixWorldNeedsUpdate:!0,onPointerDown:a}),o.createElement("mesh",{geometry:kr,position:n.location(),rotation:(new l.Euler).setFromQuaternion(u),scale:m,material:i,matrixWorldNeedsUpdate:!0,onPointerDown:a}),o.createElement("mesh",{geometry:wr,position:n.alpha.location(),material:Oe,scale:g,matrixWorldNeedsUpdate:!0,onPointerDown:a}),o.createElement("mesh",{geometry:wr,position:n.omega.location(),material:Oe,scale:g,matrixWorldNeedsUpdate:!0,onPointerDown:a})):o.createElement("mesh",{geometry:Er,position:n.location(),rotation:(new l.Euler).setFromQuaternion(u),scale:m,material:i,matrixWorldNeedsUpdate:!0,onPointerDown:a}))}function Cr(e){var t=e.tensegrity,n=e.storedState;return o.createElement("group",null,t.intervals.map((function(e){return o.createElement(Rr,{key:"I".concat(e.index),tensegrity:t,interval:e,storedState:n})})),"}")}function Nr(e){var t=e.interval,n=e.tensegrity,r=e.storedState,a=e.toggleSelectedInterval;return o.createElement(Rr,{tensegrity:n,interval:t,storedState:r,onPointerDown:function(){return a(t)}})}function Vr(e){var t=e.tensegrity,n=e.selectedIntervals,r=e.storedState,a=e.toggleSelectedInterval;return o.createElement("group",null,o.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:Fe}),n.map((function(e){return o.createElement(Nr,{key:"SI".concat(e.index),interval:e,tensegrity:t,storedState:r,toggleSelectedInterval:a})})))}function Ir(e){var t=e.tensegrity,n=e.stage,r=e.selectFace,a=Object(H.d)().raycaster,i=Object(o.useRef)(),c=Object(o.useState)(),s=Object(X.a)(c,2),u=s[0],h=s[1];return o.createElement("mesh",{key:"faces",ref:i,onPointerDown:function(e){return h(e)},onPointerUp:function(e){var o=i.current;if(!function(e){return e===f.Stage.Growing||e===f.Stage.Slack}(n)&&u&&o){var c=u.clientX-e.clientX,s=u.clientY-e.clientY;if(!(c*c+s*s>100)){var l=a.intersectObjects([o],!0).map((function(e){return e.faceIndex})).map((function(e){if(void 0!==e)return t.faces[e]})).reverse().pop();h(void 0),l&&r(l)}}},geometry:t.instance.floatView.faceGeometry},o.createElement("meshPhongMaterial",{attach:"material",transparent:!0,side:l.DoubleSide,opacity:.3,color:"white"}))}function Mr(e){var t=function(){var e=location.hash.substring(1);try{return Qe((function(e){return console.error(e)}),!0,decodeURIComponent(e))}catch(t){console.error("Code error",t)}}();if(t)return t;S()!==p.Design&&k(S());var n=nt(e);return n.length>0?n[0]:et[0]}function Ar(e){var t=e.createInstance,n=e.floatFeatures,r=e.storedState$,a=Object(o.useMemo)((function(){return t(!1)}),[]),i=Object(o.useState)(),c=Object(X.a)(i,2),s=c[0],u=c[1],d=Object(o.useState)([]),m=Object(X.a)(d,2),g=m[0],v=m[1],p=Object(o.useState)([]),b=Object(X.a)(p,2),y=b[0],E=b[1];Object(o.useEffect)((function(){return E(g.reduce((function(e,t){var n=function(t){return!e.some((function(e){return t.index===e.index}))},r=t.pulls.filter(n),a=t.pushes.filter(n);return[].concat(Object(h.a)(e),Object(h.a)(a),Object(h.a)(r))}),[]))}),[g]);var S=Object(o.useState)((function(){return Mr(r.getValue())})),k=Object(X.a)(S,2),P=k[0],x=k[1];Object(o.useEffect)((function(){location.hash.startsWith("#`")||(location.hash=P.code)}),[P]);var F=Object(o.useState)(r.getValue().rotating),j=Object(X.a)(F,2),O=j[0],R=j[1],C=Object(o.useState)(ar.None),N=Object(X.a)(C,2),V=N[0],I=N[1],M=Object(o.useState)(r.getValue().fullScreen),A=Object(X.a)(M,2),T=A[0],W=A[1],_=Object(o.useState)(r.getValue().polygons),B=Object(X.a)(_,2),z=B[0],G=B[1];function Z(e){if(a){location.hash=e.code,n[f.WorldFeature.ShapingPretenstFactor].percent=100,n[f.WorldFeature.ShapingDrag].percent=100,n[f.WorldFeature.ShapingStiffnessFactor].percent=100,r.next(it(r.getValue(),{polygons:!1}));u(new ft(new l.Vector3,e.symmetrical,0,D(),(function(e){return at((function(e){return n[e].numeric}),e)}),(function(e){return r.getValue().featureValues[e].numeric}),a,e))}}function U(e){r.next(it(r.getValue(),{fullScreen:e}))}return Object(o.useEffect)((function(){var e=r.subscribe((function(e){W(e.fullScreen),G(e.polygons),R(e.rotating),s&&a.world.set_surface_character(e.surfaceCharacter)}));return function(){return e.unsubscribe()}}),[s]),Object(o.useEffect)((function(){var e=Object.keys(n).map((function(e){return n[e]})).map((function(e){return e.observable.subscribe((function(t){if(s){s.instance.applyFeature(e);var n=w(e.config.feature);void 0!==n&&s.intervals.filter((function(e){return e.intervalRole===n})).forEach((function(t){var n=e.numeric*L(t.scale);s.fabric.change_rest_length(t.index,n,500)}))}}))}));return function(){return e.forEach((function(e){return e.unsubscribe()}))}}),[s]),Object(o.useEffect)((function(){var e=setTimeout((function(){s||Z(P)}),200);return function(){return clearTimeout(e)}}),[P]),o.createElement(o.Fragment,null,T?o.createElement(q.a,{id:"to-full-screen",color:"dark",onClick:function(){return U(!1)}},o.createElement(J.d,null),o.createElement("br",null),o.createElement(J.T,null),o.createElement("br",null),o.createElement(J.d,null)):o.createElement("div",{id:"left-side",style:{visibility:T?"collapse":"visible",width:"25em"}},o.createElement(br,{floatFeatures:n,rootTenscript:P,setRootTenscript:x,tensegrity:s,setFabric:u,selectedIntervals:y,shapeSelection:V,setShapeSelection:I,selectedFaces:g,clearSelection:function(){v([]),E([])},runTenscript:Z,toFullScreen:function(){return U(!0)},storedState$:r})),o.createElement("div",{style:{position:"absolute",left:T?0:"26em",right:0,height:"100%"}},s?o.createElement("div",{className:"h-100"},o.createElement(Tr,{tensegrity:s}),o.createElement("div",{id:"bottom-right"},o.createElement(Q.a,null,o.createElement(q.a,{color:O?"warning":"secondary",onClick:function(){return r.next(it(r.getValue(),{rotating:!O}))}},o.createElement(J.R,null)))),o.createElement("div",{id:"bottom-left"},o.createElement(Q.a,null,o.createElement(q.a,{disabled:!z,color:z?"secondary":"success",onClick:function(){return r.next(it(r.getValue(),{polygons:!1}))}},o.createElement(J.N,null)),o.createElement(q.a,{disabled:z,color:z?"success":"secondary",onClick:function(){return r.next(it(r.getValue(),{polygons:!0}))}},o.createElement(J.H,null)))),o.createElement("div",{id:"view-container",className:"h-100"},o.createElement(H.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:V===ar.Faces||z?"#f0ad4e":"black",cursor:V===ar.Faces?"pointer":"all-scroll",borderWidth:"2px"}},o.createElement(jr,{tensegrity:s,selectedIntervals:y,toggleSelectedInterval:function(e){return E((function(t){return t.filter((function(t){return t.index!==e.index}))}))},selectedFaces:g,setSelectedFaces:v,shapeSelection:V,polygons:z,storedState$:r})))):o.createElement("div",{id:"tensegrity-view",className:"h-100"},o.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},o.createElement(q.a,{onClick:function(){return Z(P)}},o.createElement("h6",null,P.name),o.createElement("h1",null,o.createElement(J.J,null)))))))}function Tr(e){var t=e.tensegrity,n=Object(o.useState)(t.life$.getValue()),r=Object(X.a)(n,2),a=r[0],i=r[1];return Object(o.useEffect)((function(){var e=t.life$.subscribe(i);return function(){return e.unsubscribe()}}),[t]),o.createElement("div",{id:"top-middle"},o.createElement("span",null,f.Stage[a.stage])," ",o.createElement("i",null,'"',t.tenscript.name,'"'))}n.d(t,"startReact",(function(){return _r}));var Dr=function(e){throw new Error("Unable to compile: ".concat(e))},Lr=function(e){var t=Qe(Dr,!1,e);if(!t)throw new Error("Unable to build body");return t};function Wr(e){var t=document.getElementById("root");c.render(e,t)}function _r(e,t,n){return Br.apply(this,arguments)}function Br(){return(Br=Object(i.a)(a.a.mark((function e(t,n,r){var i,c,u,h,f,d,m,v,b,y,w,E,k,P,x;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=function(e,a){return new re(t,200,e?r:n,a)},e.t0=S(),e.next=e.t0===p.Gotchi?4:e.t0===p.Bridge?10:e.t0===p.Sphere?20:27;break;case 4:return location.hash="gotchi",c=function(e,t,n,r,a,i){return g.forEach((function(n){return e.world.set_float_value(n,t(n))})),new ft(n,a,i,D(),(function(e){return at(t,e)}),t,e,Lr(r))},u=new Kt({newGotchi:function(e,n,r){var a=At(e,n,r);return new Tt(a,0!==n.fabric.age?void 0:c(n,(function(e){return Lt(e,t.default_world_feature(e))}),e.center,Ct,!0,e.rotation))},newSatoshiTree:function(e,n){return new ln(e.name,c(n,(function(e){return Wt(e,t.default_world_feature(e))}),e.center,Nt,!1,0))}},"Pretenst Island",1001010),Wr(o.createElement(an,{island:u,homePatch:u.patches[0],createInstance:i})),e.abrupt("break",32);case 10:return location.hash="bridge",h=function(e){return $(e,t.default_world_feature(e))},f=function(e){return at(h,e)},d=i(!0),g.forEach((function(e){return d.world.set_float_value(e,h(e))})),m=Lr(U()),v=W(3.5),b=new ft(new l.Vector3,!0,0,v,f,h,d,m),Wr(o.createElement(Te,{tensegrity:b})),e.abrupt("break",32);case 20:return y=function(e){return dn(e,t.default_world_feature(e))},w=i(!1),g.forEach((function(e){return w.world.set_float_value(e,y(e))})),E=new l.Vector3(0,3,0),k=function(e){return new _n(E,2,e,.52,y,w)},Wr(o.createElement(Tn,{createSphere:k})),e.abrupt("break",32);case 27:return(P=new s.BehaviorSubject(ct(st,t.default_world_feature))).subscribe((function(e){return ot(e)})),x=ut(P,t.default_world_feature),Wr(o.createElement(Ar,{createInstance:i,floatFeatures:x,storedState$:P})),e.abrupt("break",32);case 32:hn();case 33:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}}]);
//# sourceMappingURL=4.8de142e4.chunk.js.map