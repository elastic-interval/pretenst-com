{"version":3,"sources":["fabric/eig-util.ts","fabric/tensegrity-types.ts","fabric/tensegrity-builder.ts","fabric/tenscript.ts","storage/stored-state.ts","fabric/fabric-features.ts","service-worker.ts","fabric/fabric-instance.ts","fabric/tensegrity-optimizer.ts","fabric/life.ts","fabric/tensegrity.ts","view/life-stage-button.tsx","view/shape-tab.tsx","view/materials.ts","view/feature-panel.tsx","view/realize-tab.tsx","view/strain-tab.tsx","view/tenscript-tab.tsx","storage/download.ts","view/view-tab.tsx","view/control-tabs.tsx","view/orbit.ts","view/surface-component.tsx","view/fabric-view.tsx","view/tensegrity-view.tsx","start.tsx"],"names":["FABRIC_FEATURES","Object","keys","FabricFeature","filter","k","isNaN","parseInt","map","intervalRoleName","intervalRole","IntervalRole","NexusPush","ColumnPush","Triangle","Ring","NexusCross","ColumnCross","BowMid","BowEnd","FaceConnector","FaceDistancer","ADJUSTABLE_INTERVAL_ROLES","role","isPushInterval","fabricFeatureIntervalRole","fabricFeature","NexusPushLength","ColumnPushLength","TriangleLength","RingLength","NexusCrossLength","ColumnCrossLength","BowMidLength","BowEndLength","Ray","PushEnd","PHI","DEFAULT_PUSH_LENGTH","Math","sqrt","TRIANGLES","NNN","PNN","NPN","NNP","NPP","PNP","PPN","PPP","TRIANGLE_DIRECTIONS","otherJoint","interval","joint","alpha","index","omega","Error","gatherJointCables","intervals","jointIntervals","push","find","isPush","unitFromHere","Vector3","subVectors","location","normalize","pushUnit","sort","a","b","pushToA","dot","pushToB","shift","nearUnit","projectNearOnPush","addScaledVector","nearPerp","pushToNear","Quaternion","setFromUnitVectors","nearCross","crossVectors","jointInterval","intervalUnit","projectIntervalOnPush","intervalPerp","intervalCross","pushToInterval","separation","acos","PI","rotation","angleTo","rayVector","ray","v","XP","setX","XN","YP","setY","YN","ZP","setZ","ZN","brickPoint","primaryRay","secondaryRay","multiplyScalar","PUSH_ARRAY","TRIANGLE_DEFINITIONS","name","opposite","negative","ring","NN","pushEnds","YNA","XNA","ZNA","ringMember","NP","PN","PP","YPA","ZNO","XNO","ZPA","XPA","YNO","XPO","YPO","ZPO","oppositeTriangle","triangle","percentOrHundred","percent","_","percentToFactor","factorToPercent","factor","brickContaining","brickA","brickB","chooseA","joints","brickJoint","chooseB","createBrickPointsAt","base","scale","position","points","reduce","vectors","add","newBase","trianglePoints","end","reverse","midpoint","mid","p","x","y","sub","z","basis","Matrix4","makeBasis","scaleFactor","fromBasis","getInverse","setPosition","applyMatrix4","scaleToFaceConnectorLength","TensegrityBuilder","tensegrity","this","createBrick","violated","negativeAdjacent","postiveAdjacent","brickWasViolated","faceA","faces","scaleA","scaleB","createBrickOnFace","faceB","countdown","numericFeature","IntervalCountdown","connectFaces","brickToOrigin","faceIntervals","removeInterval","length","faceInterval","connector","distanceTo","connectFaceInteval","face","instance","apply","faceBasis","faceToOriginMatrix","refreshFloatView","brick","unitVector","pushes","m","twirl","makeRotationZ","multiply","brickToOriginMatrix","mark","centerBrickFaceIntervals","locations","createBrickAt","sum","averageScaleFactor","closestFace","removed","createFaceConnector","action","MarkAction","JoinFaces","FaceDistance","pullScale","distancers","forEach","indexA","indexB","createFaceDistancer","negativeFace","midSide","addVectors","u","proj","xform","movedToFace","baseTriangle","pulls","crosses","rings","initialBrick","bricks","jointIndexes","idx","createLeftJoint","alphaIndex","omegaIndex","oppositeIndex","jointLocation","createInterval","arr","tJoints","walk","createFace","dirA","oppositeJoint","pop","permutation","connectorScale","removeFace","facesToRing","from","to","corner","prev","curr","next","crossInterval","adjustRole","changeIntervalRole","isNexus","treeToCode","tree","JSON","stringify","replace","s","isDirection","char","indexOf","faceMark","isDigit","toNumber","digits","match","argument","maybeBracketed","stripBrackets","commaPos","commaPresent","charAt","content","substring","skip","finalBracket","depth","matchBracket","codeToTenscript","error","fromUrl","code","fragmentToTree","codeFragment","codeString","subtree","codeTree","direction","forward","scaleArg","S","directionChar","markNumber","undefined","parts","split","foundName","part","startsWith","endsWith","foundMain","markCode","eq","Number","Date","toDateString","mainCode","parseCode","marks","key","c","Subtree","BaseFace","mainTree","markSections","subtreesCode","join","treeToTenscript","e","message","noParseErrors","ControlTab","BOOTSTRAP","script","execute","before","active","grow","previous","newTree","treeScale","brickToMark","treeWithMarks","connectTriangle","newBrick","createConnectedBrick","brickFace","childTree","triangleMark","decremented","markTree","deleteFaceMark","VERSION","getRecentTenscript","state","recentCode","tenscript","console","roleLengthFeature","transition","partial","nonce","STORED_STATE_KEY","loadState","toConfig","defaultValue","item","localStorage","getItem","storedState","parse","version","DEFAULT_FEATURE_VALUES","record","config","feature","numeric","surfaceCharacter","SurfaceCharacter","Frozen","featureValues","controlTab","Grow","fullScreen","ellipsoids","rotating","showPushes","showPulls","initialStoredState","featureConfig","Gravity","percents","Drag","PretenstFactor","IterationsPerFrame","RealizingCountdown","SlackThreshold","ShapingPretenstFactor","ShapingStiffnessFactor","ShapingDrag","MaxStrain","VisualStrain","PushOverPull","PushRadius","PullRadius","JointRadius","MaxStiffness","FloatFeature","storedState$","value$","fromConfig","getValue","initialValue","BehaviorSubject","subscribe","value","expo","toExponential","zero","max","toFixed","createFloatFeatures","features","isLocalhost","Boolean","window","hostname","register","navigator","URL","process","toString","origin","addEventListener","swUrl","fetch","then","response","status","headers","get","serviceWorker","ready","registration","unregister","reload","registerValidSW","catch","log","checkValidServiceWorker","onupdatefound","installingWorker","installing","onstatechange","controller","vectorFromArray","array","vector","offset","set","createFloatView","fabric","view","lineColors","floatArray","copy_line_colors_to","get_interval_count","lineLocations","copy_line_locations_to","faceNormals","copy_face_normals_to","get_face_count","faceLocations","copy_face_vertex_locations_to","jointLocations","copy_joint_locations_to","get_joint_count","jointVelocities","copy_joint_velocities_to","unitVectors","copy_unit_vectors_to","idealLengths","copy_ideal_lengths_to","strains","copy_strains_to","strainNuances","copy_strain_nuances_to","stiffnesses","copy_stiffnesses_to","linearDensities","copy_linear_densities_to","copyFunction","Float32Array","FabricInstance","eig","jointCount","world","floatView","featuresToApply","World","new","Fabric","View","on_fabric","requestedStage","stage","iterate","render","set_float_value","clear","jointIndex","matrix","apply_matrix4","toArray","intervalIndex","TensegrityOptimizer","pairs","findPush","i","intervalA","aAlpha","aOmega","aAlphaPush","aOmegaPush","aAlphaLoc","aOmegaLoc","aLength","aMid","intervalB","bAlpha","bOmega","bAlphaPush","bOmegaPush","samePush","pushA","pushB","bAlphaLoc","bOmegaLoc","bLength","bMid","aAlphaMidB","aOmegaMidB","bAlphaMidA","bOmegaMidA","closeCount","close","dist","ax","findInterval","ay","bx","by","pushOverPull","newStiffnesses","getAverageStrain","toAverage","averagePushStrain","averagePullStrain","averageAbsoluteStrain","changes","adjustedStiffness","restore","copy_stiffnesses","Life","_stage","prefs","Stage","Growing","Shaping","save","Slack","adoptLengths","adopt_lengths","removeFaceInterval","Realizing","Realized","strainToStiffness","stiffnessesFromStrains","COUNTDOWN_MAX","scaleToStiffness","Tensegrity","roleDefaultLength","life$","activeTenscript","backup","copy","life","withStage","create_joint","createFaceInterval","existing","remove_interval","coundown","idealLength","restLength","stiffness","create_interval","multiply_rest_length","set_interval_role","change_rest_length","foundPush","endJoint","create_face","removeIntervals","remove_face","lifePhase","Busy","activeCode","builder","centralize","collated","found","entries","possibleMark","FaceStrategy","faceStrategies","strategy","replaceCrossedNexusCrosses","finish_growing","checkFaceIntervals","joint1","joint2","jointCables","radius","jointRadius","type","strain","linearDensity","distance","faceConnectorCountdown","Float32BufferAttribute","geometry","BufferGeometry","addAttribute","computeBoundingSphere","StageTransition","ShapeSelection","faceToOrigin","createFaceIntervals","RAINBOW_COLORS","colorString","Color","lights","SURFACE","MeshPhongMaterial","color","side","DoubleSide","LINE_VERTEX_COLORS","LineBasicMaterial","vertexColors","VertexColors","SCALE_LINE","FACE","transparent","opacity","SELECT_MATERIAL","JOINT_MATERIAL","RAINBOW_LAMBERT","MeshLambertMaterial","roleColorString","roleMaterial","roleColor","FeaturePanel","disabled","useState","featurePercent","setFeaturePercent","useEffect","subscription","observable","unsubscribe","className","style","formatted","ButtonGroup","percentChoices","backgroundColor","Button","size","onClick","percentLabel","LifeStageButton","stageTransition","updateLife","allDisabledExcept","stageAccepted","CaptureLengthsToSlack","toStage","Symbol","CurrentLengthsToSlack","SlackToRealizing","SlackToShaping","vertical","CaptureRealizedToSlack","CaptureStrainForStiffness","ShapeTab","floatFeatures","selectedIntervals","setFabric","shapeSelection","setShapeSelection","selectedFaces","clearSelectedFaces","pushAndPull","setPushAndPull","set_push_and_pull","updateEllipsoids","subscriptions","newState","lengthFeature","setLengthFeature","adjustValue","up","changeIntervalScale","disableUnlessFaceCount","faceCount","mode","disabledLifeStage","None","Grouping","Intervals","selection","Faces","title","RealizeTab","updateFabricState","changed","SCALE_WIDTH","NEEDLE_WIDTH","SCALE_MAX","FEATURES","scaleGeometry","middleTick","Geometry","vertices","needleGeometry","values","midValue","maxValue","unboundedHeight","height","StrainTab","camera","useRef","left","right","age","updateAge","maxStrain","updateMaxStrain","maxStiffness","updateMaxStiffness","timer","setInterval","fabricAge","clearTimeout","Scale","floats","material","ref","TenscriptTab","rootTenscript","setRootTenscript","runTenscript","setTenscript","setError","recentOpen","setRecentOpen","recentPrograms","setRecentPrograms","bootstrapOpen","setBootstrapOpen","addToRecentPrograms","newCode","addRecentCode","id","flexDirection","CodeArea","ButtonDropdown","isOpen","toggle","DropdownToggle","borderRadius","DropdownMenu","DropdownItem","bootstrapProgram","tenscriptCode","setTenscriptCode","onCodeChange","compiled","compile","borderStyle","borderColor","borderWidth","Input","onChange","changeEvent","target","csvNumber","n","dateString","toISOString","saveCSVZip","output","getFabricOutput","zip","JSZip","file","csvJoints","extractJointFile","csvIntervals","j","extractIntervalFile","csvSubmerged","submergedJoints","extractSubmergedFile","generateAsync","mimeType","blob","FileSaver","ViewTab","visibleRoles","setVisibleRoles","updateShowPushes","updateShowPulls","ViewButton","children","set_altitude","saveJSONZip","SPLIT_LEFT","ControlTabs","toFullScreen","updateControlTab","Link","tab","NavItem","NavLink","Pane","NO_FABRIC","Alert","TabPane","tabId","Shape","Realize","Strain","Nav","tabs","TabContent","flex","flexFlow","activeTab","top","zIndex","width","padding","margin","STATE","NONE","ROTATE","DOLLY","PAN","TOUCH_ROTATE","TOUCH_DOLLY","TOUCH_PAN","CHANGE_EVENT","START_EVENT","END_EVENT","Orbit","element","object","enabled","enableZoom","zoomSpeed","minDistance","maxDistance","enableRotate","rotateSpeed","enablePan","keyPanSpeed","autoRotate","autoRotateSpeed","minZoom","maxZoom","minPolarAngle","maxPolarAngle","minAzimuthAngle","maxAzimuthAngle","mouseButtons","enableDamping","dampingFactor","spherical","sphericalDelta","target0","position0","zoom0","panOffset","zoomChanged","rotateStart","rotateEnd","rotateDelta","panStart","panEnd","panDelta","dollyStart","dollyEnd","dollyDelta","updateLastPosition","updateOffset","updateQuat","updateLastQuaternion","updateQuatInverse","panLeftV","panUpV","panInternalOffset","onMouseUp","onMouseDown","onMouseMove","onMouseWheel","onTouchStart","onTouchEnd","onTouchMove","THREE","Infinity","LEFT","UP","RIGHT","BOTTOM","ORBIT","ZOOM","MIDDLE","clone","zoom","inverse","event","preventDefault","button","clientX","clientY","document","dispatchEvent","rotateLeft","clientWidth","rotateUp","clientHeight","update","dollyIn","getZoomScale","dollyOut","pan","removeEventListener","stopPropagation","deltaY","touches","pageX","pageY","dx","dy","capture","applyQuaternion","setFromVector3","getAutoRotationAngle","theta","phi","min","makeSafe","setFromSpherical","lookAt","distanceToSquared","quaternion","objectMatrix","setFromMatrixColumn","deltaX","targetDistance","tan","fov","panLeft","panUp","dollyScale","pow","angle","updateProjectionMatrix","HEXAGON_POINTS","SURFACE_SCALE","KINDA","SURFACE_LAND_COLOR","SIX","LAND_NORMAL_SPREAD","SurfaceComponent","spots","useMemo","hexPoint","vertexNormals","Face3","addSurfaceGeometry","spotsGeometry","extend","SPHERE","SphereGeometry","PULL_CYLINDER","CylinderGeometry","PUSH_CYLINDER_INNER","PUSH_CYLINDER_OUTER","AMBIENT_COLOR","SPACE_RADIUS","SPACE_SCALE","SPACE_GEOMETRY","TOWARDS_TARGET","ALTITUDE","Y_AXIS","FabricView","fabricError","setSelectedFaces","viewContainer","getElementById","setAge","perspective","useThree","spaceMaterial","spaceTexture","TextureLoader","load","BackSide","updateStoredState","orbit","current","useUpdate","orb","far","near","useRender","midpoint_x","midpoint_y","midpoint_z","towardsTarget","nextStage","setTimeout","args","EllipsoidView","LineView","selectFace","faceToToggle","some","selected","SelectedFace","intensity","IntervalMesh","nuance","floor","rainbowMaterial","unit","intervalScale","jointScale","Euler","setFromQuaternion","matrixWorldNeedsUpdate","linesGeometry","raycaster","meshRef","downEvent","setDownEvent","onPointerDown","onPointerUp","mesh","doNotClick","intersectObjects","intersection","faceIndex","facesGeometry","SPLIT_RIGHT","getCodeToRun","urlCode","hash","decodeURIComponent","getCodeFromUrl","TensegrityView","mainInstance","setTensegrity","setSelectedIntervals","accum","unknown","updateRotating","updateFullScreen","newTenscript","roleDefaultFromFeatures","set_coloring","set_surface_character","featureSubscriptions","applyFeature","scaledLength","visibility","TopMiddle","cursor","startReact","root","default_fabric_feature","setItem","ReactDOM","registerServiceWorker"],"mappings":"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","file":"static/js/4.5059fa4b.chunk.js","sourcesContent":["/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole, Stage } from \"eig\"\n\nexport function doNotClick(stage: Stage): boolean {\n    return stage === Stage.Growing || stage === Stage.Slack\n}\n\nexport const FABRIC_FEATURES: FabricFeature[] = Object.keys(FabricFeature)\n    .filter(k => isNaN(parseInt(k, 10)))\n    .map(k => FabricFeature[k])\n\nexport function intervalRoleName(intervalRole: IntervalRole): string {\n    switch (intervalRole) {\n        case IntervalRole.NexusPush:\n            return \"NP\"\n        case IntervalRole.ColumnPush:\n            return \"CP\"\n        case IntervalRole.Triangle:\n            return \"TR\"\n        case IntervalRole.Ring:\n            return \"RI\"\n        case IntervalRole.NexusCross:\n            return \"NC\"\n        case IntervalRole.ColumnCross:\n            return \"CC\"\n        case IntervalRole.BowMid:\n            return \"BM\"\n        case IntervalRole.BowEnd:\n            return \"BE\"\n        case IntervalRole.FaceConnector:\n            return \"FC\"\n        case IntervalRole.FaceDistancer:\n            return \"FD\"\n        default:\n            return \"?\"\n    }\n}\n\nexport const ADJUSTABLE_INTERVAL_ROLES: IntervalRole[] = Object.keys(IntervalRole)\n    .filter(role => IntervalRole[role] !== IntervalRole.FaceConnector && IntervalRole[role] !== IntervalRole.FaceDistancer)\n    .map(role => IntervalRole[role])\n\nexport function isPushInterval(intervalRole: IntervalRole): boolean {\n    return intervalRole === IntervalRole.ColumnPush || intervalRole === IntervalRole.NexusPush\n}\n\nexport function fabricFeatureIntervalRole(fabricFeature: FabricFeature): IntervalRole | undefined {\n    switch (fabricFeature) {\n        case FabricFeature.NexusPushLength:\n            return IntervalRole.NexusPush\n        case FabricFeature.ColumnPushLength:\n            return IntervalRole.ColumnPush\n        case FabricFeature.TriangleLength:\n            return IntervalRole.Triangle\n        case FabricFeature.RingLength:\n            return IntervalRole.Ring\n        case FabricFeature.NexusCrossLength:\n            return IntervalRole.NexusCross\n        case FabricFeature.ColumnCrossLength:\n            return IntervalRole.ColumnCross\n        case FabricFeature.BowMidLength:\n            return IntervalRole.BowMid\n        case FabricFeature.BowEndLength:\n            return IntervalRole.BowEnd\n        default:\n            return undefined\n    }\n}\n\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { IntervalRole } from \"eig\"\nimport { Matrix4, Quaternion, Vector3 } from \"three\"\n\nimport { intervalRoleName } from \"./eig-util\"\n\nexport const PHI = 1.61803398875\nexport const DEFAULT_PUSH_LENGTH = Math.sqrt(2)\n\nexport enum Ray {\n    XP = 0, XN, YP, YN, ZP, ZN,\n}\n\nexport enum PushEnd {\n    XPA = 0, XPO, XNA, XNO, YPA, YPO,\n    YNA, YNO, ZPA, ZPO, ZNA, ZNO,\n}\n\nexport enum Triangle {\n    NNN = 0, PNN, NPN, NNP, NPP, PNP, PPN, PPP,\n}\n\nexport const TRIANGLES = [Triangle.NNN, Triangle.PNN, Triangle.NPN, Triangle.NNP, Triangle.NPP, Triangle.PNP, Triangle.PPN, Triangle.PPP]\n\nexport const TRIANGLE_DIRECTIONS = \"aBCDbcdA\"\n\nexport enum Ring {\n    NN = 0, // [PushEnd.ZNO, PushEnd.XPA, PushEnd.YNO, PushEnd.ZPA, PushEnd.XNO, PushEnd.YPA],\n    PN = 1, // [PushEnd.YNA, PushEnd.XNA, PushEnd.ZNO, PushEnd.YPO, PushEnd.XPO, PushEnd.ZPA],\n    NP = 2, // [PushEnd.XNA, PushEnd.YPA, PushEnd.ZPO, PushEnd.XPO, PushEnd.YNO, PushEnd.ZNA],\n    PP = 3, // [PushEnd.YNA, PushEnd.ZNA, PushEnd.XPA, PushEnd.YPO, PushEnd.ZPO, PushEnd.XNO],\n}\n\nexport interface IJoint {\n    index: number\n    oppositeIndex: number\n    location: () => Vector3\n}\n\nexport interface IInterval {\n    index: number\n    isPush: boolean\n    removed: boolean\n    intervalRole: IntervalRole\n    scale: IPercent\n    alpha: IJoint\n    omega: IJoint\n    location: () => Vector3\n}\n\nexport interface IJointCable {\n    interval: number\n    role: string\n    joint: number\n    separation: number\n    rotation: number\n}\n\nexport function otherJoint(interval: IInterval, joint: IJoint): IJoint {\n    if (interval.alpha.index === joint.index) {\n        return interval.omega\n    }\n    if (interval.omega.index === joint.index) {\n        return interval.alpha\n    }\n    throw new Error(\"Other of what?\")\n}\n\nexport function gatherJointCables(joint: IJoint, intervals: IInterval[]): IJointCable[] {\n    const jointIntervals = intervals.filter(interval => interval.alpha.index === joint.index || interval.omega.index === joint.index)\n    const push = jointIntervals.find(interval => interval.isPush)\n    if (!push) {\n        throw new Error(\"No push on joint\")\n    }\n    const unitFromHere = (interval: IInterval) => new Vector3()\n        .subVectors(otherJoint(interval, joint).location(), joint.location()).normalize()\n    const pushUnit = unitFromHere(push)\n    jointIntervals.sort((a: IInterval, b: IInterval) => {\n        const pushToA = unitFromHere(a).dot(pushUnit)\n        const pushToB = unitFromHere(b).dot(pushUnit)\n        return pushToA < pushToB ? 1 : pushToA > pushToB ? -1 : 0\n    })\n    jointIntervals.shift()\n    const nearUnit = unitFromHere(jointIntervals[0])\n    const projectNearOnPush = new Vector3().addScaledVector(pushUnit, nearUnit.dot(pushUnit))\n    const nearPerp = new Vector3().subVectors(nearUnit, projectNearOnPush).normalize()\n    const pushToNear = new Quaternion().setFromUnitVectors(pushUnit, nearPerp)\n    const nearCross = new Vector3().crossVectors(pushUnit, nearPerp)\n    return jointIntervals.map(jointInterval => {\n        const intervalUnit = unitFromHere(jointInterval)\n        const projectIntervalOnPush = new Vector3().addScaledVector(pushUnit, intervalUnit.dot(pushUnit))\n        const intervalPerp = new Vector3().subVectors(intervalUnit, projectIntervalOnPush).normalize()\n        const intervalCross = new Vector3().crossVectors(pushUnit, intervalUnit)\n        const pushToInterval = new Quaternion().setFromUnitVectors(pushUnit, intervalPerp)\n        const separation = Math.acos(pushUnit.dot(intervalUnit)) * 180 / Math.PI\n        const rotation = pushToNear.angleTo(pushToInterval) * (nearCross.dot(intervalCross) > 0 ? 180 : -180) / Math.PI\n        return <IJointCable>{\n            interval: jointInterval.index,\n            role: intervalRoleName(jointInterval.intervalRole),\n            joint: otherJoint(jointInterval, joint).index,\n            separation, rotation,\n        }\n    })\n}\n\nexport interface IFaceInterval {\n    index: number\n    alpha: IFace\n    omega: IFace\n    connector: boolean\n    scaleFactor: number\n    removed: boolean\n}\n\nexport interface IFace {\n    index: number\n    negative: boolean\n    brick: IBrick\n    triangle: Triangle\n    joints: IJoint[]\n    pushes: IInterval[]\n    pulls: IInterval[]\n    mark?: IFaceMark\n    removed: boolean\n    location: () => Vector3\n}\n\nexport function averageScaleFactor(faces: IFace[]): number {\n    return faces.reduce((sum, face) => sum + percentToFactor(face.brick.scale), 0) / faces.length\n}\n\nexport function averageLocation(locations: Vector3[]): Vector3 {\n    return locations\n        .reduce((sum, location) => sum.add(location), new Vector3())\n        .multiplyScalar(1 / locations.length)\n}\n\nexport function faceToOriginMatrix(face: IFace): Matrix4 {\n    const trianglePoints = face.joints.map(joint => joint.location())\n    const midpoint = trianglePoints.reduce((mid: Vector3, p: Vector3) => mid.add(p), new Vector3()).multiplyScalar(1.0 / 3.0)\n    const x = new Vector3().subVectors(trianglePoints[1], midpoint).normalize()\n    const z = new Vector3().subVectors(trianglePoints[0], midpoint).normalize()\n    const y = new Vector3().crossVectors(z, x).normalize()\n    z.crossVectors(x, y).normalize()\n    const faceBasis = new Matrix4().makeBasis(x, y, z).setPosition(midpoint)\n    return new Matrix4().getInverse(faceBasis)\n}\n\nexport function getOrderedJoints(face: IFace): IJoint[] {\n    const clone = [...face.joints]\n    return [...TRIANGLE_DEFINITIONS[face.triangle].negative ? clone.reverse() : clone]\n}\n\nexport interface IPushDefinition {\n    alpha: Vector3\n    omega: Vector3\n}\n\nfunction rayVector(ray: Ray): Vector3 {\n    const v = new Vector3()\n    switch (ray) {\n        case Ray.XP:\n            return v.setX(1)\n        case Ray.XN:\n            return v.setX(-1)\n        case Ray.YP:\n            return v.setY(1)\n        case Ray.YN:\n            return v.setY(-1)\n        case Ray.ZP:\n            return v.setZ(1)\n        case Ray.ZN:\n            return v.setZ(-1)\n        default:\n            return v\n    }\n}\n\nfunction brickPoint(primaryRay: Ray, secondaryRay: Ray): Vector3 {\n    return rayVector(primaryRay)\n        .multiplyScalar(DEFAULT_PUSH_LENGTH / 2)\n        .addScaledVector(rayVector(secondaryRay), DEFAULT_PUSH_LENGTH / 2 / PHI)\n}\n\nexport const PUSH_ARRAY: IPushDefinition[] = [\n    {alpha: brickPoint(Ray.ZN, Ray.XP), omega: brickPoint(Ray.ZP, Ray.XP)},\n    {alpha: brickPoint(Ray.ZN, Ray.XN), omega: brickPoint(Ray.ZP, Ray.XN)},\n    {alpha: brickPoint(Ray.XN, Ray.YP), omega: brickPoint(Ray.XP, Ray.YP)},\n    {alpha: brickPoint(Ray.XN, Ray.YN), omega: brickPoint(Ray.XP, Ray.YN)},\n    {alpha: brickPoint(Ray.YN, Ray.ZP), omega: brickPoint(Ray.YP, Ray.ZP)},\n    {alpha: brickPoint(Ray.YN, Ray.ZN), omega: brickPoint(Ray.YP, Ray.ZN)},\n]\n\nexport interface ITriangleDefinition {\n    name: Triangle\n    opposite: Triangle\n    negative: boolean\n    pushEnds: PushEnd[]\n    ringMember: Ring[]\n    ring: Ring\n}\n\nexport const TRIANGLE_DEFINITIONS: ITriangleDefinition[] = [\n    {\n        name: Triangle.NNN, opposite: Triangle.PPP, negative: true, ring: Ring.NN,\n        pushEnds: [PushEnd.YNA, PushEnd.XNA, PushEnd.ZNA], ringMember: [Ring.NP, Ring.PN, Ring.PP],\n    },\n    {\n        name: Triangle.PNN, opposite: Triangle.NPP, negative: false, ring: Ring.PP,\n        pushEnds: [PushEnd.XNA, PushEnd.YPA, PushEnd.ZNO], ringMember: [Ring.PN, Ring.NN, Ring.NP],\n    },\n    {\n        name: Triangle.NPN, opposite: Triangle.PNP, negative: false, ring: Ring.PN,\n        pushEnds: [PushEnd.XNO, PushEnd.YNA, PushEnd.ZPA], ringMember: [Ring.PP, Ring.NP, Ring.NN],\n    },\n    {\n        name: Triangle.NNP, opposite: Triangle.PPN, negative: false, ring: Ring.NP,\n        pushEnds: [PushEnd.XPA, PushEnd.YNO, PushEnd.ZNA], ringMember: [Ring.NN, Ring.PN, Ring.PP],\n    },\n    {\n        name: Triangle.NPP, opposite: Triangle.PNN, negative: true, ring: Ring.PP,\n        pushEnds: [PushEnd.YNO, PushEnd.XPO, PushEnd.ZPA], ringMember: [Ring.PN, Ring.NP, Ring.NN],\n    },\n    {\n        name: Triangle.PNP, opposite: Triangle.NPN, negative: true, ring: Ring.PN,\n        pushEnds: [PushEnd.YPO, PushEnd.XPA, PushEnd.ZNO], ringMember: [Ring.PP, Ring.NN, Ring.NP],\n    },\n    {\n        name: Triangle.PPN, opposite: Triangle.NNP, negative: true, ring: Ring.NP,\n        pushEnds: [PushEnd.YPA, PushEnd.XNO, PushEnd.ZPO], ringMember: [Ring.NN, Ring.PP, Ring.PN],\n    },\n    {\n        name: Triangle.PPP, opposite: Triangle.NNN, negative: false, ring: Ring.NN,\n        pushEnds: [PushEnd.XPO, PushEnd.YPO, PushEnd.ZPO], ringMember: [Ring.NP, Ring.PP, Ring.PN],\n    },\n]\n\nexport function oppositeTriangle(triangle: Triangle): Triangle {\n    return TRIANGLE_DEFINITIONS[triangle].opposite\n}\n\nexport interface IFaceMark {\n    _: number\n}\n\nexport interface IPercent {\n    _: number\n}\n\nexport function percentOrHundred(percent?: IPercent): IPercent {\n    return percent ? percent : {_: 100.0}\n}\n\nexport function percentToFactor({_: percent}: IPercent): number {\n    return percent / 100.0\n}\n\nexport function factorToPercent(factor: number): IPercent {\n    const _ = factor * 100.0\n    return {_}\n}\n\nexport interface IBrick {\n    index: number,\n    base: Triangle\n    scale: IPercent\n    joints: IJoint[]\n    pushes: IInterval[]\n    pulls: IInterval[]\n    crosses: IInterval[]\n    rings: IInterval[][]\n    faces: IFace[]\n    negativeAdjacent: number\n    postiveAdjacent: number\n}\n\nexport function isNexus(brick: IBrick): boolean {\n    return brick.negativeAdjacent > 1 || brick.postiveAdjacent > 1\n}\n\nexport function brickContaining(joint: IJoint, brickA: IBrick, brickB: IBrick): IBrick {\n    const chooseA = !!brickA.joints.find(brickJoint => brickJoint.index === joint.index)\n    const chooseB = !!brickB.joints.find(brickJoint => brickJoint.index === joint.index)\n    if (chooseA && !chooseB) {\n        return brickA\n    } else if (chooseB && !chooseA) {\n        return brickB\n    } else {\n        throw new Error(\"Neither contained joint\")\n    }\n}\n\nexport function initialBrick(index: number, base: Triangle, scale: IPercent): IBrick {\n    return {\n        index, base, scale, joints: [],\n        pushes: [], pulls: [], crosses: [],\n        rings: [[], [], [], []], faces: [],\n        negativeAdjacent: 0, postiveAdjacent: 0,\n    }\n}\n\nexport function createBrickPointsAt(base: Triangle, scale: IPercent, position: Vector3): Vector3 [] {\n    const pushesToPoints = (vectors: Vector3[], push: IPushDefinition): Vector3[] => {\n        vectors.push(new Vector3().add(push.alpha))\n        vectors.push(new Vector3().add(push.omega))\n        return vectors\n    }\n    const points = PUSH_ARRAY.reduce(pushesToPoints, [])\n    const newBase = oppositeTriangle(base)\n    const trianglePoints = TRIANGLE_DEFINITIONS[newBase].pushEnds.map((end: PushEnd) => points[end]).reverse()\n    const midpoint = trianglePoints.reduce((mid: Vector3, p: Vector3) => mid.add(p), new Vector3()).multiplyScalar(1.0 / 3.0)\n    const x = new Vector3().subVectors(trianglePoints[0], midpoint).normalize()\n    const y = new Vector3().sub(midpoint).normalize()\n    const z = new Vector3().crossVectors(y, x).normalize()\n    const basis = new Matrix4().makeBasis(x, y, z)\n    const scaleFactor = percentToFactor(scale)\n    const fromBasis = new Matrix4()\n        .getInverse(basis)\n        .setPosition(position)\n        .scale(new Vector3(scaleFactor, scaleFactor, scaleFactor))\n    return points.map(p => p.applyMatrix4(fromBasis))\n}\n\nexport function brickToOriginMatrix(brick: IBrick, unitVector: (index: number) => Vector3): Matrix4 {\n    const x = unitVector(brick.pushes[2].index)\n    const y = unitVector(brick.pushes[0].index)\n    const z = unitVector(brick.pushes[4].index)\n    const midpoint = brick.joints\n        .reduce((m, joint) => m.add(joint.location()), new Vector3(0, 10, 0))\n        .multiplyScalar(1.0 / 12.0)\n    const faceBasis = new Matrix4().makeBasis(x, y, z).setPosition(midpoint)\n    const twirl = new Matrix4().makeRotationZ(Math.PI/4)\n    return new Matrix4().getInverse(faceBasis.multiply(twirl))\n}\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole } from \"eig\"\nimport { Matrix4, Vector3 } from \"three\"\n\nimport { IMark, MarkAction } from \"./tenscript\"\nimport { Tensegrity } from \"./tensegrity\"\nimport {\n    averageLocation,\n    averageScaleFactor,\n    brickContaining, brickToOriginMatrix,\n    createBrickPointsAt,\n    faceToOriginMatrix,\n    factorToPercent,\n    IBrick,\n    IFace,\n    IFaceInterval,\n    IInterval,\n    IJoint,\n    initialBrick,\n    IPercent,\n    IPushDefinition,\n    isNexus,\n    percentToFactor,\n    PUSH_ARRAY,\n    Triangle,\n    TRIANGLE_DEFINITIONS,\n} from \"./tensegrity-types\"\n\nexport function scaleToFaceConnectorLength(scaleFactor: number): number {\n    return 0.6 * scaleFactor\n}\n\nexport class TensegrityBuilder {\n\n    constructor(private tensegrity: Tensegrity) {\n    }\n\n    public createBrickAt(midpoint: Vector3, scale: IPercent): IBrick {\n        const points = createBrickPointsAt(Triangle.PPP, scale, midpoint)\n        return this.createBrick(points, Triangle.NNN, scale)\n    }\n\n    public createConnectedBrick(brickA: IBrick, triangle: Triangle, scale: IPercent): IBrick {\n        const violated = () => brickA.negativeAdjacent > 1 && brickA.postiveAdjacent > 1\n        const brickWasViolated = violated()\n        const faceA = brickA.faces[triangle]\n        const scaleA = percentToFactor(brickA.scale)\n        const scaleB = scaleA * percentToFactor(scale)\n        const brickB = this.createBrickOnFace(faceA, factorToPercent(scaleB))\n        const faceB = brickB.faces[brickB.base]\n        const countdown = this.tensegrity.numericFeature(FabricFeature.IntervalCountdown)\n        this.connectFaces(faceA, faceB, factorToPercent((scaleA + scaleB) / 2), countdown)\n        if (brickWasViolated !== violated()) {\n            this.brickToOrigin(brickA)\n        }\n        return brickB\n    }\n\n    public checkFaceIntervals(faceIntervals: IFaceInterval[], removeInterval: (faceInterval: IFaceInterval) => void): IFaceInterval[] {\n        if (faceIntervals.length === 0) {\n            return faceIntervals\n        }\n        const connectFaceInteval = ({alpha, omega, scaleFactor}: IFaceInterval) => {\n            const countdown = this.tensegrity.numericFeature(FabricFeature.IntervalCountdown)\n            this.connectFaces(alpha, omega, factorToPercent(scaleFactor), countdown)\n        }\n        return faceIntervals.filter(faceInterval => {\n            if (faceInterval.connector) {\n                const {alpha, omega, scaleFactor} = faceInterval\n                const distance = alpha.location().distanceTo(omega.location())\n                const closeEnough = distance <= scaleToFaceConnectorLength(scaleFactor) * 10\n                if (closeEnough) {\n                    connectFaceInteval(faceInterval)\n                    removeInterval(faceInterval)\n                    return false\n                }\n            }\n            return true\n        })\n    }\n\n    public faceToOrigin(face: IFace): void {\n        const instance = this.tensegrity.instance\n        instance.apply(faceToOriginMatrix(face))\n        instance.refreshFloatView()\n    }\n\n    public brickToOrigin(brick: IBrick): void {\n        const instance = this.tensegrity.instance\n        instance.apply(brickToOriginMatrix(brick, index => instance.unitVector(index)))\n        instance.refreshFloatView()\n    }\n\n    public createFaceIntervals(faces: IFace[], mark: IMark): IFaceInterval[] {\n        const centerBrickFaceIntervals = () => {\n            const brick = this.createBrickAt(\n                averageLocation(faces.map(face => face.location())),\n                factorToPercent(averageScaleFactor(faces)),\n            )\n            return faces.map(face => {\n                const opposing = brick.faces.filter(({negative, removed}) => !removed && negative !== face.negative)\n                const closestFace = opposing.reduce((a, b) => {\n                    const aa = a.location().distanceTo(face.location())\n                    const bb = b.location().distanceTo(face.location())\n                    return aa < bb ? a : b\n                })\n                closestFace.removed = true\n                return this.tensegrity.createFaceConnector(closestFace, face)\n            })\n        }\n        switch (mark.action) {\n            case MarkAction.JoinFaces:\n                switch (faces.length) {\n                    case 2:\n                        if (faces[0].negative === faces[1].negative) {\n                            return centerBrickFaceIntervals()\n                        }\n                        return [this.tensegrity.createFaceConnector(faces[0], faces[1])]\n                    case 3:\n                        return centerBrickFaceIntervals()\n                    default:\n                        return []\n                }\n            case MarkAction.FaceDistance:\n                const pullScale = mark.scale\n                if (!pullScale) {\n                    throw new Error(\"Missing pull scale\")\n                }\n                const distancers: IFaceInterval[] = []\n                faces.forEach((faceA, indexA) => {\n                    faces.forEach((faceB, indexB) => {\n                        if (indexA <= indexB) {\n                            return\n                        }\n                        distancers.push(this.tensegrity.createFaceDistancer(faceA, faceB, pullScale))\n                    })\n                })\n                return distancers\n            default:\n                return []\n        }\n    }\n\n    private createBrickOnFace(face: IFace, scale: IPercent): IBrick {\n        const negativeFace = TRIANGLE_DEFINITIONS[face.triangle].negative\n        const brick = face.brick\n        const triangle = face.triangle\n        const trianglePoints = brick.faces[triangle].joints.map(joint => joint.location())\n        const midpoint = trianglePoints.reduce((mid: Vector3, p: Vector3) => mid.add(p), new Vector3()).multiplyScalar(1.0 / 3.0)\n        const midSide = new Vector3().addVectors(trianglePoints[0], trianglePoints[1]).multiplyScalar(0.5)\n        const x = new Vector3().subVectors(midSide, midpoint).normalize()\n        const u = new Vector3().subVectors(trianglePoints[1], midpoint).normalize()\n        const proj = new Vector3().add(x).multiplyScalar(x.dot(u))\n        const z = u.sub(proj).normalize()\n        const y = new Vector3().crossVectors(z, x).normalize().multiplyScalar(0.2)\n        const xform = new Matrix4().makeBasis(x, y, z).setPosition(midpoint)\n        const base = negativeFace ? Triangle.NNN : Triangle.PPP\n        const points = createBrickPointsAt(base, scale, new Vector3(0, 0, 0)) // todo: maybe raise it\n        const movedToFace = points.map(p => p.applyMatrix4(xform))\n        const baseTriangle = negativeFace ? Triangle.PPP : Triangle.NNN\n        return this.createBrick(movedToFace, baseTriangle, scale)\n    }\n\n    private createBrick(points: Vector3[], base: Triangle, scale: IPercent): IBrick {\n        const countdown = this.tensegrity.numericFeature(FabricFeature.IntervalCountdown)\n        const brick = initialBrick(this.tensegrity.bricks.length, base, scale)\n        this.tensegrity.bricks.push(brick)\n        const jointIndexes = points.map((p, idx) => this.tensegrity.createLeftJoint(p))\n        this.tensegrity.instance.refreshFloatView()\n        PUSH_ARRAY.forEach(({}: IPushDefinition, idx: number) => {\n            const alphaIndex = jointIndexes[idx * 2]\n            const omegaIndex = jointIndexes[idx * 2 + 1]\n            const alpha: IJoint = {\n                index: alphaIndex,\n                oppositeIndex: omegaIndex,\n                location: () => this.tensegrity.instance.jointLocation(alphaIndex),\n            }\n            const omega: IJoint = {\n                index: omegaIndex,\n                oppositeIndex: alphaIndex,\n                location: () => this.tensegrity.instance.jointLocation(omegaIndex),\n            }\n            brick.pushes.push(this.tensegrity.createInterval(alpha, omega, IntervalRole.NexusPush, scale, countdown))\n        })\n        brick.pushes.forEach(push => brick.joints.push(push.alpha, push.omega))\n        const joints = brick.pushes.reduce((arr: IJoint[], push) => {\n            arr.push(push.alpha, push.omega)\n            return arr\n        }, [])\n        this.tensegrity.joints.push(...joints)\n        TRIANGLE_DEFINITIONS.forEach(triangle => {\n            const tJoints = triangle.pushEnds.map(end => joints[end])\n            for (let walk = 0; walk < 3; walk++) {\n                const alpha = tJoints[walk]\n                const omega = tJoints[(walk + 1) % 3]\n                const interval = this.tensegrity.createInterval(alpha, omega, IntervalRole.Triangle, scale, countdown)\n                brick.pulls.push(interval)\n                brick.rings[triangle.ringMember[walk]].push(interval)\n            }\n        })\n        TRIANGLE_DEFINITIONS.forEach(triangle => {\n            const face = this.tensegrity.createFace(brick, triangle.name)\n            brick.faces.push(face)\n        })\n        this.tensegrity.instance.refreshFloatView()\n        return brick\n    }\n\n    private facesToRing(faceA: IFace, faceB: IFace): IJoint[] {\n        if (faceA.negative === faceB.negative) {\n            throw new Error(\"Polarity not opposite\")\n        }\n        const dirA = new Vector3().subVectors(faceA.joints[0].location(), faceA.location()).normalize()\n        const oppositeJoint = faceB.joints.map((joint, index) => [\n            new Vector3().subVectors(joint.location(), faceB.location()).normalize().dot(dirA), index,\n        ]).sort((a, b) => b[0] - a[0]).pop()\n        if (!oppositeJoint) {\n            throw new Error(\"No opposite joint\")\n        }\n        const permutation: number[] = [[1, 0, 2], [2, 1, 0], [0, 2, 1]][oppositeJoint[1]]\n        return [\n            faceA.joints[0], faceB.joints[permutation[0]],\n            faceA.joints[1], faceB.joints[permutation[1]],\n            faceA.joints[2], faceB.joints[permutation[2]],\n        ]\n    }\n\n    private connectFaces(faceA: IFace, faceB: IFace, connectorScale: IPercent, countdown: number): void {\n        if (faceA.negative === faceB.negative) {\n            throw new Error(\"Same polarity!\")\n        }\n        [faceA, faceB].forEach((face: IFace): void => {\n            this.tensegrity.removeFace(face, true)\n            if (!face.negative) {\n                face.brick.negativeAdjacent++\n            } else {\n                face.brick.postiveAdjacent++\n            }\n        })\n        const ring = this.facesToRing(faceA, faceB)\n        const createInterval = (from: IJoint, to: IJoint, role: IntervalRole) => this.tensegrity.createInterval(from, to, role, connectorScale, countdown)\n        for (let corner = 0; corner < ring.length; corner++) {\n            const prev = ring[(corner + 5) % 6]\n            const curr = ring[corner]\n            const next = ring[(corner + 1) % 6]\n            createInterval(curr, next, IntervalRole.Ring)\n            const crossInterval = (from: IJoint, opposite: IJoint) => {\n                const to = this.tensegrity.joints[opposite.oppositeIndex]\n                const toBrick = brickContaining(to, faceA.brick, faceB.brick)\n                toBrick.crosses.push(createInterval(from, to, IntervalRole.ColumnCross))\n            }\n            if (faceA.negative) {\n                crossInterval(prev, curr)\n            } else {\n                crossInterval(next, curr)\n            }\n        }\n        [faceA, faceB].forEach(({triangle, brick}: IFace): void => {\n            const adjustRole = (intervals: IInterval[], role: IntervalRole) => intervals\n                .filter(interval => !interval.removed && interval.intervalRole !== role)\n                .forEach(interval => this.tensegrity.changeIntervalRole(interval, role, brick.scale, countdown))\n            if (isNexus(brick)) {\n                adjustRole(brick.pulls, IntervalRole.Triangle)\n                adjustRole(brick.crosses, IntervalRole.NexusCross)\n                adjustRole(brick.pushes, IntervalRole.NexusPush)\n            } else {\n                adjustRole(brick.rings[TRIANGLE_DEFINITIONS[triangle].ring], IntervalRole.Ring)\n                adjustRole(brick.crosses, IntervalRole.ColumnCross)\n                adjustRole(brick.pushes, IntervalRole.ColumnPush)\n            }\n        })\n        this.tensegrity.instance.refreshFloatView()\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Tensegrity } from \"./tensegrity\"\nimport { TensegrityBuilder } from \"./tensegrity-builder\"\nimport {\n    IBrick,\n    IFaceMark,\n    IPercent,\n    oppositeTriangle,\n    percentOrHundred,\n    Triangle,\n    TRIANGLE_DIRECTIONS,\n    TRIANGLES,\n} from \"./tensegrity-types\"\n\nconst BOOTSTRAP_TENSCRIPTS = [\n    \"'Zen':(0)\",\n    \"'One':(1)\",\n    \"'Six':(6)\",\n    \"'Axoneme':(16,S90)\",\n    \"'Knee':(b1,a1)\",\n    \"'Leg':(b3,a3)\",\n    \"'Nexus':(a1,b1,c1,d1)\",\n    \"'Tripod with Knees':(A2,B(3,b(2,S90),S80),C(3,c(2,S90),S80),D(3,d(2,S90),S80))\",\n    \"'Bulge Ring':(A(8, S85, MA1), a(8, S85, MA1))\",\n    \"'Convergence Three':(a1,b(3,S85,MA1),c(3,S85,MA1),d(3,S85,MA1))\",\n    \"'Convergence Ten':(a1,b(10,S85,MA1),c(10,S85,MA1),d(10,S85,MA1))\",\n    \"'Halo by Crane':(B(7,S80,MA1),C(2,S120,MA0),D(7,S80,MA1))\",\n    \"'Pretenst Lander':(B(5,S75),C(5,S75),D(5,S75))\",\n    \"'Zig Zag Loop':(a(1,MA0),c(3,b(3,d(3,c(3,b(3,d(1,MA0)))))))\",\n    \"'Crystal Interstitial':(B2, C2, D2, A(2, b2, c2, d2))\",\n    \"'Diamond':(a(2,b(2,c(2,d(1,MA1)),d(2,c(1,MA0))),c(2,d(2,b(1,MA3)),b(2,d(1,MA2))),d(2,b(2,c(1,MA5)),c(2,b(1,MA4)))),b(2,d(2,Mc3),c(2,Md4)),c(2,b(2,Md5),d(2,Mb0)),d(2,c(2,Mb1),b(2,Mc2)))\",\n    \"'Composed':(3,b(2,MA0),c(2,MA0),d(2,MA0)):0=subtree(b2,c2,d2)\",\n    \"'Galapagotchi1':(A(3,S90,Mb0),b(3,S90,Mb0),a(2,S90,Md0),B(2,Md0,S90)):0=face-distance-60\",\n    \"'Galapagotchi2':(A(2,c(2,MA0)),b(2,c(2,MA0)),a(2,d(2,MA0)),B(2,d(2,MA0))):0=face-distance-115\",\n    \"'Galapagotchi3':(A(5,S80,Mb0),b(5,S80,Mb0),a(3,S70,Md0),B(3,Md0,S70)):0=face-distance-60\",\n    \"'Thick Tripod':(A1,B(3,MA1),C(3,MA1),D(3,MA1)):1=face-distance-35\",\n]\n\nexport interface ITenscriptTree {\n    _?: number, // forward steps\n    S?: IPercent, // scale\n    A?: ITenscriptTree, // directions: up\n    b?: ITenscriptTree, // kinda up\n    c?: ITenscriptTree,\n    d?: ITenscriptTree,\n    B?: ITenscriptTree, // kinda down\n    C?: ITenscriptTree,\n    D?: ITenscriptTree,\n    a?: ITenscriptTree, // down\n    MA?: IFaceMark, // marks: reference\n    MB?: IFaceMark,\n    MC?: IFaceMark,\n    MD?: IFaceMark,\n    Ma?: IFaceMark,\n    Mb?: IFaceMark,\n    Mc?: IFaceMark,\n    Md?: IFaceMark,\n}\n\nexport enum MarkAction {\n    Subtree,\n    BaseFace,\n    JoinFaces,\n    FaceDistance,\n}\n\nexport interface IMark {\n    action: MarkAction\n    tree?: ITenscriptTree\n    scale?: IPercent\n}\n\nexport interface ITenscript {\n    name: string\n    code: string\n    tree: ITenscriptTree\n    marks: Record<number, IMark>\n    fromUrl: boolean\n}\n\nfunction treeToCode(tree: ITenscriptTree): string {\n    const replacer = (s: string, ...args: object[]) => `${args[0]}${args[1]}`\n    return JSON.stringify(tree)\n        .replace(/[_.:\"]/g, \"\")\n        .replace(/[{]/g, \"(\")\n        .replace(/[}]/g, \")\")\n        .replace(/([ABCDabcdSM])\\((\\d*)\\)/g, replacer)\n}\n\nexport function treeToTenscript(name: string, mainTree: ITenscriptTree, marks: Record<number, IMark>, fromUrl: boolean): ITenscript {\n    const mainCode = treeToCode(mainTree)\n    const markSections: string[] = []\n    Object.keys(marks).forEach(key => {\n        const mark: IMark = marks[key]\n        switch (mark.action) {\n            case MarkAction.Subtree:\n                const tree = mark.tree\n                if (!tree) {\n                    throw new Error(\"Missing tree\")\n                }\n                markSections.push(`${key}=${treeToCode(tree)}`)\n                break\n            case MarkAction.BaseFace:\n                break\n            case MarkAction.JoinFaces:\n                break\n            case MarkAction.FaceDistance:\n                const scale = mark.scale\n                if (!scale) {\n                    throw new Error(\"Missing scale\")\n                }\n                markSections.push(`${key}=face-distance-${scale._}`)\n                break\n        }\n    })\n    const subtreesCode = markSections.length > 0 ? `:${markSections.join(\":\")}` : \"\"\n    return {name, tree: mainTree, marks, code: `'${name}':${mainCode}${subtreesCode}`, fromUrl}\n}\n\nfunction isDirection(char: string): boolean {\n    return TRIANGLE_DIRECTIONS.indexOf(char) >= 0\n}\n\nfunction childTree(triangle: Triangle, tree: ITenscriptTree): ITenscriptTree | undefined {\n    return tree[TRIANGLE_DIRECTIONS[triangle]]\n}\n\nfunction faceMark(triangle: Triangle, tree: ITenscriptTree): IFaceMark | undefined {\n    return tree[`M${TRIANGLE_DIRECTIONS[triangle]}`]\n}\n\nfunction deleteFaceMark(triangle: Triangle, tree: ITenscriptTree): void {\n    tree[`M${TRIANGLE_DIRECTIONS[triangle]}`] = undefined\n}\n\nfunction isDigit(char: string): boolean {\n    return \"0123456789\".indexOf(char) >= 0\n}\n\nfunction toNumber(digits: string): number {\n    if (!digits.match(/^\\d+$/)) {\n        throw new Error(`Not a number: ${digits}`)\n    }\n    return parseInt(digits, 10)\n}\n\nfunction parseCode(code: string): { name: string, mainCode: string, markCode: Record<number, string> } {\n    const parts = code.replace(/[\\n\\r\\t]/g, \"\").split(\":\")\n    const foundName = parts.find(part => part.startsWith(\"'\") && part.endsWith(\"'\"))\n    const foundMain = parts.find(part => part.startsWith(\"(\") && part.endsWith(\")\"))\n    const markCode: Record<number, string> = {}\n    parts.filter(part => part.match(/^\\d+=.*$/)).forEach(part => {\n        const eq = part.indexOf(\"=\")\n        const mark = Number(part.substring(0, eq))\n        markCode[mark] = part.substring(eq + 1)\n    })\n    return {\n        name: foundName ? foundName.replace(/'/g, \"\") : new Date().toDateString(),\n        mainCode: foundMain || \"(0)\",\n        markCode,\n    }\n}\n\nfunction matchBracket(s: string): number {\n    if (s.charAt(0) !== \"(\") {\n        throw new Error(`Code must start with \"(\": ${s} ${s.charAt(0)}`)\n    }\n    let depth = 0\n    for (let index = 0; index < s.length; index++) {\n        const char = s.charAt(index)\n        if (char === \"(\") {\n            depth++\n        } else if (char === \")\") {\n            depth--\n            if (depth === 0) {\n                return index\n            }\n        }\n    }\n    throw new Error(`No matching end bracket: |${s}|`)\n}\n\nfunction argument(maybeBracketed: string, stripBrackets: boolean): { content: string, skip: number } {\n    const commaPos = maybeBracketed.indexOf(\",\")\n    const commaPresent = commaPos >= 0\n    if (maybeBracketed.charAt(0) !== \"(\") {\n        if (commaPresent) {\n            return {content: maybeBracketed.substring(0, commaPos), skip: commaPos}\n        }\n        return {content: maybeBracketed, skip: maybeBracketed.length}\n    }\n    const finalBracket = matchBracket(maybeBracketed)\n    const content = stripBrackets ? maybeBracketed.substring(1, finalBracket) : maybeBracketed.substring(0, finalBracket + 1)\n    return {content, skip: finalBracket + 1}\n}\n\nexport function codeToTenscript(error: (message: string) => void, fromUrl: boolean, code?: string): ITenscript | undefined {\n\n    function fragmentToTree(codeFragment: string): ITenscriptTree | undefined {\n        const initialCode = argument(codeFragment, true)\n        const codeString = initialCode.content\n        const tree: ITenscriptTree = {}\n\n        function subtree(index: number): { codeTree?: ITenscriptTree, skip: number } {\n            const {content, skip} = argument(codeString.substring(index), false)\n            const codeTree = fragmentToTree(content)\n            return {codeTree, skip}\n        }\n\n        for (let index = 0; index < codeString.length; index++) {\n            const char = codeString.charAt(index)\n            if (isDirection(char)) {\n                const direction = subtree(index + 1)\n                if (!direction.codeTree) {\n                    throw new Error(`No subtree: ${codeString.substring(index)}`)\n                }\n                tree[char] = direction.codeTree\n                index += direction.skip\n            } else if (isDigit(char)) {\n                const forward = argument(codeString, false)\n                tree._ = toNumber(forward.content)\n                index += forward.skip\n            } else {\n                switch (char) {\n                    case \"S\":\n                        const scaleArg = argument(codeString.substring(index + 1), true)\n                        tree.S = {_: toNumber(scaleArg.content)}\n                        index += scaleArg.skip\n                        break\n                    case \"M\":\n                        const directionChar = codeString.charAt(index + 1)\n                        const markNumber = argument(codeString.substring(index + 2), true)\n                        tree[`M${directionChar}`] = {_: toNumber(markNumber.content)}\n                        index += markNumber.skip + 1\n                        break\n                    case \",\":\n                    case \" \":\n                        break\n                    default:\n                        throw new Error(`Unexpected character: ${char}`)\n                }\n            }\n        }\n        return Object.keys(tree).length === 0 ? undefined : tree\n    }\n\n    try {\n        if (!code || code.length === 0) {\n            error(\"No code to parse\")\n            return undefined\n        }\n        const {name, mainCode, markCode} = parseCode(code)\n        const tree = fragmentToTree(mainCode)\n        if (!tree) {\n            return undefined\n        }\n        const marks: Record<number, IMark> = {}\n        Object.keys(markCode).forEach(key => {\n            const c: string = markCode[key]\n            if (c.startsWith(\"subtree\")) {\n                const subtree = fragmentToTree(c.substring(\"subtree\".length))\n                marks[key] = <IMark>{action: MarkAction.Subtree, tree: subtree}\n            } else if (c.startsWith(\"base-face\")) {\n                marks[key] = <IMark>{action: MarkAction.BaseFace}\n            } else if (c.startsWith(\"join-faces\")) {\n                marks[key] = <IMark>{action: MarkAction.JoinFaces}\n            } else if (c.startsWith(\"face-distance-\")) {\n                const scale: IPercent = {_: parseInt(c.split(\"-\")[2], 10)}\n                marks[key] = <IMark>{action: MarkAction.FaceDistance, scale}\n            } else {\n                throw new Error(`Unrecognized mark code: [${c}]`)\n            }\n        })\n        return treeToTenscript(name, tree, marks, fromUrl)\n    } catch (e) {\n        error(e.message)\n        return undefined\n    }\n}\n\nfunction noParseErrors(message: string): void {\n    throw new Error(`Unable to parse: ${message}`)\n}\n\nexport const BOOTSTRAP = BOOTSTRAP_TENSCRIPTS.map(script => codeToTenscript(noParseErrors, false, script)) as ITenscript[]\n\nexport interface IActiveTenscript {\n    tree: ITenscriptTree\n    brick: IBrick\n    tensegrity: Tensegrity\n}\n\nexport function execute(before: IActiveTenscript[], marks: Record<number, IMark>): IActiveTenscript[] {\n    const active: IActiveTenscript[] = []\n\n    before.forEach(({brick, tree, tensegrity}) => {\n\n        function markBrick(brickToMark: IBrick, treeWithMarks: ITenscriptTree): void {\n            TRIANGLES.forEach(triangle => {\n                const mark = faceMark(triangle, treeWithMarks)\n                if (!mark) {\n                    return\n                }\n                const brickFace = brickToMark.base === Triangle.NNN ? brickToMark.faces[triangle] : brickToMark.faces[oppositeTriangle(triangle)]\n                if (brickFace.removed) {\n                    throw new Error(\"!! trying to use a face that was removed\")\n                }\n                brickFace.mark = mark\n            })\n        }\n\n        function grow(previous: IBrick, newTree: ITenscriptTree, triangle: Triangle, treeScale: IPercent): IActiveTenscript {\n            const connectTriangle = previous.base === Triangle.PPP ? oppositeTriangle(triangle) : triangle\n            const newBrick = new TensegrityBuilder(tensegrity).createConnectedBrick(previous, connectTriangle, treeScale)\n            if (newTree._ === 0) {\n                markBrick(newBrick, newTree)\n            }\n            return {tree: newTree, brick: newBrick, tensegrity}\n        }\n\n        const forward = tree._\n        if (forward) {\n            const _ = forward - 1\n            active.push(grow(brick, {...tree, _}, Triangle.PPP, percentOrHundred(tree.S)))\n            return\n        }\n\n        TRIANGLES.forEach(triangle => {\n            const subtree = childTree(triangle, tree)\n            const triangleMark = faceMark(triangle, tree)\n            if (subtree) {\n                const _ = subtree._ ? subtree._ - 1 : undefined\n                const decremented = {...subtree, _}\n                active.push(grow(brick, decremented, triangle, percentOrHundred(subtree.S)))\n            } else if (triangleMark) {\n                const mark = marks[triangleMark._]\n                if (mark && mark.action === MarkAction.Subtree) {\n                    const markTree = mark.tree\n                    if (!markTree) {\n                        throw new Error(\"Missing subtree\")\n                    }\n                    deleteFaceMark(triangle, tree)\n                    active.push(grow(brick, markTree, triangle, percentOrHundred(markTree.S)))\n                }\n            }\n        })\n    })\n    return active\n}\n\nexport function getCodeFromUrl(): ITenscript | undefined {\n    const urlCode = location.hash.substring(1)\n    try {\n        return codeToTenscript(message => console.error(message), true, decodeURIComponent(urlCode))\n    } catch (e) {\n        console.error(\"Code error\", e)\n    }\n    return undefined\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole, SurfaceCharacter } from \"eig\"\n\nimport { FABRIC_FEATURES } from \"../fabric/eig-util\"\nimport { IFeatureConfig } from \"../fabric/fabric-features\"\nimport { codeToTenscript, ITenscript } from \"../fabric/tenscript\"\n\nexport enum ControlTab {\n    Grow = \"Grow\",\n    Shape = \"Shape\",\n    Realize = \"Realize\",\n    View = \"View\",\n    Strain = \"Strain\",\n}\n\nconst VERSION = \"2020-03-12\"\n\nexport interface IFeatureValue {\n    numeric: number\n    percent: number\n}\n\nexport interface IStoredState {\n    version: string\n    nonce: number\n    surfaceCharacter: SurfaceCharacter\n    featureValues: Record<FabricFeature, IFeatureValue>\n    recentCode: Record<string, string>\n    controlTab: ControlTab\n    fullScreen: boolean\n    ellipsoids: boolean\n    rotating: boolean\n    showPushes: boolean\n    showPulls: boolean\n}\n\nexport function addRecentCode(state: IStoredState, {code, name}: ITenscript): IStoredState {\n    const recentCode = {...state.recentCode}\n    recentCode[name] = code\n    return transition(state, {recentCode})\n}\n\nexport function getRecentTenscript(state: IStoredState): ITenscript[] {\n    return Object.keys(state.recentCode).map(key => {\n        const code = state.recentCode[key]\n        const tenscript = codeToTenscript(error => console.error(error), false, code)\n        if (!tenscript) {\n            throw new Error(`Unable to read recent tenscript code: ${code}`)\n        }\n        return tenscript\n    })\n}\n\nexport function roleLengthFeature(intervalRole: IntervalRole): FabricFeature {\n    switch (intervalRole) {\n        case IntervalRole.NexusPush:\n            return FabricFeature.NexusPushLength\n        case IntervalRole.ColumnPush:\n            return FabricFeature.ColumnPushLength\n        case IntervalRole.Triangle:\n            return FabricFeature.TriangleLength\n        case IntervalRole.Ring:\n            return FabricFeature.RingLength\n        case IntervalRole.NexusCross:\n            return FabricFeature.NexusCrossLength\n        case IntervalRole.ColumnCross:\n            return FabricFeature.ColumnCrossLength\n        case IntervalRole.BowMid:\n            return FabricFeature.BowMidLength\n        case IntervalRole.BowEnd:\n            return FabricFeature.BowEndLength\n        default:\n            throw new Error(\"role?\")\n    }\n}\n\nexport function roleDefaultFromFeatures(featureValues: Record<FabricFeature, IFeatureValue>, intervalRole: IntervalRole): number {\n    if (intervalRole === IntervalRole.FaceConnector || intervalRole === IntervalRole.FaceDistancer) {\n        throw new Error()\n    }\n    return featureValues[roleLengthFeature(intervalRole)].numeric\n}\n\nexport function transition(state: IStoredState, partial: Partial<IStoredState>): IStoredState {\n    return {...state, nonce: state.nonce + 1, ...partial}\n}\n\nfunction initialStoredState(toConfig: (feature: FabricFeature) => IFeatureConfig, defaultValue: (feature: FabricFeature) => number): IStoredState {\n    const DEFAULT_FEATURE_VALUES = FABRIC_FEATURES.map(toConfig)\n        .reduce((record, config) => {\n            record[config.feature] = ({percent: 100, numeric: defaultValue(config.feature)})\n            return record\n        }, {} as Record<FabricFeature, IFeatureValue>)\n\n    return ({\n        version: VERSION,\n        nonce: 0,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        featureValues: DEFAULT_FEATURE_VALUES,\n        recentCode: {},\n        controlTab: ControlTab.Grow,\n        fullScreen: true,\n        ellipsoids: false,\n        rotating: false,\n        showPushes: true,\n        showPulls: true,\n    })\n}\n\nconst STORED_STATE_KEY = \"State\"\n\nexport function saveState(storedState: IStoredState): void {\n    localStorage.setItem(STORED_STATE_KEY, JSON.stringify(storedState))\n}\n\nexport function loadState(toConfig: (feature: FabricFeature) => IFeatureConfig, defaultValue: (feature: FabricFeature) => number): IStoredState {\n    const item = localStorage.getItem(STORED_STATE_KEY)\n    if (item) {\n        const storedState = JSON.parse(item) as IStoredState\n        if (storedState.version === VERSION) {\n            return storedState\n        }\n    }\n    return initialStoredState(toConfig, defaultValue)\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n * something extra so it can compile\n */\n\nimport { FabricFeature } from \"eig\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { IFeatureValue, IStoredState, transition } from \"../storage/stored-state\"\n\nimport { FABRIC_FEATURES } from \"./eig-util\"\n\nexport interface IFeatureConfig {\n    feature: FabricFeature\n    name: string\n    percents: number[]\n}\n\nexport function featureConfig(feature: FabricFeature): IFeatureConfig {\n    switch (feature) {\n        case FabricFeature.Gravity:\n            return {\n                feature,\n                name: \"Gravity\",\n                percents: [0, 10, 50, 100, 200, 500],\n            }\n        case FabricFeature.Drag:\n            return {\n                feature,\n                name: \"Drag\",\n                percents: [0, 10, 50, 100, 150, 200],\n            }\n        case FabricFeature.PretenstFactor:\n            return {\n                feature,\n                name: \"Pretenst factor\",\n                percents: [0, 50, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.IterationsPerFrame:\n            return {\n                feature,\n                name: \"Iterations per frame\",\n                percents: [10, 25, 50, 100, 200, 300, 500],\n            }\n        case FabricFeature.IntervalCountdown:\n            return {\n                feature,\n                name: \"Interval Countdown\",\n                percents: [10, 20, 30, 100, 150, 400, 1000],\n            }\n        case FabricFeature.RealizingCountdown:\n            return {\n                feature,\n                name: \"Slack to Pretenst countdown\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.SlackThreshold:\n            return {\n                feature,\n                name: \"Slack threshold\",\n                percents: [0.01, 0.1, 1, 10, 100, 1000],\n            }\n        case FabricFeature.ShapingPretenstFactor:\n            return {\n                feature,\n                name: \"Pretenst factor\",\n                percents: [0, 1, 2, 3, 5, 10, 20, 50, 100],\n            }\n        case FabricFeature.ShapingStiffnessFactor:\n            return {\n                feature,\n                name: \"Stiffness factor\",\n                percents: [100, 150, 200, 250, 300, 400, 500],\n            }\n        case FabricFeature.ShapingDrag:\n            return {\n                feature,\n                name: \"Drag\",\n                percents: [0, 10, 50, 100, 200, 500],\n            }\n        case FabricFeature.MaxStrain:\n            return {\n                feature,\n                name: \"Maximum Strain\",\n                percents: [1, 2, 3, 5, 8, 13, 21, 34, 55, 100],\n            }\n        case FabricFeature.VisualStrain:\n            return {\n                feature,\n                name: \"Visual Strain\",\n                percents: [0, 10, 50, 100, 200, 300, 500, 1000, 2000, 3000],\n            }\n        case FabricFeature.PushOverPull:\n            return {\n                feature,\n                name: \"Compression/Tension\",\n                percents: [10, 20, 30, 50, 100, 200, 300, 500, 1000],\n            }\n        case FabricFeature.NexusPushLength:\n            return {\n                feature,\n                name: \"Nexus Push\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.ColumnPushLength:\n            return {\n                feature,\n                name: \"Column Push\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.TriangleLength:\n            return {\n                feature,\n                name: \"Triangle\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.RingLength:\n            return {\n                feature,\n                name: \"Ring\",\n                percents: [10, 80, 90, 100, 110, 120, 130],\n            }\n        case FabricFeature.NexusCrossLength:\n            return {\n                feature,\n                name: \"Nexus Cross\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.ColumnCrossLength:\n            return {\n                feature,\n                name: \"Column Cross\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.BowMidLength:\n            return {\n                feature,\n                name: \"Bow Mid\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.BowEndLength:\n            return {\n                feature,\n                name: \"Bow End\",\n                percents: [50, 75, 90, 100, 125, 150, 200],\n            }\n        case FabricFeature.PushRadius:\n            return {\n                feature,\n                name: \"Push Radius\",\n                percents: [5, 25, 50, 100, 150, 200, 300],\n            }\n        case FabricFeature.PullRadius:\n            return {\n                feature,\n                name: \"Pull Radius\",\n                percents: [5, 25, 50, 100, 150, 200, 300],\n            }\n        case FabricFeature.JointRadius:\n            return {\n                feature,\n                name: \"Joint Radius\",\n                percents: [5, 25, 50, 100, 150, 200, 300],\n            }\n        case FabricFeature.MaxStiffness:\n            return {\n                feature,\n                name: \"Maximum Stiffness\",\n                percents: [5, 25, 50, 100, 150, 200, 500],\n            }\n        default:\n            throw new Error(\"Feature?\")\n    }\n}\n\nexport class FloatFeature {\n    private value$: BehaviorSubject<IFeatureValue>\n\n    constructor(public readonly config: IFeatureConfig, private defaultValue: number, storedState$: BehaviorSubject<IStoredState>) {\n        const features = storedState$.getValue().featureValues\n        const fromConfig = features[config.feature]\n        const initialValue: IFeatureValue = fromConfig !== undefined ? fromConfig : {\n            numeric: this.defaultValue,\n            percent: 100,\n        }\n        this.value$ = new BehaviorSubject<IFeatureValue>(initialValue)\n        this.value$.subscribe(value => {\n            const storedState = storedState$.getValue()\n            const featureValues = {...storedState.featureValues} as Record<FabricFeature, IFeatureValue>\n            featureValues[config.feature] = value\n            storedState$.next(transition(storedState, {featureValues}))\n        })\n    }\n\n    public get value(): IFeatureValue {\n        return this.value$.getValue()\n    }\n\n    public get title(): string {\n        return this.config.name\n    }\n\n    public get percentChoices(): number[] {\n        return this.config.percents\n    }\n\n    public get numeric(): number {\n        return this.value$.getValue().numeric\n    }\n\n    public get formatted(): string {\n        const numeric = this.numeric\n        const expo = numeric.toExponential(5)\n        const zero = expo.indexOf(\"e+0\")\n        if (zero > 0) {\n            return expo.substring(0, zero)\n        }\n        const minus = Math.max(expo.indexOf(\"e-1\"), expo.indexOf(\"e-2\"))\n        if (minus > 0) {\n            return numeric.toFixed(5)\n        }\n        const plus = Math.max(expo.indexOf(\"e+1\"), expo.indexOf(\"e+2\"))\n        if (plus > 0) {\n            return numeric.toFixed(1)\n        }\n        return expo\n    }\n\n    public get percent(): number {\n        return this.value$.getValue().percent\n    }\n\n    public set percent(percent: number) {\n        this.value$.next({numeric: this.defaultValue * percent / 100, percent})\n    }\n\n    public get observable(): BehaviorSubject<IFeatureValue> {\n        return this.value$\n    }\n\n    public get fabricFeature(): FabricFeature {\n        return this.config.feature\n    }\n}\n\nexport function createFloatFeatures(storedState$: BehaviorSubject<IStoredState>, defaultValue: (feature: FabricFeature) => number):\n    Record<FabricFeature, FloatFeature> {\n    const features = {} as Record<FabricFeature, FloatFeature>\n    FABRIC_FEATURES.map(featureConfig).forEach(config => {\n        features[config.feature] = new FloatFeature(config, defaultValue(config.feature), storedState$)\n    })\n    return features\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\n// tslint:disable:no-console\n// In production, we register a service worker to serve assets from local cache.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on the 'N+1' visit to a page, since previously\n// cached resources are updated in the background.\n\n// To learn more about the benefits of this model, read https://goo.gl/KwvDNy.\n// This link also includes instructions on opting out of this behavior.\n\nconst isLocalhost = Boolean(\n    window.location.hostname === \"localhost\" ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === \"[::1]\" ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n        /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/,\n    ),\n)\n\nexport default function register(): void {\n    if (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n        // The URL constructor is available in all browsers that support SW.\n        const publicUrl = new URL(\n            process.env.PUBLIC_URL!,\n            window.location.toString(),\n        )\n        if (publicUrl.origin !== window.location.origin) {\n            // Our service worker won't work if PUBLIC_URL is on a different origin\n            // from what our page is served on. This might happen if a CDN is used to\n            // serve assets; see https://github.com/facebookincubator/create-react-app/issues/2374\n            return\n        }\n\n        window.addEventListener(\"load\", () => {\n            const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`\n\n            if (isLocalhost) {\n                // This is running on localhost. Lets check if a service worker still exists or not.\n                checkValidServiceWorker(swUrl)\n\n                // Add some additional logging to localhost, pointing developers to the\n                // service worker/PWA documentation.\n                navigator.serviceWorker.ready.then(() => {\n                    console.log(\n                        \"This web app is being served cache-first by a service \" +\n                        \"worker. To learn more, visit https://goo.gl/SC7cgQ\",\n                    )\n                })\n            } else {\n                // Is not local host. Just register service worker\n                registerValidSW(swUrl)\n            }\n        })\n    }\n}\n\nfunction registerValidSW(swUrl: string): void {\n    navigator.serviceWorker\n        .register(swUrl)\n        .then(registration => {\n            registration.onupdatefound = () => {\n                const installingWorker = registration.installing\n                if (installingWorker) {\n                    installingWorker.onstatechange = () => {\n                        if (installingWorker.state === \"installed\") {\n                            if (navigator.serviceWorker.controller) {\n                                // At this point, the old content will have been purged and\n                                // the fresh content will have been added to the cache.\n                                // It's the perfect time to display a 'New content is\n                                // available; please refresh.' message in your web app.\n                                console.log(\"New content is available; please refresh.\")\n                            } else {\n                                // At this point, everything has been precached.\n                                // It's the perfect time to display a\n                                // 'Content is cached for offline use.' message.\n                                console.log(\"Content is cached for offline use.\")\n                            }\n                        }\n                    }\n                }\n            }\n        })\n        .catch(error => {\n            console.error(\"Error during service worker registration:\", error)\n        })\n}\n\nfunction checkValidServiceWorker(swUrl: string): void {\n    // Check if the service worker can be found. If it can't reload the page.\n    fetch(swUrl)\n        .then(response => {\n            // Ensure service worker exists, and that we really are getting a JS file.\n            if (\n                response.status === 404 ||\n                response.headers.get(\"content-type\")!.indexOf(\"javascript\") === -1\n            ) {\n                // No service worker found. Probably a different app. Reload the page.\n                navigator.serviceWorker.ready.then(registration => {\n                    registration.unregister().then(() => {\n                        window.location.reload()\n                    })\n                })\n            } else {\n                // Service worker found. Proceed as normal.\n                registerValidSW(swUrl)\n            }\n        })\n        .catch(() => {\n            console.log(\n                \"No internet connection found. App is running in offline mode.\",\n            )\n        })\n}\n\nexport function unregister(): void {\n    if (\"serviceWorker\" in navigator) {\n        navigator.serviceWorker.ready.then(registration => {\n            registration.unregister()\n        })\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Fabric, Stage, View, World } from \"eig\"\nimport { Matrix4, Vector3 } from \"three\"\n\nimport { FloatFeature } from \"./fabric-features\"\n\nconst vectorFromArray = (array: Float32Array, index: number, vector?: Vector3): Vector3 => {\n    const offset = index * 3\n    if (vector) {\n        vector.set(array[offset], array[offset + 1], array[offset + 2])\n        return vector\n    } else {\n        return new Vector3(array[offset], array[offset + 1], array[offset + 2])\n    }\n}\n\nexport interface IFloatView {\n    lineColors: Float32Array\n    lineLocations: Float32Array\n    faceNormals: Float32Array\n    faceLocations: Float32Array\n    jointLocations: Float32Array\n    jointVelocities: Float32Array\n    unitVectors: Float32Array\n    idealLengths: Float32Array\n    strains: Float32Array\n    strainNuances: Float32Array\n    stiffnesses: Float32Array\n    linearDensities: Float32Array\n}\n\nfunction createFloatView(fabric: Fabric, view: View): IFloatView {\n    return {\n        lineColors: floatArray(\n            array => view.copy_line_colors_to(array),\n            () => fabric.get_interval_count() * 3 * 2,\n        ),\n        lineLocations: floatArray(\n            array => view.copy_line_locations_to(array),\n            () => fabric.get_interval_count() * 3 * 2,\n        ),\n        faceNormals: floatArray(\n            array => view.copy_face_normals_to(array),\n            () => fabric.get_face_count() * 3 * 3,\n        ),\n        faceLocations: floatArray(\n            array => view.copy_face_vertex_locations_to(array),\n            () => fabric.get_face_count() * 3 * 3,\n        ),\n        jointLocations: floatArray(\n            array => view.copy_joint_locations_to(array),\n            () => fabric.get_joint_count() * 3,\n        ),\n        jointVelocities: floatArray(\n            array => view.copy_joint_velocities_to(array),\n            () => fabric.get_joint_count() * 3,\n        ),\n        unitVectors: floatArray(\n            array => view.copy_unit_vectors_to(array),\n            () => fabric.get_interval_count() * 3,\n        ),\n        idealLengths: floatArray(\n            array => view.copy_ideal_lengths_to(array),\n            () => fabric.get_interval_count(),\n        ),\n        strains: floatArray(\n            array => view.copy_strains_to(array),\n            () => fabric.get_interval_count(),\n        ),\n        strainNuances: floatArray(\n            array => view.copy_strain_nuances_to(array),\n            () => fabric.get_interval_count(),\n        ),\n        stiffnesses: floatArray(\n            array => view.copy_stiffnesses_to(array),\n            () => fabric.get_interval_count(),\n        ),\n        linearDensities: floatArray(\n            array => view.copy_linear_densities_to(array),\n            () => fabric.get_interval_count(),\n        ),\n    }\n}\n\nfunction floatArray(copyFunction: (array: Float32Array) => void, length: () => number): Float32Array {\n    const array = new Float32Array(length())\n    copyFunction(array)\n    return array\n}\n\nexport class FabricInstance {\n    public fabric: Fabric\n    public world: World\n    public view: View\n    public floatView: IFloatView\n\n    private featuresToApply: FloatFeature[] = []\n\n    constructor(eig: typeof import(\"eig\"), jointCount: number) {\n        this.world = eig.World.new()\n        this.fabric = eig.Fabric.new(jointCount)\n        this.view = eig.View.on_fabric(this.fabric)\n        this.floatView = createFloatView(this.fabric, this.view)\n    }\n\n    public iterate(requestedStage: Stage): Stage {\n        const stage = this.fabric.iterate(requestedStage, this.world)\n        this.view.render(this.fabric, this.world)\n        if (this.featuresToApply.length > 0) {\n            this.featuresToApply.forEach(feature => this.world.set_float_value(feature.fabricFeature, feature.numeric))\n            this.featuresToApply = []\n        }\n        this.floatView = createFloatView(this.fabric, this.view)\n        return stage\n    }\n\n    public refreshFloatView(): void {\n        this.view.render(this.fabric, this.world)\n        this.floatView = createFloatView(this.fabric, this.view)\n    }\n\n    public clear(): void {\n        this.fabric.clear()\n        this.refreshFloatView()\n    }\n\n    public applyFeature(feature: FloatFeature): void {\n        this.featuresToApply.push(feature)\n    }\n\n    public jointLocation(jointIndex: number): Vector3 {\n        return vectorFromArray(this.floatView.jointLocations, jointIndex)\n    }\n\n    public apply(matrix: Matrix4): void {\n        this.fabric.apply_matrix4(new Float32Array(matrix.toArray()))\n    }\n\n    public unitVector(intervalIndex: number): Vector3 {\n        return vectorFromArray(this.floatView.unitVectors, intervalIndex)\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole } from \"eig\"\nimport { Vector3 } from \"three\"\n\nimport { Tensegrity } from \"./tensegrity\"\nimport { IInterval, IJoint, IPercent } from \"./tensegrity-types\"\n\nexport class TensegrityOptimizer {\n\n    constructor(private tensegrity: Tensegrity) {\n    }\n\n    public replaceCrossedNexusCrosses(countdown: number): void {\n        const tensegrity = this.tensegrity\n        const pairs: IPair[] = []\n        const findPush = (jointIndex: number): IPush => {\n            const interval = tensegrity.intervals\n                .filter(i => i.isPush)\n                .find(i => i.alpha.index === jointIndex || i.omega.index === jointIndex)\n            if (!interval) {\n                throw new Error(`Cannot find ${jointIndex}`)\n            }\n            const joint: IJoint = interval.alpha.index === jointIndex ? interval.alpha : interval.omega\n            return {interval, joint}\n        }\n        const crosses = tensegrity.intervals.filter(interval => interval.intervalRole === IntervalRole.NexusCross)\n        crosses.forEach((intervalA, indexA) => {\n            const aAlpha = intervalA.alpha.index\n            const aOmega = intervalA.omega.index\n            const aAlphaPush = findPush(aAlpha)\n            const aOmegaPush = findPush(aOmega)\n            const aAlphaLoc = intervalA.alpha.location()\n            const aOmegaLoc = intervalA.omega.location()\n            const aLength = aAlphaLoc.distanceTo(aOmegaLoc)\n            const aMid = new Vector3().addVectors(aAlphaLoc, aOmegaLoc).multiplyScalar(0.5)\n            crosses.forEach((intervalB, indexB) => {\n                const bAlpha = intervalB.alpha.index\n                const bOmega = intervalB.omega.index\n                if (indexA >= indexB || aAlpha === bAlpha || aAlpha === bOmega || aOmega === bAlpha || aOmega === bOmega) {\n                    return\n                }\n                const bAlphaPush = findPush(bAlpha)\n                const bOmegaPush = findPush(bOmega)\n                let push: IInterval | undefined\n                let a: IJoint | undefined\n                let x: IJoint | undefined\n                let b: IJoint | undefined\n                let y: IJoint | undefined\n                const samePush = (pushA: IPush, pushB: IPush) => pushA.interval.index === pushB.interval.index\n                if (samePush(aAlphaPush, bAlphaPush)) {\n                    push = aAlphaPush.interval\n                    a = intervalA.alpha\n                    x = intervalA.omega\n                    b = intervalB.alpha\n                    y = intervalB.omega\n                } else if (samePush(aAlphaPush, bOmegaPush)) {\n                    push = aAlphaPush.interval\n                    a = intervalA.alpha\n                    x = intervalA.omega\n                    b = intervalB.omega\n                    y = intervalB.alpha\n                } else if (samePush(aOmegaPush, bAlphaPush)) {\n                    push = aOmegaPush.interval\n                    a = intervalA.omega\n                    x = intervalA.alpha\n                    b = intervalB.alpha\n                    y = intervalB.omega\n                } else if (samePush(aOmegaPush, bOmegaPush)) {\n                    push = aOmegaPush.interval\n                    a = intervalA.omega\n                    x = intervalA.alpha\n                    b = intervalB.omega\n                    y = intervalB.alpha\n                } else {\n                    return\n                }\n                const bAlphaLoc = intervalB.alpha.location()\n                const bOmegaLoc = intervalB.omega.location()\n                const bLength = bAlphaLoc.distanceTo(bOmegaLoc)\n                const bMid = new Vector3().addVectors(bAlphaLoc, bOmegaLoc).multiplyScalar(0.5)\n                const aAlphaMidB = aAlphaLoc.distanceTo(bMid) / bLength\n                const aOmegaMidB = aOmegaLoc.distanceTo(bMid) / bLength\n                const bAlphaMidA = bAlphaLoc.distanceTo(aMid) / aLength\n                const bOmegaMidA = bOmegaLoc.distanceTo(aMid) / aLength\n                let closeCount = 0\n                const close = (dist: number) => {\n                    if (dist < 0.5) {\n                        closeCount++\n                    }\n                }\n                close(aAlphaMidB)\n                close(aOmegaMidB)\n                close(bAlphaMidA)\n                close(bOmegaMidA)\n                if (closeCount < 2) {\n                    return\n                }\n                const scale = push.scale\n                pairs.push({scale, a, x, b, y})\n            })\n        })\n        pairs.forEach(({scale, a, x, b, y}: IPair) => {\n            tensegrity.createInterval(x, y, IntervalRole.BowMid, scale, countdown)\n            const ax = tensegrity.findInterval(a, x)\n            const ay = tensegrity.findInterval(a, y)\n            const bx = tensegrity.findInterval(b, x)\n            const by = tensegrity.findInterval(b, y)\n            if (!(ax && bx && ay && by)) {\n                console.log(\"Cannot find intervals during optimize\")\n                return\n            }\n            tensegrity.removeInterval(ax)\n            tensegrity.removeInterval(by)\n            this.tensegrity.changeIntervalRole(ay, IntervalRole.BowEnd, scale, countdown)\n            this.tensegrity.changeIntervalRole(bx, IntervalRole.BowEnd, scale, countdown)\n        })\n    }\n\n    public stiffnessesFromStrains(): void {\n        const pushOverPull = this.tensegrity.numericFeature(FabricFeature.PushOverPull)\n        const newStiffnesses = adjustedStiffness(this.tensegrity, pushOverPull)\n        this.tensegrity.restore()\n        this.tensegrity.instance.fabric.copy_stiffnesses(newStiffnesses)\n    }\n}\n\nfunction adjustedStiffness(tensegrity: Tensegrity, pushOverPull: number): Float32Array {\n    const strains: Float32Array = tensegrity.instance.floatView.strains\n    const getAverageStrain = (toAverage: IInterval[]) => {\n        const totalStrain = toAverage.reduce((sum, interval) => sum + strains[interval.index], 0)\n        return totalStrain / toAverage.length\n    }\n    const intervals = tensegrity.intervals\n    const pushes = intervals.filter(interval => interval.isPush)\n    const averagePushStrain = getAverageStrain(pushes)\n    const pulls = intervals.filter(interval => !interval.isPush)\n    const averagePullStrain = getAverageStrain(pulls)\n    const averageAbsoluteStrain = (-pushOverPull * averagePushStrain + averagePullStrain) / 2\n    const changes = intervals.map(interval => {\n        const absoluteStrain = strains[interval.index] * (interval.isPush ? -pushOverPull : 1)\n        const normalizedStrain = absoluteStrain - averageAbsoluteStrain\n        const strainFactor = normalizedStrain / averageAbsoluteStrain\n        return 1 + strainFactor\n    })\n    return tensegrity.instance.floatView.stiffnesses.map((value, index) => value * changes[index])\n}\n\ninterface IPair {\n    scale: IPercent\n    a: IJoint\n    x: IJoint\n    b: IJoint\n    y: IJoint\n}\n\ninterface IPush {\n    interval: IInterval\n    joint: IJoint\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, Stage } from \"eig\"\n\nimport { Tensegrity } from \"./tensegrity\"\nimport { TensegrityOptimizer } from \"./tensegrity-optimizer\"\n\nexport interface ITransitionPrefs {\n    strainToStiffness?: boolean\n    adoptLengths?: boolean\n}\n\nexport class Life {\n    private _stage: Stage\n\n    constructor(private numericFeature: (fabricFeature: FabricFeature) => number, private tensegrity: Tensegrity, stage: Stage) {\n        this._stage = stage\n    }\n\n    public withStage(stage: Stage, prefs?: ITransitionPrefs): Life {\n        this.transition(stage, prefs)\n        this._stage = stage\n        return new Life(this.numericFeature, this.tensegrity, stage)\n    }\n\n    public get stage(): Stage {\n        return this._stage\n    }\n\n    private transition(stage: Stage, prefs?: ITransitionPrefs): void {\n        switch (this._stage) {\n            case Stage.Growing:\n                switch (stage) {\n                    case Stage.Shaping:\n                        this.tensegrity.save()\n                        return\n                }\n                break\n            case Stage.Shaping:\n                switch (stage) {\n                    case Stage.Slack:\n                        if (prefs && prefs.adoptLengths) {\n                            this.tensegrity.instance.fabric.adopt_lengths()\n                            const faceIntervals = [...this.tensegrity.faceIntervals]\n                            faceIntervals.forEach(interval => this.tensegrity.removeFaceInterval(interval))\n                            this.tensegrity.save()\n                        }\n                        return\n                    case Stage.Realizing:\n                        return\n                }\n                break\n            case Stage.Slack:\n                switch (stage) {\n                    case Stage.Shaping:\n                        return\n                    case Stage.Realizing:\n                        return\n                }\n                break\n            case Stage.Realizing:\n                switch (stage) {\n                    case Stage.Realized:\n                        return\n                }\n                break\n            case Stage.Realized:\n                switch (stage) {\n                    case Stage.Slack:\n                        if (prefs) {\n                            if (prefs.strainToStiffness) {\n                                new TensegrityOptimizer(this.tensegrity).stiffnessesFromStrains()\n                                return\n                            } else if (prefs.adoptLengths) {\n                                this.tensegrity.instance.fabric.adopt_lengths()\n                                this.tensegrity.save()\n                                return\n                            }\n                        }\n                }\n                break\n        }\n        throw new Error(`No transition ${Stage[this._stage]} to ${Stage[stage]}`)\n    }\n}\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Fabric, FabricFeature, IntervalRole, Stage } from \"eig\"\nimport { BehaviorSubject } from \"rxjs\"\nimport { BufferGeometry, Float32BufferAttribute, Vector3 } from \"three\"\n\nimport { IFabricOutput, IOutputInterval, IOutputJoint } from \"../storage/download\"\nimport { IStoredState } from \"../storage/stored-state\"\n\nimport { intervalRoleName, isPushInterval } from \"./eig-util\"\nimport { FabricInstance } from \"./fabric-instance\"\nimport { ITransitionPrefs, Life } from \"./life\"\nimport { execute, IActiveTenscript, IMark, ITenscript, MarkAction } from \"./tenscript\"\nimport { scaleToFaceConnectorLength, TensegrityBuilder } from \"./tensegrity-builder\"\nimport { TensegrityOptimizer } from \"./tensegrity-optimizer\"\nimport {\n    factorToPercent,\n    gatherJointCables,\n    IBrick,\n    IFace,\n    IFaceInterval,\n    IInterval,\n    IJoint,\n    IPercent,\n    percentOrHundred,\n    percentToFactor,\n    Triangle,\n    TRIANGLE_DEFINITIONS,\n} from \"./tensegrity-types\"\n\nconst COUNTDOWN_MAX = 65535\n\nfunction faceConnectorCountdown(distance: number): number {\n    const countdown = distance * 6000\n    return countdown > COUNTDOWN_MAX ? COUNTDOWN_MAX : countdown\n}\n\nfunction scaleToStiffness(scale: IPercent): number {\n    return percentToFactor(scale) / 10000\n}\n\nexport class Tensegrity {\n    public life$: BehaviorSubject<Life>\n    public joints: IJoint[] = []\n    public intervals: IInterval[] = []\n    public faceIntervals: IFaceInterval[] = []\n    public faces: IFace[] = []\n    public bricks: IBrick[] = []\n    public activeTenscript?: IActiveTenscript[]\n\n    private backup?: Fabric\n\n    constructor(\n        public readonly roleDefaultLength: (intervalRole: IntervalRole) => number,\n        public readonly numericFeature: (fabricFeature: FabricFeature) => number,\n        public readonly instance: FabricInstance,\n        public readonly tenscript: ITenscript,\n    ) {\n        this.instance.clear()\n        this.life$ = new BehaviorSubject(new Life(numericFeature, this, Stage.Growing))\n        const brick = new TensegrityBuilder(this).createBrickAt(new Vector3(), percentOrHundred())\n        this.bricks = [brick]\n        this.activeTenscript = [{tree: this.tenscript.tree, brick, tensegrity: this}]\n    }\n\n    public get life(): Life {\n        return this.life$.getValue()\n    }\n\n    public save(): void {\n        this.backup = this.instance.fabric.copy()\n    }\n\n    public restore(): void {\n        if (!this.backup) {\n            throw new Error(\"No backup\")\n        }\n        this.instance.fabric.restore(this.backup)\n    }\n\n    public toStage(stage: Stage, prefs?: ITransitionPrefs): void {\n        if (stage === this.life.stage) {\n            return\n        }\n        this.life$.next(this.life.withStage(stage, prefs))\n    }\n\n    public createLeftJoint(location: Vector3): number {\n        return this.instance.fabric.create_joint(location.x, location.y, location.z)\n    }\n\n    public createFaceConnector(alpha: IFace, omega: IFace): IFaceInterval {\n        return this.createFaceInterval(alpha, omega)\n    }\n\n    public createFaceDistancer(alpha: IFace, omega: IFace, pullScale: IPercent): IFaceInterval {\n        return this.createFaceInterval(alpha, omega, pullScale)\n    }\n\n    public removeFaceInterval(interval: IFaceInterval): void {\n        this.faceIntervals = this.faceIntervals.filter(existing => existing.index !== interval.index)\n        this.instance.fabric.remove_interval(interval.index)\n        this.faceIntervals.forEach(existing => {\n            if (existing.index > interval.index) {\n                existing.index--\n            }\n        })\n        this.intervals.forEach(existing => {\n            if (existing.index > interval.index) {\n                existing.index--\n            }\n        })\n        interval.removed = true\n    }\n\n    public createInterval(alpha: IJoint, omega: IJoint, intervalRole: IntervalRole, scale: IPercent, coundown: number): IInterval {\n        const idealLength = alpha.location().distanceTo(omega.location())\n        const scaleFactor = percentToFactor(scale)\n        const defaultLength = this.roleDefaultLength(intervalRole)\n        const restLength = scaleFactor * defaultLength\n        const stiffness = scaleToStiffness(scale)\n        const index = this.instance.fabric.create_interval(\n            alpha.index, omega.index, intervalRole,\n            idealLength, restLength, stiffness, coundown)\n        const interval: IInterval = {\n            index,\n            intervalRole,\n            scale,\n            alpha,\n            omega,\n            removed: false,\n            isPush: isPushInterval(intervalRole),\n            location: () => new Vector3().addVectors(alpha.location(), omega.location()).multiplyScalar(0.5),\n        }\n        this.intervals.push(interval)\n        return interval\n    }\n\n    public changeIntervalScale(interval: IInterval, factor: number): void {\n        interval.scale = factorToPercent(percentToFactor(interval.scale) * factor)\n        this.instance.fabric.multiply_rest_length(interval.index, factor, 100)\n    }\n\n    public changeIntervalRole(interval: IInterval, intervalRole: IntervalRole, scaleFactor: IPercent, countdown: number): void {\n        interval.intervalRole = intervalRole\n        this.instance.fabric.set_interval_role(interval.index, intervalRole)\n        this.instance.fabric.change_rest_length(interval.index, percentToFactor(scaleFactor) * this.roleDefaultLength(intervalRole), countdown)\n    }\n\n    public removeInterval(interval: IInterval): void {\n        this.intervals = this.intervals.filter(existing => existing.index !== interval.index)\n        this.instance.fabric.remove_interval(interval.index)\n        this.intervals.forEach(existing => {\n            if (existing.index > interval.index) {\n                existing.index--\n            }\n        })\n        this.faceIntervals.forEach(existing => {\n            if (existing.index > interval.index) {\n                existing.index--\n            }\n        })\n        interval.removed = true\n    }\n\n    public createFace(brick: IBrick, triangle: Triangle): IFace {\n        const {negative, pushEnds} = TRIANGLE_DEFINITIONS[triangle]\n        const pushes = pushEnds.map(end => {\n            const foundPush = brick.pushes.find(push => {\n                const endJoint = brick.joints[end]\n                return endJoint.index === push.alpha.index || endJoint.index === push.omega.index\n            })\n            if (foundPush === undefined) {\n                throw new Error()\n            }\n            return foundPush\n        })\n        const pulls = [0, 1, 2].map(offset => brick.pulls[triangle * 3 + offset])\n        const joints = pushEnds.map(end => brick.joints[end])\n        const index = this.instance.fabric.create_face(joints[0].index, joints[1].index, joints[2].index)\n        const face: IFace = {\n            index, negative, removed: false,\n            brick, triangle, joints, pushes, pulls,\n            location: () =>\n                joints.reduce((sum, joint) => sum.add(joint.location()), new Vector3())\n                    .multiplyScalar(1.0 / 3.0),\n        }\n        this.faces.push(face)\n        return face\n    }\n\n    public removeFace(face: IFace, removeIntervals: boolean): void {\n        this.instance.fabric.remove_face(face.index)\n        this.faces = this.faces.filter(existing => existing.index !== face.index)\n        this.faces.forEach(existing => {\n            if (existing.index > face.index) {\n                existing.index--\n            }\n        })\n        this.faceIntervals.forEach(existing => {\n            if (existing.alpha.index > face.index) {\n                existing.alpha.index--\n            }\n            if (existing.omega.index > face.index) {\n                existing.omega.index--\n            }\n        })\n        face.removed = true\n        if (removeIntervals) {\n            face.pulls.forEach(interval => this.removeInterval(interval))\n        }\n    }\n\n    public get submergedJoints(): IJoint[] {\n        return this.joints.filter(joint => joint.location().y < 0)\n    }\n\n    public get facesGeometry(): BufferGeometry {\n        const faceLocations = new Float32BufferAttribute(this.instance.floatView.faceLocations, 3)\n        const faceNormals = new Float32BufferAttribute(this.instance.floatView.faceNormals, 3)\n        const geometry = new BufferGeometry()\n        geometry.addAttribute(\"position\", faceLocations)\n        geometry.addAttribute(\"normal\", faceNormals)\n        geometry.computeBoundingSphere()\n        return geometry\n    }\n\n    public get linesGeometry(): BufferGeometry {\n        const lineLocations = new Float32BufferAttribute(this.instance.floatView.lineLocations, 3)\n        const lineColors = new Float32BufferAttribute(this.instance.floatView.lineColors, 3)\n        const geometry = new BufferGeometry()\n        geometry.addAttribute(\"position\", lineLocations)\n        geometry.addAttribute(\"color\", lineColors)\n        geometry.computeBoundingSphere()\n        return geometry\n    }\n\n    public startTightening(intervals: IFaceInterval[]): void {\n        this.faceIntervals = intervals\n    }\n\n    public iterate(): Stage {\n        const lifePhase = this.instance.iterate(this.life$.getValue().stage)\n        if (lifePhase === Stage.Busy) {\n            return lifePhase\n        }\n        const activeCode = this.activeTenscript\n        const builder = () => new TensegrityBuilder(this)\n        if (activeCode) {\n            if (activeCode.length > 0) {\n                this.activeTenscript = execute(activeCode, this.tenscript.marks)\n                this.instance.fabric.centralize()\n            }\n            if (activeCode.length === 0) {\n                this.activeTenscript = undefined\n                faceStrategies(this.faces, this.tenscript.marks, builder()).forEach(strategy => strategy.execute())\n                if (lifePhase === Stage.Growing) {\n                    new TensegrityOptimizer(this).replaceCrossedNexusCrosses(1000)\n                    return this.instance.fabric.finish_growing()\n                }\n            }\n            return Stage.Growing\n        }\n        if (this.faceIntervals.length > 0) {\n            this.faceIntervals = builder().checkFaceIntervals(this.faceIntervals, interval => this.removeFaceInterval(interval))\n        }\n        return lifePhase\n    }\n\n    public findInterval(joint1: IJoint, joint2: IJoint): IInterval | undefined {\n        return this.intervals.find(interval => (\n            (interval.alpha.index === joint1.index && interval.omega.index === joint2.index) ||\n            (interval.alpha.index === joint2.index && interval.omega.index === joint1.index)\n        ))\n    }\n\n    public getFabricOutput(storedState: IStoredState): IFabricOutput {\n        const idealLengths = this.instance.floatView.idealLengths\n        const strains = this.instance.floatView.strains\n        const stiffnesses = this.instance.floatView.stiffnesses\n        const linearDensities = this.instance.floatView.linearDensities\n        return {\n            name: this.tenscript.name,\n            joints: this.joints.map(joint => {\n                const vector = joint.location()\n                return <IOutputJoint>{\n                    index: joint.index,\n                    x: vector.x, y: vector.z, z: vector.y,\n                    jointCables: gatherJointCables(joint, this.intervals),\n                }\n            }),\n            intervals: this.intervals.map(interval => {\n                const radiusFeature = storedState.featureValues[interval.isPush ? FabricFeature.PushRadius : FabricFeature.PullRadius]\n                const radius = radiusFeature.numeric * linearDensities[interval.index]\n                const jointRadius = radius * storedState.featureValues[FabricFeature.JointRadius].numeric\n                const currentLength = interval.alpha.location().distanceTo(interval.omega.location())\n                const length = currentLength + (interval.isPush ? -jointRadius * 2 : jointRadius * 2)\n                return <IOutputInterval>{\n                    index: interval.index,\n                    joints: [interval.alpha.index, interval.omega.index],\n                    type: interval.isPush ? \"Push\" : \"Pull\",\n                    strain: strains[interval.index],\n                    stiffness: stiffnesses[interval.index],\n                    linearDensity: linearDensities[interval.index],\n                    role: intervalRoleName(interval.intervalRole),\n                    idealLength: idealLengths[interval.index],\n                    isPush: interval.isPush,\n                    length, radius, jointRadius,\n                }\n            }),\n        }\n    }\n\n    private createFaceInterval(alpha: IFace, omega: IFace, pullScale?: IPercent): IFaceInterval {\n        const connector = !pullScale\n        const intervalRole = connector ? IntervalRole.FaceConnector : IntervalRole.FaceDistancer\n        const idealLength = alpha.location().distanceTo(omega.location())\n        const stiffness = scaleToStiffness(percentOrHundred())\n        const scaleFactor = (percentToFactor(alpha.brick.scale) + percentToFactor(omega.brick.scale)) / 2\n        const restLength = !pullScale ? scaleToFaceConnectorLength(scaleFactor) : percentToFactor(pullScale) * idealLength\n        const index = this.instance.fabric.create_interval(\n            alpha.index, omega.index, intervalRole,\n            idealLength, restLength, stiffness, faceConnectorCountdown(idealLength),\n        )\n        const interval: IFaceInterval = {index, alpha, omega, connector, scaleFactor, removed: false}\n        this.faceIntervals.push(interval)\n        return interval\n    }\n\n\n}\n\nfunction faceStrategies(faces: IFace[], marks: Record<number, IMark>, builder: TensegrityBuilder): FaceStrategy[] {\n    const collated: Record<number, IFace[]> = {}\n    faces.forEach(face => {\n        if (face.mark === undefined) {\n            return\n        }\n        const found = collated[face.mark._]\n        if (found) {\n            found.push(face)\n        } else {\n            collated[face.mark._] = [face]\n        }\n    })\n    return Object.entries(collated).map(([key, value]) => {\n        const possibleMark = marks[key]\n        const mark = possibleMark ? possibleMark :\n            value.length === 1 ?\n                <IMark>{action: MarkAction.BaseFace} :\n                <IMark>{action: MarkAction.JoinFaces}\n        return new FaceStrategy(collated[key], mark, builder)\n    })\n}\n\nclass FaceStrategy {\n    constructor(private faces: IFace[], private mark: IMark, private builder: TensegrityBuilder) {\n    }\n\n    public execute(): void {\n        switch (this.mark.action) {\n            case MarkAction.Subtree:\n                break\n            case MarkAction.BaseFace:\n                this.builder.faceToOrigin(this.faces[0])\n                break\n            case MarkAction.JoinFaces:\n            case MarkAction.FaceDistance:\n                this.builder.createFaceIntervals(this.faces, this.mark)\n                break\n        }\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport {\n    FaArrowRight,\n    FaBaby,\n    FaCamera,\n    FaChartBar,\n    FaClock,\n    FaHandSpock,\n    FaList,\n    FaSeedling,\n    FaTools,\n    FaYinYang,\n} from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\n\nexport enum StageTransition {\n    CaptureLengthsToSlack,\n    CurrentLengthsToSlack,\n    SlackToRealizing,\n    SlackToShaping,\n    CaptureRealizedToSlack,\n    CaptureStrainForStiffness,\n}\n\nexport function LifeStageButton({tensegrity, stageTransition, disabled}: {\n    tensegrity: Tensegrity,\n    stageTransition: StageTransition,\n    disabled: boolean,\n}): JSX.Element {\n\n    const [life, updateLife] = useState(tensegrity.life)\n    useEffect(() => {\n        const sub = tensegrity.life$.subscribe(updateLife)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    function allDisabledExcept(stageAccepted: Stage): boolean {\n        if (disabled || life.stage === Stage.Busy || life.stage === Stage.Realizing) {\n            return true\n        }\n        return life.stage !== stageAccepted\n    }\n\n    switch (stageTransition) {\n        case StageTransition.CaptureLengthsToSlack:\n            return (\n                <Button\n                    className=\"my-1 w-100\"\n                    disabled={allDisabledExcept(Stage.Shaping)}\n                    onClick={() => tensegrity.toStage(Stage.Slack, {adoptLengths: true})}\n                >\n                    Capture Lengths <FaCamera/> (\n                    <Symbol stage={Stage.Shaping}/> ) <FaArrowRight/> ( <FaBaby/><Symbol stage={Stage.Slack}/> )\n                    New Slack\n                </Button>\n            )\n        case StageTransition.CurrentLengthsToSlack:\n            return (\n                <Button\n                    className=\"my-1 w-100\"\n                    disabled={allDisabledExcept(Stage.Shaping)}\n                    onClick={() => tensegrity.toStage(Stage.Slack)}\n                >\n                    Current Lengths <Symbol stage={Stage.Shaping}/> <FaArrowRight/>\n                    <Symbol stage={Stage.Slack}/> Slack\n                </Button>\n            )\n        case StageTransition.SlackToRealizing:\n            return (\n                <Button\n                    className=\"my-1 w-100\"\n                    disabled={allDisabledExcept(Stage.Slack)}\n                    onClick={() => tensegrity.toStage(Stage.Realizing)}\n                >\n                    Slack <Symbol stage={Stage.Slack}/> <FaArrowRight/> <Symbol stage={Stage.Realized}/> Realized\n                </Button>\n            )\n        case StageTransition.SlackToShaping:\n            return (\n                <ButtonGroup vertical={true} className=\"w-100 my-1\">\n                    <Button\n                        className=\"my-1 w-100\"\n                        disabled={allDisabledExcept(Stage.Slack)}\n                        onClick={() => tensegrity.toStage(Stage.Shaping)}\n                    >\n                        Slack <Symbol stage={Stage.Slack}/> <FaArrowRight/> <Symbol stage={Stage.Shaping}/> Shaping\n                    </Button>\n                </ButtonGroup>\n            )\n        case StageTransition.CaptureRealizedToSlack:\n            return (\n                <Button\n                    className=\"my-1 w-100\"\n                    disabled={allDisabledExcept(Stage.Realized)}\n                    onClick={() => tensegrity.toStage(Stage.Slack, {adoptLengths: true})}\n                >\n                    Capture realized <FaCamera/> ( <Symbol stage={Stage.Realized}/> ) <FaArrowRight/> ( <FaBaby/>\n                    <Symbol stage={Stage.Slack}/> ) New Slack\n                </Button>\n            )\n        case StageTransition.CaptureStrainForStiffness:\n            return (\n                <Button\n                    className=\"my-1 w-100\"\n                    disabled={allDisabledExcept(Stage.Realized)}\n                    onClick={() => tensegrity.toStage(Stage.Slack, {strainToStiffness: true})}\n                >\n                    Capture Strain <FaCamera/> ( <Symbol stage={Stage.Realized}/> <FaList/> ) <FaArrowRight/>\n                    ( <Symbol stage={Stage.Slack}/> <FaChartBar/> ) Slack Stiffness\n                </Button>\n            )\n    }\n}\n\nfunction Symbol({stage}: { stage: Stage }): JSX.Element {\n    switch (stage) {\n        case Stage.Busy:\n            return <FaClock/>\n        case Stage.Growing:\n            return <FaSeedling/>\n        case Stage.Shaping:\n            return <FaTools/>\n        case Stage.Slack:\n            return <FaYinYang/>\n        case Stage.Realizing:\n            return <FaClock/>\n        case Stage.Realized:\n            return <FaHandSpock/>\n        default:\n            throw new Error(\"Stage?\")\n    }\n}\n\n// function stageName(stage: Stage): string {\n//     switch (stage) {\n//         case Stage.Busy:\n//             return \"Busy\"\n//         case Stage.Growing:\n//             return \"Growing\"\n//         case Stage.Shaping:\n//             return \"Shaping\"\n//         case Stage.Slack:\n//             return \"Slack\"\n//         case Stage.Realizing:\n//             return \"Realizing\"\n//         case Stage.Realized:\n//             return \"Realized\"\n//     }\n// }\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport {\n    FaArrowAltCircleRight,\n    FaArrowDown,\n    FaArrowUp,\n    FaCheck,\n    FaCompass,\n    FaDragon,\n    FaHandPointUp,\n    FaLink,\n    FaList,\n    FaTimesCircle,\n    FaTools,\n} from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { ADJUSTABLE_INTERVAL_ROLES, intervalRoleName } from \"../fabric/eig-util\"\nimport { FloatFeature } from \"../fabric/fabric-features\"\nimport { MarkAction } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { TensegrityBuilder } from \"../fabric/tensegrity-builder\"\nimport { IFace, IInterval } from \"../fabric/tensegrity-types\"\nimport { IStoredState, roleLengthFeature } from \"../storage/stored-state\"\n\nimport { Grouping } from \"./control-tabs\"\nimport { FeaturePanel } from \"./feature-panel\"\nimport { LifeStageButton, StageTransition } from \"./life-stage-button\"\n\nexport enum ShapeSelection {\n    None,\n    Faces,\n    Intervals,\n}\n\nexport function ShapeTab(\n    {\n        floatFeatures, tensegrity, selectedIntervals,\n        setFabric, shapeSelection, setShapeSelection,\n        selectedFaces, clearSelectedFaces, storedState$,\n    }: {\n        floatFeatures: Record<FabricFeature, FloatFeature>,\n        tensegrity: Tensegrity,\n        setFabric: (tensegrity: Tensegrity) => void,\n        selectedIntervals: IInterval[],\n        shapeSelection: ShapeSelection,\n        setShapeSelection: (shapeSelection: ShapeSelection) => void,\n        selectedFaces: IFace[],\n        clearSelectedFaces: () => void,\n        storedState$: BehaviorSubject<IStoredState>,\n    }): JSX.Element {\n\n    const [pushAndPull, setPushAndPull] = useState(false)\n    useEffect(() => {\n        tensegrity.instance.world.set_push_and_pull(pushAndPull)\n    }, [pushAndPull])\n\n    const [ellipsoids, updateEllipsoids] = useState(storedState$.getValue().ellipsoids)\n    useEffect(() => {\n        const subscriptions = [\n            storedState$.subscribe(newState => updateEllipsoids(newState.ellipsoids)),\n        ]\n        return () => subscriptions.forEach(sub => sub.unsubscribe())\n    }, [])\n\n    const [life, updateLife] = useState(tensegrity.life)\n    useEffect(() => {\n        const sub = tensegrity.life$.subscribe(updateLife)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    const [lengthFeature, setLengthFeature] = useState(floatFeatures[FabricFeature.NexusPushLength])\n\n    const adjustValue = (up: boolean, pushes: boolean, pulls: boolean) => () => {\n        function adjustment(): number {\n            const factor = 1.03\n            return up ? factor : (1 / factor)\n        }\n\n        if (!selectedIntervals) {\n            return\n        }\n        selectedIntervals.forEach(interval => {\n            if (interval.isPush && !pushes || !interval.isPush && !pulls) {\n                return\n            }\n            tensegrity.changeIntervalScale(interval, adjustment())\n        })\n    }\n\n    function connect(): void {\n        const pulls = new TensegrityBuilder(tensegrity).createFaceIntervals(selectedFaces, {action: MarkAction.JoinFaces})\n        tensegrity.faceIntervals.push(...pulls)\n        clearSelectedFaces()\n        setShapeSelection(ShapeSelection.None)\n        setFabric(tensegrity)\n    }\n\n    function disabled(): boolean {\n        return ellipsoids || life.stage !== Stage.Shaping\n    }\n\n    function disableUnlessFaceCount(faceCount: number, mode: ShapeSelection): boolean {\n        if (disabled() || shapeSelection !== mode) {\n            return true\n        }\n        return selectedFaces.length < faceCount || ellipsoids\n    }\n\n    function disabledLifeStage(): boolean {\n        return ellipsoids || shapeSelection !== ShapeSelection.None\n    }\n\n    return (\n        <div>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaArrowAltCircleRight/> Phase</h6>\n                <LifeStageButton\n                    tensegrity={tensegrity}\n                    stageTransition={StageTransition.CaptureLengthsToSlack}\n                    disabled={disabledLifeStage()}\n                />\n                <LifeStageButton\n                    tensegrity={tensegrity}\n                    stageTransition={StageTransition.CurrentLengthsToSlack}\n                    disabled={disabledLifeStage()}\n                />\n                <LifeStageButton\n                    tensegrity={tensegrity}\n                    stageTransition={StageTransition.SlackToShaping}\n                    disabled={disabledLifeStage()}\n                />\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaHandPointUp/> Manual</h6>\n                <ButtonGroup size=\"sm\" className=\"w-100 my-2\">\n                    <Button\n                        color={shapeSelection === ShapeSelection.Intervals ? \"warning\" : \"secondary\"}\n                        disabled={ellipsoids && shapeSelection === ShapeSelection.None || selectedFaces.length === 0}\n                        onClick={() => {\n                            const selection = shapeSelection === ShapeSelection.Intervals ? ShapeSelection.None : ShapeSelection.Intervals\n                            setShapeSelection(selection)\n                        }}\n                    >\n                        <span><FaArrowDown/> Adjust <FaArrowUp/></span>\n                    </Button>\n                    <Button disabled={disableUnlessFaceCount(1, ShapeSelection.Intervals)}\n                            onClick={adjustValue(true, true, true)}>\n                        TC <FaArrowUp/>\n                    </Button>\n                    <Button disabled={disableUnlessFaceCount(1, ShapeSelection.Intervals)}\n                            onClick={adjustValue(false, true, true)}>\n                        TC <FaArrowDown/>\n                    </Button>\n                    <Button disabled={disableUnlessFaceCount(1, ShapeSelection.Intervals)}\n                            onClick={adjustValue(true, false, true)}>\n                        T<FaArrowUp/>\n                    </Button>\n                    <Button disabled={disableUnlessFaceCount(1, ShapeSelection.Intervals)}\n                            onClick={adjustValue(false, false, true)}>\n                        T <FaArrowDown/>\n                    </Button>\n                    <Button disabled={disableUnlessFaceCount(1, ShapeSelection.Intervals)}\n                            onClick={adjustValue(true, true, false)}>\n                        C <FaArrowUp/>\n                    </Button>\n                    <Button disabled={disableUnlessFaceCount(1, ShapeSelection.Intervals)}\n                            onClick={adjustValue(false, true, false)}>\n                        C <FaArrowDown/>\n                    </Button>\n                </ButtonGroup>\n                <ButtonGroup size=\"sm\" className=\"w-100 my-2\">\n                    <Button\n                        disabled={selectedFaces.length === 0 || disabled() && shapeSelection !== ShapeSelection.None}\n                        onClick={() => clearSelectedFaces()}\n                    >\n                        <FaTimesCircle/> Clear selection\n                    </Button>\n                    <Button\n                        disabled={disableUnlessFaceCount(1, ShapeSelection.Faces)}\n                        onClick={() => {\n                            new TensegrityBuilder(tensegrity).faceToOrigin(selectedFaces[0])\n                            tensegrity.instance.refreshFloatView()\n                            clearSelectedFaces()\n                        }}>\n                        <FaCompass/><span> Upright</span>\n                    </Button>\n                    <Button\n                        disabled={disableUnlessFaceCount(2, ShapeSelection.Faces)}\n                        onClick={connect}>\n                        <FaLink/><span> Connect</span>\n                    </Button>\n                </ButtonGroup>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaTools/> Adjustments</h6>\n                <FeaturePanel feature={floatFeatures[FabricFeature.ShapingPretenstFactor]} disabled={disabled()}/>\n                <FeaturePanel feature={floatFeatures[FabricFeature.ShapingDrag]} disabled={disabled()}/>\n                <FeaturePanel feature={floatFeatures[FabricFeature.ShapingStiffnessFactor]} disabled={disabled()}/>\n                <ButtonGroup size=\"sm\" className=\"w-100 my-2\">\n                    <Button\n                        disabled={disabled()}\n                        color={pushAndPull ? \"secondary\" : \"success\"}\n                        onClick={() => setPushAndPull(false)}\n                    ><FaCheck/>: T or C</Button>\n                    <Button\n                        disabled={disabled()}\n                        color={pushAndPull ? \"success\" : \"secondary\"}\n                        onClick={() => setPushAndPull(true)}\n                    ><FaDragon/>: T=C</Button>\n                </ButtonGroup>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaList/> Default Lengths</h6>\n                <FeaturePanel key={lengthFeature.title} feature={lengthFeature} disabled={disabled()}/>\n                <ButtonGroup className=\"my-2 w-100\">{\n                    ADJUSTABLE_INTERVAL_ROLES\n                        .map(intervalRole => ({\n                            intervalRole,\n                            feature: floatFeatures[roleLengthFeature(intervalRole)],\n                        }))\n                        .map(({intervalRole, feature}) => (\n                            <Button size=\"sm\" key={`IntervalRole[${intervalRole}]`}\n                                    onClick={() => setLengthFeature(feature)}\n                                    color={lengthFeature.fabricFeature === feature.fabricFeature ? \"success\" : \"secondary\"}\n                            >\n                                {intervalRoleName(intervalRole)}\n                            </Button>\n                        ))\n                }</ButtonGroup>\n            </Grouping>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { IntervalRole } from \"eig\"\nimport {\n    Color,\n    DoubleSide,\n    LineBasicMaterial,\n    Material,\n    MeshLambertMaterial,\n    MeshPhongMaterial,\n    VertexColors,\n} from \"three\"\n\nexport const SELECTION_COLOR = \"#91934f\"\nexport const SCALE_LINE_COLOR = \"#cace02\"\nexport const JOINT_COLOR = \"#e83ada\"\n\nconst RAINBOW_GRADIENT = [\n    \"#ff0012\",\n    \"#fb5c06\",\n    \"#e28a00\",\n    \"#d4b500\",\n    \"#afd200\",\n    \"#80da52\",\n    \"#4edd83\",\n    \"#00ddad\",\n    \"#00c4d7\",\n    \"#00a5ff\",\n    \"#007bff\",\n    \"#2329f7\",\n].reverse()\n\nconst RAINBOW_COLORS = RAINBOW_GRADIENT.map(colorString => new Color(colorString))\n\n// console.log(\"RAINBOW\\n\",`pub const RAINBOW: [[f32; 3]; ${RAINBOW_GRADIENT.length}] = [\\n${RAINBOW_COLORS.map(color => (\n//     `[${(color.r).toFixed(4)}, ${(color.g).toFixed(4)}, ${(color.b).toFixed(4)}],`\n// )).join(\"\\n\")}\\n];`)\n\nconst lights = true\n\nexport const SURFACE = new MeshPhongMaterial({\n    color: new Color(\"#1c1608\"),\n    side: DoubleSide,\n})\n\nexport const LINE_VERTEX_COLORS = new LineBasicMaterial({\n    vertexColors: VertexColors,\n})\n\nexport const SCALE_LINE = new LineBasicMaterial({\n    color: new Color(SCALE_LINE_COLOR),\n})\n\nexport const FACE = new MeshPhongMaterial({\n    lights,\n    color: new Color(\"white\"),\n    side: DoubleSide,\n    transparent: true,\n    opacity: 0.2,\n})\n\nexport const SELECT_MATERIAL = new MeshPhongMaterial({\n    color: new Color(SELECTION_COLOR),\n    lights: true,\n})\n\nexport const JOINT_MATERIAL = new MeshPhongMaterial({\n    color: new Color(JOINT_COLOR),\n    lights: true,\n})\n\nconst RAINBOW_LAMBERT = RAINBOW_COLORS.map(color => new MeshLambertMaterial({color, lights}))\n\nexport function rainbowMaterial(nuance: number): Material {\n    const index = Math.floor(nuance * RAINBOW_LAMBERT.length)\n    return RAINBOW_LAMBERT[index >= RAINBOW_LAMBERT.length ? RAINBOW_LAMBERT.length - 1 : index]\n}\n\nexport function roleColorString(intervalRole?: IntervalRole): string | undefined {\n    switch (intervalRole) {\n        case IntervalRole.NexusPush:\n            return \"#6541b4\"\n        case IntervalRole.ColumnPush:\n            return \"#2f3aca\"\n        case IntervalRole.Triangle:\n            return \"#c9c445\"\n        case IntervalRole.Ring:\n            return \"#e83ada\"\n        case IntervalRole.NexusCross:\n            return \"#59ebcb\"\n        case IntervalRole.ColumnCross:\n            return \"#299995\"\n        case IntervalRole.BowMid:\n            return \"#f14302\"\n        case IntervalRole.BowEnd:\n            return \"#c03b02\"\n        case IntervalRole.FaceConnector:\n            return \"#fe0105\"\n        case IntervalRole.FaceDistancer:\n            return \"#fefb07\"\n        default:\n            return undefined\n    }\n}\n\nexport function roleColor(intervalRole?: IntervalRole): Color {\n    return new Color(roleColorString(intervalRole))\n}\n\n// import { ALL_INTERVAL_ROLES } from \"../fabric/fabric-engine\"\n// console.log(\"ROLE_COLORS\\n\", `pub const ROLE_COLORS: [[f32; 3]; ${ALL_INTERVAL_ROLES.length}] = [\\n${ALL_INTERVAL_ROLES.map(roleColor).map(color => (\n//     `[${(color.r).toFixed(4)}, ${(color.g).toFixed(4)}, ${(color.b).toFixed(4)}],`\n// )).join(\"\\n\")}\\n];`)\n\nexport function roleMaterial(intervalRole: IntervalRole): Material {\n    const color = roleColor(intervalRole)\n    return new MeshLambertMaterial({color, lights})\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { Button, ButtonGroup } from \"reactstrap\"\n\nimport { fabricFeatureIntervalRole } from \"../fabric/eig-util\"\nimport { FloatFeature } from \"../fabric/fabric-features\"\n\nimport { roleColorString } from \"./materials\"\n\nexport function FeaturePanel({feature, disabled}: {\n    feature: FloatFeature,\n    disabled: boolean,\n}): JSX.Element {\n\n    const [featurePercent, setFeaturePercent] = useState(() => feature.percent)\n    useEffect(() => {\n        const subscription = feature.observable.subscribe(({percent}) => setFeaturePercent(percent))\n        return () => subscription.unsubscribe()\n    }, [])\n\n    const roleColor = roleColorString(fabricFeatureIntervalRole(feature.fabricFeature))\n    const color = roleColor ? roleColor : \"#919191\"\n\n    function percentLabel(percent: number): string {\n        if (percent <= 100) {\n            return `${percent}%`\n        } else {\n            return `${percent / 100}x`\n        }\n    }\n\n    return (\n        <div className=\"my-2\">\n            <div className=\"float-right\" style={{\n                color: disabled ? \"gray\" : \"white\",\n            }}>\n                {feature.formatted}\n            </div>\n            <div>\n                {feature.config.name}\n            </div>\n            <ButtonGroup className=\"w-100\">\n                {feature.percentChoices.map(percent => {\n                    const backgroundColor = featurePercent === percent ? \"#000000\" : color\n                    return (\n                        <Button\n                            disabled={disabled}\n                            size=\"sm\"\n                            style={{\n                                color: \"white\",\n                                backgroundColor,\n                            }}\n                            key={`${feature.config.name}:${percent}`}\n                            onClick={() => feature.percent = percent}\n                        >{percentLabel(percent)}</Button>\n                    )\n                })}\n            </ButtonGroup>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, Stage, SurfaceCharacter } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { FaArrowAltCircleRight, FaBalanceScale, FaGlobe } from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { FloatFeature } from \"../fabric/fabric-features\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IStoredState, transition } from \"../storage/stored-state\"\n\nimport { Grouping } from \"./control-tabs\"\nimport { FeaturePanel } from \"./feature-panel\"\nimport { LifeStageButton, StageTransition } from \"./life-stage-button\"\nimport { ShapeSelection } from \"./shape-tab\"\n\nexport function RealizeTab({floatFeatures, tensegrity, shapeSelection, storedState$}: {\n    floatFeatures: Record<FabricFeature, FloatFeature>,\n    tensegrity: Tensegrity,\n    shapeSelection: ShapeSelection,\n    storedState$: BehaviorSubject<IStoredState>,\n}): JSX.Element {\n\n    const [storedState, updateFabricState] = useState(storedState$.getValue())\n    const [ellipsoids, updateEllipsoids] = useState(storedState$.getValue().ellipsoids)\n    useEffect(() => {\n        const subscriptions = [\n            storedState$.subscribe(newState => {\n                updateEllipsoids(storedState.ellipsoids)\n                updateFabricState(newState)\n            }),\n        ]\n        return () => subscriptions.forEach(s => s.unsubscribe())\n    }, [])\n\n    const [life, updateLife] = useState(tensegrity.life)\n    useEffect(() => {\n        const sub = tensegrity.life$.subscribe(updateLife)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    function disabled(): boolean {\n        return ellipsoids || shapeSelection !== ShapeSelection.None || life.stage < Stage.Slack\n    }\n\n    function changeState(changed: Partial<IStoredState>): void {\n        storedState$.next(transition(storedState$.getValue(), changed))\n    }\n\n    function disabledLifeStage(): boolean {\n        return ellipsoids || shapeSelection !== ShapeSelection.None\n    }\n\n    return (\n        <div>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaArrowAltCircleRight/> Phase</h6>\n                <LifeStageButton\n                    tensegrity={tensegrity}\n                    stageTransition={StageTransition.SlackToRealizing}\n                    disabled={disabledLifeStage()}\n                />\n                <LifeStageButton\n                    tensegrity={tensegrity}\n                    stageTransition={StageTransition.CaptureRealizedToSlack}\n                    disabled={disabledLifeStage()}\n                />\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaGlobe/> Environment</h6>\n                <FeaturePanel feature={floatFeatures[FabricFeature.PretenstFactor]} disabled={disabled()}/>\n                <div className=\"float-right\" style={{\n                    color: disabled() ? \"gray\" : \"white\",\n                }}>\n                    {SurfaceCharacter[storedState.surfaceCharacter]}\n                </div>\n                <div>Surface</div>\n                <ButtonGroup size=\"sm\" className=\"w-100\">\n                    {Object.keys(SurfaceCharacter).map(key => (\n                        <Button\n                            key={`SurfaceCharacter[${key}]`}\n                            disabled={disabled()}\n                            active={storedState.surfaceCharacter === SurfaceCharacter[key]}\n                            onClick={() => changeState({surfaceCharacter: SurfaceCharacter[key]})}\n                        >{key}</Button>\n                    ))}\n                </ButtonGroup>\n                <FeaturePanel feature={floatFeatures[FabricFeature.Gravity]} disabled={disabled()}/>\n                <FeaturePanel feature={floatFeatures[FabricFeature.Drag]} disabled={disabled()}/>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaBalanceScale/> Compression vs Tension</h6>\n                <LifeStageButton\n                    tensegrity={tensegrity}\n                    stageTransition={StageTransition.CaptureStrainForStiffness}\n                    disabled={disabledLifeStage()}\n                />\n                <FeaturePanel feature={floatFeatures[FabricFeature.PushOverPull]} disabled={disabled()}/>\n            </Grouping>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\n\nimport { FabricFeature } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useRef, useState } from \"react\"\nimport { FaSlidersH } from \"react-icons/all\"\nimport { Canvas } from \"react-three-fiber\"\nimport { BehaviorSubject } from \"rxjs\"\nimport { BufferGeometry, Float32BufferAttribute, Geometry, Vector3 } from \"three\"\n\nimport { FloatFeature } from \"../fabric/fabric-features\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IInterval } from \"../fabric/tensegrity-types\"\nimport { IStoredState } from \"../storage/stored-state\"\n\nimport { Grouping } from \"./control-tabs\"\nimport { FeaturePanel } from \"./feature-panel\"\nimport { LINE_VERTEX_COLORS, SCALE_LINE } from \"./materials\"\n\nconst SCALE_WIDTH = 0.7\nconst NEEDLE_WIDTH = 1.4\nconst SCALE_MAX = 3.5\n\nconst FEATURES = [\n    FabricFeature.MaxStrain,\n    FabricFeature.MaxStiffness,\n    FabricFeature.VisualStrain,\n    FabricFeature.SlackThreshold,\n]\n\nfunction scaleGeometry(middleTick: boolean): Geometry {\n    const geometry = new Geometry()\n    const v = (x: number, y: number) => new Vector3(x, y, 0)\n    geometry.vertices = [\n        v(0, -SCALE_MAX), v(0, SCALE_MAX),\n        v(-SCALE_WIDTH, SCALE_MAX), v(SCALE_WIDTH, SCALE_MAX),\n        v(-SCALE_WIDTH, -SCALE_MAX), v(SCALE_WIDTH, -SCALE_MAX),\n    ]\n    if (middleTick) {\n        geometry.vertices.push(v(-SCALE_WIDTH, 0), v(SCALE_WIDTH, 0))\n    }\n    return geometry\n}\n\nfunction needleGeometry(\n    intervals: IInterval[], lineColors: Float32Array,\n    values: Float32Array, midValue: number, maxValue: number,\n): BufferGeometry {\n    const position = new Float32Array(values.length * 2 * 3)\n    let offset = 0\n    intervals.forEach(interval => {\n        const value = values[interval.index]\n        const unboundedHeight = (value - midValue) / (maxValue - midValue)\n        const height = unboundedHeight < -1 ? -1 : unboundedHeight > 1 ? 1 : unboundedHeight\n        position[offset++] = -SCALE_WIDTH * NEEDLE_WIDTH\n        position[offset++] = height * SCALE_MAX\n        position[offset++] = 0\n        position[offset++] = SCALE_WIDTH * NEEDLE_WIDTH\n        position[offset++] = height * SCALE_MAX\n        position[offset++] = 0\n    })\n    const geometry = new BufferGeometry()\n    geometry.addAttribute(\"position\", new Float32BufferAttribute(position, 3))\n    geometry.addAttribute(\"color\", new Float32BufferAttribute(lineColors, 3))\n    return geometry\n}\n\nexport function StrainTab({floatFeatures, tensegrity, storedState$}: {\n    floatFeatures: Record<FabricFeature, FloatFeature>,\n    tensegrity: Tensegrity,\n    storedState$: BehaviorSubject<IStoredState>,\n}): JSX.Element {\n    const camera = useRef()\n\n    function ScaleView(): JSX.Element {\n        const [age, updateAge] = useState(0)\n        const [maxStrain, updateMaxStrain] = useState(storedState$.getValue().featureValues[FabricFeature.MaxStrain].numeric)\n        const [maxStiffness, updateMaxStiffness] = useState(storedState$.getValue().featureValues[FabricFeature.MaxStiffness].numeric)\n\n        useEffect(() => {\n            const sub = storedState$.subscribe(storedState => {\n                updateMaxStrain(storedState.featureValues[FabricFeature.MaxStrain].numeric)\n                updateMaxStiffness(storedState.featureValues[FabricFeature.MaxStiffness].numeric)\n            })\n            return () => sub.unsubscribe()\n        }, [tensegrity])\n\n        useEffect(() => {\n            const timer = setInterval(() => {\n                const fabricAge = tensegrity.instance.fabric.age\n                if (age < fabricAge) {\n                    updateAge(fabricAge) // to trigger repaint. better way?\n                }\n            }, 1000)\n            return () => clearTimeout(timer)\n        }, [])\n\n        const instance = tensegrity.instance\n\n        function Scale({position, intervals, floats, mid, max, middleTick}: {\n            position: number,\n            intervals: IInterval[],\n            floats: Float32Array,\n            mid: number,\n            max: number,\n            middleTick: boolean,\n        }): JSX.Element {\n            return (\n                <group position={new Vector3(position, -0.15, 0)}>\n                    <lineSegments\n                        geometry={needleGeometry(intervals, instance.floatView.lineColors, floats, mid, max)}\n                        material={LINE_VERTEX_COLORS}/>\n                    <lineSegments geometry={scaleGeometry(middleTick)} material={SCALE_LINE}/>\n                </group>\n            )\n        }\n\n        return (\n            <Canvas>\n                <orthographicCamera position={new Vector3(0, 0, -1)} ref={camera}/>\n                <scene>\n                    <Scale\n                        position={-1.5}\n                        intervals={tensegrity.intervals}\n                        floats={instance.floatView.strains}\n                        mid={0}\n                        max={maxStrain}\n                        middleTick={true}\n                    />\n                    <Scale\n                        position={1.5}\n                        intervals={tensegrity.intervals}\n                        floats={instance.floatView.stiffnesses}\n                        mid={0}\n                        max={maxStiffness}\n                        middleTick={false}\n                    />\n                </scene>\n            </Canvas>\n        )\n    }\n\n    return <>\n        <Grouping height=\"50%\">\n            <div style={{\n                position: \"absolute\",\n                left: \"6em\",\n            }}>\n                Strain\n            </div>\n            <div style={{\n                position: \"absolute\",\n                right: \"5em\",\n            }}>\n                Stiffness\n            </div>\n            <ScaleView/>\n        </Grouping>\n        <Grouping>\n            <h6 className=\"w-100 text-center\"><FaSlidersH/> Adjustments</h6>\n            {FEATURES.map(feature => (\n                <FeaturePanel\n                    key={`FabricFeature[${feature}]`}\n                    feature={floatFeatures[feature]}\n                    disabled={false}\n                />))}\n        </Grouping>\n    </>\n}\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { FaBox, FaBug, FaHeart, FaHiking, FaPlay, FaRegFolder, FaRegFolderOpen, FaSeedling } from \"react-icons/all\"\nimport { Button, ButtonDropdown, ButtonGroup, DropdownItem, DropdownMenu, DropdownToggle, Input } from \"reactstrap\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { BOOTSTRAP, codeToTenscript, ITenscript } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { addRecentCode, getRecentTenscript, IStoredState } from \"../storage/stored-state\"\n\nimport { Grouping } from \"./control-tabs\"\n\nexport function TenscriptTab({rootTenscript, setRootTenscript, tensegrity, runTenscript, storedState$}: {\n    rootTenscript: ITenscript,\n    setRootTenscript: (tenscript: ITenscript) => void,\n    tensegrity?: Tensegrity,\n    runTenscript: (tenscript: ITenscript) => void,\n    storedState$: BehaviorSubject<IStoredState>,\n}): JSX.Element {\n\n    const [tenscript, setTenscript] = useState<ITenscript>(tensegrity && !tensegrity.tenscript.fromUrl ? tensegrity.tenscript : rootTenscript)\n    const [error, setError] = useState(\"\")\n\n    const [recentOpen, setRecentOpen] = useState(false)\n    const [recentPrograms, setRecentPrograms] = useState<ITenscript[]>(getRecentTenscript(storedState$.getValue()))\n    const [bootstrapOpen, setBootstrapOpen] = useState(false)\n\n    function addToRecentPrograms(newCode: ITenscript): void {\n        const state = addRecentCode(storedState$.getValue(), newCode)\n        setRecentPrograms(getRecentTenscript(state))\n        storedState$.next(state)\n    }\n\n    return (\n        <div id=\"tenscript-panel\" style={{\n            flexDirection: \"column\",\n            position: \"relative\",\n            backgroundColor: \"rgba(0,0,0,1)\",\n            height: \"100%\",\n        }}>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaSeedling/> Tenscript</h6>\n                <div id=\"code-and-run\" style={{\n                    flexDirection: \"column\",\n                    height: \"available\",\n                }}>\n                    <CodeArea\n                        tenscript={tenscript}\n                        setTenscript={setTenscript}\n                        error={error}\n                        setError={setError}\n                    />\n                    <ButtonGroup className=\"w-100 my-2\">\n                        <Button\n                            color={error.length > 0 ? \"warning\" : \"success\"}\n                            disabled={error.length > 0}\n                            onClick={() => runTenscript(tenscript)}\n                        >\n                            {error.length === 0 ? (\n                                <span>Execute <FaPlay/> tenscript</span>\n                            ) : (\n                                <span><FaBug/> {error}</span>\n                            )}\n                        </Button>\n                    </ButtonGroup>\n                </div>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaBox/> Storage</h6>\n                {recentPrograms.length === 0 ? undefined : (\n                    <ButtonDropdown\n                        className=\"w-100 my-2\"\n                        isOpen={recentOpen}\n                        toggle={() => setRecentOpen(!recentOpen)}\n                    >\n                        <DropdownToggle style={{borderRadius: \"1.078em\"}}>\n                            {recentOpen ? <FaRegFolderOpen/> : <FaRegFolder/>} Recent\n                        </DropdownToggle>\n                        <DropdownMenu>{recentPrograms.map((recentCode, index) => (\n                            <DropdownItem key={`Recent${index}`} onClick={() => runTenscript(recentCode)}>\n                                {recentCode.name}\n                            </DropdownItem>\n                        ))}</DropdownMenu>\n                    </ButtonDropdown>\n                )}\n                <ButtonGroup className=\"w-100 my-2\">\n                    <Button\n                        disabled={tenscript.code === rootTenscript.code}\n                        onClick={() => {\n                            setRootTenscript(tenscript)\n                            addToRecentPrograms(tenscript)\n                        }}\n                    >\n                        Save <FaHeart/> for later\n                    </Button>\n                </ButtonGroup>\n                <ButtonDropdown\n                    className=\"w-100 my-2\"\n                    isOpen={bootstrapOpen}\n                    toggle={() => setBootstrapOpen(!bootstrapOpen)}\n                >\n                    <DropdownToggle color=\"info\" style={{borderRadius: \"1.078em\"}}>\n                        Explore <FaHiking/> existing designs\n                    </DropdownToggle>\n                    <DropdownMenu>{BOOTSTRAP.map((bootstrapProgram, index) => (\n                        <DropdownItem key={`Boot${index}`} onClick={() => runTenscript(bootstrapProgram)}>\n                            {bootstrapProgram.name}\n                        </DropdownItem>\n                    ))}</DropdownMenu>\n                </ButtonDropdown>\n            </Grouping>\n        </div>\n    )\n}\n\nfunction CodeArea({tenscript, setTenscript, error, setError}: {\n    tenscript: ITenscript,\n    setTenscript: (tenscript: ITenscript) => void,\n    error: string,\n    setError: (message: string) => void,\n}): JSX.Element {\n\n    const [tenscriptCode, setTenscriptCode] = useState(\"\")\n    useEffect(() => setTenscriptCode(tenscript.code), [])\n\n    function compile(newCode: string): void {\n        const compiled = codeToTenscript(setError, false, newCode)\n        if (compiled) {\n            setError(\"\")\n            setTenscript(compiled)\n        }\n    }\n\n    function onCodeChange(newCode: string): void {\n        setTenscriptCode(newCode)\n        compile(newCode)\n    }\n\n    return (\n        <div\n            className=\"my-2 p-2 w-100\"\n            style={{\n                backgroundColor: \"#757575\",\n                color: \"#ffffff\",\n                borderStyle: \"solid\",\n                borderRadius: \"1em\",\n                borderColor: error.length === 0 ? \"black\" : \"#f0ad4e\",\n                borderWidth: \"2px\",\n            }}\n        >\n            <h6 className=\"w-100 text-center\">\n                <i>\"{tenscript.name}\"</i>\n            </h6>\n            <Input\n                style={{\n                    borderRadius: \"1em\",\n                    height: \"20em\",\n                }}\n                type=\"textarea\" id=\"tenscript\"\n                value={tenscriptCode}\n                onChange={changeEvent => onCodeChange(changeEvent.target.value)}\n            />\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as FileSaver from \"file-saver\"\nimport JSZip from \"jszip\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IJointCable } from \"../fabric/tensegrity-types\"\n\nimport { IStoredState } from \"./stored-state\"\n\nfunction csvNumber(n: number): string {\n    return n.toFixed(5).replace(/[.]/, \",\")\n}\n\nfunction dateString(): string {\n    return new Date().toISOString()\n        .replace(/[.].*/, \"\").replace(/[:T_]/g, \"-\")\n}\n\nexport interface IOutputJoint {\n    index: number\n    x: number\n    y: number\n    z: number\n    jointCables: IJointCable[]\n}\n\nexport interface IOutputInterval {\n    index: number\n    joints: number[]\n    type: string\n    strain: number\n    stiffness: number\n    linearDensity: number\n    isPush: boolean\n    role: string\n    idealLength: number\n    length: number\n    radius: number\n    jointRadius: number\n}\n\nexport interface IFabricOutput {\n    name: string\n    joints: IOutputJoint[]\n    intervals: IOutputInterval[]\n}\n\nfunction extractJointFile(output: IFabricOutput): string {\n    const csvJoints: string[][] = []\n    csvJoints.push([\"index\", \"x\", \"y\", \"z\"])\n    output.joints.forEach(joint => csvJoints.push([\n        (joint.index+1).toFixed(0),\n        csvNumber(joint.x), csvNumber(joint.y), csvNumber(joint.z),\n    ]))\n    return csvJoints.map(a => a.join(\";\")).join(\"\\n\")\n}\n\nfunction extractIntervalFile(output: IFabricOutput): string {\n    const csvIntervals: string[][] = []\n    csvIntervals.push([\"joints\", \"type\", \"strain\", \"stiffness\", \"linear density\", \"role\", \"length\"])\n    output.intervals.forEach(interval => {\n        csvIntervals.push([\n            `\"=\"\"${interval.joints.map(j => (j + 1).toFixed(0))}\"\"\"`, interval.type,\n            csvNumber(interval.strain), csvNumber(interval.stiffness), csvNumber(interval.linearDensity),\n            interval.role, interval.length.toFixed(8),\n        ])\n    })\n    return csvIntervals.map(a => a.join(\";\")).join(\"\\n\")\n}\n\nfunction extractSubmergedFile(tensegrity: Tensegrity): string {\n    const csvSubmerged: string[][] = []\n    csvSubmerged.push([\"joints\"])\n    csvSubmerged.push([`\"=\"\"${tensegrity.submergedJoints.map(joint => joint.index + 1)}\"\"\"`])\n    return csvSubmerged.map(a => a.join(\";\")).join(\"\\n\")\n}\n\nexport function saveCSVZip(tensegrity: Tensegrity, storedState: IStoredState): void {\n    const output = tensegrity.getFabricOutput(storedState)\n    const zip = new JSZip()\n    zip.file(\"joints.csv\", extractJointFile(output))\n    zip.file(\"intervals.csv\", extractIntervalFile(output))\n    zip.file(\"submerged.csv\", extractSubmergedFile(tensegrity))\n    zip.generateAsync({type: \"blob\", mimeType: \"application/zip\"}).then(blob => {\n        FileSaver.saveAs(blob, `pretenst-${dateString()}.zip`)\n    })\n}\n\nexport function saveJSONZip(tensegrity: Tensegrity, storedState: IStoredState): void {\n    const output = tensegrity.getFabricOutput(storedState)\n    const zip = new JSZip()\n    zip.file(`pretenst-${dateString()}.json`, JSON.stringify(output, undefined, 2))\n    zip.generateAsync({type: \"blob\", mimeType: \"application/zip\"}).then(blob => {\n        FileSaver.saveAs(blob, `pretenst-${dateString()}.zip`)\n    })\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole, Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport {\n    FaCamera,\n    FaCircle,\n    FaClock,\n    FaCompressArrowsAlt,\n    FaDownload,\n    FaExpandArrowsAlt, FaEye, FaFile,\n    FaFileCsv,\n    FaFistRaised,\n    FaFutbol,\n    FaHandRock,\n    FaParachuteBox, FaRunning,\n    FaVolleyballBall,\n} from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { ADJUSTABLE_INTERVAL_ROLES, intervalRoleName } from \"../fabric/eig-util\"\nimport { FloatFeature } from \"../fabric/fabric-features\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { saveCSVZip, saveJSONZip } from \"../storage/download\"\nimport { IStoredState, transition } from \"../storage/stored-state\"\n\nimport { Grouping } from \"./control-tabs\"\nimport { FeaturePanel } from \"./feature-panel\"\n\nexport function ViewTab(\n    {\n        floatFeatures, tensegrity,\n        visibleRoles, setVisibleRoles, storedState$,\n    }: {\n        floatFeatures: Record<FabricFeature, FloatFeature>,\n        tensegrity: Tensegrity,\n        visibleRoles: IntervalRole[],\n        setVisibleRoles: (roles: IntervalRole[]) => void,\n        storedState$: BehaviorSubject<IStoredState>,\n    }): JSX.Element {\n\n    const [ellipsoids, updateEllipsoids] = useState(storedState$.getValue().ellipsoids)\n    const [showPushes, updateShowPushes] = useState(storedState$.getValue().showPushes)\n    const [showPulls, updateShowPulls] = useState(storedState$.getValue().showPulls)\n    useEffect(() => {\n        const subscription = storedState$.subscribe(newState => {\n            updateEllipsoids(newState.ellipsoids)\n            updateShowPushes(newState.showPushes)\n            updateShowPulls(newState.showPulls)\n        })\n        return () => subscription.unsubscribe()\n    }, [])\n\n    const [life, updateLife] = useState(tensegrity.life)\n    useEffect(() => {\n        const sub = tensegrity.life$.subscribe(updateLife)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    function ViewButton({pushes, pulls, children}: { pushes: boolean, pulls: boolean, children: JSX.Element }): JSX.Element {\n        return (\n            <Button\n                style={{color: \"white\"}}\n                color={pushes === showPushes && pulls === showPulls ? \"success\" : \"secondary\"}\n                onClick={() => {\n                    storedState$.next(transition(storedState$.getValue(), {showPulls: pulls, showPushes: pushes}))\n                }}\n            >\n                {children}\n            </Button>\n        )\n    }\n\n    return (\n        <div>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaEye/> Coloring</h6>\n                <ButtonGroup className=\"w-100 my-2\">\n                    <ViewButton pushes={true} pulls={true}>\n                        <span><FaFutbol/> All</span>\n                    </ViewButton>\n                    <ViewButton pushes={false} pulls={true}>\n                        <span><FaVolleyballBall/> Pulls</span>\n                    </ViewButton>\n                    <ViewButton pushes={true} pulls={false}>\n                        <span><FaExpandArrowsAlt/> Pushes</span>\n                    </ViewButton>\n                    <ViewButton pushes={false} pulls={false}>\n                        <span><FaCircle/> Roles</span>\n                    </ViewButton>\n                </ButtonGroup>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaCamera/> Snapshot</h6>\n                <ButtonGroup size=\"sm\" className=\"w-100\">\n                    {ADJUSTABLE_INTERVAL_ROLES.map(intervalRole => (\n                        <Button\n                            color={visibleRoles.indexOf(intervalRole) < 0 ? \"secondary\" : \"success\"}\n                            key={`viz${intervalRole}`}\n                            onClick={() => {\n                                if (visibleRoles.indexOf(intervalRole) < 0) {\n                                    setVisibleRoles([...visibleRoles, intervalRole])\n                                } else {\n                                    setVisibleRoles(visibleRoles.filter(role => role !== intervalRole))\n                                }\n                            }}\n                            disabled={!ellipsoids}\n                        >\n                            {intervalRoleName(intervalRole)}\n                        </Button>\n                    ))}\n                </ButtonGroup>\n                <FeaturePanel key=\"pushrad\" feature={floatFeatures[FabricFeature.PushRadius]}\n                              disabled={!ellipsoids}/>\n                <FeaturePanel key=\"pullrad\" feature={floatFeatures[FabricFeature.PullRadius]}\n                              disabled={!ellipsoids}/>\n                <FeaturePanel key=\"jointrad\" feature={floatFeatures[FabricFeature.JointRadius]}\n                              disabled={!ellipsoids}/>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaClock/> Time</h6>\n                <FeaturePanel key=\"it\" feature={floatFeatures[FabricFeature.IterationsPerFrame]} disabled={ellipsoids}/>\n                <FeaturePanel key=\"ic\" feature={floatFeatures[FabricFeature.IntervalCountdown]} disabled={ellipsoids}/>\n                <FeaturePanel key=\"pc\" feature={floatFeatures[FabricFeature.RealizingCountdown]} disabled={ellipsoids}/>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaFistRaised/> Perturb</h6>\n                <ButtonGroup className=\"w-100\">\n                    <Button disabled={life.stage !== Stage.Realized}\n                            onClick={() => tensegrity.instance.fabric.set_altitude(1)}>\n                        <FaHandRock/> Nudge\n                    </Button>\n                    <Button disabled={life.stage !== Stage.Realized}\n                            onClick={() => tensegrity.instance.fabric.set_altitude(10)}>\n                        <FaParachuteBox/> Drop\n                    </Button>\n                    <Button disabled={ellipsoids}\n                            onClick={() => tensegrity.instance.fabric.centralize()}>\n                        <FaCompressArrowsAlt/> Centralize\n                    </Button>\n                </ButtonGroup>\n            </Grouping>\n            <Grouping>\n                <h6 className=\"w-100 text-center\"><FaRunning/> Take</h6>\n                <ButtonGroup vertical={false} className=\"w-100\">\n                    <Button onClick={() => saveCSVZip(tensegrity, storedState$.getValue())}>\n                        <FaDownload/> Download CSV <FaFileCsv/>\n                    </Button>\n                    <Button onClick={() => saveJSONZip(tensegrity, storedState$.getValue())}>\n                        <FaDownload/> Download JSON <FaFile/>\n                    </Button>\n                </ButtonGroup>\n            </Grouping>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { FaArrowLeft } from \"react-icons/all\"\nimport { Alert, Button, Nav, NavItem, NavLink, TabContent, TabPane } from \"reactstrap\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { FloatFeature } from \"../fabric/fabric-features\"\nimport { Life } from \"../fabric/life\"\nimport { ITenscript } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IFace, IInterval } from \"../fabric/tensegrity-types\"\nimport { ControlTab, IStoredState, transition } from \"../storage/stored-state\"\n\nimport { RealizeTab } from \"./realize-tab\"\nimport { ShapeSelection, ShapeTab } from \"./shape-tab\"\nimport { StrainTab } from \"./strain-tab\"\nimport { TenscriptTab } from \"./tenscript-tab\"\nimport { ViewTab } from \"./view-tab\"\n\nconst SPLIT_LEFT = \"25em\"\n\nexport function ControlTabs(\n    {\n        floatFeatures,\n        rootTenscript, setRootTenscript,\n        shapeSelection, setShapeSelection,\n        selectedFaces, clearSelectedFaces, selectedIntervals,\n        tensegrity, setFabric, runTenscript,\n        visibleRoles, setVisibleRoles,\n        toFullScreen, storedState$,\n    }: {\n        floatFeatures: Record<FabricFeature, FloatFeature>,\n        rootTenscript: ITenscript,\n        setRootTenscript: (tenscript: ITenscript) => void,\n        selectedFaces: IFace[],\n        clearSelectedFaces: () => void,\n        selectedIntervals: IInterval[],\n        runTenscript: (tenscript: ITenscript) => void,\n        tensegrity?: Tensegrity,\n        setFabric: (tensegrity: Tensegrity) => void,\n        shapeSelection: ShapeSelection,\n        setShapeSelection: (shapeSelection: ShapeSelection) => void,\n        toFullScreen: () => void,\n        visibleRoles: IntervalRole[],\n        setVisibleRoles: (roles: IntervalRole[]) => void,\n        storedState$: BehaviorSubject<IStoredState>,\n    }): JSX.Element {\n\n    const [life, updateLife] = useState<Life | undefined>(tensegrity ? tensegrity.life : undefined)\n    useEffect(() => {\n        const sub = tensegrity ? tensegrity.life$.subscribe(updateLife) : undefined\n        return () => {\n            if (sub) {\n                sub.unsubscribe()\n            }\n        }\n    }, [tensegrity])\n\n    const [controlTab, updateControlTab] = useState(storedState$.getValue().controlTab)\n    useEffect(() => {\n        if (controlTab !== ControlTab.Shape) {\n            clearSelectedFaces()\n        }\n    }, [controlTab, life])\n\n    useEffect(() => {\n        const sub = storedState$.subscribe(newState => updateControlTab(newState.controlTab))\n        return () => sub.unsubscribe()\n    }, [])\n\n    function Link({tab}: { tab: ControlTab }): JSX.Element {\n        return (\n            <NavItem>\n                <NavLink\n                    active={controlTab === tab}\n                    onClick={() => storedState$.next(transition(storedState$.getValue(), {controlTab: tab}))}\n                >{tab}</NavLink>\n            </NavItem>\n        )\n    }\n\n    function Pane({tab}: { tab: ControlTab }): JSX.Element {\n\n        const NO_FABRIC = <Alert color=\"warning\">No fabric</Alert>\n\n        function Content(): JSX.Element {\n            switch (tab) {\n                case ControlTab.Grow:\n                    return (\n                        <TenscriptTab\n                            rootTenscript={rootTenscript}\n                            setRootTenscript={setRootTenscript}\n                            tensegrity={tensegrity}\n                            runTenscript={runTenscript}\n                            storedState$={storedState$}\n                        />\n                    )\n                case ControlTab.Shape:\n                    return !tensegrity ? NO_FABRIC : (\n                        <ShapeTab\n                            floatFeatures={floatFeatures}\n                            tensegrity={tensegrity}\n                            setFabric={setFabric}\n                            selectedIntervals={selectedIntervals}\n                            shapeSelection={shapeSelection}\n                            setShapeSelection={setShapeSelection}\n                            selectedFaces={selectedFaces}\n                            clearSelectedFaces={clearSelectedFaces}\n                            storedState$={storedState$}\n                        />\n                    )\n                case ControlTab.Realize:\n                    return !tensegrity ? NO_FABRIC : (\n                        <RealizeTab\n                            floatFeatures={floatFeatures}\n                            tensegrity={tensegrity}\n                            shapeSelection={shapeSelection}\n                            storedState$={storedState$}\n                        />\n                    )\n                case ControlTab.View:\n                    return !tensegrity ? NO_FABRIC : (\n                        <ViewTab\n                            floatFeatures={floatFeatures}\n                            tensegrity={tensegrity}\n                            visibleRoles={visibleRoles}\n                            setVisibleRoles={setVisibleRoles}\n                            storedState$={storedState$}\n                        />\n                    )\n                case ControlTab.Strain:\n                    return !tensegrity ? NO_FABRIC : (\n                        <StrainTab\n                            floatFeatures={floatFeatures}\n                            tensegrity={tensegrity}\n                            storedState$={storedState$}\n                        />\n                    )\n            }\n        }\n\n        return (\n            <TabPane id=\"tab-pane\" style={{height: \"100%\"}} tabId={tab}><Content/></TabPane>\n        )\n    }\n\n    function FullScreenButton(): JSX.Element {\n        return (\n            <Button\n                style={{\n                    padding: 0,\n                    margin: 0,\n                    borderRadius: 0,\n                    width: \"1em\",\n                }}\n                className=\"w-100 h-100\" color=\"dark\"\n                onClick={toFullScreen}\n            >\n                <FaArrowLeft/>\n            </Button>\n        )\n    }\n\n    return (\n        <div className=\"h-100\">\n            <Nav tabs={true} style={{backgroundColor: \"#b2b2b2\"}}>\n                {Object.keys(ControlTab).map(tab => <Link key={`T${tab}`} tab={ControlTab[tab]}/>)}\n            </Nav>\n            <TabContent style={{flex: 1, flexFlow: \"auto\", height: \"100%\"}} id=\"tab-content\" activeTab={controlTab}>\n                {Object.keys(ControlTab).map(tab => <Pane key={tab} tab={ControlTab[tab]}/>)}\n            </TabContent>\n            <div style={{\n                position: \"absolute\",\n                top: 0,\n                height: \"100%\",\n                left: SPLIT_LEFT,\n                zIndex: 10,\n                width: \"1em\",\n            }}>\n                <FullScreenButton/>\n            </div>\n        </div>\n    )\n}\n\nexport function Grouping({children, height}: {\n    children: JSX.Element | (JSX.Element[] | JSX.Element | undefined)[],\n    height?: string,\n}): JSX.Element {\n    return (\n        <div className=\"m-3 p-2\" style={{\n            height,\n            borderRadius: \"1em\",\n            borderStyle: \"solid\",\n            borderWidth: \"0.1em\",\n            borderColor: \"#45782e\",\n        }}>\n            {children}\n        </div>\n    )\n}\n","\n/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as THREE from \"three\"\nimport { Matrix4, PerspectiveCamera } from \"three\"\n\nconst STATE = {\n    NONE: -1,\n    ROTATE: 0,\n    DOLLY: 1,\n    PAN: 2,\n    TOUCH_ROTATE: 3,\n    TOUCH_DOLLY: 4,\n    TOUCH_PAN: 5,\n}\n\nconst CHANGE_EVENT = {type: \"change\"}\nconst START_EVENT = {type: \"start\"}\nconst END_EVENT = {type: \"end\"}\nconst EPS = 0.000001\n\n/**\n * @author qiao / https://github.com/qiao\n * @author mrdoob / http://mrdoob.com\n * @author alteredq / http://alteredqualia.com/\n * @author WestLangley / http://github.com/WestLangley\n * @author erich666 / http://erichaines.com\n * @author nicolaspanel / http://github.com/nicolaspanel\n *\n * This set of controls performs orbiting, dollying (zooming), and panning.\n * Unlike TrackballControls, it maintains the \"up\" direction object.up (+Y by default).\n *    Orbit - left mouse / touch: one finger move\n *    Zoom - middle mouse, or mousewheel / touch: two finger spread or squish\n *    Pan - right mouse, or arrow keys / touch: three finger swipe\n */\nexport class Orbit extends THREE.EventDispatcher {\n    public object: PerspectiveCamera\n    public element: HTMLElement\n    public window: Window\n\n    // API\n    public enabled: boolean\n    public target: THREE.Vector3\n\n    public enableZoom: boolean\n    public zoomSpeed: number\n    public minDistance: number\n    public maxDistance: number\n    public enableRotate: boolean\n    public rotateSpeed: number\n    public enablePan: boolean\n    public keyPanSpeed: number\n    public autoRotate: boolean\n    public autoRotateSpeed: number\n    public minZoom: number\n    public maxZoom: number\n    public minPolarAngle: number\n    public maxPolarAngle: number\n    public minAzimuthAngle: number\n    public maxAzimuthAngle: number\n    public keys: { LEFT: number; UP: number; RIGHT: number; BOTTOM: number; }\n    public mouseButtons: { ORBIT: THREE.MOUSE; ZOOM: THREE.MOUSE; PAN: THREE.MOUSE; }\n    public enableDamping: boolean\n    public dampingFactor: number\n\n    private readonly spherical: THREE.Spherical\n    private sphericalDelta: THREE.Spherical\n    private scale: number\n    private readonly target0: THREE.Vector3\n    private readonly position0: THREE.Vector3\n    private readonly zoom0: number\n    private state: number\n    private readonly panOffset: THREE.Vector3\n    private zoomChanged: boolean\n\n    private readonly rotateStart: THREE.Vector2\n    private readonly rotateEnd: THREE.Vector2\n    private rotateDelta: THREE.Vector2\n\n    private readonly panStart: THREE.Vector2\n    private readonly panEnd: THREE.Vector2\n    private panDelta: THREE.Vector2\n\n    private readonly dollyStart: THREE.Vector2\n    private readonly dollyEnd: THREE.Vector2\n    private dollyDelta: THREE.Vector2\n\n    private updateLastPosition: THREE.Vector3\n    private readonly updateOffset: THREE.Vector3\n    private readonly updateQuat: THREE.Quaternion\n    private updateLastQuaternion: THREE.Quaternion\n    private readonly updateQuatInverse: THREE.Quaternion\n\n    private readonly panLeftV: THREE.Vector3\n    private readonly panUpV: THREE.Vector3\n    private panInternalOffset: THREE.Vector3\n\n    private readonly onMouseUp: EventListener\n    private readonly onMouseDown: EventListener\n    private readonly onMouseMove: EventListener\n    private readonly onMouseWheel: EventListener\n    private readonly onTouchStart: EventListener\n    private readonly onTouchEnd: EventListener\n    private readonly onTouchMove: EventListener\n\n    constructor(camera: THREE.PerspectiveCamera, element: HTMLElement) {\n        super()\n        this.object = camera\n        this.element = element\n        this.window = window\n\n        // Set to false to disable this control\n        this.enabled = true\n\n        // \"target\" sets the location of focus, where the object orbits around\n        this.target = new THREE.Vector3()\n\n        // How far you can dolly in and out ( PerspectiveCamera only )\n        this.minDistance = 0\n        this.maxDistance = Infinity\n\n        // How far you can zoom in and out ( OrthographicCamera only )\n        this.minZoom = 0\n        this.maxZoom = Infinity\n\n        // How far you can orbit vertically, upper and lower limits.\n        // Range is 0 to Math.PI radians.\n        this.minPolarAngle = 0 // radians\n        this.maxPolarAngle = Math.PI // radians\n\n        // How far you can orbit horizontally, upper and lower limits.\n        // If set, must be a sub-interval of the interval [ - Math.PI, Math.PI ].\n        this.minAzimuthAngle = -Infinity // radians\n        this.maxAzimuthAngle = Infinity // radians\n\n        // Set to true to enable damping (inertia)\n        // If damping is enabled, you must call controls.update() in your animation loop\n        this.enableDamping = false\n        this.dampingFactor = 0.25\n\n        // This option actually enables dollying in and out; left as \"zoom\" for backwards compatibility.\n        // Set to false to disable zooming\n        this.enableZoom = true\n        this.zoomSpeed = 1.0\n\n        // Set to false to disable rotating\n        this.enableRotate = true\n        this.rotateSpeed = 1.0\n\n        // Set to false to disable panning\n        this.enablePan = true\n        this.keyPanSpeed = 7.0\t// pixels moved per arrow key push\n\n        // Set to true to automatically rotate around the target\n        // If auto-rotate is enabled, you must call controls.update() in your animation loop\n        this.autoRotate = false\n        this.autoRotateSpeed = 2.0 // 30 seconds per round when fps is 60\n\n        // The four arrow keys\n        this.keys = {LEFT: 37, UP: 38, RIGHT: 39, BOTTOM: 40}\n\n        // Mouse buttons\n        this.mouseButtons = {ORBIT: THREE.MOUSE.LEFT, ZOOM: THREE.MOUSE.MIDDLE, PAN: THREE.MOUSE.RIGHT}\n\n        // for reset\n        this.target0 = this.target.clone()\n        this.position0 = this.object.position.clone()\n        this.zoom0 = (this.object as PerspectiveCamera).zoom\n\n        // for update speedup\n        this.updateOffset = new THREE.Vector3()\n        // so camera.up is the orbit axis\n        this.updateQuat = new THREE.Quaternion().setFromUnitVectors(this.object.up, new THREE.Vector3(0, 1, 0))\n        this.updateQuatInverse = this.updateQuat.clone().inverse()\n        this.updateLastPosition = new THREE.Vector3()\n        this.updateLastQuaternion = new THREE.Quaternion()\n\n        this.state = STATE.NONE\n        this.scale = 1\n\n        // current position in spherical coordinates\n        this.spherical = new THREE.Spherical()\n        this.sphericalDelta = new THREE.Spherical()\n\n        this.panOffset = new THREE.Vector3()\n        this.zoomChanged = false\n\n        this.rotateStart = new THREE.Vector2()\n        this.rotateEnd = new THREE.Vector2()\n        this.rotateDelta = new THREE.Vector2()\n\n        this.panStart = new THREE.Vector2()\n        this.panEnd = new THREE.Vector2()\n        this.panDelta = new THREE.Vector2()\n\n        this.dollyStart = new THREE.Vector2()\n        this.dollyEnd = new THREE.Vector2()\n        this.dollyDelta = new THREE.Vector2()\n\n        this.panLeftV = new THREE.Vector3()\n        this.panUpV = new THREE.Vector3()\n        this.panInternalOffset = new THREE.Vector3()\n\n        // event handlers - FSM: listen for events and reset state\n\n        this.onMouseDown = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled) {\n                return\n            }\n            if (event.button === this.mouseButtons.ORBIT) {\n                if (!this.enableRotate) {\n                    return\n                }\n                this.rotateStart.set(event.clientX, event.clientY)\n                this.state = STATE.ROTATE\n            } else if (event.button === this.mouseButtons.ZOOM) {\n                if (!this.enableZoom) {\n                    return\n                }\n                this.dollyStart.set(event.clientX, event.clientY)\n                this.state = STATE.DOLLY\n            } else if (event.button === this.mouseButtons.PAN) {\n                if (!this.enablePan) {\n                    return\n                }\n                this.panStart.set(event.clientX, event.clientY)\n                this.state = STATE.PAN\n            }\n            if (this.state !== STATE.NONE) {\n                document.addEventListener(\"mousemove\", this.onMouseMove, false)\n                document.addEventListener(\"mouseup\", this.onMouseUp, false)\n                this.dispatchEvent(START_EVENT)\n            }\n        }\n\n        this.onMouseMove = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled) {\n                return\n            }\n            if (this.state === STATE.ROTATE) {\n                if (!this.enableRotate) {\n                    return\n                }\n                this.rotateEnd.set(event.clientX, event.clientY)\n                this.rotateDelta.subVectors(this.rotateEnd, this.rotateStart)\n                // rotating across whole screen goes 360 degrees around\n                this.rotateLeft(2 * Math.PI * this.rotateDelta.x / this.element.clientWidth * this.rotateSpeed)\n                // rotating up and down along whole screen attempts to go 360, but limited to 180\n                this.rotateUp(2 * Math.PI * this.rotateDelta.y / this.element.clientHeight * this.rotateSpeed)\n                this.rotateStart.copy(this.rotateEnd)\n\n                this.update()\n            } else if (this.state === STATE.DOLLY) {\n\n                if (!this.enableZoom) {\n                    return\n                }\n\n                this.dollyEnd.set(event.clientX, event.clientY)\n                this.dollyDelta.subVectors(this.dollyEnd, this.dollyStart)\n\n                if (this.dollyDelta.y > 0) {\n                    this.dollyIn(this.getZoomScale())\n                } else if (this.dollyDelta.y < 0) {\n                    this.dollyOut(this.getZoomScale())\n                }\n\n                this.dollyStart.copy(this.dollyEnd)\n                this.update()\n            } else if (this.state === STATE.PAN) {\n\n                if (!this.enablePan) {\n                    return\n                }\n\n                this.panEnd.set(event.clientX, event.clientY)\n                this.panDelta.subVectors(this.panEnd, this.panStart)\n                this.pan(this.panDelta.x, this.panDelta.y)\n                this.panStart.copy(this.panEnd)\n                this.update()\n            }\n        }\n\n        this.onMouseUp = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled) {\n                return\n            }\n            document.removeEventListener(\"mousemove\", this.onMouseMove, false)\n            document.removeEventListener(\"mouseup\", this.onMouseUp, false)\n\n            this.dispatchEvent(END_EVENT)\n            this.state = STATE.NONE\n        }\n\n        this.onMouseWheel = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled || !this.enableZoom || (this.state !== STATE.NONE && this.state !== STATE.ROTATE)) {\n                return\n            }\n            event.stopPropagation()\n            if (event.deltaY < 0) {\n                this.dollyOut(this.getZoomScale())\n            } else if (event.deltaY > 0) {\n                this.dollyIn(this.getZoomScale())\n            }\n            this.update()\n            this.dispatchEvent(START_EVENT) // not sure why these are here...\n            this.dispatchEvent(END_EVENT)\n        }\n\n        this.onTouchStart = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled) {\n                return\n            }\n            switch (event.touches.length) {\n                // one-fingered touch: rotate\n                case 1: {\n                    if (!this.enableRotate) {\n                        return\n                    }\n                    this.rotateStart.set(event.touches[0].pageX, event.touches[0].pageY)\n                    this.state = STATE.TOUCH_ROTATE\n                }\n                    break\n                // two-fingered touch: dolly\n                case 2: {\n                    if (!this.enableZoom) {\n                        return\n                    }\n\n                    const dx = event.touches[0].pageX - event.touches[1].pageX\n                    const dy = event.touches[0].pageY - event.touches[1].pageY\n\n                    const distance = Math.sqrt(dx * dx + dy * dy)\n                    this.dollyStart.set(0, distance)\n                    this.state = STATE.TOUCH_DOLLY\n                }\n                    break\n                // three-fingered touch: pan\n                case 3: {\n                    if (!this.enablePan) {\n                        return\n                    }\n\n                    this.panStart.set(event.touches[0].pageX, event.touches[0].pageY)\n                    this.state = STATE.TOUCH_PAN\n                }\n                    break\n                default: {\n                    this.state = STATE.NONE\n                }\n            }\n\n            if (this.state !== STATE.NONE) {\n                this.dispatchEvent(START_EVENT)\n            }\n        }\n\n        this.onTouchMove = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled) {\n                return\n            }\n            switch (event.touches.length) {\n                // one-fingered touch: rotate\n                case 1: {\n                    if (!this.enableRotate) {\n                        return\n                    }\n                    if (this.state !== STATE.TOUCH_ROTATE) {\n                        return\n                    } // is this needed?...\n\n                    this.rotateEnd.set(event.touches[0].pageX, event.touches[0].pageY)\n                    this.rotateDelta.subVectors(this.rotateEnd, this.rotateStart)\n\n                    // rotating across whole screen goes 360 degrees around\n                    this.rotateLeft(2 * Math.PI * this.rotateDelta.x / this.element.clientWidth * this.rotateSpeed)\n\n                    // rotating up and down along whole screen attempts to go 360, but limited to 180\n                    this.rotateUp(2 * Math.PI * this.rotateDelta.y / this.element.clientHeight * this.rotateSpeed)\n\n                    this.rotateStart.copy(this.rotateEnd)\n\n                    this.update()\n                }\n                    break\n                // two-fingered touch: dolly\n                case 2: {\n                    if (!this.enableZoom) {\n                        return\n                    }\n                    if (this.state !== STATE.TOUCH_DOLLY) {\n                        return\n                    } // is this needed?...\n\n                    const dx = event.touches[0].pageX - event.touches[1].pageX\n                    const dy = event.touches[0].pageY - event.touches[1].pageY\n\n                    const distance = Math.sqrt(dx * dx + dy * dy)\n\n                    this.dollyEnd.set(0, distance)\n\n                    this.dollyDelta.subVectors(this.dollyEnd, this.dollyStart)\n\n                    if (this.dollyDelta.y > 0) {\n                        this.dollyOut(this.getZoomScale())\n                    } else if (this.dollyDelta.y < 0) {\n                        this.dollyIn(this.getZoomScale())\n                    }\n\n                    this.dollyStart.copy(this.dollyEnd)\n                    this.update()\n                }\n                    break\n                // three-fingered touch: pan\n                case 3: {\n                    if (!this.enablePan) {\n                        return\n                    }\n                    if (this.state !== STATE.TOUCH_PAN) {\n                        return\n                    } // is this needed?...\n                    this.panEnd.set(event.touches[0].pageX, event.touches[0].pageY)\n                    this.panDelta.subVectors(this.panEnd, this.panStart)\n                    this.pan(this.panDelta.x, this.panDelta.y)\n                    this.panStart.copy(this.panEnd)\n                    this.update()\n                }\n                    break\n                default: {\n                    this.state = STATE.NONE\n                }\n            }\n        }\n\n        this.onTouchEnd = (event: IThreeEvent) => {\n            event.preventDefault()\n            if (!this.enabled) {\n                return\n            }\n            this.dispatchEvent(END_EVENT)\n            this.state = STATE.NONE\n        }\n\n        this.element.addEventListener(\"mousedown\", this.onMouseDown, {capture: true})\n        this.element.addEventListener(\"wheel\", this.onMouseWheel, {capture: true})\n        this.element.addEventListener(\"touchstart\", this.onTouchStart, {capture: true})\n        this.element.addEventListener(\"touchend\", this.onTouchEnd, {capture: true})\n        this.element.addEventListener(\"touchmove\", this.onTouchMove, {capture: true})\n\n        // force an update at start\n        this.update()\n    }\n\n    public update(): boolean {\n        const position = this.object.position\n        this.updateOffset.copy(position).sub(this.target)\n\n        // rotate offset to \"y-axis-is-up\" space\n        this.updateOffset.applyQuaternion(this.updateQuat)\n\n        // angle from z-axis around y-axis\n        this.spherical.setFromVector3(this.updateOffset)\n\n        if (this.autoRotate && this.state === STATE.NONE) {\n            this.rotateLeft(this.getAutoRotationAngle())\n        }\n\n        this.spherical.theta += this.sphericalDelta.theta\n        this.spherical.phi += this.sphericalDelta.phi\n\n        // restrict theta to be between desired limits\n        this.spherical.theta = Math.max(this.minAzimuthAngle, Math.min(this.maxAzimuthAngle, this.spherical.theta))\n\n        // restrict phi to be between desired limits\n        this.spherical.phi = Math.max(this.minPolarAngle, Math.min(this.maxPolarAngle, this.spherical.phi))\n\n        this.spherical.makeSafe()\n\n        this.spherical.radius *= this.scale\n\n        // restrict radius to be between desired limits\n        this.spherical.radius = Math.max(this.minDistance, Math.min(this.maxDistance, this.spherical.radius))\n\n        // move target to panned location\n        this.target.add(this.panOffset)\n\n        this.updateOffset.setFromSpherical(this.spherical)\n\n        // rotate offset back to \"camera-up-vector-is-up\" space\n        this.updateOffset.applyQuaternion(this.updateQuatInverse)\n\n        position.copy(this.target).add(this.updateOffset)\n\n        this.object.lookAt(this.target)\n\n        if (this.enableDamping) {\n\n            this.sphericalDelta.theta *= (1 - this.dampingFactor)\n            this.sphericalDelta.phi *= (1 - this.dampingFactor)\n\n        } else {\n\n            this.sphericalDelta.set(0, 0, 0)\n\n        }\n\n        this.scale = 1\n        this.panOffset.set(0, 0, 0)\n\n        // update condition is:\n        // min(camera displacement, camera rotation in radians)^2 > EPS\n        // using small-angle approximation cos(x/2) = 1 - x^2 / 8\n\n        if (this.zoomChanged ||\n            this.updateLastPosition.distanceToSquared(this.object.position) > EPS ||\n            8 * (1 - this.updateLastQuaternion.dot(this.object.quaternion)) > EPS) {\n\n            this.dispatchEvent(CHANGE_EVENT)\n            this.updateLastPosition.copy(this.object.position)\n            this.updateLastQuaternion.copy(this.object.quaternion)\n            this.zoomChanged = false\n            return true\n        }\n        return false\n    }\n\n    public panLeft(distance: number, objectMatrix: Matrix4): void {\n        this.panLeftV.setFromMatrixColumn(objectMatrix, 0) // get X column of objectMatrix\n        this.panLeftV.multiplyScalar(-distance)\n        this.panOffset.add(this.panLeftV)\n    }\n\n    public panUp(distance: number, objectMatrix: Matrix4): void {\n        this.panUpV.setFromMatrixColumn(objectMatrix, 1) // get Y column of objectMatrix\n        this.panUpV.multiplyScalar(distance)\n        this.panOffset.add(this.panUpV)\n    }\n\n    // deltaX and deltaY are in pixels; right and down are positive\n    public pan(deltaX: number, deltaY: number): void {\n        const element: HTMLElement = this.element as HTMLElement\n\n        const position = this.object.position\n        this.panInternalOffset.copy(position).sub(this.target)\n        let targetDistance = this.panInternalOffset.length()\n\n        // half of the fov is center to top of screen\n        targetDistance *= Math.tan((this.object.fov / 2) * Math.PI / 180.0)\n\n        // we actually don't use screenWidth, since perspective camera is fixed to screen height\n        this.panLeft(2 * deltaX * targetDistance / element.clientHeight, this.object.matrix)\n        this.panUp(2 * deltaY * targetDistance / element.clientHeight, this.object.matrix)\n    }\n\n    public dollyIn(dollyScale: number): void {\n        this.scale /= dollyScale\n    }\n\n    public dollyOut(dollyScale: number): void {\n        this.scale *= dollyScale\n    }\n\n    public getAutoRotationAngle(): number {\n        return 2 * Math.PI / 60 / 60 * this.autoRotateSpeed\n    }\n\n    public getZoomScale(): number {\n        return Math.pow(0.95, this.zoomSpeed)\n    }\n\n    public rotateLeft(angle: number): void {\n        this.sphericalDelta.theta -= angle\n    }\n\n    public rotateUp(angle: number): void {\n        this.sphericalDelta.phi -= angle\n    }\n\n    public getPolarAngle(): number {\n        return this.spherical.phi\n    }\n\n    public getAzimuthalAngle(): number {\n        return this.spherical.theta\n    }\n\n    public dispose(): void {\n        this.element.removeEventListener(\"mousedown\", this.onMouseDown, false)\n        this.element.removeEventListener(\"wheel\", this.onMouseWheel, false)\n        this.element.removeEventListener(\"touchstart\", this.onTouchStart, false)\n        this.element.removeEventListener(\"touchend\", this.onTouchEnd, false)\n        this.element.removeEventListener(\"touchmove\", this.onTouchMove, false)\n        document.removeEventListener(\"mousemove\", this.onMouseMove, false)\n        document.removeEventListener(\"mouseup\", this.onMouseUp, false)\n    }\n\n    public reset(): void {\n        this.target.copy(this.target0)\n        this.object.position.copy(this.position0)\n        this.object.zoom = this.zoom0\n        this.object.updateProjectionMatrix()\n        this.dispatchEvent(CHANGE_EVENT)\n        this.update()\n        this.state = STATE.NONE\n    }\n}\n\ninterface ITouch {\n    pageX: number\n    pageY: number\n}\n\ninterface IThreeEvent extends Event {\n    clientX: number\n    clientY: number\n    deltaY: number\n    button: THREE.MOUSE\n    touches: ITouch[]\n    keyCode: number\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useMemo } from \"react\"\nimport { Color, Face3, Geometry, Vector3 } from \"three\"\n\nimport { SURFACE } from \"./materials\"\n\nexport const KINDA = 0.866\nexport const SURFACE_SCALE = 20\nexport const HEXAGON_POINTS = [\n    new Vector3(0, 0, -SURFACE_SCALE),\n    new Vector3(-KINDA * SURFACE_SCALE, 0, -SURFACE_SCALE / 2),\n    new Vector3(-KINDA * SURFACE_SCALE, 0, SURFACE_SCALE / 2),\n    new Vector3(0, 0, SURFACE_SCALE),\n    new Vector3(KINDA * SURFACE_SCALE, 0, SURFACE_SCALE / 2),\n    new Vector3(KINDA * SURFACE_SCALE, 0, -SURFACE_SCALE / 2),\n]\nexport const SURFACE_LAND_COLOR = new Color(\"tan\")\nexport const SIX = 6\nexport const UP = new Vector3(0, 1, 0)\nexport const LAND_NORMAL_SPREAD = 0.03\n\nexport function SurfaceComponent(): JSX.Element {\n    const spots = useMemo(() => spotsGeometry(), [])\n    return (\n        <mesh name=\"Spots\" geometry={spots} material={SURFACE}/>\n    )\n}\n\nfunction spotsGeometry(): Geometry {\n    const geometry = new Geometry()\n    addSurfaceGeometry(geometry.vertices, geometry.faces)\n    geometry.vertices.forEach(v => v.sub(new Vector3(0, 0.01, 0)))\n    geometry.computeBoundingSphere()\n    return geometry\n}\n\nfunction addSurfaceGeometry(vertices: Vector3[], faces: Face3[]): void {\n    vertices.push(...HEXAGON_POINTS.map(hexPoint => new Vector3(hexPoint.x, hexPoint.y, hexPoint.z)))\n    vertices.push(new Vector3())\n    for (let a = 0; a < SIX; a++) {\n        const b = (a + 1) % SIX\n        const vertexNormals = [\n            UP,\n            new Vector3().add(UP).addScaledVector(HEXAGON_POINTS[a], LAND_NORMAL_SPREAD).normalize(),\n            new Vector3().add(UP).addScaledVector(HEXAGON_POINTS[b], LAND_NORMAL_SPREAD).normalize(),\n        ]\n        faces.push(new Face3(SIX, a, b, vertexNormals, SURFACE_LAND_COLOR))\n    }\n}\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole, Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useMemo, useRef, useState } from \"react\"\nimport { DomEvent, extend, ReactThreeFiber, useRender, useThree, useUpdate } from \"react-three-fiber\"\nimport { BehaviorSubject } from \"rxjs\"\nimport {\n    BackSide,\n    Color,\n    CylinderGeometry,\n    Euler,\n    MeshPhongMaterial,\n    Object3D,\n    PerspectiveCamera,\n    Quaternion,\n    SphereGeometry,\n    TextureLoader,\n    Vector3,\n} from \"three\"\n\nimport { doNotClick } from \"../fabric/eig-util\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IFace, IInterval, percentToFactor } from \"../fabric/tensegrity-types\"\nimport { IStoredState } from \"../storage/stored-state\"\n\nimport { FACE, JOINT_MATERIAL, LINE_VERTEX_COLORS, rainbowMaterial, roleMaterial, SELECT_MATERIAL } from \"./materials\"\nimport { Orbit } from \"./orbit\"\nimport { ShapeSelection } from \"./shape-tab\"\nimport { SurfaceComponent } from \"./surface-component\"\n\nextend({Orbit})\n\nconst SPHERE = new SphereGeometry(1, 32, 8)\nconst PULL_CYLINDER = new CylinderGeometry(1, 1, 1, 12, 1, false)\nconst PUSH_CYLINDER_INNER = new CylinderGeometry(0.5, 0.5, 1, 6, 1, false)\nconst PUSH_CYLINDER_OUTER = new CylinderGeometry(1, 1, 0.85, 12, 1, false)\n\ndeclare global {\n    namespace JSX {\n        /* eslint-disable @typescript-eslint/interface-name-prefix */\n        interface IntrinsicElements {\n            orbit: ReactThreeFiber.Object3DNode<Orbit, typeof Orbit>\n        }\n\n        /* eslint-enable @typescript-eslint/interface-name-prefix */\n    }\n}\n\nconst AMBIENT_COLOR = new Color(\"#ffffff\")\nconst SPACE_RADIUS = 100\nconst SPACE_SCALE = 1\nconst SPACE_GEOMETRY = new SphereGeometry(SPACE_RADIUS, 25, 25)\n    .scale(SPACE_SCALE, SPACE_SCALE, SPACE_SCALE)\n\nconst TOWARDS_TARGET = 0.01\nconst ALTITUDE = 4\nconst Y_AXIS = new Vector3(0, 1, 0)\n\nexport function FabricView({\n                               tensegrity, fabricError, selectedIntervals, selectedFaces, setSelectedFaces, storedState$,\n                               shapeSelection, ellipsoids, visibleRoles,\n                           }: {\n    tensegrity: Tensegrity,\n    fabricError: (error: string) => void,\n    selectedIntervals: IInterval[],\n    selectedFaces: IFace[],\n    setSelectedFaces: (faces: IFace[]) => void,\n    shapeSelection: ShapeSelection,\n    ellipsoids: boolean,\n    visibleRoles: IntervalRole[],\n    storedState$: BehaviorSubject<IStoredState>,\n}): JSX.Element {\n\n    const viewContainer = document.getElementById(\"view-container\") as HTMLElement\n    const [age, setAge] = useState(0)\n    const {camera} = useThree()\n    const perspective = camera as PerspectiveCamera\n    const spaceMaterial = useMemo(() => {\n        const spaceTexture = new TextureLoader().load(\"space.jpg\")\n        return new MeshPhongMaterial({map: spaceTexture, side: BackSide})\n    }, [])\n\n    const [life, updateLife] = useState(tensegrity.life)\n    useEffect(() => {\n        const sub = tensegrity.life$.subscribe(updateLife)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    const [storedState, updateStoredState] = useState(storedState$.getValue())\n    useEffect(() => {\n        const sub = storedState$.subscribe(newState => updateStoredState(newState))\n        return () => sub.unsubscribe()\n    }, [])\n    useEffect(() => {\n        orbit.current.autoRotate = storedState.rotating\n    }, [storedState])\n\n    const orbit = useUpdate<Orbit>(orb => {\n        const midpoint = new Vector3(0, ALTITUDE, 0)\n        perspective.position.set(midpoint.x, ALTITUDE, midpoint.z + ALTITUDE * 4)\n        perspective.lookAt(orbit.current.target)\n        perspective.fov = 60\n        perspective.far = SPACE_RADIUS * 2\n        perspective.near = 0.001\n        orb.object = perspective\n        orb.minPolarAngle = -0.98 * Math.PI / 2\n        orb.maxPolarAngle = 0.8 * Math.PI\n        orb.maxDistance = SPACE_RADIUS * SPACE_SCALE * 0.9\n        orb.zoomSpeed = 0.5\n        orb.enableZoom = true\n        orb.target.set(midpoint.x, midpoint.y, midpoint.z)\n        orb.update()\n    }, [])\n\n    useRender(() => {\n        try {\n            const instance = tensegrity.instance\n            const view = instance.view\n            const target = new Vector3(view.midpoint_x(), view.midpoint_y(), view.midpoint_z())\n            const towardsTarget = new Vector3().subVectors(target, orbit.current.target).multiplyScalar(TOWARDS_TARGET)\n            orbit.current.target.add(towardsTarget)\n            orbit.current.update()\n            if (!ellipsoids && shapeSelection !== ShapeSelection.Faces) {\n                const nextStage = tensegrity.iterate()\n                if (life.stage === Stage.Realizing && nextStage === Stage.Realized) {\n                    setTimeout(() => tensegrity.toStage(Stage.Realized, {}))\n                } else if (nextStage !== life.stage && life.stage !== Stage.Realizing && nextStage !== Stage.Busy) {\n                    setTimeout(() => tensegrity.toStage(nextStage, {}))\n                }\n            }\n            setAge(instance.fabric.age)\n        } catch (e) {\n            fabricError(e)\n        }\n    }, true, [\n        tensegrity, age, life, shapeSelection, ellipsoids,\n    ])\n\n    function toggleFacesSelection(faceToToggle: IFace): void {\n        if (selectedFaces.some(selected => selected.index === faceToToggle.index)) {\n            setSelectedFaces(selectedFaces.filter(b => b.index !== faceToToggle.index))\n        } else {\n            setSelectedFaces([...selectedFaces, faceToToggle])\n        }\n    }\n\n    return (\n        <group>\n            <orbit ref={orbit} args={[perspective, viewContainer]}/>\n            <scene>\n                {ellipsoids ? (\n                    <EllipsoidView\n                        key=\"ellipsoid\"\n                        tensegrity={tensegrity}\n                        selectedIntervals={selectedIntervals}\n                        storedState={storedState}\n                        visibleRoles={visibleRoles}\n                    />\n                ) : (\n                    <LineView\n                        key=\"lines\"\n                        tensegrity={tensegrity}\n                        selectedIntervals={selectedIntervals}\n                        storedState={storedState}\n                    />\n                )}\n                {shapeSelection !== ShapeSelection.Faces ? undefined : (\n                    <Faces\n                        key=\"faces\"\n                        tensegrity={tensegrity}\n                        stage={life.stage}\n                        selectFace={toggleFacesSelection}\n                    />\n                )}\n                {selectedFaces.map(face => <SelectedFace key={`Face${face.index}`} tensegrity={tensegrity} face={face}/>)}\n                <SurfaceComponent/>\n                <mesh key=\"space\" geometry={SPACE_GEOMETRY} material={spaceMaterial}/>\n                <ambientLight color={AMBIENT_COLOR} intensity={0.8}/>\n                <directionalLight color={new Color(\"#FFFFFF\")} intensity={2}/>\n            </scene>\n        </group>\n    )\n}\n\nfunction SelectedFace({tensegrity, face}: { tensegrity: Tensegrity, face: IFace }): JSX.Element {\n    const scale = percentToFactor(face.brick.scale) / 8\n    return (\n        <mesh\n            geometry={SPHERE}\n            position={face.location()}\n            material={SELECT_MATERIAL}\n            scale={new Vector3(scale, scale, scale)}\n        />\n    )\n}\n\nfunction IntervalMesh({tensegrity, interval, storedState}: {\n    tensegrity: Tensegrity,\n    interval: IInterval,\n    storedState: IStoredState,\n}): JSX.Element | null {\n\n    let material = roleMaterial(interval.intervalRole)\n    if (storedState.showPushes || storedState.showPulls) {\n        material = rainbowMaterial(tensegrity.instance.floatView.strainNuances[interval.index])\n        if (!(storedState.showPushes && storedState.showPulls) && (storedState.showPushes && !interval.isPush || storedState.showPulls && interval.isPush)) {\n            return <group/>\n        }\n    }\n    const linearDensity = tensegrity.instance.floatView.linearDensities[interval.index]\n    const radiusFeature = storedState.featureValues[interval.isPush ? FabricFeature.PushRadius : FabricFeature.PullRadius]\n    const radius = radiusFeature.numeric * linearDensity\n    const unit = tensegrity.instance.unitVector(interval.index)\n    const rotation = new Quaternion().setFromUnitVectors(Y_AXIS, unit)\n    const length = interval.alpha.location().distanceTo(interval.omega.location())\n    const jointRadius = radius * storedState.featureValues[FabricFeature.JointRadius].numeric\n    const intervalScale = new Vector3(radius, length + (interval.isPush ? -jointRadius * 2 : 0), radius)\n    const jointScale = new Vector3(jointRadius, jointRadius, jointRadius)\n    return (\n        <>\n            {interval.isPush ? (\n                <>\n                    <mesh\n                        geometry={PUSH_CYLINDER_INNER}\n                        position={interval.location()}\n                        rotation={new Euler().setFromQuaternion(rotation)}\n                        scale={intervalScale}\n                        material={material}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                    <mesh\n                        geometry={PUSH_CYLINDER_OUTER}\n                        position={interval.location()}\n                        rotation={new Euler().setFromQuaternion(rotation)}\n                        scale={intervalScale}\n                        material={material}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                    <mesh\n                        geometry={SPHERE}\n                        position={interval.alpha.location()}\n                        material={JOINT_MATERIAL}\n                        scale={jointScale}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                    <mesh\n                        geometry={SPHERE}\n                        position={interval.omega.location()}\n                        material={JOINT_MATERIAL}\n                        scale={jointScale}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                </>\n            ) : (\n                <mesh\n                    geometry={PULL_CYLINDER}\n                    position={interval.location()}\n                    rotation={new Euler().setFromQuaternion(rotation)}\n                    scale={intervalScale}\n                    material={material}\n                    matrixWorldNeedsUpdate={true}\n                />\n            )}\n        </>\n    )\n}\n\nfunction EllipsoidView({tensegrity, visibleRoles, selectedIntervals, storedState}: {\n    tensegrity: Tensegrity,\n    visibleRoles: IntervalRole[],\n    selectedIntervals: IInterval[],\n    storedState: IStoredState,\n}): JSX.Element {\n    return (\n        <group>\n            {selectedIntervals.length > 0 ? selectedIntervals.map(interval => (\n                <IntervalMesh\n                    key={`SI${interval.index}`}\n                    tensegrity={tensegrity}\n                    interval={interval}\n                    storedState={storedState}\n                />\n            )) : tensegrity.intervals.map(interval => (visibleRoles.indexOf(interval.intervalRole) < 0 ? undefined :\n                    <IntervalMesh\n                        key={`I${interval.index}`}\n                        tensegrity={tensegrity}\n                        interval={interval}\n                        storedState={storedState}\n                    />\n            ))}}\n        </group>\n    )\n}\n\nfunction LineView({tensegrity, selectedIntervals, storedState}: {\n    tensegrity: Tensegrity,\n    selectedIntervals: IInterval[],\n    storedState: IStoredState,\n}): JSX.Element {\n    return (\n        <group>\n            <lineSegments\n                key=\"lines\"\n                geometry={tensegrity.linesGeometry}\n                material={LINE_VERTEX_COLORS}\n            />\n            {selectedIntervals.map(interval => (\n                <IntervalMesh\n                    key={`SI${interval.index}`}\n                    tensegrity={tensegrity}\n                    interval={interval}\n                    storedState={storedState}\n                />\n            ))}\n        </group>\n    )\n}\n\nfunction Faces({tensegrity, stage, selectFace}: {\n    tensegrity: Tensegrity,\n    stage: Stage,\n    selectFace: (face: IFace) => void,\n}): JSX.Element {\n    const {raycaster} = useThree()\n    const meshRef = useRef<Object3D>()\n    const [downEvent, setDownEvent] = useState<DomEvent | undefined>()\n    const onPointerDown = (event: DomEvent) => setDownEvent(event)\n    const onPointerUp = (event: DomEvent) => {\n        const mesh = meshRef.current\n        if (doNotClick(stage) || !downEvent || !mesh) {\n            return\n        }\n        const dx = downEvent.clientX - event.clientX\n        const dy = downEvent.clientY - event.clientY\n        const distanceSq = dx * dx + dy * dy\n        if (distanceSq > 100) {\n            return\n        }\n        const intersections = raycaster.intersectObjects([mesh], true)\n        const faces = intersections.map(intersection => intersection.faceIndex).map(faceIndex => {\n            if (faceIndex === undefined) {\n                return undefined\n            }\n            return tensegrity.faces[faceIndex]\n        })\n        const face = faces.reverse().pop()\n        setDownEvent(undefined)\n        if (!face) {\n            return\n        }\n        selectFace(face)\n    }\n    return (\n        <mesh\n            key=\"faces\"\n            ref={meshRef}\n            onPointerDown={onPointerDown}\n            onPointerUp={onPointerUp}\n            geometry={tensegrity.facesGeometry}\n            material={FACE}\n        />\n    )\n}\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FabricFeature, IntervalRole, Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useMemo, useState } from \"react\"\nimport { FaArrowRight, FaCamera, FaHandPointUp, FaPlay, FaSyncAlt, FaToolbox } from \"react-icons/all\"\nimport { Canvas } from \"react-three-fiber\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { ADJUSTABLE_INTERVAL_ROLES, fabricFeatureIntervalRole } from \"../fabric/eig-util\"\nimport { FloatFeature } from \"../fabric/fabric-features\"\nimport { FabricInstance } from \"../fabric/fabric-instance\"\nimport { BOOTSTRAP, getCodeFromUrl, ITenscript } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IFace, IInterval, percentToFactor } from \"../fabric/tensegrity-types\"\nimport {\n    getRecentTenscript,\n    IFeatureValue,\n    IStoredState,\n    roleDefaultFromFeatures,\n    transition,\n} from \"../storage/stored-state\"\n\nimport { ControlTabs } from \"./control-tabs\"\nimport { FabricView } from \"./fabric-view\"\nimport { ShapeSelection } from \"./shape-tab\"\n\nconst SPLIT_LEFT = \"25em\"\nconst SPLIT_RIGHT = \"26em\"\n\nfunction getCodeToRun(state: IStoredState): ITenscript {\n    const fromUrl = getCodeFromUrl()\n    if (fromUrl) {\n        return fromUrl\n    }\n    const recentCode = getRecentTenscript(state)\n    return recentCode.length > 0 ? recentCode[0] : BOOTSTRAP[0]\n}\n\nfunction selectIntervals(faces: IFace[]): IInterval[] {\n    return faces.reduce((accum, face) => {\n        const unknown = (interval: IInterval) => !accum.some(existing => interval.index === existing.index)\n        const pulls = face.pulls.filter(unknown)\n        const pushes = face.pushes.filter(unknown)\n        return [...accum, ...pushes, ...pulls]\n    }, [] as IInterval[])\n}\n\nexport function TensegrityView({eig, floatFeatures, storedState$}: {\n    eig: typeof import(\"eig\"),\n    floatFeatures: Record<FabricFeature, FloatFeature>,\n    storedState$: BehaviorSubject<IStoredState>,\n}): JSX.Element {\n\n    const mainInstance = useMemo(() => new FabricInstance(eig, 100), [])\n\n    const [tensegrity, setTensegrity] = useState<Tensegrity | undefined>()\n    const [selectedIntervals, setSelectedIntervals] = useState<IInterval[]>([])\n    const [selectedFaces, setSelectedFaces] = useState<IFace[]>([])\n    useEffect(() => setSelectedIntervals(selectIntervals(selectedFaces)), [selectedFaces])\n\n    const [rootTenscript, setRootTenscript] = useState(() => getCodeToRun(storedState$.getValue()))\n    useEffect(() => {\n        if (location.hash.length === 0) {\n            location.hash = rootTenscript.code\n        }\n    }, [rootTenscript])\n\n    const [visibleRoles, setVisibleRoles] = useState(ADJUSTABLE_INTERVAL_ROLES)\n    const [rotating, updateRotating] = useState(storedState$.getValue().rotating)\n    const [shapeSelection, setShapeSelection] = useState(ShapeSelection.None)\n    const [fullScreen, updateFullScreen] = useState(storedState$.getValue().fullScreen)\n    const [ellipsoids, updateEllipsoids] = useState(storedState$.getValue().ellipsoids)\n    useEffect(() => setVisibleRoles(ADJUSTABLE_INTERVAL_ROLES), [ellipsoids])\n    useEffect(() => {\n        const subscription = storedState$.subscribe(storedState => {\n            updateFullScreen(storedState.fullScreen)\n            updateEllipsoids(storedState.ellipsoids)\n            updateRotating(storedState.rotating)\n            if (!tensegrity) {\n                return\n            }\n            mainInstance.world.set_coloring(storedState.showPushes, storedState.showPulls)\n            mainInstance.world.set_surface_character(storedState.surfaceCharacter)\n        })\n        return () => subscription.unsubscribe()\n    }, [tensegrity])\n\n    useEffect(() => {\n        const featureSubscriptions = Object.keys(floatFeatures).map(k => floatFeatures[k]).map((feature: FloatFeature) =>\n            feature.observable.subscribe((value: IFeatureValue) => {\n                if (!tensegrity) {\n                    return\n                }\n                tensegrity.instance.applyFeature(feature)\n                const intervalRole = fabricFeatureIntervalRole(feature.config.feature)\n                if (intervalRole !== undefined) {\n                    tensegrity.intervals\n                        .filter(interval => interval.intervalRole === intervalRole)\n                        .forEach(interval => {\n                            const scaledLength = feature.numeric * percentToFactor(interval.scale)\n                            tensegrity.instance.fabric.change_rest_length(interval.index, scaledLength, 500)\n                        })\n                }\n            }))\n        return () => featureSubscriptions.forEach(sub => sub.unsubscribe())\n    }, [tensegrity])\n\n    function runTenscript(newTenscript: ITenscript): void {\n        if (!mainInstance) {\n            return\n        }\n        location.hash = newTenscript.code\n        floatFeatures[FabricFeature.ShapingPretenstFactor].percent = 100\n        floatFeatures[FabricFeature.ShapingDrag].percent = 100\n        floatFeatures[FabricFeature.ShapingStiffnessFactor].percent = 100\n        storedState$.next(transition(storedState$.getValue(), {ellipsoids: false}))\n        const roleLength = (role: IntervalRole) => roleDefaultFromFeatures(floatFeatures, role)\n        const numericFeature = (feature: FabricFeature) => storedState$.getValue().featureValues[feature].numeric\n        setTensegrity(new Tensegrity(roleLength, numericFeature, mainInstance, newTenscript))\n    }\n\n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (!tensegrity) {\n                runTenscript(rootTenscript)\n            }\n        }, 200)\n        return () => clearTimeout(timer)\n    }, [rootTenscript])\n\n    function toFullScreen(value: boolean): void {\n        storedState$.next(transition(storedState$.getValue(), {fullScreen: value}))\n    }\n\n    return (\n        <>\n            {fullScreen ? (\n                <Button id=\"to-full-screen\" color=\"dark\" onClick={() => toFullScreen(false)}>\n                    <FaArrowRight/><br/><FaToolbox/><br/><FaArrowRight/>\n                </Button>\n            ) : (\n                <div\n                    id=\"left-side\"\n                    style={{\n                        visibility: fullScreen ? \"collapse\" : \"visible\",\n                        width: SPLIT_LEFT,\n                    }}\n                >\n                    <ControlTabs\n                        floatFeatures={floatFeatures}\n                        rootTenscript={rootTenscript}\n                        setRootTenscript={setRootTenscript}\n                        tensegrity={tensegrity}\n                        setFabric={setTensegrity}\n                        selectedIntervals={selectedIntervals}\n                        shapeSelection={shapeSelection}\n                        setShapeSelection={setShapeSelection}\n                        selectedFaces={selectedFaces}\n                        clearSelectedFaces={() => setSelectedFaces([])}\n                        runTenscript={runTenscript}\n                        toFullScreen={() => toFullScreen(true)}\n                        visibleRoles={visibleRoles}\n                        setVisibleRoles={setVisibleRoles}\n                        storedState$={storedState$}\n                    />\n                </div>\n            )}\n            <div style={{\n                position: \"absolute\",\n                left: fullScreen ? 0 : SPLIT_RIGHT,\n                right: 0,\n                height: \"100%\",\n            }}>\n                {!tensegrity ? (\n                    <div id=\"tensegrity-view\" className=\"h-100\">\n                        <div style={{position: \"relative\", top: \"50%\", left: \"50%\"}}>\n                            <Button onClick={() => runTenscript(rootTenscript)}>\n                                <h6>{rootTenscript.name}</h6>\n                                <h1><FaPlay/></h1>\n                            </Button>\n                        </div>\n                    </div>\n                ) : (\n                    <div className=\"h-100\">\n                        <TopMiddle tensegrity={tensegrity}/>\n                        <div id=\"bottom-middle\">\n                            <ButtonGroup>\n                                <Button\n                                    color={ellipsoids ? \"warning\" : \"secondary\"}\n                                    onClick={() => storedState$.next(transition(storedState$.getValue(), {ellipsoids: !ellipsoids}))}\n                                >\n                                    <FaCamera/>\n                                </Button>\n                                <Button\n                                    color={shapeSelection === ShapeSelection.Faces ? \"warning\" : \"secondary\"}\n                                    disabled={ellipsoids && shapeSelection === ShapeSelection.None}\n                                    onClick={() => setShapeSelection(shapeSelection !== ShapeSelection.Faces ? ShapeSelection.Faces : ShapeSelection.None)}\n                                >\n                                    <span><FaHandPointUp/></span>\n                                </Button>\n                                <Button\n                                    color={rotating ? \"warning\" : \"secondary\"}\n                                    onClick={() => storedState$.next(transition(storedState$.getValue(), {rotating: !rotating}))}\n                                >\n                                    <FaSyncAlt/>\n                                </Button>\n                            </ButtonGroup>\n                        </div>\n                        <div id=\"view-container\" className=\"h-100\">\n                            <Canvas style={{\n                                backgroundColor: \"black\",\n                                borderStyle: \"solid\",\n                                borderColor: shapeSelection === ShapeSelection.Faces || ellipsoids ? \"#f0ad4e\" : \"black\",\n                                cursor: shapeSelection === ShapeSelection.Faces ? \"pointer\" : \"all-scroll\",\n                                borderWidth: \"2px\",\n                            }}>\n                                <FabricView\n                                    tensegrity={tensegrity}\n                                    fabricError={error => {\n                                        console.error(error)\n                                        const tenscript = tensegrity.tenscript\n                                        setTensegrity(undefined)\n                                        setTimeout(() => runTenscript(tenscript), 1000)\n                                    }}\n                                    selectedIntervals={selectedIntervals}\n                                    selectedFaces={selectedFaces}\n                                    setSelectedFaces={setSelectedFaces}\n                                    shapeSelection={shapeSelection}\n                                    ellipsoids={ellipsoids}\n                                    visibleRoles={visibleRoles}\n                                    storedState$={storedState$}\n                                />\n                            </Canvas>\n                        </div>\n                    </div>\n                )}\n            </div>\n        </>\n    )\n}\n\nfunction TopMiddle({tensegrity}: { tensegrity: Tensegrity }): JSX.Element {\n    const [life, updateLife] = useState(tensegrity.life)\n    useEffect(() => {\n        const sub = tensegrity.life$.subscribe(updateLife)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n    return (\n        <div id=\"top-middle\">\n            <span>{Stage[life.stage]}</span> <i>\"{tensegrity.tenscript.name}\"</i>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport * as ReactDOM from \"react-dom\"\nimport { BehaviorSubject } from \"rxjs\"\n\nimport { createFloatFeatures, featureConfig } from \"./fabric/fabric-features\"\nimport registerServiceWorker from \"./service-worker\"\nimport { loadState, saveState } from \"./storage/stored-state\"\nimport { TensegrityView } from \"./view/tensegrity-view\"\n\nexport async function startReact(eig: typeof import(\"eig\")): Promise<void> {\n    const root = document.getElementById(\"root\") as HTMLElement\n    const storedState$ = new BehaviorSubject(loadState(featureConfig, eig.default_fabric_feature))\n    storedState$.subscribe(newState => saveState(newState))\n    ReactDOM.render(\n        <TensegrityView\n            eig={eig}\n            floatFeatures={createFloatFeatures(storedState$, eig.default_fabric_feature)}\n            storedState$={storedState$}\n        />,\n        root,\n    )\n    registerServiceWorker()\n}\n\n"],"sourceRoot":""}