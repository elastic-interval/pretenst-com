{"version":3,"sources":["view/feature-mapping.ts","fabric/eig-util.ts","fabric/fabric-instance.ts","service-worker.ts","fabric/tensegrity-types.ts","fabric/tenscript-node.ts","fabric/tensegrity-logic.ts","fabric/twist-logic.ts","fabric/tensegrity.ts","fabric/tenscript.ts","storage/recoil.ts","view/bottom-left.tsx","storage/download.ts","view/bottom-right.tsx","view/materials.ts","view/live-view.tsx","view/look-view.tsx","view/interval-details.tsx","view/select-view.tsx","view/surface-component.tsx","construction/object-view.tsx","construction/construction-view.tsx","evo/island-geometry.ts","evo/genome.ts","evo/island.ts","evo/patch.ts","evo/evo-state.ts","evo/runner-logic.ts","evo/population.ts","evo/runner-view.tsx","evo/population-view.tsx","evo/island-view.tsx","evo/twitcher.ts","evo/runner.ts","evo/stats-view.tsx","evo/evo-view.tsx","fabric/bootstrap.ts","mobius/klein-builder.ts","mobius/klein-view.tsx","mobius/mobius-builder.ts","mobius/mobius-view.tsx","sphere/sphere-scaffold.ts","sphere/sphere-builder.ts","sphere/sphere-view.tsx","view/feature-slider.tsx","view/bottom-middle.tsx","view/fabric-view.tsx","view/script-panel.tsx","view/stage-button.tsx","view/top-left.tsx","view/top-middle.tsx","view/design-view.tsx","view/main-view.tsx","start.tsx"],"names":["FeatureStage","linearMapping","feature","name","featureStage","low","high","nuanceToPercent","nuance","percentToNuance","percent","percentToValue","default_world_feature","valueToPercent","value","featureMapping","WorldFeature","Gravity","Postslack","Antigravity","All","ShapingDrag","Preslack","ShapingStiffnessFactor","Drag","ShapingPretenstFactor","PretenstFactor","StiffnessFactor","IterationsPerFrame","IntervalCountdown","PretensingCountdown","VisualStrain","PushOverPull","Error","FORWARD","Vector3","UP","DOWN","ROOT3","WORLD_FEATURES","Object","keys","stageName","stage","Stage","Growing","Shaping","Slack","Pretensing","GlobalMode","GLOBAL_MODES","map","k","nameToUrl","replace","globalModeFromUrl","split","location","hash","substring","mode","find","m","param","length","reloadGlobalMode","Choice","reload","sub","a","b","subVectors","normalize","midpoint","points","mid","forEach","point","add","multiplyScalar","pointsToNormal","radials","copy","norm","index","current","next","crossVectors","vectorFromArray","array","vector","offset","set","FabricInstance","constructor","eig","featureValues","jointCount","worldObject","fabricObject","fabric","world","view","floatView","empty","Float32Array","intervalCount","faceCount","lineGeometry","BufferGeometry","faceGeometry","jointLocations","unitVectors","idealLengths","strains","strainLimits","strainNuances","stiffnesses","linearDensities","createEmptyFloatView","adoptFabric","valuesToApply","fabricBackup","this","key","entries","parseInt","set_float_value","free","View","on_fabric","Fabric","new","iterate","busy","refreshFloatView","shift","get_stage","requested","request_stage","console","error","showFrozen","satisfied","updateFloatView","clone","snapshot","log","fabricClone","restoreSnapshot","backup","render","midpoint_x","midpoint_y","midpoint_z","clear","applyFeature","immediate","push","jointLocation","joint","averageJointLocation","joints","reduce","accum","jointDistance","distanceTo","intervalLocation","alpha","omega","twistLocation","pushes","sum","intervalLength","faceLocation","face","ends","end","averageFaceLocation","faces","apply","matrix","apply_matrix4","toArray","unitVector","intervalIndex","frozen","get_joint_count","get_interval_count","get_face_count","dispose","lineLocations","copy_line_locations_to","setAttribute","Float32BufferAttribute","lineColors","fill","green","copy_line_colors_to","faceLocations","copy_face_vertex_locations_to","faceNormals","copy_face_normals_to","line","attributes","position","linePosition","needsUpdate","lineColor","color","facePosition","faceNormal","normal","copy_joint_locations_to","copy_unit_vectors_to","copy_ideal_lengths_to","copy_strains_to","copy_strain_limits_to","copy_strain_nuances_to","copy_stiffnesses_to","copy_linear_densities_to","isLocalhost","Boolean","window","hostname","match","register","navigator","URL","process","toString","origin","addEventListener","swUrl","fetch","then","response","status","headers","get","indexOf","serviceWorker","ready","registration","unregister","registerValidSW","catch","checkValidServiceWorker","onupdatefound","installingWorker","installing","onstatechange","state","controller","Spin","Left","Right","LeftRight","RightLeft","spinChange","spin","opposite","toOmni","FaceName","FACE_NAMES","B","C","D","c","d","A","isFaceNameChar","char","faceNameFromChar","expectPush","jointPulls","pulls","twoJointKey","pairKey","intervalRotation","unit","dot","Quaternion","setFromUnitVectors","areAdjacent","intervalJoins","acrossPush","otherJoint","interval","percentOrHundred","_","factorFromPercent","percentFromFactor","factor","TenscriptNode","forward","scale","subtrees","markNumbers","root","undefined","subtreeCode","markCode","action","afterNode","subtree","faceName","faceMarks","deleteMark","omniFaceNames","filter","some","hasScale","parts","join","v","code","marks","mark","flat","PULL_AA","tag","stiffness","PULL_BB","PULL_CONFLICT","filterRole","targetRole","role","bowtiePairs","tensegrity","pullARole","pullBRole","pairs","onlyA","onlyB","common","aj","bj","intersection","pullA","instance","withPulls","pairMap","addPair","pair","addPairFor","near","pullB","far","otherFar","otherNear","commonNear","commonFar","acrossFar","acrossNear","nextPair","intervals","joint3APush","found","faceJoint","a3A","outwards","fjA","sort","f1","f2","namedJob","age","job","todo","zeroFaces","n","upwards","b1","up","b2","x","y","z","xy","yz","zx","basisFromVector","Matrix4","makeBasis","setPosition","invert","set_altitude","conflicts","betweenDot","toAlpha","toOmega","jointA","pushA","jointB","pushB","otherA","otherB","findConflicts","createInterval","t","faceFromTwist","twist","adjacentPullsFromTwist","detailsSoFar","addFace","f0","removed","removeFace","pull","removeInterval","removeJoint","createSingle","base","leftSpin","pointPairs","createJoint","alphaJoint","omegaJoint","PUSH_A","makeFace","midJoint","j","PULL_A","reverse","PULL_B","createDouble","botPairs","topPairs","bot","top","PUSH_B","faceJoints","midJoints","midVector","fromMid","between","idx1","idx2","avg","addVectors","addScaledVector","createBase","pushesPerTwist","angle","Math","PI","cos","sin","FaceAction","PostGrowthOp","PairSelection","PULL_CONNECTOR","AGE_POST_GROWTH","PULL_PRETENST_DISTANCER","PULL_SHAPING_DISTANCER","PULL_RADIAL","Tensegrity","countdown","builder","stage$","loops","twists","connectors","distancers","pretenstAge","jobs","BehaviorSubject","operateOn","newJoint","create_joint","remove_joint","createRadialPull","pullScale","axis","creatAxis","alphaRestLength","omegaRestLength","alphaRays","createRay","omegaRays","radialPull","patience","targetLength","currentLength","patienceFactor","abs","attack","create_interval","changeIntervalScale","multiply_rest_length","existing","remove_interval","faceToTriangle","endA","endB","triangleFaces","work","addPull","intervalKey","intervalToPair","createPulls","pairSelection","Bowtie","Snelson","snelsonPair","acrossA","acrossB","snelsonPairs","selectPairs","removeSlackPulls","pullC","createTwist","baseKnown","createTwistOn","baseFace","createLoop","findTwist","f","concat","getValue","ray","jobsBefore","ageNow","finished","checkConnectors","Pretenst","strainToStiffness","averagePullStrain","strainFactor","copy_stiffnesses","createRadialPulls","actionScale","locationFromFace","centerBrickFaceIntervals","omniTwist","averageScaleFactor","opposing","closestFace","ShapingDistance","PretenstDistance","faceA","indexA","faceB","indexB","Join","connectFaces","alphaEnds","omegaEnds","ringLengths","rotation","ringLength","walk","rotatedWalk","bestRotation","minLength","rotateForBestRing","i","getIntervalDetails","strain","height","reverseA","forwardB","loop","a0","a1","idealLength","restLength","CONNECTOR_LENGTH","PHI","compileTenscript","tenscript","codeToNode","e","message","TenscriptBuilder","tree","markDefStrings","buds","set_surface_character","surfaceCharacter","toDo","postGrowthOp","Faces","BowtieFaces","postGrowthJob","createBud","before","activeBuds","bud","markActions","reorient","decremented","omni","needsOmniTwist","grow","middle","faceBasis","twirl","makeRotationZ","rotate","makeRotationY","multiply","reorientMatrix","treeMarks","twistMark","Subtree","markTree","execute","markStrings","markDefStringsToActions","collated","possibleMark","None","FaceStrategy","faceStrategies","strategy","markAction","startsWith","codeFragment","codeString","argument","content","skip","codeTree","addMark","markNumber","charAt","direction","isDigit","forwardArg","forwardCount","toNumber","repeat","scaleArg","faceNameChar","nonEmpty","afterTree","scaleChange","getSpin","newTwist","twistToMark","treeWithMarks","thisFace","digits","maybeBracketed","stripBrackets","commaPos","commaPresent","finalBracket","s","depth","matchBracket","contentOption","persistAtom","recoilPersist","storage","localStorage","effects_UNSTABLE","postGrowthAtom","atom","default","NoOp","bootstrapIndexAtom","tenscriptAtom","currentFeature","rotatingAtom","globalModeAtom","ViewMode","viewModeAtom","Time","FEATURE_VALUES","SurfaceCharacter","Frozen","mapping","percentAtom","selectedTwistAtom","visibleDetailsAtom","BottomLeft","viewMode","setViewMode","useRecoilState","ViewModeButton","item","children","Button","disabled","onClick","ButtonGroup","Select","Look","csvNumber","toFixed","dateString","Date","toISOString","getFabricOutput","pushRadius","pullRadius","jointRadius","radius","anchor","isPush","alphaIndex","omegaIndex","type","linearDensity","saveCSVZip","output","zip","JSZip","file","csvJoints","extractJointFile","csvIntervals","extractIntervalFile","csvSubmerged","extractSubmergedFile","generateAsync","mimeType","blob","FileSaver","BottomRight","updateStage","useState","useEffect","subscribe","unsubscribe","rotating","setRotating","className","JSON","stringify","saveJSONZip","centralize","RAINBOW_COLORS","Color","setHex","LINE_VERTEX_COLORS","LineBasicMaterial","vertexColors","MeshLambertMaterial","roleMaterial","ghost","roleColorString","roleColor","opacity","transparent","cylinderRadius","CYLINDER_GEOMETRY","CylinderGeometry","LiveView","geometry","material","LookView","intervalScale","Euler","setFromQuaternion","matrixWorldNeedsUpdate","IntervalDetails","details","singleDetails","Html","onMouseDown","Table","colSpan","SelectView","clickDetails","selected","setSelected","onDoubleClick","event","stopPropagation","again","MATERIAL","MeshPhongMaterial","specular","side","FrontSide","HEXAGON_POINTS","SURFACE_SCALE","KINDA","TRIANGLE_POSITION","SurfaceComponent","useMemo","positionF32","normalF32","faceOffset","BufferAttribute","patchesGeometry","ObjectView","aim","setAim","useFrame","toMidpoint","lengthSq","camera","distanceChange","towardsDistance","Rendering","OrbitControls","autoRotate","target","zoomSpeed","maxDistance","Stars","intensity","ConstructionView","createInstance","mainInstance","setTensegrity","setDetails","setPostGrowth","useSetRecoilState","emergency","ts","localValue","createTensegrity","Title","RecoilBridge","useRecoilBridgeAcrossReactRoots_UNSTABLE","style","left","right","backgroundColor","borderStyle","borderColor","cursor","borderWidth","id","PATCH_SURROUNDING_SHAPE","ADJACENT","SIN_60","PATCH_DISTANCE","SCALE_X","SCALE_Y","FAUNA_PATCH_COLOR","FLORA_PATCH_COLOR","SUN_POSITION","Genome","roll","genes","createReader","GeneReader","getGene","withMutations","directionGeneNames","mutateTwitchConfig","genesCopy","gene","geneName","tosses","dice","slice","directionName","mutateGene","twitchConfig","GeneName","TwitchConfig","geneString","die","symbol","serializeGene","chooseFrom","total","floor","diceToNuance","nextDie","readMuscleTwitch","config","attackPeriod","decayPeriod","twitchNuance","muscle","when","diceToInteger","diceToFloat","decay","readFeatureValue","DICE","numeral","DICE_MAP","max","woops","random","currentRoll","rollTheDice","pow","PatchCharacter","emptyGenome","fromGeneData","geneData","search","fresh","Patch","island","coords","patchCharacter","runner","flora","center","adjacent","getItem","parse","setItem","SIX","RUNNER_CODE","Bouncy","islandAtom","seed","patches","_seed","patch","findPatch","p","equals","createSurroundedPatch","getOrCreatePatch","surface","FaunaPatch","FloraPatch","homePatchSelector","selector","destinationAtom","showDetailsAtom","Direction","DIRECTIONS","directionGene","ToA","ToB","ToC","calculateDirections","toA","toB","toC","locations","fromTo","fromJoint","toJoint","from","to","EVO_PARAMETERS","EvolutionPhase","Population","ancestor","useTwitches","cyclePattern","snapshotsSubject","winners","challengersVisible","challengers","phase","SurvivorsAdvance","cyclePatternIndex","currentCycle","currentMaxCycles","embryo","storedGenes","createAutoRunner","letter","proximityHistory","persisted","pop","winnerMinCycles","winnerMoved","cycleCount","getCycleCount","rankEvolvers","reachedTarget","EvolutionDone","winner","ChallengersBorn","ChallengersReborn","genome","challenger","autopilot","ChallengersOvertake","parentIndex","survivorIndex","parent","recycled","mutatedGeneData","challengerMoved","challengerMinCycles","evolvers","broadcastSnapshot","evolver","rankedToSnapshot","SurvivorsStored","losers","splitEvolvers","EvolutionAdvance","allReachedTarget","EvolutionHarder","rankedEvolver","evolverSnapshots","cycle","cycleIndex","snapshots","alreadyHere","findIndex","distanceFromTarget","proximityForCycle","proximity","String","fromCharCode","RunnerView","topFaceLocation","showDirection","onUpdate","self","computeBoundingSphere","attach","attachObject","count","itemSize","quaternion","directionQuaternion","PopulationView","population","IslandView","happening","evolutionPhase","countdownToEvo","stopEvo","destination","setDestination","happeningChanged","updateHappeningChanged","now","updateNow","updateTarget","adjustTarget","clock","elapsedTime","approachDistance","distance","positionToTarget","deltaDistance","Happening","Developing","Resting","Running","Evolving","withReducedCyclePattern","wasSeconds","time","isSeconds","minDistance","enablePan","autoRotateSpeed","enableDamping","minPolarAngle","maxPolarAngle","positionArray","normalArray","removeRandomInterval","Rest","clickPatch","DoubleSide","Sky","rayleigh","inclination","mieCoefficient","mieDirectionalG","turbidity","Twitcher","twitchCount","twitchCycles","reader","musclePeriod","readTwitchConfig","totalTwitches","TwitchCycle","loopMuscles","cycles","tick","twitch","timeSlice","twitchCycle","activate","slices","chosen","splice","addTwitch","twitches","twitchArray","Runner","shapingTime","twitcher","topFace","currentTwitchAge","twitchAge","directionHistory","twitchesPerCycle","auto","geneNames","dir","newTwitchAge","twitchInterval","twitch_interval","alphaInterval","omegaInterval","checkDirection","sortedFaces","aa","bb","locA","locB","findTopFace","alphaPulls","omegaPulls","onlyMuscles","extractLoopMuscles","targetPatch","quaternionForDirection","directionToTarget","towards","toTarget","matchA","matchB","matchC","StatsView","setShowStats","EvolutionInfo","evolverSnapshot","mutationSymbols","nameLength","reachedSymbol","borderRadius","marginBottom","padding","display","whiteSpace","margin","EvoView","createBodyInstance","homePatch","useRecoilValue","showStats","setRunner","newRunner","setHappening","setSnapshots","evolutionCountdown","setEvolutionCountdown","setPopulation","setPhase","storedGenome","Sticky","err","newStage","evolveWithPattern","toEvolve","pattern","nextEvolution","ControlButtons","evoCountdown","toRunning","toEvolving","toRebirth","toRest","EvolutionStatsView","vertical","createContent","BOOTSTRAP","1","2","3","4","5","6","0","CONSTRUCTIONS","PUSH","PULL","KleinBuilder","width","randomJoint","createFace","j0","j1","j2","create_face","kleinJoint","xRelative","xModulo","yModulo","jointIndex","meshLambertMaterial","KleinView","createKlein","setHeight","setWidth","setFrozen","drag","setDrag","generate","toInt","klein","setKlein","Form","onSubmit","preventDefault","FormGroup","Label","for","Input","valid","isValidHeight","invalid","onChange","isValidWidth","KleinScene","setTarget","matrixAutoUpdate","PerspectiveCamera","makeDefault","isNaN","parsed","PULL_WIDTH","PULL_LENGTH","MobiusBuilder","segments","bottom","major","minor","MobiusView","createMobius","mobius","muscles","unordered","even","odd","MobiusScene","muscleIndex","setMuscleIndex","twitchTime","setTwitchTime","r","h","idx","SphereScaffold","frequency","vertices","VERTEX","vertexAt","EDGE","edge","midVertices","v0","v1","midEdge","vertexBetween","FACE_EDGES","faceEdge","side0","side1","side2","buildFaces","buildEdgeVertices","sortVertex","edgeVertices","edgeVertexIndex","verticesOfEdge","vertex","previousVertex","loc0","loc1","spot","lerpVectors","faceVertexArrays","FACE_VERTICES","faceVertexIndex","faceIndex","faceVertex","which","walkA","vectorA","walkB","v2","vectorB","row","rowMember","vert","sideVertices","antiWalk","walkSide","faceEdges","vsVertex","PENTAGON_VERTICES","vertexArray","edgeVertexA","front","edgeVertexB","lerp","ONE","outward","first","sorted","vectorTo","neigbor","toAdjacent","toTop","adj","SphereBuilder","useCurves","scaffold","hubs","spokes","allSpokes","createCurve","createPush","spoke","segmentLength","averageIntervalLength","allPulls","hub","pullsForSpoke","setFromAxisAngle","alphaLocation","applyQuaternion","omegaLocation","alphaVertex","omegaVertex","midAlphaJoint","midOmegaJoint","pushScale","createPull","pullName","nextSpoke","nearOppositeNext","spokeLength","colorString","PUSH_MATERIAL","PULL_MATERIAL","FREQUENCY_CHOICES","showPushAtom","showPullAtom","frozenAtom","gravityAtom","useCurvesAtom","SphereView","frequencyParam","createSphere","frequencyChoice","showPush","setShowPush","showPull","setShowPull","gravity","setGravity","sphere","setSphere","freq","Sphere","SphereScene","SPHERE_RADIUS","PolygonView","CYLINDER","domain","FeatureSlider","sliderValue","setPercent","values","setValues","round","percentString","numeric","expo","toExponential","zero","floatString","step","rootStyle","sliderStyle","newValues","getRailProps","handles","getHandleProps","handle","Handle","tracks","getTrackProps","source","Track","min","aria-valuemin","aria-valuemax","aria-valuenow","BottomMiddle","open","setOpen","worldFeature","setWorldFeature","featureValue","setFeatureValue","ButtonDropdown","isOpen","toggle","DropdownToggle","DropdownMenu","DropdownItem","AMBIENT_COLOR","FabricView","updateAim","ScriptPanel","runTenscript","setTenscript","postGrowth","json","setJson","setError","toJson","flexDirection","changeEvent","newTenscript","StageTransition","STAGE_TRANSITIONS","StageButton","stageTransition","allDisabledExcept","stageAccepted","doNow","CaptureLengthsToSlack","Symbol","SlackToPretensing","CapturePretenstToSlack","CaptureStrainForStiffness","TopLeft","setBootstrapIndex","showScriptPanel","setShowScriptPanel","bootstrapOpen","setBootstrapOpen","run","pgo","opChanged","opColor","bootstrapProgram","TopMiddle","DesignView","worldFeatures","bootstrapIndex","intervalCountdown","removeItem","MainView","globalMode","visit","url","Design","Construction","Evolution","g","Mobius","Klein","set_push_and_pull","size","async","startReact","element","document","getElementById","ReactDOM","registerServiceWorker"],"mappings":"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","file":"static/js/4.ffa57050.chunk.js","sourcesContent":["/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { default_world_feature, WorldFeature } from \"eig\"\n\nexport enum FeatureStage {\n    Preslack,\n    Postslack,\n    All,\n}\n\nexport interface IFeatureMapping {\n    feature: WorldFeature\n    name: string\n    featureStage: FeatureStage\n    nuanceToPercent: (nuance: number) => number\n    percentToNuance: (percent: number) => number\n    percentToValue: (percent: number) => number\n    valueToPercent: (value: number) => number\n}\n\nfunction linearMapping(feature: WorldFeature, name: string, featureStage: FeatureStage, low: number, high: number): IFeatureMapping {\n    const nuanceToPercent = (nuance: number) => (low * (1 - nuance) + high * nuance)\n    const percentToNuance = (percent: number) => (percent - low) / (high - low)\n    const percentToValue = (percent: number) => default_world_feature(feature) * percent / 100\n    const valueToPercent = (value: number) => value / default_world_feature(feature) * 100\n    return {feature, name, featureStage, nuanceToPercent, percentToNuance, percentToValue, valueToPercent}\n}\n\nexport function featureMapping(feature: WorldFeature): IFeatureMapping {\n    switch (feature) {\n        case WorldFeature.Gravity:\n            // percents: [0, 10, 25, 50, 100, 200, 500, 1000],\n            return linearMapping(feature, \"Gravity\", FeatureStage.Postslack, 0, 1000)\n        case WorldFeature.Antigravity:\n            // percents: [5, 25, 50, 100, 150, 200, 500],\n            return linearMapping(feature, \"-Antigravity\", FeatureStage.All, 5, 500)\n        case WorldFeature.ShapingDrag:\n            // percents: [0, 10, 50, 100, 200, 500],\n            return linearMapping(feature, \"Shaping Drag\", FeatureStage.Preslack, 0, 500)\n        case WorldFeature.ShapingStiffnessFactor:\n            // percents: [10, 50, 100, 200, 300, 500, 1000],\n            return linearMapping(feature, \"Shaping Stiffness\", FeatureStage.Preslack, 10, 1000)\n        case WorldFeature.Drag:\n            // percents: [0, 10, 50, 100, 150, 200, 500, 1000],\n            return linearMapping(feature, \"Drag\", FeatureStage.Postslack, 0, 1000)\n        case WorldFeature.ShapingPretenstFactor:\n            // percents: [0, 5,  25, 50, 100, 200, 500, 1000],\n            return linearMapping(feature, \"Shaping Pretenst\", FeatureStage.Preslack, 0, 1000)\n        case WorldFeature.PretenstFactor:\n            // percents: [0, 50, 90, 100, 125, 150, 200, 300, 500],\n            return linearMapping(feature, \"Pretenst Factor\", FeatureStage.Postslack, 0, 500)\n        case WorldFeature.StiffnessFactor:\n            // percents: [1, 10, 50, 100, 150, 200, 300],\n            return linearMapping(feature, \"Stiffness\", FeatureStage.Postslack, 1, 300)\n        case WorldFeature.IterationsPerFrame:\n            // percents: [2, 10, 25, 50, 100, 200, 300, 500],\n            return linearMapping(feature, \"Iterations/frame\", FeatureStage.All, 2, 500)\n        case WorldFeature.IntervalCountdown:\n            // percents: [10, 20, 30, 100, 150, 400, 1000],\n            return linearMapping(feature, \"-Interval Countdown\", FeatureStage.Preslack, 10, 1000)\n        case WorldFeature.PretensingCountdown:\n            // percents: [50, 75, 90, 100, 125, 150, 200],\n            return linearMapping(feature, \"-Pretenst countdown\", FeatureStage.All, 50, 200)\n        case WorldFeature.VisualStrain:\n            // percents: [0, 10, 50, 100, 200, 300, 500, 1000],\n            return linearMapping(feature, \"Visual strain\", FeatureStage.All, 0, 300)\n        case WorldFeature.PushOverPull:\n            // percents: [10, 25, 50, 100, 200, 300, 400, 500, 600, 700],\n            return linearMapping(feature, \"Push/Pull\", FeatureStage.All, 10, 700)\n        default:\n            throw new Error(\"Feature?\")\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Stage, WorldFeature } from \"eig\"\nimport { Vector3 } from \"three\"\n\nexport const FORWARD = new Vector3(1, 0, 0)\nexport const RIGHT = new Vector3(0, 0, 1)\nexport const UP = new Vector3(0, 1, 0)\nexport const DOWN = new Vector3(0, -1, 0)\n\nexport const CONNECTOR_LENGTH = 0.05\n\nexport const ROOT3 = 1.732050807568877\nexport const ROOT5 = 2.23606797749979\nexport const PHI = (1 + ROOT5) / 2\nexport const ROOT6 = 2.44948974278\nexport const SHORTENING = 0.5\n\nexport function doNotClick(stage: Stage): boolean {\n    return stage === Stage.Growing || stage === Stage.Slack\n}\n\nexport const WORLD_FEATURES: string[] = Object.keys(WorldFeature)\n\nexport function stageName(stage: Stage): string {\n    switch (stage) {\n        case Stage.Growing:\n            return \"Growing\"\n        case Stage.Shaping:\n            return \"Shaping\"\n        case Stage.Slack:\n            return \"Slack\"\n        case Stage.Pretensing:\n            return \"Pretensing\"\n        default:\n            return \"Pretenst\"\n    }\n}\n\nexport enum GlobalMode {\n    Choice = \"choice\",\n    Design = \"design\",\n    Sphere = \"sphere\",\n    Mobius = \"mobius\",\n    Klein = \"klein\",\n    Construction = \"construction\",\n    Evolution = \"evolution\",\n}\n\nexport const GLOBAL_MODES: GlobalMode[] = Object.keys(GlobalMode).map(k => GlobalMode[k])\n\nexport interface IGlobalMode {\n    mode: GlobalMode,\n    param?: string\n}\n\nexport function nameToUrl(name: string): string {\n    return name.replace(/ /g, \"-\")\n}\n\nexport function globalModeFromUrl(): IGlobalMode {\n    const hash = location.hash.substring(1)\n    const split = hash.split(\";\")\n    const mode = GLOBAL_MODES.find(m => m === split[0])\n    if (mode) {\n        const param = split.length > 1 ? split[1] : \"\"\n        return {mode, param}\n    }\n    return reloadGlobalMode(GlobalMode.Choice)\n}\n\nexport function reloadGlobalMode(mode: GlobalMode, param?: string): IGlobalMode {\n    location.hash = param && param.length > 0 ? `${mode};${param}` : mode\n    location.reload()\n    return {mode, param}\n}\n\nexport function floatString(numeric: number): string {\n    const expo = numeric.toExponential(3)\n    const zero = expo.indexOf(\"e+0\")\n    if (zero > 0) {\n        return expo.substring(0, zero)\n    }\n    const minus = Math.max(expo.indexOf(\"e-1\"), expo.indexOf(\"e-2\"))\n    if (minus > 0) {\n        return numeric.toFixed(3)\n    }\n    const plus = Math.max(expo.indexOf(\"e+1\"), expo.indexOf(\"e+2\"), expo.indexOf(\"e+3\"))\n    if (plus > 0) {\n        return numeric.toFixed(1)\n    }\n    return expo\n}\n\nexport function percentString(percent: number): string {\n    if (percent <= 100) {\n        return `${percent.toFixed(0)}%`\n    } else {\n        return `${(percent / 100).toFixed(1)}x`\n    }\n}\n\nexport function vectorString({x, y, z}: Vector3): string {\n    const digits = 2\n    return `(${x.toFixed(digits)}, ${y.toFixed(digits)}, ${z.toFixed(digits)})`\n}\n\nexport function sub(a: Vector3, b: Vector3): Vector3 {\n    return new Vector3().subVectors(a, b).normalize()\n}\n\nexport function avg(a: Vector3, b: Vector3): Vector3 {\n    return new Vector3().addVectors(a, b).normalize()\n}\n\nexport function midpoint(points: Vector3[]): Vector3 {\n    const mid = new Vector3()\n    points.forEach(point => mid.add(point))\n    return mid.multiplyScalar(1 / points.length)\n}\n\nexport function pointsToNormal(points: Vector3 []): Vector3 {\n    const mid = midpoint(points)\n    const radials = points.map(point => new Vector3().copy(point).sub(mid))\n    const norm = new Vector3()\n    for (let index = 0; index < radials.length; index++) {\n        const current = radials[index]\n        const next = radials[(index + 1) % radials.length]\n        norm.add(new Vector3().crossVectors(current, next).normalize())\n    }\n    return norm.normalize()\n}\n\nexport function vectorFromArray(array: Float32Array, index: number, vector?: Vector3): Vector3 {\n    const offset = index * 3\n    if (vector) {\n        vector.set(array[offset], array[offset + 1], array[offset + 2])\n        return vector\n    } else {\n        return new Vector3(array[offset], array[offset + 1], array[offset + 2])\n    }\n}\n\nexport function basisFromVector(up: Vector3): { b1: Vector3, up: Vector3, b2: Vector3 } {\n    const {x, y, z} = up\n    const xy = x * x + y * y\n    const yz = y * y + z * z\n    const zx = z * z + x * x\n    const b1 = new Vector3()\n    if (xy > yz && xy > zx) {\n        b1.set(-y, x, 0).normalize()\n    } else if (yz > xy && yz > zx) {\n        b1.set(0, -z, y).normalize()\n    } else {\n        b1.set(-z, 0, x).normalize()\n    }\n    const b2 = new Vector3().crossVectors(up, b1).normalize()\n    return {b1, up, b2}\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Fabric, Stage, View, World, WorldFeature } from \"eig\"\nimport { BufferGeometry, Float32BufferAttribute, Matrix4, Vector3 } from \"three\"\n\nimport { featureMapping } from \"../view/feature-mapping\"\n\nimport { midpoint, vectorFromArray } from \"./eig-util\"\nimport { IInterval, IJoint, ITwist, ITwistFace } from \"./tensegrity-types\"\n\nexport interface IFloatView {\n    jointCount: number\n    intervalCount: number\n    faceCount: number\n    lineGeometry: BufferGeometry\n    faceGeometry: BufferGeometry\n    jointLocations: Float32Array\n    unitVectors: Float32Array\n    idealLengths: Float32Array\n    strains: Float32Array\n    strainLimits: Float32Array\n    strainNuances: Float32Array\n    stiffnesses: Float32Array\n    linearDensities: Float32Array\n}\n\nexport type CreateInstance = (featureValues?: Record<WorldFeature, number>, existingFabric?: Fabric) => FabricInstance\n\nexport class FabricInstance {\n    public fabric: Fabric\n    public world: World\n    public view: View\n    public floatView: IFloatView = createEmptyFloatView()\n    public adoptFabric: (fabric: Fabric) => FabricInstance\n    public midpoint = new Vector3(0, 0, 0)\n\n    private valuesToApply: ICurrentValue[] = []\n    private fabricBackup?: Fabric\n\n    constructor(\n        eig: typeof import(\"eig\"),\n        featureValues: Record<WorldFeature, number>,\n        jointCount: number,\n        // eslint-disable-next-line @typescript-eslint/ban-types\n        worldObject: object,\n        // eslint-disable-next-line @typescript-eslint/ban-types\n        fabricObject?: object,\n    ) {\n        this.world = worldObject as World\n        for (const [key, percent] of Object.entries(featureValues)) {\n            const feature = parseInt(key, 10)\n            const {percentToValue} = featureMapping(feature)\n            const value = percentToValue(percent)\n            this.world.set_float_value(feature, value)\n        }\n        this.adoptFabric = (fabric) => {\n            this.free()\n            this.fabric = fabric\n            this.view = eig.View.on_fabric(fabric)\n            return this\n        }\n        this.adoptFabric(fabricObject ? fabricObject as Fabric : eig.Fabric.new(jointCount))\n    }\n\n    public iterate(): boolean {\n        const busy = this.fabric.iterate(this.world)\n        this.refreshFloatView()\n        const current = this.valuesToApply.shift()\n        if (current) {\n            this.world.set_float_value(current.feature, current.value)\n        }\n        return busy\n    }\n\n    public get stage(): Stage {\n        return this.fabric.get_stage()\n    }\n\n    public set stage(requested: Stage) {\n        const stage = this.fabric.request_stage(requested, this.world)\n        if (!stage) {\n            console.error(`Could not move to stage ${requested}!`)\n        }\n    }\n\n    public showFrozen(satisfied: boolean): void {\n        this.updateFloatView(true, satisfied)\n    }\n\n    public get fabricClone(): Fabric {\n        return this.fabric.clone()\n    }\n\n    public snapshot(): void {\n        console.log(\"snapshot\")\n        this.fabricBackup = this.fabricClone\n    }\n\n    public restoreSnapshot(): void {\n        console.log(\"restoreSnapshot\")\n        const backup = this.fabricBackup\n        if (!backup) {\n            throw new Error(\"Missing backup\")\n        }\n        this.adoptFabric(backup.clone())\n    }\n\n    public refreshFloatView(): void {\n        this.view.render(this.fabric, this.world)\n        this.midpoint.set(this.view.midpoint_x(), this.view.midpoint_y(), this.view.midpoint_z())\n        this.updateFloatView(false, false)\n    }\n\n    public clear(): FabricInstance {\n        this.fabric.clear()\n        this.refreshFloatView()\n        return this\n    }\n\n    public applyFeature({feature, percent, value}: ICurrentValue, immediate: boolean): void {\n        if (immediate) {\n            this.world.set_float_value(feature, value)\n        } else {\n            this.valuesToApply.push({feature, percent, value})\n        }\n    }\n\n    public jointLocation(joint: IJoint): Vector3 {\n        return vectorFromArray(this.floatView.jointLocations, joint.index)\n    }\n\n    public averageJointLocation(joints: IJoint[]): Vector3 {\n        return joints\n            .reduce((accum, joint) => accum.add(this.jointLocation(joint)), new Vector3())\n            .multiplyScalar(1 / joints.length)\n    }\n\n    public jointDistance(a: IJoint, b: IJoint): number {\n        return this.jointLocation(a).distanceTo(this.jointLocation(b))\n    }\n\n    public intervalLocation({alpha, omega}: IInterval): Vector3 {\n        return this.jointLocation(alpha).add(this.jointLocation(omega)).multiplyScalar(0.5)\n    }\n\n    public twistLocation({pushes}: ITwist): Vector3 {\n        return pushes\n            .reduce((sum, push) => sum.add(this.intervalLocation(push)), new Vector3())\n            .multiplyScalar(1 / pushes.length)\n    }\n\n    public intervalLength({alpha, omega}: IInterval): number {\n        return this.jointDistance(alpha, omega)\n    }\n\n    public faceLocation(face: ITwistFace): Vector3 {\n        return midpoint(face.ends.map(end => this.jointLocation(end)))\n    }\n\n    public averageFaceLocation(faces: ITwistFace[]): Vector3 {\n        return faces\n            .reduce((accum, face) => accum.add(this.faceLocation(face)), new Vector3())\n            .multiplyScalar(1 / faces.length)\n    }\n\n    public apply(matrix: Matrix4): void {\n        this.fabric.apply_matrix4(new Float32Array(matrix.toArray()))\n        this.refreshFloatView()\n    }\n\n    public unitVector(intervalIndex: number): Vector3 {\n        return vectorFromArray(this.floatView.unitVectors, intervalIndex)\n    }\n\n    public free(): void {\n        const fabric = this.fabric\n        if (fabric) {\n            fabric.free()\n        }\n        const view = this.view\n        if (view) {\n            view.free()\n        }\n    }\n\n    private updateFloatView(frozen: boolean, satisfied: boolean): void {\n        const fabric = this.fabric\n        const view = this.view\n        const jointCount = fabric.get_joint_count()\n        const intervalCount = fabric.get_interval_count()\n        const faceCount = fabric.get_face_count()\n        const floatView = this.floatView\n        const dimensionChange = floatView.jointCount !== jointCount || floatView.intervalCount !== intervalCount || floatView.faceCount !== faceCount\n        if (dimensionChange) {\n            // console.log(`j(${floatView.jointCount}=>${jointCount}) i(${floatView.intervalCount}=>${intervalCount}) f(${floatView.faceCount}=>${faceCount})`)\n            floatView.jointCount = jointCount\n            floatView.intervalCount = intervalCount\n            floatView.faceCount = faceCount\n            floatView.lineGeometry.dispose()\n            floatView.lineGeometry = new BufferGeometry()\n            const lineLocations = new Float32Array(intervalCount * 3 * 2)\n            view.copy_line_locations_to(lineLocations)\n            floatView.lineGeometry.setAttribute(\"position\", new Float32BufferAttribute(lineLocations, 3))\n            const lineColors = new Float32Array(intervalCount * 3 * 2)\n            if (frozen) {\n                if (satisfied) {\n                    lineColors.fill(0)\n                    for (let green = 1; green < lineColors.length; green += 3) {\n                        lineColors[green] = 1\n                    }\n                } else {\n                    lineColors.fill(1)\n                }\n            } else {\n                view.copy_line_colors_to(lineColors)\n            }\n            floatView.lineGeometry.setAttribute(\"color\", new Float32BufferAttribute(lineColors, 3))\n            floatView.faceGeometry.dispose()\n            floatView.faceGeometry = new BufferGeometry()\n            const faceLocations = new Float32Array(faceCount * 3 * 3)\n            view.copy_face_vertex_locations_to(faceLocations)\n            floatView.faceGeometry.setAttribute(\"position\", new Float32BufferAttribute(faceLocations, 3))\n            const faceNormals = new Float32Array(faceCount * 3 * 3)\n            view.copy_face_normals_to(faceNormals)\n            floatView.faceGeometry.setAttribute(\"normal\", new Float32BufferAttribute(faceNormals, 3))\n            floatView.jointLocations = new Float32Array(jointCount * 3)\n            floatView.unitVectors = new Float32Array(intervalCount * 3)\n            floatView.idealLengths = new Float32Array(intervalCount)\n            floatView.strains = new Float32Array(intervalCount)\n            floatView.strainNuances = new Float32Array(intervalCount)\n            floatView.stiffnesses = new Float32Array(intervalCount)\n            floatView.linearDensities = new Float32Array(intervalCount)\n        } else {\n            const line = this.floatView.lineGeometry.attributes\n            const face = this.floatView.faceGeometry.attributes\n            if (line.position) {\n                // console.log(`j(${floatView.jointCount}) i(${floatView.intervalCount}) f(${floatView.faceCount})`)\n                const linePosition = line.position as Float32BufferAttribute\n                view.copy_line_locations_to(linePosition.array as Float32Array)\n                linePosition.needsUpdate = true\n                const lineColor = line.color as Float32BufferAttribute\n                const lineColors = lineColor.array as Float32Array\n                if (frozen) {\n                    if (satisfied) {\n                        lineColors.fill(0)\n                        for (let green = 1; green < lineColors.length; green += 3) {\n                            lineColors[green] = 1\n                        }\n                    } else {\n                        lineColors.fill(1)\n                    }\n                } else {\n                    view.copy_line_colors_to(lineColors)\n                }\n                lineColor.needsUpdate = true\n                const facePosition = face.position as Float32BufferAttribute\n                view.copy_face_vertex_locations_to(facePosition.array as Float32Array)\n                facePosition.needsUpdate = true\n                const faceNormal = face.normal as Float32BufferAttribute\n                view.copy_face_normals_to(faceNormal.array as Float32Array)\n                faceNormal.needsUpdate = true\n            }\n        }\n        view.copy_joint_locations_to(floatView.jointLocations)\n        view.copy_unit_vectors_to(floatView.unitVectors)\n        view.copy_ideal_lengths_to(floatView.idealLengths)\n        view.copy_strains_to(floatView.strains)\n        view.copy_strain_limits_to(floatView.strainLimits)\n        view.copy_strain_nuances_to(floatView.strainNuances)\n        view.copy_stiffnesses_to(floatView.stiffnesses)\n        view.copy_linear_densities_to(floatView.linearDensities)\n    }\n}\n\nfunction createEmptyFloatView(): IFloatView {\n    const empty = new Float32Array(0)\n    const jointCount = 0\n    const intervalCount = 0\n    const faceCount = 0\n    return {\n        jointCount, intervalCount, faceCount,\n        lineGeometry: new BufferGeometry(), faceGeometry: new BufferGeometry(),\n        jointLocations: empty, unitVectors: empty, idealLengths: empty,\n        strains: empty, strainLimits: new Float32Array(4), strainNuances: empty,\n        stiffnesses: empty, linearDensities: empty,\n    }\n}\n\nexport interface ICurrentValue {\n    feature: WorldFeature\n    percent: number\n    value: number\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\n// tslint:disable:no-console\n// In production, we register a service worker to serve assets from local cache.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on the 'N+1' visit to a page, since previously\n// cached resources are updated in the background.\n\n// To learn more about the benefits of this model, read https://goo.gl/KwvDNy.\n// This link also includes instructions on opting out of this behavior.\n\nconst isLocalhost = Boolean(\n    window.location.hostname === \"localhost\" ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === \"[::1]\" ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n        /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/,\n    ),\n)\n\nexport default function register(): void {\n    if (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n        // The URL constructor is available in all browsers that support SW.\n        const publicUrl = new URL(\n            process.env.PUBLIC_URL!,\n            window.location.toString(),\n        )\n        if (publicUrl.origin !== window.location.origin) {\n            // Our service worker won't work if PUBLIC_URL is on a different origin\n            // from what our page is served on. This might happen if a CDN is used to\n            // serve assets; see https://github.com/facebookincubator/create-react-app/issues/2374\n            return\n        }\n\n        window.addEventListener(\"load\", () => {\n            const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`\n\n            if (isLocalhost) {\n                // This is running on localhost. Lets check if a service worker still exists or not.\n                checkValidServiceWorker(swUrl)\n\n                // Add some additional logging to localhost, pointing developers to the\n                // service worker/PWA documentation.\n                navigator.serviceWorker.ready.then(() => {\n                    console.log(\n                        \"This web app is being served cache-first by a service \" +\n                        \"worker. To learn more, visit https://goo.gl/SC7cgQ\",\n                    )\n                })\n            } else {\n                // Is not local host. Just register service worker\n                registerValidSW(swUrl)\n            }\n        })\n    }\n}\n\nfunction registerValidSW(swUrl: string): void {\n    navigator.serviceWorker\n        .register(swUrl)\n        .then(registration => {\n            registration.onupdatefound = () => {\n                const installingWorker = registration.installing\n                if (installingWorker) {\n                    installingWorker.onstatechange = () => {\n                        if (installingWorker.state === \"installed\") {\n                            if (navigator.serviceWorker.controller) {\n                                // At this point, the old content will have been purged and\n                                // the fresh content will have been added to the cache.\n                                // It's the perfect time to display a 'New content is\n                                // available; please refresh.' message in your web app.\n                                console.log(\"New content is available; please refresh.\")\n                            } else {\n                                // At this point, everything has been precached.\n                                // It's the perfect time to display a\n                                // 'Content is cached for offline use.' message.\n                                console.log(\"Content is cached for offline use.\")\n                            }\n                        }\n                    }\n                }\n            }\n        })\n        .catch(error => {\n            console.error(\"Error during service worker registration:\", error)\n        })\n}\n\nfunction checkValidServiceWorker(swUrl: string): void {\n    // Check if the service worker can be found. If it can't reload the page.\n    fetch(swUrl)\n        .then(response => {\n            // Ensure service worker exists, and that we really are getting a JS file.\n            if (\n                response.status === 404 ||\n                response.headers.get(\"content-type\")!.indexOf(\"javascript\") === -1\n            ) {\n                // No service worker found. Probably a different app. Reload the page.\n                navigator.serviceWorker.ready.then(registration => {\n                    registration.unregister().then(() => {\n                        window.location.reload()\n                    })\n                })\n            } else {\n                // Service worker found. Proceed as normal.\n                registerValidSW(swUrl)\n            }\n        })\n        .catch(() => {\n            console.log(\n                \"No internet connection found. App is running in offline mode.\",\n            )\n        })\n}\n\nexport function unregister(): void {\n    if (\"serviceWorker\" in navigator) {\n        navigator.serviceWorker.ready.then(registration => {\n            registration.unregister()\n        })\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Matrix4, Quaternion, Vector3 } from \"three\"\n\nimport { DOWN, sub, UP } from \"./eig-util\"\nimport { FabricInstance } from \"./fabric-instance\"\n\nexport enum Spin {\n    Left = \"Left\",\n    Right = \"Right\",\n    LeftRight = \"Left-Right\",\n    RightLeft = \"Right-Left\",\n}\n\nexport const SPINS = [Spin.Left, Spin.Right, Spin.LeftRight, Spin.RightLeft]\n\nexport function spinChange(spin: Spin, opposite: boolean, toOmni: boolean): Spin {\n    if (opposite) {\n        switch (spin) {\n            case Spin.Left:\n                return toOmni ? Spin.RightLeft : Spin.Right\n            case Spin.Right:\n                return toOmni ? Spin.LeftRight : Spin.Left\n            case Spin.LeftRight:\n                return Spin.RightLeft\n            case Spin.RightLeft:\n                return Spin.LeftRight\n        }\n    } else {\n        switch (spin) {\n            case Spin.Left:\n                return toOmni ? Spin.LeftRight : spin\n            case Spin.Right:\n                return toOmni ? Spin.RightLeft : spin\n            case Spin.LeftRight:\n            case Spin.RightLeft:\n                return spin\n        }\n    }\n    throw new Error(\"Spin?\")\n}\n\nexport function isOmniSpin(spin: Spin): boolean {\n    switch (spin) {\n        case Spin.LeftRight:\n        case Spin.RightLeft:\n            return true\n    }\n    return false\n}\n\nexport enum FaceName {a = 0, B, C, D, b, c, d, A}\n\nexport const FACE_NAMES = [FaceName.a, FaceName.B, FaceName.C, FaceName.D, FaceName.b, FaceName.c, FaceName.d, FaceName.A]\n\nexport const FACE_NAME_CHARS = \"aBCDbcdA\"\n\nexport function isFaceNameChar(char: string): boolean {\n    return FACE_NAME_CHARS.indexOf(char) >= 0\n}\n\nexport function faceNameFromChar(char: string): FaceName {\n    const index = FACE_NAME_CHARS.indexOf(char)\n    if (index < 0) {\n        throw new Error(`[${char}] is not a face name`)\n    }\n    return FACE_NAMES[index]\n}\n\nexport interface IJoint {\n    index: number\n    push?: IInterval\n    pulls?: IInterval[]\n}\n\nexport function expectPush({push}: IJoint): IInterval {\n    if (!push) {\n        throw new Error(\"Expected push\")\n    }\n    return push\n}\n\nexport function jointPulls({pulls}: IJoint): IInterval[] {\n    if (!pulls) {\n        throw new Error(\"no pulls\")\n    }\n    return pulls\n}\n\nexport interface IIntervalDetails {\n    interval: IInterval\n    strain: number\n    length: number\n    height: number\n}\n\nfunction indexKey(a: number, b: number): string {\n    return a < b ? `(${a},${b})` : `(${b},${a})`\n}\n\nexport function twoJointKey(alpha: IJoint, omega: IJoint): string {\n    return indexKey(alpha.index, omega.index)\n}\n\nexport interface IPair {\n    alpha: IJoint\n    omega: IJoint\n    scale: IPercent\n    role: IRole\n}\n\nexport function pairKey({alpha, omega}: IPair): string {\n    return twoJointKey(alpha, omega)\n}\n\nexport interface IRole {\n    tag: string\n    push: boolean\n    length: number\n    stiffness: number\n}\n\nexport interface IInterval {\n    index: number\n    removed: boolean\n    role: IRole\n    scale: IPercent\n    alpha: IJoint\n    omega: IJoint\n}\n\nexport function intervalRotation(unit: Vector3): Quaternion {\n    const dot = UP.dot(unit)\n    return new Quaternion().setFromUnitVectors(dot > 0 ? UP : DOWN, unit)\n}\n\nexport function areAdjacent(a: IInterval, b: IInterval): boolean {\n    if (a.index === b.index) {\n        return false\n    }\n    return a.alpha.index === b.alpha.index\n        || a.omega.index === b.omega.index\n        || a.alpha.index === b.omega.index\n        || a.omega.index === b.alpha.index\n}\n\nexport function intervalToPair({alpha, omega, scale, role}: IInterval): IPair {\n    return {alpha, omega, scale, role}\n}\n\nexport function intervalKey({alpha, omega}: IInterval): string {\n    return twoJointKey(alpha, omega)\n}\n\nexport function intervalJoins(a: IJoint, b: IJoint): (interval: IInterval) => boolean {\n    return ({alpha, omega}: IInterval) =>\n        alpha.index === a.index && omega.index === b.index || omega.index === a.index && alpha.index === b.index\n}\n\nexport function intervalToString({role, alpha, omega}: IInterval): string {\n    return `${role.tag}/${alpha.index}:${omega.index}`\n}\n\nexport function acrossPush(joint: IJoint): IJoint {\n    if (!joint.push) {\n        throw new Error(\"No push\")\n    }\n    const push = joint.push\n    if (push.alpha.index === joint.index) {\n        return push.omega\n    }\n    if (push.omega.index === joint.index) {\n        return push.alpha\n    }\n    throw new Error(\"Big problem\")\n}\n\nexport function otherJoint(joint: IJoint, interval: IInterval): IJoint {\n    if (interval.alpha.index === joint.index) {\n        return interval.omega\n    }\n    if (interval.omega.index === joint.index) {\n        return interval.alpha\n    }\n    throw new Error(\"No other joint\")\n}\n\nexport interface IMarkNumber {\n    _: number\n}\n\nexport interface IRadialPull {\n    alpha: ITwistFace\n    omega: ITwistFace\n    axis: IInterval,\n    alphaRays: IInterval[],\n    omegaRays: IInterval[],\n}\n\nexport function rotateForBestRing(instance: FabricInstance, alpha: ITwistFace, omega: ITwistFace): void {\n    const alphaEnds = [...alpha.ends].reverse()\n    const omegaEnds = omega.ends\n    const ringLengths: number[] = []\n    for (let rotation = 0; rotation < alphaEnds.length; rotation++) {\n        let ringLength = 0\n        for (let walk = 0; walk < alphaEnds.length; walk++) {\n            const rotatedWalk = (walk + rotation) % alphaEnds.length\n            ringLength += instance.jointDistance(alphaEnds[walk], omegaEnds[rotatedWalk])\n            ringLength += instance.jointDistance(omegaEnds[rotatedWalk], alphaEnds[(walk + 1) % alphaEnds.length])\n        }\n        ringLengths.push(ringLength)\n    }\n    let bestRotation = 0\n    let minLength = ringLengths[bestRotation]\n    ringLengths.forEach((ringLength, index) => {\n        if (ringLength < minLength) {\n            bestRotation = index\n            minLength = ringLength\n        }\n    })\n    if (bestRotation > 0) {\n        omega.ends = omega.ends.map(({}, index) => omega.ends[(index + bestRotation) % omega.ends.length])\n    }\n}\n\nexport function intervalsFromFaces(faces: ITwistFace[]): IInterval[] {\n    return faces.reduce((accum, face) => {\n        const unknown = (interval: IInterval) => !accum.some(existing => interval.index === existing.index)\n        const pulls = face.pulls.filter(unknown)\n        return [...accum, ...pulls]\n    }, [] as IInterval[])\n}\n\nexport interface IPercent {\n    _: number\n}\n\nexport function percentOrHundred(percent?: IPercent): IPercent {\n    return percent ? percent : {_: 100.0}\n}\n\nexport function factorFromPercent({_: percent}: IPercent): number {\n    return percent / 100.0\n}\n\nexport function percentFromFactor(factor: number): IPercent {\n    const _ = factor * 100.0\n    return {_}\n}\n\nexport function averageScaleFactor(faces: ITwistFace[]): number {\n    return faces.reduce((sum, face) => sum + factorFromPercent(face.scale), 0) / faces.length\n}\n\nexport function reorientMatrix(points: Vector3[], rotation: number): Matrix4 {\n    const x = sub(points[0], points[1])\n    const y = sub(points[3], points[2])\n    const z = sub(points[5], points[4])\n    const middle = points\n        .reduce((sum, point) => sum.add(point), new Vector3())\n        .multiplyScalar(1.0 / points.length)\n    const faceBasis = new Matrix4().makeBasis(x, y, z).setPosition(middle)\n    const twirl = new Matrix4().makeRotationZ(Math.PI * -0.24)\n    const rotate = new Matrix4().makeRotationY(-Math.PI / 2 - rotation * Math.PI / 3)\n    return faceBasis.multiply(twirl).multiply(rotate).invert()\n}\n\nexport interface ITwistFace {\n    twist: ITwist,\n    spin: Spin\n    scale: IPercent\n    pulls: IInterval[]\n    ends: IJoint[]\n    pushes: IInterval[]\n    markNumbers: IMarkNumber[]\n    removed: boolean\n    joint?: IJoint\n}\n\nexport interface ITwist {\n    faces: ITwistFace[]\n    pushes: IInterval[]\n    pulls: IInterval[]\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { FaceName, FACE_NAMES, FACE_NAME_CHARS, IMarkNumber, IPercent } from \"./tensegrity-types\"\n\nexport class TenscriptNode {\n    public root?: boolean\n\n    constructor(\n        public readonly forward: string | undefined,\n        public readonly scale: IPercent,\n        public readonly subtrees: Record<FaceName, TenscriptNode>,\n        public readonly markNumbers: Record<FaceName, IMarkNumber[]>,\n    ) {\n    }\n\n    public get nonEmpty(): TenscriptNode | undefined {\n        const empty = this.forward === undefined && this.subtreeCode.length === 0 && this.markCode.length === 0\n        return empty ? undefined : this\n    }\n\n    public get decremented(): { afterNode: TenscriptNode, action: string } {\n        if (this.forward !== undefined && this.forward.length > 0) {\n            const action = this.forward.substring(0, 1)\n            return {\n                afterNode: new TenscriptNode(this.forward.substring(1), this.scale, this.subtrees, this.markNumbers),\n                action,\n            }\n        }\n        return {afterNode: this, action: \"\"}\n    }\n\n    public subtree(faceName: FaceName): TenscriptNode | undefined {\n        return this.subtrees[faceName]\n    }\n\n    public faceMarks(faceName: FaceName): IMarkNumber [] | undefined {\n        return this.markNumbers[faceName]\n    }\n\n    public deleteMark(faceName: FaceName): void {\n        delete this.markNumbers[faceName]\n    }\n\n    public get needsOmniTwist(): boolean {\n        const omniFaceNames = FACE_NAMES.filter(faceName => faceName !== FaceName.A && faceName !== FaceName.a)\n        return omniFaceNames.some(faceName => this.subtrees[faceName]) || omniFaceNames.some(faceName => this.markNumbers[faceName])\n    }\n\n    public get code(): string {\n        const hasScale = this.scale._ !== 100\n        const subtreeCode = this.subtreeCode\n        const markCode = this.markCode\n        if (!this.root && this.forward && this.forward.length > 0 && !hasScale && subtreeCode.length === 0 && markCode.length === 0) {\n            return this.forward.toString()\n        }\n        const parts = []\n        if (this.forward && this.forward.length > 0) {\n            parts.push(this.forward.toString())\n        }\n        if (hasScale) {\n            parts.push(`S${this.scale._}`)\n        }\n        parts.push(...subtreeCode)\n        parts.push(...markCode)\n        return `(${parts.join(\",\")})`\n    }\n\n    private get subtreeCode(): string [] {\n        return Object.entries(this.subtrees).map(([k, v]) => `${FACE_NAME_CHARS[k]}${v.code}`)\n    }\n\n    private get markCode(): string[] {\n        return Object.entries(this.markNumbers)\n            .map(([k, marks]) => marks.map(mark => `M${FACE_NAME_CHARS[k]}${mark._}`)).flat()\n    }\n}\n","import { Stage } from \"eig\"\nimport { Matrix4, Vector3 } from \"three\"\n\nimport { basisFromVector, midpoint, pointsToNormal, ROOT3, SHORTENING } from \"./eig-util\"\nimport { AGE_POST_GROWTH, IJob, PairSelection, PostGrowthOp, Tensegrity, ToDo } from \"./tensegrity\"\nimport {\n    acrossPush,\n    areAdjacent,\n    IInterval,\n    IJoint,\n    intervalJoins,\n    IPair,\n    IRole,\n    jointPulls,\n    otherJoint,\n    pairKey,\n    percentOrHundred,\n} from \"./tensegrity-types\"\n\nexport interface IConflict {\n    jointA: IJoint\n    jointB: IJoint\n}\n\nconst PULL_AA: IRole = {\n    tag: \"(aa)\",\n    push: false,\n    length: SHORTENING,\n    stiffness: 0.4,\n}\n\nconst PULL_BB: IRole = {\n    tag: \"(bb)\",\n    push: false,\n    length: ROOT3 * SHORTENING,\n    stiffness: 0.4,\n}\n\nconst PULL_CONFLICT: IRole = {\n    tag: \"conflict\",\n    push: false,\n    length: 0.01,\n    stiffness: 1,\n}\n\nconst CONFLICT_MULTIPLE = 6\n\nfunction filterRole(targetRole: IRole): (interval: IInterval) => boolean {\n    return ({role}) => targetRole.tag === role.tag\n}\n\nexport function findConflicts(tensegrity: Tensegrity): IConflict[] {\n    const conflicts: IConflict[] = []\n    const instance = tensegrity.instance\n    const betweenDot = (joint: IJoint, interval: IInterval) => {\n        const toAlpha = instance.jointLocation(joint).sub(instance.jointLocation(interval.alpha)).normalize()\n        const toOmega = instance.jointLocation(joint).sub(instance.jointLocation(interval.omega)).normalize()\n        return toAlpha.dot(toOmega) < 0\n    }\n    tensegrity.joints.forEach((jointA, a) => {\n        const pushA = jointA.push\n        if (pushA) {\n            tensegrity.joints.forEach((jointB, b) => {\n                if (b <= a) {\n                    return\n                }\n                const pushB = jointB.push\n                if (pushB) {\n                    const otherA = otherJoint(jointA, pushA)\n                    const otherB = otherJoint(jointB, pushB)\n                    const distanceNear = instance.jointDistance(jointA, jointB)\n                    const distanceFar = instance.jointDistance(otherA, otherB)\n                    if (distanceNear * CONFLICT_MULTIPLE > distanceFar) {\n                        return\n                    }\n                    if (betweenDot(jointA, pushB) && betweenDot(jointB, pushA)) {\n                        conflicts.push({jointA, jointB})\n                    }\n                }\n            })\n        }\n    })\n    return conflicts\n}\n\nexport function snelsonPairs(tensegrity: Tensegrity, pullARole: IRole, pullBRole: IRole): IPair[] {\n    const pairs: IPair[] = []\n    const snelsonPair = (alpha: IJoint, pullB: IInterval): IPair | undefined => {\n        const a = acrossPush(alpha)\n        const b = otherJoint(alpha, pullB)\n        if (!a.push || !b.push) {\n            return undefined\n        }\n        const acrossA = jointPulls(a).filter(filterRole(pullARole)).map(pullA => otherJoint(a, pullA))\n        const acrossB = jointPulls(b).filter(filterRole(pullARole)).map(pullA => otherJoint(b, pullA))\n        const omega = acrossA.find(jointA => !!acrossB.find(jointB => jointA.index === jointB.index))\n        if (!omega || !omega.push) {\n            return undefined\n        }\n        const role = pullBRole\n        const scale = pullB.scale\n        return {alpha, omega, role, scale}\n    }\n    tensegrity.withPulls(pairMap => {\n        const pullBs = tensegrity.intervals.filter(filterRole(pullBRole))\n        pullBs.forEach(pullB => {\n            const alpha = snelsonPair(pullB.alpha, pullB)\n            if (alpha) {\n                const existingAlpha = pairMap[pairKey(alpha)]\n                if (!existingAlpha) {\n                    pairs.push(alpha)\n                }\n            }\n            const omega = snelsonPair(pullB.omega, pullB)\n            if (omega) {\n                const existingOmega = pairMap[pairKey(omega)]\n                if (!existingOmega) {\n                    pairs.push(omega)\n                }\n            }\n        })\n    })\n    return pairs\n}\n\nexport function bowtiePairs(tensegrity: Tensegrity, pullARole: IRole, pullBRole: IRole): IPair[] {\n    const pairs: IPair[] = []\n    const onlyA = filterRole(pullARole)\n    const onlyB = filterRole(pullBRole)\n    const intersection = (a: IJoint[], b: IJoint[]) => a.find(aj => b.find(bj => aj.index === bj.index))\n    const common = (a: IJoint, b: IJoint) => intersection(\n        jointPulls(a).filter(onlyA).map(pullA => otherJoint(a, pullA)),\n        jointPulls(b).filter(onlyA).map(pullA => otherJoint(b, pullA)),\n    )\n    const nextPair = (near: IJoint): IPair | undefined => {\n        const pullB = jointPulls(near).filter(onlyB)[0]\n        const far = otherJoint(near, pullB)\n        const otherFar = acrossPush(near)\n        const otherB = jointPulls(otherFar).filter(onlyB)[0]\n        const otherNear = otherJoint(otherFar, otherB)\n        const commonNear = common(near, otherNear)\n        const commonFar = common(far, otherFar)\n        if (!commonNear || !commonFar) {\n            return undefined\n        }\n        if (commonNear.push && !commonFar.push) {\n            const acrossFar = acrossPush(far)\n            if (!jointPulls(acrossFar).some(intervalJoins(commonNear, acrossFar))) {\n                return undefined\n            }\n        } else if (commonFar.push && !commonNear.push) {\n            const acrossNear = acrossPush(near)\n            if (!jointPulls(acrossNear).some(intervalJoins(commonFar, acrossNear))) {\n                return undefined\n            }\n        }\n        const alpha = commonNear.push ? commonNear : near\n        const omega = commonFar.push ? commonFar : far\n        const scale = pullB.scale\n        const role = !commonNear.push || !commonFar.push ? pullBRole : PULL_BB\n        return {alpha, omega, scale, role}\n    }\n    const instance = tensegrity.instance\n    tensegrity.withPulls(pairMap => {\n        const addPair = (pair: IPair) => {\n            const key = pairKey(pair)\n            const exists = pairMap[key]\n            if (!exists) {\n                pairs.push(pair)\n                pairMap[key] = pair\n            }\n        }\n        const addPairFor = (joint: IJoint) => {\n            const pair = nextPair(joint)\n            if (pair) {\n                addPair(pair)\n            }\n        }\n        tensegrity.intervals\n            .filter(filterRole(pullBRole))\n            .forEach(({alpha, omega}) => {\n                addPairFor(alpha)\n                addPairFor(omega)\n            })\n        tensegrity.joints\n            .filter(joint => joint.push && jointPulls(joint).filter(onlyA).length === 3)\n            .forEach(joint3APush => {\n                const noPushAcross = (interval: IInterval) => !otherJoint(joint3APush, interval).push\n                const found = jointPulls(joint3APush).filter(onlyA).find(noPushAcross)\n                if (!found) {\n                    throw new Error(\"no-push not found\")\n                }\n                const faceJoint = otherJoint(joint3APush, found)\n                const a3A = jointPulls(joint3APush).filter(onlyA).map(pullA => otherJoint(joint3APush, pullA))\n                    .map(end => {\n                        const outwards = new Vector3().subVectors(instance.jointLocation(end), instance.jointLocation(joint3APush)).normalize()\n                        return {end, outwards}\n                    })\n                const fjA = jointPulls(faceJoint).filter(onlyA).map(pullA => otherJoint(faceJoint, pullA))\n                    .map(end => {\n                        const outwards = new Vector3().subVectors(instance.jointLocation(end), instance.jointLocation(joint3APush)).normalize()\n                        return {end, outwards}\n                    })\n                a3A.map(a => {\n                    const b = fjA.sort((f1, f2) =>\n                        a.outwards.dot(f2.outwards) - a.outwards.dot(f1.outwards))[0]\n                    const role = PULL_AA\n                    const scale = found.scale\n                    const pair: IPair = {alpha: a.end, omega: b.end, scale, role}\n                    addPair(pair)\n                })\n            })\n    })\n    return pairs\n}\n\nexport function namedJob(name: string, age: number): IJob {\n    const job = (todo: ToDo): IJob => ({age, todo})\n    switch (name) {\n        case \"orient-0\":\n            return job(tensegrity => {\n                const zeroFaces = tensegrity.faces.filter(({markNumbers}) => markNumbers.find((n) => n._ === 0))\n                if (zeroFaces.length === 0) {\n                    throw new Error(\"No faces marked zero\")\n                }\n                const instance = tensegrity.instance\n                const position = zeroFaces\n                    .reduce((v, {ends}) =>\n                        v.add(midpoint(ends.map(end => instance.jointLocation(end)))), new Vector3())\n                    .multiplyScalar(1 / zeroFaces.length)\n                const upwards = zeroFaces\n                    .reduce((v, {ends}) =>\n                        v.sub(pointsToNormal(ends.map(end => instance.jointLocation(end)))), new Vector3())\n                    .normalize()\n                const {b1, up, b2} = basisFromVector(upwards)\n                tensegrity.instance.apply(new Matrix4().makeBasis(b1, up, b2).setPosition(position).invert())\n                tensegrity.fabric.set_altitude(5)\n            })\n        case \"conflict\":\n            return job(tensegrity => {\n                findConflicts(tensegrity).forEach(({jointA, jointB}) => {\n                    tensegrity.createInterval(jointA, jointB, PULL_CONFLICT, percentOrHundred())\n                })\n            })\n        case \"pretensing\":\n            return job(tensegrity => {\n                tensegrity.stage = Stage.Slack\n                tensegrity.stage = Stage.Pretensing\n            })\n        case \"age\":\n            return job(t => {\n                console.log(`age exceeds ${t.name} @ ${age}`, t.fabric.age)\n            })\n        default:\n            throw new Error(`No job named ${name}`)\n    }\n}\n\nexport function postGrowthJob(postGrowthOp: PostGrowthOp): IJob {\n    const age = AGE_POST_GROWTH\n    const job = (todo: ToDo): IJob => ({age, todo})\n    switch (postGrowthOp) {\n        case PostGrowthOp.Faces:\n            return job(tensegrity => {\n                tensegrity.triangleFaces()\n            })\n        case PostGrowthOp.Snelson:\n            return job(tensegrity => {\n                tensegrity.createPulls(PairSelection.Snelson)\n                tensegrity.triangleFaces()\n            })\n        case PostGrowthOp.Bowtie:\n            return job(tensegrity => {\n                tensegrity.createPulls(PairSelection.Bowtie)\n            })\n        case PostGrowthOp.BowtieFaces:\n            return job(tensegrity => {\n                tensegrity.createPulls(PairSelection.Bowtie)\n                tensegrity.triangleFaces()\n            })\n        default:\n            return job(() => {\n            })\n    }\n}\n\nexport function isAdjacent(targetInterval: IInterval): (interval: IInterval) => boolean {\n    return (interval: IInterval) => areAdjacent(targetInterval, interval)\n}\n","import { Vector3 } from \"three\"\n\nimport { avg, midpoint, pointsToNormal, sub } from \"./eig-util\"\nimport { PULL_A, PULL_B, PUSH_A, PUSH_B } from \"./tenscript\"\nimport { Tensegrity } from \"./tensegrity\"\nimport {\n    areAdjacent, expectPush,\n    FaceName,\n    factorFromPercent,\n    IInterval,\n    IJoint,\n    IPercent,\n    ITwist,\n    ITwistFace,\n    Spin,\n} from \"./tensegrity-types\"\n\nexport function createTwist(tensegrity: Tensegrity, spin: Spin, scale: IPercent, baseKnown?: Vector3[]): ITwist {\n    const base = !baseKnown ? createBase(new Vector3(), 3) :\n        baseKnown.length === 3 ? baseKnown : createBase(baseKnown[0], 3)\n    switch (spin) {\n        case Spin.Left:\n            return createSingle(base, spin, true, scale, tensegrity)\n        case Spin.Right:\n            return createSingle(base, spin, false, scale, tensegrity)\n        case Spin.LeftRight:\n            return createDouble(base, true, scale, tensegrity)\n        case Spin.RightLeft:\n            return createDouble(base, false, scale, tensegrity)\n        default:\n            throw new Error(\"Spin?\")\n    }\n}\n\nexport function faceFromTwist(faceName: FaceName, twist: ITwist): ITwistFace {\n    switch (twist.faces.length) {\n        case 2:\n            switch (faceName) {\n                case FaceName.a:\n                    return twist.faces[0]\n                case FaceName.A:\n                    return twist.faces[1]\n            }\n            break\n        case 8:\n            switch (faceName) {\n                case FaceName.a:\n                    return twist.faces[0]\n                case FaceName.B:\n                    return twist.faces[2]\n                case FaceName.C:\n                    return twist.faces[1]\n                case FaceName.D:\n                    return twist.faces[3]\n                case FaceName.b:\n                    return twist.faces[4]\n                case FaceName.c:\n                    return twist.faces[5]\n                case FaceName.d:\n                    return twist.faces[6]\n                case FaceName.A:\n                    return twist.faces[7]\n            }\n            break\n    }\n    throw new Error(`Face ${FaceName[faceName]} not found in twist with ${twist.faces.length} faces`)\n}\n\nexport function adjacentPullsFromTwist(tensegrity: Tensegrity, twist: ITwist): IInterval[] {\n    return tensegrity.intervals\n        .filter(({role}) => !role.push)\n        .reduce((detailsSoFar, interval) => {\n            const adjacent = twist.pushes.find(push => areAdjacent(push, interval))\n            if (adjacent) {\n                detailsSoFar.push(interval)\n            }\n            return detailsSoFar\n        }, [] as IInterval[])\n}\n\nfunction addFace(twist: ITwist, ends: IJoint[], pulls: IInterval[], spin: Spin, scale: IPercent, joint?: IJoint): void {\n    const f0 = ends[0]\n    const f1 = ends[2]\n    const f2 = ends[1]\n    const pushes = [expectPush(f0), expectPush(f1), expectPush(f2)]\n    const face: ITwistFace = {twist, spin, scale, ends, pushes, pulls, markNumbers: [], removed: false, joint}\n    twist.faces.push(face)\n}\n\nexport function removeFace(face: ITwistFace, tensegrity: Tensegrity): void {\n    face.pulls.forEach(pull => tensegrity.removeInterval(pull))\n    face.pulls = []\n    if (face.joint) {\n        tensegrity.removeJoint(face.joint)\n    }\n    face.removed = true\n}\n\nfunction createSingle(base: Vector3[], spin: Spin, leftSpin: boolean, scale: IPercent, tensegrity: Tensegrity): ITwist {\n    const twist: ITwist = {pushes: [], pulls: [], faces: []}\n    const pairs = pointPairs(base, scale, leftSpin)\n    const ends = pairs.map(({alpha, omega}) => ({\n        alpha: tensegrity.createJoint(alpha),\n        omega: tensegrity.createJoint(omega),\n    }))\n    const alphaJoint = tensegrity.createJoint(midpoint(pairs.map(({alpha}) => alpha)))\n    const omegaJoint = tensegrity.createJoint(midpoint(pairs.map(({omega}) => omega)))\n    tensegrity.instance.refreshFloatView()\n    ends.forEach(({alpha, omega}) => {\n        const push = tensegrity.createInterval(alpha, omega, PUSH_A, scale)\n        twist.pushes.push(push)\n        alpha.push = omega.push = push\n    })\n    const makeFace = (joints: IJoint[], midJoint: IJoint) => {\n        const pulls = joints.map(j => tensegrity.createInterval(j, midJoint, PULL_A, scale))\n        twist.pulls.push(...pulls)\n        addFace(twist, joints, pulls, spin, scale, midJoint)\n    }\n    makeFace(ends.map(({alpha}) => alpha), alphaJoint)\n    makeFace(ends.map(({omega}) => omega).reverse(), omegaJoint)\n    ends.forEach(({alpha}, index) => {\n        const omega = ends[(ends.length + index + (leftSpin ? -1 : 1)) % ends.length].omega\n        twist.pulls.push(tensegrity.createInterval(alpha, omega, PULL_B, scale))\n    })\n    return twist\n}\n\nfunction createDouble(base: Vector3[], leftSpin: boolean, scale: IPercent, tensegrity: Tensegrity): ITwist {\n    const twist: ITwist = {pushes: [], pulls: [], faces: []}\n    const botPairs = pointPairs(base, scale, leftSpin)\n    const topPairs = pointPairs(botPairs.map(({omega}) => omega), scale, !leftSpin)\n    const bot = botPairs.map(({alpha, omega}) => ({\n        alpha: tensegrity.createJoint(alpha),\n        omega: tensegrity.createJoint(omega),\n    }))\n    const top = topPairs.map(({alpha, omega}) => ({\n        alpha: tensegrity.createJoint(alpha),\n        omega: tensegrity.createJoint(omega),\n    }))\n    tensegrity.instance.refreshFloatView()\n    const ends = [...bot, ...top]\n    ends.forEach(({alpha, omega}) => {\n        const push = tensegrity.createInterval(alpha, omega, PUSH_B, scale)\n        twist.pushes.push(push)\n        alpha.push = omega.push = push\n    })\n    const faceJoints = leftSpin ?\n        [\n            [bot[0].alpha, bot[1].alpha, bot[2].alpha], // a\n            [bot[2].alpha, bot[1].omega, top[1].alpha], // B\n            [bot[0].alpha, bot[2].omega, top[2].alpha], // C\n            [bot[1].alpha, bot[0].omega, top[0].alpha], // D\n            [top[1].omega, top[0].alpha, bot[1].omega].reverse(), // b\n            [top[0].omega, top[2].alpha, bot[0].omega].reverse(), // d\n            [top[2].omega, top[1].alpha, bot[2].omega].reverse(), // c\n            [top[0].omega, top[1].omega, top[2].omega].reverse(), // A\n        ] : [\n            [bot[0].alpha, bot[1].alpha, bot[2].alpha], // a\n            [bot[2].alpha, bot[0].omega, top[2].alpha].reverse(), // D\n            [bot[0].alpha, bot[1].omega, top[0].alpha].reverse(), // B\n            [bot[1].alpha, bot[2].omega, top[1].alpha].reverse(), // C\n            [top[1].omega, top[2].alpha, bot[2].omega], // b\n            [top[2].omega, top[0].alpha, bot[0].omega], // c\n            [top[0].omega, top[1].alpha, bot[1].omega], // d\n            [top[0].omega, top[1].omega, top[2].omega].reverse(), // A\n        ]\n    const jointLocation = (joint: IJoint) => tensegrity.instance.jointLocation(joint)\n    const midJoints = faceJoints.map(joints => tensegrity.createJoint(midpoint(joints.map(jointLocation))))\n    tensegrity.instance.refreshFloatView()\n    faceJoints.forEach((joints, index) => {\n        const midJoint = midJoints[index]\n        const pulls = joints.map(j => tensegrity.createInterval(j, midJoint, PULL_A, scale))\n        twist.pulls.push(...pulls)\n        const spin = leftSpin === ([0, 4, 5, 6].some(n => n === index)) ? Spin.Left : Spin.Right\n        addFace(twist, joints, pulls, spin, scale, midJoint)\n    })\n    return twist\n}\n\ninterface IPointPair {\n    alpha: Vector3\n    omega: Vector3\n}\n\nfunction pointPairs(base: Vector3[], scale: IPercent, leftSpin: boolean): IPointPair[] {\n    const points: IPointPair[] = []\n    const mid = midpoint(base)\n    const midVector = () => new Vector3().copy(mid)\n    const factor = factorFromPercent(scale)\n    const up = pointsToNormal(base).multiplyScalar(-factor)\n    for (let index = 0; index < base.length; index++) {\n        const fromMid = (offset: number) => sub(base[(index + base.length + offset) % base.length], mid)\n        const between = (idx1: number, idx2: number) => avg(fromMid(idx1), fromMid(idx2))\n        const alpha = midVector().addScaledVector(between(0, 1), factor)\n        const omega = midVector().add(up).addScaledVector(leftSpin ? between(1, 2) : between(-1, 0), factor)\n        points.push({alpha, omega})\n    }\n    return points\n}\n\nfunction createBase(location: Vector3, pushesPerTwist: number): Vector3[] {\n    const base: Vector3[] = []\n    for (let index = 0; index < pushesPerTwist; index++) {\n        const angle = index * Math.PI * 2 / pushesPerTwist\n        const x = Math.cos(angle)\n        const y = Math.sin(angle)\n        base.push(new Vector3(x, 0, y).add(location))\n    }\n    return base\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Fabric, Stage } from \"eig\"\nimport { BehaviorSubject } from \"rxjs\"\nimport { Vector3 } from \"three\"\n\nimport { CONNECTOR_LENGTH, ROOT3 } from \"./eig-util\"\nimport { FabricInstance } from \"./fabric-instance\"\nimport { bowtiePairs, snelsonPairs } from \"./tensegrity-logic\"\nimport {\n    averageScaleFactor,\n    FaceName,\n    factorFromPercent,\n    IInterval,\n    IIntervalDetails,\n    IJoint,\n    intervalKey,\n    intervalToPair,\n    IPair,\n    IPercent,\n    IRadialPull,\n    IRole,\n    ITwist,\n    ITwistFace,\n    percentFromFactor,\n    percentOrHundred,\n    rotateForBestRing,\n    Spin,\n} from \"./tensegrity-types\"\nimport { createTwist, faceFromTwist, removeFace } from \"./twist-logic\"\n\nexport enum FaceAction {\n    Subtree,\n    Join,\n    ShapingDistance,\n    PretenstDistance,\n    None,\n}\n\nexport enum PostGrowthOp {\n    NoOp,\n    Faces,\n    Snelson,\n    Bowtie,\n    BowtieFaces,\n}\n\nexport enum PairSelection {\n    Bowtie,\n    Snelson,\n}\n\nconst PULL_A: IRole = {\n    tag: \"(a)\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nconst PULL_CONNECTOR: IRole = {\n    tag: \"connector\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nexport type ToDo = (tensegrity: Tensegrity) => void\n\nexport const AGE_POST_GROWTH = -1\n\nconst PULL_B = {\n    tag: \"(b)\",\n    push: false,\n    length: ROOT3,\n    stiffness: 1,\n}\n\nconst PULL_PRETENST_DISTANCER = {\n    tag: \"pretenst-distancer\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nconst PULL_SHAPING_DISTANCER = {\n    tag: \"shaping-distancer\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nconst PULL_RADIAL = {\n    tag: \"radial\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nexport interface IJob {\n    todo: ToDo,\n    age?: number\n}\n\nexport interface ITensegrityBuilder {\n    operateOn: (tensegrity: Tensegrity) => void\n    finished: () => boolean\n    work: () => void\n}\n\nexport class Tensegrity {\n    public name: string\n    public stage$: BehaviorSubject<Stage>\n    public joints: IJoint[] = []\n    public intervals: IInterval[] = []\n    public loops: IInterval[][] = []\n    public twists: ITwist[] = []\n\n    public connectors: IRadialPull[] = []\n    public distancers: IRadialPull[] = []\n    public pretenstAge = -1\n    public scale = 1\n\n    private jobs: IJob[] = []\n\n    constructor(\n        public readonly instance: FabricInstance,\n        public readonly countdown: number,\n        private builder: ITensegrityBuilder,\n    ) {\n        this.instance.clear()\n        this.stage$ = new BehaviorSubject(this.fabric.get_stage())\n        this.builder.operateOn(this)\n    }\n\n    public get fabric(): Fabric {\n        return this.instance.fabric\n    }\n\n    public createJoint(location: Vector3): IJoint {\n        const index = this.fabric.create_joint(location.x, location.y, location.z)\n        const newJoint: IJoint = {index}\n        this.joints.push(newJoint)\n        return newJoint\n    }\n\n    public removeJoint(joint: IJoint): void {\n        if (joint.index < 0) {\n            return\n        }\n        const index = joint.index\n        this.fabric.remove_joint(index)\n        this.joints = this.joints.filter(j => j.index !== index)\n        joint.index = -index - 1 // mark it\n        this.joints.forEach(j => j.index = j.index > index ? j.index - 1 : j.index)\n        this.instance.refreshFloatView()\n    }\n\n    public createRadialPull(alpha: ITwistFace, omega: ITwistFace, role: IRole, pullScale?: IPercent): IRadialPull {\n        const instance = this.instance\n        const alphaJoint = this.createJoint(instance.faceLocation(alpha))\n        const omegaJoint = this.createJoint(instance.faceLocation(omega))\n        instance.refreshFloatView()\n        const axis = this.creatAxis(alphaJoint, omegaJoint, role, pullScale)\n        const alphaRestLength = alpha.ends.reduce((sum, end) => sum + instance.jointDistance(alphaJoint, end), 0) / alpha.ends.length\n        const omegaRestLength = omega.ends.reduce((sum, end) => sum + instance.jointDistance(omegaJoint, end), 0) / omega.ends.length\n        const alphaRays = alpha.ends.map(end => this.createRay(alphaJoint, end, alphaRestLength))\n        const omegaRays = omega.ends.map(end => this.createRay(omegaJoint, end, omegaRestLength))\n        const radialPull: IRadialPull = {alpha, omega, axis, alphaRays, omegaRays}\n        switch (axis.role.tag) {\n            case \"connector\":\n                this.connectors.push(radialPull)\n                break\n            case \"shaping-distancer\":\n                this.distancers.push(radialPull)\n                break\n            case \"pretenst-distancer\":\n                break\n        }\n        return radialPull\n    }\n\n    public createInterval(alpha: IJoint, omega: IJoint, role: IRole, scale: IPercent, patience?: number): IInterval {\n        const targetLength = role.length * factorFromPercent(scale)\n        const currentLength = targetLength === 0 ? 0 : this.instance.jointDistance(alpha, omega)\n        const patienceFactor = patience === undefined ? 1 : patience\n        const countdown = this.countdown * Math.abs(targetLength - currentLength) * patienceFactor\n        const attack = countdown <= 0 ? 0 : 1 / countdown\n        const index = this.fabric.create_interval(alpha.index, omega.index, role.push, currentLength, targetLength, role.stiffness, attack)\n        const interval: IInterval = {index, role, scale, alpha, omega, removed: false}\n        this.intervals.push(interval)\n        return interval\n    }\n\n    public changeIntervalScale(interval: IInterval, factor: number): void {\n        interval.scale = percentFromFactor(factorFromPercent(interval.scale) * factor)\n        this.fabric.multiply_rest_length(interval.index, factor, 100)\n    }\n\n    public removeInterval(interval: IInterval): void {\n        const index = interval.index\n        this.intervals = this.intervals.filter(existing => existing.index !== index)\n        this.fabric.remove_interval(index)\n        this.intervals.forEach(existing => {\n            if (existing.index > index) {\n                existing.index--\n            }\n        })\n        interval.removed = true\n    }\n\n\n    public faceToTriangle(face: ITwistFace): void {\n        face.pulls.forEach(pull => this.removeInterval(pull))\n        face.pulls = []\n        if (face.joint) {\n            this.removeJoint(face.joint)\n        }\n        for (let index = 0; index < face.ends.length; index++) {\n            const endA = face.ends[index]\n            const endB = face.ends[(index + 1) % face.ends.length]\n            face.pulls.push(this.createInterval(endA, endB, PULL_B, face.scale))\n        }\n    }\n\n    public triangleFaces(): void {\n        this.faces.forEach(face => this.faceToTriangle(face))\n    }\n\n    public withPulls(work: (pairMap: Record<string, IPair>) => void): void {\n        const addPull = (end: IJoint, pull: IInterval) => {\n            if (end.pulls) {\n                end.pulls.push(pull)\n            } else {\n                end.pulls = [pull]\n            }\n        }\n        this.intervals\n            .filter(({role}) => !role.push)\n            .forEach(pull => {\n                addPull(pull.alpha, pull)\n                addPull(pull.omega, pull)\n            })\n        const pairMap: Record<string, IPair> = {}\n        this.intervals.forEach(interval => pairMap[intervalKey(interval)] = intervalToPair(interval))\n        work(pairMap)\n        this.joints.forEach(joint => joint.pulls = undefined)\n    }\n\n    public createPulls(pairSelection: PairSelection): void {\n        const selectPairs = () => {\n            switch (pairSelection) {\n                case PairSelection.Bowtie:\n                    return bowtiePairs(this, PULL_A, PULL_B)\n                case PairSelection.Snelson:\n                    return snelsonPairs(this, PULL_A, PULL_B)\n                default:\n                    throw new Error()\n            }\n        }\n        // selectPairs().forEach(pair=> console.log(pairKey(pair)))\n        selectPairs().forEach(({alpha, omega, role, scale}) => {\n            this.createInterval(alpha, omega, role, scale, 5)\n        })\n    }\n\n    public removeSlackPulls(): void {\n        const slack = this.intervals\n            .filter(({role}) => role.tag === \"(aa)\")\n            .filter(pullC => this.instance.floatView.strains[pullC.index] === 0)\n        slack.forEach(interval => this.removeInterval(interval))\n    }\n\n    public createTwist(spin: Spin, scale: IPercent, baseKnown?: Vector3[]): ITwist {\n        const twist = createTwist(this, spin, scale, baseKnown)\n        this.twists.push(twist)\n        return twist\n    }\n\n    public createTwistOn(baseFace: ITwistFace, spin: Spin, scale: IPercent): ITwist {\n        const jointLocation = (joint: IJoint) => this.instance.jointLocation(joint)\n        const twist = this.createTwist(spin, scale, baseFace.ends.map(jointLocation).reverse())\n        this.createLoop(baseFace, faceFromTwist(FaceName.a, twist))\n        return twist\n    }\n\n    public findTwist(push: IInterval): ITwist {\n        const found = this.twists.find(({pushes}) => pushes.find(({index}) => index === push.index))\n        if (!found) {\n            throw new Error(\"Cannot find twist\")\n        }\n        return found\n    }\n\n    public get faces(): ITwistFace[] {\n        return this.twists.reduce((f, {faces}) => f.concat(faces), [] as ITwistFace[]).filter(({removed}) => !removed)\n    }\n\n    public get stage(): Stage {\n        return this.stage$.getValue()\n    }\n\n    public set stage(stage: Stage) {\n        this.instance.stage = stage\n        if (stage === Stage.Slack) {\n            this.distancers.forEach(radialPull => {\n                const {axis, alphaRays, omegaRays} = radialPull\n                const intervals = [axis, ...alphaRays, ...omegaRays]\n                intervals.forEach(ray => this.removeInterval(ray))\n            })\n            this.distancers = []\n            this.instance.snapshot()\n        }\n        this.stage$.next(stage)\n    }\n\n    public set toDo(job: IJob) {\n        this.jobs.push(job)\n    }\n\n    public iterate(): boolean {\n        const busy = this.instance.iterate()\n        if (busy) {\n            return busy\n        }\n        const jobsBefore = this.jobs.length\n        if (jobsBefore) {\n            const ageNow = this.instance.fabric.age\n            this.jobs = this.jobs.filter(({todo, age}) => {\n                if (age !== undefined && (age < 0 || age > ageNow)) {\n                    return true // keep\n                }\n                todo(this)\n                return false\n            })\n            if (this.jobs.length < jobsBefore) {\n                return true\n            }\n        }\n        switch (this.stage) {\n            case Stage.Growing:\n                if (!this.builder.finished()) {\n                    this.builder.work()\n                    return false\n                } else if (this.connectors.length > 0) {\n                    this.connectors = this.checkConnectors()\n                    return false\n                }\n                this.stage = Stage.Shaping\n                this.jobs = this.jobs.filter(({todo, age}) => {\n                    if (age === AGE_POST_GROWTH) {\n                        todo(this)\n                        return false\n                    }\n                    return true\n                })\n                break\n            case Stage.Shaping:\n                break\n            case Stage.Slack:\n                break\n            case Stage.Pretensing:\n                this.stage = Stage.Pretenst\n                break\n            case Stage.Pretenst:\n                if (this.pretenstAge < 0) {\n                    this.pretenstAge = this.fabric.age\n                }\n        }\n        return false\n    }\n\n    public strainToStiffness(): void {\n        const instance = this.instance\n        const floatView = instance.floatView\n        const pulls = this.intervals.filter(interval => {\n            if (interval.role.push) {\n                return false\n            }\n            return instance.jointLocation(interval.alpha).y >= 0 || instance.jointLocation(interval.omega).y >= 0\n        })\n        const strains = floatView.strains\n        const averagePullStrain = pulls.reduce((sum, interval) => sum + strains[interval.index], 0) / pulls.length\n        const stiffnesses = new Float32Array(floatView.stiffnesses)\n        pulls.forEach(pull => {\n            const pullStrain = strains[pull.index]\n            const normalizedStrain = pullStrain - averagePullStrain\n            const strainFactor = normalizedStrain / averagePullStrain\n            stiffnesses[pull.index] *= 1 + strainFactor\n        })\n        instance.restoreSnapshot()\n        this.fabric.copy_stiffnesses(stiffnesses)\n    }\n\n    public createRadialPulls(faces: ITwistFace[], action: FaceAction, actionScale?: IPercent): void {\n        const locationFromFace = (face: ITwistFace) => this.instance.faceLocation(face)\n        const centerBrickFaceIntervals = () => {\n            const omniTwist = this.createTwist(Spin.LeftRight, percentFromFactor(averageScaleFactor(faces)), [this.instance.averageFaceLocation(faces)])\n            this.instance.refreshFloatView()\n            return faces.map(face => {\n                const opposing = omniTwist.faces.filter(({spin, pulls}) => pulls.length > 0 && spin !== face.spin)\n                const faceLocation = locationFromFace(face)\n                const closestFace = opposing.reduce((a, b) => {\n                    const aa = locationFromFace(a).distanceTo(faceLocation)\n                    const bb = locationFromFace(b).distanceTo(faceLocation)\n                    return aa < bb ? a : b\n                })\n                return this.createRadialPull(closestFace, face, PULL_CONNECTOR)\n            })\n        }\n        const pullScale = actionScale ? actionScale : percentFromFactor(0.75)\n        switch (action) {\n            case FaceAction.ShapingDistance:\n            case FaceAction.PretenstDistance:\n                if (!pullScale) {\n                    throw new Error(\"Missing pull scale\")\n                }\n                faces.forEach((faceA, indexA) => {\n                    faces.forEach((faceB, indexB) => {\n                        if (indexA <= indexB) {\n                            return\n                        }\n                        const role = action === FaceAction.ShapingDistance ? PULL_SHAPING_DISTANCER : PULL_PRETENST_DISTANCER\n                        this.createRadialPull(faceA, faceB, role, pullScale)\n                    })\n                })\n                break\n            case FaceAction.Join:\n                switch (faces.length) {\n                    case 2:\n                        if (faces[0].spin === faces[1].spin) {\n                            centerBrickFaceIntervals()\n                        } else {\n                            this.createRadialPull(faces[0], faces[1], PULL_CONNECTOR)\n                        }\n                        break\n                    case 3:\n                        centerBrickFaceIntervals()\n                        break\n                }\n                break\n        }\n    }\n\n    public checkConnectors(): IRadialPull[] {\n        if (this.connectors.length === 0) {\n            return this.connectors\n        }\n        const connectFaces = (alpha: ITwistFace, omega: ITwistFace) => {\n            rotateForBestRing(this.instance, alpha, omega)\n            this.createLoop(alpha, omega)\n        }\n        return this.connectors.filter(({axis, alpha, omega, alphaRays, omegaRays}) => {\n            if (axis.role.tag === \"connector\") {\n                const distance = this.instance.jointDistance(axis.alpha, axis.omega)\n                if (distance <= CONNECTOR_LENGTH) {\n                    connectFaces(alpha, omega)\n                    this.removeInterval(axis)\n                    alphaRays.forEach(i => this.removeInterval(i))\n                    omegaRays.forEach(i => this.removeInterval(i))\n                    return false\n                }\n            }\n            return true\n        })\n    }\n\n    public getIntervalDetails(interval: IInterval): IIntervalDetails {\n        const instance = this.instance\n        const {floatView} = instance\n        const strain = floatView.strains[interval.index]\n        const length = instance.intervalLength(interval) * this.scale\n        const height = instance.intervalLocation(interval).y * this.scale\n        return {interval, strain, length, height}\n    }\n\n    private createLoop(faceA: ITwistFace, faceB: ITwistFace): void {\n        const reverseA = [...faceA.ends].reverse()\n        const forwardB = faceB.ends\n        const scale = percentFromFactor((factorFromPercent(faceA.scale) + factorFromPercent(faceB.scale)) / 2)\n        const loop: IInterval[] = []\n        for (let index = 0; index < reverseA.length; index++) {\n            const a0 = reverseA[index]\n            const a1 = reverseA[(index + 1) % reverseA.length]\n            const b = forwardB[index]\n            loop.push(this.createInterval(a0, b, PULL_A, scale))\n            loop.push(this.createInterval(b, a1, PULL_A, scale))\n        }\n        removeFace(faceB, this)\n        removeFace(faceA, this)\n        this.loops.push(loop)\n    }\n\n    // =========================\n\n    private creatAxis(alpha: IJoint, omega: IJoint, role: IRole, pullScale?: IPercent): IInterval {\n        const idealLength = this.instance.jointDistance(alpha, omega)\n        const restLength = pullScale ? factorFromPercent(pullScale) * idealLength : CONNECTOR_LENGTH / 2\n        const stiffness = 1\n        const scale = percentOrHundred()\n        const countdown = this.countdown * Math.abs(restLength - idealLength)\n        const attack = 1 / countdown\n        const index = this.fabric.create_interval(alpha.index, omega.index, false, idealLength, restLength, stiffness, attack)\n        const interval: IInterval = {index, alpha, omega, role, scale, removed: false}\n        this.intervals.push(interval)\n        return interval\n    }\n\n    private createRay(alpha: IJoint, omega: IJoint, restLength: number): IInterval {\n        const idealLength = this.instance.jointDistance(alpha, omega)\n        const role = PULL_RADIAL\n        const stiffness = 1\n        const scale = percentFromFactor(restLength)\n        const countdown = this.countdown * Math.abs(restLength - idealLength)\n        const attack = 1 / countdown\n        const index = this.fabric.create_interval(alpha.index, omega.index, false, idealLength, restLength, stiffness, attack)\n        const interval: IInterval = {index, alpha, omega, role, scale, removed: false}\n        this.intervals.push(interval)\n        return interval\n    }\n}\n\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { SurfaceCharacter, WorldFeature } from \"eig\"\nimport { Vector3 } from \"three\"\n\nimport { PHI, ROOT3, ROOT6 } from \"./eig-util\"\nimport { TenscriptNode } from \"./tenscript-node\"\nimport { FaceAction, ITensegrityBuilder, PostGrowthOp, Tensegrity } from \"./tensegrity\"\nimport { namedJob, postGrowthJob } from \"./tensegrity-logic\"\nimport {\n    FaceName,\n    faceNameFromChar,\n    FACE_NAMES,\n    factorFromPercent,\n    IMarkNumber,\n    IPercent,\n    IRole,\n    isFaceNameChar,\n    ITwist,\n    ITwistFace,\n    percentFromFactor,\n    percentOrHundred,\n    reorientMatrix,\n    Spin,\n    spinChange,\n} from \"./tensegrity-types\"\nimport { faceFromTwist } from \"./twist-logic\"\n\nexport const PUSH_A: IRole = {\n    tag: \"[A]\",\n    push: true,\n    length: ROOT6,\n    stiffness: 1,\n}\n\nexport const PUSH_B: IRole = {\n    tag: \"[B]\",\n    push: true,\n    length: PHI * ROOT3,\n    stiffness: 1,\n}\n\nexport const PULL_A: IRole = {\n    tag: \"(a)\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nexport const PULL_B: IRole = {\n    tag: \"(b)\",\n    push: false,\n    length: ROOT3,\n    stiffness: 1,\n}\n\nexport interface INamedJob {\n    todo: string\n    age: number\n}\n\nexport interface ITenscript {\n    name: string\n    spin: Spin\n    postGrowthOp: PostGrowthOp\n    surfaceCharacter: SurfaceCharacter\n    code: string[]\n    scale?: number\n    jobs?: INamedJob[]\n    markDefStrings?: Record<number, string>\n    featureValues?: Record<WorldFeature, number>\n}\n\nexport interface IMarkAction {\n    action: FaceAction\n    tree?: TenscriptNode\n    scale?: IPercent\n    point?: Vector3\n}\n\nexport function compileTenscript(tenscript: ITenscript, error: (message: string) => void): TenscriptNode | undefined {\n    try {\n        const code = tenscript.code.join()\n        const root = codeToNode(code)\n        if (!root) {\n            error(\"Nothing to compile\")\n            return undefined\n        }\n        root.root = true\n        return root\n    } catch (e) {\n        error(e.message)\n        return undefined\n    }\n}\n\nexport type RunTenscript = (tenscript: ITenscript, error: (message: string) => void) => boolean\n\nexport interface IBud {\n    tensegrity: Tensegrity\n    tree: TenscriptNode\n    twist: ITwist\n    markActions: Record<number, IMarkAction>\n    reorient: boolean\n}\n\nexport class TenscriptBuilder implements ITensegrityBuilder {\n    private tensegrity: Tensegrity\n    private markDefStrings: Record<number, string>\n    private buds: IBud[]\n\n    constructor(\n        private location: Vector3,\n        private tenscript: ITenscript,\n        private tree: TenscriptNode,\n    ) {\n    }\n\n    public operateOn(tensegrity: Tensegrity): void {\n        this.tensegrity = tensegrity\n        if (this.tenscript.scale) {\n            this.tensegrity.scale = this.tenscript.scale\n        }\n        tensegrity.name = this.tenscript.name\n        tensegrity.instance.world.set_surface_character(this.tenscript.surfaceCharacter)\n        this.markDefStrings = this.tenscript.markDefStrings ? this.tenscript.markDefStrings : {}\n        if (this.tenscript.jobs) {\n            this.tenscript.jobs.forEach(({todo, age}) => tensegrity.toDo = namedJob(todo, age))\n        }\n        this.tensegrity.toDo = postGrowthJob(this.tenscript.postGrowthOp)\n        this.buds = [createBud(tensegrity, this.location, this.tenscript, this.tree)]\n    }\n\n    public finished(): boolean {\n        return this.buds.length === 0\n    }\n\n    public work(): void {\n        this.buds = execute(this.buds)\n        if (this.finished()) { // last one executed\n            faceStrategies(this.tensegrity, this.tensegrity.faces, this.markDefStrings).forEach(strategy => strategy.execute())\n        }\n    }\n}\n\nfunction faceStrategies(tensegrity: Tensegrity, faces: ITwistFace[], markStrings?: Record<number, string>): FaceStrategy[] {\n    const marks = markDefStringsToActions(markStrings)\n    const collated: Record<number, ITwistFace[]> = {}\n    faces.forEach(face => {\n        face.markNumbers.forEach(mark => {\n            const found = collated[mark._]\n            if (found) {\n                found.push(face)\n            } else {\n                collated[mark._] = [face]\n            }\n        })\n    })\n    return Object.entries(collated).map(([key]) => {\n        const possibleMark = marks[key] || marks[-1]\n        const mark = possibleMark ? possibleMark : FaceAction.None\n        return new FaceStrategy(tensegrity, collated[key], mark)\n    })\n}\n\nclass FaceStrategy {\n    constructor(private tensegrity: Tensegrity, private faces: ITwistFace[], private markAction: IMarkAction) {\n    }\n\n    public execute(): void {\n        switch (this.markAction.action) {\n            case FaceAction.Join:\n            case FaceAction.ShapingDistance:\n            case FaceAction.PretenstDistance:\n                this.tensegrity.createRadialPulls(this.faces, this.markAction.action, this.markAction.scale)\n                break\n        }\n    }\n}\n\nexport function createBud(tensegrity: Tensegrity, location: Vector3, tenscript: ITenscript, tree: TenscriptNode): IBud {\n    const reorient = tree.forward === undefined\n    const {spin, markDefStrings} = tenscript\n    const twist = tensegrity.createTwist(spin, percentOrHundred(), [location])\n    return {tensegrity, tree, twist, markActions: markDefStringsToActions(markDefStrings), reorient}\n}\n\nexport function markDefStringsToActions(markStrings?: Record<number, string>): Record<number, IMarkAction> {\n    const markActions: Record<number, IMarkAction> = {}\n    if (markStrings) {\n        Object.keys(markStrings).forEach(key => {\n            const c: string = markStrings[key]\n            if (c.startsWith(\"subtree\")) {\n                const subtree = codeToNode(c.substring(\"subtree\".length))\n                markActions[key] = <IMarkAction>{action: FaceAction.Subtree, tree: subtree}\n            } else if (c.startsWith(\"join\")) {\n                markActions[key] = <IMarkAction>{action: FaceAction.Join}\n            } else if (c.startsWith(\"shaping-distance-\")) {\n                const scale: IPercent = {_: parseInt(c.split(\"-\")[2], 10)}\n                markActions[key] = <IMarkAction>{action: FaceAction.ShapingDistance, scale}\n            } else if (c.startsWith(\"pretenst-distance-\")) {\n                const scale: IPercent = {_: parseInt(c.split(\"-\")[2], 10)}\n                markActions[key] = <IMarkAction>{action: FaceAction.PretenstDistance, scale}\n            }\n        })\n    }\n    return markActions\n}\n\nfunction codeToNode(codeFragment: string): TenscriptNode | undefined {\n    const initialCode = argument(codeFragment, true)\n    const codeString = initialCode.content\n    let forward: string | undefined\n    let scale = percentOrHundred()\n    const subtrees = {} as Record<FaceName, TenscriptNode>\n    const faceMarks = {} as Record<FaceName, IMarkNumber[]>\n\n    function subtree(index: number): { codeTree?: TenscriptNode, skip: number } {\n        const {content, skip} = argument(codeString.substring(index), false)\n        const codeTree = codeToNode(content)\n        return {codeTree, skip}\n    }\n\n    function addMark(faceName: FaceName, mark: number): void {\n        const found = faceMarks[faceName]\n        const markNumber: IMarkNumber = {_: mark}\n        if (found) {\n            found.push(markNumber)\n        } else {\n            faceMarks[faceName] = [markNumber]\n        }\n    }\n\n    for (let index = 0; index < codeString.length; index++) {\n        const char = codeString.charAt(index)\n        if (isFaceNameChar(char)) {\n            const direction = subtree(index + 1)\n            const codeTree = direction.codeTree\n            if (!codeTree) {\n                throw new Error(`No subtree: ${codeString.substring(index)}`)\n            }\n            subtrees[faceNameFromChar(char)] = codeTree\n            index += direction.skip\n        } else if (isDigit(char)) {\n            const forwardArg = argument(codeString, false)\n            const forwardCount = toNumber(forwardArg.content)\n            forward = \"X\".repeat(forwardCount)\n            index += forwardArg.skip\n        } else if (char === \"X\" || char === \"O\") {\n            const forwardArg = argument(codeString, false)\n            forward = forwardArg.content\n            index += forwardArg.skip\n        } else {\n            switch (char) {\n                case \"S\":\n                    const scaleArg = argument(codeString.substring(index + 1), true)\n                    scale = {_: toNumber(scaleArg.content)}\n                    index += scaleArg.skip\n                    break\n                case \"M\":\n                    const faceNameChar = codeString.charAt(index + 1)\n                    const markNumber = argument(codeString.substring(index + 2), true)\n                    addMark(faceNameFromChar(faceNameChar), toNumber(markNumber.content))\n                    index += markNumber.skip + 1\n                    break\n                case \",\":\n                case \" \":\n                case \"\\n\":\n                    break\n                default:\n                    throw new Error(`Unexpected character: ${char}`)\n            }\n        }\n    }\n    return new TenscriptNode(forward, scale, subtrees, faceMarks).nonEmpty\n}\n\nfunction markTwist(twistToMark: ITwist, treeWithMarks: TenscriptNode): void {\n    FACE_NAMES.forEach(thisFace => {\n        const marks = treeWithMarks.faceMarks(thisFace)\n        if (!marks) {\n            return\n        }\n        faceFromTwist(thisFace, twistToMark).markNumbers.push(...marks)\n    })\n}\n\nfunction grow(\n    {tensegrity, twist, markActions}: IBud,\n    action: string,\n    afterTree: TenscriptNode,\n    faceName: FaceName,\n    toOmni: boolean,\n    scaleChange: IPercent,\n): IBud {\n    const baseFace = faceFromTwist(faceName, twist)\n    const getSpin = () => {\n        switch (action) {\n            case \"O\":\n                return spinChange(baseFace.spin, false, toOmni)\n            default:\n                return spinChange(baseFace.spin, true, toOmni)\n        }\n    }\n    const spin = getSpin()\n    const scale = percentFromFactor(factorFromPercent(baseFace.scale) * factorFromPercent(scaleChange))\n    const newTwist = tensegrity.createTwistOn(baseFace, spin, scale)\n    if (afterTree.forward === \"\") {\n        markTwist(newTwist, afterTree)\n    }\n    return {tensegrity, tree: afterTree, twist: newTwist, markActions, reorient: false}\n}\n\nexport function execute(before: IBud[]): IBud[] {\n    const activeBuds: IBud[] = []\n    before.forEach(bud => {\n        const {tensegrity, tree, markActions, reorient} = bud\n        if (tree.forward !== undefined && tree.forward.length > 0) {\n            const {afterNode, action} = tree.decremented\n            const omni = tree.needsOmniTwist && afterNode.forward !== undefined && afterNode.forward.length === 0\n            activeBuds.push(grow(bud, action, afterNode, FaceName.A, omni, tree.scale))\n            return\n        }\n        if (reorient) {\n            const abOrientation = ![FaceName.A, FaceName.a, FaceName.B, FaceName.b].some(f => !tree.subtree(f))\n            if (abOrientation) {\n                const points = tensegrity.joints.map(joint => tensegrity.instance.jointLocation(joint))\n                tensegrity.instance.apply(reorientMatrix(points, 0))\n            }\n        }\n        FACE_NAMES.forEach(faceName => {\n            const subtree = tree.subtree(faceName)\n            if (subtree) {\n                const {afterNode, action} = subtree.decremented\n                const omni = subtree.needsOmniTwist && subtree.forward === \"\"\n                activeBuds.push(grow(bud, action, afterNode, faceName, omni, subtree.scale))\n            } else {\n                const treeMarks = tree.faceMarks(faceName)\n                if (treeMarks) {\n                    treeMarks.forEach(twistMark => {\n                        const mark = markActions[twistMark._]\n                        if (mark && mark.action === FaceAction.Subtree) {\n                            const markTree = mark.tree\n                            if (!markTree) {\n                                throw new Error(\"Missing subtree\")\n                            }\n                            tree.deleteMark(faceName)\n                            const omni = markTree.needsOmniTwist\n                            activeBuds.push(grow(bud, \"\", markTree, faceName, omni, percentOrHundred(markTree.scale)))\n                        }\n                    })\n                }\n            }\n        })\n    })\n    return activeBuds\n}\n\n\nfunction isDigit(char: string): boolean {\n    return \"0123456789\".indexOf(char) >= 0\n}\n\nfunction toNumber(digits: string): number {\n    if (!digits.match(/^\\d*$/)) {\n        throw new Error(`Not a number: ${digits}`)\n    }\n    if (digits.length === 0) {\n        return 0\n    }\n    return parseInt(digits, 10)\n}\n\nfunction matchBracket(s: string): number {\n    if (s.charAt(0) !== \"(\") {\n        throw new Error(`Code must start with \"(\": ${s} ${s.charAt(0)}`)\n    }\n    let depth = 0\n    for (let index = 0; index < s.length; index++) {\n        const char = s.charAt(index)\n        if (char === \"(\") {\n            depth++\n        } else if (char === \")\") {\n            depth--\n            if (depth === 0) {\n                return index\n            }\n        }\n    }\n    throw new Error(`No matching end bracket: |${s}|`)\n}\n\nfunction argument(maybeBracketed: string, stripBrackets: boolean): { content: string, skip: number } {\n    const commaPos = maybeBracketed.indexOf(\",\")\n    const commaPresent = commaPos >= 0\n    if (maybeBracketed.charAt(0) !== \"(\") {\n        if (commaPresent) {\n            return {content: maybeBracketed.substring(0, commaPos), skip: commaPos}\n        }\n        return {content: maybeBracketed, skip: maybeBracketed.length}\n    }\n    const finalBracket = matchBracket(maybeBracketed)\n    const contentOption = stripBrackets ? maybeBracketed.substring(1, finalBracket) : maybeBracketed.substring(0, finalBracket + 1)\n    const content = contentOption.length > 0 ? contentOption : \"0\"\n    return {content, skip: finalBracket + 1}\n}\n\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { SurfaceCharacter, WorldFeature } from \"eig\"\nimport { atom, RecoilState } from \"recoil\"\nimport { recoilPersist } from \"recoil-persist\"\n\nimport { globalModeFromUrl, IGlobalMode, WORLD_FEATURES } from \"../fabric/eig-util\"\nimport { ITenscript } from \"../fabric/tenscript\"\nimport { PostGrowthOp } from \"../fabric/tensegrity\"\nimport { IIntervalDetails, ITwist } from \"../fabric/tensegrity-types\"\nimport { featureMapping, IFeatureMapping } from \"../view/feature-mapping\"\n\nexport const STORAGE_KEY = \"pretenst-2022-04-06\"\nconst DEFAULT_BOOTSTRAP = 0\n\nconst {persistAtom} = recoilPersist({\n    key: STORAGE_KEY,\n    storage: localStorage,\n})\n\n// eslint-disable-next-line @typescript-eslint/tslint/config\nconst effects_UNSTABLE = [persistAtom]\n\nexport const postGrowthAtom = atom({\n    key: \"postGrowth\",\n    default: PostGrowthOp.NoOp,\n    effects_UNSTABLE,\n})\n\nexport const bootstrapIndexAtom = atom({\n    key: \"bootstrapIndex\",\n    default: DEFAULT_BOOTSTRAP,\n    effects_UNSTABLE,\n})\n\nexport const tenscriptAtom = atom<ITenscript | undefined>({\n    key: \"tenscript\",\n    default: undefined,\n    effects_UNSTABLE,\n})\n\nexport const currentFeature = atom<WorldFeature>({\n    key: \"currentFeature\",\n    default: WorldFeature.VisualStrain,\n    effects_UNSTABLE,\n})\n\nfunction createWorldFeatureValues(): IWorldFeatureValue[] {\n    return WORLD_FEATURES.map(feature => {\n        const mapping = featureMapping(WorldFeature[feature])\n        const percentAtom = atom({\n            key: mapping.name,\n            default: 100,\n            effects_UNSTABLE,\n        })\n        return <IWorldFeatureValue>{mapping, percentAtom}\n    })\n}\n\nexport const rotatingAtom = atom({\n    key: \"rotating\",\n    default: false,\n})\n\nexport const globalModeAtom = atom<IGlobalMode>({\n    key: \"globalMode\",\n    default: globalModeFromUrl(),\n})\n\nexport enum ViewMode {\n    Time = \"Time\",\n    Select = \"Select\",\n    Look = \"Look\",\n}\n\nexport const viewModeAtom = atom<ViewMode>({\n    key: \"viewMode\",\n    default: ViewMode.Time,\n})\n\nexport const surfaceCharacterAtom = atom({\n    key: \"surfaceCharacter\",\n    default: SurfaceCharacter.Frozen,\n})\n\nexport interface IWorldFeatureValue {\n    mapping: IFeatureMapping\n    percentAtom: RecoilState<number>\n}\n\nexport const FEATURE_VALUES = createWorldFeatureValues()\n\nexport const selectedTwistAtom = atom<ITwist | undefined>({\n    key: \"selectedTwist\",\n    default: undefined,\n})\n\nexport const visibleDetailsAtom = atom<IIntervalDetails[]>({\n    key: \"visibleDetails\",\n    default: [],\n})\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { FaCamera, FaHandPointUp, FaPlay } from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { useRecoilState } from \"recoil\"\n\nimport { ViewMode, viewModeAtom } from \"../storage/recoil\"\n\nexport function BottomLeft(): JSX.Element {\n    const [viewMode, setViewMode] = useRecoilState(viewModeAtom)\n\n    function ViewModeButton({item, children}: {\n        item: ViewMode,\n        children: JSX.Element | (JSX.Element[] | JSX.Element | undefined)[],\n    }): JSX.Element {\n        return (\n            <Button\n                disabled={item === viewMode}\n                color={item === viewMode ? \"success\" : \"secondary\"}\n                onClick={() => setViewMode(item)}\n            >\n                {children}\n            </Button>\n        )\n    }\n\n    return (\n        <ButtonGroup>\n            <ViewModeButton item={ViewMode.Time}>\n                <FaPlay/><span> Time</span>\n            </ViewModeButton>\n            <ViewModeButton item={ViewMode.Select}>\n                <FaHandPointUp/><span> Select</span>\n            </ViewModeButton>\n            <ViewModeButton item={ViewMode.Look}>\n                <FaCamera/><span> Look</span>\n            </ViewModeButton>\n        </ButtonGroup>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as FileSaver from \"file-saver\"\nimport JSZip from \"jszip\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\n\nfunction csvNumber(n: number): string {\n    return n.toFixed(5).replace(/[.]/, \",\")\n}\n\nfunction dateString(): string {\n    return new Date().toISOString()\n        .replace(/[.].*/, \"\").replace(/[:T_]/g, \"-\")\n}\n\nexport interface IOutputJoint {\n    index: number\n    x: number\n    y: number\n    z: number\n    radius: number\n}\n\nexport interface IOutputInterval {\n    index: number\n    joints: number[]\n    type: string\n    strain: number\n    stiffness: number\n    linearDensity: number\n    isPush: boolean\n    role: string\n    scale: number\n    idealLength: number\n    length: number\n    radius: number\n}\n\nexport interface IFabricOutput {\n    name: string\n    joints: IOutputJoint[]\n    intervals: IOutputInterval[]\n}\n\nexport function getFabricOutput({name, instance, joints, intervals}: Tensegrity, pushRadius: number, pullRadius: number, jointRadius: number): IFabricOutput {\n    instance.refreshFloatView()\n    const idealLengths = instance.floatView.idealLengths\n    const strains = instance.floatView.strains\n    const stiffnesses = instance.floatView.stiffnesses\n    const linearDensities = instance.floatView.linearDensities\n    return {\n        name,\n        joints: joints.map(joint => {\n            const vector = instance.jointLocation(joint)\n            return <IOutputJoint>{\n                index: joint.index,\n                radius: jointRadius,\n                x: vector.x, y: vector.z, z: vector.y,\n                anchor: false, // TODO: can this be determined?\n            }\n        }),\n        intervals: intervals.map(interval => {\n            const isPush = interval.role.push\n            const radius = isPush ? pushRadius : pullRadius\n            const currentLength = instance.intervalLength(interval)\n            const alphaIndex = interval.alpha.index\n            const omegaIndex = interval.omega.index\n            if (alphaIndex >= joints.length || omegaIndex >= joints.length) {\n                throw new Error(`Joint not found ${interval.role.tag}:${alphaIndex},${omegaIndex}:${joints.length}`)\n            }\n            return <IOutputInterval>{\n                index: interval.index,\n                joints: [alphaIndex, omegaIndex],\n                type: isPush ? \"Push\" : \"Pull\",\n                strain: strains[interval.index],\n                stiffness: stiffnesses[interval.index],\n                linearDensity: linearDensities[interval.index],\n                role: interval.role.tag,\n                scale: interval.scale._,\n                idealLength: idealLengths[interval.index],\n                isPush,\n                length: currentLength,\n                radius,\n            }\n        }),\n    }\n}\n\nfunction extractJointFile(output: IFabricOutput): string {\n    const csvJoints: string[][] = []\n    csvJoints.push([\"index\", \"x\", \"y\", \"z\"])\n    output.joints.forEach(joint => csvJoints.push([\n        (joint.index+1).toFixed(0),\n        csvNumber(joint.x), csvNumber(joint.y), csvNumber(joint.z),\n    ]))\n    return csvJoints.map(a => a.join(\";\")).join(\"\\n\")\n}\n\nfunction extractIntervalFile(output: IFabricOutput): string {\n    const csvIntervals: string[][] = []\n    csvIntervals.push([\"joints\", \"type\", \"strain\", \"stiffness\", \"linear density\", \"role\", \"length\", \"ideal length\"])\n    output.intervals.forEach(interval => {\n        csvIntervals.push([\n            `\"=\"\"${interval.joints.map(j => (j + 1).toFixed(0))}\"\"\"`, interval.type,\n            csvNumber(interval.strain), csvNumber(interval.stiffness), csvNumber(interval.linearDensity),\n            interval.role, csvNumber(interval.length), csvNumber(interval.idealLength),\n        ])\n    })\n    return csvIntervals.map(a => a.join(\";\")).join(\"\\n\")\n}\n\nfunction extractSubmergedFile(output: IFabricOutput): string {\n    const csvSubmerged: string[][] = []\n    csvSubmerged.push([\"joints\"])\n    // TODO: submerged\n    // csvSubmerged.push([`\"=\"\"${output.joints.filter(({anchor})=> anchor).map(joint => joint.index + 1)}\"\"\"`])\n    return csvSubmerged.map(a => a.join(\";\")).join(\"\\n\")\n}\n\nexport function saveCSVZip(output: IFabricOutput): void {\n    const zip = new JSZip()\n    zip.file(\"joints.csv\", extractJointFile(output))\n    zip.file(\"intervals.csv\", extractIntervalFile(output))\n    zip.file(\"submerged.csv\", extractSubmergedFile(output))\n    zip.generateAsync({type: \"blob\", mimeType: \"application/zip\"}).then(blob => {\n        FileSaver.saveAs(blob, `pretenst-${dateString()}.zip`)\n    })\n}\n\nexport function saveJSONZip(output: IFabricOutput): void {\n    const zip = new JSZip()\n    zip.file(`pretenst-${dateString()}.json`, JSON.stringify(output, undefined, 2))\n    zip.generateAsync({type: \"blob\", mimeType: \"application/zip\"}).then(blob => {\n        FileSaver.saveAs(blob, `pretenst-${dateString()}.zip`)\n    })\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport {\n    FaCompressArrowsAlt,\n    FaDownload,\n    FaFile,\n    FaFileCsv,\n    FaParachuteBox,\n    FaSignOutAlt,\n    FaSyncAlt,\n} from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { useRecoilState } from \"recoil\"\n\nimport { GlobalMode, reloadGlobalMode } from \"../fabric/eig-util\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { getFabricOutput, saveCSVZip, saveJSONZip } from \"../storage/download\"\nimport { rotatingAtom, ViewMode, viewModeAtom } from \"../storage/recoil\"\n\nconst PUSH_RADIUS = 0.012\nconst PULL_RADIUS = 0.005\nconst JOINT_RADIUS = 0.015\n\nexport function BottomRight({tensegrity}: { tensegrity: Tensegrity }): JSX.Element {\n    const [stage, updateStage] = useState(tensegrity.stage$.getValue())\n    useEffect(() => {\n        const sub = tensegrity.stage$.subscribe(updateStage)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n    const [viewMode] = useRecoilState(viewModeAtom)\n    const [rotating, setRotating] = useRecoilState(rotatingAtom)\n\n    return (\n        <div className=\"text-right\">\n            <ButtonGroup>\n                {viewMode !== ViewMode.Time ? (\n                    <>\n                        <Button\n                            onClick={() => saveCSVZip(getFabricOutput(tensegrity, PUSH_RADIUS, PULL_RADIUS, JOINT_RADIUS))}>\n                            <FaDownload/><FaFileCsv/>\n                        </Button>\n                        <Button\n                            onClick={() => saveJSONZip(getFabricOutput(tensegrity, PUSH_RADIUS, PULL_RADIUS, JOINT_RADIUS))}>\n                            <FaDownload/><FaFile/>\n                        </Button>\n                    </>\n                ) : stage > Stage.Slack ? (\n                    <>\n                        <Button disabled={stage !== Stage.Pretenst}\n                                onClick={() => tensegrity.fabric.set_altitude(10)}>\n                            <FaParachuteBox/>\n                        </Button>\n                    </>\n                ) : undefined}\n                <Button onClick={() => tensegrity.fabric.centralize()}><FaCompressArrowsAlt/></Button>\n                <Button\n                    color={rotating ? \"warning\" : \"secondary\"}\n                    onClick={() => setRotating(!rotating)}\n                >\n                    <FaSyncAlt/>\n                </Button>\n                <Button color=\"warning\" onClick={() => reloadGlobalMode(GlobalMode.Choice)}>\n                    <FaSignOutAlt/>\n                </Button>\n            </ButtonGroup>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Color, CylinderGeometry, LineBasicMaterial, Material, MeshLambertMaterial } from \"three\"\n\nimport { IInterval, IRole } from \"../fabric/tensegrity-types\"\nimport { ViewMode } from \"../storage/recoil\"\n\nconst RAINBOW_GRADIENT = [\n    \"#fd0000\",\n    \"#c94f00\",\n    \"#d58e1c\",\n    \"#897c00\",\n    \"#6c8901\",\n    \"#1d6c01\",\n    \"#0e4e00\",\n    \"#007f67\",\n    \"#01808b\",\n    \"#005da3\",\n    \"#0015c7\",\n    \"#0000ff\",\n].reverse()\n\nconst RAINBOW_COLORS = RAINBOW_GRADIENT.map(c => new Color().setHex(parseInt(`${c.substring(1)}`, 16)))\n\nexport const LINE_VERTEX_COLORS = new LineBasicMaterial({\n    vertexColors: true,\n})\n\nconst RAINBOW_LAMBERT = RAINBOW_COLORS.map(color => new MeshLambertMaterial({color}))\n\nexport function rainbowMaterial(nuance: number): Material {\n    const index = Math.floor(nuance * RAINBOW_LAMBERT.length)\n    return RAINBOW_LAMBERT[index >= RAINBOW_LAMBERT.length ? RAINBOW_LAMBERT.length - 1 : index]\n}\n\nexport function roleColorString(role?: IRole): string {\n    if (!role) {\n        return \"#FFFFFF\"\n    }\n    switch (role.tag) {\n        case \"[A]\":\n            return \"#191f86\"\n        case \"[B]\":\n            return \"#5739a0\"\n        case \"(a)\":\n            return \"#a20d0d\"\n        case \"(b)\":\n            return \"#eeec05\"\n        case \"(aa)\":\n            return \"#da04b7\"\n        case \"(bb)\":\n            return \"#00ff06\"\n        default:\n            return \"#FFFFFF\"\n    }\n}\n\nexport function roleColor(role?: IRole): Color {\n    return new Color(roleColorString(role))\n}\n\nexport function roleMaterial(role: IRole, ghost?: boolean): Material {\n    const color = roleColor(role)\n    const opacity = ghost ? 0.4 : 1\n    const transparent = true\n    return new MeshLambertMaterial({color, opacity, transparent})\n}\n\nexport function cylinderRadius(interval: IInterval, viewMode: ViewMode): number {\n    switch (viewMode) {\n        case ViewMode.Select:\n            return interval.role.push ? 0.05 : 0.02\n        case ViewMode.Look:\n            return interval.role.push ? 0.03 : 0.01\n        default:\n            throw new Error(\"Bad view mode\")\n    }\n}\n\nexport const CYLINDER_GEOMETRY = new CylinderGeometry(1, 1, 1, 12, 1, false)\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\n\nimport { LINE_VERTEX_COLORS } from \"./materials\"\n\nexport function LiveView({tensegrity}: { tensegrity: Tensegrity }): JSX.Element {\n    return (\n        <lineSegments\n            key=\"lines\"\n            geometry={tensegrity.instance.floatView.lineGeometry}\n            material={LINE_VERTEX_COLORS}\n        />\n    )\n}\n\n//            onUpdate={self => self.geometry.computeBoundingSphere()}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { Euler, Vector3 } from \"three\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IInterval, intervalRotation } from \"../fabric/tensegrity-types\"\nimport { ViewMode } from \"../storage/recoil\"\n\nimport { cylinderRadius, CYLINDER_GEOMETRY, roleMaterial } from \"./materials\"\n\nexport function LookView({tensegrity}: { tensegrity: Tensegrity }): JSX.Element {\n    const instance = tensegrity.instance\n    return (\n        <group>\n            {tensegrity.intervals.map((interval: IInterval) => {\n                const {alpha, omega, role} = interval\n                const rotation = intervalRotation(instance.unitVector(interval.index))\n                const length = instance.jointDistance(alpha, omega)\n                const radius = cylinderRadius(interval, ViewMode.Look)\n                const intervalScale = new Vector3(radius, length, radius)\n                return (\n                    <mesh\n                        key={`T${interval.index}`}\n                        geometry={CYLINDER_GEOMETRY}\n                        position={instance.intervalLocation(interval)}\n                        rotation={new Euler().setFromQuaternion(rotation)}\n                        scale={intervalScale}\n                        material={roleMaterial(role)}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                )\n            })}\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Html } from \"@react-three/drei\"\nimport * as React from \"react\"\nimport { FaMousePointer } from \"react-icons/all\"\nimport { Table } from \"reactstrap\"\n\nimport { FabricInstance } from \"../fabric/fabric-instance\"\nimport { IIntervalDetails } from \"../fabric/tensegrity-types\"\n\nconst DIGITS = 1\n\nexport function IntervalDetails({instance, details, singleDetails, onClick}: {\n    instance: FabricInstance,\n    details: IIntervalDetails,\n    singleDetails: boolean,\n    onClick: (details: IIntervalDetails) => void,\n}): JSX.Element {\n    return (\n        <Html\n            className={`interval-details ${singleDetails ? \"single-details\" : \"\"}`}\n            position={instance.intervalLocation(details.interval)}\n        >\n            <div onMouseDown={(e) => onClick(details)}>\n\n                <div className=\"details-mouse\">\n                    <FaMousePointer/>\n                </div>\n                <Table className=\"details-table\">\n                    <thead>\n                    <tr>\n                        <td colSpan={2}>{details.interval.alpha.index}-{details.interval.omega.index}</td>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    <tr>\n                        <td className=\"text-right\">Length:</td>\n                        <td className=\"text-center\">{details.length.toFixed(DIGITS)}mm</td>\n                    </tr>\n                    <tr>\n                        <td className=\"text-right\">Height:</td>\n                        <td className=\"text-center\">{(details.height).toFixed(DIGITS)}mm</td>\n                    </tr>\n                    <tr>\n                        <td className=\"text-right\">Strain:</td>\n                        <td className=\"text-center\">{(details.strain * 100).toFixed(DIGITS)}%</td>\n                    </tr>\n                    </tbody>\n                </Table>\n            </div>\n        </Html>\n    )\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useRecoilState } from \"recoil\"\nimport { Euler, Vector3 } from \"three\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { areAdjacent, IInterval, IIntervalDetails, intervalRotation } from \"../fabric/tensegrity-types\"\nimport { selectedTwistAtom, ViewMode, visibleDetailsAtom } from \"../storage/recoil\"\n\nimport { IntervalDetails } from \"./interval-details\"\nimport { cylinderRadius, CYLINDER_GEOMETRY, roleMaterial } from \"./materials\"\n\nexport function SelectView({tensegrity, clickDetails}: {\n    tensegrity: Tensegrity,\n    clickDetails: (details: IIntervalDetails) => void,\n}): JSX.Element {\n    const [selected, setSelected] = useRecoilState(selectedTwistAtom)\n    const [details] = useRecoilState(visibleDetailsAtom)\n    const instance = tensegrity.instance\n    return (\n        <group>\n            {tensegrity.intervals.map((interval: IInterval) => {\n                const isPush = interval.role.push\n                if (!isPush) {\n                    if (selected) {\n                        const adjacent = selected.pushes.find(push => areAdjacent(push, interval))\n                        if (!adjacent) {\n                            return undefined\n                        }\n                    } else {\n                        return undefined\n                    }\n                }\n                const rotation = intervalRotation(instance.unitVector(interval.index))\n                const length = instance.jointDistance(interval.alpha, interval.omega)\n                const radius = cylinderRadius(interval, ViewMode.Select)\n                const intervalScale = new Vector3(radius, length, radius)\n                return (\n                    <mesh\n                        key={`T${interval.index}`}\n                        geometry={CYLINDER_GEOMETRY}\n                        position={instance.intervalLocation(interval)}\n                        rotation={new Euler().setFromQuaternion(rotation)}\n                        scale={intervalScale}\n                        material={roleMaterial(interval.role)}\n                        matrixWorldNeedsUpdate={true}\n                        onDoubleClick={event => {\n                            event.stopPropagation()\n                            if (!interval.role.push) {\n                                return\n                            }\n                            if (!selected) {\n                                setSelected(tensegrity.findTwist(interval))\n                            } else {\n                                const again = selected.pushes.find(push => push.index === interval.index)\n                                if (again) {\n                                    setSelected(undefined)\n                                } else {\n                                    setSelected(tensegrity.findTwist(interval))\n                                }\n                            }\n                        }}\n                    />\n                )\n            })}\n            {details.map(d => (\n                <IntervalDetails key={`deets-${d.interval.index}`} instance={tensegrity.instance}\n                                 details={d} singleDetails={details.length === 1} onClick={clickDetails}\n                />\n            ))}\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useMemo } from \"react\"\nimport { BufferAttribute, BufferGeometry, Color, FrontSide, MeshPhongMaterial, Vector3 } from \"three\"\n\nconst MATERIAL = new MeshPhongMaterial({\n    color: new Color(\"#070707\"),\n    specular: new Color(\"#110404\"),\n    side: FrontSide,\n})\nconst KINDA = 0.866\nconst SURFACE_SCALE = 20\nconst HEXAGON_POINTS = [\n    new Vector3(0, 0, -SURFACE_SCALE),\n    new Vector3(-KINDA * SURFACE_SCALE, 0, -SURFACE_SCALE / 2),\n    new Vector3(-KINDA * SURFACE_SCALE, 0, SURFACE_SCALE / 2),\n    new Vector3(0, 0, SURFACE_SCALE),\n    new Vector3(KINDA * SURFACE_SCALE, 0, SURFACE_SCALE / 2),\n    new Vector3(KINDA * SURFACE_SCALE, 0, -SURFACE_SCALE / 2),\n    new Vector3(),\n]\nconst TRIANGLES = [\n    6, 0, 1,\n    6, 1, 2,\n    6, 2, 3,\n    6, 3, 4,\n    6, 4, 5,\n    6, 5, 0,\n]\nconst TRIANGLE_POSITION = TRIANGLES.map(t => HEXAGON_POINTS[t])\n\nexport function SurfaceComponent(): JSX.Element {\n    const geometry = useMemo(() => patchesGeometry(), [])\n    return <mesh name=\"Patches\" geometry={geometry} material={MATERIAL}/>\n}\n\nfunction patchesGeometry(): BufferGeometry {\n    const geometry = new BufferGeometry()\n    const positionF32 = new Float32Array(TRIANGLE_POSITION.length * 3)\n    const normalF32 = new Float32Array(TRIANGLE_POSITION.length * 3)\n    TRIANGLE_POSITION.forEach((position, index) => {\n        const faceOffset = index * 3\n        positionF32[faceOffset] = position.x\n        positionF32[faceOffset + 1] = position.y - 0.01\n        positionF32[faceOffset + 2] = position.z\n        const normal = new Vector3(0,300,0).add(position).normalize()\n        normalF32[faceOffset] = normal.x\n        normalF32[faceOffset + 1] = normal.y\n        normalF32[faceOffset + 2] = normal.z\n    })\n    geometry.setAttribute(\"position\", new BufferAttribute(positionF32, 3))\n    geometry.setAttribute(\"normal\", new BufferAttribute(normalF32, 3))\n    return geometry\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { OrbitControls, Stars } from \"@react-three/drei\"\nimport { useFrame } from \"@react-three/fiber\"\nimport { Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { useRecoilState } from \"recoil\"\nimport { Color, Vector3 } from \"three\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IIntervalDetails } from \"../fabric/tensegrity-types\"\nimport { rotatingAtom, selectedTwistAtom, ViewMode, viewModeAtom } from \"../storage/recoil\"\nimport { LiveView } from \"../view/live-view\"\nimport { LookView } from \"../view/look-view\"\nimport { SelectView } from \"../view/select-view\"\nimport { SurfaceComponent } from \"../view/surface-component\"\n\nconst TOWARDS_TARGET = 0.1\nconst TOWARDS_POSITION = 0.1\n\nexport function ObjectView({tensegrity, clickDetails}: {\n    tensegrity: Tensegrity,\n    clickDetails: (details: IIntervalDetails) => void,\n}): JSX.Element {\n    const [viewMode] = useRecoilState(viewModeAtom)\n    const [selected] = useRecoilState(selectedTwistAtom)\n    const [aim, setAim] = useState(new Vector3())\n    const [stage, updateStage] = useState(tensegrity.stage$.getValue())\n    useEffect(() => {\n        const sub = tensegrity.stage$.subscribe(updateStage)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n    const [rotating] = useRecoilState(rotatingAtom)\n    useFrame(state => {\n        if (viewMode === ViewMode.Time) {\n            tensegrity.iterate()\n        }\n        const midpoint = selected ? tensegrity.instance.twistLocation(selected) : tensegrity.instance.midpoint\n        const toMidpoint = new Vector3().subVectors(midpoint, aim).multiplyScalar(TOWARDS_TARGET)\n        if (viewMode === ViewMode.Time || toMidpoint.lengthSq() > 0.001) {\n            setAim(new Vector3().copy(aim).add(toMidpoint))\n        }\n        if (stage === Stage.Growing) {\n            state.camera.position.y += (midpoint.y - state.camera.position.y) * TOWARDS_POSITION\n            const distanceChange = state.camera.position.distanceTo(midpoint) - tensegrity.instance.view.radius() * 1.5\n            const towardsDistance = new Vector3().subVectors(midpoint, state.camera.position).normalize().multiplyScalar(distanceChange * TOWARDS_POSITION)\n            state.camera.position.add(towardsDistance)\n        } else {\n            if (state.camera.position.y < 0) {\n                state.camera.position.y -= state.camera.position.y * TOWARDS_POSITION * 20\n            }\n        }\n\n    })\n    const Rendering = () => {\n        switch (viewMode) {\n            case ViewMode.Time:\n                return <LiveView tensegrity={tensegrity}/>\n            case ViewMode.Select:\n                return <SelectView tensegrity={tensegrity} clickDetails={clickDetails}/>\n            case ViewMode.Look:\n                return <LookView tensegrity={tensegrity}/>\n        }\n    }\n    return (\n        <group>\n            <OrbitControls autoRotate={rotating} target={aim} zoomSpeed={0.5} maxDistance={200}/>\n            <scene>\n                <Rendering/>\n                <SurfaceComponent/>\n                <Stars radius={400}/>\n                <ambientLight color={new Color(\"white\")} intensity={0.8}/>\n                <directionalLight color={new Color(\"#FFFFFF\")} intensity={2}/>\n            </scene>\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Canvas } from \"@react-three/fiber\"\nimport { default_world_feature, Stage, WorldFeature } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useMemo, useState } from \"react\"\nimport { FaPlay } from \"react-icons/all\"\nimport { useRecoilBridgeAcrossReactRoots_UNSTABLE, useRecoilState, useSetRecoilState } from \"recoil\"\nimport { Vector3 } from \"three\"\n\nimport { stageName, WORLD_FEATURES } from \"../fabric/eig-util\"\nimport { CreateInstance } from \"../fabric/fabric-instance\"\nimport { compileTenscript, ITenscript, RunTenscript, TenscriptBuilder } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { adjacentPullsFromTwist } from \"../fabric/twist-logic\"\nimport { postGrowthAtom, selectedTwistAtom, ViewMode, viewModeAtom, visibleDetailsAtom } from \"../storage/recoil\"\nimport { BottomLeft } from \"../view/bottom-left\"\nimport { BottomRight } from \"../view/bottom-right\"\nimport { featureMapping } from \"../view/feature-mapping\"\n\nimport { ObjectView } from \"./object-view\"\n\nexport function ConstructionView({tenscript, createInstance}: {\n    tenscript: ITenscript,\n    createInstance: CreateInstance,\n}): JSX.Element {\n    const mainInstance = useMemo(() => createInstance(tenscript.featureValues), [])\n    const [tensegrity, setTensegrity] = useState<Tensegrity | undefined>()\n    const [viewMode, setViewMode] = useRecoilState(viewModeAtom)\n    const [selected, setSelected] = useRecoilState(selectedTwistAtom)\n    const [details, setDetails] = useRecoilState(visibleDetailsAtom)\n    const setPostGrowth = useSetRecoilState(postGrowthAtom)\n    const emergency = (message: string) => console.error(\"build view\", message)\n    const [stage, updateStage] = useState<Stage | undefined>()\n\n    useEffect(() => {\n        const sub = tensegrity ? tensegrity.stage$.subscribe(updateStage) : undefined\n        return () => {\n            if (sub) {\n                sub.unsubscribe()\n            }\n        }\n    }, [tensegrity])\n\n    const createTensegrity: RunTenscript = (ts: ITenscript, error: (message: string) => void) => {\n        try {\n            const tree = compileTenscript(ts, error)\n            if (!tree) {\n                return false\n            }\n            setViewMode(ViewMode.Time)\n            setPostGrowth(ts.postGrowthOp)\n            const featureValues = ts.featureValues\n            WORLD_FEATURES.map(key => {\n                const feature = WorldFeature[key]\n                const {percentToValue} = featureMapping(feature)\n                const percent = featureValues ? featureValues[key] : undefined\n                if (percent !== undefined) {\n                    mainInstance.applyFeature({feature, percent, value: percentToValue(percent)}, true)\n                }\n            })\n            const localValue = featureValues ? featureValues[WorldFeature.IntervalCountdown] : undefined\n            const countdown = localValue === undefined ? default_world_feature(WorldFeature.IntervalCountdown) : localValue\n            const builder = new TenscriptBuilder(new Vector3(), ts, tree)\n            setTensegrity(new Tensegrity(mainInstance, countdown, builder))\n        } catch (e) {\n            throw new Error(\"Problem running\")\n        }\n        return true\n    }\n    useEffect(() => {\n        createTensegrity(tenscript, emergency)\n    }, [])\n    useEffect(() => {\n        if (viewMode === ViewMode.Time) {\n            setSelected(undefined)\n        }\n    }, [viewMode])\n    useEffect(() => {\n        if (tensegrity) {\n            if (selected) {\n                setDetails(selected.pushes.map(push => tensegrity.getIntervalDetails(push)))\n            } else {\n                setDetails([])\n            }\n        }\n    }, [selected])\n\n    const Title = () => {\n        switch (viewMode) {\n            case ViewMode.Time:\n                return <span>{stage !== undefined ? stageName(stage) : \"New\"} {tensegrity ? `\"${tensegrity.name}\"` : \"\"}</span>\n            case ViewMode.Select:\n                return <span>Double click to select a twist</span>\n            case ViewMode.Look:\n                return <span>{tensegrity ? `\"${tensegrity.name}\"` : \"\"}</span>\n        }\n    }\n\n    // const camera = useRef<Cam>()\n    const RecoilBridge = useRecoilBridgeAcrossReactRoots_UNSTABLE()\n    return (\n        <div style={{\n            position: \"absolute\",\n            left: 0,\n            right: 0,\n            height: \"100%\",\n        }}>\n            {!tensegrity ? (\n                <div className=\"h-100\">\n                    <div style={{position: \"relative\", top: \"50%\", left: \"50%\"}}>\n                        <h1><FaPlay/></h1>\n                    </div>\n                </div>\n            ) : (\n                <div className=\"h-100\">\n                    <Canvas\n                        style={{\n                            backgroundColor: \"black\",\n                            borderStyle: \"solid\",\n                            borderColor: viewMode !== ViewMode.Time ? \"#f0ad4e\" : \"black\",\n                            cursor: viewMode === ViewMode.Select ? \"pointer\" : \"default\",\n                            borderWidth: \"2px\",\n                        }}\n                    >\n                        <RecoilBridge>\n                            <ObjectView\n                                tensegrity={tensegrity}\n                                clickDetails={({interval}) => {\n                                    if (!selected || !tensegrity) {\n                                        return\n                                    }\n                                    if (details.length === 1) { // one pull, presumably\n                                        setDetails(adjacentPullsFromTwist(tensegrity, selected).map(pull => tensegrity.getIntervalDetails(pull)))\n                                    } else {\n                                        if (interval.role.push) {\n                                            setDetails(adjacentPullsFromTwist(tensegrity, selected).map(pull => tensegrity.getIntervalDetails(pull)))\n                                        } else {\n                                            setDetails(details.filter(d => d.interval.index === interval.index))\n                                        }\n                                    }\n                                }}\n                            />\n                        </RecoilBridge>\n                    </Canvas>\n                    <div id=\"top-middle\">\n                        <Title/>\n                    </div>\n                    <div id=\"bottom-left\">\n                        <BottomLeft/>\n                    </div>\n                    <div id=\"bottom-right\">\n                        <BottomRight tensegrity={tensegrity}/>\n                    </div>\n                </div>\n            )}\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Color, Vector3 } from \"three\"\n\nexport const PATCH_SURROUNDING_SHAPE = [\n    // center\n    {x: 0, y: 0},\n    // layer 1\n    {x: 2, y: 0}, // 1\n    {x: 1, y: -1},\n    {x: -1, y: -1},\n    {x: -2, y: 0},\n    {x: -1, y: 1},\n    {x: 1, y: 1}, // 6\n    // layer 2\n    {x: 4, y: 0}, // 7\n    {x: 3, y: -1},\n    {x: 2, y: -2},\n    {x: 0, y: -2},\n    {x: -2, y: -2},\n    {x: -3, y: -1},\n    {x: -4, y: 0},\n    {x: -3, y: 1},\n    {x: -2, y: 2},\n    {x: 0, y: 2},\n    {x: 2, y: 2},\n    {x: 3, y: 1}, // 18\n    // layer 3\n    {x: 6, y: 0}, // 19\n    {x: 5, y: -1},\n    {x: 4, y: -2},\n    {x: 3, y: -3},\n    {x: 1, y: -3},\n    {x: -1, y: -3},\n    {x: -3, y: -3},\n    {x: -4, y: -2},\n    {x: -5, y: -1},\n    {x: -6, y: 0},\n    {x: -5, y: 1},\n    {x: -4, y: 2},\n    {x: -3, y: 3},\n    {x: -1, y: 3},\n    {x: 1, y: 3},\n    {x: 3, y: 3},\n    {x: 4, y: 2},\n    {x: 5, y: 1}, // 36\n]\n\nexport const ADJACENT = [\n    {x: 2, y: 0}, // 1\n    {x: 1, y: -1},\n    {x: -1, y: -1},\n    {x: -2, y: 0},\n    {x: -1, y: 1},\n    {x: 1, y: 1}, // 6\n]\n\nconst PATCH_DISTANCE = 35\n\nexport const SIN_60 = Math.sin(60 * Math.PI / 180)\nexport const SURFACE_SCALE = PATCH_DISTANCE / 2 / SIN_60\nexport const SCALE_X = SURFACE_SCALE * SIN_60\nexport const SCALE_Y = SURFACE_SCALE * 1.5\n\nexport const HEXAGON_POINTS = [\n    new Vector3(0, 0, -SURFACE_SCALE),\n    new Vector3(-SIN_60 * SURFACE_SCALE, 0, -SURFACE_SCALE / 2),\n    new Vector3(-SIN_60 * SURFACE_SCALE, 0, SURFACE_SCALE / 2),\n    new Vector3(0, 0, SURFACE_SCALE),\n    new Vector3(SIN_60 * SURFACE_SCALE, 0, SURFACE_SCALE / 2),\n    new Vector3(SIN_60 * SURFACE_SCALE, 0, -SURFACE_SCALE / 2),\n]\nexport const FAUNA_PATCH_COLOR = new Color(\"#091009\")\nexport const FLORA_PATCH_COLOR = new Color(\"#100902\")\nexport const SIX = 6\nexport const UP = new Vector3(0, 1, 0)\nexport const NORMAL_SPREAD = 0.9 / PATCH_DISTANCE\nexport const SUN_POSITION = new Vector3(0, 500, 0)\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { IMuscle } from \"./runner-logic\"\nimport { ITwitchConfig } from \"./twitcher\"\n\nexport class Genome {\n    constructor(private roll: () => IDie, private genes: IGene[]) {\n    }\n\n    public createReader(name: GeneName): GeneReader {\n        return new GeneReader(getGene(name, this.genes), this.roll)\n    }\n\n    public get totalTwitches(): number {\n        return 16\n    }\n\n    public withMutations(directionGeneNames: GeneName[], mutateTwitchConfig: boolean): Genome {\n        const genesCopy: IGene[] = this.genes.map(gene => {\n            const {geneName, tosses} = gene\n            const dice = gene.dice.slice() // TODO: tweet this to the world\n            return {geneName, tosses, dice}\n        })\n        directionGeneNames.forEach(directionName => {\n            const directionGene = getGene(directionName, genesCopy)\n            mutateGene(() => this.roll(), directionGene)\n        })\n        if (mutateTwitchConfig) {\n            const twitchConfig = getGene(GeneName.TwitchConfig, genesCopy)\n            mutateGene(() => this.roll(), twitchConfig)\n            twitchConfig.tosses++\n        }\n        return new Genome(this.roll, genesCopy)\n    }\n\n    public get geneData(): IGeneData[] {\n        return this.genes.map(gene => {\n            const {geneName, tosses, dice} = gene\n            const geneString = serializeGene(dice)\n            return <IGeneData>{geneName, tosses, geneString}\n        })\n    }\n\n    public get tosses(): number {\n        return this.genes.reduce((sum, {tosses}: IGene) => sum + tosses, 0)\n    }\n\n    public toString(): string {\n        return this.genes.map(gene => `(${gene.geneName}:${gene.tosses})`).join(\", \")\n        // return this.genes.map(gene => serializeGene(gene.dice)).join(\"\\n\")\n    }\n}\n\nexport class GeneReader {\n    private cursor = 0\n\n    constructor(private gene: IGene, private roll: () => IDie) {\n    }\n\n    public chooseFrom(total: number): number {\n        return Math.floor(total * diceToNuance(this.nextDie(), this.nextDie()))\n    }\n\n    public readMuscleTwitch(loop: IMuscle[], config: ITwitchConfig): ITwitch {\n        const {attackPeriod, decayPeriod, twitchNuance} = config\n        const muscle = loop[this.nextDie().index]\n        return {\n            muscle, twitchNuance,\n            when: diceToInteger(36, this.nextDie(), this.nextDie()),\n            attack: (2 + diceToFloat(6, this.nextDie())) * attackPeriod,\n            decay: (2 + diceToFloat(6, this.nextDie())) * decayPeriod,\n        }\n    }\n\n    public readFeatureValue(low: number, high: number): number {\n        const nuance = diceToNuance(this.nextDie(), this.nextDie(), this.nextDie())\n        return low * nuance + high * (1 - nuance)\n    }\n\n    public get length(): number {\n        return this.gene.dice.length\n    }\n\n    public nextDie(): IDie {\n        while (this.gene.dice.length < this.cursor + 1) {\n            this.gene.dice.push(this.roll())\n        }\n        return this.gene.dice[this.cursor++]\n    }\n}\n\ninterface IDie {\n    index: number\n    numeral: string\n    symbol: string\n}\n\nconst DICE: IDie[] = [\n    {index: 0, numeral: \"1\", symbol: \"⚀\"},\n    {index: 1, numeral: \"2\", symbol: \"⚁\"},\n    {index: 2, numeral: \"3\", symbol: \"⚂\"},\n    {index: 3, numeral: \"4\", symbol: \"⚃\"},\n    {index: 4, numeral: \"5\", symbol: \"⚄\"},\n    {index: 5, numeral: \"6\", symbol: \"⚅\"},\n]\n\nconst DICE_MAP = ((): { [key: string]: IDie; } => {\n    const map = {}\n    DICE.forEach(die => {\n        map[die.numeral] = die\n        map[die.symbol] = die\n    })\n    return map\n})()\n\nfunction diceToInteger(max: number, ...dice: IDie[]): number {\n    return Math.floor(diceToNuance(...dice) * max)\n}\n\nfunction diceToFloat(max: number, ...dice: IDie[]): number {\n    return diceToNuance(...dice) * max\n}\n\nfunction mutateGene(roll: () => IDie, gene: IGene): void {\n    if (gene.dice.length === 0) {\n        gene.dice.push(roll())\n    } else {\n        const woops = Math.floor(Math.random() * gene.dice.length)\n        const currentRoll = gene.dice[woops]\n        while (gene.dice[woops] === currentRoll) {\n            gene.dice[woops] = roll()\n        }\n    }\n    gene.tosses++\n}\n\nfunction rollTheDice(): IDie {\n    return DICE[Math.floor(Math.random() * DICE.length)]\n}\n\nfunction diceToNuance(...dice: IDie[]): number {\n    if (dice.length === 0) {\n        throw new Error(\"No dice!\")\n    }\n    const base6 = dice.reduce((sum: number, die: IDie) => sum * 6 + die.index, 0)\n    return base6 / Math.pow(6, dice.length)\n}\n\nfunction serializeGene(dice: IDie[]): string {\n    return dice.map(die => die.symbol).join(\"\")\n}\n\nfunction deserializeGene(s: string): IDie[] {\n    return s.split(\"\").map((numeral: string): IDie => DICE_MAP[numeral]).filter(die => !!die)\n}\n\nexport enum GeneName {\n    ToA = \"ToA\",\n    ToB = \"ToB\",\n    ToC = \"ToC\",\n    TwitchConfig = \"TwitchConfig\",\n}\n\nexport interface IGeneData {\n    geneName: GeneName\n    tosses: number\n    geneString: string\n}\n\nexport interface ITwitch {\n    when: number\n    muscle: IMuscle\n    attack: number\n    decay: number\n    twitchNuance: number\n}\n\nexport function emptyGenome(): Genome {\n    return new Genome(rollTheDice, [])\n}\n\nexport function fromGeneData(geneData: IGeneData[]): Genome {\n    if (geneData.length === 0) {\n        return emptyGenome()\n    }\n    const genes = geneData.map(({geneName, tosses, geneString}) => {\n        const dice = deserializeGene(geneString)\n        return {geneName, tosses, dice}\n    })\n    return new Genome(rollTheDice, genes)\n}\n\nexport interface IGene {\n    geneName: GeneName\n    tosses: number\n    dice: IDie[]\n}\n\nfunction getGene(search: GeneName, genes: IGene[]): IGene {\n    const existing = genes.find(({geneName}) => search === geneName)\n    if (existing) {\n        return existing\n    }\n    const fresh: IGene = {geneName: search, tosses: 0, dice: []}\n    genes.push(fresh)\n    return fresh\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Vector3 } from \"three\"\n\nimport { ADJACENT, PATCH_SURROUNDING_SHAPE } from \"./island-geometry\"\nimport { Patch } from \"./patch\"\n\nexport interface ICoords {\n    x: number\n    y: number\n}\n\nexport enum PatchCharacter {\n    FaunaPatch = \"Fauna\",\n    FloraPatch = \"Flora\",\n}\n\nfunction equals(a: ICoords, b: ICoords): boolean {\n    return a.x === b.x && a.y === b.y\n}\n\nfunction plus(a: ICoords, b: ICoords): ICoords {\n    return {x: a.x + b.x, y: a.y + b.y}\n}\n\nexport class Island {\n    public patches: Patch[] = []\n\n    private _seed: number\n\n    constructor(public readonly name: string, seed: number) {\n        this._seed = seed % 2147483647\n        this.fill()\n    }\n\n    public get midpoint(): Vector3 {\n        return this.patches\n            .reduce((sum: Vector3, patch: Patch) => sum.add(patch.center), new Vector3())\n            .multiplyScalar(1 / this.patches.length)\n    }\n\n    public findPatch(coords: ICoords): Patch | undefined {\n        return this.patches.find(p => equals(p.coords, coords))\n    }\n\n    // ================================================================================================\n\n    private fill(): void {\n        this.createSurroundedPatch({x: 0, y: 0})\n        // todo: random walk/tree?\n        this.patches.forEach(patch => {\n            const coords = patch.coords\n            ADJACENT.forEach(({x, y}) => {\n                patch.adjacent.push(this.findPatch({x: x + coords.x, y: y + coords.y}))\n            })\n        })\n    }\n\n    private createSurroundedPatch(coords: ICoords): Patch {\n        const patch = this.getOrCreatePatch(coords)\n        PATCH_SURROUNDING_SHAPE.map(c => this.getOrCreatePatch(plus(c, coords)))\n        return patch\n    }\n\n    private getOrCreatePatch(coords: ICoords): Patch {\n        const existing = this.findPatch(coords)\n        if (existing) {\n            return existing\n        }\n        const surface = (this.next() > 0.5) ? PatchCharacter.FaunaPatch : PatchCharacter.FloraPatch\n        const patch = new Patch(this, coords, surface)\n        this.patches.push(patch)\n        return patch\n    }\n\n    private next(): number {\n        this._seed = this._seed * 16807 % 2147483647\n        return (this._seed - 1) / 2147483646\n    }\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Vector3 } from \"three\"\n\nimport { Flora } from \"./flora\"\nimport { emptyGenome, IGeneData } from \"./genome\"\nimport { ICoords, Island, PatchCharacter } from \"./island\"\nimport { HEXAGON_POINTS, NORMAL_SPREAD, SCALE_X, SCALE_Y, SIX, UP } from \"./island-geometry\"\nimport { Runner } from \"./runner\"\n\nexport class Patch {\n    public runner?: Runner\n    public flora?: Flora\n    public readonly center: Vector3\n    public readonly name: string\n    public adjacent: (Patch | undefined)[] = []\n\n    constructor(\n        public readonly island: Island,\n        public readonly coords: ICoords,\n        public patchCharacter: PatchCharacter,\n    ) {\n        this.center = new Vector3(coords.x * SCALE_X, 0, coords.y * SCALE_Y)\n        this.name = `(${coords.x},${coords.y})`\n    }\n\n    public get storedGenes(): IGeneData[][] {\n        const item = localStorage.getItem(this.name)\n        return item ? JSON.parse(item) : [emptyGenome().geneData]\n    }\n\n    public set storedGenes(geneData: IGeneData[][]) {\n        localStorage.setItem(this.name, JSON.stringify(geneData))\n        // console.log(`Saving genome to ${this.name}`, geneData)\n    }\n\n    public get positionArray(): Float32Array {\n        const array = new Float32Array(SIX * 3 * 3)\n        let index = 0\n        const add = (point: Vector3) => {\n            const {x, y, z} = new Vector3().copy(this.center).addScaledVector(point, 0.99)\n            array[index++] = x\n            array[index++] = y\n            array[index++] = z\n        }\n        for (let a = 0; a < SIX; a++) {\n            const b = (a + 1) % SIX\n            add(new Vector3())\n            add(HEXAGON_POINTS[a])\n            add(HEXAGON_POINTS[b])\n        }\n        return array\n    }\n\n    public get normalArray(): Float32Array {\n        const array = new Float32Array(SIX * 3 * 3)\n        let index = 0\n        const add = ({x, y, z}: Vector3) => {\n            array[index++] = x\n            array[index++] = y\n            array[index++] = z\n        }\n        for (let a = 0; a < SIX; a++) {\n            const b = (a + 1) % SIX\n            add(UP)\n            add(new Vector3().add(UP).addScaledVector(HEXAGON_POINTS[a], NORMAL_SPREAD).normalize())\n            add(new Vector3().add(UP).addScaledVector(HEXAGON_POINTS[b], NORMAL_SPREAD).normalize())\n        }\n        return array\n    }\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { SurfaceCharacter, WorldFeature } from \"eig\"\nimport { atom, selector } from \"recoil\"\n\nimport { ITenscript } from \"../fabric/tenscript\"\nimport { PostGrowthOp } from \"../fabric/tensegrity\"\nimport { Spin } from \"../fabric/tensegrity-types\"\n\nimport { Island } from \"./island\"\nimport { Patch } from \"./patch\"\n\nconst LEG = 5\nconst SCALE = 90\n\nexport const RUNNER_CODE: ITenscript = {\n    name: \"Runner\",\n    spin: Spin.LeftRight,\n    code: [\n        `(A1,B(${LEG},S${SCALE}),C(${LEG},S${SCALE}),D(${LEG},S${SCALE}))`,\n    ],\n    postGrowthOp: PostGrowthOp.Bowtie,\n    markDefStrings: {},\n    surfaceCharacter: SurfaceCharacter.Bouncy,\n    featureValues: {\n        [WorldFeature.IterationsPerFrame]: 300,\n        [WorldFeature.Drag]: 200,\n        [WorldFeature.StiffnessFactor]: 150,\n        [WorldFeature.Gravity]: 500,\n    },\n}\n\nexport const FLORA_CODE: ITenscript = {\n    name: \"Flora\",\n    postGrowthOp: PostGrowthOp.Bowtie,\n    code: [\"(2,S85,b(4,S85,MA0),c(4,S85,MA0),d(4,S85,MA0))\"],\n    spin: Spin.Left,\n    markDefStrings: {\n        0: \"subtree(b(3, S85),c(3, S85),d(3, S85))\",\n    },\n    surfaceCharacter: SurfaceCharacter.Frozen,\n    featureValues: {},\n}\n\nexport const islandAtom = atom<Island>({\n    key: \"island\",\n    default: new Island(\"galapagos\", 383),\n})\n\nexport const homePatchSelector = selector<Patch>({\n    key: \"MySelector\",\n    get: ({get}) => get(islandAtom).patches[0], // todo: for now\n})\n\nexport const destinationAtom = atom<number>({\n    key: \"destination\",\n    default: 0,\n})\n\nexport const showDetailsAtom = atom<boolean>({\n    key: \"showDetails\",\n    default: false,\n})\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Vector3 } from \"three\"\n\nimport { FabricInstance } from \"../fabric/fabric-instance\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IInterval, IJoint, ITwistFace } from \"../fabric/tensegrity-types\"\n\nimport { GeneName, Genome } from \"./genome\"\nimport { Patch } from \"./patch\"\n\nexport enum Direction {\n    Rest = \"Rest\",\n    ToA = \"ToA\",\n    ToB = \"ToB\",\n    ToC = \"ToC\",\n}\n\nexport const DIRECTIONS: Direction[] = Object.keys(Direction).map(k => Direction[k])\n\nexport function directionGene(direction: Direction): GeneName {\n    switch (direction) {\n        case Direction.ToA:\n            return GeneName.ToA\n        case Direction.ToB:\n            return GeneName.ToB\n        case Direction.ToC:\n            return GeneName.ToC\n        default:\n            throw new Error(`No gene for direction ${direction}`)\n    }\n}\n\nexport interface IMuscle {\n    interval: IInterval\n    alphaInterval?: IInterval\n    omegaInterval?: IInterval\n}\n\nexport interface IRunnerState {\n    patch: Patch\n    targetPatch: Patch\n    instance: FabricInstance\n    midpoint: Vector3,\n    genome: Genome\n    loopMuscles: IMuscle[][]\n    direction: Direction\n    directionHistory: Direction[]\n    autopilot: boolean\n    timeSlice: number\n    twitchesPerCycle: number\n}\n\nexport function findTopFace(tensegrity: Tensegrity): ITwistFace {\n    const sortedFaces = tensegrity.faces.sort((a, b) => {\n        const aa = a.joint\n        const bb = b.joint\n        if (!aa || !bb) {\n            throw new Error(\"faces without joints\")\n        }\n        const locA = tensegrity.instance.jointLocation(aa)\n        const locB = tensegrity.instance.jointLocation(bb)\n        return locA.y - locB.y\n    })\n    const top = sortedFaces.pop()\n    sortedFaces.forEach(face => tensegrity.faceToTriangle(face))\n    if (!top) {\n        throw new Error(\"no top face\")\n    }\n    return top\n}\n\nexport function calculateDirections(instance: FabricInstance, toA: Vector3, toB: Vector3, toC: Vector3, face?: ITwistFace): void {\n    if (!face) {\n        return\n    }\n    const joint = face.joint\n    if (!joint) {\n        return undefined\n    }\n    const locations = instance.floatView.jointLocations\n    const fromTo = (fromJoint: IJoint, toJoint: IJoint, vector: Vector3) => {\n        const from = fromJoint.index * 3\n        const to = toJoint.index * 3\n        vector.set(locations[to] - locations[from], 0, locations[to + 2] - locations[from + 2])\n        vector.normalize()\n    }\n    fromTo(joint, face.ends[0], toA)\n    fromTo(joint, face.ends[1], toB)\n    fromTo(joint, face.ends[2], toC)\n}\n\nexport function extractLoopMuscles(tensegrity: Tensegrity): IMuscle[][] {\n    const loopMuscles: IMuscle[][] = []\n    tensegrity.withPulls(() => {\n        tensegrity.loops.forEach(loop => loopMuscles.push(loop.map(interval => {\n            const alphaPulls = interval.alpha.pulls\n            const omegaPulls = interval.omega.pulls\n            if (!alphaPulls || !omegaPulls) {\n                throw new Error(\"missing pulls\")\n            }\n            const onlyMuscles = ({role}: IInterval) => role.tag === \"(aa)\" || role.tag === \"(bb)\"\n            const alphaInterval = alphaPulls.find(onlyMuscles)\n            const omegaInterval = omegaPulls.find(onlyMuscles)\n            if (!alphaInterval && !omegaInterval) {\n                throw new Error(\"cannot find any intervals\")\n            }\n            return <IMuscle>{interval, alphaInterval, omegaInterval}\n        })))\n    })\n    return loopMuscles\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { BehaviorSubject } from \"rxjs\"\nimport { Vector3 } from \"three\"\n\nimport { CreateInstance } from \"../fabric/fabric-instance\"\n\nimport { RUNNER_CODE } from \"./evo-state\"\nimport { fromGeneData, Genome } from \"./genome\"\nimport { Runner } from \"./runner\"\nimport { directionGene } from \"./runner-logic\"\n\nexport interface IEvolutionParameters {\n    cyclePattern: number[]\n    persistentPopulation: number\n    challengerPopulation: number\n}\n\nexport const EVO_PARAMETERS: IEvolutionParameters = {\n    cyclePattern: [4, 5, 6, 7, 8, 9],\n    persistentPopulation: 8,\n    challengerPopulation: 8,\n}\n\nexport enum EvolutionPhase {\n    SurvivorsAdvance = \"Survivors advance\",\n    ChallengersBorn = \"Challengers born\",\n    ChallengersReborn = \"Challengers reborn\",\n    ChallengersOvertake = \"Challengers try to overtake\",\n    SurvivorsStored = \"Survivors stored\",\n    EvolutionAdvance = \"Evolution advance\",\n    EvolutionDone = \"Evolution done\",\n    EvolutionHarder = \"Evolution harder\",\n}\n\nexport interface IEvolver {\n    name: string\n    runner: Runner\n    proximityHistory: number[]\n    persisted: boolean\n}\n\nexport interface ISplit {\n    cycleCount: number,\n    winners: IEvolver[],\n    losers: IEvolver[]\n}\n\nexport interface IEvolverSnapshot {\n    name: string,\n    proximity: number\n    tosses: number,\n    reachedTarget: boolean,\n    persisted: boolean\n}\n\nexport interface IEvolutionSnapshot {\n    cyclePattern: number[]\n    cycle: number\n    cycleIndex: number\n    evolverSnapshots: IEvolverSnapshot[]\n}\n\nexport class Population {\n    public readonly snapshotsSubject = new BehaviorSubject<IEvolutionSnapshot[]>([])\n    public winners: IEvolver[] = []\n    public midpoint: Vector3\n    public challengersVisible = false\n    public challengers: IEvolver[] = []\n    public phase = EvolutionPhase.SurvivorsAdvance\n    private cyclePatternIndex: number\n    private currentCycle: number = 0\n    private currentMaxCycles: number\n\n    constructor(\n        private ancestor: Runner,\n        private createInstance: CreateInstance,\n        private useTwitches: boolean,\n        private cyclePattern: number[],\n    ) {\n        if (ancestor.embryo) {\n            throw new Error(\"Cannot create evolution from runner which is not pretenst\")\n        }\n        this.midpoint = ancestor.state.midpoint\n        this.currentMaxCycles = this.cyclePattern[this.cyclePatternIndex = 0]\n        const winners: Runner[] = []\n        const storedGenes = ancestor.state.patch.storedGenes\n        while (winners.length < EVO_PARAMETERS.persistentPopulation) {\n            winners.push(this.createAutoRunner(fromGeneData(storedGenes[winners.length % storedGenes.length])))\n        }\n        this.winners = winners.map((runner, index) => ({\n            runner,\n            name: letter(index),\n            proximityHistory: [],\n            persisted: true,\n        }))\n    }\n\n    public get withReducedCyclePattern(): Population | undefined {\n        const cyclePattern = [...this.cyclePattern]\n        cyclePattern.pop()\n        if (cyclePattern.length < 3) {\n            return undefined\n        }\n        return new Population(this.ancestor, this.createInstance, this.useTwitches, cyclePattern)\n    }\n\n    public iterate(): EvolutionPhase {\n        switch (this.phase) {\n            case EvolutionPhase.SurvivorsAdvance:\n                let winnerMinCycles = 0\n                let winnerMoved = false\n                this.winners.forEach(({runner}) => {\n                    const cycleCount = runner.getCycleCount(this.useTwitches)\n                    if (cycleCount > winnerMinCycles) {\n                        winnerMinCycles = cycleCount\n                    }\n                    if (cycleCount < this.currentMaxCycles) {\n                        runner.iterate()\n                        winnerMoved = true\n                    }\n                })\n                if (winnerMinCycles > this.currentCycle) {\n                    rankEvolvers(this.winners, this.currentCycle)\n                    this.currentCycle = winnerMinCycles\n                }\n                if (!winnerMoved) {\n                    const allWinnersReachedTarget = !this.winners.find(({runner}) => !runner.reachedTarget)\n                    if (allWinnersReachedTarget) {\n                        this.phase = EvolutionPhase.EvolutionDone\n                    } else {\n                        this.winners.forEach(winner => winner.runner.showFrozen())\n                        this.phase = this.challengers.length === 0 ? EvolutionPhase.ChallengersBorn : EvolutionPhase.ChallengersReborn\n                        this.currentCycle = 0\n                    }\n                }\n                break\n            case EvolutionPhase.ChallengersBorn:\n                const challengers: Runner[] = []\n                while (challengers.length < EVO_PARAMETERS.challengerPopulation) {\n                    const genome = fromGeneData(this.winners[challengers.length % this.winners.length].runner.state.genome.geneData)\n                    challengers.push(this.createAutoRunner(genome.withMutations([directionGene(this.ancestor.direction)], false)))\n                }\n                this.challengers = challengers.map((challenger, index) => {\n                    challenger.autopilot = true\n                    const name = `${letter(index + this.winners.length)}${letter(index % this.winners.length)}`\n                    return <IEvolver>{runner: challenger, name, proximityHistory: [], persisted: false}\n                })\n                this.phase = EvolutionPhase.ChallengersOvertake\n                break\n            case EvolutionPhase.ChallengersReborn:\n                let parentIndex = 0\n                this.challengers = this.challengers.map((challenger, index): IEvolver => {\n                    const survivorIndex = parentIndex++ % this.winners.length\n                    const parent = this.winners[survivorIndex]\n                    const instance = challenger.runner.adoptFabric(this.ancestor.state.instance.fabricClone)\n                    const runner = challenger.runner.recycled(instance, parent.runner.mutatedGeneData())\n                    const name = `${parent.name}${letter(index)}`\n                    runner.autopilot = true\n                    return {runner, name, proximityHistory: [], persisted: false}\n                })\n                this.phase = EvolutionPhase.ChallengersOvertake\n                break\n            case EvolutionPhase.ChallengersOvertake:\n                this.challengersVisible = true\n                let challengerMoved = false\n                let challengerMinCycles = 0\n                this.challengers.forEach(({runner, name}) => {\n                    const cycleCount = runner.getCycleCount(this.useTwitches)\n                    if (cycleCount > challengerMinCycles) {\n                        challengerMinCycles = cycleCount\n                    }\n                    if (cycleCount < this.currentMaxCycles) {\n                        runner.iterate()\n                        challengerMoved = true\n                    }\n                })\n                if (challengerMinCycles > this.currentCycle) {\n                    const evolvers = [...this.winners, ...this.challengers]\n                    rankEvolvers(evolvers, this.currentCycle)\n                    this.broadcastSnapshot(evolvers.map(evolver => rankedToSnapshot(evolver, this.currentCycle)))\n                    this.currentCycle = challengerMinCycles\n                }\n                if (!challengerMoved) {\n                    this.phase = EvolutionPhase.SurvivorsStored\n                }\n                break\n            case EvolutionPhase.SurvivorsStored:\n                const {winners, losers} = this.splitEvolvers(this.currentCycle)\n                this.ancestor.state.patch.storedGenes = winners.map(({runner}) => runner.state.genome.geneData)\n                winners.forEach(winner => winner.persisted = true)\n                losers.forEach(winner => winner.persisted = false)\n                this.broadcastSnapshot(winners.map(evolver => rankedToSnapshot(evolver, this.currentCycle)))\n                this.winners = winners\n                this.challengers = losers\n                this.challengersVisible = false\n                this.phase = EvolutionPhase.EvolutionAdvance\n                break\n            case EvolutionPhase.EvolutionAdvance:\n                if (this.cyclePatternIndex === this.cyclePattern.length - 1) {\n                    const allReachedTarget = !this.winners.find(({runner}) => !runner.reachedTarget)\n                    this.phase = allReachedTarget ? EvolutionPhase.EvolutionHarder : EvolutionPhase.EvolutionDone\n                } else {\n                    this.cyclePatternIndex++\n                    this.currentMaxCycles = this.cyclePattern[this.cyclePatternIndex]\n                    this.currentCycle = 0\n                    this.phase = EvolutionPhase.SurvivorsAdvance\n                    // todo: maybe they have all reached the target?\n                }\n                break\n            case EvolutionPhase.EvolutionDone:\n                break\n            case EvolutionPhase.EvolutionHarder:\n                break\n        }\n        this.midpoint.set(0, 0, 0)\n        this.winners.forEach(({runner}) => this.midpoint.add(runner.state.midpoint))\n        this.challengers.forEach(({runner}) => this.midpoint.add(runner.state.midpoint))\n        this.midpoint.multiplyScalar(1.0 / (this.winners.length + this.challengers.length))\n        return this.phase\n    }\n\n    public get target(): Vector3 {\n        return this.ancestor.target\n    }\n\n    // Privates =============================================================\n\n    private splitEvolvers(cycleCount: number): ISplit {\n        const winners: IEvolver[] = []\n        const losers: IEvolver[] = []\n        const evolvers = [...this.winners, ...this.challengers]\n        rankEvolvers(evolvers, cycleCount)\n        evolvers.forEach((rankedEvolver, index) => {\n            if (index < EVO_PARAMETERS.persistentPopulation) {\n                winners.push(rankedEvolver)\n            } else {\n                losers.push(rankedEvolver)\n            }\n        })\n        return {cycleCount, winners, losers}\n    }\n\n    private broadcastSnapshot(evolverSnapshots: IEvolverSnapshot[]): void {\n        const cycle = this.currentCycle\n        const cycleIndex = this.cyclePatternIndex\n        const cyclePattern = this.cyclePattern\n        const snapshot = <IEvolutionSnapshot>{cycle, cyclePattern, cycleIndex, evolverSnapshots}\n        const snapshots = this.snapshotsSubject.getValue()\n        const alreadyHere = snapshots.findIndex(s => snapshot.cycleIndex === s.cycleIndex)\n        if (alreadyHere < 0) {\n            this.snapshotsSubject.next([...snapshots, snapshot])\n        } else if (alreadyHere === snapshots.length - 1) {\n            const copy = [...snapshots]\n            copy[alreadyHere] = snapshot\n            this.snapshotsSubject.next(copy)\n        } else {\n            this.snapshotsSubject.next([snapshot])\n        }\n    }\n\n    private createAutoRunner(genome: Genome): Runner {\n        const instance = this.createInstance(RUNNER_CODE.featureValues, this.ancestor.state.instance.fabricClone)\n        const runner = this.ancestor.recycled(instance, genome.geneData)\n        runner.autopilot = true\n        return runner\n    }\n}\n\nfunction rankEvolvers(evolvers: IEvolver[], cycleCount: number): void {\n    evolvers.forEach(evolver => {\n        if (evolver.proximityHistory.length === cycleCount) {\n            const event = evolver.runner.distanceFromTarget\n            evolver.proximityHistory.push(event)\n        }\n    })\n    evolvers.sort((a, b) => a.proximityHistory[cycleCount] - b.proximityHistory[cycleCount])\n}\n\nfunction rankedToSnapshot({runner, proximityHistory, persisted, name}: IEvolver, cycleCount: number): IEvolverSnapshot {\n    const proximityForCycle = proximityHistory[cycleCount]\n    if (proximityForCycle === undefined) {\n        throw new Error(\"Cannot snapshot\")\n    }\n    const tosses = runner.state.genome.tosses\n    const reachedTarget = runner.reachedTarget\n    return {name, proximity: proximityForCycle, reachedTarget, tosses, persisted}\n}\n\nexport function letter(index: number): string {\n    return String.fromCharCode(65 + index)\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\n\nimport { Runner } from \"./runner\"\n\nexport function RunnerView({runner}: { runner: Runner }): JSX.Element {\n    const {topFaceLocation, target, state, showDirection} = runner\n    const floatView = state.instance.floatView\n    return (\n        <group>\n            <lineSegments geometry={floatView.lineGeometry} onUpdate={self => self.geometry.computeBoundingSphere()}>\n                <lineBasicMaterial attach=\"material\" vertexColors={true}/>\n            </lineSegments>\n            {!showDirection || !topFaceLocation ? undefined : (\n                <group>\n                    <lineSegments>\n                        <bufferGeometry attach=\"geometry\">\n                            <bufferAttribute\n                                attachObject={[\"attributes\", \"position\"]}\n                                array={new Float32Array([\n                                    topFaceLocation.x, topFaceLocation.y, topFaceLocation.z,\n                                    target.x, topFaceLocation.y, target.z,\n                                ])}\n                                count={2}\n                                itemSize={3}\n                                onUpdate={self => self.needsUpdate = true}\n                            />\n                        </bufferGeometry>\n                        <lineBasicMaterial attach=\"material\" color={\"#FFFFFF\"}/>\n                    </lineSegments>\n                    <lineSegments\n                        quaternion={runner.directionQuaternion}\n                        position={topFaceLocation}\n                    >\n                        <bufferGeometry attach=\"geometry\">\n                            <bufferAttribute\n                                attachObject={[\"attributes\", \"position\"]}\n                                array={new Float32Array([\n                                    0,0,0,\n                                    0,0,5,\n                                ])}\n                                count={2}\n                                itemSize={3}\n                                onUpdate={self => self.needsUpdate = true}\n                            />\n                        </bufferGeometry>\n                        <lineBasicMaterial attach=\"material\" color={\"#f80303\"}/>\n                    </lineSegments>\n                </group>\n            )}\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\n\nimport { Population } from \"./population\"\nimport { RunnerView } from \"./runner-view\"\n\nexport function PopulationView({population}: { population: Population }): JSX.Element {\n    const height = 6\n    const {midpoint, target} = population\n    return (\n        <group>\n            {population.winners.map(({runner}, index) => (\n                <RunnerView key={`evolving-${index}`} runner={runner}/>\n            ))}\n            {!population.challengersVisible ? undefined : population.challengers.map(({runner}, index) => (\n                <RunnerView key={`evolving-${index + population.winners.length}`} runner={runner}/>\n            ))}\n            <lineSegments>\n                <bufferGeometry attach=\"geometry\">\n                    <bufferAttribute\n                        attachObject={[\"attributes\", \"position\"]}\n                        array={new Float32Array([\n                            midpoint.x, 0, midpoint.z,\n                            midpoint.x, height, midpoint.z,\n                            midpoint.x, height, midpoint.z,\n                            target.x, height, target.z,\n                            target.x, height, target.z,\n                            target.x, 0, target.z,\n                        ])}\n                        count={6}\n                        itemSize={3}\n                        onUpdate={self => self.needsUpdate = true}\n                    />\n                </bufferGeometry>\n                <lineBasicMaterial attach=\"material\" color={\"#ffffff\"}/>\n            </lineSegments>\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { OrbitControls, Sky } from \"@react-three/drei\"\nimport { useFrame } from \"@react-three/fiber\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { useRecoilState } from \"recoil\"\nimport { DoubleSide, Vector3 } from \"three\"\n\nimport { destinationAtom } from \"./evo-state\"\nimport { Happening } from \"./evo-view\"\nimport { Island, PatchCharacter } from \"./island\"\nimport { FAUNA_PATCH_COLOR, FLORA_PATCH_COLOR, SIX, SUN_POSITION } from \"./island-geometry\"\nimport { Patch } from \"./patch\"\nimport { EvolutionPhase, Population } from \"./population\"\nimport { PopulationView } from \"./population-view\"\nimport { Runner } from \"./runner\"\nimport { Direction } from \"./runner-logic\"\nimport { RunnerView } from \"./runner-view\"\n\nconst TOWARDS_POSITION = 0.003\nconst TOWARDS_TARGET = 0.05\nconst TARGET_HEIGHT = 3\nconst TOWARDS_HEIGHT = 0.01\nconst SECONDS_UNTIL_EVOLUTION = 5\n\nexport function IslandView({island, happening, runner, population, evolutionPhase, countdownToEvo, stopEvo}: {\n    island: Island,\n    happening: Happening,\n    runner?: Runner,\n    population?: Population,\n    evolutionPhase: (phase: EvolutionPhase) => void,\n    countdownToEvo: (countdown: number) => void,\n    stopEvo: (nextEvolution?: Population) => void,\n}): JSX.Element {\n    const [rotating, setRotating] = useState(false)\n    const [destination, setDestination] = useRecoilState(destinationAtom)\n    const [happeningChanged, updateHappeningChanged] = useState(Date.now())\n    const [now, updateNow] = useState(Date.now())\n    const [target, updateTarget] = useState(new Vector3(0, 1, 0))\n\n    function adjustTarget(midpoint: Vector3): void {\n        updateTarget(new Vector3().subVectors(midpoint, target).multiplyScalar(TOWARDS_TARGET).add(target))\n    }\n\n    useFrame((state) => {\n        const {camera, clock} = state\n        if (clock.elapsedTime === 0) {\n            camera.position.set(30, 30, 10)\n        }\n        const approachDistance = (distance: number) => {\n            const positionToTarget = new Vector3().subVectors(camera.position, target)\n            const deltaDistance = distance - positionToTarget.length()\n            positionToTarget.normalize()\n            camera.position.y += (TARGET_HEIGHT - camera.position.y) * TOWARDS_HEIGHT\n            camera.position.add(positionToTarget.multiplyScalar(deltaDistance * TOWARDS_POSITION))\n        }\n        switch (happening) {\n            case Happening.Developing:\n                if (runner) {\n                    runner.iterate()\n                    adjustTarget(runner.state.midpoint)\n                    approachDistance(9)\n                }\n                break\n            case Happening.Resting:\n                if (runner) {\n                    runner.iterate()\n                    adjustTarget(runner.state.midpoint)\n                    approachDistance(12)\n                }\n                break\n            case Happening.Running:\n                if (runner) {\n                    runner.iterate()\n                    adjustTarget(runner.state.midpoint)\n                    approachDistance(9)\n                }\n                break\n            case Happening.Evolving:\n                if (population) {\n                    switch (population.iterate()) {\n                        case EvolutionPhase.EvolutionDone:\n                            console.log(\"Evolution DONE\")\n                            stopEvo()\n                            break\n                        case EvolutionPhase.EvolutionHarder:\n                            console.log(\"Evolution advance...\")\n                            stopEvo(population.withReducedCyclePattern)\n                            break\n                    }\n                    adjustTarget(population.midpoint)\n                    approachDistance(25)\n                    evolutionPhase(population.phase)\n                }\n                break\n        }\n        const wasSeconds = Math.floor((now - happeningChanged) / 1000)\n        const time = Date.now()\n        updateNow(time)\n        const isSeconds = Math.floor((time - happeningChanged) / 1000)\n        if (happening === Happening.Resting && wasSeconds < isSeconds) {\n            countdownToEvo(SECONDS_UNTIL_EVOLUTION - isSeconds)\n        }\n    })\n\n    useEffect(() => {\n        updateHappeningChanged(Date.now())\n        updateNow(Date.now())\n        setRotating(happening === Happening.Evolving)\n    }, [happening])\n\n    function clickPatch(patch: Patch): void {\n        if (patch.flora) {\n            patch.flora.removeRandomInterval()\n            console.log(\"remove\", patch.name)\n        } else if (runner && runner.direction === Direction.Rest) {\n            setDestination((destination + 1) % SIX)\n        }\n    }\n\n    return (\n        <group>\n            <OrbitControls target={target} maxDistance={250} minDistance={1}\n                           enablePan={false} autoRotateSpeed={0.6} autoRotate={rotating}\n                           enableDamping={false} minPolarAngle={Math.PI * 0.1} maxPolarAngle={Math.PI * 0.5}\n            />\n            <scene>\n                {(population && happening === Happening.Evolving) ? (\n                    <PopulationView population={population}/>\n                ) : (runner ? (\n                    <RunnerView runner={runner}/>\n                ) : undefined)}\n                {island.patches.map(patch => {\n                    const array = patch.positionArray\n                    const normal = patch.normalArray\n                    return (\n                        <mesh key={`patch-${patch.name}`} onClick={() => clickPatch(patch)}>\n                            <meshPhongMaterial\n                                attach=\"material\"\n                                side={DoubleSide}\n                                color={patch.patchCharacter === PatchCharacter.FaunaPatch ? FAUNA_PATCH_COLOR : FLORA_PATCH_COLOR}/>\n                            <bufferGeometry attach=\"geometry\">\n                                <bufferAttribute\n                                    attachObject={[\"attributes\", \"position\"]}\n                                    array={array}\n                                    count={array.length / 3}\n                                    itemSize={3}\n                                />\n                                <bufferAttribute\n                                    attachObject={[\"attributes\", \"normal\"]}\n                                    array={normal}\n                                    count={normal.length / 3}\n                                    itemSize={3}\n                                />\n                            </bufferGeometry>\n                        </mesh>\n                    )\n                })}\n                <Sky\n                    distance={1000000}\n                    rayleigh={3}\n                    inclination={0.505}\n                    mieCoefficient={0.001}\n                    mieDirectionalG={0.93}\n                    turbidity={7.5}\n                />\n                <pointLight distance={1000} decay={0.1} position={SUN_POSITION}/>\n                <hemisphereLight name=\"Hemi\"/>\n            </scene>\n        </group>\n    )\n}\n\n\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { GeneName, GeneReader, ITwitch } from \"./genome\"\nimport { Direction, directionGene, DIRECTIONS, IMuscle, IRunnerState } from \"./runner-logic\"\n\nexport type TwitchFunction = (muscle: IMuscle, attack: number, decay: number, twitchNuance: number) => void\n\nexport interface ITwitchConfig {\n    twitchNuance: number\n    musclePeriod: number\n    attackPeriod: number\n    decayPeriod: number\n}\n\nexport class Twitcher {\n    public cycleCount = 0\n    public twitchCount = 0\n    private config: ITwitchConfig\n    private twitchCycles: Record<string, TwitchCycle> = {}\n\n    constructor(private state: IRunnerState) {\n        const genome = this.state.genome\n        const readTwitchConfig = (): ITwitchConfig => {\n            const reader = genome.createReader(GeneName.TwitchConfig)\n            const musclePeriod = reader.readFeatureValue(800, 1200)\n            return <ITwitchConfig>{\n                twitchNuance: reader.readFeatureValue(0.1, 0.3),\n                musclePeriod,\n                attackPeriod: reader.readFeatureValue(0.5, 1) * musclePeriod,\n                decayPeriod: reader.readFeatureValue(0.5, 1) * musclePeriod,\n            }\n        }\n        this.config = readTwitchConfig()\n        const totalTwitches = genome.totalTwitches\n        DIRECTIONS.filter(d => d !== Direction.Rest).forEach(direction => {\n            const geneName = directionGene(direction)\n            const reader = genome.createReader(geneName)\n            this.twitchCycles[direction] = new TwitchCycle(reader, this.config, this.state.loopMuscles, totalTwitches)\n        })\n    }\n\n    public toString(): string {\n        const cycles = Object.keys(this.twitchCycles)\n            .map(k => this.twitchCycles[k]).map(c => c.toString()).join(\"\\n\")\n        return `Twitcher(${cycles})`\n    }\n\n    public tick(twitch: TwitchFunction): boolean {\n        const state = this.state\n        state.timeSlice++\n        if (state.timeSlice >= 36) {\n            state.timeSlice = 0\n            this.cycleCount++\n            return true\n        }\n        const twitchCycle = this.twitchCycles[state.direction]\n        if (twitchCycle) {\n            this.twitchCount += twitchCycle.activate(state.timeSlice, twitch)\n        }\n        return false\n    }\n}\n\nclass TwitchCycle {\n    private slices: Record<number, ITwitch[]> = {}\n\n    constructor(reader: GeneReader, config: ITwitchConfig, loopMuscles: IMuscle[][], totalTwitches: number) {\n        const loops = [...loopMuscles]\n        while (totalTwitches-- > 0) {\n            const chosen = reader.chooseFrom(loops.length)\n            const twitch = reader.readMuscleTwitch(loops[chosen], config)\n            loops.splice(chosen, 1)\n            this.addTwitch(twitch.when, twitch)\n        }\n    }\n\n    public toString(): string {\n        const twitches = Object.keys(this.slices)\n            .map(k => this.slices[k])\n            .map((twitchArray: ITwitch[]) => twitchArray\n                .map(twitch => `${twitch.when}:${twitch.muscle.interval.index}`)\n                .join(\";\"))\n            .join(\",\")\n        return `Cycle(${twitches})`\n    }\n\n    public activate(timeSlice: number, twitch: TwitchFunction): number {\n        const slice = this.slices[timeSlice]\n        if (!slice) {\n            return 0\n        }\n        slice.forEach(({muscle, attack, decay, twitchNuance}) => twitch(muscle, attack, decay, twitchNuance))\n        return slice.length\n    }\n\n    private addTwitch(index: number, twitch: ITwitch): void {\n        const slice = this.slices[index]\n        if (slice) {\n            slice.push(twitch)\n        } else {\n            this.slices[index] = [twitch]\n        }\n    }\n}\n\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Fabric, Stage } from \"eig\"\nimport { Quaternion, Vector3 } from \"three\"\n\nimport { FORWARD } from \"../fabric/eig-util\"\nimport { FabricInstance } from \"../fabric/fabric-instance\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IInterval, ITwistFace } from \"../fabric/tensegrity-types\"\n\nimport { fromGeneData, IGeneData } from \"./genome\"\nimport {\n    calculateDirections,\n    Direction,\n    directionGene,\n    DIRECTIONS,\n    extractLoopMuscles,\n    findTopFace,\n    IMuscle,\n    IRunnerState,\n} from \"./runner-logic\"\nimport { Twitcher, TwitchFunction } from \"./twitcher\"\n\nconst CLOSE_ENOUGH_TO_TARGET = 4\nconst MAX_HISTORY_LENGTH = 20\n\nexport class Runner {\n\n    public toA = new Vector3(1, 0, 0)\n    public toB = new Vector3(0, 0, 1)\n    public toC = new Vector3(0, 0, -1)\n\n    private shapingTime = 150\n    private twitcher?: Twitcher\n    private topFace?: ITwistFace\n    private currentTwitchAge = 0\n\n    constructor(public readonly state: IRunnerState, public embryo?: Tensegrity) {\n        if (!embryo) {\n            this.twitcher = new Twitcher(this.state)\n        }\n        this.currentTwitchAge = this.twitchAge\n    }\n\n    public get growing(): boolean {\n        return !!this.embryo\n    }\n\n    public recycled(instance: FabricInstance, geneData?: IGeneData[]): Runner {\n        const genome = fromGeneData(geneData ? geneData : this.state.patch.storedGenes[0])\n        const midpoint = new Vector3().copy(this.state.midpoint)\n        const state: IRunnerState = {...this.state, instance, midpoint, genome, directionHistory: []}\n        const runner = new Runner(state)\n        runner.topFace = this.topFace\n        calculateDirections(runner.state.instance, runner.toA, runner.toB, runner.toC, this.topFace)\n        return runner\n    }\n\n    public getCycleCount(useTwitches: boolean): number {\n        return !this.twitcher ? 0 : useTwitches ? Math.floor(this.twitcher.twitchCount / this.state.twitchesPerCycle) : this.twitcher.cycleCount\n    }\n\n    public get autopilot(): boolean {\n        return this.state.autopilot\n    }\n\n    public set autopilot(auto: boolean) {\n        this.state.autopilot = auto\n    }\n\n    public get direction(): Direction {\n        return this.state.direction\n    }\n\n    public set direction(direction: Direction) {\n        this.state.direction = direction\n        this.autopilot = false\n    }\n\n    public adoptFabric(fabric: Fabric): FabricInstance {\n        return this.state.instance.adoptFabric(fabric)\n    }\n\n    public mutatedGeneData(): IGeneData[] {\n        const counts = DIRECTIONS.map(dir => {\n            const count = this.state.directionHistory.filter(d => d === dir).length\n            return ({dir, count})\n        })\n        const nonzero = counts.filter(count => count.count > 0)\n        const geneNames = nonzero.map(d => d.dir).map(directionGene)\n        return this.state.genome.withMutations(geneNames, Math.random() > 0.9).geneData\n    }\n\n    public get age(): number {\n        return this.state.instance.fabric.age\n    }\n\n    public get distanceFromTarget(): number {\n        return this.state.midpoint.distanceTo(this.target)\n    }\n\n    public iterate(): boolean {\n        const instance = this.state.instance\n        const view = instance.view\n        this.state.midpoint.set(view.midpoint_x(), view.midpoint_y(), view.midpoint_z())\n        const embryo = this.embryo\n        if (embryo) {\n            const busy = embryo.iterate()\n            if (busy) {\n                return true\n            }\n            const stage = embryo.stage$.getValue()\n            switch (stage) {\n                case Stage.Shaping:\n                    if (this.shapingTime <= 0) {\n                        embryo.stage = Stage.Slack\n                    } else {\n                        this.shapingTime--\n                    }\n                    return false\n                case Stage.Slack:\n                    this.topFace = findTopFace(embryo)\n                    embryo.stage = Stage.Pretensing\n                    return false\n                case Stage.Pretensing:\n                    return false\n                case Stage.Pretenst:\n                    this.state.loopMuscles = extractLoopMuscles(embryo)\n                    this.state.instance.refreshFloatView()\n                    calculateDirections(this.state.instance, this.toA, this.toB, this.toC, this.topFace)\n                    this.checkDirection()\n                    this.twitcher = new Twitcher(this.state)\n                    this.embryo = undefined\n                    return true\n                default:\n                    return false\n            }\n        } else {\n            this.state.instance.iterate()\n            if (this.twitcher) {\n                const newTwitchAge = this.twitchAge\n                if (newTwitchAge <= this.currentTwitchAge) {\n                    return true\n                }\n                this.currentTwitchAge = newTwitchAge\n                const twitch: TwitchFunction = (muscle: IMuscle, attack: number, decay: number, twitchNuance: number) => {\n                    const twitchInterval = (interval?: IInterval) => {\n                        if (interval) {\n                            this.state.instance.fabric.twitch_interval(interval.index, attack, decay, twitchNuance)\n                            // console.log(`twitch ${interval.index}: ${attack}, ${decay}, ${twitchNuance}`)\n                        }\n                    }\n                    twitchInterval(muscle.alphaInterval)\n                    twitchInterval(muscle.omegaInterval)\n                }\n                if (this.state.autopilot && this.twitcher.tick(twitch)) {\n                    if (this.reachedTarget) {\n                        this.direction = Direction.Rest\n                    } else {\n                        this.checkDirection()\n                    }\n                }\n            }\n            return true\n        }\n    }\n\n    public showFrozen(): void {\n        this.state.instance.showFrozen(this.reachedTarget)\n    }\n\n    public get topFaceLocation(): Vector3 | undefined {\n        const face = this.topFace\n        if (!face) {\n            return undefined\n        }\n        const joint = face.joint\n        if (!joint) {\n            return undefined\n        }\n        return this.state.instance.jointLocation(joint)\n    }\n\n    public get target(): Vector3 {\n        return this.state.targetPatch.center\n    }\n\n    public get showDirection(): boolean {\n        return this.state.direction !== Direction.Rest\n    }\n\n    public get directionQuaternion(): Quaternion {\n        return this.quaternionForDirection(this.state.direction)\n    }\n\n    public get reachedTarget(): boolean {\n        return this.distanceFromTarget < CLOSE_ENOUGH_TO_TARGET\n    }\n\n    public checkDirection(): void {\n        const state = this.state\n        if (this.reachedTarget) {\n            this.direction = Direction.Rest\n        } else {\n            state.direction = this.directionToTarget\n            if (state.direction === Direction.Rest) {\n                console.error(\"direction is REST??\")\n                return\n            }\n            state.directionHistory.push(state.direction)\n            if (state.directionHistory.length > MAX_HISTORY_LENGTH) {\n                state.directionHistory.shift()\n            }\n        }\n    }\n\n    private get twitchAge(): number {\n        return this.state.instance.fabric.age / 600\n    }\n\n    private quaternionForDirection(direction: Direction): Quaternion {\n        const towards = () => {\n            switch (direction) {\n                case Direction.Rest:\n                case Direction.ToA:\n                    return this.toA\n                case Direction.ToB:\n                    return this.toB\n                case Direction.ToC:\n                    return this.toC\n            }\n        }\n        return new Quaternion().setFromUnitVectors(FORWARD, towards())\n    }\n\n    private get directionToTarget(): Direction {\n        const toTarget = this.toTarget\n        calculateDirections(this.state.instance, this.toA, this.toB, this.toC, this.topFace)\n        const matchA = toTarget.dot(this.toA)\n        const matchB = toTarget.dot(this.toB)\n        const matchC = toTarget.dot(this.toC)\n        if (matchA > matchB && matchA > matchC) {\n            return Direction.ToA\n        }\n        if (matchB > matchA && matchB > matchC) {\n            return Direction.ToB\n        }\n        if (matchC > matchA && matchC > matchB) {\n            return Direction.ToC\n        }\n        return Direction.Rest\n    }\n\n    private get toTarget(): Vector3 {\n        const toTarget = new Vector3()\n        toTarget.subVectors(this.target, this.state.midpoint)\n        toTarget.y = 0\n        toTarget.normalize()\n        return toTarget\n    }\n}\n\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { FaDna, FaYinYang } from \"react-icons/all\"\nimport { useSetRecoilState } from \"recoil\"\n\nimport { showDetailsAtom } from \"./evo-state\"\nimport { IEvolutionSnapshot, letter } from \"./population\"\n\nexport function StatsView({snapshots}: {\n    snapshots: IEvolutionSnapshot[],\n}): JSX.Element {\n    const setShowStats = useSetRecoilState(showDetailsAtom)\n    return (\n        <div className=\"text-monospace d-inline-flex\" onClick={() => setShowStats(false)}>\n            {snapshots.map(snapshot => (\n                <div key={snapshot.cycleIndex} className=\"float-left p-1 m-1\" style={{\n                    borderStyle: \"solid\",\n                    borderWidth: \"2px\",\n                }}>\n                    <EvolutionInfo snapshot={snapshot}/>\n                    <div className=\"m-2\">\n                        {snapshot.evolverSnapshots.map((evolverSnapshot, index) => {\n                            const {name, reachedTarget, persisted, proximity, tosses} = evolverSnapshot\n                            const mutationSymbols = []\n                            let nameLength = name.length - 1\n                            while (nameLength > 0) {\n                                mutationSymbols.push(<FaDna key={`${name}-${nameLength}`}/>)\n                                nameLength--\n                            }\n                            const reachedSymbol = reachedTarget ? <FaYinYang/> : undefined\n                            return (\n                                <div key={`competitor-${index}`} style={{\n                                    color: persisted ? reachedTarget ? \"#ffffff\" : \"#2cd710\" : \"#c2c2c2\",\n                                    backgroundColor: persisted ? reachedTarget ? \"#b1b1b1\" : \"#848383\" : \"#555454\",\n                                    borderRadius: \"0.2em\",\n                                    marginBottom: \"1px\",\n                                    padding: \"2px\",\n                                    display: \"block\",\n                                    whiteSpace: \"nowrap\",\n                                }}>\n                                    {`${letter(index)} ${proximity.toFixed(3)} ${name}${tosses}`}\n                                    &nbsp;\n                                    {mutationSymbols}{reachedSymbol}\n                                </div>\n                            )\n                        })}\n                    </div>\n                </div>\n            ))}\n        </div>\n    )\n}\n\nexport function EvolutionInfo({snapshot}: { snapshot: IEvolutionSnapshot }): JSX.Element {\n    const {cyclePattern, cycleIndex, cycle} = snapshot\n    const setShowStats = useSetRecoilState(showDetailsAtom)\n    return (\n        <div className=\"p-1 my-2 w-100 text-center\" onClick={() => setShowStats(false)}>\n            {cyclePattern.map((cycles, index) => (\n                <span\n                    key={`cycle-${index}`}\n                    style={{\n                        color: \"black\",\n                        backgroundColor: index === cycleIndex ? \"#24f00f\" : \"#cbc7c7\",\n                        margin: \"0.1em\",\n                        padding: \"0.2em\",\n                        borderRadius: \"0.3em\",\n                        borderStyle: \"solid\",\n                        borderWidth: \"1px\",\n                    }}\n                >{index === cycleIndex && cycle < cyclePattern[cycleIndex] ? `${cycle + 1}/${cycles}` : cycles}</span>\n            ))}\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Canvas } from \"@react-three/fiber\"\nimport { Stage, SurfaceCharacter } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { FaBaby, FaDna, FaRunning, FaSignOutAlt, FaYinYang } from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { useRecoilBridgeAcrossReactRoots_UNSTABLE, useRecoilState, useRecoilValue } from \"recoil\"\nimport { Vector3 } from \"three\"\n\nimport { GlobalMode, reloadGlobalMode, stageName } from \"../fabric/eig-util\"\nimport { CreateInstance } from \"../fabric/fabric-instance\"\nimport { compileTenscript, TenscriptBuilder } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\n\nimport { destinationAtom, homePatchSelector, islandAtom, RUNNER_CODE, showDetailsAtom } from \"./evo-state\"\nimport { emptyGenome, fromGeneData } from \"./genome\"\nimport { IslandView } from \"./island-view\"\nimport { Patch } from \"./patch\"\nimport { EvolutionPhase, EVO_PARAMETERS, IEvolutionSnapshot, Population } from \"./population\"\nimport { Runner } from \"./runner\"\nimport { Direction, IRunnerState } from \"./runner-logic\"\nimport { EvolutionInfo, StatsView } from \"./stats-view\"\n\nexport enum Happening {\n    Developing,\n    Resting,\n    Running,\n    Evolving,\n}\n\nexport function EvoView({createBodyInstance}: { createBodyInstance: CreateInstance }): JSX.Element {\n    const [island] = useRecoilState(islandAtom)\n    const homePatch = useRecoilValue(homePatchSelector)\n    const destination = useRecoilValue(destinationAtom)\n    const [showStats, setShowStats] = useRecoilState(showDetailsAtom)\n    // const [cyclePattern, setCyclePattern] = useState<number[]>(EVO_PARAMETERS.cycle)\n    const [runner, setRunner] = useState(() => newRunner(homePatch))\n    const [happening, setHappening] = useState(Happening.Developing)\n    const [snapshots, setSnapshots] = useState<IEvolutionSnapshot[]>([])\n    const [evolutionCountdown, setEvolutionCountdown] = useState(-1)\n    const [population, setPopulation] = useState<Population | undefined>(undefined)\n    const [phase, setPhase] = useState(EvolutionPhase.SurvivorsAdvance)\n    const [stage, updateStage] = useState<Stage | undefined>(undefined)\n\n    function newRunner(patch: Patch): Runner {\n        const targetPatch = patch.adjacent[0]\n        if (!targetPatch) {\n            throw new Error(\"No adjacent\")\n        }\n        const storedGenome = patch.storedGenes[0]\n        const genome = storedGenome ? fromGeneData(storedGenome) : emptyGenome()\n        const instance = createBodyInstance(RUNNER_CODE.featureValues)\n        instance.world.set_surface_character(SurfaceCharacter.Sticky)\n        const state: IRunnerState = {\n            patch,\n            targetPatch,\n            instance,\n            midpoint: new Vector3().copy(patch.center),\n            genome,\n            loopMuscles: [],\n            direction: Direction.ToA,\n            directionHistory: [],\n            autopilot: false,\n            timeSlice: 10,\n            twitchesPerCycle: 10,\n        }\n        const tree = compileTenscript(RUNNER_CODE, (err) => {\n            throw new Error(\"unable to compile runner: \" + err)\n        })\n        if (!tree) {\n            throw new Error(\"no tree\")\n        }\n        const builder = new TenscriptBuilder(patch.center, RUNNER_CODE, tree)\n        const embryo = new Tensegrity(instance, 1000, builder)\n        return new Runner(state, embryo)\n    }\n\n    // function newFlora(patch: Patch, instance: FabricInstance): Flora {\n    //     const tree = compileTenscript(FLORA_CODE, (err) => {\n    //         throw new Error(\"unable to compile sat tree: \" + err)\n    //     })\n    //     if (!tree) {\n    //         throw new Error(\"no tree\")\n    //     }\n    //     const tensegrity = new Tensegrity(patch.center, percentOrHundred(), instance, 1000, FLORA_CODE, tree)\n    //     return new Flora(patch.name, tensegrity)\n    // }\n\n    useEffect(() => {\n        if (runner) {\n            const adjacent = runner.state.patch.adjacent[destination]\n            if (adjacent) {\n                runner.state.targetPatch = adjacent\n            }\n        }\n    }, [destination])\n\n    useEffect(() => {\n        if (!runner || !runner.embryo) {\n            updateStage(undefined)\n            return\n        }\n        const sub = runner.embryo.stage$.subscribe((newStage: Stage) => {\n            if (newStage === Stage.Pretenst) {\n                setHappening(Happening.Resting)\n            }\n            updateStage(newStage)\n        })\n        return () => sub.unsubscribe()\n    }, [runner])\n\n    useEffect(() => {\n        if (!population) {\n            return\n        }\n        const sub = population.snapshotsSubject.subscribe(setSnapshots)\n        return () => sub.unsubscribe()\n    }, [population])\n\n    const evolveWithPattern = (toEvolve: Runner, pattern: number[]) => {\n        if (population) {\n            setPopulation(population.withReducedCyclePattern)\n            // todo: free up current evolution?\n        } else {\n            setPopulation(new Population(toEvolve, createBodyInstance, false, pattern))\n        }\n        setHappening(Happening.Evolving)\n    }\n\n    const countdownToEvolution = (countdown: number) => {\n        setEvolutionCountdown(countdown)\n        if (runner && countdown === 0) {\n            evolveWithPattern(runner, EVO_PARAMETERS.cyclePattern)\n        }\n    }\n\n    const stopEvolution = (nextEvolution: Population) => {\n        // todo: free up current evolution?\n        setPopulation(nextEvolution)\n        if (!nextEvolution) {\n            setRunner(newRunner(homePatch))\n            setHappening(Happening.Developing)\n        }\n    }\n\n    const RecoilBridge = useRecoilBridgeAcrossReactRoots_UNSTABLE()\n    return (\n        <div style={{\n            position: \"absolute\",\n            left: 0,\n            right: 0,\n            height: \"100%\",\n        }}>\n            <Canvas key={island.name} style={{backgroundColor: \"black\"}}>\n                <RecoilBridge>\n                    <IslandView\n                        island={island}\n                        happening={happening}\n                        runner={runner}\n                        population={population}\n                        evolutionPhase={evolutionPhase => {\n                            if (evolutionPhase !== phase) {\n                                setPhase(evolutionPhase)\n                            }\n                        }}\n                        countdownToEvo={countdownToEvolution}\n                        stopEvo={stopEvolution}\n                    />\n                </RecoilBridge>\n            </Canvas>\n            {!runner ? <h1>no runner</h1> : (happening === Happening.Developing) ? (\n                !stage ? <h1>nothing</h1> : (\n                    <div id=\"bottom-middle\">\n                        <div className=\"py-2 px-3 text-center\">\n                            <FaBaby/> {stageName(stage)}\n                        </div>\n                    </div>\n                )\n            ) : (\n                <ControlButtons\n                    runner={runner}\n                    happening={happening}\n                    evoCountdown={evolutionCountdown}\n                    toRunning={() => {\n                        setHappening(Happening.Running)\n                        runner.autopilot = true\n                    }}\n                    toEvolving={() => {\n                        setHappening(Happening.Evolving)\n                        setEvolutionCountdown(-1)\n                        evolveWithPattern(runner, EVO_PARAMETERS.cyclePattern)\n                    }}\n                    toRebirth={() => {\n                        setRunner(newRunner(homePatch))\n                        setHappening(Happening.Developing)\n                    }}\n                    toRest={() => {\n                        setHappening(Happening.Resting)\n                        runner.direction = Direction.Rest\n                    }}\n                />\n            )}\n            {!population ? undefined : (\n                <>\n                    <div id=\"top-middle\">\n                        {showStats ? undefined : (\n                            <Button color=\"info\" onClick={() => setShowStats(true)}>\n                                Phase: {phase}<br/>\n                                {snapshots.length === 0 ? undefined :\n                                    <EvolutionInfo snapshot={snapshots[snapshots.length - 1]}/>\n                                }\n                            </Button>\n                        )}\n                    </div>\n                    {!showStats ? undefined : (\n                        <EvolutionStatsView happening={happening} snapshots={snapshots}/>\n                    )}\n                </>\n            )}\n            <div id=\"bottom-right\">\n                <ButtonGroup vertical={false} className=\"w-100\">\n                    <Button color=\"warning\" onClick={() => reloadGlobalMode(GlobalMode.Choice)}><FaSignOutAlt/></Button>\n                </ButtonGroup>\n            </div>\n        </div>\n    )\n}\n\nfunction ControlButtons({\n                            runner,\n                            happening,\n                            evoCountdown,\n                            toRunning,\n                            toRest,\n                            toEvolving,\n                            toRebirth,\n                        }: {\n    runner?: Runner,\n    happening: Happening,\n    evoCountdown: number,\n    toRunning: () => void,\n    toEvolving: () => void,\n    toRebirth: () => void,\n    toRest: () => void,\n}): JSX.Element {\n    const createContent = () => {\n        switch (happening) {\n            case Happening.Developing:\n                return <h1>developing</h1>\n            case Happening.Resting:\n                return !runner ? undefined : (\n                    <ButtonGroup className=\"w-100\">\n                        <Button color=\"success\" onClick={toRunning}>\n                            <FaRunning/>\n                        </Button>\n                        <Button color=\"success\" onClick={toEvolving}>\n                            <FaDna/> {evoCountdown >= 0 ? evoCountdown : \"\"}\n                        </Button>\n                        <Button color=\"success\" onClick={toRebirth}>\n                            <FaBaby/>\n                        </Button>\n                    </ButtonGroup>\n                )\n            case Happening.Running:\n                return !runner ? undefined : (\n                    <ButtonGroup className=\"w-100\">\n                        <Button color=\"success\" onClick={toRest}>\n                            <FaYinYang/> Rest\n                        </Button>\n                    </ButtonGroup>\n                )\n            case Happening.Evolving:\n                return !runner ? undefined : (\n                    <ButtonGroup className=\"w-100\">\n                        <Button color=\"success\" onClick={toRebirth}>\n                            <FaBaby/>\n                        </Button>\n                    </ButtonGroup>\n                )\n        }\n    }\n    const content = createContent()\n    if (!content) {\n        return <h1>{happening}</h1>\n    }\n    return (\n        <div id=\"bottom-middle\">{content}</div>\n    )\n}\n\nfunction EvolutionStatsView({happening, snapshots}: {\n    happening: Happening,\n    snapshots: IEvolutionSnapshot[],\n}): JSX.Element {\n    switch (happening) {\n        case Happening.Developing:\n        case Happening.Running:\n        case Happening.Resting:\n            return <div/>\n        case Happening.Evolving:\n            return (\n                <div id=\"evolution-stats\">\n                    {snapshots.length > 0 ? (\n                        <StatsView snapshots={snapshots}/>\n                    ) : (\n                        <h2 className=\"p-2\">First round, please wait</h2>\n                    )}\n                </div>\n            )\n    }\n}\n","import { SurfaceCharacter, WorldFeature } from \"eig\"\n\nimport { compileTenscript, ITenscript } from \"./tenscript\"\nimport { PostGrowthOp } from \"./tensegrity\"\nimport { Spin } from \"./tensegrity-types\"\n\nconst BOOTSTRAP_TENSCRIPTS: ITenscript[] = [\n    {\n        name: \"Phi\",\n        spin: Spin.LeftRight,\n        postGrowthOp: PostGrowthOp.NoOp,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"()\"],\n    },\n    {\n        name: \"One\",\n        spin: Spin.Left,\n        postGrowthOp: PostGrowthOp.NoOp,\n        surfaceCharacter: SurfaceCharacter.Bouncy,\n        code: [\"(1)\"],\n        jobs: [\n            {\n                age: 30000,\n                todo: \"pretensing\",\n            },\n        ],\n        featureValues: {\n            [WorldFeature.IterationsPerFrame]: 300,\n        },\n    },\n    {\n        name: \"Axoneme\",\n        spin: Spin.Left,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        code: [\"(30,S95)\"],\n    },\n    {\n        name: \"Knee\",\n        spin: Spin.Left,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(3,b3)\"],\n    },\n    {\n        name: \"Jack\",\n        spin: Spin.LeftRight,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(a2,b2,c2,d2)\"],\n    },\n    {\n        name: \"Star\",\n        spin: Spin.LeftRight,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(a(15,S90),b(15,S90),c(15,S90),d(15,S90))\"],\n    },\n    {\n        name: \"Tripod with Knees\",\n        spin: Spin.RightLeft,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(A5,B(7,c(5,S90),S90),C(7,c(5,S90),S90),D(7,c(5,S90),S90))\"],\n    },\n    {\n        name: \"Zigzag\",\n        spin: Spin.LeftRight,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(c(3,MA1),d(7,b(7,c(7,d(7,c(7,d(3,MA1)))))))\"],\n        markDefStrings: {\n            1: \"join\",\n        },\n    },\n    {\n        name: \"Diamond\",\n        spin: Spin.RightLeft,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\n            \"(\",\n            \"   a(5,\",\n            \"      b(5,b(5,b(2,MA3)),c(5,c(2,MA4))),\",\n            \"      c(5,b(5,b(2,MA1)),c(5,c(2,MA5))),\",\n            \"      d(5,b(5,b(2,MA6)),c(5,c(2,MA2)))\",\n            \"   )\",\n            \"   b(5,b(5,b(2,MA5)),c(5,c(2,MA3))),\",\n            \"   c(5,b(5,b(2,MA2)),c(5,c(2,MA1))),\",\n            \"   d(5,b(5,b(2,MA4)),c(5,c(2,MA6)))\",\n            \")\",\n        ],\n        markDefStrings: {\n            1: \"join\",\n            2: \"join\",\n            3: \"join\",\n            4: \"join\",\n            5: \"join\",\n            6: \"join\",\n        },\n    },\n    {\n        name: \"Composed Tree\",\n        spin: Spin.Left,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(6,b(4,MA1),c(4,MA1),d(4,MA1))\"],\n        markDefStrings: {\n            1: \"subtree(b5,c5,d5)\",\n        },\n    },\n    {\n        name: \"Equus Lunae\",\n        spin: Spin.LeftRight,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\n            \"(\",\n            \"  A(16,S95,Md0),\",\n            \"  b(16,S95,Md0),\",\n            \"  a(16,S95,Md0),\",\n            \"  B(16,S95,Md0)\",\n            \")\",\n        ],\n        markDefStrings: {\n            0: \"shaping-distance-60\",\n        },\n    },\n    {\n        name: \"Runner\",\n        spin: Spin.LeftRight,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Bouncy,\n        code: [\"(A1,B(5,S90),C(5,S90),D(5,S90))\"],\n    },\n    {\n        name: \"Infinity\",\n        spin: Spin.LeftRight,\n        postGrowthOp: 3,\n        surfaceCharacter: 2,\n        code: [\n            \"(\",\n            \"A(11,S88,MA1),b(11,S88,MA1),\",\n            \"a(11,S88,MA2),B(11,S88,MA2)\",\n            \")\",\n        ],\n        featureValues: {},\n        markDefStrings: {\n            \"1\": \"join\",\n            \"2\": \"join\",\n        },\n    },\n    {\n        name: \"Propellor Tree\",\n        spin: Spin.LeftRight,\n        postGrowthOp: 3,\n        surfaceCharacter: 2,\n        code: [\n            \"(\",\n            \"  a(5,S110),\",\n            \"  B(11,S90,MA3),\",\n            \"  b(11,S90,MA1),\",\n            \"  C(11,S90,MA2),\",\n            \"  c(11,S90,MA3),\",\n            \"  D(11,S90,MA1),\",\n            \"  d(11,S90,MA2),\",\n            \")\",\n        ],\n        featureValues: {},\n        markDefStrings: {\n            \"1\": \"join\",\n            \"2\": \"join\",\n            \"3\": \"join\",\n            \"4\": \"join\",\n        },\n    },\n    {\n        name: \"Halo by Crane\",\n        spin: Spin.Left,\n        scale: 100,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(5,S92,b(12,S92,MA1),d(11,S92,MA1))\"],\n        markDefStrings: {\n            1: \"join\",\n        },\n        jobs: [\n            {\n                age: 60000,\n                todo: \"pretensing\",\n            },\n        ],\n        featureValues: {\n            [WorldFeature.Gravity]: 50,\n            [WorldFeature.IterationsPerFrame]: 1000,\n        },\n    },\n    {\n        name: \"Convergence\",\n        spin: Spin.LeftRight,\n        scale: 100,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(a2,b(10,S90,MA1),c(10,S90,MA1),d(10,S90,MA1))\"],\n        markDefStrings: {\n            1: \"join\",\n        },\n        jobs: [\n            {\n                age: 60000,\n                todo: \"pretensing\",\n            },\n        ],\n        featureValues: {\n            [WorldFeature.IterationsPerFrame]: 1000,\n        },\n    },\n    {\n        name: \"Headless Hug\",\n        spin: Spin.LeftRight,\n        scale: 105,\n        postGrowthOp: PostGrowthOp.BowtieFaces,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\n            \"(\",\n            \"A(OOOOXOO,S95,MA0),\",\n            \"b(OOOOXOO,S95,MA0),\",\n            \"a(3,C(XOOOXOO,S93,MA3),S90,MA2),\",\n            \"B(3,C(XOOOXOO,S93,MA3),S90,MA2)\",\n            \")\",\n        ],\n        markDefStrings: {\n            \"0\": \"shaping-distance-5\",\n            \"2\": \"shaping-distance-7\",\n            \"3\": \"shaping-distance-5\",\n        },\n        featureValues: {\n            [WorldFeature.IterationsPerFrame]: 1000,\n            [WorldFeature.PushOverPull]: 400,\n        },\n        jobs: [\n            {\n                age: 100000,\n                todo: \"pretensing\",\n            },\n            {\n                age: 110000,\n                todo: \"conflict\",\n            },\n            {\n                age: 120000,\n                todo: \"orient-0\",\n            },\n        ],\n    },\n    {\n        name: \"Triped\",\n        spin: Spin.LeftRight,\n        scale: 100,\n        postGrowthOp: PostGrowthOp.Bowtie,\n        surfaceCharacter: SurfaceCharacter.Bouncy,\n        code: [\"(B(9,S90,MA1),C(9,S90,MA1),D(9,S90,MA1))\"],\n        markDefStrings: {\n            1: \"shaping-distance-25\",\n        },\n        featureValues: {\n            [WorldFeature.IterationsPerFrame]: 1000,\n            [WorldFeature.PushOverPull]: 1000,\n        },\n        jobs: [\n            {\n                age: 80000,\n                todo: \"pretensing\",\n            },\n        ],\n    },\n    {\n        name: \"Arch\",\n        spin: Spin.Left,\n        scale: 1600,\n        postGrowthOp: PostGrowthOp.Faces,\n        surfaceCharacter: SurfaceCharacter.Frozen,\n        code: [\"(A(3,MA0), a(4,MA0))\"],\n        markDefStrings: {\n            0: \"pretenst-distance-35\",\n        },\n        featureValues: {\n            [WorldFeature.PushOverPull]: 1000,\n            [WorldFeature.IterationsPerFrame]: 500,\n        },\n        jobs: [\n            {\n                age: 50000,\n                todo: \"orient-0\",\n            },\n        ],\n    },\n]\n\nexport const BOOTSTRAP = BOOTSTRAP_TENSCRIPTS.map(tenscript => {\n    compileTenscript(tenscript, (message: string) => {\n        throw new Error(`Bootstrap compile error in \"${tenscript}\"! ${message}`)\n    })\n    return tenscript\n})\n\nexport const CONSTRUCTIONS = BOOTSTRAP.filter(({scale}) => scale !== undefined)\n","import { Vector3 } from \"three\"\n\nimport { ITensegrityBuilder, Tensegrity } from \"../fabric/tensegrity\"\nimport { IJoint, IPercent, IRole, percentOrHundred } from \"../fabric/tensegrity-types\"\n\nconst PUSH: IRole = {\n    tag: \"push\",\n    push: true,\n    length: 8,\n    stiffness: 1,\n}\n\nconst PULL: IRole = {\n    tag: \"pull\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nexport class KleinBuilder implements ITensegrityBuilder {\n    private tensegrity: Tensegrity\n\n    constructor(public readonly width: number, public readonly height: number, public readonly shift: number) {\n        if (height % 2 === 0) {\n            throw new Error(\"Even height not allowed\")\n        }\n    }\n\n    public operateOn(tensegrity: Tensegrity): void {\n        this.tensegrity = tensegrity\n    }\n\n    public finished(): boolean {\n        return this.tensegrity.joints.length > 0\n    }\n\n    public work(): void {\n        for (let j = 0; j < this.width * this.height / 2; j++) {\n            this.randomJoint()\n        }\n        this.tensegrity.instance.refreshFloatView()\n        const createInterval = (alpha: IJoint, omega: IJoint, role: IRole, scale: IPercent) =>\n            this.tensegrity.createInterval(alpha, omega, role, scale, 100)\n        const createFace = (j0: IJoint, j1: IJoint, j2: IJoint) =>\n            this.tensegrity.instance.fabric.create_face(j0.index, j1.index, j2.index)\n        for (let y = 0; y < this.height; y++) {\n            const scale = percentOrHundred()\n            for (let x = 0; x < this.width; x++) {\n                if ((x + y) % 2 === 0) {\n                    const a = this.kleinJoint(x, y)\n                    const b = this.kleinJoint(x - 1, y + 1)\n                    const c = this.kleinJoint(x + 1, y + 1)\n                    const d = this.kleinJoint(x, y + 2)\n                    const e = this.kleinJoint(x - 1, y + 3)\n                    const f = this.kleinJoint(x + 1, y + 3)\n                    createInterval(a, b, PULL, scale)\n                    createInterval(a, c, PULL, scale)\n                    createInterval(a, d, PULL, scale)\n                    createInterval(a, e, PUSH, scale)\n                    createInterval(a, f, PUSH, scale)\n                    createInterval(e, f, PUSH, scale)\n                    createFace(a, b, d)\n                    createFace(a, c, d)\n                }\n            }\n        }\n    }\n\n    private randomJoint(): void {\n        const location = new Vector3(100)\n        while (location.lengthSq() > 1) {\n            location.set(Math.random() * 2 - 1, Math.random() * 2 - 1, Math.random() * 2 - 1)\n        }\n        this.tensegrity.createJoint(location)\n    }\n\n    private kleinJoint(x: number, y: number): IJoint {\n        const flip = Math.floor(y / this.height) % 2 === 1\n        const xRelative = flip ? this.shift - 1 - x : x\n        const xModulo = (this.width * 2 + xRelative) % this.width\n        const yModulo = y % this.height\n        const jointIndex = Math.floor((yModulo * this.width + xModulo) / 2)\n        return this.tensegrity.joints[jointIndex]\n    }\n}\n\n","import { OrbitControls, PerspectiveCamera } from \"@react-three/drei\"\nimport { Canvas, useFrame } from \"@react-three/fiber\"\nimport { WorldFeature } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { FaSignOutAlt, FaSyncAlt } from \"react-icons/all\"\nimport { Button, ButtonGroup, Form, FormGroup, Input, Label } from \"reactstrap\"\nimport { useRecoilState } from \"recoil\"\nimport { Color, DoubleSide, MeshLambertMaterial, Vector3 } from \"three\"\n\nimport { GlobalMode, reloadGlobalMode } from \"../fabric/eig-util\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { rotatingAtom } from \"../storage/recoil\"\nimport { featureMapping } from \"../view/feature-mapping\"\nimport { LINE_VERTEX_COLORS } from \"../view/materials\"\n\nconst meshLambertMaterial = new MeshLambertMaterial({color: \"#FFFFFF\", side: DoubleSide})\n\nexport function KleinView({createKlein}: {\n    createKlein: (width: number, height: number, shift: number) => Tensegrity,\n}): JSX.Element {\n    const [height, setHeight] = useState(\"31\")\n    const [width, setWidth] = useState(\"10\")\n    const [frozen, setFrozen] = useState(false)\n    const [drag, setDrag] = useState(true)\n    const generate = () => createKlein(toInt(width, 18), toInt(height, 41), 0)\n    const [rotating, setRotating] = useRecoilState(rotatingAtom)\n    const [klein, setKlein] = useState(generate)\n    useEffect(() => {\n        if (klein) {\n            const feature = WorldFeature.ShapingDrag\n            const percent = drag ? 1000 : 0\n            const value = featureMapping(feature).percentToValue(percent)\n            klein.instance.applyFeature({feature, percent, value}, false)\n        }\n    }, [drag, klein])\n    return (\n        <div style={{position: \"absolute\", left: 0, right: 0, height: \"100%\"}}>\n            <div id=\"bottom-right\">\n                <ButtonGroup>\n                    <Button color={rotating ? \"warning\" : \"secondary\"} onClick={() => setRotating(!rotating)}>\n                        <FaSyncAlt/>\n                    </Button>\n                    <Button color=\"warning\" onClick={() => reloadGlobalMode(GlobalMode.Choice)}>\n                        <FaSignOutAlt/>\n                    </Button>\n                </ButtonGroup>\n            </div>\n            <div id=\"top-left\">\n                <Form\n                    style={{width: \"9em\", backgroundColor: \"white\", margin: \"1em\", padding: \"1em\", borderRadius: \"1em\"}}\n                    onSubmit={e => {\n                        e.preventDefault()\n                        setKlein(() => generate())\n                        setFrozen(false)\n                    }}>\n                    <FormGroup>\n                        <Label for=\"height\">Height(odd)</Label>\n                        <Input id=\"height\"\n                               value={height}\n                               valid={isValidHeight(height)}\n                               invalid={!isValidHeight(height)}\n                               onChange={({target}) => {\n                                   console.log(\"set height\", target.value)\n                                   setHeight(target.value)\n                               }}\n                        />\n                    </FormGroup>\n                    <FormGroup>\n                        <Label for=\"width\">Width(even)</Label>\n                        <Input id=\"width\"\n                               value={width}\n                               valid={isValidWidth(width)}\n                               invalid={!isValidWidth(width)}\n                               onChange={({target}) => setWidth(target.value)}\n                        />\n                    </FormGroup>\n                    <Button color=\"success\" className=\"w-100 my-1\" type=\"submit\">Generate!</Button>\n                    <hr/>\n                    <Button color={frozen ? \"warning\" : \"secondary\"} className=\"w-100 my-1\"\n                            onClick={() => setFrozen(!frozen)}>{frozen ? \"Unfreeze\" : \"Freeze\"}</Button>\n                    <Button color={drag ? \"warning\" : \"secondary\"} className=\"w-100 my-1\"\n                            onClick={() => setDrag(!drag)}>{drag ? \"Free\" : \"Drag\"}</Button>\n                </Form>\n            </div>\n            <Canvas style={{backgroundColor: \"black\"}}>\n                {!klein ? <h1>No Klein</h1> : <KleinScene klein={klein} frozen={frozen} rotating={rotating}/>}\n            </Canvas>\n        </div>\n    )\n}\n\nfunction KleinScene({klein, frozen, rotating}: { klein: Tensegrity, frozen: boolean, rotating: boolean }): JSX.Element {\n    const [target, setTarget] = useState(new Vector3())\n    useFrame(state => {\n        const {camera, clock} = state\n        if (clock.elapsedTime < 0.01) {\n            camera.position.set(50, 0, 0)\n        }\n        if (!frozen) {\n            klein.iterate()\n        }\n        const toMidpoint = new Vector3().subVectors(klein.instance.midpoint, target).multiplyScalar(0.001)\n        setTarget(new Vector3().copy(target).add(toMidpoint))\n    })\n    return (\n        <group>\n            <OrbitControls target={target} autoRotate={rotating} maxDistance={200} zoomSpeed={0.3}/>\n            <scene>\n                {frozen ? (\n                    <mesh\n                        geometry={klein.instance.floatView.faceGeometry}\n                        material={meshLambertMaterial}\n                        matrixAutoUpdate={false}\n                    />\n                ) : (\n                    <lineSegments\n                        geometry={klein.instance.floatView.lineGeometry}\n                        material={LINE_VERTEX_COLORS}\n                        onUpdate={self => self.geometry.computeBoundingSphere()}\n                    />\n                )}\n                <PerspectiveCamera makeDefault={true}>\n                    <pointLight color={new Color(\"#4fa903\")} position={new Vector3(0, 100, 0)}/>\n                    <pointLight color={new Color(\"#043eb7\")} position={new Vector3(0, -10, 100)}/>\n                    <pointLight color={new Color(\"#f60606\")} position={new Vector3(0, -10, -100)}/>\n                </PerspectiveCamera>\n            </scene>\n        </group>\n\n    )\n}\n\nfunction toInt(s: string, d: number): number {\n    const n = parseInt(s, 10)\n    return isNaN(n) ? d : n\n}\n\nfunction isValidWidth(s: string): boolean {\n    const parsed = parseInt(s, 10)\n    return !isNaN(parsed) && parsed % 2 === 0\n}\n\nfunction isValidHeight(s: string): boolean {\n    const parsed = parseInt(s, 10)\n    return !isNaN(parsed) && parsed % 2 === 1\n}\n","import { Vector3 } from \"three\"\n\nimport { ITensegrityBuilder, Tensegrity } from \"../fabric/tensegrity\"\nimport { IJoint, IRole, percentOrHundred } from \"../fabric/tensegrity-types\"\n\nconst PUSH: IRole = {\n    tag: \"push\",\n    push: true,\n    length: 3,\n    stiffness: 1,\n}\n\nconst PULL_WIDTH: IRole = {\n    tag: \"pull-width\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nconst PULL_LENGTH: IRole = {\n    tag: \"pull-length\",\n    push: false,\n    length: 0.4,\n    stiffness: 1,\n}\n\nexport class MobiusBuilder implements ITensegrityBuilder {\n    public readonly radius: number\n    public readonly jointCount: number\n    private tensegrity: Tensegrity\n\n    constructor(segments: number) {\n        this.jointCount = segments * 2 + 1\n        this.radius = this.jointCount * PULL_LENGTH.length * 0.17\n    }\n\n    public operateOn(tensegrity: Tensegrity): void {\n        this.tensegrity = tensegrity\n    }\n\n    public finished(): boolean {\n        return this.tensegrity.joints.length > 0\n    }\n\n    public work(): void {\n        const location = (bottom: boolean, angle: number) => {\n            const major = new Vector3(Math.cos(angle) * this.radius, 0, Math.sin(angle) * this.radius)\n            const outwards = new Vector3().copy(major).normalize()\n            const up = new Vector3(0, 1, 0)\n            const ray = new Vector3().addVectors(outwards.multiplyScalar(Math.sin(angle / 2)), up.multiplyScalar(Math.cos(angle / 2)))\n            const minor = ray.multiplyScalar((bottom ? -0.5 : 0.5))\n            return major.add(minor)\n        }\n        for (let joint = 0; joint < this.jointCount; joint++) {\n            const angle = joint / this.jointCount * Math.PI * 2\n            this.tensegrity.createJoint(location(joint % 2 === 0, angle))\n        }\n        this.tensegrity.instance.refreshFloatView()\n        const createInterval = (alpha: IJoint, omega: IJoint, role: IRole) =>\n            this.tensegrity.createInterval(alpha, omega, role, percentOrHundred(), 1000)\n        for (let jointIndex = 0; jointIndex < this.jointCount; jointIndex++) {\n            const joint = (offset: number) => this.tensegrity.joints[(jointIndex * 2 + offset) % this.tensegrity.joints.length]\n            createInterval(joint(0), joint(2), PULL_LENGTH)\n            createInterval(joint(0), joint(1), PULL_WIDTH)\n            createInterval(joint(0), joint(3), PUSH)\n            this.tensegrity.instance.fabric.create_face(joint(0).index, joint(1).index, joint(2).index)\n        }\n    }\n}\n","import { OrbitControls, Stars } from \"@react-three/drei\"\nimport { Canvas, useFrame } from \"@react-three/fiber\"\nimport * as React from \"react\"\nimport { useState } from \"react\"\nimport { FaSignOutAlt } from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { useRecoilBridgeAcrossReactRoots_UNSTABLE } from \"recoil\"\nimport { Color, DoubleSide, MeshLambertMaterial, Vector3 } from \"three\"\n\nimport { GlobalMode, reloadGlobalMode } from \"../fabric/eig-util\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IInterval } from \"../fabric/tensegrity-types\"\n\nconst meshLambertMaterial = new MeshLambertMaterial({color: \"#FFFFFF\", side: DoubleSide})\n\nexport function MobiusView({createMobius}: {\n    createMobius: (segments: number) => Tensegrity,\n}): JSX.Element {\n    const [mobius] = useState(() => {\n        const m = createMobius(60)\n        m.iterate()\n        return m\n    })\n    const [muscles] = useState(() => {\n        const unordered = mobius.intervals.filter(({role}) => role.tag === \"pull-length\")\n        const even = unordered.filter(({}, index) => index % 2 === 0)\n        const odd = unordered.filter(({}, index) => index % 2 === 1)\n        return even.concat(odd)\n    })\n    const RecoilBridge = useRecoilBridgeAcrossReactRoots_UNSTABLE()\n    return (\n        <div style={{position: \"absolute\", left: 0, right: 0, height: \"100%\"}}>\n            <div id=\"bottom-right\">\n                <ButtonGroup>\n                    <Button color=\"warning\" onClick={() => reloadGlobalMode(GlobalMode.Choice)}><FaSignOutAlt/></Button>\n                </ButtonGroup>\n            </div>\n            <Canvas style={{backgroundColor: \"black\"}}>\n                <RecoilBridge>\n                    {!mobius ? <h1>No Mobius</h1> : <MobiusScene mobius={mobius} muscles={muscles}/>}\n                </RecoilBridge>\n            </Canvas>\n        </div>\n    )\n}\n\nfunction MobiusScene({mobius, muscles}: { mobius: Tensegrity, muscles: IInterval[] }): JSX.Element {\n    const [target, setTarget] = useState(new Vector3())\n    const [muscleIndex, setMuscleIndex] = useState(0)\n    const [twitchTime, setTwitchTime] = useState(20000)\n    useFrame(state => {\n        const {camera, clock} = state\n        if (clock.elapsedTime < 0.01) {\n            const radius = mobius.joints.reduce((r, joint) => Math.max(r, mobius.instance.jointLocation(joint).length()), 0)\n            const height = mobius.joints.reduce((h, joint) => Math.max(h, mobius.instance.jointLocation(joint).y), 0)\n            camera.position.set(radius * 1.5, height * 2, 0)\n        }\n        mobius.iterate()\n        const age = mobius.instance.fabric.age\n        if (age > twitchTime) {\n            const muscle = muscles[muscleIndex]\n            mobius.instance.fabric.twitch_interval(muscle.index, 50000, 50000, 0.9)\n            setMuscleIndex(idx => idx === muscles.length - 1 ? 0 : idx + 1)\n            setTwitchTime(time => time + 10000)\n        }\n        const toMidpoint = new Vector3().subVectors(mobius.instance.midpoint, target).multiplyScalar(0.1)\n        setTarget(new Vector3().copy(target).add(toMidpoint))\n    })\n    return (\n        <group>\n            <OrbitControls target={target} maxDistance={200}/>\n            <scene>\n                <mesh\n                    geometry={mobius.instance.floatView.faceGeometry}\n                    material={meshLambertMaterial}\n                    matrixAutoUpdate={false}\n                />\n                <Stars radius={300}/>\n                <ambientLight color={new Color(\"white\")} intensity={0.1}/>\n                <pointLight color={new Color(\"#4fa903\")} position={new Vector3(0, 100, 0)}/>\n                <pointLight color={new Color(\"#043eb7\")} position={new Vector3(0, -10, 100)}/>\n                <pointLight color={new Color(\"#f60606\")} position={new Vector3(0, -10, -100)}/>\n            </scene>\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Vector3 } from \"three\"\n\nexport interface IVertex {\n    index: number,\n    location: Vector3\n    adjacent: IVertex[]\n}\n\nexport class SphereScaffold {\n    public readonly vertices: IVertex[] = []\n\n    constructor(public readonly frequency: number, public readonly radius: number) {\n        VERTEX.forEach(location => this.vertexAt(location))\n        if (frequency === 1) {\n            EDGE.forEach(edge => {\n                const v0 = this.vertices[edge[0]]\n                const v1 = this.vertices[edge[1]]\n                adjacent(v0, v1)\n            })\n        } else if (frequency === 2) {\n            const midVertices = EDGE.map(edge => {\n                const v0 = this.vertices[edge[0]]\n                const v1 = this.vertices[edge[1]]\n                const midEdge = this.vertexBetween(v0, v1)\n                adjacent(v0, midEdge)\n                adjacent(midEdge, v1)\n                return midEdge\n            })\n            FACE_EDGES.forEach(faceEdge => {\n                const side0 = midVertices[faceEdge[0]]\n                const side1 = midVertices[faceEdge[1]]\n                const side2 = midVertices[faceEdge[2]]\n                adjacent(side0, side1)\n                adjacent(side1, side2)\n                adjacent(side2, side0)\n            })\n        } else {\n            this.buildFaces(this.buildEdgeVertices())\n        }\n        this.vertices.forEach(sortVertex)\n    }\n\n    private buildEdgeVertices(): IVertex[][] {\n        const edgeVertices: IVertex[][] = []\n        EDGE.forEach(edgeVertexIndex => {\n            const verticesOfEdge: IVertex[] = []\n            edgeVertices.push(verticesOfEdge)\n            let vertex: IVertex | undefined\n            let previousVertex: IVertex | undefined\n            for (let walk = 0; walk < this.frequency - 1; walk++) {\n                previousVertex = vertex\n                const v0 = this.vertices[edgeVertexIndex[0]]\n                const v1 = this.vertices[edgeVertexIndex[1]]\n                const loc0 = v0.location\n                const loc1 = v1.location\n                const spot = new Vector3().lerpVectors(loc0, loc1, (walk + 1) / this.frequency)\n                vertex = this.vertexAt(spot)\n                verticesOfEdge.push(vertex)\n                if (previousVertex) {\n                    adjacent(vertex, previousVertex)\n                    if (walk === this.frequency - 2) {\n                        adjacent(vertex, v1)\n                    }\n                } else {\n                    adjacent(vertex, v0)\n                }\n            }\n        })\n        return edgeVertices\n    }\n\n    private buildFaces(edgeVertices: IVertex[][]): void {\n        const faceVertexArrays: IVertex[][] = []\n        FACE_VERTICES.forEach((faceVertexIndex, faceIndex) => {\n            const faceVertex = (which: number) => this.vertices[faceVertexIndex[which]]\n            const v0 = faceVertex(0)\n            const origin = v0.location\n            // interpolate along the edges of the face creating arrays of vertices on the way\n            for (let walkA = 1; walkA < this.frequency - 1; walkA++) {\n                const v1 = faceVertex(1)\n                const vectorA = new Vector3().lerpVectors(origin, v1.location, walkA / this.frequency)\n                vectorA.sub(origin)\n                faceVertexArrays[walkA - 1] = []\n                for (let walkB = 1; walkB < this.frequency - walkA; walkB++) {\n                    const v2 = faceVertex(2)\n                    const vectorB = new Vector3().lerpVectors(origin, v2.location, walkB / this.frequency)\n                    vectorB.sub(origin)\n                    const spot = new Vector3().copy(origin)\n                    spot.add(vectorA)\n                    spot.add(vectorB)\n                    faceVertexArrays[walkA - 1].push(this.vertexAt(spot))\n                }\n            }\n            // define the adjacency among face vertices\n            for (let row = 0; row < faceVertexArrays.length; row++) {\n                for (let rowMember = 0; rowMember < faceVertexArrays[row].length; rowMember++) {\n                    if (rowMember < faceVertexArrays[row].length - 1) {\n                        adjacent(faceVertexArrays[row][rowMember], faceVertexArrays[row][rowMember + 1])\n                    }\n                    if (row > 0) {\n                        const vert = faceVertexArrays[row][rowMember]\n                        adjacent(vert, faceVertexArrays[row - 1][rowMember])\n                        adjacent(vert, faceVertexArrays[row - 1][rowMember + 1])\n                    }\n                }\n            }\n            // compile side vertices (of a triangle!) reversing traversal when necessary\n            const sideVertices: IVertex[] [] = [[], [], []]\n            for (let walk = 0; walk < this.frequency - 2; walk++) {\n                const antiWalk = faceVertexArrays.length - walk - 1\n                sideVertices[0].push(faceVertexArrays[walk][0])\n                sideVertices[1].push(faceVertexArrays[antiWalk][faceVertexArrays[antiWalk].length - 1])\n                sideVertices[2].push(faceVertexArrays[0][walk])\n            }\n            // define adjacency between face vertices and edge vertices\n            for (let walkSide = 0; walkSide < sideVertices.length; walkSide++) {\n                const faceEdges = FACE_EDGES[faceIndex]\n                const edge = edgeVertices[faceEdges[walkSide]]\n                for (let walk = 0; walk < faceVertexArrays.length; walk++) {\n                    const vsVertex = sideVertices[walkSide][walk]\n                    adjacent(vsVertex, edge[walk])\n                    adjacent(vsVertex, edge[walk + 1])\n                }\n            }\n        })\n        PENTAGON_VERTICES.forEach(vertexArray => {\n            // define the adjacency for this pentagon\n            for (let current = 0; current < vertexArray.length; current++) {\n                const next = (current + 1) % vertexArray.length\n                const edgeVertexA = vertexArray[current].front ? 0 : this.frequency - 2\n                const edgeVertexB = vertexArray[next].front ? 0 : this.frequency - 2\n                const vertexA = edgeVertices[vertexArray[current].edge][edgeVertexA]\n                const vertexB = edgeVertices[vertexArray[next].edge][edgeVertexB]\n                adjacent(vertexA, vertexB)\n            }\n        })\n    }\n\n    private vertexBetween(v0: IVertex, v1: IVertex): IVertex {\n        const location = new Vector3().copy(v0.location).lerp(v1.location, 0.5)\n        return this.vertexAt(location)\n    }\n\n    private vertexAt(location: Vector3): IVertex {\n        const length = location.length()\n        location.multiplyScalar(this.radius / length)\n        const index = this.vertices.length\n        const vertex = {index, location, adjacent: []}\n        this.vertices.push(vertex)\n        return vertex\n    }\n}\n\nconst NUL = 0.0\nconst ONE = 0.5257311121191336\nconst PHI = 0.8506508083520400\n\nconst VERTEX: Vector3[] = [\n    new Vector3(+ONE, NUL, +PHI), new Vector3(+ONE, NUL, -PHI),\n    new Vector3(+PHI, +ONE, NUL), new Vector3(-PHI, +ONE, NUL),\n    new Vector3(NUL, +PHI, +ONE), new Vector3(NUL, -PHI, +ONE),\n    new Vector3(-ONE, NUL, -PHI), new Vector3(-ONE, NUL, +PHI),\n    new Vector3(-PHI, -ONE, NUL), new Vector3(+PHI, -ONE, NUL),\n    new Vector3(NUL, -PHI, -ONE), new Vector3(NUL, +PHI, -ONE),\n]\n\nconst EDGE = [\n    [0, 2], [0, 4], [0, 5], [0, 7], [0, 9],\n    [1, 10], [1, 11], [1, 2], [1, 6], [1, 9],\n    [2, 11], [2, 4], [2, 9], [3, 11], [3, 4],\n    [3, 6], [3, 7], [3, 8], [4, 11], [4, 7],\n    [5, 10], [5, 7], [5, 8], [5, 9], [6, 10],\n    [6, 11], [6, 8], [7, 8], [8, 10], [9, 10],\n]\n\nconst FACE_VERTICES = [\n    [0, 2, 4], [0, 2, 9], [0, 4, 7], [0, 5, 7], [0, 5, 9],\n    [1, 2, 11], [1, 2, 9], [1, 6, 10], [1, 6, 11], [1, 9, 10],\n    [2, 4, 11], [3, 4, 11], [3, 4, 7], [3, 6, 11], [3, 6, 8],\n    [3, 7, 8], [5, 7, 8], [5, 8, 10], [5, 9, 10], [6, 8, 10],\n]\n\nconst FACE_EDGES = [\n    [0, 11, 1], [0, 12, 4], [1, 19, 3], [2, 21, 3], [2, 23, 4],\n    [7, 10, 6], [7, 12, 9], [8, 24, 5], [8, 25, 6], [9, 29, 5],\n    [11, 18, 10], [14, 18, 13], [14, 19, 16], [15, 25, 13], [15, 26, 17],\n    [16, 27, 17], [21, 27, 22], [22, 28, 20], [23, 29, 20], [26, 28, 24],\n]\n\ninterface IPentagonVertex {\n    edge: number\n    front: boolean\n}\n\nconst PENTAGON_VERTICES: IPentagonVertex[][] = [\n    [{edge: 0, front: true}, {edge: 1, front: true},\n        {edge: 3, front: true}, {edge: 2, front: true}, {edge: 4, front: true}],\n    [{edge: 7, front: true}, {edge: 6, front: true},\n        {edge: 8, front: true}, {edge: 5, front: true}, {edge: 9, front: true}],\n    [{edge: 10, front: true}, {edge: 11, front: true},\n        {edge: 0, front: false}, {edge: 12, front: true}, {edge: 7, front: false}],\n    [{edge: 14, front: true}, {edge: 13, front: true},\n        {edge: 15, front: true}, {edge: 17, front: true}, {edge: 16, front: true}],\n    [{edge: 18, front: true}, {edge: 11, front: false},\n        {edge: 1, front: false}, {edge: 19, front: true}, {edge: 14, front: false}],\n    [{edge: 21, front: true}, {edge: 22, front: true},\n        {edge: 20, front: true}, {edge: 23, front: true}, {edge: 2, front: false}],\n    [{edge: 26, front: true}, {edge: 24, front: true},\n        {edge: 8, front: false}, {edge: 25, front: true}, {edge: 15, front: false}],\n    [{edge: 27, front: true}, {edge: 16, front: false},\n        {edge: 19, front: false}, {edge: 3, front: false}, {edge: 21, front: false}],\n    [{edge: 28, front: true}, {edge: 22, front: false},\n        {edge: 27, front: false}, {edge: 17, front: false}, {edge: 26, front: false}],\n    [{edge: 4, front: false}, {edge: 23, front: false},\n        {edge: 29, front: true}, {edge: 9, front: false}, {edge: 12, front: false}],\n    [{edge: 28, front: false}, {edge: 20, front: false},\n        {edge: 29, front: false}, {edge: 5, front: false}, {edge: 24, front: false}],\n    [{edge: 6, front: false}, {edge: 10, front: false},\n        {edge: 18, front: false}, {edge: 13, front: false}, {edge: 25, front: false}],\n]\n\nfunction adjacent(v0: IVertex, v1: IVertex): void {\n    v0.adjacent.push(v1)\n    v1.adjacent.push(v0)\n}\n\n// sort the adjacent vertices of a vertex in a clockwise way\nfunction sortVertex(vertex: IVertex): void {\n    const outward = new Vector3().copy(vertex.location).normalize()\n    const first = vertex.adjacent.pop()\n    if (!first) {\n        throw new Error(\"No first to pop!\")\n    }\n    const sorted: IVertex[] = [first]\n    const vectorTo = ({location}: IVertex) => new Vector3().subVectors(location, vertex.location).normalize()\n    while (vertex.adjacent.length > 0) {\n        const top: IVertex = sorted[sorted.length - 1]\n        const next = vertex.adjacent.find(neigbor => {\n            const toAdjacent = vectorTo(neigbor)\n            const toTop = vectorTo(top)\n            if (toAdjacent.dot(toTop) < 0.25) {\n                return false\n            }\n            return new Vector3().crossVectors(toTop, toAdjacent).dot(outward) > 0\n        })\n        if (!next) {\n            throw new Error(\"No next found\")\n        }\n        sorted.push(next)\n        vertex.adjacent = vertex.adjacent.filter(adj => adj.index !== next.index)\n    }\n    vertex.adjacent = sorted\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Stage } from \"eig\"\nimport { Quaternion, Vector3 } from \"three\"\n\nimport { FabricInstance } from \"../fabric/fabric-instance\"\nimport { ITensegrityBuilder, Tensegrity } from \"../fabric/tensegrity\"\nimport { IInterval, IJoint, IRole, percentFromFactor } from \"../fabric/tensegrity-types\"\n\nimport { IVertex, SphereScaffold } from \"./sphere-scaffold\"\n\nconst PUSH: IRole = {\n    tag: \"push\",\n    push: true,\n    length: 1,\n    stiffness: 1,\n}\n\nconst PULL: IRole = {\n    tag: \"pull\",\n    push: false,\n    length: 1,\n    stiffness: 1,\n}\n\nconst TWIST_ANGLE = 0.52\n\ninterface IHub {\n    vertex: IVertex\n    spokes: ISpoke[]\n}\n\ninterface ISpoke {\n    hubs: IHub[]\n    joints: IJoint[]\n    push: IInterval[]\n}\n\nexport class SphereBuilder implements ITensegrityBuilder {\n    private readonly scaffold: SphereScaffold\n    private readonly hubs: IHub[]\n    private tensegrity: Tensegrity\n\n    constructor(\n        public readonly location: Vector3,\n        public readonly frequency: number,\n        public readonly radius: number,\n        public readonly useCurves: boolean,\n    ) {\n        this.scaffold = new SphereScaffold(frequency, radius)\n        this.hubs = this.scaffold.vertices.map(vertex => ({vertex, spokes: []} as IHub))\n    }\n\n    public operateOn(tensegrity: Tensegrity): void {\n        this.tensegrity = tensegrity\n    }\n\n    public finished(): boolean {\n        return this.tensegrity.joints.length > 0\n    }\n\n    public work(): void {\n        const allSpokes: Record<string, ISpoke> = {}\n        // create pushes and populate spokes\n        this.hubs.forEach(({vertex, spokes}) =>\n            vertex.adjacent.forEach(adjacent => {\n                const existing = allSpokes[`${adjacent.index}-${vertex.index}`]\n                const hubs = [this.hubs[vertex.index], this.hubs[adjacent.index]]\n                if (existing) {\n                    const {push} = existing\n                    const joints = this.useCurves ? [push[1].omega, push[0].omega, push[1].alpha, push[0].alpha] : [push[0].omega, push[0].alpha]\n                    spokes.push({push, hubs, joints})\n                } else {\n                    const push = this.useCurves ? this.createCurve(vertex, adjacent) : this.createPush(vertex, adjacent)\n                    const joints = this.useCurves ? [push[0].alpha, push[1].alpha, push[0].omega, push[1].omega] : [push[0].alpha, push[0].omega]\n                    const spoke: ISpoke = {push, hubs, joints}\n                    allSpokes[`${vertex.index}-${adjacent.index}`] = spoke\n                    spokes.push(spoke)\n                }\n            }))\n        this.instance.refreshFloatView()\n        const segmentLength = this.averageIntervalLength / 3\n        const allPulls: Record<string, IInterval> = {}\n        this.hubs.forEach(hub => hub.spokes.forEach(spoke => this.pullsForSpoke(hub, spoke, segmentLength, allPulls)))\n        this.tensegrity.toDo = {\n            age: 20000,\n            todo: (t: Tensegrity) => {\n                t.stage = Stage.Slack\n                t.fabric.set_altitude(this.location.y)\n                t.stage = Stage.Pretensing\n            },\n        }\n    }\n\n    private createPush(alpha: IVertex, omega: IVertex): IInterval[] {\n        const midpoint = new Vector3().addVectors(alpha.location, omega.location).normalize()\n        const quaternion = new Quaternion().setFromAxisAngle(midpoint, TWIST_ANGLE)\n        const alphaLocation = new Vector3().copy(alpha.location).applyQuaternion(quaternion)\n        const omegaLocation = new Vector3().copy(omega.location).applyQuaternion(quaternion)\n        const length0 = alpha.location.distanceTo(omega.location)\n        const scale = percentFromFactor(length0)\n        const alphaJoint = this.tensegrity.createJoint(alphaLocation)\n        const omegaJoint = this.tensegrity.createJoint(omegaLocation)\n        this.instance.refreshFloatView()\n        return [this.tensegrity.createInterval(alphaJoint, omegaJoint, PUSH, scale)]\n    }\n\n    private createCurve(alphaVertex: IVertex, omegaVertex: IVertex): IInterval[] {\n        const midpoint = new Vector3().addVectors(alphaVertex.location, omegaVertex.location).normalize()\n        const quaternion = new Quaternion().setFromAxisAngle(midpoint, TWIST_ANGLE)\n        const alphaLocation = new Vector3().copy(alphaVertex.location).applyQuaternion(quaternion)\n        const omegaLocation = new Vector3().copy(omegaVertex.location).applyQuaternion(quaternion)\n        const alphaJoint = this.tensegrity.createJoint(alphaLocation)\n        const midAlphaJoint = this.tensegrity.createJoint(new Vector3().lerpVectors(alphaLocation, omegaLocation, 1 / 3))\n        const midOmegaJoint = this.tensegrity.createJoint(new Vector3().lerpVectors(alphaLocation, omegaLocation, 2 / 3))\n        const omegaJoint = this.tensegrity.createJoint(omegaLocation)\n        this.instance.refreshFloatView()\n        const pushScale = percentFromFactor(alphaVertex.location.distanceTo(omegaVertex.location) * 2 / 3)\n        const alpha = this.tensegrity.createInterval(alphaJoint, midOmegaJoint, PUSH, pushScale)\n        const omega = this.tensegrity.createInterval(midAlphaJoint, omegaJoint, PUSH, pushScale)\n        const pullScale = percentFromFactor(alphaVertex.location.distanceTo(omegaVertex.location) / 6)\n        this.tensegrity.createInterval(alphaJoint, midAlphaJoint, PULL, pullScale)\n        this.tensegrity.createInterval(midAlphaJoint, midOmegaJoint, PULL, pullScale)\n        this.tensegrity.createInterval(midOmegaJoint, omegaJoint, PULL, pullScale)\n        return [alpha, omega]\n    }\n\n\n    private pullsForSpoke(hub: IHub, spoke: ISpoke, segmentLength: number, allPulls: Record<string, IInterval>): void {\n        const createPull = (alpha: IJoint, omega: IJoint, idealLength: number) => {\n            const pullName = omega.index > alpha.index ? `${alpha.index}-${omega.index}` : `${omega.index}-${alpha.index}`\n            if (allPulls[pullName]) {\n                return\n            }\n            allPulls[pullName] = this.tensegrity.createInterval(alpha, omega, PULL, percentFromFactor(idealLength))\n        }\n        if (this.useCurves) {\n            createPull(spoke.joints[0], nextSpoke(hub, spoke).joints[1], segmentLength / 5)\n        } else {\n            const next = nextSpoke(hub, spoke)\n            createPull(spoke.joints[0], next.joints[0], segmentLength)\n            const nearOppositeNext = nextSpoke(spoke.hubs[1], spoke).joints[0]\n            const spokeLength = this.instance.intervalLength(spoke.push[0])\n            createPull(next.joints[0], nearOppositeNext, spokeLength - segmentLength * 2)\n        }\n    }\n\n    private get averageIntervalLength(): number {\n        const length = (interval: IInterval) => this.instance.intervalLength(interval)\n        return this.intervals.reduce((sum, push) => sum + length(push), 0) / this.intervals.length\n    }\n\n    private get instance(): FabricInstance {\n        return this.tensegrity.instance\n    }\n\n    private get intervals(): IInterval[] {\n        return this.tensegrity.intervals\n    }\n}\n\nfunction nextSpoke(hub: IHub, spoke: ISpoke): ISpoke {\n    const index = hub.spokes.findIndex(({push}) => push[0].index === spoke.push[0].index)\n    if (index < 0) {\n        throw new Error(\"Cannot find current spoke when looking for next\")\n    }\n    return hub.spokes[(index + 1) % hub.spokes.length]\n}\n","/*\n * Copyright (c) 2020. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\nimport { OrbitControls, Stars } from \"@react-three/drei\"\nimport { Canvas, useFrame } from \"@react-three/fiber\"\nimport * as React from \"react\"\nimport { useEffect, useMemo, useState } from \"react\"\nimport { FaDownload, FaSignOutAlt, FaSnowflake } from \"react-icons/all\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { atom, useRecoilBridgeAcrossReactRoots_UNSTABLE, useRecoilState } from \"recoil\"\nimport { Color, CylinderGeometry, Euler, Material, MeshLambertMaterial, Vector3 } from \"three\"\n\nimport { GlobalMode, reloadGlobalMode } from \"../fabric/eig-util\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { intervalRotation } from \"../fabric/tensegrity-types\"\nimport { getFabricOutput, saveCSVZip } from \"../storage/download\"\nimport { LINE_VERTEX_COLORS } from \"../view/materials\"\nimport { SurfaceComponent } from \"../view/surface-component\"\n\nexport const SPHERE_RADIUS = 15\n\nconst PUSH_RADIUS = 0.004 * SPHERE_RADIUS\nconst PULL_RADIUS = 0.002 * SPHERE_RADIUS\n\nfunction material(colorString: string): Material {\n    const color = new Color(colorString)\n    return new MeshLambertMaterial({color})\n}\n\nconst PUSH_MATERIAL = material(\"#011884\")\nconst PULL_MATERIAL = material(\"#a80000\")\n\nconst FREQUENCY_CHOICES = [1, 2, 3, 4, 5]\n\nexport const showPushAtom = atom({\n    key: \"show push\",\n    default: true,\n})\nexport const showPullAtom = atom({\n    key: \"show pull\",\n    default: true,\n})\nexport const frozenAtom = atom({\n    key: \"frozen\",\n    default: false,\n})\nexport const gravityAtom = atom({\n    key: \"gravity\",\n    default: 2,\n})\nexport const useCurvesAtom = atom({\n    key: \"useCurves\",\n    default: false,\n})\n\nexport function SphereView({frequencyParam, createSphere}: {\n    frequencyParam?: string,\n    createSphere: (frequency: number, gravity: number, useCurves: boolean) => Tensegrity,\n}): JSX.Element {\n    const frequencyChoice = useMemo(() => {\n        const frequency = (frequencyParam === undefined) ? 1 : parseInt(frequencyParam, 10)\n        const index = FREQUENCY_CHOICES.findIndex(c => c === frequency)\n        return index >= 0 ? index : 0\n    }, [])\n    const [frozen, setFrozen] = useRecoilState(frozenAtom)\n    const [showPush, setShowPush] = useRecoilState(showPushAtom)\n    const [showPull, setShowPull] = useRecoilState(showPullAtom)\n    const [gravity, setGravity] = useRecoilState(gravityAtom)\n    const [useCurves] = useRecoilState(useCurvesAtom)\n    const [sphere, setSphere] = useState(() => createSphere(FREQUENCY_CHOICES[frequencyChoice], gravity, useCurves))\n\n    useEffect(() => {\n        setFrozen(false)\n        setSphere(createSphere(FREQUENCY_CHOICES[frequencyChoice], gravity, useCurves))\n    }, [gravity, frequencyChoice, useCurves])\n\n    useEffect(() => {\n        if (!showPush && !showPull) {\n            setShowPush(true)\n            setShowPull(true)\n        }\n    }, [showPush, showPull])\n\n    const RecoilBridge = useRecoilBridgeAcrossReactRoots_UNSTABLE()\n    return (\n        <div style={{position: \"absolute\", left: 0, right: 0, height: \"100%\"}}>\n            <div id=\"bottom-right\">\n                <ButtonGroup>\n                    <Button onClick={() => saveCSVZip(getFabricOutput(sphere, 1, 1, 1))}><FaDownload/></Button>\n                    <Button color=\"warning\" onClick={() => reloadGlobalMode(GlobalMode.Choice)}><FaSignOutAlt/></Button>\n                </ButtonGroup>\n            </div>\n            <div id=\"top-left\">\n                <ButtonGroup>\n                    {FREQUENCY_CHOICES.map((freq, index) => (\n                        <Button key={`Freq${freq}`} onClick={() => reloadGlobalMode(GlobalMode.Sphere, freq.toFixed(0))}\n                                color={index === frequencyChoice ? \"success\" : \"secondary\"}>\n                            {freq}\n                        </Button>\n                    ))}\n                </ButtonGroup>\n            </div>\n            <div id=\"top-right\">\n                <ButtonGroup>\n                    <Button color={gravity === 2 ? \"success\" : \"secondary\"}\n                            onClick={() => setGravity(2)}>Heavy Gravity</Button>\n                    <Button color={gravity === 1 ? \"success\" : \"secondary\"}\n                            onClick={() => setGravity(1)}>Light Gravity</Button>\n                    <Button color={gravity === 0 ? \"success\" : \"secondary\"}\n                            onClick={() => setGravity(0)}>Space</Button>\n                </ButtonGroup>\n            </div>\n            <div id=\"bottom-left\">\n                <ButtonGroup>\n                    <Button color={frozen ? \"success\" : \"secondary\"}\n                            onClick={() => setFrozen(!frozen)}><FaSnowflake/></Button>\n                    <Button color={showPush ? \"success\" : \"secondary\"}\n                            disabled={!frozen}\n                            onClick={() => setShowPush(!showPush)}>C</Button>\n                    <Button color={showPull ? \"success\" : \"secondary\"}\n                            disabled={!frozen}\n                            onClick={() => setShowPull(!showPull)}>T</Button>\n                </ButtonGroup>\n            </div>\n            <Canvas style={{backgroundColor: \"black\"}}>\n                <RecoilBridge>\n                    {!sphere ? <h1>No Sphere</h1> : <SphereScene sphere={sphere}/>}\n                </RecoilBridge>\n            </Canvas>\n        </div>\n    )\n}\n\nfunction SphereScene({sphere}: { sphere: Tensegrity }): JSX.Element {\n    const [target, setTarget] = useState(new Vector3())\n    const [frozen] = useRecoilState(frozenAtom)\n\n    useFrame(state => {\n        const {camera, clock} = state\n        if (clock.elapsedTime < 0.01) {\n            camera.position.set(0, SPHERE_RADIUS, SPHERE_RADIUS * 3.6)\n        }\n        if (!frozen) {\n            sphere.iterate()\n            const toMidpoint = new Vector3().subVectors(sphere.instance.midpoint, target).multiplyScalar(0.1)\n            setTarget(new Vector3().copy(target).add(toMidpoint))\n        }\n    })\n    return (\n        <group>\n            <OrbitControls target={target} maxDistance={200}/>\n            <scene>\n                {frozen ? (\n                    <PolygonView sphere={sphere}/>\n                ) : (\n                    <lineSegments\n                        key=\"lines\"\n                        geometry={sphere.instance.floatView.lineGeometry}\n                        material={LINE_VERTEX_COLORS}\n                        onUpdate={self => self.geometry.computeBoundingSphere()}\n                    />\n                )}\n                <SurfaceComponent/>\n                <Stars radius={300}/>\n                <ambientLight color={new Color(\"white\")} intensity={0.8}/>\n                <directionalLight color={new Color(\"#FFFFFF\")} intensity={2}/>\n            </scene>\n        </group>\n    )\n}\n\nconst CYLINDER = new CylinderGeometry(1, 1, 1, 12, 1, false)\n\nfunction PolygonView({sphere}: { sphere: Tensegrity }): JSX.Element {\n    const [showPush] = useRecoilState(showPushAtom)\n    const [showPull] = useRecoilState(showPullAtom)\n    const instance = sphere.instance\n    return (\n        <group>\n            {!showPull ? undefined : sphere.intervals.filter(({role}) => !role.push).map(interval => {\n                const rotation = intervalRotation(instance.unitVector(interval.index))\n                const length = instance.jointDistance(interval.alpha, interval.omega)\n                const intervalScale = new Vector3(PULL_RADIUS, length, PULL_RADIUS)\n                return (\n                    <mesh\n                        key={`T${interval.index}`}\n                        geometry={CYLINDER}\n                        position={instance.intervalLocation(interval)}\n                        rotation={new Euler().setFromQuaternion(rotation)}\n                        scale={intervalScale}\n                        material={PULL_MATERIAL}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                )\n            })}\n            {!showPush ? undefined : sphere.intervals.filter(({role}) => role.push).map(interval => {\n                const rotation = intervalRotation(instance.unitVector(interval.index))\n                const length = instance.jointDistance(interval.alpha, interval.omega)\n                const intervalScale = new Vector3(PUSH_RADIUS, length, PUSH_RADIUS)\n                return (\n                    <mesh\n                        key={`C${interval.index}`}\n                        geometry={CYLINDER}\n                        position={instance.intervalLocation(interval)}\n                        rotation={new Euler().setFromQuaternion(rotation)}\n                        scale={intervalScale}\n                        material={PUSH_MATERIAL}\n                        matrixWorldNeedsUpdate={true}\n                    />\n                )\n            })}\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { WorldFeature } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { GetHandleProps, GetTrackProps, Handles, Rail, Slider, SliderItem, Tracks } from \"react-compound-slider\"\nimport { FaBalanceScale } from \"react-icons/all\"\nimport { RecoilState, useRecoilState } from \"recoil\"\n\nimport { floatString, percentString } from \"../fabric/eig-util\"\n\nimport { IFeatureMapping } from \"./feature-mapping\"\n\nconst MAX_SLIDER = 100000\nconst domain = [0, MAX_SLIDER]\n\nexport function FeatureSlider({mapping, percentAtom, apply}: {\n    mapping: IFeatureMapping\n    percentAtom: RecoilState<number>\n    apply: (wf: WorldFeature, percent: number, value: number) => void,\n}): JSX.Element {\n    const {name, nuanceToPercent, percentToNuance, percentToValue} = mapping\n    const sliderValue = (p: number) => [Math.floor(percentToNuance(p) * MAX_SLIDER)]\n    const [percent, setPercent] = useRecoilState(percentAtom)\n    const [values, setValues] = useState(sliderValue(percent))\n\n    useEffect(() => {\n        setPercent(Math.round(nuanceToPercent(values[0] / MAX_SLIDER)))\n    }, [values])\n    useEffect(() => apply(mapping.feature, percent, percentToValue(percent)), [percent])\n    useEffect(() => {\n        setValues(sliderValue(percent))\n    }, [mapping, percent])\n\n    return (\n        <div className=\"slider\">\n            <div className=\"float-right mr-4\">\n                <FaBalanceScale onClick={() => setValues(sliderValue(100))}/>\n            </div>\n            <div className=\"ml-2 small my-1\">\n                {name} = {percentString(percent)} ({floatString(percentToValue(percent))})\n            </div>\n            <Slider\n                mode={1} step={1} domain={domain} rootStyle={sliderStyle}\n                values={values}\n                onChange={(newValues: number[]) => setValues(newValues)}\n            >\n                <Rail>\n                    {({getRailProps}) => <div className=\"slider-rail\" {...getRailProps()}/>}\n                </Rail>\n                <Handles>\n                    {({handles, getHandleProps}) => (\n                        <div className=\"slider-handles\">\n                            {handles.map((handle, index) => (\n                                <Handle key={handle.id} handle={handle} getHandleProps={getHandleProps}/>\n                            ))}\n                        </div>\n                    )}\n                </Handles>\n                <Tracks right={false}>\n                    {({tracks, getTrackProps}) => (\n                        <div className=\"slider-tracks\">\n                            {tracks.map(({id, source, target}, index) => (\n                                <Track key={id} source={source} target={target} getTrackProps={getTrackProps}/>\n                            ))}\n                        </div>\n                    )}\n                </Tracks>\n            </Slider>\n        </div>\n    )\n}\n\nfunction Handle({handle, getHandleProps}: {\n    handle: SliderItem,\n    getHandleProps: GetHandleProps,\n}): JSX.Element {\n    const min = domain[0]\n    const max = domain[1]\n    const {id, value, percent} = handle\n    return (\n        <div\n            role=\"slider\"\n            className=\"slider-handle\"\n            style={{left: `${percent}%`}}\n            aria-valuemin={min} aria-valuemax={max} aria-valuenow={value}\n            {...getHandleProps(id)}\n        />\n    )\n}\n\nfunction Track({source, target, getTrackProps}: {\n    source: SliderItem,\n    target: SliderItem,\n    getTrackProps: GetTrackProps,\n}): JSX.Element {\n    return (\n        <div className=\"slider-track\"\n             style={{left: `${source.percent}%`, width: `${target.percent - source.percent}%`}}\n             {...getTrackProps()}\n        />\n    )\n}\n\nconst sliderStyle: React.CSSProperties = {\n    margin: \"1%\",\n    position: \"relative\",\n    width: \"98%\",\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useState } from \"react\"\nimport { ButtonDropdown, DropdownItem, DropdownMenu, DropdownToggle } from \"reactstrap\"\nimport { useRecoilState } from \"recoil\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { currentFeature, FEATURE_VALUES } from \"../storage/recoil\"\n\nimport { FeatureSlider } from \"./feature-slider\"\n\nexport function BottomMiddle({tensegrity}: {\n    tensegrity: Tensegrity,\n}): JSX.Element {\n    const [open, setOpen] = useState(false)\n    const [worldFeature, setWorldFeature] = useRecoilState(currentFeature)\n    const [featureValue, setFeatureValue] = useState(FEATURE_VALUES[worldFeature])\n    return (\n        <div className=\"w-100 d-flex\">\n            <ButtonDropdown isOpen={open} toggle={() => setOpen(!open)}>\n                <DropdownToggle>Choose</DropdownToggle>\n                <DropdownMenu>{\n                    FEATURE_VALUES\n                        .filter(value => !value.mapping.name.startsWith(\"-\"))\n                        .map((value) => (\n                            <DropdownItem key={`fitem-${value.mapping.feature}`} onClick={() => {\n                                setWorldFeature(value.mapping.feature)\n                                setFeatureValue(value)\n                            }}>\n                                {value.mapping.name}\n                            </DropdownItem>\n                        ))\n                }</DropdownMenu>\n            </ButtonDropdown>\n            <FeatureSlider\n                mapping={featureValue.mapping}\n                percentAtom={featureValue.percentAtom}\n                apply={(feature, percent, value) => {\n                    tensegrity.instance.applyFeature({feature, percent, value}, false)\n                }}\n            />\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { OrbitControls, Stars } from \"@react-three/drei\"\nimport { useFrame } from \"@react-three/fiber\"\nimport { Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { useRecoilState } from \"recoil\"\nimport { Color, Vector3 } from \"three\"\n\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { IIntervalDetails } from \"../fabric/tensegrity-types\"\nimport { rotatingAtom, selectedTwistAtom, ViewMode, viewModeAtom } from \"../storage/recoil\"\n\nimport { LiveView } from \"./live-view\"\nimport { LookView } from \"./look-view\"\nimport { SelectView } from \"./select-view\"\nimport { SurfaceComponent } from \"./surface-component\"\n\nconst AMBIENT_COLOR = new Color(\"#ffffff\")\nconst TOWARDS_TARGET = 0.01\nconst TOWARDS_POSITION = 0.01\n\nexport function FabricView({tensegrity, clickDetails}: {\n    tensegrity: Tensegrity,\n    clickDetails: (details: IIntervalDetails) => void,\n}): JSX.Element {\n\n    const [viewMode] = useRecoilState(viewModeAtom)\n    const [rotating] = useRecoilState(rotatingAtom)\n    const [selected] = useRecoilState(selectedTwistAtom)\n\n    const [aim, updateAim] = useState(new Vector3(0, 1, 0))\n    const [stage, updateStage] = useState(tensegrity.stage$.getValue())\n\n    useEffect(() => {\n        const sub = tensegrity.stage$.subscribe(updateStage)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    useFrame(state => {\n        if (viewMode === ViewMode.Time) {\n            tensegrity.iterate()\n        }\n        const midpoint = selected ? tensegrity.instance.twistLocation(selected) : tensegrity.instance.midpoint\n        updateAim(new Vector3().subVectors(midpoint, aim).multiplyScalar(TOWARDS_TARGET).add(aim))\n        if (stage === Stage.Growing) {\n            state.camera.position.y += (midpoint.y - state.camera.position.y) * TOWARDS_POSITION\n            const distanceChange = state.camera.position.distanceTo(midpoint) - tensegrity.instance.view.radius() * 2.5\n            const towardsDistance = new Vector3().subVectors(midpoint, state.camera.position).normalize().multiplyScalar(distanceChange * TOWARDS_POSITION)\n            state.camera.position.add(towardsDistance)\n        } else {\n            if (state.camera.position.y < 0) {\n                state.camera.position.y -= state.camera.position.y * TOWARDS_POSITION * 20\n            }\n        }\n    })\n    return (\n        <group>\n            <OrbitControls target={aim} autoRotate={rotating} enablePan={false} maxDistance={200}\n                           enableDamping={false} minPolarAngle={Math.PI * 0.1} maxPolarAngle={Math.PI * 0.8}\n                           zoomSpeed={0.5}\n            />\n            <scene>\n                {viewMode === ViewMode.Time ? (<LiveView tensegrity={tensegrity}/>) :\n                    viewMode === ViewMode.Select ? (<SelectView tensegrity={tensegrity} clickDetails={clickDetails}/>) :\n                        (<LookView tensegrity={tensegrity}/>)\n                }\n                <SurfaceComponent/>\n                <Stars radius={300}/>\n                <ambientLight color={AMBIENT_COLOR} intensity={0.8}/>\n                <directionalLight color={new Color(\"#FFFFFF\")} intensity={2}/>\n            </scene>\n        </group>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport { FaBug, FaSeedling } from \"react-icons/all\"\nimport { Button, ButtonGroup, Input } from \"reactstrap\"\nimport { useRecoilState } from \"recoil\"\n\nimport { compileTenscript, RunTenscript } from \"../fabric/tenscript\"\nimport { postGrowthAtom, tenscriptAtom } from \"../storage/recoil\"\n\nexport function ScriptPanel({runTenscript}: { runTenscript: RunTenscript }): JSX.Element {\n    const [tenscript, setTenscript] = useRecoilState(tenscriptAtom)\n    const [postGrowth] = useRecoilState(postGrowthAtom)\n    const [json, setJson] = useState<string>(\"\")\n    const [error, setError] = useState(\"\")\n    const toJson = () => JSON.stringify(tenscript, undefined, 2)\n\n    function parse(): void {\n        try {\n            const newTenscript = JSON.parse(json)\n            if (compileTenscript(newTenscript, setError)) {\n                setError(\"\")\n                newTenscript.postGrowthOp = postGrowth\n                setTenscript(newTenscript)\n                runTenscript(newTenscript, setError)\n            }\n        } catch (e) {\n            setError(e.toString())\n        }\n    }\n\n    useEffect(() => {\n        if (tenscript) {\n            setJson(toJson())\n        } else {\n            setJson(\"\")\n        }\n    }, [tenscript])\n\n    return (\n        <div id=\"tenscript-panel\" style={{\n            flexDirection: \"column\",\n            position: \"relative\",\n            backgroundColor: \"rgba(0,0,0,1)\",\n            height: \"100%\",\n        }}>\n            <div>\n                <h6 className=\"w-100 text-center\"><FaSeedling/> Tenscript</h6>\n                <div id=\"code-and-run\" style={{flexDirection: \"column\", height: \"available\"}}>\n                    <Input\n                        style={{borderRadius: \"1em\", height: \"22em\", marginBottom: \"0.5em\"}}\n                        type=\"textarea\" id=\"tenscript\"\n                        value={json}\n                        onChange={changeEvent => setJson(changeEvent.target.value)}\n                    />\n                    <ButtonGroup vertical={true} className=\"w-100 my-2\">\n                        {error.length === 0 ? undefined : (\n                            <Button className=\"my-2\" color=\"warning\" onClick={() => {\n                                setJson(toJson())\n                                setError(\"\")\n                            }}>\n                                <FaBug/><hr/>{error}\n                            </Button>\n                        )}\n                        <Button color=\"success\" onClick={() => parse()}>\n                            Try it out!\n                        </Button>\n                    </ButtonGroup>\n                </div>\n            </div>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Stage } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\nimport {\n    FaArrowRight,\n    FaCamera,\n    FaChartBar,\n    FaClock,\n    FaHandSpock,\n    FaSeedling,\n    FaSlidersH,\n    FaYinYang,\n} from \"react-icons/all\"\nimport { Button } from \"reactstrap\"\n\nimport { Tensegrity, ToDo } from \"../fabric/tensegrity\"\n\nexport enum StageTransition {\n    CaptureLengthsToSlack,\n    SlackToPretensing,\n    CapturePretenstToSlack,\n    CaptureStrainForStiffness,\n}\n\nexport const STAGE_TRANSITIONS = Object.keys(StageTransition)\n    .filter(k => isNaN(parseInt(k, 10)))\n    .map(k => StageTransition[k])\n\nexport function StageButton({tensegrity, stageTransition, disabled}: {\n    tensegrity: Tensegrity,\n    stageTransition: StageTransition,\n    disabled: boolean,\n}): JSX.Element {\n\n    const [stage, updateStage] = useState(tensegrity.stage)\n    useEffect(() => {\n        const sub = tensegrity.stage$.subscribe(updateStage)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n\n    function allDisabledExcept(stageAccepted: Stage): boolean {\n        if (disabled || stage === Stage.Pretensing) {\n            return true\n        }\n        return stage !== stageAccepted\n    }\n\n    function doNow(todo: ToDo): void {\n        tensegrity.toDo = {todo}\n    }\n\n    switch (stageTransition) {\n        case StageTransition.CaptureLengthsToSlack:\n            return (\n                <Button\n                    disabled={allDisabledExcept(Stage.Shaping)}\n                    onClick={() => doNow(t => t.stage = Stage.Slack)}\n                >\n                    <FaCamera/><FaArrowRight/><Symbol stage={Stage.Slack}/>\n                </Button>\n            )\n        case StageTransition.SlackToPretensing:\n            return (\n                <Button\n                    disabled={allDisabledExcept(Stage.Slack)}\n                    onClick={() => doNow(t => t.stage = Stage.Pretensing)}\n                >\n                    <Symbol stage={Stage.Slack}/><FaArrowRight/><Symbol stage={Stage.Pretenst}/>\n                </Button>\n            )\n        case StageTransition.CapturePretenstToSlack:\n            return (\n                <Button\n                    disabled={allDisabledExcept(Stage.Pretenst)}\n                    onClick={() => doNow(t => t.stage = Stage.Slack)}\n                >\n                    <Symbol stage={Stage.Pretenst}/><FaArrowRight/><Symbol stage={Stage.Slack}/>\n                </Button>\n            )\n        case StageTransition.CaptureStrainForStiffness:\n            return (\n                <Button\n                    disabled={allDisabledExcept(Stage.Pretenst)}\n                    onClick={() => doNow(t => {\n                        t.stage = Stage.Slack\n                        t.strainToStiffness()\n                    })}\n                >\n                    <Symbol stage={Stage.Pretenst}/><FaArrowRight/><Symbol stage={Stage.Slack}/><FaChartBar/>\n                </Button>\n            )\n    }\n}\n\nfunction Symbol({stage}: { stage: Stage }): JSX.Element {\n    switch (stage) {\n        case Stage.Growing:\n            return <FaSeedling/>\n        case Stage.Shaping:\n            return <FaSlidersH/>\n        case Stage.Slack:\n            return <FaYinYang/>\n        case Stage.Pretensing:\n            return <FaClock/>\n        case Stage.Pretenst:\n            return <FaHandSpock/>\n        default:\n            throw new Error(\"Stage?\")\n    }\n}\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useState } from \"react\"\nimport { FaEye, FaHiking } from \"react-icons/all\"\nimport { Button, ButtonDropdown, ButtonGroup, DropdownItem, DropdownMenu, DropdownToggle } from \"reactstrap\"\nimport { useRecoilState, useSetRecoilState } from \"recoil\"\n\nimport { BOOTSTRAP } from \"../fabric/bootstrap\"\nimport { ITenscript, RunTenscript } from \"../fabric/tenscript\"\nimport { PostGrowthOp, Tensegrity } from \"../fabric/tensegrity\"\nimport { bootstrapIndexAtom, postGrowthAtom, tenscriptAtom, ViewMode, viewModeAtom } from \"../storage/recoil\"\n\nimport { ScriptPanel } from \"./script-panel\"\nimport { StageButton, STAGE_TRANSITIONS } from \"./stage-button\"\n\nexport function TopLeft({tensegrity, runTenscript}: {\n    tensegrity: Tensegrity,\n    runTenscript: RunTenscript,\n}): JSX.Element {\n\n    const [viewMode] = useRecoilState(viewModeAtom)\n    const setBootstrapIndex = useSetRecoilState(bootstrapIndexAtom)\n    const [tenscript, setTenscript] = useRecoilState(tenscriptAtom)\n    const [postGrowth, setPostGrowth] = useRecoilState(postGrowthAtom)\n\n    const [showScriptPanel, setShowScriptPanel] = useState(false)\n    const [bootstrapOpen, setBootstrapOpen] = useState(false)\n\n    const run = (pgo: PostGrowthOp) => {\n        if (!tenscript) {\n            return\n        }\n        setPostGrowth(pgo)\n        if (tenscript.postGrowthOp === pgo) {\n            runTenscript(tenscript, error => console.error(error))\n        } else {\n            const opChanged: ITenscript = {...tenscript, postGrowthOp: pgo}\n            setTenscript(opChanged)\n            runTenscript(opChanged, error => console.error(error))\n        }\n    }\n\n    const opColor = (pgo: PostGrowthOp) => postGrowth === pgo ? \"success\" : \"secondary\"\n\n    return (\n        <>\n            <ButtonGroup>{STAGE_TRANSITIONS\n                .map(stageTransition => (\n                    <StageButton\n                        key={`strans-${stageTransition}`}\n                        tensegrity={tensegrity}\n                        stageTransition={stageTransition}\n                        disabled={viewMode === ViewMode.Look}/>\n                ))\n            }</ButtonGroup>\n            <br/>\n            <ButtonGroup className=\"my-1\">\n                <Button onClick={() => run(PostGrowthOp.NoOp)} color={opColor(PostGrowthOp.NoOp)}>0</Button>\n                <Button onClick={() => run(PostGrowthOp.Faces)} color={opColor(PostGrowthOp.Faces)}>&#9653;</Button>\n                <Button onClick={() => run(PostGrowthOp.Snelson)} color={opColor(PostGrowthOp.Snelson)}>S&#9653;</Button>\n                <Button onClick={() => run(PostGrowthOp.Bowtie)} color={opColor(PostGrowthOp.Bowtie)}>&#8904;</Button>\n                <Button onClick={() => run(PostGrowthOp.BowtieFaces)} color={opColor(PostGrowthOp.BowtieFaces)}>&#8904; <strong>&#9653;</strong></Button>\n            </ButtonGroup>\n            <br/>\n            <ButtonGroup>\n                <ButtonDropdown\n                    isOpen={bootstrapOpen}\n                    toggle={() => setBootstrapOpen(!bootstrapOpen)}\n                >\n                    <DropdownToggle><FaHiking/></DropdownToggle>\n                    <DropdownMenu>{BOOTSTRAP.map((bootstrapProgram, index) => (\n                        <DropdownItem key={`Boot${index}`} onClick={() => {\n                            setBootstrapIndex(index)\n                            runTenscript(bootstrapProgram, () => console.error(\"impossible\"))\n                        }}>\n                            {bootstrapProgram.name}\n                        </DropdownItem>\n                    ))}</DropdownMenu>\n                </ButtonDropdown>\n                <Button\n                    color={showScriptPanel ? \"warning\" : \"secondary\"}\n                    onClick={() => setShowScriptPanel(!showScriptPanel)}>\n                    <FaEye/>\n                </Button>\n            </ButtonGroup>\n            {!showScriptPanel ? undefined : <ScriptPanel runTenscript={runTenscript}/>}\n        </>\n    )\n}\n\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport * as React from \"react\"\nimport { useEffect, useState } from \"react\"\n\nimport { stageName } from \"../fabric/eig-util\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\n\nexport function TopMiddle({tensegrity}: { tensegrity: Tensegrity }): JSX.Element {\n    const [stage, updateStage] = useState(tensegrity.stage$.getValue())\n    useEffect(() => {\n        const sub = tensegrity.stage$.subscribe(updateStage)\n        return () => sub.unsubscribe()\n    }, [tensegrity])\n    return (\n        <div>\n            <span>{stageName(stage)}</span> <i>\"{tensegrity.name}\"</i>\n        </div>\n    )\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { Canvas } from \"@react-three/fiber\"\nimport { default_world_feature, WorldFeature } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect, useMemo, useState } from \"react\"\nimport { FaPlay } from \"react-icons/all\"\nimport { useRecoilBridgeAcrossReactRoots_UNSTABLE, useRecoilState, useSetRecoilState } from \"recoil\"\nimport { Vector3 } from \"three\"\n\nimport { BOOTSTRAP } from \"../fabric/bootstrap\"\nimport { WORLD_FEATURES } from \"../fabric/eig-util\"\nimport { CreateInstance } from \"../fabric/fabric-instance\"\nimport { compileTenscript, ITenscript, RunTenscript, TenscriptBuilder } from \"../fabric/tenscript\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { adjacentPullsFromTwist } from \"../fabric/twist-logic\"\nimport {\n    bootstrapIndexAtom,\n    FEATURE_VALUES,\n    postGrowthAtom,\n    selectedTwistAtom,\n    STORAGE_KEY,\n    tenscriptAtom,\n    ViewMode,\n    viewModeAtom,\n    visibleDetailsAtom,\n} from \"../storage/recoil\"\n\nimport { BottomLeft } from \"./bottom-left\"\nimport { BottomMiddle } from \"./bottom-middle\"\nimport { BottomRight } from \"./bottom-right\"\nimport { FabricView } from \"./fabric-view\"\nimport { featureMapping } from \"./feature-mapping\"\nimport { TopLeft } from \"./top-left\"\nimport { TopMiddle } from \"./top-middle\"\n\nexport function DesignView({createInstance}: { createInstance: CreateInstance }): JSX.Element {\n\n    const mainInstance = useMemo(() => createInstance({}), [])\n    const worldFeatures = FEATURE_VALUES.map(({percentAtom}) => useRecoilState(percentAtom))\n    const [tenscript, setTenscript] = useRecoilState(tenscriptAtom)\n    const [bootstrapIndex] = useRecoilState(bootstrapIndexAtom)\n    const setPostGrowth = useSetRecoilState(postGrowthAtom)\n    const [viewMode, setViewMode] = useRecoilState(viewModeAtom)\n\n    const [tensegrity, setTensegrity] = useState<Tensegrity | undefined>()\n    const [selected, setSelected] = useRecoilState(selectedTwistAtom)\n    const [details, setDetails] = useRecoilState(visibleDetailsAtom)\n    useEffect(() => {\n        if (tensegrity) {\n            if (selected) {\n                setDetails(selected.pushes.map(push => tensegrity.getIntervalDetails(push)))\n            } else {\n                setDetails([])\n            }\n        }\n    }, [selected])\n    const emergency = (message: string) => console.error(\"tensegrity view\", message)\n\n    const runTenscript: RunTenscript = (ts: ITenscript, error: (message: string) => void) => {\n        try {\n            const tree = compileTenscript(ts, error)\n            if (!tree) {\n                return false\n            }\n            setViewMode(ViewMode.Time)\n            setSelected(undefined)\n            const featureValues = ts.featureValues\n            const intervalCountdown = featureValues ? featureValues[WorldFeature.IntervalCountdown] : undefined\n            const countdown = intervalCountdown === undefined ? default_world_feature(WorldFeature.IntervalCountdown) : intervalCountdown\n            setTenscript(ts)\n            WORLD_FEATURES.map(key => {\n                const feature = WorldFeature[key]\n                const {percentToValue} = featureMapping(feature)\n                const percent = featureValues ? featureValues[key] : undefined\n                if (percent !== undefined) {\n                    worldFeatures[feature][1](percent)\n                    mainInstance.applyFeature({feature, percent, value: percentToValue(percent)}, true)\n                }\n            })\n            setPostGrowth(ts.postGrowthOp)\n            const builder = new TenscriptBuilder(new Vector3(), ts, tree)\n            setTensegrity(new Tensegrity(mainInstance, countdown, builder))\n        } catch (e) {\n            console.log(\"Problem running\", e)\n            return runTenscript(BOOTSTRAP[bootstrapIndex], emergency)\n        }\n        return true\n    }\n\n    useEffect(() => {\n        Object.keys(localStorage).filter(k => k !== STORAGE_KEY).forEach(k => localStorage.removeItem(k))\n        if (tenscript) {\n            runTenscript(tenscript, emergency)\n        } else {\n            runTenscript(BOOTSTRAP[bootstrapIndex], emergency)\n        }\n    }, [])\n\n    const RecoilBridge = useRecoilBridgeAcrossReactRoots_UNSTABLE()\n    return (\n        <div>\n            <div style={{\n                position: \"absolute\",\n                left: 0,\n                right: 0,\n                height: \"100%\",\n            }}>\n                {!tensegrity ? (\n                    <div className=\"h-100\">\n                        <div style={{position: \"relative\", top: \"50%\", left: \"50%\"}}>\n                            <h1><FaPlay/></h1>\n                        </div>\n                    </div>\n                ) : (\n                    <div className=\"h-100\">\n                        <Canvas\n                            style={{\n                                backgroundColor: \"black\",\n                                borderStyle: \"solid\",\n                                borderColor: viewMode !== ViewMode.Time ? \"#f0ad4e\" : \"black\",\n                                cursor: viewMode === ViewMode.Select ? \"pointer\" : \"default\",\n                                borderWidth: \"2px\",\n                            }}\n                        >\n                            <RecoilBridge>\n                                <FabricView\n                                    tensegrity={tensegrity}\n                                    clickDetails={({interval}) => {\n                                        if (!selected || !tensegrity) {\n                                            return\n                                        }\n                                        if (details.length === 1) { // one pull, presumably\n                                            setDetails(adjacentPullsFromTwist(tensegrity, selected).map(pull => tensegrity.getIntervalDetails(pull)))\n                                        } else {\n                                            if (interval.role.push) {\n                                                setDetails(adjacentPullsFromTwist(tensegrity, selected).map(pull => tensegrity.getIntervalDetails(pull)))\n                                            } else {\n                                                setDetails(details.filter(d => d.interval.index === interval.index))\n                                            }\n                                        }\n                                    }}\n                                />\n                            </RecoilBridge>\n                        </Canvas>\n                        <div id=\"top-left\">\n                            <TopLeft tensegrity={tensegrity} runTenscript={runTenscript}/>\n                        </div>\n                        <div id=\"bottom-left\">\n                            <BottomLeft/>\n                        </div>\n                        <div id=\"bottom-middle\" style={{width: \"60%\"}}>\n                            <BottomMiddle tensegrity={tensegrity}/>\n                        </div>\n                        <div id=\"top-middle\">\n                            <TopMiddle tensegrity={tensegrity}/>\n                        </div>\n                        <div id=\"bottom-right\">\n                            <BottomRight tensegrity={tensegrity}/>\n                        </div>\n                    </div>\n                )}\n            </div>\n        </div>\n    )\n}\n\n","/*\n * Copyright (c) 2021. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\n\nimport { WorldFeature } from \"eig\"\nimport * as React from \"react\"\nimport { useEffect } from \"react\"\nimport { Button, ButtonGroup } from \"reactstrap\"\nimport { useRecoilState } from \"recoil\"\nimport { Vector3 } from \"three\"\n\nimport { ConstructionView } from \"../construction/construction-view\"\nimport { EvoView } from \"../evo/evo-view\"\nimport { BOOTSTRAP, CONSTRUCTIONS } from \"../fabric/bootstrap\"\nimport { GlobalMode, globalModeFromUrl, nameToUrl, reloadGlobalMode } from \"../fabric/eig-util\"\nimport { CreateInstance } from \"../fabric/fabric-instance\"\nimport { Tensegrity } from \"../fabric/tensegrity\"\nimport { KleinBuilder } from \"../mobius/klein-builder\"\nimport { KleinView } from \"../mobius/klein-view\"\nimport { MobiusBuilder } from \"../mobius/mobius-builder\"\nimport { MobiusView } from \"../mobius/mobius-view\"\nimport { SphereBuilder } from \"../sphere/sphere-builder\"\nimport { SphereView, SPHERE_RADIUS } from \"../sphere/sphere-view\"\nimport { globalModeAtom } from \"../storage/recoil\"\n\nimport { DesignView } from \"./design-view\"\n\nexport function MainView({createInstance}: { createInstance: CreateInstance }): JSX.Element {\n\n    const [globalMode] = useRecoilState(globalModeAtom)\n    useEffect(() => {\n        const {mode, param} = globalModeFromUrl()\n        if (mode !== globalMode.mode) {\n            reloadGlobalMode(mode, param)\n        }\n    }, [])\n\n    function visit(url: string): void {\n        window.open(url, \"_blank\")\n    }\n\n    switch (globalMode.mode) {\n        case GlobalMode.Design:\n            return <DesignView createInstance={createInstance}/>\n        case GlobalMode.Construction:\n            const tenscript = CONSTRUCTIONS.find(({name}) => nameToUrl(name) === globalMode.param)\n            if (tenscript) {\n                return <ConstructionView tenscript={tenscript} createInstance={createInstance}/>\n            } else {\n                reloadGlobalMode(GlobalMode.Choice)\n                return <div/>\n            }\n        case GlobalMode.Evolution:\n            return (\n                <EvoView createBodyInstance={createInstance}/>\n            )\n        case GlobalMode.Sphere:\n            return (\n                <SphereView\n                    frequencyParam={globalMode.param}\n                    createSphere={(frequency: number, gravity: number, useCurves: boolean) => {\n                        const g = () => {\n                            switch (gravity) {\n                                case 0:\n                                    return 0\n                                case 1:\n                                    return 25\n                                default:\n                                    return 1500\n                            }\n                        }\n                        const instance = createInstance({\n                            [WorldFeature.IterationsPerFrame]: 200,\n                            [WorldFeature.Gravity]: g(),\n                            [WorldFeature.ShapingStiffnessFactor]: 600,\n                            [WorldFeature.ShapingDrag]: 300,\n                            [WorldFeature.Drag]: 0,\n                            [WorldFeature.VisualStrain]: 0,\n                            [WorldFeature.StiffnessFactor]: 800,\n                        })\n                        const builder = new SphereBuilder(new Vector3(0, 60, 0), frequency, SPHERE_RADIUS, useCurves)\n                        return new Tensegrity(instance, 100, builder)\n                    }}\n                />\n            )\n        case GlobalMode.Mobius:\n            return (\n                <MobiusView createMobius={(segments: number) => {\n                    const instance = createInstance({\n                        [WorldFeature.IterationsPerFrame]: 1000,\n                        [WorldFeature.Gravity]: 0,\n                        [WorldFeature.ShapingDrag]: 10,\n                        [WorldFeature.ShapingStiffnessFactor]: 1000,\n                        [WorldFeature.VisualStrain]: 0,\n                    })\n                    const builder = new MobiusBuilder(segments)\n                    return new Tensegrity(instance, 100, builder)\n                }}/>\n            )\n        case GlobalMode.Klein:\n            return (\n                <KleinView createKlein={(width: number, height: number, shift: number)=> {\n                    const instance = createInstance({\n                        [WorldFeature.IterationsPerFrame]: 100,\n                        [WorldFeature.Gravity]: 0,\n                        [WorldFeature.ShapingDrag]: 10,\n                        [WorldFeature.ShapingStiffnessFactor]: 5000,\n                        [WorldFeature.VisualStrain]: 0,\n                    })\n                    instance.world.set_push_and_pull(true)\n                    const builder = new KleinBuilder(width, height, shift)\n                    return new Tensegrity(instance, 10, builder)\n                }}/>\n            )\n        default:\n            return (\n                <div id=\"choice-menu\">\n                    <h1>Pretenst App</h1>\n                    <div className=\"d-inline-flex\">\n                        <div className=\"choice-menu-box\">\n                            <h4>Projects</h4>\n                            <ButtonGroup className=\"choice-menu-group\" vertical={true}>\n                                {BOOTSTRAP.map(({scale, name}) => {\n                                    if (scale === undefined) {\n                                        return undefined\n                                    }\n                                    return (\n                                        <Button size=\"lg\" color=\"info\" key={name}\n                                                onClick={() => reloadGlobalMode(GlobalMode.Construction, nameToUrl(name))}\n                                        >\n                                            \"{name}\"\n                                        </Button>\n                                    )\n                                })}\n                            </ButtonGroup>\n                        </div>\n                        <div className=\"choice-menu-box\">\n                            <h4>Modes</h4>\n                            <ButtonGroup className=\"choice-menu-group\" vertical={true}>\n                                <Button size=\"lg\" color=\"info\" onClick={() => reloadGlobalMode(GlobalMode.Klein)}>\n                                    Klein\n                                </Button>\n                                <Button size=\"lg\" color=\"info\" onClick={() => reloadGlobalMode(GlobalMode.Mobius)}>\n                                    Möbius\n                                </Button>\n                                <Button size=\"lg\" color=\"info\" onClick={() => reloadGlobalMode(GlobalMode.Sphere)}>\n                                    Sphere\n                                </Button>\n                                <Button size=\"lg\" color=\"info\" onClick={() => reloadGlobalMode(GlobalMode.Design)}>\n                                    Design\n                                </Button>\n                                <Button size=\"lg\" color=\"info\" onClick={() => reloadGlobalMode(GlobalMode.Evolution)}>\n                                    Evolution\n                                </Button>\n                            </ButtonGroup>\n                        </div>\n                        <div className=\"choice-menu-box\">\n                            <h4>Background</h4>\n                            <ButtonGroup className=\"choice-menu-group\" vertical={true}>\n                                <Button size=\"lg\" color=\"info\" onClick={() => visit(\"https://pretenst.com/\")}>\n                                    Construction Stories\n                                </Button>\n                                <Button size=\"lg\" color=\"info\"\n                                        onClick={() => visit(\"https://github.com/elastic-interval/pretenst\")}>\n                                    Virtual Design Software\n                                </Button>\n                            </ButtonGroup>\n                        </div>\n                    </div>\n                </div>\n            )\n    }\n}\n","/*\n * Copyright (c) 2019. Beautiful Code BV, Rotterdam, Netherlands\n * Licensed under GNU GENERAL PUBLIC LICENSE Version 3.\n */\nimport { WorldFeature } from \"eig\"\nimport * as React from \"react\"\nimport * as ReactDOM from \"react-dom\"\nimport { RecoilRoot } from \"recoil\"\n\nimport { FabricInstance } from \"./fabric/fabric-instance\"\nimport registerServiceWorker from \"./service-worker\"\nimport { MainView } from \"./view/main-view\"\n\nfunction render(element: JSX.Element): void {\n    const root = document.getElementById(\"root\") as HTMLElement\n    ReactDOM.render(element, root)\n}\n\nexport async function startReact(\n    eig: typeof import(\"eig\"),\n    world: typeof import(\"eig\").World,\n): Promise<void> {\n    render(\n        <RecoilRoot>\n            <MainView createInstance={(\n                featureValues: Record<WorldFeature, number>,\n                // eslint-disable-next-line @typescript-eslint/ban-types\n                fabric?: object,\n            ) => new FabricInstance(\n                    eig,\n                    featureValues,\n                    2000, // TODO\n                    world,\n                    fabric,\n                )}/>\n        </RecoilRoot>,\n    )\n    registerServiceWorker()\n}\n"],"sourceRoot":""}