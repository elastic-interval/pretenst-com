(window.webpackJsonppretenst=window.webpackJsonppretenst||[]).push([[4],{5:function(e,t,n){"use strict";n.r(t);var r=n(6),a=n(23),s=n(8),i=n(7),o=n(4);let c;function l(e,t,n,r,a){return{feature:e,name:t,featureStage:n,nuanceToPercent:e=>r*(1-e)+a*e,percentToNuance:e=>(e-r)/(a-r),percentToValue:t=>Object(o.default_world_feature)(e)*t/100,valueToPercent:t=>t/Object(o.default_world_feature)(e)*100}}function u(e){switch(e){case o.WorldFeature.Gravity:return l(e,"Gravity",c.Postslack,0,1e3);case o.WorldFeature.Antigravity:return l(e,"-Antigravity",c.All,5,500);case o.WorldFeature.ShapingDrag:return l(e,"Shaping Drag",c.Preslack,0,500);case o.WorldFeature.ShapingStiffnessFactor:return l(e,"Shaping Stiffness",c.Preslack,10,1e3);case o.WorldFeature.Drag:return l(e,"Drag",c.Postslack,0,1e3);case o.WorldFeature.ShapingPretenstFactor:return l(e,"Shaping Pretenst",c.Preslack,0,1e3);case o.WorldFeature.PretenstFactor:return l(e,"Pretenst Factor",c.Postslack,0,500);case o.WorldFeature.StiffnessFactor:return l(e,"Stiffness",c.Postslack,1,300);case o.WorldFeature.IterationsPerFrame:return l(e,"Iterations/frame",c.All,2,500);case o.WorldFeature.IntervalCountdown:return l(e,"-Interval Countdown",c.Preslack,10,1e3);case o.WorldFeature.PretensingCountdown:return l(e,"-Pretenst countdown",c.All,50,200);case o.WorldFeature.VisualStrain:return l(e,"Visual strain",c.All,0,300);case o.WorldFeature.PushOverPull:return l(e,"Push/Pull",c.All,10,700);default:throw new Error("Feature?")}}!function(e){e[e.Preslack=0]="Preslack",e[e.Postslack=1]="Postslack",e[e.All=2]="All"}(c||(c={}));const h=new i.Vector3(1,0,0),d=(new i.Vector3(0,0,1),new i.Vector3(0,1,0)),m=new i.Vector3(0,-1,0);let f;!function(e){e[e.PushA=0]="PushA",e[e.PushB=1]="PushB",e[e.PushC=2]="PushC",e[e.PullA=3]="PullA",e[e.PullB=4]="PullB",e[e.PullAA=5]="PullAA",e[e.PullBB=6]="PullBB",e[e.Conflict=7]="Conflict",e[e.Radial=8]="Radial",e[e.Connector=9]="Connector",e[e.ShapingDistancer=10]="ShapingDistancer",e[e.PretenstDistancer=11]="PretenstDistancer"}(f||(f={}));Object.keys(f).filter(e=>isNaN(parseInt(e,10))).map(e=>f[e]);function g(e){switch(e){case f.PushA:return 2.44948974278;case f.PushB:return 2.8025170768881464;case f.PushC:case f.PullA:return 1;case f.PullB:return 1.732050807568877;case f.PullAA:return.5*g(f.PullA);case f.PullBB:return.5*g(f.PullB);case f.Conflict:return.01;default:throw new Error("Length for Role ".concat(f[e],"?"))}}const p=Object.keys(o.WorldFeature);function w(e){switch(e){case f.PushA:return"[A]";case f.PushB:return"[B]";case f.PullA:return"(a)";case f.PullB:return"(b)";case f.PullAA:return"(aa)";case f.PullBB:return"(bb)";default:return"?"}}const b=Object.keys(f).filter(e=>{switch(f[e]){case f.PushA:case f.PushB:case f.PullA:case f.PullB:case f.PullAA:case f.PullBB:return!0;default:return!1}}).map(e=>f[e]);function y(e){switch(e){case f.PushA:case f.PushB:case f.PushC:return!0}return!1}function E(e){switch(e){case o.Stage.Growing:return"Growing";case o.Stage.Shaping:return"Shaping";case o.Stage.Slack:return"Slack";case o.Stage.Pretensing:return"Pretensing";default:return"Pretenst"}}let v;!function(e){e.Choice="choice",e.Design="design",e.Sphere="sphere",e.Construction="construction",e.Evolution="evolution"}(v||(v={}));const S=Object.keys(v).map(e=>v[e]);function x(e){return e.replace(/ /g,"-")}function k(){const e=location.hash.substring(1).split(";"),t=S.find(t=>t===e[0]);if(t){return{mode:t,param:e.length>1?e[1]:""}}return j(v.Choice)}function j(e,t){return location.hash=t&&t.length>0?"".concat(e,";").concat(t):e,location.reload(),{mode:e,param:t}}function C(e){const t=e.toExponential(3),n=t.indexOf("e+0");if(n>0)return t.substring(0,n);if(Math.max(t.indexOf("e-1"),t.indexOf("e-2"))>0)return e.toFixed(3);return Math.max(t.indexOf("e+1"),t.indexOf("e+2"),t.indexOf("e+3"))>0?e.toFixed(1):t}function O(e,t){return(new i.Vector3).subVectors(e,t).normalize()}function A(e){const t=new i.Vector3;return e.forEach(e=>t.add(e)),t.multiplyScalar(1/e.length)}function P(e){const t=A(e),n=e.map(e=>(new i.Vector3).copy(e).sub(t)),r=new i.Vector3;for(let a=0;a<n.length;a++){const e=n[a],t=n[(a+1)%n.length];r.add((new i.Vector3).crossVectors(e,t).normalize())}return r.normalize()}function F(e,t,n){const r=3*t;return n?(n.set(e[r],e[r+1],e[r+2]),n):new i.Vector3(e[r],e[r+1],e[r+2])}class R{constructor(e,t,n,r,a){this.fabric=void 0,this.world=void 0,this.view=void 0,this.floatView=function(){const e=new Float32Array(0);return{jointCount:0,intervalCount:0,faceCount:0,lineGeometry:new i.BufferGeometry,faceGeometry:new i.BufferGeometry,jointLocations:e,unitVectors:e,idealLengths:e,strains:e,strainLimits:new Float32Array(4),strainNuances:e,stiffnesses:e,linearDensities:e}}(),this.adoptFabric=void 0,this.midpoint=new i.Vector3(0,0,0),this.valuesToApply=[],this.fabricBackup=void 0,this.world=r;for(const[s,i]of Object.entries(t)){const e=parseInt(s,10),{percentToValue:t}=u(e),n=t(i);this.world.set_float_value(e,n)}this.adoptFabric=t=>(this.free(),this.fabric=t,this.view=e.View.on_fabric(t),this),this.adoptFabric(a||e.Fabric.new(n))}iterate(){const e=this.fabric.iterate(this.world);this.refreshFloatView();const t=this.valuesToApply.shift();return t&&this.world.set_float_value(t.feature,t.value),e}get stage(){return this.fabric.get_stage()}set stage(e){this.fabric.request_stage(e,this.world)||console.error("Could not move to stage ".concat(e,"!"))}showFrozen(e){this.updateFloatView(!0,e)}get fabricClone(){return this.fabric.clone()}snapshot(){console.log("snapshot"),this.fabricBackup=this.fabricClone}restoreSnapshot(){console.log("restoreSnapshot");const e=this.fabricBackup;if(!e)throw new Error("Missing backup");this.adoptFabric(e.clone())}refreshFloatView(){this.view.render(this.fabric,this.world),this.midpoint.set(this.view.midpoint_x(),this.view.midpoint_y(),this.view.midpoint_z()),this.updateFloatView(!1,!1)}clear(){return this.fabric.clear(),this.refreshFloatView(),this}applyFeature(e,t,n){this.valuesToApply.push({feature:e,percent:t,value:n})}jointLocation(e){return F(this.floatView.jointLocations,e.index)}averageJointLocation(e){return e.reduce((e,t)=>e.add(this.jointLocation(t)),new i.Vector3).multiplyScalar(1/e.length)}jointDistance(e,t){return this.jointLocation(e).distanceTo(this.jointLocation(t))}intervalLocation({alpha:e,omega:t}){return this.jointLocation(e).add(this.jointLocation(t)).multiplyScalar(.5)}twistLocation({pushes:e}){return e.reduce((e,t)=>e.add(this.intervalLocation(t)),new i.Vector3).multiplyScalar(1/e.length)}intervalLength({alpha:e,omega:t}){return this.jointDistance(e,t)}faceLocation(e){return A(e.ends.map(e=>this.jointLocation(e)))}averageFaceLocation(e){return e.reduce((e,t)=>e.add(this.faceLocation(t)),new i.Vector3).multiplyScalar(1/e.length)}apply(e){this.fabric.apply_matrix4(new Float32Array(e.toArray())),this.refreshFloatView()}unitVector(e){return F(this.floatView.unitVectors,e)}free(){const e=this.fabric;e&&e.free();const t=this.view;t&&t.free()}updateFloatView(e,t){const n=this.fabric,r=this.view,a=n.get_joint_count(),s=n.get_interval_count(),o=n.get_face_count(),c=this.floatView;if(c.jointCount!==a||c.intervalCount!==s||c.faceCount!==o){c.jointCount=a,c.intervalCount=s,c.faceCount=o,c.lineGeometry.dispose(),c.lineGeometry=new i.BufferGeometry;const n=new Float32Array(3*s*2);r.copy_line_locations_to(n),c.lineGeometry.setAttribute("position",new i.Float32BufferAttribute(n,3));const l=new Float32Array(3*s*2);if(e)if(t){l.fill(0);for(let e=1;e<l.length;e+=3)l[e]=1}else l.fill(1);else r.copy_line_colors_to(l);c.lineGeometry.setAttribute("color",new i.Float32BufferAttribute(l,3)),c.faceGeometry.dispose(),c.faceGeometry=new i.BufferGeometry;const u=new Float32Array(3*o*3);r.copy_face_vertex_locations_to(u),c.faceGeometry.setAttribute("position",new i.Float32BufferAttribute(u,3));const h=new Float32Array(3*o*3);r.copy_face_normals_to(h),c.faceGeometry.setAttribute("normal",new i.Float32BufferAttribute(h,3)),c.jointLocations=new Float32Array(3*a),c.unitVectors=new Float32Array(3*s),c.idealLengths=new Float32Array(s),c.strains=new Float32Array(s),c.strainNuances=new Float32Array(s),c.stiffnesses=new Float32Array(s),c.linearDensities=new Float32Array(s)}else{const n=this.floatView.lineGeometry.attributes,a=this.floatView.faceGeometry.attributes;if(n.position){const s=n.position;r.copy_line_locations_to(s.array),s.needsUpdate=!0;const i=n.color,o=i.array;if(e)if(t){o.fill(0);for(let e=1;e<o.length;e+=3)o[e]=1}else o.fill(1);else r.copy_line_colors_to(o);i.needsUpdate=!0;const c=a.position;r.copy_face_vertex_locations_to(c.array),c.needsUpdate=!0;const l=a.normal;r.copy_face_normals_to(l.array),l.needsUpdate=!0}}r.copy_joint_locations_to(c.jointLocations),r.copy_unit_vectors_to(c.unitVectors),r.copy_ideal_lengths_to(c.idealLengths),r.copy_strains_to(c.strains),r.copy_strain_limits_to(c.strainLimits),r.copy_strain_nuances_to(c.strainNuances),r.copy_stiffnesses_to(c.stiffnesses),r.copy_linear_densities_to(c.linearDensities)}}const V=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function T(){if("serviceWorker"in navigator){if(new URL("/app",window.location.toString()).origin!==window.location.origin)return;window.addEventListener("load",()=>{const e="".concat("/app","/service-worker.js");V?(!function(e){fetch(e).then(t=>{404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then(e=>{e.unregister().then(()=>{window.location.reload()})}):D(e)}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")})}(e),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")})):D(e)})}}function D(e){navigator.serviceWorker.register(e).then(e=>{e.onupdatefound=()=>{const t=e.installing;t&&(t.onstatechange=()=>{"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))})}}).catch(e=>{console.error("Error during service worker registration:",e)})}var B=n(95),L=n(57),M=n(12),N=n(103);let _;!function(e){e.Left="Left",e.Right="Right",e.LeftRight="Left-Right",e.RightLeft="Right-Left"}(_||(_={}));_.Left,_.Right,_.LeftRight,_.RightLeft;function I(e,t,n){if(t)switch(e){case _.Left:return n?_.RightLeft:_.Right;case _.Right:return n?_.LeftRight:_.Left;case _.LeftRight:return _.RightLeft;case _.RightLeft:return _.LeftRight}else switch(e){case _.Left:return n?_.LeftRight:e;case _.Right:return n?_.RightLeft:e;case _.LeftRight:case _.RightLeft:return e}throw new Error("Spin?")}let z;!function(e){e[e.a=0]="a",e[e.B=1]="B",e[e.C=2]="C",e[e.D=3]="D",e[e.b=4]="b",e[e.c=5]="c",e[e.d=6]="d",e[e.A=7]="A"}(z||(z={}));const G=[z.a,z.B,z.C,z.D,z.b,z.c,z.d,z.A];function W(e){return"aBCDbcdA".indexOf(e)>=0}function J(e){const t="aBCDbcdA".indexOf(e);if(t<0)throw new Error("[".concat(e,"] is not a face name"));return G[t]}function H({push:e}){if(!e)throw new Error("Expected push");return e}function U({pulls:e}){if(!e)throw new Error("no pulls");return e}function q(e,t){return n=e.index,r=t.index,n<r?"(".concat(n,",").concat(r,")"):"(".concat(r,",").concat(n,")");var n,r}function $({alpha:e,omega:t}){return q(e,t)}function Q(e){const t=d.dot(e);return(new i.Quaternion).setFromUnitVectors(t>0?d:m,e)}function X(e,t){return e.index!==t.index&&(e.alpha.index===t.alpha.index||e.omega.index===t.omega.index||e.alpha.index===t.omega.index||e.omega.index===t.alpha.index)}function K(e){return({intervalRole:t})=>t===e}function Z(e,t){return({alpha:n,omega:r})=>n.index===e.index&&r.index===t.index||r.index===e.index&&n.index===t.index}function Y(e){if(!e.push)throw new Error("No push");const t=e.push;if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("Big problem")}function ee(e,t){if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("No other joint")}function te(e){return e||{_:100}}function ne({_:e}){return e/100}function re(e){return{_:100*e}}class ae{constructor(e,t,n,r){this.forward=e,this.scale=t,this.subtrees=n,this.markNumbers=r,this.root=void 0}get nonEmpty(){return void 0===this.forward&&0===this.subtreeCode.length&&0===this.markCode.length?void 0:this}get decremented(){if(void 0!==this.forward&&this.forward.length>0){const e=this.forward.substring(0,1);return{afterNode:new ae(this.forward.substring(1),this.scale,this.subtrees,this.markNumbers),action:e}}return{afterNode:this,action:""}}subtree(e){return this.subtrees[e]}faceMarks(e){return this.markNumbers[e]}deleteMark(e){delete this.markNumbers[e]}get needsOmniTwist(){const e=G.filter(e=>e!==z.A&&e!==z.a);return e.some(e=>this.subtrees[e])||e.some(e=>this.markNumbers[e])}get code(){const e=100!==this.scale._,t=this.subtreeCode,n=this.markCode;if(!this.root&&this.forward&&this.forward.length>0&&!e&&0===t.length&&0===n.length)return this.forward.toString();const r=[];return this.forward&&this.forward.length>0&&r.push(this.forward.toString()),e&&r.push("S".concat(this.scale._)),r.push(...t),r.push(...n),"(".concat(r.join(","),")")}get subtreeCode(){return Object.entries(this.subtrees).map(([e,t])=>"".concat("aBCDbcdA"[e]).concat(t.code))}get markCode(){return Object.entries(this.markNumbers).map(([e,t])=>t.map(t=>"M".concat("aBCDbcdA"[e]).concat(t._))).flat()}}var se=n(102);function ie(e){const t=[],n=K(f.PullA),r=K(f.PullB),a=(e,t)=>((e,t)=>e.find(e=>t.find(t=>e.index===t.index)))(U(e).filter(n).map(t=>ee(e,t)),U(t).filter(n).map(e=>ee(t,e))),s=e.instance;return e.withPulls(o=>{const c=e=>{const n=$(e);o[n]||(t.push(e),o[n]=e)},l=e=>{const t=(e=>{const t=U(e).filter(r)[0],n=ee(e,t),s=Y(e),i=ee(s,U(s).filter(r)[0]),o=a(e,i),c=a(n,s);if(!o||!c)return;if(o.push&&!c.push){const e=Y(n);if(!U(e).some(Z(o,e)))return}else if(c.push&&!o.push){const t=Y(e);if(!U(t).some(Z(c,t)))return}return{alpha:o.push?o:e,omega:c.push?c:n,scale:t.scale,intervalRole:o.push&&c.push?f.PullBB:f.PullB}})(e);t&&c(t)};e.intervals.filter(K(f.PullB)).forEach(({alpha:e,omega:t})=>{l(e),l(t)}),e.joints.filter(e=>e.push&&3===U(e).filter(n).length).forEach(e=>{const t=U(e).filter(n).find(t=>!ee(e,t).push);if(!t)throw new Error("no-push not found");const r=ee(e,t),a=U(e).filter(n).map(t=>ee(e,t)).map(t=>({end:t,outwards:(new i.Vector3).subVectors(s.jointLocation(t),s.jointLocation(e)).normalize()})),o=U(r).filter(n).map(e=>ee(r,e)).map(t=>({end:t,outwards:(new i.Vector3).subVectors(s.jointLocation(t),s.jointLocation(e)).normalize()}));a.map(e=>{const n=o.sort((t,n)=>e.outwards.dot(n.outwards)-e.outwards.dot(t.outwards))[0],r=f.PullAA,a=t.scale,s={alpha:e.end,omega:n.end,scale:a,intervalRole:r};c(s)})})}),t}function oe(e,t){const n=e=>({age:t,todo:e});switch(e){case"orient-0":return n(e=>{const t=e.faces.filter(({markNumbers:e})=>e.find(e=>0===e._));if(0===t.length)throw new Error("No faces marked zero");const n=e.instance,r=t.reduce((e,{ends:t})=>e.add(A(t.map(e=>n.jointLocation(e)))),new i.Vector3).multiplyScalar(1/t.length),a=t.reduce((e,{ends:t})=>e.sub(P(t.map(e=>n.jointLocation(e)))),new i.Vector3).normalize(),{b1:s,up:o,b2:c}=function(e){const{x:t,y:n,z:r}=e,a=t*t+n*n,s=n*n+r*r,o=r*r+t*t,c=new i.Vector3;return a>s&&a>o?c.set(-n,t,0).normalize():s>a&&s>o?c.set(0,-r,n).normalize():c.set(-r,0,t).normalize(),{b1:c,up:e,b2:(new i.Vector3).crossVectors(e,c).normalize()}}(a);e.instance.apply((new i.Matrix4).makeBasis(s,o,c).setPosition(r).invert()),e.fabric.set_altitude(5)});case"conflict":return n(e=>{(function(e){const t=[],n=e.instance,r=(e,t)=>{const r=n.jointLocation(e).sub(n.jointLocation(t.alpha)).normalize(),a=n.jointLocation(e).sub(n.jointLocation(t.omega)).normalize();return r.dot(a)<0};return e.joints.forEach((a,s)=>{const i=a.push;i&&e.joints.forEach((e,o)=>{if(o<=s)return;const c=e.push;if(c){const s=ee(a,i),o=ee(e,c);if(6*n.jointDistance(a,e)>n.jointDistance(s,o))return;r(a,c)&&r(e,i)&&t.push({jointA:a,jointB:e})}})}),t})(e).forEach(({jointA:t,jointB:n})=>{e.createInterval(t,n,f.Conflict,te())})});case"pretensing":return n(e=>{e.stage=o.Stage.Slack,e.stage=o.Stage.Pretensing});case"age":return n(e=>{console.log("age exceeds ".concat(e.name," @ ").concat(t),e.fabric.age)});default:throw new Error("No job named ".concat(e))}}class ce{constructor(e,t,n,r){this.tensegrity=e,this.spin=t,this.scale=n,this.faces=[],this.pushes=[],this.pulls=[];const a=r?3===r.length?r:ue(r[0],3):ue(new i.Vector3,3);switch(this.spin){case _.Left:this.createSingle(a,!0);break;case _.Right:this.createSingle(a,!1);break;case _.LeftRight:this.createDouble(a,!0);break;case _.RightLeft:this.createDouble(a,!1);break;default:throw new Error("Spin?")}}face(e){switch(this.faces.length){case 2:switch(e){case z.a:return this.faces[0];case z.A:return this.faces[1]}break;case 8:switch(e){case z.a:return this.faces[0];case z.B:return this.faces[2];case z.C:return this.faces[1];case z.D:return this.faces[3];case z.b:return this.faces[4];case z.c:return this.faces[5];case z.d:return this.faces[6];case z.A:return this.faces[7]}}throw new Error("Face ".concat(z[e]," not found in twist with ").concat(this.faces.length," faces"))}get adjacentPulls(){return this.tensegrity.intervals.filter(({intervalRole:e})=>!y(e)).reduce((e,t)=>(this.pushes.find(e=>X(e,t))&&e.push(t),e),[])}createSingle(e,t){const n=le(e,this.scale,t),r=n.map(({alpha:e,omega:t})=>({alpha:this.tensegrity.createJoint(e),omega:this.tensegrity.createJoint(t)})),a=this.tensegrity.createJoint(A(n.map(({alpha:e})=>e))),s=this.tensegrity.createJoint(A(n.map(({omega:e})=>e)));this.tensegrity.instance.refreshFloatView(),r.forEach(({alpha:e,omega:t})=>{const n=this.tensegrity.createInterval(e,t,f.PushA,this.scale);this.pushes.push(n),e.push=t.push=n});const i=(e,t)=>{const n=e.map(e=>this.tensegrity.createInterval(e,t,f.PullA,this.scale));this.pulls.push(...n),this.faces.push(this.tensegrity.createFace(this,e,n,this.spin,this.scale,t))};i(r.map(({alpha:e})=>e),a),i(r.map(({omega:e})=>e).reverse(),s),r.forEach(({alpha:e},n)=>{const a=r[(r.length+n+(t?-1:1))%r.length].omega;this.pulls.push(this.tensegrity.createInterval(e,a,f.PullB,this.scale))})}createDouble(e,t){const n=le(e,this.scale,t),r=le(n.map(({omega:e})=>e),this.scale,!t),a=n.map(({alpha:e,omega:t})=>({alpha:this.tensegrity.createJoint(e),omega:this.tensegrity.createJoint(t)})),s=r.map(({alpha:e,omega:t})=>({alpha:this.tensegrity.createJoint(e),omega:this.tensegrity.createJoint(t)}));this.tensegrity.instance.refreshFloatView();[...a,...s].forEach(({alpha:e,omega:t})=>{const n=this.tensegrity.createInterval(e,t,f.PushB,this.scale);this.pushes.push(n),e.push=t.push=n});const i=t?[[a[0].alpha,a[1].alpha,a[2].alpha],[a[2].alpha,a[1].omega,s[1].alpha],[a[0].alpha,a[2].omega,s[2].alpha],[a[1].alpha,a[0].omega,s[0].alpha],[s[1].omega,s[0].alpha,a[1].omega].reverse(),[s[0].omega,s[2].alpha,a[0].omega].reverse(),[s[2].omega,s[1].alpha,a[2].omega].reverse(),[s[0].omega,s[1].omega,s[2].omega].reverse()]:[[a[0].alpha,a[1].alpha,a[2].alpha],[a[2].alpha,a[0].omega,s[2].alpha].reverse(),[a[0].alpha,a[1].omega,s[0].alpha].reverse(),[a[1].alpha,a[2].omega,s[1].alpha].reverse(),[s[1].omega,s[2].alpha,a[2].omega],[s[2].omega,s[0].alpha,a[0].omega],[s[0].omega,s[1].alpha,a[1].omega],[s[0].omega,s[1].omega,s[2].omega].reverse()],o=e=>this.tensegrity.instance.jointLocation(e),c=i.map(e=>this.tensegrity.createJoint(A(e.map(o))));this.tensegrity.instance.refreshFloatView(),i.forEach((e,n)=>{const r=c[n],a=e.map(e=>this.tensegrity.createInterval(e,r,f.PullA,this.scale));this.pulls.push(...a);const s=t===[0,4,5,6].some(e=>e===n)?_.Left:_.Right;this.faces.push(this.tensegrity.createFace(this,e,a,s,this.scale,r))})}}function le(e,t,n){const r=[],a=A(e),s=()=>(new i.Vector3).copy(a),o=ne(t),c=P(e).multiplyScalar(-o);for(let l=0;l<e.length;l++){const t=t=>O(e[(l+e.length+t)%e.length],a),u=(e,n)=>{return r=t(e),a=t(n),(new i.Vector3).addVectors(r,a).normalize();var r,a},h=s().addScaledVector(u(0,1),o),d=s().add(c).addScaledVector(n?u(1,2):u(-1,0),o);r.push({alpha:h,omega:d})}return r}function ue(e,t){const n=[];for(let r=0;r<t;r++){const a=r*Math.PI*2/t,s=Math.cos(a),o=Math.sin(a);n.push(new i.Vector3(s,0,o).add(e))}return n}let he,de,me;!function(e){e[e.Subtree=0]="Subtree",e[e.Join=1]="Join",e[e.ShapingDistance=2]="ShapingDistance",e[e.PretenstDistance=3]="PretenstDistance",e[e.None=4]="None"}(he||(he={})),function(e){e[e.NoOp=0]="NoOp",e[e.Faces=1]="Faces",e[e.Snelson=2]="Snelson",e[e.Bowtie=3]="Bowtie",e[e.BowtieFaces=4]="BowtieFaces"}(de||(de={})),function(e){e[e.Bowtie=0]="Bowtie",e[e.Snelson=1]="Snelson"}(me||(me={}));const fe=-1;class ge{constructor(e,t,n){this.instance=e,this.countdown=t,this.builder=n,this.name=void 0,this.stage$=void 0,this.joints=[],this.intervals=[],this.loops=[],this.faces=[],this.twists=[],this.connectors=[],this.distancers=[],this.pretenstAge=-1,this.scale=1,this.jobs=[],this.instance.clear(),this.stage$=new se.a(this.fabric.get_stage()),this.builder.operateOn(this)}get fabric(){return this.instance.fabric}createJoint(e){const t={index:this.fabric.create_joint(e.x,e.y,e.z)};return this.joints.push(t),t}removeJoint(e){const t=e.index;this.fabric.remove_joint(t),this.joints=this.joints.filter(e=>e.index!==t),e.index=-t,this.joints.forEach(e=>e.index=e.index>t?e.index-1:e.index),this.instance.refreshFloatView()}createRadialPull(e,t,n,r){const a=this.instance,s=this.createJoint(a.faceLocation(e)),i=this.createJoint(a.faceLocation(t));a.refreshFloatView();const o=this.creatAxis(s,i,n,r),c=e.ends.reduce((e,t)=>e+a.jointDistance(s,t),0)/e.ends.length,l=t.ends.reduce((e,t)=>e+a.jointDistance(i,t),0)/t.ends.length,u=e.ends.map(e=>this.createRay(s,e,c)),h=t.ends.map(e=>this.createRay(i,e,l)),d={alpha:e,omega:t,axis:o,alphaRays:u,omegaRays:h};switch(o.intervalRole){case f.Connector:this.connectors.push(d);break;case f.ShapingDistancer:this.distancers.push(d);break;case f.PretenstDistancer:}return d}createInterval(e,t,n,r,a){const s=y(n),i=g(n)*ne(r),o=function(e){switch(e){case f.PushA:case f.PushB:case f.PushC:case f.PullA:case f.PullB:case f.Conflict:return 1;case f.PullAA:case f.PullBB:return.4;default:throw new Error("Stiffness for Role ".concat(f[e],"?"))}}(n),c=0===i?0:this.instance.jointDistance(e,t),l=void 0===a?1:a,u=this.countdown*Math.abs(i-c)*l,h=u<=0?0:1/u,d={index:this.fabric.create_interval(e.index,t.index,s,c,i,o,h),intervalRole:n,scale:r,alpha:e,omega:t,removed:!1};return this.intervals.push(d),d}changeIntervalScale(e,t){e.scale=re(ne(e.scale)*t),this.fabric.multiply_rest_length(e.index,t,100)}removeInterval(e){const t=e.index;this.intervals=this.intervals.filter(e=>e.index!==t),this.fabric.remove_interval(t),this.intervals.forEach(e=>{e.index>t&&e.index--}),e.removed=!0}createFace(e,t,n,r,a,s){const i=t[0],o=t[2],c=t[1],l={twist:e,index:this.fabric.create_face(i.index,c.index,o.index),spin:r,scale:a,ends:t,pushes:[H(i),H(o),H(c)],pulls:n,markNumbers:[],joint:s};return this.faces.push(l),l}removeFace(e){e.pulls.forEach(e=>this.removeInterval(e)),e.pulls=[],e.joint&&this.removeJoint(e.joint),this.fabric.remove_face(e.index),this.faces=this.faces.filter(t=>t.index!==e.index),this.faces.forEach(t=>{t.index>e.index&&t.index--}),e.index=-1}faceToTriangle(e){e.pulls.forEach(e=>this.removeInterval(e)),e.pulls=[],e.joint&&this.removeJoint(e.joint);for(let t=0;t<e.ends.length;t++){const n=e.ends[t],r=e.ends[(t+1)%e.ends.length];e.pulls.push(this.createInterval(n,r,f.PullB,e.scale))}}triangleFaces(){this.faces.forEach(e=>this.faceToTriangle(e))}withPulls(e){const t=(e,t)=>{e.pulls?e.pulls.push(t):e.pulls=[t]};this.intervals.filter(({intervalRole:e})=>!y(e)).forEach(e=>{t(e.alpha,e),t(e.omega,e)});const n={};this.intervals.forEach(e=>n[function({alpha:e,omega:t}){return q(e,t)}(e)]=function({alpha:e,omega:t,scale:n,intervalRole:r}){return{alpha:e,omega:t,scale:n,intervalRole:r}}(e)),e(n),this.joints.forEach(e=>e.pulls=void 0)}createPulls(e){(()=>{switch(e){case me.Bowtie:return ie(this);case me.Snelson:return function(e){const t=[],n=(e,t)=>{const n=Y(e),r=ee(e,t);if(!n.push||!r.push)return;const a=U(n).filter(K(f.PullA)).map(e=>ee(n,e)),s=U(r).filter(K(f.PullA)).map(e=>ee(r,e)),i=a.find(e=>!!s.find(t=>e.index===t.index));if(!i||!i.push)return;return{alpha:e,omega:i,intervalRole:f.PullB,scale:t.scale}};return e.withPulls(r=>{e.intervals.filter(K(f.PullB)).forEach(e=>{const a=n(e.alpha,e);if(a){r[$(a)]||t.push(a)}const s=n(e.omega,e);if(s){r[$(s)]||t.push(s)}})}),t}(this);default:throw new Error}})().forEach(({alpha:e,omega:t,intervalRole:n,scale:r})=>{this.createInterval(e,t,n,r,5)})}removeSlackPulls(){this.intervals.filter(({intervalRole:e})=>e===f.PullAA).filter(e=>0===this.instance.floatView.strains[e.index]).forEach(e=>this.removeInterval(e))}createTwist(e,t,n){const r=new ce(this,e,t,n);return this.twists.push(r),r}createTwistOn(e,t,n){const r=this.createTwist(t,n,e.ends.map(e=>this.instance.jointLocation(e)).reverse());return this.createLoop(e,r.face(z.a)),r}findTwist(e){const t=this.twists.find(({pushes:t})=>t.find(({index:t})=>t===e.index));if(!t)throw new Error("Cannot find twist");return t}get stage(){return this.stage$.getValue()}set stage(e){this.instance.stage=e,e===o.Stage.Slack&&(this.distancers.forEach(e=>{const{axis:t,alphaRays:n,omegaRays:r}=e;[t,...n,...r].forEach(e=>this.removeInterval(e))}),this.distancers=[],this.instance.snapshot()),this.stage$.next(e)}set toDo(e){this.jobs.push(e)}iterate(){const e=this.instance.iterate();if(e)return e;const t=this.jobs.length;if(t){const e=this.instance.fabric.age;if(this.jobs=this.jobs.filter(({todo:t,age:n})=>void 0!==n&&(n<0||n>e)||(t(this),!1)),this.jobs.length<t)return!0}switch(this.stage){case o.Stage.Growing:if(!this.builder.finished())return this.builder.work(),!1;if(this.connectors.length>0)return this.connectors=this.checkConnectors(),!1;this.stage=o.Stage.Shaping,this.jobs=this.jobs.filter(({todo:e,age:t})=>t!==fe||(e(this),!1));break;case o.Stage.Shaping:case o.Stage.Slack:break;case o.Stage.Pretensing:this.stage=o.Stage.Pretenst;break;case o.Stage.Pretenst:this.pretenstAge<0&&(this.pretenstAge=this.fabric.age)}return!1}strainToStiffness(){const e=this.instance,t=e.floatView,n=this.intervals.filter(t=>!y(t.intervalRole)&&(e.jointLocation(t.alpha).y>=0||e.jointLocation(t.omega).y>=0)),r=t.strains,a=n.reduce((e,t)=>e+r[t.index],0)/n.length,s=new Float32Array(t.stiffnesses);n.forEach(e=>{const t=(r[e.index]-a)/a;s[e.index]*=1+t}),e.restoreSnapshot(),this.fabric.copy_stiffnesses(s)}createRadialPulls(e,t,n){const r=e=>this.instance.faceLocation(e),a=()=>{const t=this.createTwist(_.LeftRight,re(function(e){return e.reduce((e,t)=>e+ne(t.scale),0)/e.length}(e)),[this.instance.averageFaceLocation(e)]);return this.instance.refreshFloatView(),e.map(e=>{const n=t.faces.filter(({spin:t,pulls:n})=>n.length>0&&t!==e.spin),a=r(e),s=n.reduce((e,t)=>r(e).distanceTo(a)<r(t).distanceTo(a)?e:t);return this.createRadialPull(s,e,f.Connector)})},s=n||re(.75);switch(t){case he.ShapingDistance:case he.PretenstDistance:if(!s)throw new Error("Missing pull scale");e.forEach((n,r)=>{e.forEach((e,a)=>{if(r<=a)return;const i=t===he.ShapingDistance?f.ShapingDistancer:f.PretenstDistancer;this.createRadialPull(n,e,i,s)})});break;case he.Join:switch(e.length){case 2:e[0].spin===e[1].spin?a():this.createRadialPull(e[0],e[1],f.Connector);break;case 3:a()}}}checkConnectors(){if(0===this.connectors.length)return this.connectors;const e=(e,t)=>{!function(e,t,n){const r=[...t.ends].reverse(),a=n.ends,s=[];for(let c=0;c<r.length;c++){let t=0;for(let n=0;n<r.length;n++){const s=(n+c)%r.length;t+=e.jointDistance(r[n],a[s]),t+=e.jointDistance(a[s],r[(n+1)%r.length])}s.push(t)}let i=0,o=s[i];s.forEach((e,t)=>{e<o&&(i=t,o=e)}),i>0&&(n.ends=n.ends.map(({},e)=>n.ends[(e+i)%n.ends.length]))}(this.instance,e,t),this.createLoop(e,t)};return this.connectors.filter(({axis:t,alpha:n,omega:r,alphaRays:a,omegaRays:s})=>{if(t.intervalRole===f.Connector){if(this.instance.jointDistance(t.alpha,t.omega)<=.05)return e(n,r),this.removeInterval(t),a.forEach(e=>this.removeInterval(e)),s.forEach(e=>this.removeInterval(e)),!1}return!0})}getIntervalDetails(e){const t=this.instance,{floatView:n}=t;return{interval:e,strain:n.strains[e.index],length:t.intervalLength(e)*this.scale,height:t.intervalLocation(e).y*this.scale}}createLoop(e,t){const n=[...e.ends].reverse(),r=t.ends,a=re((ne(e.scale)+ne(t.scale))/2),s=[];for(let i=0;i<n.length;i++){const e=n[i],t=n[(i+1)%n.length],o=r[i];s.push(this.createInterval(e,o,f.PullA,a)),s.push(this.createInterval(o,t,f.PullA,a))}this.removeFace(t),this.removeFace(e),this.loops.push(s)}creatAxis(e,t,n,r){const a=this.instance.jointDistance(e,t),s=r?ne(r)*a:.025,i=te(),o=1/(this.countdown*Math.abs(s-a)),c={index:this.fabric.create_interval(e.index,t.index,!1,a,s,1,o),alpha:e,omega:t,intervalRole:n,scale:i,removed:!1};return this.intervals.push(c),c}createRay(e,t,n){const r=this.instance.jointDistance(e,t),a=f.Radial,s=re(n),i=1/(this.countdown*Math.abs(n-r)),o={index:this.fabric.create_interval(e.index,t.index,!1,r,n,1,i),alpha:e,omega:t,intervalRole:a,scale:s,removed:!1};return this.intervals.push(o),o}}function pe(e,t){try{const n=ve(e.code.join());return n?(n.root=!0,n):void t("Nothing to compile")}catch(n){return void t(n.message)}}class we{constructor(e,t,n){this.location=e,this.tenscript=t,this.tree=n,this.tensegrity=void 0,this.markDefStrings=void 0,this.buds=void 0}operateOn(e){this.tensegrity=e,this.tenscript.scale&&(this.tensegrity.scale=this.tenscript.scale),e.name=this.tenscript.name,e.instance.world.set_surface_character(this.tenscript.surfaceCharacter),this.markDefStrings=this.tenscript.markDefStrings?this.tenscript.markDefStrings:{},this.tenscript.jobs&&this.tenscript.jobs.forEach(({todo:t,age:n})=>e.toDo=oe(t,n)),this.tensegrity.toDo=function(e){const t=fe,n=e=>({age:t,todo:e});switch(e){case de.Faces:return n(e=>{e.triangleFaces()});case de.Snelson:return n(e=>{e.createPulls(me.Snelson),e.triangleFaces()});case de.Bowtie:return n(e=>{e.createPulls(me.Bowtie)});case de.BowtieFaces:return n(e=>{e.createPulls(me.Bowtie),e.triangleFaces()});default:return n(()=>{})}}(this.tenscript.postGrowthOp),this.buds=[ye(e,this.location,this.tenscript,this.tree)]}finished(){return 0===this.buds.length}work(){this.buds=function(e){const t=[];return e.forEach(e=>{const{tree:n,markActions:r,reorient:a,twist:s}=e;if(void 0!==n.forward&&n.forward.length>0){const{afterNode:r,action:a}=n.decremented,s=n.needsOmniTwist&&void 0!==r.forward&&0===r.forward.length;t.push(Se(e,a,r,z.A,s,n.scale))}else{if(a){if(![z.A,z.a,z.B,z.b].some(e=>!n.subtree(e))){const e=s.tensegrity.joints.map(e=>s.tensegrity.instance.jointLocation(e));s.tensegrity.instance.apply(function(e,t){const n=O(e[0],e[1]),r=O(e[3],e[2]),a=O(e[5],e[4]),s=e.reduce((e,t)=>e.add(t),new i.Vector3).multiplyScalar(1/e.length),o=(new i.Matrix4).makeBasis(n,r,a).setPosition(s),c=(new i.Matrix4).makeRotationZ(-.24*Math.PI),l=(new i.Matrix4).makeRotationY(-Math.PI/2-t*Math.PI/3);return o.multiply(c).multiply(l).invert()}(e,0))}}G.forEach(a=>{const s=n.subtree(a);if(s){const{afterNode:n,action:r}=s.decremented,i=s.needsOmniTwist&&""===s.forward;t.push(Se(e,r,n,a,i,s.scale))}else{const s=n.faceMarks(a);s&&s.forEach(s=>{const i=r[s._];if(i&&i.action===he.Subtree){const r=i.tree;if(!r)throw new Error("Missing subtree");n.deleteMark(a);const s=r.needsOmniTwist;t.push(Se(e,"",r,a,s,te(r.scale)))}})}})}}),t}(this.buds),this.finished()&&function(e,t,n){const r=Ee(n),a={};return t.forEach(e=>{e.markNumbers.forEach(t=>{const n=a[t._];n?n.push(e):a[t._]=[e]})}),Object.entries(a).map(([t])=>{const n=r[t]||r[-1],s=n||he.None;return new be(e,a[t],s)})}(this.tensegrity,this.tensegrity.faces,this.markDefStrings).forEach(e=>e.execute())}}class be{constructor(e,t,n){this.tensegrity=e,this.faces=t,this.markAction=n}execute(){switch(this.markAction.action){case he.Join:case he.ShapingDistance:case he.PretenstDistance:this.tensegrity.createRadialPulls(this.faces,this.markAction.action,this.markAction.scale)}}}function ye(e,t,n,r){const a=void 0===r.forward,{spin:s,markDefStrings:i}=n;return{tree:r,twist:e.createTwist(s,te(),[t]),markActions:Ee(i),reorient:a}}function Ee(e){const t={};return e&&Object.keys(e).forEach(n=>{const r=e[n];if(r.startsWith("subtree")){const e=ve(r.substring("subtree".length));t[n]={action:he.Subtree,tree:e}}else if(r.startsWith("join"))t[n]={action:he.Join};else if(r.startsWith("shaping-distance-")){const e={_:parseInt(r.split("-")[2],10)};t[n]={action:he.ShapingDistance,scale:e}}else if(r.startsWith("pretenst-distance-")){const e={_:parseInt(r.split("-")[2],10)};t[n]={action:he.PretenstDistance,scale:e}}}),t}function ve(e){const t=je(e,!0).content;let n,r=te();const a={},s={};function i(e){const{content:n,skip:r}=je(t.substring(e),!1);return{codeTree:ve(n),skip:r}}function o(e,t){const n=s[e],r={_:t};n?n.push(r):s[e]=[r]}for(let c=0;c<t.length;c++){const e=t.charAt(c);if(W(e)){const n=i(c+1),r=n.codeTree;if(!r)throw new Error("No subtree: ".concat(t.substring(c)));a[J(e)]=r,c+=n.skip}else if(xe(e)){const e=je(t,!1),r=ke(e.content);n="X".repeat(r),c+=e.skip}else if("X"===e||"O"===e){const e=je(t,!1);n=e.content,c+=e.skip}else switch(e){case"S":const n=je(t.substring(c+1),!0);r={_:ke(n.content)},c+=n.skip;break;case"M":const a=t.charAt(c+1),s=je(t.substring(c+2),!0);o(J(a),ke(s.content)),c+=s.skip+1;break;case",":case" ":case"\n":break;default:throw new Error("Unexpected character: ".concat(e))}}return new ae(n,r,a,s).nonEmpty}function Se({twist:e,markActions:t},n,r,a,s,i){const o=e.face(a),c=(()=>{switch(n){case"O":return I(o.spin,!1,s);default:return I(o.spin,!0,s)}})(),l=re(ne(o.scale)*ne(i)),u=e.tensegrity.createTwistOn(o,c,l);var h,d;return""===r.forward&&(h=u,d=r,G.forEach(e=>{const t=d.faceMarks(e);t&&h.face(e).markNumbers.push(...t)})),{tree:r,twist:u,markActions:t,reorient:!1}}function xe(e){return"0123456789".indexOf(e)>=0}function ke(e){if(!e.match(/^\d*$/))throw new Error("Not a number: ".concat(e));return 0===e.length?0:parseInt(e,10)}function je(e,t){const n=e.indexOf(","),r=n>=0;if("("!==e.charAt(0))return r?{content:e.substring(0,n),skip:n}:{content:e,skip:e.length};const a=function(e){if("("!==e.charAt(0))throw new Error('Code must start with "(": '.concat(e," ").concat(e.charAt(0)));let t=0;for(let n=0;n<e.length;n++){const r=e.charAt(n);if("("===r)t++;else if(")"===r&&(t--,0===t))return n}throw new Error("No matching end bracket: |".concat(e,"|"))}(e),s=t?e.substring(1,a):e.substring(0,a+1);return{content:s.length>0?s:"0",skip:a+1}}var Ce=n(56);const{persistAtom:Oe}=Object(Ce.recoilPersist)({key:"pretenst-2021-11-02",storage:localStorage}),Ae=[Oe],Pe=Object(s.atom)({key:"postGrowth",default:de.NoOp,effects_UNSTABLE:Ae}),Fe=Object(s.atom)({key:"bootstrapIndex",default:0,effects_UNSTABLE:Ae}),Re=Object(s.atom)({key:"tenscript",default:void 0,effects_UNSTABLE:Ae}),Ve=Object(s.atom)({key:"currentFeature",default:o.WorldFeature.VisualStrain,effects_UNSTABLE:Ae});const Te=Object(s.atom)({key:"rotating",default:!1}),De=Object(s.atom)({key:"globalMode",default:k()});let Be;!function(e){e.Time="Time",e.Select="Select",e.Look="Look"}(Be||(Be={}));const Le=Object(s.atom)({key:"viewMode",default:Be.Time}),Me=(Object(s.atom)({key:"surfaceCharacter",default:o.SurfaceCharacter.Frozen}),Object(s.atom)({key:"visibleRoles",default:b})),Ne=p.map(e=>{const t=u(o.WorldFeature[e]);return{mapping:t,percentAtom:Object(s.atom)({key:t.name,default:100,effects_UNSTABLE:Ae})}}),_e=Object(s.atom)({key:"selectedTwist",default:void 0}),Ie=Object(s.atom)({key:"visibleDetails",default:[]});function ze(){const[e,t]=Object(s.useRecoilState)(Le);function n({item:n,children:a}){return r.createElement(L.a,{disabled:n===e,color:n===e?"success":"secondary",onClick:()=>t(n)},a)}return r.createElement(B.a,null,r.createElement(n,{item:Be.Time},r.createElement(N.u,null),r.createElement("span",null," Time")),r.createElement(n,{item:Be.Select},r.createElement(N.o,null),r.createElement("span",null," Select")),r.createElement(n,{item:Be.Look},r.createElement(N.e,null),r.createElement("span",null," Look")))}var Ge=n(60),We=n(61),Je=n.n(We);function He(e){return e.toFixed(5).replace(/[.]/,",")}function Ue(){return(new Date).toISOString().replace(/[.].*/,"").replace(/[:T_]/g,"-")}function qe({name:e,instance:t,joints:n,intervals:r},a,s,i){t.refreshFloatView();const o=t.floatView.idealLengths,c=t.floatView.strains,l=t.floatView.stiffnesses,u=t.floatView.linearDensities;return{name:e,joints:n.map(e=>{const n=t.jointLocation(e);return{index:e.index,radius:i,x:n.x,y:n.z,z:n.y,anchor:!1}}),intervals:r.map(e=>{const r=y(e.intervalRole),i=r?a:s,h=t.intervalLength(e),d=e.alpha.index,m=e.omega.index;if(d>=n.length||m>=n.length)throw new Error("Joint not found ".concat(w(e.intervalRole),":").concat(d,",").concat(m,":").concat(n.length));return{index:e.index,joints:[d,m],type:r?"Push":"Pull",strain:c[e.index],stiffness:l[e.index],linearDensity:u[e.index],role:w(e.intervalRole),scale:e.scale._,idealLength:o[e.index],isPush:r,length:h,radius:i}})}}function $e(e){const t=new Je.a;t.file("joints.csv",function(e){const t=[];return t.push(["index","x","y","z"]),e.joints.forEach(e=>t.push([(e.index+1).toFixed(0),He(e.x),He(e.y),He(e.z)])),t.map(e=>e.join(";")).join("\n")}(e)),t.file("intervals.csv",function(e){const t=[];return t.push(["joints","type","strain","stiffness","linear density","role","length","ideal length"]),e.intervals.forEach(e=>{t.push(['"=""'.concat(e.joints.map(e=>(e+1).toFixed(0)),'"""'),e.type,He(e.strain),He(e.stiffness),He(e.linearDensity),e.role,He(e.length),He(e.idealLength)])}),t.map(e=>e.join(";")).join("\n")}(e)),t.file("submerged.csv",function(e){const t=[];return t.push(["joints"]),t.map(e=>e.join(";")).join("\n")}()),t.generateAsync({type:"blob",mimeType:"application/zip"}).then(e=>{Ge.saveAs(e,"pretenst-".concat(Ue(),".zip"))})}function Qe({tensegrity:e}){const[t,n]=Object(r.useState)(e.stage$.getValue());Object(r.useEffect)(()=>{const t=e.stage$.subscribe(n);return()=>t.unsubscribe()},[e]);const[a]=Object(s.useRecoilState)(Le),[i,c]=Object(s.useRecoilState)(Te);return r.createElement("div",{className:"text-right"},r.createElement(B.a,null,a!==Be.Time?r.createElement(r.Fragment,null,r.createElement(L.a,{onClick:()=>$e(qe(e,.012,.005,.015))},r.createElement(N.k,null),r.createElement(N.n,null)),r.createElement(L.a,{onClick:()=>function(e){const t=new Je.a;t.file("pretenst-".concat(Ue(),".json"),JSON.stringify(e,void 0,2)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then(e=>{Ge.saveAs(e,"pretenst-".concat(Ue(),".zip"))})}(qe(e,.012,.005,.015))},r.createElement(N.k,null),r.createElement(N.m,null))):t>o.Stage.Slack?r.createElement(r.Fragment,null,r.createElement(L.a,{disabled:t!==o.Stage.Pretenst,onClick:()=>e.fabric.set_altitude(10)},r.createElement(N.t,null))):void 0,r.createElement(L.a,{onClick:()=>e.fabric.centralize()},r.createElement(N.i,null)),r.createElement(L.a,{color:i?"warning":"secondary",onClick:()=>c(!i)},r.createElement(N.B,null)),r.createElement(L.a,{color:"warning",onClick:()=>j(v.Choice)},r.createElement(N.y,null))))}var Xe=n(98),Ke=n(107),Ze=n(99);const Ye=["#fd0000","#c94f00","#d58e1c","#897c00","#6c8901","#1d6c01","#0e4e00","#007f67","#01808b","#005da3","#0015c7","#0000ff"].reverse().map(e=>(new i.Color).setHex(parseInt("".concat(e.substring(1)),16))),et=new i.LineBasicMaterial({vertexColors:!0});new i.MeshBasicMaterial({color:new i.Color("#ffdf00"),side:i.DoubleSide,transparent:!0,opacity:.25,depthTest:!1}),Ye.map(e=>new i.MeshLambertMaterial({color:e}));function tt(e){switch(e){case f.PushA:return"#191f86";case f.PushB:return"#5739a0";case f.PullA:return"#a20d0d";case f.PullB:return"#eeec05";case f.PullAA:return"#da04b7";case f.PullBB:return"#00ff06";default:return"#FFFFFF"}}function nt(e,t){const n=function(e){return new i.Color(tt(e))}(e),r=t?.4:1;return new i.MeshLambertMaterial({color:n,opacity:r,transparent:!0})}function rt(e,t){switch(t){case Be.Select:return y(e.intervalRole)?.05:.02;case Be.Look:return y(e.intervalRole)?.03:.01;default:throw new Error("Bad view mode")}}const at=new i.CylinderGeometry(1,1,1,12,1,!1);function st({tensegrity:e}){return r.createElement("lineSegments",{key:"lines",geometry:e.instance.floatView.lineGeometry,material:et})}function it({tensegrity:e}){const t=e.instance,[n]=Object(s.useRecoilState)(Me),a=n.length===b.length?e.intervals:e.intervals.filter(e=>n.some(t=>t===e.intervalRole));return r.createElement("group",null,a.map(e=>{const{alpha:n,omega:a,intervalRole:s}=e,o=Q(t.unitVector(e.index)),c=t.jointDistance(n,a),l=rt(e,Be.Look),u=new i.Vector3(l,c,l);return r.createElement("mesh",{key:"T".concat(e.index),geometry:at,position:t.intervalLocation(e),rotation:(new i.Euler).setFromQuaternion(o),scale:u,material:nt(s),matrixWorldNeedsUpdate:!0})}))}var ot=n(96),ct=n(97);function lt({instance:e,details:t,singleDetails:n,onClick:a}){return r.createElement(ot.a,{className:"interval-details ".concat(n?"single-details":""),position:e.intervalLocation(t.interval)},r.createElement("div",{onMouseDown:e=>a(t)},r.createElement("div",{className:"details-mouse"},r.createElement(N.s,null)),r.createElement(ct.a,{className:"details-table"},r.createElement("thead",null,r.createElement("tr",null,r.createElement("td",{colSpan:2},t.interval.alpha.index,"-",t.interval.omega.index))),r.createElement("tbody",null,r.createElement("tr",null,r.createElement("td",{className:"text-right"},"Length:"),r.createElement("td",{className:"text-center"},t.length.toFixed(1),"mm")),r.createElement("tr",null,r.createElement("td",{className:"text-right"},"Height:"),r.createElement("td",{className:"text-center"},t.height.toFixed(1),"mm")),r.createElement("tr",null,r.createElement("td",{className:"text-right"},"Strain:"),r.createElement("td",{className:"text-center"},(100*t.strain).toFixed(1),"%"))))))}function ut({tensegrity:e,clickDetails:t}){const[n,a]=Object(s.useRecoilState)(_e),[o]=Object(s.useRecoilState)(Ie),c=e.instance;return r.createElement("group",null,e.intervals.map(t=>{if(!y(t.intervalRole)){if(!n)return;if(!n.pushes.find(e=>X(e,t)))return}const s=Q(c.unitVector(t.index)),o=c.jointDistance(t.alpha,t.omega),l=rt(t,Be.Select),u=new i.Vector3(l,o,l);return r.createElement("mesh",{key:"T".concat(t.index),geometry:at,position:c.intervalLocation(t),rotation:(new i.Euler).setFromQuaternion(s),scale:u,material:nt(t.intervalRole),matrixWorldNeedsUpdate:!0,onDoubleClick:r=>{if(r.stopPropagation(),y(t.intervalRole))if(n){const r=n.pushes.find(e=>e.index===t.index);a(r?void 0:e.findTwist(t))}else a(e.findTwist(t))}})}),o.map(n=>r.createElement(lt,{key:"deets-".concat(n.interval.index),instance:e.instance,details:n,singleDetails:1===o.length,onClick:t})))}const ht=new i.MeshPhongMaterial({color:new i.Color("#070707"),specular:new i.Color("#110404"),side:i.FrontSide}),dt=[new i.Vector3(0,0,-20),new i.Vector3(-17.32,0,-10),new i.Vector3(-17.32,0,10),new i.Vector3(0,0,20),new i.Vector3(17.32,0,10),new i.Vector3(17.32,0,-10),new i.Vector3],mt=[6,0,1,6,1,2,6,2,3,6,3,4,6,4,5,6,5,0].map(e=>dt[e]);function ft(){const e=Object(r.useMemo)(()=>function(){const e=new i.BufferGeometry,t=new Float32Array(3*mt.length),n=new Float32Array(3*mt.length);return mt.forEach((e,r)=>{const a=3*r;t[a]=e.x,t[a+1]=e.y-.01,t[a+2]=e.z;const s=new i.Vector3(0,300,0).add(e).normalize();n[a]=s.x,n[a+1]=s.y,n[a+2]=s.z}),e.setAttribute("position",new i.BufferAttribute(t,3)),e.setAttribute("normal",new i.BufferAttribute(n,3)),e}(),[]);return r.createElement("mesh",{name:"Patches",geometry:e,material:ht})}function gt({tensegrity:e,clickDetails:t}){const[n]=Object(s.useRecoilState)(Le),[a]=Object(s.useRecoilState)(_e),[c,l]=Object(r.useState)(new i.Vector3),[u,h]=Object(r.useState)(e.stage$.getValue());Object(r.useEffect)(()=>{const t=e.stage$.subscribe(h);return()=>t.unsubscribe()},[e]);const[d]=Object(s.useRecoilState)(Te),m=Object(r.useRef)();Object(r.useEffect)(()=>{m.current&&m.current.position.set(0,5,5*e.instance.view.radius())},[]),Object(M.b)(()=>{if(!m.current)return;n===Be.Time&&e.iterate();const t=a?e.instance.twistLocation(a):e.instance.midpoint,r=(new i.Vector3).subVectors(t,c).multiplyScalar(.1);(n===Be.Time||r.lengthSq()>.001)&&l((new i.Vector3).copy(c).add(r));const s=m.current.position;if(u===o.Stage.Growing){s.y+=.1*(t.y-s.y);const n=s.distanceTo(t)-2.5*e.instance.view.radius(),r=(new i.Vector3).subVectors(t,s).normalize().multiplyScalar(.1*n);s.add(r)}else s.y<0&&(s.y-=.1*s.y*20)});const f=()=>{switch(n){case Be.Time:return r.createElement(st,{tensegrity:e});case Be.Select:return r.createElement(ut,{tensegrity:e,clickDetails:t});case Be.Look:return r.createElement(it,{tensegrity:e})}};return r.createElement("group",null,r.createElement(Xe.a,{ref:m,makeDefault:!0}),r.createElement(Ke.a,{autoRotate:d,target:c,zoomSpeed:.5}),r.createElement("scene",null,r.createElement(f,null),r.createElement(ft,null),r.createElement(Ze.a,null),r.createElement("ambientLight",{color:new i.Color("white"),intensity:.8}),r.createElement("directionalLight",{color:new i.Color("#FFFFFF"),intensity:2})))}function pt({tenscript:e,createInstance:t}){const n=Object(r.useMemo)(()=>t(e.featureValues),[]),[a,c]=Object(r.useState)(),[l,h]=Object(s.useRecoilState)(Le),[d,m]=Object(s.useRecoilState)(_e),[f,g]=Object(s.useRecoilState)(Ie),w=Object(s.useSetRecoilState)(Pe),b=e=>console.error("build view",e),[v,S]=Object(r.useState)();Object(r.useEffect)(()=>{const e=a?a.stage$.subscribe(S):void 0;return()=>{e&&e.unsubscribe()}},[a]);Object(r.useEffect)(()=>{((e,t)=>{try{const r=pe(e,t);if(!r)return!1;h(Be.Time),w(e.postGrowthOp);const a=e.featureValues;p.map(e=>{const t=o.WorldFeature[e],{percentToValue:r}=u(t),s=a?a[e]:void 0;void 0!==s&&n.applyFeature(t,s,r(s))});const s=a?a[o.WorldFeature.IntervalCountdown]:void 0,l=void 0===s?Object(o.default_world_feature)(o.WorldFeature.IntervalCountdown):s,d=new we(new i.Vector3,e,r);c(new ge(n,l,d))}catch(r){throw new Error("Problem running")}})(e,b)},[]),Object(r.useEffect)(()=>{l===Be.Time&&m(void 0)},[l]),Object(r.useEffect)(()=>{a&&g(d?d.pushes.map(e=>a.getIntervalDetails(e)):[])},[d]);const x=()=>{switch(l){case Be.Time:return r.createElement("span",null,void 0!==v?E(v):"New"," ",a?'"'.concat(a.name,'"'):"");case Be.Select:return r.createElement("span",null,"Double click to select a twist");case Be.Look:return r.createElement("span",null,a?'"'.concat(a.name,'"'):"")}},k=Object(s.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},a?r.createElement("div",{className:"h-100"},r.createElement(M.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:l!==Be.Time?"#f0ad4e":"black",cursor:l===Be.Select?"pointer":"default",borderWidth:"2px"}},r.createElement(k,null,r.createElement(gt,{tensegrity:a,clickDetails:({interval:e})=>{d&&a&&(1===f.length||y(e.intervalRole)?g(d.adjacentPulls.map(e=>a.getIntervalDetails(e))):g(f.filter(t=>t.interval.index===e.index)))}}))),r.createElement("div",{id:"top-middle"},r.createElement(x,null)),r.createElement("div",{id:"bottom-left"},r.createElement(ze,null)),r.createElement("div",{id:"bottom-right"},r.createElement(Qe,{tensegrity:a}))):r.createElement("div",{className:"h-100"},r.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},r.createElement("h1",null,r.createElement(N.u,null)))))}const wt=[{x:0,y:0},{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1},{x:4,y:0},{x:3,y:-1},{x:2,y:-2},{x:0,y:-2},{x:-2,y:-2},{x:-3,y:-1},{x:-4,y:0},{x:-3,y:1},{x:-2,y:2},{x:0,y:2},{x:2,y:2},{x:3,y:1},{x:6,y:0},{x:5,y:-1},{x:4,y:-2},{x:3,y:-3},{x:1,y:-3},{x:-1,y:-3},{x:-3,y:-3},{x:-4,y:-2},{x:-5,y:-1},{x:-6,y:0},{x:-5,y:1},{x:-4,y:2},{x:-3,y:3},{x:-1,y:3},{x:1,y:3},{x:3,y:3},{x:4,y:2},{x:5,y:1}],bt=[{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1}],yt=Math.sin(60*Math.PI/180),Et=17.5/yt,vt=Et*yt,St=1.5*Et,xt=[new i.Vector3(0,0,-Et),new i.Vector3(-yt*Et,0,-Et/2),new i.Vector3(-yt*Et,0,Et/2),new i.Vector3(0,0,Et),new i.Vector3(yt*Et,0,Et/2),new i.Vector3(yt*Et,0,-Et/2)],kt=new i.Color("#091009"),jt=new i.Color("#100902"),Ct=new i.Vector3(0,1,0),Ot=new i.Vector3(0,500,0);class At{constructor(e,t){this.roll=e,this.genes=t}createReader(e){return new Pt(zt(e,this.genes),this.roll)}get totalTwitches(){return 16}withMutations(e,t){const n=this.genes.map(e=>{const{geneName:t,tosses:n}=e;return{geneName:t,tosses:n,dice:e.dice.slice()}});if(e.forEach(e=>{Dt(()=>this.roll(),zt(e,n))}),t){const e=zt(Mt.TwitchConfig,n);Dt(()=>this.roll(),e),e.tosses++}return new At(this.roll,n)}get geneData(){return this.genes.map(e=>{const{geneName:t,tosses:n,dice:r}=e;return{geneName:t,tosses:n,geneString:function(e){return e.map(e=>e.symbol).join("")}(r)}})}get tosses(){return this.genes.reduce((e,{tosses:t})=>e+t,0)}toString(){return this.genes.map(e=>"(".concat(e.geneName,":").concat(e.tosses,")")).join(", ")}}class Pt{constructor(e,t){this.gene=e,this.roll=t,this.cursor=0}chooseFrom(e){return Math.floor(e*Lt(this.nextDie(),this.nextDie()))}readMuscleTwitch(e,t){const{attackPeriod:n,decayPeriod:r,twitchNuance:a}=t;return{muscle:e[this.nextDie().index],twitchNuance:a,when:Vt(36,this.nextDie(),this.nextDie()),attack:(2+Tt(6,this.nextDie()))*n,decay:(2+Tt(6,this.nextDie()))*r}}readFeatureValue(e,t){const n=Lt(this.nextDie(),this.nextDie(),this.nextDie());return e*n+t*(1-n)}get length(){return this.gene.dice.length}nextDie(){for(;this.gene.dice.length<this.cursor+1;)this.gene.dice.push(this.roll());return this.gene.dice[this.cursor++]}}const Ft=[{index:0,numeral:"1",symbol:"\u2680"},{index:1,numeral:"2",symbol:"\u2681"},{index:2,numeral:"3",symbol:"\u2682"},{index:3,numeral:"4",symbol:"\u2683"},{index:4,numeral:"5",symbol:"\u2684"},{index:5,numeral:"6",symbol:"\u2685"}],Rt=(()=>{const e={};return Ft.forEach(t=>{e[t.numeral]=t,e[t.symbol]=t}),e})();function Vt(e,...t){return Math.floor(Lt(...t)*e)}function Tt(e,...t){return Lt(...t)*e}function Dt(e,t){if(0===t.dice.length)t.dice.push(e());else{const n=Math.floor(Math.random()*t.dice.length),r=t.dice[n];for(;t.dice[n]===r;)t.dice[n]=e()}t.tosses++}function Bt(){return Ft[Math.floor(Math.random()*Ft.length)]}function Lt(...e){if(0===e.length)throw new Error("No dice!");return e.reduce((e,t)=>6*e+t.index,0)/Math.pow(6,e.length)}let Mt,Nt;function _t(){return new At(Bt,[])}function It(e){if(0===e.length)return _t();const t=e.map(({geneName:e,tosses:t,geneString:n})=>({geneName:e,tosses:t,dice:n.split("").map(e=>Rt[e]).filter(e=>!!e)}));return new At(Bt,t)}function zt(e,t){const n=t.find(({geneName:t})=>e===t);if(n)return n;const r={geneName:e,tosses:0,dice:[]};return t.push(r),r}!function(e){e.ToA="ToA",e.ToB="ToB",e.ToC="ToC",e.TwitchConfig="TwitchConfig"}(Mt||(Mt={}));class Gt{constructor(e,t,n){this.island=e,this.coords=t,this.patchCharacter=n,this.runner=void 0,this.flora=void 0,this.center=void 0,this.name=void 0,this.adjacent=[],this.center=new i.Vector3(t.x*vt,0,t.y*St),this.name="(".concat(t.x,",").concat(t.y,")")}get storedGenes(){const e=localStorage.getItem(this.name);return e?JSON.parse(e):[_t().geneData]}set storedGenes(e){localStorage.setItem(this.name,JSON.stringify(e))}get positionArray(){const e=new Float32Array(54);let t=0;const n=n=>{const{x:r,y:a,z:s}=(new i.Vector3).copy(this.center).addScaledVector(n,.99);e[t++]=r,e[t++]=a,e[t++]=s};for(let r=0;r<6;r++){const e=(r+1)%6;n(new i.Vector3),n(xt[r]),n(xt[e])}return e}get normalArray(){const e=new Float32Array(54);let t=0;const n=({x:n,y:r,z:a})=>{e[t++]=n,e[t++]=r,e[t++]=a};for(let r=0;r<6;r++){const e=(r+1)%6;n(Ct),n((new i.Vector3).add(Ct).addScaledVector(xt[r],.9/35).normalize()),n((new i.Vector3).add(Ct).addScaledVector(xt[e],.9/35).normalize())}return e}}!function(e){e.FaunaPatch="Fauna",e.FloraPatch="Flora"}(Nt||(Nt={}));const Wt={name:"Runner",spin:_.LeftRight,code:["(A1,B(".concat(5,",S").concat(90,"),C(").concat(5,",S").concat(90,"),D(").concat(5,",S").concat(90,"))")],postGrowthOp:de.Bowtie,markDefStrings:{},surfaceCharacter:o.SurfaceCharacter.Bouncy,featureValues:{[o.WorldFeature.IterationsPerFrame]:300,[o.WorldFeature.Drag]:200,[o.WorldFeature.StiffnessFactor]:150,[o.WorldFeature.Gravity]:500}},Jt=(de.Bowtie,_.Left,o.SurfaceCharacter.Frozen,Object(s.atom)({key:"island",default:new class{constructor(e,t){this.name=e,this.patches=[],this._seed=void 0,this._seed=t%2147483647,this.fill()}get midpoint(){return this.patches.reduce((e,t)=>e.add(t.center),new i.Vector3).multiplyScalar(1/this.patches.length)}findPatch(e){return this.patches.find(t=>{return n=t.coords,r=e,n.x===r.x&&n.y===r.y;var n,r})}fill(){this.createSurroundedPatch({x:0,y:0}),this.patches.forEach(e=>{const t=e.coords;bt.forEach(({x:n,y:r})=>{e.adjacent.push(this.findPatch({x:n+t.x,y:r+t.y}))})})}createSurroundedPatch(e){const t=this.getOrCreatePatch(e);return wt.map(t=>{return this.getOrCreatePatch((r=e,{x:(n=t).x+r.x,y:n.y+r.y}));var n,r}),t}getOrCreatePatch(e){const t=this.findPatch(e);if(t)return t;const n=this.next()>.5?Nt.FaunaPatch:Nt.FloraPatch,r=new Gt(this,e,n);return this.patches.push(r),r}next(){return this._seed=16807*this._seed%2147483647,(this._seed-1)/2147483646}}("galapagos",383)})),Ht=Object(s.selector)({key:"MySelector",get:({get:e})=>e(Jt).patches[0]}),Ut=Object(s.atom)({key:"destination",default:0}),qt=Object(s.atom)({key:"showDetails",default:!1});var $t=n(108);let Qt;!function(e){e.Rest="Rest",e.ToA="ToA",e.ToB="ToB",e.ToC="ToC"}(Qt||(Qt={}));const Xt=Object.keys(Qt).map(e=>Qt[e]);function Kt(e){switch(e){case Qt.ToA:return Mt.ToA;case Qt.ToB:return Mt.ToB;case Qt.ToC:return Mt.ToC;default:throw new Error("No gene for direction ".concat(e))}}function Zt(e,t,n,r,a){if(!a)return;const s=a.joint;if(!s)return;const i=e.floatView.jointLocations,o=(e,t,n)=>{const r=3*e.index,a=3*t.index;n.set(i[a]-i[r],0,i[a+2]-i[r+2]),n.normalize()};o(s,a.ends[0],t),o(s,a.ends[1],n),o(s,a.ends[2],r)}const Yt=[4,5,6,7,8,9],en=8,tn=8;let nn;!function(e){e.SurvivorsAdvance="Survivors advance",e.ChallengersBorn="Challengers born",e.ChallengersReborn="Challengers reborn",e.ChallengersOvertake="Challengers try to overtake",e.SurvivorsStored="Survivors stored",e.EvolutionAdvance="Evolution advance",e.EvolutionDone="Evolution done",e.EvolutionHarder="Evolution harder"}(nn||(nn={}));class rn{constructor(e,t,n,r){if(this.ancestor=e,this.createInstance=t,this.useTwitches=n,this.cyclePattern=r,this.snapshotsSubject=new se.a([]),this.winners=[],this.midpoint=void 0,this.challengersVisible=!1,this.challengers=[],this.phase=nn.SurvivorsAdvance,this.cyclePatternIndex=void 0,this.currentCycle=0,this.currentMaxCycles=void 0,e.embryo)throw new Error("Cannot create evolution from runner which is not pretenst");this.midpoint=e.state.midpoint,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex=0];const a=[],s=e.state.patch.storedGenes;for(;a.length<en;)a.push(this.createAutoRunner(It(s[a.length%s.length])));this.winners=a.map((e,t)=>({runner:e,name:on(t),proximityHistory:[],persisted:!0}))}get withReducedCyclePattern(){const e=[...this.cyclePattern];if(e.pop(),!(e.length<3))return new rn(this.ancestor,this.createInstance,this.useTwitches,e)}iterate(){switch(this.phase){case nn.SurvivorsAdvance:let e=0,t=!1;if(this.winners.forEach(({runner:n})=>{const r=n.getCycleCount(this.useTwitches);r>e&&(e=r),r<this.currentMaxCycles&&(n.iterate(),t=!0)}),e>this.currentCycle&&(an(this.winners,this.currentCycle),this.currentCycle=e),!t){!this.winners.find(({runner:e})=>!e.reachedTarget)?this.phase=nn.EvolutionDone:(this.winners.forEach(e=>e.runner.showFrozen()),this.phase=0===this.challengers.length?nn.ChallengersBorn:nn.ChallengersReborn,this.currentCycle=0)}break;case nn.ChallengersBorn:const n=[];for(;n.length<tn;){const e=It(this.winners[n.length%this.winners.length].runner.state.genome.geneData);n.push(this.createAutoRunner(e.withMutations([Kt(this.ancestor.direction)],!1)))}this.challengers=n.map((e,t)=>{e.autopilot=!0;return{runner:e,name:"".concat(on(t+this.winners.length)).concat(on(t%this.winners.length)),proximityHistory:[],persisted:!1}}),this.phase=nn.ChallengersOvertake;break;case nn.ChallengersReborn:let r=0;this.challengers=this.challengers.map((e,t)=>{const n=r++%this.winners.length,a=this.winners[n],s=e.runner.adoptFabric(this.ancestor.state.instance.fabricClone),i=e.runner.recycled(s,a.runner.mutatedGeneData()),o="".concat(a.name).concat(on(t));return i.autopilot=!0,{runner:i,name:o,proximityHistory:[],persisted:!1}}),this.phase=nn.ChallengersOvertake;break;case nn.ChallengersOvertake:this.challengersVisible=!0;let a=!1,s=0;if(this.challengers.forEach(({runner:e,name:t})=>{const n=e.getCycleCount(this.useTwitches);n>s&&(s=n),n<this.currentMaxCycles&&(e.iterate(),a=!0)}),s>this.currentCycle){const e=[...this.winners,...this.challengers];an(e,this.currentCycle),this.broadcastSnapshot(e.map(e=>sn(e,this.currentCycle))),this.currentCycle=s}a||(this.phase=nn.SurvivorsStored);break;case nn.SurvivorsStored:const{winners:i,losers:o}=this.splitEvolvers(this.currentCycle);this.ancestor.state.patch.storedGenes=i.map(({runner:e})=>e.state.genome.geneData),i.forEach(e=>e.persisted=!0),o.forEach(e=>e.persisted=!1),this.broadcastSnapshot(i.map(e=>sn(e,this.currentCycle))),this.winners=i,this.challengers=o,this.challengersVisible=!1,this.phase=nn.EvolutionAdvance;break;case nn.EvolutionAdvance:if(this.cyclePatternIndex===this.cyclePattern.length-1){const e=!this.winners.find(({runner:e})=>!e.reachedTarget);this.phase=e?nn.EvolutionHarder:nn.EvolutionDone}else this.cyclePatternIndex++,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex],this.currentCycle=0,this.phase=nn.SurvivorsAdvance;break;case nn.EvolutionDone:case nn.EvolutionHarder:}return this.midpoint.set(0,0,0),this.winners.forEach(({runner:e})=>this.midpoint.add(e.state.midpoint)),this.challengers.forEach(({runner:e})=>this.midpoint.add(e.state.midpoint)),this.midpoint.multiplyScalar(1/(this.winners.length+this.challengers.length)),this.phase}get target(){return this.ancestor.target}splitEvolvers(e){const t=[],n=[],r=[...this.winners,...this.challengers];return an(r,e),r.forEach((e,r)=>{r<en?t.push(e):n.push(e)}),{cycleCount:e,winners:t,losers:n}}broadcastSnapshot(e){const t=this.currentCycle,n=this.cyclePatternIndex,r={cycle:t,cyclePattern:this.cyclePattern,cycleIndex:n,evolverSnapshots:e},a=this.snapshotsSubject.getValue(),s=a.findIndex(e=>r.cycleIndex===e.cycleIndex);if(s<0)this.snapshotsSubject.next([...a,r]);else if(s===a.length-1){const e=[...a];e[s]=r,this.snapshotsSubject.next(e)}else this.snapshotsSubject.next([r])}createAutoRunner(e){const t=this.createInstance(Wt.featureValues,this.ancestor.state.instance.fabricClone),n=this.ancestor.recycled(t,e.geneData);return n.autopilot=!0,n}}function an(e,t){e.forEach(e=>{if(e.proximityHistory.length===t){const t=e.runner.distanceFromTarget;e.proximityHistory.push(t)}}),e.sort((e,n)=>e.proximityHistory[t]-n.proximityHistory[t])}function sn({runner:e,proximityHistory:t,persisted:n,name:r},a){const s=t[a];if(void 0===s)throw new Error("Cannot snapshot");const i=e.state.genome.tosses;return{name:r,proximity:s,reachedTarget:e.reachedTarget,tosses:i,persisted:n}}function on(e){return String.fromCharCode(65+e)}function cn({runner:e}){const{topFaceLocation:t,target:n,state:a,showDirection:s}=e,i=a.instance.floatView;return r.createElement("group",null,r.createElement("lineSegments",{geometry:i.lineGeometry,onUpdate:e=>e.geometry.computeBoundingSphere()},r.createElement("lineBasicMaterial",{attach:"material",vertexColors:!0})),s&&t?r.createElement("group",null,r.createElement("lineSegments",null,r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([t.x,t.y,t.z,n.x,t.y,n.z]),count:2,itemSize:3,onUpdate:e=>e.needsUpdate=!0})),r.createElement("lineBasicMaterial",{attach:"material",color:"#FFFFFF"})),r.createElement("lineSegments",{quaternion:e.directionQuaternion,position:t},r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([0,0,0,0,0,5]),count:2,itemSize:3,onUpdate:e=>e.needsUpdate=!0})),r.createElement("lineBasicMaterial",{attach:"material",color:"#f80303"}))):void 0)}function ln({population:e}){const{midpoint:t,target:n}=e;return r.createElement("group",null,e.winners.map(({runner:e},t)=>r.createElement(cn,{key:"evolving-".concat(t),runner:e})),e.challengersVisible?e.challengers.map(({runner:t},n)=>r.createElement(cn,{key:"evolving-".concat(n+e.winners.length),runner:t})):void 0,r.createElement("lineSegments",null,r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([t.x,0,t.z,t.x,6,t.z,t.x,6,t.z,n.x,6,n.z,n.x,6,n.z,n.x,0,n.z]),count:6,itemSize:3,onUpdate:e=>e.needsUpdate=!0})),r.createElement("lineBasicMaterial",{attach:"material",color:"#ffffff"})))}function un({island:e,happening:t,runner:n,population:a,evolutionPhase:o,countdownToEvo:c,stopEvo:l}){const[u,h]=Object(r.useState)(!1),[d,m]=Object(s.useRecoilState)(Ut),[f,g]=Object(r.useState)(Date.now()),[p,w]=Object(r.useState)(Date.now()),[b,y]=Object(r.useState)(new i.Vector3(0,1,0)),[E,v]=Object(r.useState)(new i.Vector3(0,1,10));function S(e){y((new i.Vector3).subVectors(e,b).multiplyScalar(.05).add(b))}return Object(M.b)(()=>{const e=e=>{const t=(new i.Vector3).subVectors(E,b),n=e-t.length();t.normalize(),E.y+=.01*(3-E.y),v(E.add(t.multiplyScalar(.003*n)))};switch(t){case pn.Developing:n&&(n.iterate(),S(n.state.midpoint),e(6));break;case pn.Resting:n&&(n.iterate(),S(n.state.midpoint),e(8));break;case pn.Running:n&&(n.iterate(),S(n.state.midpoint),e(6));break;case pn.Evolving:if(a){switch(a.iterate()){case nn.EvolutionDone:console.log("Evolution DONE"),l();break;case nn.EvolutionHarder:console.log("Evolution advance..."),l(a.withReducedCyclePattern)}S(a.midpoint),e(15),o(a.phase)}}const r=Math.floor((p-f)/1e3),s=Date.now();w(s);const u=Math.floor((s-f)/1e3);t===pn.Resting&&r<u&&c(5-u)}),Object(r.useEffect)(()=>{g(Date.now()),w(Date.now()),h(t===pn.Evolving)},[t]),r.createElement("group",null,r.createElement(Ke.a,{target:b,autoRotate:u,enablePan:!1,position:E,autoRotateSpeed:.6,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.8*Math.PI}),r.createElement("scene",null,a&&t===pn.Evolving?r.createElement(ln,{population:a}):n?r.createElement(cn,{runner:n}):void 0,e.patches.map(e=>{const t=e.positionArray,a=e.normalArray;return r.createElement("mesh",{key:"patch-".concat(e.name),onClick:()=>function(e){e.flora?(e.flora.removeRandomInterval(),console.log("remove",e.name)):n&&n.direction===Qt.Rest&&m((d+1)%6)}(e)},r.createElement("meshPhongMaterial",{attach:"material",side:i.DoubleSide,color:e.patchCharacter===Nt.FaunaPatch?kt:jt}),r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:t,count:t.length/3,itemSize:3}),r.createElement("bufferAttribute",{attachObject:["attributes","normal"],array:a,count:a.length/3,itemSize:3})))}),r.createElement($t.a,{distance:1e6,rayleigh:3,inclination:.505,mieCoefficient:.001,mieDirectionalG:.93,turbidity:7.5}),r.createElement("pointLight",{distance:1e3,decay:.1,position:Ot}),r.createElement("hemisphereLight",{name:"Hemi"})))}class hn{constructor(e){this.state=e,this.cycleCount=0,this.twitchCount=0,this.config=void 0,this.twitchCycles={};const t=this.state.genome;this.config=(()=>{const e=t.createReader(Mt.TwitchConfig),n=e.readFeatureValue(800,1200);return{twitchNuance:e.readFeatureValue(.1,.3),musclePeriod:n,attackPeriod:e.readFeatureValue(.5,1)*n,decayPeriod:e.readFeatureValue(.5,1)*n}})();const n=t.totalTwitches;Xt.filter(e=>e!==Qt.Rest).forEach(e=>{const r=Kt(e),a=t.createReader(r);this.twitchCycles[e]=new dn(a,this.config,this.state.loopMuscles,n)})}toString(){const e=Object.keys(this.twitchCycles).map(e=>this.twitchCycles[e]).map(e=>e.toString()).join("\n");return"Twitcher(".concat(e,")")}tick(e){const t=this.state;if(t.timeSlice++,t.timeSlice>=36)return t.timeSlice=0,this.cycleCount++,!0;const n=this.twitchCycles[t.direction];return n&&(this.twitchCount+=n.activate(t.timeSlice,e)),!1}}class dn{constructor(e,t,n,r){this.slices={};const a=[...n];for(;r-- >0;){const n=e.chooseFrom(a.length),r=e.readMuscleTwitch(a[n],t);a.splice(n,1),this.addTwitch(r.when,r)}}toString(){const e=Object.keys(this.slices).map(e=>this.slices[e]).map(e=>e.map(e=>"".concat(e.when,":").concat(e.muscle.interval.index)).join(";")).join(",");return"Cycle(".concat(e,")")}activate(e,t){const n=this.slices[e];return n?(n.forEach(({muscle:e,attack:n,decay:r,twitchNuance:a})=>t(e,n,r,a)),n.length):0}addTwitch(e,t){const n=this.slices[e];n?n.push(t):this.slices[e]=[t]}}class mn{constructor(e,t){this.state=e,this.embryo=t,this.toA=new i.Vector3(1,0,0),this.toB=new i.Vector3(0,0,1),this.toC=new i.Vector3(0,0,-1),this.shapingTime=150,this.twitcher=void 0,this.topFace=void 0,this.currentTwitchAge=0,t||(this.twitcher=new hn(this.state)),this.currentTwitchAge=this.twitchAge}get growing(){return!!this.embryo}recycled(e,t){const n=It(t||this.state.patch.storedGenes[0]),r=(new i.Vector3).copy(this.state.midpoint),a={...this.state,instance:e,midpoint:r,genome:n,directionHistory:[]},s=new mn(a);return s.topFace=this.topFace,Zt(s.state.instance,s.toA,s.toB,s.toC,this.topFace),s}getCycleCount(e){return this.twitcher?e?Math.floor(this.twitcher.twitchCount/this.state.twitchesPerCycle):this.twitcher.cycleCount:0}get autopilot(){return this.state.autopilot}set autopilot(e){this.state.autopilot=e}get direction(){return this.state.direction}set direction(e){this.state.direction=e,this.autopilot=!1}adoptFabric(e){return this.state.instance.adoptFabric(e)}mutatedGeneData(){const e=Xt.map(e=>{const t=this.state.directionHistory.filter(t=>t===e).length;return{dir:e,count:t}}).filter(e=>e.count>0).map(e=>e.dir).map(Kt);return this.state.genome.withMutations(e,Math.random()>.9).geneData}get age(){return this.state.instance.fabric.age}get distanceFromTarget(){return this.state.midpoint.distanceTo(this.target)}iterate(){const e=this.state.instance.view;this.state.midpoint.set(e.midpoint_x(),e.midpoint_y(),e.midpoint_z());const t=this.embryo;if(!t){if(this.state.instance.iterate(),this.twitcher){const e=this.twitchAge;if(e<=this.currentTwitchAge)return!0;this.currentTwitchAge=e;const t=(e,t,n,r)=>{const a=e=>{e&&this.state.instance.fabric.twitch_interval(e.index,t,n,r)};a(e.alphaInterval),a(e.omegaInterval)};this.state.autopilot&&this.twitcher.tick(t)&&(this.reachedTarget?this.direction=Qt.Rest:this.checkDirection())}return!0}if(t.iterate())return!0;switch(t.stage$.getValue()){case o.Stage.Shaping:return this.shapingTime<=0?t.stage=o.Stage.Slack:this.shapingTime--,!1;case o.Stage.Slack:return this.topFace=function(e){const t=e.faces.sort((t,n)=>{const r=t.joint,a=n.joint;if(!r||!a)throw new Error("faces without joints");const s=e.instance.jointLocation(r),i=e.instance.jointLocation(a);return s.y-i.y}),n=t.pop();if(t.forEach(t=>e.faceToTriangle(t)),!n)throw new Error("no top face");return n}(t),t.stage=o.Stage.Pretensing,!1;case o.Stage.Pretensing:return!1;case o.Stage.Pretenst:return this.state.loopMuscles=function(e){const t=[];return e.withPulls(()=>{e.loops.forEach(e=>t.push(e.map(e=>{const t=e.alpha.pulls,n=e.omega.pulls;if(!t||!n)throw new Error("missing pulls");const r=({intervalRole:e})=>e===f.PullAA||e===f.PullBB,a=t.find(r),s=n.find(r);if(!a&&!s)throw new Error("cannot find any intervals");return{interval:e,alphaInterval:a,omegaInterval:s}})))}),t}(t),this.state.instance.refreshFloatView(),Zt(this.state.instance,this.toA,this.toB,this.toC,this.topFace),this.checkDirection(),this.twitcher=new hn(this.state),this.embryo=void 0,!0;default:return!1}}showFrozen(){this.state.instance.showFrozen(this.reachedTarget)}get topFaceLocation(){const e=this.topFace;if(!e)return;const t=e.joint;return t?this.state.instance.jointLocation(t):void 0}get target(){return this.state.targetPatch.center}get showDirection(){return this.state.direction!==Qt.Rest}get directionQuaternion(){return this.quaternionForDirection(this.state.direction)}get reachedTarget(){return this.distanceFromTarget<4}checkDirection(){const e=this.state;if(this.reachedTarget)this.direction=Qt.Rest;else{if(e.direction=this.directionToTarget,e.direction===Qt.Rest)return void console.error("direction is REST??");e.directionHistory.push(e.direction),e.directionHistory.length>20&&e.directionHistory.shift()}}get twitchAge(){return this.state.instance.fabric.age/600}quaternionForDirection(e){return(new i.Quaternion).setFromUnitVectors(h,(()=>{switch(e){case Qt.Rest:case Qt.ToA:return this.toA;case Qt.ToB:return this.toB;case Qt.ToC:return this.toC}})())}get directionToTarget(){const e=this.toTarget;Zt(this.state.instance,this.toA,this.toB,this.toC,this.topFace);const t=e.dot(this.toA),n=e.dot(this.toB),r=e.dot(this.toC);return t>n&&t>r?Qt.ToA:n>t&&n>r?Qt.ToB:r>t&&r>n?Qt.ToC:Qt.Rest}get toTarget(){const e=new i.Vector3;return e.subVectors(this.target,this.state.midpoint),e.y=0,e.normalize(),e}}function fn({snapshots:e}){const t=Object(s.useSetRecoilState)(qt);return r.createElement("div",{className:"text-monospace d-inline-flex",onClick:()=>t(!1)},e.map(e=>r.createElement("div",{key:e.cycleIndex,className:"float-left p-1 m-1",style:{borderStyle:"solid",borderWidth:"2px"}},r.createElement(gn,{snapshot:e}),r.createElement("div",{className:"m-2"},e.evolverSnapshots.map((e,t)=>{const{name:n,reachedTarget:a,persisted:s,proximity:i,tosses:o}=e,c=[];let l=n.length-1;for(;l>0;)c.push(r.createElement(N.j,{key:"".concat(n,"-").concat(l)})),l--;const u=a?r.createElement(N.C,null):void 0;return r.createElement("div",{key:"competitor-".concat(t),style:{color:s?a?"#ffffff":"#2cd710":"#c2c2c2",backgroundColor:s?a?"#b1b1b1":"#848383":"#555454",borderRadius:"0.2em",marginBottom:"1px",padding:"2px",display:"block",whiteSpace:"nowrap"}},"".concat(on(t)," ").concat(i.toFixed(3)," ").concat(n).concat(o),"\xa0",c,u)})))))}function gn({snapshot:e}){const{cyclePattern:t,cycleIndex:n,cycle:a}=e,i=Object(s.useSetRecoilState)(qt);return r.createElement("div",{className:"p-1 my-2 w-100 text-center",onClick:()=>i(!1)},t.map((e,s)=>r.createElement("span",{key:"cycle-".concat(s),style:{color:"black",backgroundColor:s===n?"#24f00f":"#cbc7c7",margin:"0.1em",padding:"0.2em",borderRadius:"0.3em",borderStyle:"solid",borderWidth:"1px"}},s===n&&a<t[n]?"".concat(a+1,"/").concat(e):e)))}let pn;function wn({createBodyInstance:e}){const[t]=Object(s.useRecoilState)(Jt),n=Object(s.useRecoilValue)(Ht),a=Object(s.useRecoilValue)(Ut),[c,l]=Object(s.useRecoilState)(qt),[u,h]=Object(r.useState)(()=>O(n)),[d,m]=Object(r.useState)(pn.Developing),[f,g]=Object(r.useState)([]),[p,w]=Object(r.useState)(-1),[b,y]=Object(r.useState)(void 0),[S,x]=Object(r.useState)(nn.SurvivorsAdvance),[k,C]=Object(r.useState)(void 0);function O(t){const n=t.adjacent[0];if(!n)throw new Error("No adjacent");const r=t.storedGenes[0],a=r?It(r):_t(),s=e(Wt.featureValues);s.world.set_surface_character(o.SurfaceCharacter.Sticky);const c={patch:t,targetPatch:n,instance:s,midpoint:(new i.Vector3).copy(t.center),genome:a,loopMuscles:[],direction:Qt.ToA,directionHistory:[],autopilot:!1,timeSlice:10,twitchesPerCycle:10},l=pe(Wt,e=>{throw new Error("unable to compile runner: "+e)});if(!l)throw new Error("no tree");const u=new we(t.center,Wt,l),h=new ge(s,1e3,u);return new mn(c,h)}Object(r.useEffect)(()=>{if(u){const e=u.state.patch.adjacent[a];e&&(u.state.targetPatch=e)}},[a]),Object(r.useEffect)(()=>{if(!u||!u.embryo)return void C(void 0);const e=u.embryo.stage$.subscribe(e=>{e===o.Stage.Pretenst&&m(pn.Resting),C(e)});return()=>e.unsubscribe()},[u]),Object(r.useEffect)(()=>{if(!b)return;const e=b.snapshotsSubject.subscribe(g);return()=>e.unsubscribe()},[b]);const A=(t,n)=>{y(b?b.withReducedCyclePattern:new rn(t,e,!1,n)),m(pn.Evolving)},P=Object(s.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},r.createElement(M.a,{key:t.name,style:{backgroundColor:"black"}},r.createElement(Xe.a,{makeDefault:!0}),r.createElement(P,null,r.createElement(un,{island:t,happening:d,runner:u,population:b,evolutionPhase:e=>{e!==S&&x(e)},countdownToEvo:e=>{w(e),u&&0===e&&A(u,Yt)},stopEvo:e=>{y(e),e||(h(O(n)),m(pn.Developing))}}))),u?d===pn.Developing?k?r.createElement("div",{id:"bottom-middle"},r.createElement("div",{className:"py-2 px-3 text-center"},r.createElement(N.b,null)," ",E(k))):r.createElement("h1",null,"nothing"):r.createElement(bn,{runner:u,happening:d,evoCountdown:p,toRunning:()=>{m(pn.Running),u.autopilot=!0},toEvolving:()=>{m(pn.Evolving),w(-1),A(u,Yt)},toRebirth:()=>{h(O(n)),m(pn.Developing)},toRest:()=>{m(pn.Resting),u.direction=Qt.Rest}}):r.createElement("h1",null,"no runner"),b?r.createElement(r.Fragment,null,r.createElement("div",{id:"top-middle"},c?void 0:r.createElement(L.a,{color:"info",onClick:()=>l(!0)},"Phase: ",S,r.createElement("br",null),0===f.length?void 0:r.createElement(gn,{snapshot:f[f.length-1]}))),c?r.createElement(yn,{happening:d,snapshots:f}):void 0):void 0,r.createElement("div",{id:"bottom-right"},r.createElement(B.a,{vertical:!1,className:"w-100"},r.createElement(L.a,{color:"warning",onClick:()=>j(v.Choice)},r.createElement(N.y,null)))))}function bn({runner:e,happening:t,evoCountdown:n,toRunning:a,toRest:s,toEvolving:i,toRebirth:o}){const c=(()=>{switch(t){case pn.Developing:return r.createElement("h1",null,"developing");case pn.Resting:return e?r.createElement(B.a,{className:"w-100"},r.createElement(L.a,{color:"success",onClick:a},r.createElement(N.w,null)),r.createElement(L.a,{color:"success",onClick:i},r.createElement(N.j,null)," ",n>=0?n:""),r.createElement(L.a,{color:"success",onClick:o},r.createElement(N.b,null))):void 0;case pn.Running:return e?r.createElement(B.a,{className:"w-100"},r.createElement(L.a,{color:"success",onClick:s},r.createElement(N.C,null)," Rest")):void 0;case pn.Evolving:return e?r.createElement(B.a,{className:"w-100"},r.createElement(L.a,{color:"success",onClick:o},r.createElement(N.b,null))):void 0}})();return c?r.createElement("div",{id:"bottom-middle"},c):r.createElement("h1",null,t)}function yn({happening:e,snapshots:t}){switch(e){case pn.Developing:case pn.Running:case pn.Resting:return r.createElement("div",null);case pn.Evolving:return r.createElement("div",{id:"evolution-stats"},t.length>0?r.createElement(fn,{snapshots:t}):r.createElement("h2",{className:"p-2"},"First round, please wait"))}}!function(e){e[e.Developing=0]="Developing",e[e.Resting=1]="Resting",e[e.Running=2]="Running",e[e.Evolving=3]="Evolving"}(pn||(pn={}));const En=[{name:"Phi",spin:_.LeftRight,postGrowthOp:de.NoOp,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["()"]},{name:"One",spin:_.Left,postGrowthOp:de.NoOp,surfaceCharacter:o.SurfaceCharacter.Bouncy,code:["(1)"],jobs:[{age:3e4,todo:"pretensing"}],featureValues:{[o.WorldFeature.IterationsPerFrame]:300}},{name:"Axoneme",spin:_.Left,surfaceCharacter:o.SurfaceCharacter.Frozen,postGrowthOp:de.Bowtie,code:["(30,S95)"]},{name:"Knee",spin:_.Left,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(3,b3)"]},{name:"Jack",spin:_.LeftRight,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(a2,b2,c2,d2)"]},{name:"Star",spin:_.LeftRight,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(a(15,S90),b(15,S90),c(15,S90),d(15,S90))"]},{name:"Tripod with Knees",spin:_.RightLeft,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(A5,B(7,c(5,S90),S90),C(7,c(5,S90),S90),D(7,c(5,S90),S90))"]},{name:"Zigzag",spin:_.LeftRight,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(c(3,MA1),d(7,b(7,c(7,d(7,c(7,d(3,MA1)))))))"],markDefStrings:{1:"join"}},{name:"Diamond",spin:_.RightLeft,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(","   a(5,","      b(5,b(5,b(2,MA3)),c(5,c(2,MA4))),","      c(5,b(5,b(2,MA1)),c(5,c(2,MA5))),","      d(5,b(5,b(2,MA6)),c(5,c(2,MA2)))","   )","   b(5,b(5,b(2,MA5)),c(5,c(2,MA3))),","   c(5,b(5,b(2,MA2)),c(5,c(2,MA1))),","   d(5,b(5,b(2,MA4)),c(5,c(2,MA6)))",")"],markDefStrings:{1:"join",2:"join",3:"join",4:"join",5:"join",6:"join"}},{name:"Composed Tree",spin:_.Left,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(6,b(4,MA1),c(4,MA1),d(4,MA1))"],markDefStrings:{1:"subtree(b5,c5,d5)"}},{name:"Equus Lunae",spin:_.LeftRight,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(","  A(16,S95,Md0),","  b(16,S95,Md0),","  a(16,S95,Md0),","  B(16,S95,Md0)",")"],markDefStrings:{0:"shaping-distance-60"}},{name:"Runner",spin:_.LeftRight,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Bouncy,code:["(A1,B(5,S90),C(5,S90),D(5,S90))"]},{name:"Infinity",spin:_.LeftRight,postGrowthOp:3,surfaceCharacter:2,code:["(","A(11,S88,MA1),b(11,S88,MA1),","a(11,S88,MA2),B(11,S88,MA2)",")"],featureValues:{},markDefStrings:{1:"join",2:"join"}},{name:"Propellor Tree",spin:_.LeftRight,postGrowthOp:3,surfaceCharacter:2,code:["(","  a(5,S110),","  B(11,S90,MA3),","  b(11,S90,MA1),","  C(11,S90,MA2),","  c(11,S90,MA3),","  D(11,S90,MA1),","  d(11,S90,MA2),",")"],featureValues:{},markDefStrings:{1:"join",2:"join",3:"join",4:"join"}},{name:"Halo by Crane",spin:_.Left,scale:100,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(5,S92,b(12,S92,MA1),d(11,S92,MA1))"],markDefStrings:{1:"join"},jobs:[{age:6e4,todo:"pretensing"}],featureValues:{[o.WorldFeature.Gravity]:50,[o.WorldFeature.IterationsPerFrame]:1e3}},{name:"Convergence",spin:_.LeftRight,scale:100,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(a2,b(10,S90,MA1),c(10,S90,MA1),d(10,S90,MA1))"],markDefStrings:{1:"join"},jobs:[{age:6e4,todo:"pretensing"}],featureValues:{[o.WorldFeature.IterationsPerFrame]:1e3}},{name:"Headless Hug",spin:_.LeftRight,scale:105,postGrowthOp:de.BowtieFaces,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(","A(OOOOXOO,S95,MA0),","b(OOOOXOO,S95,MA0),","a(3,C(XOOOXOO,S93,MA3),S90,MA2),","B(3,C(XOOOXOO,S93,MA3),S90,MA2)",")"],markDefStrings:{0:"shaping-distance-5",2:"shaping-distance-7",3:"shaping-distance-5"},featureValues:{[o.WorldFeature.IterationsPerFrame]:1e3,[o.WorldFeature.PushOverPull]:400},jobs:[{age:1e5,todo:"pretensing"},{age:11e4,todo:"conflict"},{age:12e4,todo:"orient-0"}]},{name:"Triped",spin:_.LeftRight,scale:100,postGrowthOp:de.Bowtie,surfaceCharacter:o.SurfaceCharacter.Bouncy,code:["(B(9,S90,MA1),C(9,S90,MA1),D(9,S90,MA1))"],markDefStrings:{1:"shaping-distance-25"},featureValues:{[o.WorldFeature.IterationsPerFrame]:1e3,[o.WorldFeature.PushOverPull]:1e3},jobs:[{age:8e4,todo:"pretensing"}]},{name:"Arch",spin:_.Left,scale:1600,postGrowthOp:de.Faces,surfaceCharacter:o.SurfaceCharacter.Frozen,code:["(A(3,MA0), a(4,MA0))"],markDefStrings:{0:"pretenst-distance-35"},featureValues:{[o.WorldFeature.PushOverPull]:1e3,[o.WorldFeature.IterationsPerFrame]:500},jobs:[{age:5e4,todo:"orient-0"}]}].map(e=>(pe(e,t=>{throw new Error('Bootstrap compile error in "'.concat(e,'"! ').concat(t))}),e)),vn=En.filter(({scale:e})=>void 0!==e);class Sn{constructor(e,t){if(this.frequency=e,this.radius=t,this.vertices=[],kn.forEach(e=>this.vertexAt(e)),1===e)jn.forEach(e=>{Pn(this.vertices[e[0]],this.vertices[e[1]])});else if(2===e){const e=jn.map(e=>{const t=this.vertices[e[0]],n=this.vertices[e[1]],r=this.vertexBetween(t,n);return Pn(t,r),Pn(r,n),r});On.forEach(t=>{const n=e[t[0]],r=e[t[1]],a=e[t[2]];Pn(n,r),Pn(r,a),Pn(a,n)})}else this.buildFaces(this.buildEdgeVertices());this.vertices.forEach(Fn)}buildEdgeVertices(){const e=[];return jn.forEach(t=>{const n=[];let r,a;e.push(n);for(let e=0;e<this.frequency-1;e++){a=r;const s=this.vertices[t[0]],o=this.vertices[t[1]],c=s.location,l=o.location,u=(new i.Vector3).lerpVectors(c,l,(e+1)/this.frequency);r=this.vertexAt(u),n.push(r),a?(Pn(r,a),e===this.frequency-2&&Pn(r,o)):Pn(r,s)}}),e}buildFaces(e){const t=[];Cn.forEach((n,r)=>{const a=e=>this.vertices[n[e]],s=a(0).location;for(let e=1;e<this.frequency-1;e++){const n=a(1),r=(new i.Vector3).lerpVectors(s,n.location,e/this.frequency);r.sub(s),t[e-1]=[];for(let o=1;o<this.frequency-e;o++){const n=a(2),c=(new i.Vector3).lerpVectors(s,n.location,o/this.frequency);c.sub(s);const l=(new i.Vector3).copy(s);l.add(r),l.add(c),t[e-1].push(this.vertexAt(l))}}for(let e=0;e<t.length;e++)for(let n=0;n<t[e].length;n++)if(n<t[e].length-1&&Pn(t[e][n],t[e][n+1]),e>0){const r=t[e][n];Pn(r,t[e-1][n]),Pn(r,t[e-1][n+1])}const o=[[],[],[]];for(let e=0;e<this.frequency-2;e++){const n=t.length-e-1;o[0].push(t[e][0]),o[1].push(t[n][t[n].length-1]),o[2].push(t[0][e])}for(let i=0;i<o.length;i++){const n=On[r],a=e[n[i]];for(let e=0;e<t.length;e++){const t=o[i][e];Pn(t,a[e]),Pn(t,a[e+1])}}}),An.forEach(t=>{for(let n=0;n<t.length;n++){const r=(n+1)%t.length,a=t[n].front?0:this.frequency-2,s=t[r].front?0:this.frequency-2;Pn(e[t[n].edge][a],e[t[r].edge][s])}})}vertexBetween(e,t){const n=(new i.Vector3).copy(e.location).lerp(t.location,.5);return this.vertexAt(n)}vertexAt(e){const t=e.length();e.multiplyScalar(this.radius/t);const n={index:this.vertices.length,location:e,adjacent:[]};return this.vertices.push(n),n}}const xn=.5257311121191336,kn=[new i.Vector3(+xn,0,.85065080835204),new i.Vector3(+xn,0,-.85065080835204),new i.Vector3(.85065080835204,+xn,0),new i.Vector3(-.85065080835204,+xn,0),new i.Vector3(0,.85065080835204,+xn),new i.Vector3(0,-.85065080835204,+xn),new i.Vector3(-xn,0,-.85065080835204),new i.Vector3(-xn,0,.85065080835204),new i.Vector3(-.85065080835204,-xn,0),new i.Vector3(.85065080835204,-xn,0),new i.Vector3(0,-.85065080835204,-xn),new i.Vector3(0,.85065080835204,-xn)],jn=[[0,2],[0,4],[0,5],[0,7],[0,9],[1,10],[1,11],[1,2],[1,6],[1,9],[2,11],[2,4],[2,9],[3,11],[3,4],[3,6],[3,7],[3,8],[4,11],[4,7],[5,10],[5,7],[5,8],[5,9],[6,10],[6,11],[6,8],[7,8],[8,10],[9,10]],Cn=[[0,2,4],[0,2,9],[0,4,7],[0,5,7],[0,5,9],[1,2,11],[1,2,9],[1,6,10],[1,6,11],[1,9,10],[2,4,11],[3,4,11],[3,4,7],[3,6,11],[3,6,8],[3,7,8],[5,7,8],[5,8,10],[5,9,10],[6,8,10]],On=[[0,11,1],[0,12,4],[1,19,3],[2,21,3],[2,23,4],[7,10,6],[7,12,9],[8,24,5],[8,25,6],[9,29,5],[11,18,10],[14,18,13],[14,19,16],[15,25,13],[15,26,17],[16,27,17],[21,27,22],[22,28,20],[23,29,20],[26,28,24]],An=[[{edge:0,front:!0},{edge:1,front:!0},{edge:3,front:!0},{edge:2,front:!0},{edge:4,front:!0}],[{edge:7,front:!0},{edge:6,front:!0},{edge:8,front:!0},{edge:5,front:!0},{edge:9,front:!0}],[{edge:10,front:!0},{edge:11,front:!0},{edge:0,front:!1},{edge:12,front:!0},{edge:7,front:!1}],[{edge:14,front:!0},{edge:13,front:!0},{edge:15,front:!0},{edge:17,front:!0},{edge:16,front:!0}],[{edge:18,front:!0},{edge:11,front:!1},{edge:1,front:!1},{edge:19,front:!0},{edge:14,front:!1}],[{edge:21,front:!0},{edge:22,front:!0},{edge:20,front:!0},{edge:23,front:!0},{edge:2,front:!1}],[{edge:26,front:!0},{edge:24,front:!0},{edge:8,front:!1},{edge:25,front:!0},{edge:15,front:!1}],[{edge:27,front:!0},{edge:16,front:!1},{edge:19,front:!1},{edge:3,front:!1},{edge:21,front:!1}],[{edge:28,front:!0},{edge:22,front:!1},{edge:27,front:!1},{edge:17,front:!1},{edge:26,front:!1}],[{edge:4,front:!1},{edge:23,front:!1},{edge:29,front:!0},{edge:9,front:!1},{edge:12,front:!1}],[{edge:28,front:!1},{edge:20,front:!1},{edge:29,front:!1},{edge:5,front:!1},{edge:24,front:!1}],[{edge:6,front:!1},{edge:10,front:!1},{edge:18,front:!1},{edge:13,front:!1},{edge:25,front:!1}]];function Pn(e,t){e.adjacent.push(t),t.adjacent.push(e)}function Fn(e){const t=(new i.Vector3).copy(e.location).normalize(),n=e.adjacent.pop();if(!n)throw new Error("No first to pop!");const r=[n],a=({location:t})=>(new i.Vector3).subVectors(t,e.location).normalize();for(;e.adjacent.length>0;){const n=r[r.length-1],s=e.adjacent.find(e=>{const r=a(e),s=a(n);return!(r.dot(s)<.25)&&(new i.Vector3).crossVectors(s,r).dot(t)>0});if(!s)throw new Error("No next found");r.push(s),e.adjacent=e.adjacent.filter(e=>e.index!==s.index)}e.adjacent=r}class Rn{constructor(e,t,n,r){this.location=e,this.frequency=t,this.radius=n,this.segmentSize=r,this.scaffold=void 0,this.hubs=void 0,this.tensegrity=void 0,this.scaffold=new Sn(t,n),this.hubs=this.scaffold.vertices.map(e=>({vertex:e,spokes:[]}))}operateOn(e){this.tensegrity=e}finished(){return this.tensegrity.joints.length>0}work(){const e={};this.hubs.forEach(({vertex:t,spokes:n})=>{const r=this.hubs[t.index];t.adjacent.forEach(a=>{const s=this.hubs[a.index],i=e["".concat(a.index,"-").concat(t.index)];if(i){const{push:e}=i,t=e.omega,a=e.alpha;n.push({push:e,centerHub:r,centerJoint:t,outerHub:s,outerJoint:a})}else{const i=this.createPush(t,a),o=i.alpha,c=i.omega,l={push:i,centerHub:r,centerJoint:o,outerHub:s,outerJoint:c};e["".concat(t.index,"-").concat(a.index)]=l,n.push(l)}})}),this.instance.refreshFloatView();const t=this.segmentSize*this.averageIntervalLength,n={};this.hubs.forEach(e=>e.spokes.forEach(r=>this.pullsForSpoke(e,r,t,n))),this.tensegrity.toDo={age:2e4,todo:e=>{e.stage=o.Stage.Slack,e.fabric.set_altitude(this.location.y),e.stage=o.Stage.Pretensing}}}createPush(e,t){const n=(new i.Vector3).addVectors(e.location,t.location).normalize(),r=(new i.Quaternion).setFromAxisAngle(n,.52),a=(new i.Vector3).copy(e.location).applyQuaternion(r),s=(new i.Vector3).copy(t.location).applyQuaternion(r),o=re(e.location.distanceTo(t.location)),c=this.tensegrity.createJoint(a),l=this.tensegrity.createJoint(s);return this.instance.refreshFloatView(),this.tensegrity.createInterval(c,l,f.PushC,o)}pullsForSpoke(e,t,n,r){const a=(e,t,n)=>{const a=t.index>e.index?"".concat(e.index,"-").concat(t.index):"".concat(t.index,"-").concat(e.index);r[a]||(r[a]=this.tensegrity.createInterval(e,t,f.PullA,re(n)))},s=Vn(e,t);a(t.centerJoint,s.centerJoint,n);const i=Vn(t.outerHub,t).centerJoint,o=this.instance.intervalLength(t.push);a(s.centerJoint,i,o-2*n)}get averageIntervalLength(){const e=e=>this.instance.intervalLength(e);return this.intervals.reduce((t,n)=>t+e(n),0)/this.intervals.length}get instance(){return this.tensegrity.instance}get intervals(){return this.tensegrity.intervals}}function Vn(e,t){const n=e.spokes.findIndex(({push:e})=>e.index===t.push.index);if(n<0)throw new Error("Cannot find current spoke when looking for next");return e.spokes[(n+1)%e.spokes.length]}function Tn(e){const t=new i.Color(e);return new i.MeshLambertMaterial({color:t})}const Dn=Tn("#011884"),Bn=Tn("#a80000"),Ln=[1,2,3,4,5],Mn=Object(s.atom)({key:"show push",default:!0}),Nn=Object(s.atom)({key:"show pull",default:!0}),_n=Object(s.atom)({key:"frozen",default:!1}),In=Object(s.atom)({key:"gravity",default:2});function zn({frequencyParam:e,createSphere:t}){const n=Object(r.useMemo)(()=>{const t=void 0===e?1:parseInt(e,10),n=Ln.findIndex(e=>e===t);return n>=0?n:0},[]),[a,i]=Object(s.useRecoilState)(_n),[o,c]=Object(s.useRecoilState)(Mn),[l,u]=Object(s.useRecoilState)(Nn),[h,d]=Object(s.useRecoilState)(In),[m,f]=Object(r.useState)(()=>t(Ln[n],h));Object(r.useEffect)(()=>{i(!1),f(t(Ln[n],h))},[h,n]),Object(r.useEffect)(()=>{o||l||(c(!0),u(!0))},[o,l]);const g=Object(s.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},r.createElement("div",{id:"bottom-right"},r.createElement(B.a,null,r.createElement(L.a,{onClick:()=>$e(qe(m,1,1,1))},r.createElement(N.k,null)),r.createElement(L.a,{color:"warning",onClick:()=>j(v.Choice)},r.createElement(N.y,null)))),r.createElement("div",{id:"top-left"},r.createElement(B.a,null,Ln.map((e,t)=>r.createElement(L.a,{key:"Freq".concat(e),onClick:()=>j(v.Sphere,e.toFixed(0)),color:t===n?"success":"secondary"},e)))),r.createElement("div",{id:"top-right"},r.createElement(B.a,null,r.createElement(L.a,{color:2===h?"success":"secondary",onClick:()=>d(2)},"Heavy Gravity"),r.createElement(L.a,{color:1===h?"success":"secondary",onClick:()=>d(1)},"Light Gravity"),r.createElement(L.a,{color:0===h?"success":"secondary",onClick:()=>d(0)},"Space"))),r.createElement("div",{id:"bottom-left"},r.createElement(B.a,null,r.createElement(L.a,{color:a?"success":"secondary",onClick:()=>i(!a)},r.createElement(N.A,null)),r.createElement(L.a,{color:o?"success":"secondary",disabled:!a,onClick:()=>c(!o)},"C"),r.createElement(L.a,{color:l?"success":"secondary",disabled:!a,onClick:()=>u(!l)},"T"))),r.createElement(M.a,{style:{backgroundColor:"black"}},r.createElement(Xe.a,{makeDefault:!0,position:[0,15,54]}),r.createElement(g,null,m?r.createElement(Gn,{sphere:m}):r.createElement("h1",null,"No Sphere"))))}function Gn({sphere:e}){const[t,n]=Object(r.useState)(new i.Vector3),[a]=Object(s.useRecoilState)(_n);return Object(M.b)(()=>{if(!a){e.iterate();const r=(new i.Vector3).subVectors(e.instance.midpoint,t).multiplyScalar(.1);n((new i.Vector3).copy(t).add(r))}}),r.createElement("group",null,r.createElement(Ke.a,{target:t}),r.createElement("scene",null,a?r.createElement(Jn,{sphere:e}):r.createElement("lineSegments",{key:"lines",geometry:e.instance.floatView.lineGeometry,material:et,onUpdate:e=>e.geometry.computeBoundingSphere()}),r.createElement(ft,null),r.createElement(Ze.a,null),r.createElement("ambientLight",{color:new i.Color("white"),intensity:.8}),r.createElement("directionalLight",{color:new i.Color("#FFFFFF"),intensity:2})))}const Wn=new i.CylinderGeometry(1,1,1,12,1,!1);function Jn({sphere:e}){const[t]=Object(s.useRecoilState)(Mn),[n]=Object(s.useRecoilState)(Nn),a=e.instance;return r.createElement("group",null,n?e.intervals.filter(({intervalRole:e})=>!y(e)).map(e=>{const t=Q(a.unitVector(e.index)),n=a.jointDistance(e.alpha,e.omega),s=new i.Vector3(.03,n,.03);return r.createElement("mesh",{key:"T".concat(e.index),geometry:Wn,position:a.intervalLocation(e),rotation:(new i.Euler).setFromQuaternion(t),scale:s,material:Bn,matrixWorldNeedsUpdate:!0})}):void 0,t?e.intervals.filter(({intervalRole:e})=>y(e)).map(e=>{const t=Q(a.unitVector(e.index)),n=a.jointDistance(e.alpha,e.omega),s=new i.Vector3(.06,n,.06);return r.createElement("mesh",{key:"C".concat(e.index),geometry:Wn,position:a.intervalLocation(e),rotation:(new i.Euler).setFromQuaternion(t),scale:s,material:Dn,matrixWorldNeedsUpdate:!0})}):void 0)}var Hn=n(104),Un=n(105),qn=n(106),$n=n(100),Qn=n(94);const Xn=[0,1e5];function Kn({mapping:e,percentAtom:t,apply:n}){const{name:a,nuanceToPercent:i,percentToNuance:o,percentToValue:c}=e,l=e=>[Math.floor(1e5*o(e))],[u,h]=Object(s.useRecoilState)(t),[d,m]=Object(r.useState)(l(u));return Object(r.useEffect)(()=>{h(Math.round(i(d[0]/1e5)))},[d]),Object(r.useEffect)(()=>n(e.feature,u,c(u)),[u]),Object(r.useEffect)(()=>{m(l(u))},[e,u]),r.createElement("div",{className:"slider"},r.createElement("div",{className:"float-right mr-4"},r.createElement(N.c,{onClick:()=>m(l(100))})),r.createElement("div",{className:"ml-2 small my-1"},a," = ",function(e){return e<=100?"".concat(e.toFixed(0),"%"):"".concat((e/100).toFixed(1),"x")}(u)," (",C(c(u)),")"),r.createElement(Qn.c,{mode:1,step:1,domain:Xn,rootStyle:er,values:d,onChange:e=>m(e)},r.createElement(Qn.b,null,({getRailProps:e})=>r.createElement("div",Object.assign({className:"slider-rail"},e()))),r.createElement(Qn.a,null,({handles:e,getHandleProps:t})=>r.createElement("div",{className:"slider-handles"},e.map((e,n)=>r.createElement(Zn,{key:e.id,handle:e,getHandleProps:t})))),r.createElement(Qn.d,{right:!1},({tracks:e,getTrackProps:t})=>r.createElement("div",{className:"slider-tracks"},e.map(({id:e,source:n,target:a},s)=>r.createElement(Yn,{key:e,source:n,target:a,getTrackProps:t}))))))}function Zn({handle:e,getHandleProps:t}){const n=Xn[0],a=Xn[1],{id:s,value:i,percent:o}=e;return r.createElement("div",Object.assign({role:"slider",className:"slider-handle",style:{left:"".concat(o,"%")},"aria-valuemin":n,"aria-valuemax":a,"aria-valuenow":i},t(s)))}function Yn({source:e,target:t,getTrackProps:n}){return r.createElement("div",Object.assign({className:"slider-track",style:{left:"".concat(e.percent,"%"),width:"".concat(t.percent-e.percent,"%")}},n()))}const er={margin:"1%",position:"relative",width:"98%"};function tr({tensegrity:e}){const[t,n]=Object(r.useState)(!1),[a,i]=Object(s.useRecoilState)(Ve),[o,c]=Object(r.useState)(Ne[a]);return r.createElement("div",{className:"w-100 d-flex"},r.createElement(Hn.a,{isOpen:t,toggle:()=>n(!t)},r.createElement(Un.a,null,"Choose"),r.createElement(qn.a,null,Ne.filter(e=>!e.mapping.name.startsWith("-")).map(e=>r.createElement($n.a,{key:"fitem-".concat(e.mapping.feature),onClick:()=>{i(e.mapping.feature),c(e)}},e.mapping.name)))),r.createElement(Kn,{mapping:o.mapping,percentAtom:o.percentAtom,apply:(t,n,r)=>{e.instance.applyFeature(t,n,r)}}))}const nr=new i.Color("#ffffff");function rr({tensegrity:e,clickDetails:t}){const[n]=Object(s.useRecoilState)(Le),[a]=Object(s.useRecoilState)(Te),[c]=Object(s.useRecoilState)(_e),[l,u]=Object(r.useState)(new i.Vector3(0,1,0)),[h,d]=Object(r.useState)(e.stage$.getValue()),m=Object(r.useRef)();Object(r.useEffect)(()=>{const t=e.stage$.subscribe(d);return()=>t.unsubscribe()},[e]),Object(r.useEffect)(()=>{const t=m.current;t&&e&&t.position.set(0,5,5*e.instance.view.radius())},[]),Object(M.b)(()=>{if(!m.current)return;n===Be.Time&&e.iterate();const t=c?e.instance.twistLocation(c):e.instance.midpoint;u((new i.Vector3).subVectors(t,l).multiplyScalar(.01).add(l));const r=m.current.position;if(h===o.Stage.Growing){r.y+=.01*(t.y-r.y);const n=r.distanceTo(t)-2.5*e.instance.view.radius(),a=(new i.Vector3).subVectors(t,r).normalize().multiplyScalar(.01*n);r.add(a)}else r.y<0&&(r.y-=.01*r.y*20)});const f=()=>{switch(n){case Be.Time:return r.createElement(st,{tensegrity:e});case Be.Select:return r.createElement(ut,{tensegrity:e,clickDetails:t});case Be.Look:return r.createElement(it,{tensegrity:e})}};return r.createElement("group",null,r.createElement(Xe.a,{ref:m,makeDefault:!0}),r.createElement(Ke.a,{target:l,autoRotate:a,enablePan:!1,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.8*Math.PI,zoomSpeed:.5}),r.createElement("scene",null,r.createElement(f,null),r.createElement(ft,null),r.createElement(Ze.a,null),r.createElement("ambientLight",{color:nr,intensity:.8}),r.createElement("directionalLight",{color:new i.Color("#FFFFFF"),intensity:2})))}var ar=n(101);function sr({runTenscript:e}){const[t,n]=Object(s.useRecoilState)(Re),[a]=Object(s.useRecoilState)(Pe),[i,o]=Object(r.useState)(""),[c,l]=Object(r.useState)(""),u=()=>JSON.stringify(t,void 0,2);return Object(r.useEffect)(()=>{o(t?u():"")},[t]),r.createElement("div",{id:"tenscript-panel",style:{flexDirection:"column",position:"relative",backgroundColor:"rgba(0,0,0,1)",height:"100%"}},r.createElement("div",null,r.createElement("h6",{className:"w-100 text-center"},r.createElement(N.x,null)," Tenscript"),r.createElement("div",{id:"code-and-run",style:{flexDirection:"column",height:"available"}},r.createElement(ar.a,{style:{borderRadius:"1em",height:"22em",marginBottom:"0.5em"},type:"textarea",id:"tenscript",value:i,onChange:e=>o(e.target.value)}),r.createElement(B.a,{vertical:!0,className:"w-100 my-2"},0===c.length?void 0:r.createElement(L.a,{className:"my-2",color:"warning",onClick:()=>{o(u()),l("")}},r.createElement(N.d,null),r.createElement("hr",null),c),r.createElement(L.a,{color:"success",onClick:()=>function(){try{const t=JSON.parse(i);pe(t,l)&&(l(""),t.postGrowthOp=a,n(t),e(t,l))}catch(t){l(t.toString())}}()},"Try it out!")))))}let ir;!function(e){e[e.CaptureLengthsToSlack=0]="CaptureLengthsToSlack",e[e.SlackToPretensing=1]="SlackToPretensing",e[e.CapturePretenstToSlack=2]="CapturePretenstToSlack",e[e.CaptureStrainForStiffness=3]="CaptureStrainForStiffness"}(ir||(ir={}));const or=Object.keys(ir).filter(e=>isNaN(parseInt(e,10))).map(e=>ir[e]);function cr({tensegrity:e,stageTransition:t,disabled:n}){const[a,s]=Object(r.useState)(e.stage);function i(e){return!(!n&&a!==o.Stage.Pretensing)||a!==e}function c(t){e.toDo={todo:t}}switch(Object(r.useEffect)(()=>{const t=e.stage$.subscribe(s);return()=>t.unsubscribe()},[e]),t){case ir.CaptureLengthsToSlack:return r.createElement(L.a,{disabled:i(o.Stage.Shaping),onClick:()=>c(e=>e.stage=o.Stage.Slack)},r.createElement(N.e,null),r.createElement(N.a,null),r.createElement(lr,{stage:o.Stage.Slack}));case ir.SlackToPretensing:return r.createElement(L.a,{disabled:i(o.Stage.Slack),onClick:()=>c(e=>e.stage=o.Stage.Pretensing)},r.createElement(lr,{stage:o.Stage.Slack}),r.createElement(N.a,null),r.createElement(lr,{stage:o.Stage.Pretenst}));case ir.CapturePretenstToSlack:return r.createElement(L.a,{disabled:i(o.Stage.Pretenst),onClick:()=>c(e=>e.stage=o.Stage.Slack)},r.createElement(lr,{stage:o.Stage.Pretenst}),r.createElement(N.a,null),r.createElement(lr,{stage:o.Stage.Slack}));case ir.CaptureStrainForStiffness:return r.createElement(L.a,{disabled:i(o.Stage.Pretenst),onClick:()=>c(e=>{e.stage=o.Stage.Slack,e.strainToStiffness()})},r.createElement(lr,{stage:o.Stage.Pretenst}),r.createElement(N.a,null),r.createElement(lr,{stage:o.Stage.Slack}),r.createElement(N.f,null))}}function lr({stage:e}){switch(e){case o.Stage.Growing:return r.createElement(N.x,null);case o.Stage.Shaping:return r.createElement(N.z,null);case o.Stage.Slack:return r.createElement(N.C,null);case o.Stage.Pretensing:return r.createElement(N.h,null);case o.Stage.Pretenst:return r.createElement(N.p,null);default:throw new Error("Stage?")}}function ur({tensegrity:e,runTenscript:t}){const[n]=Object(s.useRecoilState)(Le),a=Object(s.useSetRecoilState)(Fe),[i,o]=Object(s.useRecoilState)(Re),[c,l]=Object(s.useRecoilState)(Pe),[u,h]=Object(r.useState)(!1),[d,m]=Object(r.useState)(!1),f=e=>{if(i)if(l(e),i.postGrowthOp===e)t(i,e=>console.error(e));else{const n={...i,postGrowthOp:e};o(n),t(n,e=>console.error(e))}},g=e=>c===e?"success":"secondary";return r.createElement(r.Fragment,null,r.createElement(B.a,null,or.map(t=>r.createElement(cr,{key:"strans-".concat(t),tensegrity:e,stageTransition:t,disabled:n===Be.Look}))),r.createElement("br",null),r.createElement(B.a,{className:"my-1"},r.createElement(L.a,{onClick:()=>f(de.NoOp),color:g(de.NoOp)},"0"),r.createElement(L.a,{onClick:()=>f(de.Faces),color:g(de.Faces)},"\u25b5"),r.createElement(L.a,{onClick:()=>f(de.Snelson),color:g(de.Snelson)},"S\u25b5"),r.createElement(L.a,{onClick:()=>f(de.Bowtie),color:g(de.Bowtie)},"\u22c8"),r.createElement(L.a,{onClick:()=>f(de.BowtieFaces),color:g(de.BowtieFaces)},"\u22c8 ",r.createElement("strong",null,"\u25b5"))),r.createElement("br",null),r.createElement(B.a,null,r.createElement(Hn.a,{isOpen:d,toggle:()=>m(!d)},r.createElement(Un.a,null,r.createElement(N.q,null)),r.createElement(qn.a,null,En.map((e,n)=>r.createElement($n.a,{key:"Boot".concat(n),onClick:()=>{a(n),t(e,()=>console.error("impossible"))}},e.name)))),r.createElement(L.a,{color:u?"warning":"secondary",onClick:()=>h(!u)},r.createElement(N.l,null))),u?r.createElement(sr,{runTenscript:t}):void 0)}function hr({tensegrity:e}){const[t,n]=Object(r.useState)(e.stage$.getValue());return Object(r.useEffect)(()=>{const t=e.stage$.subscribe(n);return()=>t.unsubscribe()},[e]),r.createElement("div",null,r.createElement("span",null,E(t))," ",r.createElement("i",null,'"',e.name,'"'))}function dr({tensegrity:e,selected:t}){const[n]=Object(s.useRecoilState)(Le),[a,i]=Object(s.useRecoilState)(Me),[o,c]=Object(r.useState)(f.PullA),l=n=>()=>{if(t){t.pulls.concat(t.adjacentPulls).forEach(t=>e.changeIntervalScale(t,n?1.03:1/1.03))}};switch(n){case Be.Time:return r.createElement(r.Fragment,null,r.createElement(B.a,null,b.map((e,t)=>r.createElement(L.a,{key:"IntervalRole[".concat(t,"]"),onClick:()=>c(e),color:o===e?"success":"secondary"},w(e)))),r.createElement(mr,{tensegrity:e,intervalRole:o}));case Be.Select:return r.createElement(B.a,null,r.createElement(L.a,{onClick:l(!0)},r.createElement(N.v,null)),r.createElement(L.a,{onClick:l(!1)},r.createElement(N.r,null)));case Be.Look:return r.createElement(B.a,null,b.map(e=>r.createElement(L.a,{key:"viz".concat(e),onClick:()=>{if(a.indexOf(e)<0)i([...a,e]);else{const t=a.filter(t=>t!==e);i(t.length>0?t:b)}},color:a.some(t=>t===e)?"success":"secondary"},w(e),r.createElement(N.g,{style:{color:tt(e)}}))));default:return r.createElement("span",null,"?")}}function mr({tensegrity:e,intervalRole:t,disabled:n}){const a=(n,r)=>()=>{e.intervals.filter(e=>e.intervalRole===t).forEach(t=>e.changeIntervalScale(t,function(){const e=r?1.01:1.05;return n?e:1/e}()))};return r.createElement("div",{className:"text-right"},r.createElement(B.a,{className:"my-1"},r.createElement(L.a,{disabled:n,onClick:a(!0,!1)},r.createElement(N.v,null),r.createElement(N.v,null)),r.createElement(L.a,{disabled:n,onClick:a(!0,!0)},r.createElement(N.v,null)),r.createElement(L.a,{disabled:n,onClick:a(!1,!0)},r.createElement(N.r,null)),r.createElement(L.a,{disabled:n,onClick:a(!1,!1)},r.createElement(N.r,null),r.createElement(N.r,null))),r.createElement("br",null),r.createElement(B.a,null,r.createElement(L.a,null,w(t)," = [",C(g(t)),"]")))}function fr({createInstance:e}){const t=Object(r.useMemo)(()=>e({}),[]),n=Ne.map(({percentAtom:e})=>Object(s.useRecoilState)(e)),[a,c]=Object(s.useRecoilState)(Re),[l]=Object(s.useRecoilState)(Fe),h=Object(s.useSetRecoilState)(Pe),[d,m]=Object(s.useRecoilState)(Le),[f,g]=Object(r.useState)(),[w,b]=Object(s.useRecoilState)(_e),[E,v]=Object(s.useRecoilState)(Ie);Object(r.useEffect)(()=>{f&&v(w?w.pushes.map(e=>f.getIntervalDetails(e)):[])},[w]);const S=e=>console.error("tensegrity view",e),x=(e,r)=>{try{const a=pe(e,r);if(!a)return!1;m(Be.Time),b(void 0);const s=e.featureValues,l=s?s[o.WorldFeature.IntervalCountdown]:void 0,d=void 0===l?Object(o.default_world_feature)(o.WorldFeature.IntervalCountdown):l;c(e),p.map(e=>{const r=o.WorldFeature[e],{percentToValue:a}=u(r),i=s?s[e]:void 0;void 0!==i&&(n[r][1](i),t.applyFeature(r,i,a(i)))}),h(e.postGrowthOp);const f=new we(new i.Vector3,e,a);g(new ge(t,d,f))}catch(a){return console.log("Problem running",a),x(En[l],S)}return!0};Object(r.useEffect)(()=>{Object.keys(localStorage).filter(e=>"pretenst-2021-11-02"!==e).forEach(e=>localStorage.removeItem(e)),x(a||En[l],S)},[]);const k=Object(s.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",null,r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},f?r.createElement("div",{className:"h-100"},r.createElement(M.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:d!==Be.Time?"#f0ad4e":"black",cursor:d===Be.Select?"pointer":"default",borderWidth:"2px"}},r.createElement(k,null,r.createElement(rr,{tensegrity:f,clickDetails:({interval:e})=>{w&&f&&(1===E.length||y(e.intervalRole)?v(w.adjacentPulls.map(e=>f.getIntervalDetails(e))):v(E.filter(t=>t.interval.index===e.index)))}}))),r.createElement("div",{id:"top-left"},r.createElement(ur,{tensegrity:f,runTenscript:x})),r.createElement("div",{id:"top-right"},r.createElement(dr,{tensegrity:f,selected:w})),r.createElement("div",{id:"bottom-left"},r.createElement(ze,null)),r.createElement("div",{id:"bottom-middle",style:{width:"60%"}},r.createElement(tr,{tensegrity:f})),r.createElement("div",{id:"top-middle"},r.createElement(hr,{tensegrity:f})),r.createElement("div",{id:"bottom-right"},r.createElement(Qe,{tensegrity:f}))):r.createElement("div",{className:"h-100"},r.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},r.createElement("h1",null,r.createElement(N.u,null))))))}function gr({createInstance:e}){const[t]=Object(s.useRecoilState)(De);function n(e){window.open(e,"_blank")}switch(Object(r.useEffect)(()=>{const{mode:e,param:n}=k();e!==t.mode&&j(e,n)},[]),t.mode){case v.Design:return r.createElement(fr,{createInstance:e});case v.Construction:const a=vn.find(({name:e})=>x(e)===t.param);return a?r.createElement(pt,{tenscript:a,createInstance:e}):(j(v.Choice),r.createElement("div",null));case v.Evolution:return r.createElement(wn,{createBodyInstance:e});case v.Sphere:return r.createElement(zn,{frequencyParam:t.param,createSphere:(t,n)=>{const r=e({[o.WorldFeature.IterationsPerFrame]:200,[o.WorldFeature.Gravity]:(()=>{switch(n){case 0:return 0;case 1:return 25;default:return 1500}})(),[o.WorldFeature.ShapingStiffnessFactor]:300,[o.WorldFeature.ShapingDrag]:300,[o.WorldFeature.Drag]:0,[o.WorldFeature.VisualStrain]:0,[o.WorldFeature.StiffnessFactor]:800}),a=new Rn(new i.Vector3(0,60,0),t,15,.3333);return new ge(r,100,a)}});default:return r.createElement("div",{id:"choice-menu"},r.createElement("h1",null,"Pretenst App"),r.createElement("div",{className:"d-inline-flex"},r.createElement("div",{className:"choice-menu-box"},r.createElement("h4",null,"Projects"),r.createElement(B.a,{className:"choice-menu-group",vertical:!0},En.map(({scale:e,name:t})=>{if(void 0!==e)return r.createElement(L.a,{size:"lg",color:"info",key:t,onClick:()=>j(v.Construction,x(t))},'"',t,'"')}))),r.createElement("div",{className:"choice-menu-box"},r.createElement("h4",null,"Modes"),r.createElement(B.a,{className:"choice-menu-group",vertical:!0},r.createElement(L.a,{size:"lg",color:"info",onClick:()=>j(v.Sphere)},"Sphere"),r.createElement(L.a,{size:"lg",color:"info",onClick:()=>j(v.Design)},"Design"),r.createElement(L.a,{size:"lg",color:"info",onClick:()=>j(v.Evolution)},"Evolution"))),r.createElement("div",{className:"choice-menu-box"},r.createElement("h4",null,"Background"),r.createElement(B.a,{className:"choice-menu-group",vertical:!0},r.createElement(L.a,{size:"lg",color:"info",onClick:()=>n("https://pretenst.com/")},"Construction Stories"),r.createElement(L.a,{size:"lg",color:"info",onClick:()=>n("https://github.com/elastic-interval/pretenst")},"Virtual Design Software")))))}}async function pr(e,t){!function(e){const t=document.getElementById("root");a.render(e,t)}(r.createElement(s.RecoilRoot,null,r.createElement(gr,{createInstance:(n,r)=>new R(e,n,2e3,t,r)}))),T()}n.d(t,"startReact",(function(){return pr}))}}]);
//# sourceMappingURL=4.acf98f73.chunk.js.map