(window.webpackJsonppretenst=window.webpackJsonppretenst||[]).push([[4],{5:function(e,t,n){"use strict";n.r(t);var r=n(6),a=n(23),o=n(8),s=n(7),i=n(4);let c;function l(e,t,n,r,a){return{feature:e,name:t,featureStage:n,nuanceToPercent:e=>r*(1-e)+a*e,percentToNuance:e=>(e-r)/(a-r),percentToValue:t=>Object(i.default_world_feature)(e)*t/100,valueToPercent:t=>t/Object(i.default_world_feature)(e)*100}}function u(e){switch(e){case i.WorldFeature.Gravity:return l(e,"Gravity",c.Postslack,0,1e3);case i.WorldFeature.Antigravity:return l(e,"-Antigravity",c.All,5,500);case i.WorldFeature.ShapingDrag:return l(e,"Shaping Drag",c.Preslack,0,500);case i.WorldFeature.ShapingStiffnessFactor:return l(e,"Shaping Stiffness",c.Preslack,10,1e3);case i.WorldFeature.Drag:return l(e,"Drag",c.Postslack,0,1e3);case i.WorldFeature.ShapingPretenstFactor:return l(e,"Shaping Pretenst",c.Preslack,0,1e3);case i.WorldFeature.PretenstFactor:return l(e,"Pretenst Factor",c.Postslack,0,500);case i.WorldFeature.StiffnessFactor:return l(e,"Stiffness",c.Postslack,1,300);case i.WorldFeature.IterationsPerFrame:return l(e,"Iterations/frame",c.All,2,500);case i.WorldFeature.IntervalCountdown:return l(e,"-Interval Countdown",c.Preslack,10,1e3);case i.WorldFeature.PretensingCountdown:return l(e,"-Pretenst countdown",c.All,50,200);case i.WorldFeature.VisualStrain:return l(e,"Visual strain",c.All,0,300);case i.WorldFeature.PushOverPull:return l(e,"Push/Pull",c.All,10,700);default:throw new Error("Feature?")}}!function(e){e[e.Preslack=0]="Preslack",e[e.Postslack=1]="Postslack",e[e.All=2]="All"}(c||(c={}));const h=new s.Vector3(1,0,0),d=(new s.Vector3(0,0,1),new s.Vector3(0,1,0)),m=new s.Vector3(0,-1,0),f=1.732050807568877;const g=Object.keys(i.WorldFeature);function p(e){switch(e){case i.Stage.Growing:return"Growing";case i.Stage.Shaping:return"Shaping";case i.Stage.Slack:return"Slack";case i.Stage.Pretensing:return"Pretensing";default:return"Pretenst"}}let w;!function(e){e.Choice="choice",e.Design="design",e.Sphere="sphere",e.Mobius="mobius",e.Klein="klein",e.Construction="construction",e.Evolution="evolution"}(w||(w={}));const b=Object.keys(w).map(e=>w[e]);function y(e){return e.replace(/ /g,"-")}function E(){const e=location.hash.substring(1).split(";"),t=b.find(t=>t===e[0]);if(t){return{mode:t,param:e.length>1?e[1]:""}}return v(w.Choice)}function v(e,t){return location.hash=t&&t.length>0?"".concat(e,";").concat(t):e,location.reload(),{mode:e,param:t}}function S(e,t){return(new s.Vector3).subVectors(e,t).normalize()}function j(e){const t=new s.Vector3;return e.forEach(e=>t.add(e)),t.multiplyScalar(1/e.length)}function x(e){const t=j(e),n=e.map(e=>(new s.Vector3).copy(e).sub(t)),r=new s.Vector3;for(let a=0;a<n.length;a++){const e=n[a],t=n[(a+1)%n.length];r.add((new s.Vector3).crossVectors(e,t).normalize())}return r.normalize()}function k(e,t,n){const r=3*t;return n?(n.set(e[r],e[r+1],e[r+2]),n):new s.Vector3(e[r],e[r+1],e[r+2])}class C{constructor(e,t,n,r,a){this.fabric=void 0,this.world=void 0,this.view=void 0,this.floatView=function(){const e=new Float32Array(0);return{jointCount:0,intervalCount:0,faceCount:0,lineGeometry:new s.BufferGeometry,faceGeometry:new s.BufferGeometry,jointLocations:e,unitVectors:e,idealLengths:e,strains:e,strainLimits:new Float32Array(4),strainNuances:e,stiffnesses:e,linearDensities:e}}(),this.adoptFabric=void 0,this.midpoint=new s.Vector3(0,0,0),this.valuesToApply=[],this.fabricBackup=void 0,this.world=r;for(const[o,s]of Object.entries(t)){const e=parseInt(o,10),{percentToValue:t}=u(e),n=t(s);this.world.set_float_value(e,n)}this.adoptFabric=t=>(this.free(),this.fabric=t,this.view=e.View.on_fabric(t),this),this.adoptFabric(a||e.Fabric.new(n))}iterate(){const e=this.fabric.iterate(this.world);this.refreshFloatView();const t=this.valuesToApply.shift();return t&&this.world.set_float_value(t.feature,t.value),e}get stage(){return this.fabric.get_stage()}set stage(e){this.fabric.request_stage(e,this.world)||console.error("Could not move to stage ".concat(e,"!"))}showFrozen(e){this.updateFloatView(!0,e)}get fabricClone(){return this.fabric.clone()}snapshot(){console.log("snapshot"),this.fabricBackup=this.fabricClone}restoreSnapshot(){console.log("restoreSnapshot");const e=this.fabricBackup;if(!e)throw new Error("Missing backup");this.adoptFabric(e.clone())}refreshFloatView(){this.view.render(this.fabric,this.world),this.midpoint.set(this.view.midpoint_x(),this.view.midpoint_y(),this.view.midpoint_z()),this.updateFloatView(!1,!1)}clear(){return this.fabric.clear(),this.refreshFloatView(),this}applyFeature({feature:e,percent:t,value:n},r){r?this.world.set_float_value(e,n):this.valuesToApply.push({feature:e,percent:t,value:n})}jointLocation(e){return k(this.floatView.jointLocations,e.index)}averageJointLocation(e){return e.reduce((e,t)=>e.add(this.jointLocation(t)),new s.Vector3).multiplyScalar(1/e.length)}jointDistance(e,t){return this.jointLocation(e).distanceTo(this.jointLocation(t))}intervalLocation({alpha:e,omega:t}){return this.jointLocation(e).add(this.jointLocation(t)).multiplyScalar(.5)}twistLocation({pushes:e}){return e.reduce((e,t)=>e.add(this.intervalLocation(t)),new s.Vector3).multiplyScalar(1/e.length)}intervalLength({alpha:e,omega:t}){return this.jointDistance(e,t)}faceLocation(e){return j(e.ends.map(e=>this.jointLocation(e)))}averageFaceLocation(e){return e.reduce((e,t)=>e.add(this.faceLocation(t)),new s.Vector3).multiplyScalar(1/e.length)}apply(e){this.fabric.apply_matrix4(new Float32Array(e.toArray())),this.refreshFloatView()}unitVector(e){return k(this.floatView.unitVectors,e)}free(){const e=this.fabric;e&&e.free();const t=this.view;t&&t.free()}updateFloatView(e,t){const n=this.fabric,r=this.view,a=n.get_joint_count(),o=n.get_interval_count(),i=n.get_face_count(),c=this.floatView;if(c.jointCount!==a||c.intervalCount!==o||c.faceCount!==i){c.jointCount=a,c.intervalCount=o,c.faceCount=i,c.lineGeometry.dispose(),c.lineGeometry=new s.BufferGeometry;const n=new Float32Array(3*o*2);r.copy_line_locations_to(n),c.lineGeometry.setAttribute("position",new s.Float32BufferAttribute(n,3));const l=new Float32Array(3*o*2);if(e)if(t){l.fill(0);for(let e=1;e<l.length;e+=3)l[e]=1}else l.fill(1);else r.copy_line_colors_to(l);c.lineGeometry.setAttribute("color",new s.Float32BufferAttribute(l,3)),c.faceGeometry.dispose(),c.faceGeometry=new s.BufferGeometry;const u=new Float32Array(3*i*3);r.copy_face_vertex_locations_to(u),c.faceGeometry.setAttribute("position",new s.Float32BufferAttribute(u,3));const h=new Float32Array(3*i*3);r.copy_face_normals_to(h),c.faceGeometry.setAttribute("normal",new s.Float32BufferAttribute(h,3)),c.jointLocations=new Float32Array(3*a),c.unitVectors=new Float32Array(3*o),c.idealLengths=new Float32Array(o),c.strains=new Float32Array(o),c.strainNuances=new Float32Array(o),c.stiffnesses=new Float32Array(o),c.linearDensities=new Float32Array(o)}else{const n=this.floatView.lineGeometry.attributes,a=this.floatView.faceGeometry.attributes;if(n.position){const o=n.position;r.copy_line_locations_to(o.array),o.needsUpdate=!0;const s=n.color,i=s.array;if(e)if(t){i.fill(0);for(let e=1;e<i.length;e+=3)i[e]=1}else i.fill(1);else r.copy_line_colors_to(i);s.needsUpdate=!0;const c=a.position;r.copy_face_vertex_locations_to(c.array),c.needsUpdate=!0;const l=a.normal;r.copy_face_normals_to(l.array),l.needsUpdate=!0}}r.copy_joint_locations_to(c.jointLocations),r.copy_unit_vectors_to(c.unitVectors),r.copy_ideal_lengths_to(c.idealLengths),r.copy_strains_to(c.strains),r.copy_strain_limits_to(c.strainLimits),r.copy_strain_nuances_to(c.strainNuances),r.copy_stiffnesses_to(c.stiffnesses),r.copy_linear_densities_to(c.linearDensities)}}const F=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function O(){if("serviceWorker"in navigator){if(new URL("/app",window.location.toString()).origin!==window.location.origin)return;window.addEventListener("load",()=>{const e="".concat("/app","/service-worker.js");F?(!function(e){fetch(e).then(t=>{404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then(e=>{e.unregister().then(()=>{window.location.reload()})}):V(e)}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")})}(e),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")})):V(e)})}}function V(e){navigator.serviceWorker.register(e).then(e=>{e.onupdatefound=()=>{const t=e.installing;t&&(t.onstatechange=()=>{"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))})}}).catch(e=>{console.error("Error during service worker registration:",e)})}var A=n(105),R=n(106),T=n(107),P=n(95),D=n(57),L=n(15),M=n(109);let _;!function(e){e.Left="Left",e.Right="Right",e.LeftRight="Left-Right",e.RightLeft="Right-Left"}(_||(_={}));_.Left,_.Right,_.LeftRight,_.RightLeft;function N(e,t,n){if(t)switch(e){case _.Left:return n?_.RightLeft:_.Right;case _.Right:return n?_.LeftRight:_.Left;case _.LeftRight:return _.RightLeft;case _.RightLeft:return _.LeftRight}else switch(e){case _.Left:return n?_.LeftRight:e;case _.Right:return n?_.RightLeft:e;case _.LeftRight:case _.RightLeft:return e}throw new Error("Spin?")}let B;!function(e){e[e.a=0]="a",e[e.B=1]="B",e[e.C=2]="C",e[e.D=3]="D",e[e.b=4]="b",e[e.c=5]="c",e[e.d=6]="d",e[e.A=7]="A"}(B||(B={}));const I=[B.a,B.B,B.C,B.D,B.b,B.c,B.d,B.A];function z(e){return"aBCDbcdA".indexOf(e)>=0}function G(e){const t="aBCDbcdA".indexOf(e);if(t<0)throw new Error("[".concat(e,"] is not a face name"));return I[t]}function W({push:e}){if(!e)throw new Error("Expected push");return e}function J({pulls:e}){if(!e)throw new Error("no pulls");return e}function U(e,t){return n=e.index,r=t.index,n<r?"(".concat(n,",").concat(r,")"):"(".concat(r,",").concat(n,")");var n,r}function H({alpha:e,omega:t}){return U(e,t)}function q(e){const t=d.dot(e);return(new s.Quaternion).setFromUnitVectors(t>0?d:m,e)}function $(e,t){return e.index!==t.index&&(e.alpha.index===t.alpha.index||e.omega.index===t.omega.index||e.alpha.index===t.omega.index||e.omega.index===t.alpha.index)}function Q(e,t){return({alpha:n,omega:r})=>n.index===e.index&&r.index===t.index||r.index===e.index&&n.index===t.index}function K(e){if(!e.push)throw new Error("No push");const t=e.push;if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("Big problem")}function X(e,t){if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("No other joint")}function Z(e){return e||{_:100}}function Y({_:e}){return e/100}function ee(e){return{_:100*e}}class te{constructor(e,t,n,r){this.forward=e,this.scale=t,this.subtrees=n,this.markNumbers=r,this.root=void 0}get nonEmpty(){return void 0===this.forward&&0===this.subtreeCode.length&&0===this.markCode.length?void 0:this}get decremented(){if(void 0!==this.forward&&this.forward.length>0){const e=this.forward.substring(0,1);return{afterNode:new te(this.forward.substring(1),this.scale,this.subtrees,this.markNumbers),action:e}}return{afterNode:this,action:""}}subtree(e){return this.subtrees[e]}faceMarks(e){return this.markNumbers[e]}deleteMark(e){delete this.markNumbers[e]}get needsOmniTwist(){const e=I.filter(e=>e!==B.A&&e!==B.a);return e.some(e=>this.subtrees[e])||e.some(e=>this.markNumbers[e])}get code(){const e=100!==this.scale._,t=this.subtreeCode,n=this.markCode;if(!this.root&&this.forward&&this.forward.length>0&&!e&&0===t.length&&0===n.length)return this.forward.toString();const r=[];return this.forward&&this.forward.length>0&&r.push(this.forward.toString()),e&&r.push("S".concat(this.scale._)),r.push(...t),r.push(...n),"(".concat(r.join(","),")")}get subtreeCode(){return Object.entries(this.subtrees).map(([e,t])=>"".concat("aBCDbcdA"[e]).concat(t.code))}get markCode(){return Object.entries(this.markNumbers).map(([e,t])=>t.map(t=>"M".concat("aBCDbcdA"[e]).concat(t._))).flat()}}var ne=n(108);function re(e,t){switch(t.faces.length){case 2:switch(e){case B.a:return t.faces[0];case B.A:return t.faces[1]}break;case 8:switch(e){case B.a:return t.faces[0];case B.B:return t.faces[2];case B.C:return t.faces[1];case B.D:return t.faces[3];case B.b:return t.faces[4];case B.c:return t.faces[5];case B.d:return t.faces[6];case B.A:return t.faces[7]}}throw new Error("Face ".concat(B[e]," not found in twist with ").concat(t.faces.length," faces"))}function ae(e,t){return e.intervals.filter(({role:e})=>!e.push).reduce((e,n)=>(t.pushes.find(e=>$(e,n))&&e.push(n),e),[])}function oe(e,t,n,r,a,o){const s=t[0],i=t[2],c=t[1],l={twist:e,spin:r,scale:a,ends:t,pushes:[W(s),W(i),W(c)],pulls:n,markNumbers:[],removed:!1,joint:o};e.faces.push(l)}function se(e,t){e.pulls.forEach(e=>t.removeInterval(e)),e.pulls=[],e.joint&&t.removeJoint(e.joint),e.removed=!0}function ie(e,t,n,r,a){const o={pushes:[],pulls:[],faces:[]},s=le(e,r,n),i=s.map(({alpha:e,omega:t})=>({alpha:a.createJoint(e),omega:a.createJoint(t)})),c=a.createJoint(j(s.map(({alpha:e})=>e))),l=a.createJoint(j(s.map(({omega:e})=>e)));a.instance.refreshFloatView(),i.forEach(({alpha:e,omega:t})=>{const n=a.createInterval(e,t,Fe,r);o.pushes.push(n),e.push=t.push=n});const u=(e,n)=>{const s=e.map(e=>a.createInterval(e,n,Ve,r));o.pulls.push(...s),oe(o,e,s,t,r,n)};return u(i.map(({alpha:e})=>e),c),u(i.map(({omega:e})=>e).reverse(),l),i.forEach(({alpha:e},t)=>{const s=i[(i.length+t+(n?-1:1))%i.length].omega;o.pulls.push(a.createInterval(e,s,Ae,r))}),o}function ce(e,t,n,r){const a={pushes:[],pulls:[],faces:[]},o=le(e,n,t),s=le(o.map(({omega:e})=>e),n,!t),i=o.map(({alpha:e,omega:t})=>({alpha:r.createJoint(e),omega:r.createJoint(t)})),c=s.map(({alpha:e,omega:t})=>({alpha:r.createJoint(e),omega:r.createJoint(t)}));r.instance.refreshFloatView();[...i,...c].forEach(({alpha:e,omega:t})=>{const o=r.createInterval(e,t,Oe,n);a.pushes.push(o),e.push=t.push=o});const l=t?[[i[0].alpha,i[1].alpha,i[2].alpha],[i[2].alpha,i[1].omega,c[1].alpha],[i[0].alpha,i[2].omega,c[2].alpha],[i[1].alpha,i[0].omega,c[0].alpha],[c[1].omega,c[0].alpha,i[1].omega].reverse(),[c[0].omega,c[2].alpha,i[0].omega].reverse(),[c[2].omega,c[1].alpha,i[2].omega].reverse(),[c[0].omega,c[1].omega,c[2].omega].reverse()]:[[i[0].alpha,i[1].alpha,i[2].alpha],[i[2].alpha,i[0].omega,c[2].alpha].reverse(),[i[0].alpha,i[1].omega,c[0].alpha].reverse(),[i[1].alpha,i[2].omega,c[1].alpha].reverse(),[c[1].omega,c[2].alpha,i[2].omega],[c[2].omega,c[0].alpha,i[0].omega],[c[0].omega,c[1].alpha,i[1].omega],[c[0].omega,c[1].omega,c[2].omega].reverse()],u=e=>r.instance.jointLocation(e),h=l.map(e=>r.createJoint(j(e.map(u))));return r.instance.refreshFloatView(),l.forEach((e,o)=>{const s=h[o],i=e.map(e=>r.createInterval(e,s,Ve,n));a.pulls.push(...i);const c=t===[0,4,5,6].some(e=>e===o)?_.Left:_.Right;oe(a,e,i,c,n,s)}),a}function le(e,t,n){const r=[],a=j(e),o=()=>(new s.Vector3).copy(a),i=Y(t),c=x(e).multiplyScalar(-i);for(let l=0;l<e.length;l++){const t=t=>S(e[(l+e.length+t)%e.length],a),u=(e,n)=>{return r=t(e),a=t(n),(new s.Vector3).addVectors(r,a).normalize();var r,a},h=o().addScaledVector(u(0,1),i),d=o().add(c).addScaledVector(n?u(1,2):u(-1,0),i);r.push({alpha:h,omega:d})}return r}function ue(e,t){const n=[];for(let r=0;r<t;r++){const a=r*Math.PI*2/t,o=Math.cos(a),i=Math.sin(a);n.push(new s.Vector3(o,0,i).add(e))}return n}const he={tag:"(aa)",push:!1,length:.5,stiffness:.4},de={tag:"conflict",push:!1,length:.01,stiffness:1};function me(e){return({role:t})=>e.tag===t.tag}function fe(e,t,n){const r=[],a=me(t),o=me(n),i=(e,t)=>((e,t)=>e.find(e=>t.find(t=>e.index===t.index)))(J(e).filter(a).map(t=>X(e,t)),J(t).filter(a).map(e=>X(t,e))),c=e.instance;return e.withPulls(l=>{const u=e=>{const t=H(e);l[t]||(r.push(e),l[t]=e)},h=e=>{const r=(e=>{const r=J(e).filter(o)[0],a=X(e,r),s=K(e),c=X(s,J(s).filter(o)[0]),l=i(e,c),u=i(a,s);if(!l||!u)return;if(l.push&&!u.push){const e=K(a);if(!J(e).some(Q(l,e)))return}else if(u.push&&!l.push){const t=K(e);if(!J(t).some(Q(u,t)))return}return{alpha:l.push?l:e,omega:u.push?u:a,scale:r.scale,role:l.push&&u.push?t:n}})(e);r&&u(r)};e.intervals.filter(me(n)).forEach(({alpha:e,omega:t})=>{h(e),h(t)}),e.joints.filter(e=>e.push&&3===J(e).filter(a).length).forEach(e=>{const t=J(e).filter(a).find(t=>!X(e,t).push);if(!t)throw new Error("no-push not found");const n=X(e,t),r=J(e).filter(a).map(t=>X(e,t)).map(t=>({end:t,outwards:(new s.Vector3).subVectors(c.jointLocation(t),c.jointLocation(e)).normalize()})),o=J(n).filter(a).map(e=>X(n,e)).map(t=>({end:t,outwards:(new s.Vector3).subVectors(c.jointLocation(t),c.jointLocation(e)).normalize()}));r.map(e=>{const n=o.sort((t,n)=>e.outwards.dot(n.outwards)-e.outwards.dot(t.outwards))[0],r=he,a=t.scale,s={alpha:e.end,omega:n.end,scale:a,role:r};u(s)})})}),r}function ge(e,t){const n=e=>({age:t,todo:e});switch(e){case"orient-0":return n(e=>{const t=e.faces.filter(({markNumbers:e})=>e.find(e=>0===e._));if(0===t.length)throw new Error("No faces marked zero");const n=e.instance,r=t.reduce((e,{ends:t})=>e.add(j(t.map(e=>n.jointLocation(e)))),new s.Vector3).multiplyScalar(1/t.length),a=t.reduce((e,{ends:t})=>e.sub(x(t.map(e=>n.jointLocation(e)))),new s.Vector3).normalize(),{b1:o,up:i,b2:c}=function(e){const{x:t,y:n,z:r}=e,a=t*t+n*n,o=n*n+r*r,i=r*r+t*t,c=new s.Vector3;return a>o&&a>i?c.set(-n,t,0).normalize():o>a&&o>i?c.set(0,-r,n).normalize():c.set(-r,0,t).normalize(),{b1:c,up:e,b2:(new s.Vector3).crossVectors(e,c).normalize()}}(a);e.instance.apply((new s.Matrix4).makeBasis(o,i,c).setPosition(r).invert()),e.fabric.set_altitude(5)});case"conflict":return n(e=>{(function(e){const t=[],n=e.instance,r=(e,t)=>{const r=n.jointLocation(e).sub(n.jointLocation(t.alpha)).normalize(),a=n.jointLocation(e).sub(n.jointLocation(t.omega)).normalize();return r.dot(a)<0};return e.joints.forEach((a,o)=>{const s=a.push;s&&e.joints.forEach((e,i)=>{if(i<=o)return;const c=e.push;if(c){const o=X(a,s),i=X(e,c);if(6*n.jointDistance(a,e)>n.jointDistance(o,i))return;r(a,c)&&r(e,s)&&t.push({jointA:a,jointB:e})}})}),t})(e).forEach(({jointA:t,jointB:n})=>{e.createInterval(t,n,de,Z())})});case"pretensing":return n(e=>{e.stage=i.Stage.Slack,e.stage=i.Stage.Pretensing});case"remove-faces":return n(e=>{e.faces.forEach(t=>se(t,e))});case"age":return n(e=>{console.log("age exceeds ".concat(e.name," @ ").concat(t),e.fabric.age)});default:throw new Error("No job named ".concat(e))}}let pe,we,be;!function(e){e[e.Subtree=0]="Subtree",e[e.Join=1]="Join",e[e.ShapingDistance=2]="ShapingDistance",e[e.PretenstDistance=3]="PretenstDistance",e[e.None=4]="None"}(pe||(pe={})),function(e){e[e.NoOp=0]="NoOp",e[e.Faces=1]="Faces",e[e.Snelson=2]="Snelson",e[e.Bowtie=3]="Bowtie",e[e.BowtieFaces=4]="BowtieFaces"}(we||(we={})),function(e){e[e.Bowtie=0]="Bowtie",e[e.Snelson=1]="Snelson"}(be||(be={}));const ye={tag:"(a)",push:!1,length:1,stiffness:1},Ee={tag:"connector",push:!1,length:1,stiffness:1},ve=-1,Se={tag:"(b)",push:!1,length:f,stiffness:1},je={tag:"pretenst-distancer",push:!1,length:1,stiffness:1},xe={tag:"shaping-distancer",push:!1,length:1,stiffness:1},ke={tag:"radial",push:!1,length:1,stiffness:1};class Ce{constructor(e,t,n){this.instance=e,this.countdown=t,this.builder=n,this.name=void 0,this.stage$=void 0,this.joints=[],this.intervals=[],this.loops=[],this.twists=[],this.connectors=[],this.distancers=[],this.pretenstAge=-1,this.scale=1,this.jobs=[],this.instance.clear(),this.stage$=new ne.a(this.fabric.get_stage()),this.builder.operateOn(this)}get fabric(){return this.instance.fabric}createJoint(e){const t={index:this.fabric.create_joint(e.x,e.y,e.z)};return this.joints.push(t),t}removeJoint(e){if(e.index<0)return;const t=e.index;this.fabric.remove_joint(t),this.joints=this.joints.filter(e=>e.index!==t),e.index=-t-1,this.joints.forEach(e=>e.index=e.index>t?e.index-1:e.index),this.instance.refreshFloatView()}createRadialPull(e,t,n,r){const a=this.instance,o=this.createJoint(a.faceLocation(e)),s=this.createJoint(a.faceLocation(t));a.refreshFloatView();const i=this.creatAxis(o,s,n,r),c=e.ends.reduce((e,t)=>e+a.jointDistance(o,t),0)/e.ends.length,l=t.ends.reduce((e,t)=>e+a.jointDistance(s,t),0)/t.ends.length,u=e.ends.map(e=>this.createRay(o,e,c)),h=t.ends.map(e=>this.createRay(s,e,l)),d={alpha:e,omega:t,axis:i,alphaRays:u,omegaRays:h};switch(i.role.tag){case"connector":this.connectors.push(d);break;case"shaping-distancer":this.distancers.push(d)}return d}createInterval(e,t,n,r,a){const o=n.length*Y(r),s=0===o?0:this.instance.jointDistance(e,t),i=void 0===a?1:a,c=this.countdown*Math.abs(o-s)*i,l=c<=0?0:1/c,u={index:this.fabric.create_interval(e.index,t.index,n.push,s,o,n.stiffness,l),role:n,scale:r,alpha:e,omega:t,removed:!1};return this.intervals.push(u),u}changeIntervalScale(e,t){e.scale=ee(Y(e.scale)*t),this.fabric.multiply_rest_length(e.index,t,100)}removeInterval(e){const t=e.index;this.intervals=this.intervals.filter(e=>e.index!==t),this.fabric.remove_interval(t),this.intervals.forEach(e=>{e.index>t&&e.index--}),e.removed=!0}faceToTriangle(e){e.pulls.forEach(e=>this.removeInterval(e)),e.pulls=[],e.joint&&this.removeJoint(e.joint);for(let t=0;t<e.ends.length;t++){const n=e.ends[t],r=e.ends[(t+1)%e.ends.length];e.pulls.push(this.createInterval(n,r,Se,e.scale))}}triangleFaces(){this.faces.forEach(e=>this.faceToTriangle(e))}withPulls(e){const t=(e,t)=>{e.pulls?e.pulls.push(t):e.pulls=[t]};this.intervals.filter(({role:e})=>!e.push).forEach(e=>{t(e.alpha,e),t(e.omega,e)});const n={};this.intervals.forEach(e=>n[function({alpha:e,omega:t}){return U(e,t)}(e)]=function({alpha:e,omega:t,scale:n,role:r}){return{alpha:e,omega:t,scale:n,role:r}}(e)),e(n),this.joints.forEach(e=>e.pulls=void 0)}createPulls(e){(()=>{switch(e){case be.Bowtie:return fe(this,ye,Se);case be.Snelson:return function(e,t,n){const r=[],a=(e,r)=>{const a=K(e),o=X(e,r);if(!a.push||!o.push)return;const s=J(a).filter(me(t)).map(e=>X(a,e)),i=J(o).filter(me(t)).map(e=>X(o,e)),c=s.find(e=>!!i.find(t=>e.index===t.index));if(!c||!c.push)return;return{alpha:e,omega:c,role:n,scale:r.scale}};return e.withPulls(t=>{e.intervals.filter(me(n)).forEach(e=>{const n=a(e.alpha,e);if(n){t[H(n)]||r.push(n)}const o=a(e.omega,e);if(o){t[H(o)]||r.push(o)}})}),r}(this,ye,Se);default:throw new Error}})().forEach(({alpha:e,omega:t,role:n,scale:r})=>{this.createInterval(e,t,n,r,5)})}removeSlackPulls(){this.intervals.filter(({role:e})=>"(aa)"===e.tag).filter(e=>0===this.instance.floatView.strains[e.index]).forEach(e=>this.removeInterval(e))}createTwist(e,t,n){const r=function(e,t,n,r){const a=r?3===r.length?r:ue(r[0],3):ue(new s.Vector3,3);switch(t){case _.Left:return ie(a,t,!0,n,e);case _.Right:return ie(a,t,!1,n,e);case _.LeftRight:return ce(a,!0,n,e);case _.RightLeft:return ce(a,!1,n,e);default:throw new Error("Spin?")}}(this,e,t,n);return this.twists.push(r),r}createTwistOn(e,t,n){const r=this.createTwist(t,n,e.ends.map(e=>this.instance.jointLocation(e)).reverse());return this.createLoop(e,re(B.a,r)),r}findTwist(e){const t=this.twists.find(({pushes:t})=>t.find(({index:t})=>t===e.index));if(!t)throw new Error("Cannot find twist");return t}get faces(){return this.twists.reduce((e,{faces:t})=>e.concat(t),[]).filter(({removed:e})=>!e)}get stage(){return this.stage$.getValue()}set stage(e){this.instance.stage=e,e===i.Stage.Slack&&(this.distancers.forEach(e=>{const{axis:t,alphaRays:n,omegaRays:r}=e;[t,...n,...r].forEach(e=>this.removeInterval(e))}),this.distancers=[],this.instance.snapshot()),this.stage$.next(e)}set toDo(e){this.jobs.push(e)}iterate(){const e=this.instance.iterate();if(e)return e;const t=this.jobs.length;if(t){const e=this.instance.fabric.age;if(this.jobs=this.jobs.filter(({todo:t,age:n})=>void 0!==n&&(n<0||n>e)||(t(this),!1)),this.jobs.length<t)return!0}switch(this.stage){case i.Stage.Growing:if(!this.builder.finished())return this.builder.work(),!1;if(this.connectors.length>0)return this.connectors=this.checkConnectors(),!1;this.stage=i.Stage.Shaping,this.jobs=this.jobs.filter(({todo:e,age:t})=>t!==ve||(e(this),!1));break;case i.Stage.Shaping:case i.Stage.Slack:break;case i.Stage.Pretensing:this.stage=i.Stage.Pretenst;break;case i.Stage.Pretenst:this.pretenstAge<0&&(this.pretenstAge=this.fabric.age)}return!1}strainToStiffness(){const e=this.instance,t=e.floatView,n=this.intervals.filter(t=>!t.role.push&&(e.jointLocation(t.alpha).y>=0||e.jointLocation(t.omega).y>=0)),r=t.strains,a=n.reduce((e,t)=>e+r[t.index],0)/n.length,o=new Float32Array(t.stiffnesses);n.forEach(e=>{const t=(r[e.index]-a)/a;o[e.index]*=1+t}),e.restoreSnapshot(),this.fabric.copy_stiffnesses(o)}createRadialPulls(e,t,n){const r=e=>this.instance.faceLocation(e),a=()=>{const t=this.createTwist(_.LeftRight,ee(function(e){return e.reduce((e,t)=>e+Y(t.scale),0)/e.length}(e)),[this.instance.averageFaceLocation(e)]);return this.instance.refreshFloatView(),e.map(e=>{const n=t.faces.filter(({spin:t,pulls:n})=>n.length>0&&t!==e.spin),a=r(e),o=n.reduce((e,t)=>r(e).distanceTo(a)<r(t).distanceTo(a)?e:t);return this.createRadialPull(o,e,Ee)})},o=n||ee(.75);switch(t){case pe.ShapingDistance:case pe.PretenstDistance:if(!o)throw new Error("Missing pull scale");e.forEach((n,r)=>{e.forEach((e,a)=>{if(r<=a)return;const s=t===pe.ShapingDistance?xe:je;this.createRadialPull(n,e,s,o)})});break;case pe.Join:switch(e.length){case 2:e[0].spin===e[1].spin?a():this.createRadialPull(e[0],e[1],Ee);break;case 3:a()}}}checkConnectors(){if(0===this.connectors.length)return this.connectors;const e=(e,t)=>{!function(e,t,n){const r=[...t.ends].reverse(),a=n.ends,o=[];for(let c=0;c<r.length;c++){let t=0;for(let n=0;n<r.length;n++){const o=(n+c)%r.length;t+=e.jointDistance(r[n],a[o]),t+=e.jointDistance(a[o],r[(n+1)%r.length])}o.push(t)}let s=0,i=o[s];o.forEach((e,t)=>{e<i&&(s=t,i=e)}),s>0&&(n.ends=n.ends.map(({},e)=>n.ends[(e+s)%n.ends.length]))}(this.instance,e,t),this.createLoop(e,t)};return this.connectors.filter(({axis:t,alpha:n,omega:r,alphaRays:a,omegaRays:o})=>{if("connector"===t.role.tag){if(this.instance.jointDistance(t.alpha,t.omega)<=.05)return e(n,r),this.removeInterval(t),a.forEach(e=>this.removeInterval(e)),o.forEach(e=>this.removeInterval(e)),!1}return!0})}getIntervalDetails(e){const t=this.instance,{floatView:n}=t;return{interval:e,strain:n.strains[e.index],length:t.intervalLength(e)*this.scale,height:t.intervalLocation(e).y*this.scale}}createLoop(e,t){const n=[...e.ends].reverse(),r=t.ends,a=ee((Y(e.scale)+Y(t.scale))/2),o=[];for(let s=0;s<n.length;s++){const e=n[s],t=n[(s+1)%n.length],i=r[s];o.push(this.createInterval(e,i,ye,a)),o.push(this.createInterval(i,t,ye,a))}se(t,this),se(e,this),this.loops.push(o)}creatAxis(e,t,n,r){const a=this.instance.jointDistance(e,t),o=r?Y(r)*a:.025,s=Z(),i=1/(this.countdown*Math.abs(o-a)),c={index:this.fabric.create_interval(e.index,t.index,!1,a,o,1,i),alpha:e,omega:t,role:n,scale:s,removed:!1};return this.intervals.push(c),c}createRay(e,t,n){const r=this.instance.jointDistance(e,t),a=ke,o=ee(n),s=1/(this.countdown*Math.abs(n-r)),i={index:this.fabric.create_interval(e.index,t.index,!1,r,n,1,s),alpha:e,omega:t,role:a,scale:o,removed:!1};return this.intervals.push(i),i}}const Fe={tag:"[A]",push:!0,length:2.44948974278,stiffness:1},Oe={tag:"[B]",push:!0,length:2.8025170768881464,stiffness:1},Ve={tag:"(a)",push:!1,length:1,stiffness:1},Ae={tag:"(b)",push:!1,length:f,stiffness:1};function Re(e,t){try{const n=Me(e.code.join());return n?(n.root=!0,n):void t("Nothing to compile")}catch(n){return void t(n.message)}}class Te{constructor(e,t,n){this.location=e,this.tenscript=t,this.tree=n,this.tensegrity=void 0,this.markDefStrings=void 0,this.buds=void 0}operateOn(e){this.tensegrity=e,this.tenscript.scale&&(this.tensegrity.scale=this.tenscript.scale),e.name=this.tenscript.name,e.instance.world.set_surface_character(this.tenscript.surfaceCharacter),this.markDefStrings=this.tenscript.markDefStrings?this.tenscript.markDefStrings:{},this.tenscript.jobs&&this.tenscript.jobs.forEach(({todo:t,age:n})=>e.toDo=ge(t,n)),this.tensegrity.toDo=function(e){const t=ve,n=e=>({age:t,todo:e});switch(e){case we.Faces:return n(e=>{e.triangleFaces()});case we.Snelson:return n(e=>{e.createPulls(be.Snelson),e.triangleFaces()});case we.Bowtie:return n(e=>{e.createPulls(be.Bowtie)});case we.BowtieFaces:return n(e=>{e.createPulls(be.Bowtie),e.triangleFaces()});default:return n(()=>{})}}(this.tenscript.postGrowthOp),this.buds=[De(e,this.location,this.tenscript,this.tree)]}finished(){return 0===this.buds.length}work(){this.buds=function(e){const t=[];return e.forEach(e=>{const{tensegrity:n,tree:r,markActions:a,reorient:o}=e;if(void 0!==r.forward&&r.forward.length>0){const{afterNode:n,action:a}=r.decremented,o=r.needsOmniTwist&&void 0!==n.forward&&0===n.forward.length;t.push(_e(e,a,n,B.A,o,r.scale))}else{if(o){if(![B.A,B.a,B.B,B.b].some(e=>!r.subtree(e))){const e=n.joints.map(e=>n.instance.jointLocation(e));n.instance.apply(function(e,t){const n=S(e[0],e[1]),r=S(e[3],e[2]),a=S(e[5],e[4]),o=e.reduce((e,t)=>e.add(t),new s.Vector3).multiplyScalar(1/e.length),i=(new s.Matrix4).makeBasis(n,r,a).setPosition(o),c=(new s.Matrix4).makeRotationZ(-.24*Math.PI),l=(new s.Matrix4).makeRotationY(-Math.PI/2-t*Math.PI/3);return i.multiply(c).multiply(l).invert()}(e,0))}}I.forEach(n=>{const o=r.subtree(n);if(o){const{afterNode:r,action:a}=o.decremented,s=o.needsOmniTwist&&""===o.forward;t.push(_e(e,a,r,n,s,o.scale))}else{const o=r.faceMarks(n);o&&o.forEach(o=>{const s=a[o._];if(s&&s.action===pe.Subtree){const a=s.tree;if(!a)throw new Error("Missing subtree");r.deleteMark(n);const o=a.needsOmniTwist;t.push(_e(e,"",a,n,o,Z(a.scale)))}})}})}}),t}(this.buds),this.finished()&&function(e,t,n){const r=Le(n),a={};return t.forEach(e=>{e.markNumbers.forEach(t=>{const n=a[t._];n?n.push(e):a[t._]=[e]})}),Object.entries(a).map(([t])=>{const n=r[t]||r[-1],o=n||pe.None;return new Pe(e,a[t],o)})}(this.tensegrity,this.tensegrity.faces,this.markDefStrings).forEach(e=>e.execute())}}class Pe{constructor(e,t,n){this.tensegrity=e,this.faces=t,this.markAction=n}execute(){switch(this.markAction.action){case pe.Join:case pe.ShapingDistance:case pe.PretenstDistance:this.tensegrity.createRadialPulls(this.faces,this.markAction.action,this.markAction.scale)}}}function De(e,t,n,r){const a=void 0===r.forward,{spin:o,markDefStrings:s}=n,i=e.createTwist(o,Z(),[t]);return{tensegrity:e,tree:r,twist:i,markActions:Le(s),reorient:a}}function Le(e){const t={};return e&&Object.keys(e).forEach(n=>{const r=e[n];if(r.startsWith("subtree")){const e=Me(r.substring("subtree".length));t[n]={action:pe.Subtree,tree:e}}else if(r.startsWith("join"))t[n]={action:pe.Join};else if(r.startsWith("shaping-distance-")){const e={_:parseInt(r.split("-")[2],10)};t[n]={action:pe.ShapingDistance,scale:e}}else if(r.startsWith("pretenst-distance-")){const e={_:parseInt(r.split("-")[2],10)};t[n]={action:pe.PretenstDistance,scale:e}}}),t}function Me(e){const t=Ie(e,!0).content;let n,r=Z();const a={},o={};function s(e){const{content:n,skip:r}=Ie(t.substring(e),!1);return{codeTree:Me(n),skip:r}}function i(e,t){const n=o[e],r={_:t};n?n.push(r):o[e]=[r]}for(let c=0;c<t.length;c++){const e=t.charAt(c);if(z(e)){const n=s(c+1),r=n.codeTree;if(!r)throw new Error("No subtree: ".concat(t.substring(c)));a[G(e)]=r,c+=n.skip}else if(Ne(e)){const e=Ie(t,!1),r=Be(e.content);n="X".repeat(r),c+=e.skip}else if("X"===e||"O"===e){const e=Ie(t,!1);n=e.content,c+=e.skip}else switch(e){case"S":const n=Ie(t.substring(c+1),!0);r={_:Be(n.content)},c+=n.skip;break;case"M":const a=t.charAt(c+1),o=Ie(t.substring(c+2),!0);i(G(a),Be(o.content)),c+=o.skip+1;break;case",":case" ":case"\n":break;default:throw new Error("Unexpected character: ".concat(e))}}return new te(n,r,a,o).nonEmpty}function _e({tensegrity:e,twist:t,markActions:n},r,a,o,s,i){const c=re(o,t),l=(()=>{switch(r){case"O":return N(c.spin,!1,s);default:return N(c.spin,!0,s)}})(),u=ee(Y(c.scale)*Y(i)),h=e.createTwistOn(c,l,u);var d,m;return""===a.forward&&(d=h,m=a,I.forEach(e=>{const t=m.faceMarks(e);t&&re(e,d).markNumbers.push(...t)})),{tensegrity:e,tree:a,twist:h,markActions:n,reorient:!1}}function Ne(e){return"0123456789".indexOf(e)>=0}function Be(e){if(!e.match(/^\d*$/))throw new Error("Not a number: ".concat(e));return 0===e.length?0:parseInt(e,10)}function Ie(e,t){const n=e.indexOf(","),r=n>=0;if("("!==e.charAt(0))return r?{content:e.substring(0,n),skip:n}:{content:e,skip:e.length};const a=function(e){if("("!==e.charAt(0))throw new Error('Code must start with "(": '.concat(e," ").concat(e.charAt(0)));let t=0;for(let n=0;n<e.length;n++){const r=e.charAt(n);if("("===r)t++;else if(")"===r&&(t--,0===t))return n}throw new Error("No matching end bracket: |".concat(e,"|"))}(e),o=t?e.substring(1,a):e.substring(0,a+1);return{content:o.length>0?o:"0",skip:a+1}}var ze=n(56);const{persistAtom:Ge}=Object(ze.recoilPersist)({key:"pretenst-2022-04-06",storage:localStorage}),We=[Ge],Je=Object(o.atom)({key:"postGrowth",default:we.NoOp,effects_UNSTABLE:We}),Ue=Object(o.atom)({key:"bootstrapIndex",default:0,effects_UNSTABLE:We}),He=Object(o.atom)({key:"tenscript",default:void 0,effects_UNSTABLE:We}),qe=Object(o.atom)({key:"currentFeature",default:i.WorldFeature.VisualStrain,effects_UNSTABLE:We});const $e=Object(o.atom)({key:"rotating",default:!1}),Qe=Object(o.atom)({key:"globalMode",default:E()});let Ke;!function(e){e.Time="Time",e.Select="Select",e.Look="Look"}(Ke||(Ke={}));const Xe=Object(o.atom)({key:"viewMode",default:Ke.Time}),Ze=(Object(o.atom)({key:"surfaceCharacter",default:i.SurfaceCharacter.Frozen}),g.map(e=>{const t=u(i.WorldFeature[e]);return{mapping:t,percentAtom:Object(o.atom)({key:t.name,default:100,effects_UNSTABLE:We})}})),Ye=Object(o.atom)({key:"selectedTwist",default:void 0}),et=Object(o.atom)({key:"visibleDetails",default:[]});function tt(){const[e,t]=Object(o.useRecoilState)(Xe);function n({item:n,children:a}){return r.createElement(D.a,{disabled:n===e,color:n===e?"success":"secondary",onClick:()=>t(n)},a)}return r.createElement(P.a,null,r.createElement(n,{item:Ke.Time},r.createElement(M.s,null)),r.createElement(n,{item:Ke.Select},r.createElement(M.n,null)),r.createElement(n,{item:Ke.Look},r.createElement(M.e,null)))}var nt=n(60),rt=n(61),at=n.n(rt);function ot(e){return e.toFixed(5).replace(/[.]/,",")}function st(){return(new Date).toISOString().replace(/[.].*/,"").replace(/[:T_]/g,"-")}function it(e,t){const{name:n,instance:r,joints:a,intervals:o,scale:s}=e;r.refreshFloatView();const i=r.floatView.idealLengths;return{name:n,joints:a.map(e=>{const n=r.jointLocation(e);return t&&n.multiplyScalar(s),{index:e.index,x:n.x,y:n.z,z:n.y}}),intervals:o.map(e=>{const t=e.role.push,n=e.alpha.index,r=e.omega.index;if(n>=a.length||r>=a.length)throw new Error("Joint not found ".concat(e.role.tag,":").concat(n,",").concat(r,":").concat(a.length));return{index:e.index,joints:[n,r],type:t?"Push":"Pull",role:e.role.tag,scale:e.scale._,idealLength:i[e.index]*s,isPush:t}})}}function ct(e){const t=new at.a;t.file("joints.csv",function(e){const t=[];return t.push(["index","x","y","z"]),e.joints.forEach(e=>t.push([(e.index+1).toFixed(0),ot(e.x),ot(e.y),ot(e.z)])),t.map(e=>e.join(";")).join("\n")}(e)),t.file("intervals.csv",function(e){const t=[];return t.push(["joints","type","role","ideal length"]),e.intervals.forEach(e=>{t.push(['"=""'.concat(e.joints.map(e=>(e+1).toFixed(0)),'"""'),e.type,e.role,ot(e.idealLength)])}),t.map(e=>e.join(";")).join("\n")}(e)),t.file("submerged.csv",function(e){const t=[];return t.push(["joints"]),t.push(['"=""'.concat(e.joints.filter(({y:e})=>e<=0).map(e=>e.index+1),'"""')]),t.map(e=>e.join(";")).join("\n")}(e)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then(e=>{nt.saveAs(e,"pretenst-".concat(st(),".zip"))})}function lt({tensegrity:e}){const[t,n]=Object(r.useState)(e.stage$.getValue());Object(r.useEffect)(()=>{const t=e.stage$.subscribe(n);return()=>t.unsubscribe()},[e]);const[a]=Object(o.useRecoilState)(Xe),[s,c]=Object(o.useRecoilState)($e);return r.createElement("div",{className:"text-right"},r.createElement(P.a,null,a!==Ke.Time?r.createElement(r.Fragment,null,r.createElement(D.a,{onClick:()=>ct(it(e,!0))},r.createElement(M.j,null),r.createElement(M.m,null)),r.createElement(D.a,{onClick:()=>function(e){const t=new at.a;t.file("pretenst-".concat(st(),".json"),JSON.stringify(e,void 0,2)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then(e=>{nt.saveAs(e,"pretenst-".concat(st(),".zip"))})}(it(e,!1))},r.createElement(M.j,null),r.createElement(M.l,null))):t>i.Stage.Slack?r.createElement(r.Fragment,null,r.createElement(D.a,{disabled:t!==i.Stage.Pretenst,onClick:()=>e.fabric.set_altitude(10)},r.createElement(M.r,null))):void 0,r.createElement(D.a,{onClick:()=>e.fabric.centralize()},r.createElement(M.h,null)),r.createElement(D.a,{color:s?"warning":"secondary",onClick:()=>c(!s)},r.createElement(M.y,null)),r.createElement(D.a,{color:"warning",onClick:()=>v(w.Choice)},r.createElement(M.v,null))))}var ut=n(113),ht=n(98);const dt=["#fd0000","#c94f00","#d58e1c","#897c00","#6c8901","#1d6c01","#0e4e00","#007f67","#01808b","#005da3","#0015c7","#0000ff"].reverse().map(e=>(new s.Color).setHex(parseInt("".concat(e.substring(1)),16))),mt=new s.LineBasicMaterial({vertexColors:!0});dt.map(e=>new s.MeshLambertMaterial({color:e}));function ft(e,t){const n=function(e){return new s.Color(function(e){if(!e)return"#FFFFFF";switch(e.tag){case"[A]":return"#191f86";case"[B]":return"#5739a0";case"(a)":return"#a20d0d";case"(b)":return"#eeec05";case"(aa)":return"#da04b7";case"(bb)":return"#00ff06";default:return"#FFFFFF"}}(e))}(e),r=t?.4:1;return new s.MeshLambertMaterial({color:n,opacity:r,transparent:!0})}function gt(e,t){switch(t){case Ke.Select:return e.role.push?.05:.02;case Ke.Look:return e.role.push?.03:.01;default:throw new Error("Bad view mode")}}const pt=new s.CylinderGeometry(1,1,1,12,1,!1);function wt({tensegrity:e}){return r.createElement("lineSegments",{key:"lines",geometry:e.instance.floatView.lineGeometry,material:mt})}function bt({tensegrity:e}){const t=e.instance;return r.createElement("group",null,e.intervals.map(e=>{const{alpha:n,omega:a,role:o}=e,i=q(t.unitVector(e.index)),c=t.jointDistance(n,a),l=gt(e,Ke.Look),u=new s.Vector3(l,c,l);return r.createElement("mesh",{key:"T".concat(e.index),geometry:pt,position:t.intervalLocation(e),rotation:(new s.Euler).setFromQuaternion(i),scale:u,material:ft(o),matrixWorldNeedsUpdate:!0})}))}var yt=n(96),Et=n(97);function vt({instance:e,details:t,singleDetails:n,onClick:a}){return r.createElement(yt.a,{className:"interval-details ".concat(n?"single-details":""),position:e.intervalLocation(t.interval)},r.createElement("div",{onMouseDown:e=>a(t)},r.createElement("div",{className:"details-mouse"},r.createElement(M.q,null)),r.createElement(Et.a,{className:"details-table"},r.createElement("thead",null,r.createElement("tr",null,r.createElement("td",{colSpan:2},t.interval.alpha.index,"-",t.interval.omega.index))),r.createElement("tbody",null,r.createElement("tr",null,r.createElement("td",{className:"text-right"},"Length:"),r.createElement("td",{className:"text-center"},t.length.toFixed(1),"mm")),r.createElement("tr",null,r.createElement("td",{className:"text-right"},"Height:"),r.createElement("td",{className:"text-center"},t.height.toFixed(1),"mm")),r.createElement("tr",null,r.createElement("td",{className:"text-right"},"Strain:"),r.createElement("td",{className:"text-center"},(100*t.strain).toFixed(1),"%"))))))}function St({tensegrity:e,clickDetails:t}){const[n,a]=Object(o.useRecoilState)(Ye),[i]=Object(o.useRecoilState)(et),c=e.instance;return r.createElement("group",null,e.intervals.map(t=>{if(!t.role.push){if(!n)return;if(!n.pushes.find(e=>$(e,t)))return}const o=q(c.unitVector(t.index)),i=c.jointDistance(t.alpha,t.omega),l=gt(t,Ke.Select),u=new s.Vector3(l,i,l);return r.createElement("mesh",{key:"T".concat(t.index),geometry:pt,position:c.intervalLocation(t),rotation:(new s.Euler).setFromQuaternion(o),scale:u,material:ft(t.role),matrixWorldNeedsUpdate:!0,onDoubleClick:r=>{if(r.stopPropagation(),t.role.push)if(n){const r=n.pushes.find(e=>e.index===t.index);a(r?void 0:e.findTwist(t))}else a(e.findTwist(t))}})}),i.map(n=>r.createElement(vt,{key:"deets-".concat(n.interval.index),instance:e.instance,details:n,singleDetails:1===i.length,onClick:t})))}const jt=new s.MeshPhongMaterial({color:new s.Color("#070707"),specular:new s.Color("#110404"),side:s.FrontSide}),xt=[new s.Vector3(0,0,-20),new s.Vector3(-17.32,0,-10),new s.Vector3(-17.32,0,10),new s.Vector3(0,0,20),new s.Vector3(17.32,0,10),new s.Vector3(17.32,0,-10),new s.Vector3],kt=[6,0,1,6,1,2,6,2,3,6,3,4,6,4,5,6,5,0].map(e=>xt[e]);function Ct(){const e=Object(r.useMemo)(()=>function(){const e=new s.BufferGeometry,t=new Float32Array(3*kt.length),n=new Float32Array(3*kt.length);return kt.forEach((e,r)=>{const a=3*r;t[a]=e.x,t[a+1]=e.y-.01,t[a+2]=e.z;const o=new s.Vector3(0,300,0).add(e).normalize();n[a]=o.x,n[a+1]=o.y,n[a+2]=o.z}),e.setAttribute("position",new s.BufferAttribute(t,3)),e.setAttribute("normal",new s.BufferAttribute(n,3)),e}(),[]);return r.createElement("mesh",{name:"Patches",geometry:e,material:jt})}function Ft({tensegrity:e,clickDetails:t}){const[n]=Object(o.useRecoilState)(Xe),[a]=Object(o.useRecoilState)(Ye),[c,l]=Object(r.useState)(new s.Vector3),[u,h]=Object(r.useState)(e.stage$.getValue());Object(r.useEffect)(()=>{const t=e.stage$.subscribe(h);return()=>t.unsubscribe()},[e]);const[d]=Object(o.useRecoilState)($e);return Object(L.b)(t=>{n===Ke.Time&&e.iterate();const r=a?e.instance.twistLocation(a):e.instance.midpoint,o=(new s.Vector3).subVectors(r,c).multiplyScalar(.1);if((n===Ke.Time||o.lengthSq()>.001)&&l((new s.Vector3).copy(c).add(o)),u===i.Stage.Growing){t.camera.position.y+=.1*(r.y-t.camera.position.y);const n=t.camera.position.distanceTo(r)-1.5*e.instance.view.radius(),a=(new s.Vector3).subVectors(r,t.camera.position).normalize().multiplyScalar(.1*n);t.camera.position.add(a)}else t.camera.position.y<0&&(t.camera.position.y-=.1*t.camera.position.y*20)}),r.createElement("group",null,r.createElement(ut.a,{autoRotate:d,target:c,zoomSpeed:.5,maxDistance:200}),r.createElement("scene",null,n===Ke.Time?r.createElement(wt,{tensegrity:e}):n===Ke.Select?r.createElement(St,{tensegrity:e,clickDetails:t}):r.createElement(bt,{tensegrity:e}),r.createElement(Ct,null),r.createElement(ht.a,{radius:400}),r.createElement("ambientLight",{color:new s.Color("white"),intensity:.8}),r.createElement("directionalLight",{color:new s.Color("#FFFFFF"),intensity:2})))}function Ot({tenscript:e,createInstance:t}){const n=Object(r.useMemo)(()=>t(e.featureValues),[]),[a,c]=Object(r.useState)(),[l,h]=Object(o.useRecoilState)(Xe),[d,m]=Object(o.useRecoilState)(Ye),[f,w]=Object(o.useRecoilState)(et),b=Object(o.useSetRecoilState)(Je),y=e=>console.error("build view",e),[E,v]=Object(r.useState)();Object(r.useEffect)(()=>{const e=a?a.stage$.subscribe(v):void 0;return()=>{e&&e.unsubscribe()}},[a]);Object(r.useEffect)(()=>{((e,t)=>{try{const r=Re(e,t);if(!r)return!1;h(Ke.Time),b(e.postGrowthOp);const a=e.featureValues;g.map(e=>{const t=i.WorldFeature[e],{percentToValue:r}=u(t),o=a?a[t]:void 0;void 0!==o&&n.applyFeature({feature:t,percent:o,value:r(o)},!0)});const o=a?a[i.WorldFeature.IntervalCountdown]:void 0,l=void 0===o?Object(i.default_world_feature)(i.WorldFeature.IntervalCountdown):o,d=new Te(new s.Vector3,e,r);c(new Ce(n,l,d))}catch(r){throw new Error("Problem running")}})(e,y)},[]),Object(r.useEffect)(()=>{l===Ke.Time&&m(void 0)},[l]),Object(r.useEffect)(()=>{a&&w(d?d.pushes.map(e=>a.getIntervalDetails(e)):[])},[d]);const S=()=>{switch(l){case Ke.Time:return r.createElement("span",null,void 0!==E?p(E):"New"," ",a?'"'.concat(a.name,'"'):"");case Ke.Select:return r.createElement("span",null,"Double click to select a twist");case Ke.Look:return r.createElement("span",null,a?'"'.concat(a.name,'"'):"")}},j=Object(o.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},a?r.createElement("div",{className:"h-100"},r.createElement(L.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:l!==Ke.Time?"#f0ad4e":"black",cursor:l===Ke.Select?"pointer":"default",borderWidth:"2px"}},r.createElement(j,null,r.createElement(Ft,{tensegrity:a,clickDetails:({interval:e})=>{d&&a&&(1===f.length||e.role.push?w(ae(a,d).map(e=>a.getIntervalDetails(e))):w(f.filter(t=>t.interval.index===e.index)))}}))),r.createElement("div",{id:"top-middle"},r.createElement(S,null)),r.createElement("div",{id:"bottom-left"},r.createElement(tt,null)),r.createElement("div",{id:"bottom-right"},r.createElement(lt,{tensegrity:a}))):r.createElement("div",{className:"h-100"},r.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},r.createElement("h1",null,r.createElement(M.s,null)))))}const Vt=[{x:0,y:0},{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1},{x:4,y:0},{x:3,y:-1},{x:2,y:-2},{x:0,y:-2},{x:-2,y:-2},{x:-3,y:-1},{x:-4,y:0},{x:-3,y:1},{x:-2,y:2},{x:0,y:2},{x:2,y:2},{x:3,y:1},{x:6,y:0},{x:5,y:-1},{x:4,y:-2},{x:3,y:-3},{x:1,y:-3},{x:-1,y:-3},{x:-3,y:-3},{x:-4,y:-2},{x:-5,y:-1},{x:-6,y:0},{x:-5,y:1},{x:-4,y:2},{x:-3,y:3},{x:-1,y:3},{x:1,y:3},{x:3,y:3},{x:4,y:2},{x:5,y:1}],At=[{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1}],Rt=Math.sin(60*Math.PI/180),Tt=17.5/Rt,Pt=Tt*Rt,Dt=1.5*Tt,Lt=[new s.Vector3(0,0,-Tt),new s.Vector3(-Rt*Tt,0,-Tt/2),new s.Vector3(-Rt*Tt,0,Tt/2),new s.Vector3(0,0,Tt),new s.Vector3(Rt*Tt,0,Tt/2),new s.Vector3(Rt*Tt,0,-Tt/2)],Mt=new s.Color("#091009"),_t=new s.Color("#100902"),Nt=new s.Vector3(0,1,0),Bt=new s.Vector3(0,500,0);class It{constructor(e,t){this.roll=e,this.genes=t}createReader(e){return new zt(Yt(e,this.genes),this.roll)}get totalTwitches(){return 16}withMutations(e,t){const n=this.genes.map(e=>{const{geneName:t,tosses:n}=e;return{geneName:t,tosses:n,dice:e.dice.slice()}});if(e.forEach(e=>{Ht(()=>this.roll(),Yt(e,n))}),t){const e=Yt(Qt.TwitchConfig,n);Ht(()=>this.roll(),e),e.tosses++}return new It(this.roll,n)}get geneData(){return this.genes.map(e=>{const{geneName:t,tosses:n,dice:r}=e;return{geneName:t,tosses:n,geneString:function(e){return e.map(e=>e.symbol).join("")}(r)}})}get tosses(){return this.genes.reduce((e,{tosses:t})=>e+t,0)}toString(){return this.genes.map(e=>"(".concat(e.geneName,":").concat(e.tosses,")")).join(", ")}}class zt{constructor(e,t){this.gene=e,this.roll=t,this.cursor=0}chooseFrom(e){return Math.floor(e*$t(this.nextDie(),this.nextDie()))}readMuscleTwitch(e,t){const{attackPeriod:n,decayPeriod:r,twitchNuance:a}=t;return{muscle:e[this.nextDie().index],twitchNuance:a,when:Jt(36,this.nextDie(),this.nextDie()),attack:(2+Ut(6,this.nextDie()))*n,decay:(2+Ut(6,this.nextDie()))*r}}readFeatureValue(e,t){const n=$t(this.nextDie(),this.nextDie(),this.nextDie());return e*n+t*(1-n)}get length(){return this.gene.dice.length}nextDie(){for(;this.gene.dice.length<this.cursor+1;)this.gene.dice.push(this.roll());return this.gene.dice[this.cursor++]}}const Gt=[{index:0,numeral:"1",symbol:"\u2680"},{index:1,numeral:"2",symbol:"\u2681"},{index:2,numeral:"3",symbol:"\u2682"},{index:3,numeral:"4",symbol:"\u2683"},{index:4,numeral:"5",symbol:"\u2684"},{index:5,numeral:"6",symbol:"\u2685"}],Wt=(()=>{const e={};return Gt.forEach(t=>{e[t.numeral]=t,e[t.symbol]=t}),e})();function Jt(e,...t){return Math.floor($t(...t)*e)}function Ut(e,...t){return $t(...t)*e}function Ht(e,t){if(0===t.dice.length)t.dice.push(e());else{const n=Math.floor(Math.random()*t.dice.length),r=t.dice[n];for(;t.dice[n]===r;)t.dice[n]=e()}t.tosses++}function qt(){return Gt[Math.floor(Math.random()*Gt.length)]}function $t(...e){if(0===e.length)throw new Error("No dice!");return e.reduce((e,t)=>6*e+t.index,0)/Math.pow(6,e.length)}let Qt,Kt;function Xt(){return new It(qt,[])}function Zt(e){if(0===e.length)return Xt();const t=e.map(({geneName:e,tosses:t,geneString:n})=>({geneName:e,tosses:t,dice:n.split("").map(e=>Wt[e]).filter(e=>!!e)}));return new It(qt,t)}function Yt(e,t){const n=t.find(({geneName:t})=>e===t);if(n)return n;const r={geneName:e,tosses:0,dice:[]};return t.push(r),r}!function(e){e.ToA="ToA",e.ToB="ToB",e.ToC="ToC",e.TwitchConfig="TwitchConfig"}(Qt||(Qt={}));class en{constructor(e,t,n){this.island=e,this.coords=t,this.patchCharacter=n,this.runner=void 0,this.flora=void 0,this.center=void 0,this.name=void 0,this.adjacent=[],this.center=new s.Vector3(t.x*Pt,0,t.y*Dt),this.name="(".concat(t.x,",").concat(t.y,")")}get storedGenes(){const e=localStorage.getItem(this.name);return e?JSON.parse(e):[Xt().geneData]}set storedGenes(e){localStorage.setItem(this.name,JSON.stringify(e))}get positionArray(){const e=new Float32Array(54);let t=0;const n=n=>{const{x:r,y:a,z:o}=(new s.Vector3).copy(this.center).addScaledVector(n,.99);e[t++]=r,e[t++]=a,e[t++]=o};for(let r=0;r<6;r++){const e=(r+1)%6;n(new s.Vector3),n(Lt[r]),n(Lt[e])}return e}get normalArray(){const e=new Float32Array(54);let t=0;const n=({x:n,y:r,z:a})=>{e[t++]=n,e[t++]=r,e[t++]=a};for(let r=0;r<6;r++){const e=(r+1)%6;n(Nt),n((new s.Vector3).add(Nt).addScaledVector(Lt[r],.9/35).normalize()),n((new s.Vector3).add(Nt).addScaledVector(Lt[e],.9/35).normalize())}return e}}!function(e){e.FaunaPatch="Fauna",e.FloraPatch="Flora"}(Kt||(Kt={}));const tn={name:"Runner",spin:_.LeftRight,code:["(A1,B(".concat(5,",S").concat(90,"),C(").concat(5,",S").concat(90,"),D(").concat(5,",S").concat(90,"))")],postGrowthOp:we.Bowtie,markDefStrings:{},surfaceCharacter:i.SurfaceCharacter.Bouncy,featureValues:{[i.WorldFeature.IterationsPerFrame]:300,[i.WorldFeature.Drag]:200,[i.WorldFeature.StiffnessFactor]:150,[i.WorldFeature.Gravity]:500}},nn=(we.Bowtie,_.Left,i.SurfaceCharacter.Frozen,Object(o.atom)({key:"island",default:new class{constructor(e,t){this.name=e,this.patches=[],this._seed=void 0,this._seed=t%2147483647,this.fill()}get midpoint(){return this.patches.reduce((e,t)=>e.add(t.center),new s.Vector3).multiplyScalar(1/this.patches.length)}findPatch(e){return this.patches.find(t=>{return n=t.coords,r=e,n.x===r.x&&n.y===r.y;var n,r})}fill(){this.createSurroundedPatch({x:0,y:0}),this.patches.forEach(e=>{const t=e.coords;At.forEach(({x:n,y:r})=>{e.adjacent.push(this.findPatch({x:n+t.x,y:r+t.y}))})})}createSurroundedPatch(e){const t=this.getOrCreatePatch(e);return Vt.map(t=>{return this.getOrCreatePatch((r=e,{x:(n=t).x+r.x,y:n.y+r.y}));var n,r}),t}getOrCreatePatch(e){const t=this.findPatch(e);if(t)return t;const n=this.next()>.5?Kt.FaunaPatch:Kt.FloraPatch,r=new en(this,e,n);return this.patches.push(r),r}next(){return this._seed=16807*this._seed%2147483647,(this._seed-1)/2147483646}}("galapagos",383)})),rn=Object(o.selector)({key:"MySelector",get:({get:e})=>e(nn).patches[0]}),an=Object(o.atom)({key:"destination",default:0}),on=Object(o.atom)({key:"showDetails",default:!1});var sn=n(114);let cn;!function(e){e.Rest="Rest",e.ToA="ToA",e.ToB="ToB",e.ToC="ToC"}(cn||(cn={}));const ln=Object.keys(cn).map(e=>cn[e]);function un(e){switch(e){case cn.ToA:return Qt.ToA;case cn.ToB:return Qt.ToB;case cn.ToC:return Qt.ToC;default:throw new Error("No gene for direction ".concat(e))}}function hn(e,t,n,r,a){if(!a)return;const o=a.joint;if(!o)return;const s=e.floatView.jointLocations,i=(e,t,n)=>{const r=3*e.index,a=3*t.index;n.set(s[a]-s[r],0,s[a+2]-s[r+2]),n.normalize()};i(o,a.ends[0],t),i(o,a.ends[1],n),i(o,a.ends[2],r)}const dn=[4,5,6,7,8,9],mn=8,fn=8;let gn;!function(e){e.SurvivorsAdvance="Survivors advance",e.ChallengersBorn="Challengers born",e.ChallengersReborn="Challengers reborn",e.ChallengersOvertake="Challengers try to overtake",e.SurvivorsStored="Survivors stored",e.EvolutionAdvance="Evolution advance",e.EvolutionDone="Evolution done",e.EvolutionHarder="Evolution harder"}(gn||(gn={}));class pn{constructor(e,t,n,r){if(this.ancestor=e,this.createInstance=t,this.useTwitches=n,this.cyclePattern=r,this.snapshotsSubject=new ne.a([]),this.winners=[],this.midpoint=void 0,this.challengersVisible=!1,this.challengers=[],this.phase=gn.SurvivorsAdvance,this.cyclePatternIndex=void 0,this.currentCycle=0,this.currentMaxCycles=void 0,e.embryo)throw new Error("Cannot create evolution from runner which is not pretenst");this.midpoint=e.state.midpoint,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex=0];const a=[],o=e.state.patch.storedGenes;for(;a.length<mn;)a.push(this.createAutoRunner(Zt(o[a.length%o.length])));this.winners=a.map((e,t)=>({runner:e,name:yn(t),proximityHistory:[],persisted:!0}))}get withReducedCyclePattern(){const e=[...this.cyclePattern];if(e.pop(),!(e.length<3))return new pn(this.ancestor,this.createInstance,this.useTwitches,e)}iterate(){switch(this.phase){case gn.SurvivorsAdvance:let e=0,t=!1;if(this.winners.forEach(({runner:n})=>{const r=n.getCycleCount(this.useTwitches);r>e&&(e=r),r<this.currentMaxCycles&&(n.iterate(),t=!0)}),e>this.currentCycle&&(wn(this.winners,this.currentCycle),this.currentCycle=e),!t){!this.winners.find(({runner:e})=>!e.reachedTarget)?this.phase=gn.EvolutionDone:(this.winners.forEach(e=>e.runner.showFrozen()),this.phase=0===this.challengers.length?gn.ChallengersBorn:gn.ChallengersReborn,this.currentCycle=0)}break;case gn.ChallengersBorn:const n=[];for(;n.length<fn;){const e=Zt(this.winners[n.length%this.winners.length].runner.state.genome.geneData);n.push(this.createAutoRunner(e.withMutations([un(this.ancestor.direction)],!1)))}this.challengers=n.map((e,t)=>{e.autopilot=!0;return{runner:e,name:"".concat(yn(t+this.winners.length)).concat(yn(t%this.winners.length)),proximityHistory:[],persisted:!1}}),this.phase=gn.ChallengersOvertake;break;case gn.ChallengersReborn:let r=0;this.challengers=this.challengers.map((e,t)=>{const n=r++%this.winners.length,a=this.winners[n],o=e.runner.adoptFabric(this.ancestor.state.instance.fabricClone),s=e.runner.recycled(o,a.runner.mutatedGeneData()),i="".concat(a.name).concat(yn(t));return s.autopilot=!0,{runner:s,name:i,proximityHistory:[],persisted:!1}}),this.phase=gn.ChallengersOvertake;break;case gn.ChallengersOvertake:this.challengersVisible=!0;let a=!1,o=0;if(this.challengers.forEach(({runner:e,name:t})=>{const n=e.getCycleCount(this.useTwitches);n>o&&(o=n),n<this.currentMaxCycles&&(e.iterate(),a=!0)}),o>this.currentCycle){const e=[...this.winners,...this.challengers];wn(e,this.currentCycle),this.broadcastSnapshot(e.map(e=>bn(e,this.currentCycle))),this.currentCycle=o}a||(this.phase=gn.SurvivorsStored);break;case gn.SurvivorsStored:const{winners:s,losers:i}=this.splitEvolvers(this.currentCycle);this.ancestor.state.patch.storedGenes=s.map(({runner:e})=>e.state.genome.geneData),s.forEach(e=>e.persisted=!0),i.forEach(e=>e.persisted=!1),this.broadcastSnapshot(s.map(e=>bn(e,this.currentCycle))),this.winners=s,this.challengers=i,this.challengersVisible=!1,this.phase=gn.EvolutionAdvance;break;case gn.EvolutionAdvance:if(this.cyclePatternIndex===this.cyclePattern.length-1){const e=!this.winners.find(({runner:e})=>!e.reachedTarget);this.phase=e?gn.EvolutionHarder:gn.EvolutionDone}else this.cyclePatternIndex++,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex],this.currentCycle=0,this.phase=gn.SurvivorsAdvance;break;case gn.EvolutionDone:case gn.EvolutionHarder:}return this.midpoint.set(0,0,0),this.winners.forEach(({runner:e})=>this.midpoint.add(e.state.midpoint)),this.challengers.forEach(({runner:e})=>this.midpoint.add(e.state.midpoint)),this.midpoint.multiplyScalar(1/(this.winners.length+this.challengers.length)),this.phase}get target(){return this.ancestor.target}splitEvolvers(e){const t=[],n=[],r=[...this.winners,...this.challengers];return wn(r,e),r.forEach((e,r)=>{r<mn?t.push(e):n.push(e)}),{cycleCount:e,winners:t,losers:n}}broadcastSnapshot(e){const t=this.currentCycle,n=this.cyclePatternIndex,r={cycle:t,cyclePattern:this.cyclePattern,cycleIndex:n,evolverSnapshots:e},a=this.snapshotsSubject.getValue(),o=a.findIndex(e=>r.cycleIndex===e.cycleIndex);if(o<0)this.snapshotsSubject.next([...a,r]);else if(o===a.length-1){const e=[...a];e[o]=r,this.snapshotsSubject.next(e)}else this.snapshotsSubject.next([r])}createAutoRunner(e){const t=this.createInstance(tn.featureValues,this.ancestor.state.instance.fabricClone),n=this.ancestor.recycled(t,e.geneData);return n.autopilot=!0,n}}function wn(e,t){e.forEach(e=>{if(e.proximityHistory.length===t){const t=e.runner.distanceFromTarget;e.proximityHistory.push(t)}}),e.sort((e,n)=>e.proximityHistory[t]-n.proximityHistory[t])}function bn({runner:e,proximityHistory:t,persisted:n,name:r},a){const o=t[a];if(void 0===o)throw new Error("Cannot snapshot");const s=e.state.genome.tosses;return{name:r,proximity:o,reachedTarget:e.reachedTarget,tosses:s,persisted:n}}function yn(e){return String.fromCharCode(65+e)}function En({runner:e}){const{topFaceLocation:t,target:n,state:a,showDirection:o}=e,s=a.instance.floatView;return r.createElement("group",null,r.createElement("lineSegments",{geometry:s.lineGeometry,onUpdate:e=>e.geometry.computeBoundingSphere()},r.createElement("lineBasicMaterial",{attach:"material",vertexColors:!0})),o&&t?r.createElement("group",null,r.createElement("lineSegments",null,r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([t.x,t.y,t.z,n.x,t.y,n.z]),count:2,itemSize:3,onUpdate:e=>e.needsUpdate=!0})),r.createElement("lineBasicMaterial",{attach:"material",color:"#FFFFFF"})),r.createElement("lineSegments",{quaternion:e.directionQuaternion,position:t},r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([0,0,0,0,0,5]),count:2,itemSize:3,onUpdate:e=>e.needsUpdate=!0})),r.createElement("lineBasicMaterial",{attach:"material",color:"#f80303"}))):void 0)}function vn({population:e}){const{midpoint:t,target:n}=e;return r.createElement("group",null,e.winners.map(({runner:e},t)=>r.createElement(En,{key:"evolving-".concat(t),runner:e})),e.challengersVisible?e.challengers.map(({runner:t},n)=>r.createElement(En,{key:"evolving-".concat(n+e.winners.length),runner:t})):void 0,r.createElement("lineSegments",null,r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([t.x,0,t.z,t.x,6,t.z,t.x,6,t.z,n.x,6,n.z,n.x,6,n.z,n.x,0,n.z]),count:6,itemSize:3,onUpdate:e=>e.needsUpdate=!0})),r.createElement("lineBasicMaterial",{attach:"material",color:"#ffffff"})))}function Sn({island:e,happening:t,runner:n,population:a,evolutionPhase:i,countdownToEvo:c,stopEvo:l}){const[u,h]=Object(r.useState)(!1),[d,m]=Object(o.useRecoilState)(an),[f,g]=Object(r.useState)(Date.now()),[p,w]=Object(r.useState)(Date.now()),[b,y]=Object(r.useState)(new s.Vector3(0,1,0));function E(e){y((new s.Vector3).subVectors(e,b).multiplyScalar(.05).add(b))}return Object(L.b)(e=>{const{camera:r,clock:o}=e;0===o.elapsedTime&&r.position.set(30,30,10);const u=e=>{const t=(new s.Vector3).subVectors(r.position,b),n=e-t.length();t.normalize(),r.position.y+=.01*(3-r.position.y),r.position.add(t.multiplyScalar(.003*n))};switch(t){case On.Developing:n&&(n.iterate(),E(n.state.midpoint),u(9));break;case On.Resting:n&&(n.iterate(),E(n.state.midpoint),u(12));break;case On.Running:n&&(n.iterate(),E(n.state.midpoint),u(9));break;case On.Evolving:if(a){switch(a.iterate()){case gn.EvolutionDone:console.log("Evolution DONE"),l();break;case gn.EvolutionHarder:console.log("Evolution advance..."),l(a.withReducedCyclePattern)}E(a.midpoint),u(25),i(a.phase)}}const h=Math.floor((p-f)/1e3),d=Date.now();w(d);const m=Math.floor((d-f)/1e3);t===On.Resting&&h<m&&c(5-m)}),Object(r.useEffect)(()=>{g(Date.now()),w(Date.now()),h(t===On.Evolving)},[t]),r.createElement("group",null,r.createElement(ut.a,{target:b,maxDistance:250,minDistance:1,enablePan:!1,autoRotateSpeed:.6,autoRotate:u,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.5*Math.PI}),r.createElement("scene",null,a&&t===On.Evolving?r.createElement(vn,{population:a}):n?r.createElement(En,{runner:n}):void 0,e.patches.map(e=>{const t=e.positionArray,a=e.normalArray;return r.createElement("mesh",{key:"patch-".concat(e.name),onClick:()=>function(e){e.flora?(e.flora.removeRandomInterval(),console.log("remove",e.name)):n&&n.direction===cn.Rest&&m((d+1)%6)}(e)},r.createElement("meshPhongMaterial",{attach:"material",side:s.DoubleSide,color:e.patchCharacter===Kt.FaunaPatch?Mt:_t}),r.createElement("bufferGeometry",{attach:"geometry"},r.createElement("bufferAttribute",{attachObject:["attributes","position"],array:t,count:t.length/3,itemSize:3}),r.createElement("bufferAttribute",{attachObject:["attributes","normal"],array:a,count:a.length/3,itemSize:3})))}),r.createElement(sn.a,{distance:1e6,rayleigh:3,inclination:.505,mieCoefficient:.001,mieDirectionalG:.93,turbidity:7.5}),r.createElement("pointLight",{distance:1e3,decay:.1,position:Bt}),r.createElement("hemisphereLight",{name:"Hemi"})))}class jn{constructor(e){this.state=e,this.cycleCount=0,this.twitchCount=0,this.config=void 0,this.twitchCycles={};const t=this.state.genome;this.config=(()=>{const e=t.createReader(Qt.TwitchConfig),n=e.readFeatureValue(800,1200);return{twitchNuance:e.readFeatureValue(.1,.3),musclePeriod:n,attackPeriod:e.readFeatureValue(.5,1)*n,decayPeriod:e.readFeatureValue(.5,1)*n}})();const n=t.totalTwitches;ln.filter(e=>e!==cn.Rest).forEach(e=>{const r=un(e),a=t.createReader(r);this.twitchCycles[e]=new xn(a,this.config,this.state.loopMuscles,n)})}toString(){const e=Object.keys(this.twitchCycles).map(e=>this.twitchCycles[e]).map(e=>e.toString()).join("\n");return"Twitcher(".concat(e,")")}tick(e){const t=this.state;if(t.timeSlice++,t.timeSlice>=36)return t.timeSlice=0,this.cycleCount++,!0;const n=this.twitchCycles[t.direction];return n&&(this.twitchCount+=n.activate(t.timeSlice,e)),!1}}class xn{constructor(e,t,n,r){this.slices={};const a=[...n];for(;r-- >0;){const n=e.chooseFrom(a.length),r=e.readMuscleTwitch(a[n],t);a.splice(n,1),this.addTwitch(r.when,r)}}toString(){const e=Object.keys(this.slices).map(e=>this.slices[e]).map(e=>e.map(e=>"".concat(e.when,":").concat(e.muscle.interval.index)).join(";")).join(",");return"Cycle(".concat(e,")")}activate(e,t){const n=this.slices[e];return n?(n.forEach(({muscle:e,attack:n,decay:r,twitchNuance:a})=>t(e,n,r,a)),n.length):0}addTwitch(e,t){const n=this.slices[e];n?n.push(t):this.slices[e]=[t]}}class kn{constructor(e,t){this.state=e,this.embryo=t,this.toA=new s.Vector3(1,0,0),this.toB=new s.Vector3(0,0,1),this.toC=new s.Vector3(0,0,-1),this.shapingTime=150,this.twitcher=void 0,this.topFace=void 0,this.currentTwitchAge=0,t||(this.twitcher=new jn(this.state)),this.currentTwitchAge=this.twitchAge}get growing(){return!!this.embryo}recycled(e,t){const n=Zt(t||this.state.patch.storedGenes[0]),r=(new s.Vector3).copy(this.state.midpoint),a={...this.state,instance:e,midpoint:r,genome:n,directionHistory:[]},o=new kn(a);return o.topFace=this.topFace,hn(o.state.instance,o.toA,o.toB,o.toC,this.topFace),o}getCycleCount(e){return this.twitcher?e?Math.floor(this.twitcher.twitchCount/this.state.twitchesPerCycle):this.twitcher.cycleCount:0}get autopilot(){return this.state.autopilot}set autopilot(e){this.state.autopilot=e}get direction(){return this.state.direction}set direction(e){this.state.direction=e,this.autopilot=!1}adoptFabric(e){return this.state.instance.adoptFabric(e)}mutatedGeneData(){const e=ln.map(e=>{const t=this.state.directionHistory.filter(t=>t===e).length;return{dir:e,count:t}}).filter(e=>e.count>0).map(e=>e.dir).map(un);return this.state.genome.withMutations(e,Math.random()>.9).geneData}get age(){return this.state.instance.fabric.age}get distanceFromTarget(){return this.state.midpoint.distanceTo(this.target)}iterate(){const e=this.state.instance.view;this.state.midpoint.set(e.midpoint_x(),e.midpoint_y(),e.midpoint_z());const t=this.embryo;if(!t){if(this.state.instance.iterate(),this.twitcher){const e=this.twitchAge;if(e<=this.currentTwitchAge)return!0;this.currentTwitchAge=e;const t=(e,t,n,r)=>{const a=e=>{e&&this.state.instance.fabric.twitch_interval(e.index,t,n,r)};a(e.alphaInterval),a(e.omegaInterval)};this.state.autopilot&&this.twitcher.tick(t)&&(this.reachedTarget?this.direction=cn.Rest:this.checkDirection())}return!0}if(t.iterate())return!0;switch(t.stage$.getValue()){case i.Stage.Shaping:return this.shapingTime<=0?t.stage=i.Stage.Slack:this.shapingTime--,!1;case i.Stage.Slack:return this.topFace=function(e){const t=e.faces.sort((t,n)=>{const r=t.joint,a=n.joint;if(!r||!a)throw new Error("faces without joints");const o=e.instance.jointLocation(r),s=e.instance.jointLocation(a);return o.y-s.y}),n=t.pop();if(t.forEach(t=>e.faceToTriangle(t)),!n)throw new Error("no top face");return n}(t),t.stage=i.Stage.Pretensing,!1;case i.Stage.Pretensing:return!1;case i.Stage.Pretenst:return this.state.loopMuscles=function(e){const t=[];return e.withPulls(()=>{e.loops.forEach(e=>t.push(e.map(e=>{const t=e.alpha.pulls,n=e.omega.pulls;if(!t||!n)throw new Error("missing pulls");const r=({role:e})=>"(aa)"===e.tag||"(bb)"===e.tag,a=t.find(r),o=n.find(r);if(!a&&!o)throw new Error("cannot find any intervals");return{interval:e,alphaInterval:a,omegaInterval:o}})))}),t}(t),this.state.instance.refreshFloatView(),hn(this.state.instance,this.toA,this.toB,this.toC,this.topFace),this.checkDirection(),this.twitcher=new jn(this.state),this.embryo=void 0,!0;default:return!1}}showFrozen(){this.state.instance.showFrozen(this.reachedTarget)}get topFaceLocation(){const e=this.topFace;if(!e)return;const t=e.joint;return t?this.state.instance.jointLocation(t):void 0}get target(){return this.state.targetPatch.center}get showDirection(){return this.state.direction!==cn.Rest}get directionQuaternion(){return this.quaternionForDirection(this.state.direction)}get reachedTarget(){return this.distanceFromTarget<4}checkDirection(){const e=this.state;if(this.reachedTarget)this.direction=cn.Rest;else{if(e.direction=this.directionToTarget,e.direction===cn.Rest)return void console.error("direction is REST??");e.directionHistory.push(e.direction),e.directionHistory.length>20&&e.directionHistory.shift()}}get twitchAge(){return this.state.instance.fabric.age/600}quaternionForDirection(e){return(new s.Quaternion).setFromUnitVectors(h,(()=>{switch(e){case cn.Rest:case cn.ToA:return this.toA;case cn.ToB:return this.toB;case cn.ToC:return this.toC}})())}get directionToTarget(){const e=this.toTarget;hn(this.state.instance,this.toA,this.toB,this.toC,this.topFace);const t=e.dot(this.toA),n=e.dot(this.toB),r=e.dot(this.toC);return t>n&&t>r?cn.ToA:n>t&&n>r?cn.ToB:r>t&&r>n?cn.ToC:cn.Rest}get toTarget(){const e=new s.Vector3;return e.subVectors(this.target,this.state.midpoint),e.y=0,e.normalize(),e}}function Cn({snapshots:e}){const t=Object(o.useSetRecoilState)(on);return r.createElement("div",{className:"text-monospace d-inline-flex",onClick:()=>t(!1)},e.map(e=>r.createElement("div",{key:e.cycleIndex,className:"float-left p-1 m-1",style:{borderStyle:"solid",borderWidth:"2px"}},r.createElement(Fn,{snapshot:e}),r.createElement("div",{className:"m-2"},e.evolverSnapshots.map((e,t)=>{const{name:n,reachedTarget:a,persisted:o,proximity:s,tosses:i}=e,c=[];let l=n.length-1;for(;l>0;)c.push(r.createElement(M.i,{key:"".concat(n,"-").concat(l)})),l--;const u=a?r.createElement(M.z,null):void 0;return r.createElement("div",{key:"competitor-".concat(t),style:{color:o?a?"#ffffff":"#2cd710":"#c2c2c2",backgroundColor:o?a?"#b1b1b1":"#848383":"#555454",borderRadius:"0.2em",marginBottom:"1px",padding:"2px",display:"block",whiteSpace:"nowrap"}},"".concat(yn(t)," ").concat(s.toFixed(3)," ").concat(n).concat(i),"\xa0",c,u)})))))}function Fn({snapshot:e}){const{cyclePattern:t,cycleIndex:n,cycle:a}=e,s=Object(o.useSetRecoilState)(on);return r.createElement("div",{className:"p-1 my-2 w-100 text-center",onClick:()=>s(!1)},t.map((e,o)=>r.createElement("span",{key:"cycle-".concat(o),style:{color:"black",backgroundColor:o===n?"#24f00f":"#cbc7c7",margin:"0.1em",padding:"0.2em",borderRadius:"0.3em",borderStyle:"solid",borderWidth:"1px"}},o===n&&a<t[n]?"".concat(a+1,"/").concat(e):e)))}let On;function Vn({createBodyInstance:e}){const[t]=Object(o.useRecoilState)(nn),n=Object(o.useRecoilValue)(rn),a=Object(o.useRecoilValue)(an),[c,l]=Object(o.useRecoilState)(on),[u,h]=Object(r.useState)(()=>F(n)),[d,m]=Object(r.useState)(On.Developing),[f,g]=Object(r.useState)([]),[b,y]=Object(r.useState)(-1),[E,S]=Object(r.useState)(void 0),[j,x]=Object(r.useState)(gn.SurvivorsAdvance),[k,C]=Object(r.useState)(void 0);function F(t){const n=t.adjacent[0];if(!n)throw new Error("No adjacent");const r=t.storedGenes[0],a=r?Zt(r):Xt(),o=e(tn.featureValues);o.world.set_surface_character(i.SurfaceCharacter.Sticky);const c={patch:t,targetPatch:n,instance:o,midpoint:(new s.Vector3).copy(t.center),genome:a,loopMuscles:[],direction:cn.ToA,directionHistory:[],autopilot:!1,timeSlice:10,twitchesPerCycle:10},l=Re(tn,e=>{throw new Error("unable to compile runner: "+e)});if(!l)throw new Error("no tree");const u=new Te(t.center,tn,l),h=new Ce(o,1e3,u);return new kn(c,h)}Object(r.useEffect)(()=>{if(u){const e=u.state.patch.adjacent[a];e&&(u.state.targetPatch=e)}},[a]),Object(r.useEffect)(()=>{if(!u||!u.embryo)return void C(void 0);const e=u.embryo.stage$.subscribe(e=>{e===i.Stage.Pretenst&&m(On.Resting),C(e)});return()=>e.unsubscribe()},[u]),Object(r.useEffect)(()=>{if(!E)return;const e=E.snapshotsSubject.subscribe(g);return()=>e.unsubscribe()},[E]);const O=(t,n)=>{S(E?E.withReducedCyclePattern:new pn(t,e,!1,n)),m(On.Evolving)},V=Object(o.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},r.createElement(L.a,{key:t.name,style:{backgroundColor:"black"}},r.createElement(V,null,r.createElement(Sn,{island:t,happening:d,runner:u,population:E,evolutionPhase:e=>{e!==j&&x(e)},countdownToEvo:e=>{y(e),u&&0===e&&O(u,dn)},stopEvo:e=>{S(e),e||(h(F(n)),m(On.Developing))}}))),u?d===On.Developing?k?r.createElement("div",{id:"bottom-middle"},r.createElement("div",{className:"py-2 px-3 text-center"},r.createElement(M.b,null)," ",p(k))):r.createElement("h1",null,"nothing"):r.createElement(An,{runner:u,happening:d,evoCountdown:b,toRunning:()=>{m(On.Running),u.autopilot=!0},toEvolving:()=>{m(On.Evolving),y(-1),O(u,dn)},toRebirth:()=>{h(F(n)),m(On.Developing)},toRest:()=>{m(On.Resting),u.direction=cn.Rest}}):r.createElement("h1",null,"no runner"),E?r.createElement(r.Fragment,null,r.createElement("div",{id:"top-middle"},c?void 0:r.createElement(D.a,{color:"info",onClick:()=>l(!0)},"Phase: ",j,r.createElement("br",null),0===f.length?void 0:r.createElement(Fn,{snapshot:f[f.length-1]}))),c?r.createElement(Rn,{happening:d,snapshots:f}):void 0):void 0,r.createElement("div",{id:"bottom-right"},r.createElement(P.a,{vertical:!1,className:"w-100"},r.createElement(D.a,{color:"warning",onClick:()=>v(w.Choice)},r.createElement(M.v,null)))))}function An({runner:e,happening:t,evoCountdown:n,toRunning:a,toRest:o,toEvolving:s,toRebirth:i}){const c=(()=>{switch(t){case On.Developing:return r.createElement("h1",null,"developing");case On.Resting:return e?r.createElement(P.a,{className:"w-100"},r.createElement(D.a,{color:"success",onClick:a},r.createElement(M.t,null)),r.createElement(D.a,{color:"success",onClick:s},r.createElement(M.i,null)," ",n>=0?n:""),r.createElement(D.a,{color:"success",onClick:i},r.createElement(M.b,null))):void 0;case On.Running:return e?r.createElement(P.a,{className:"w-100"},r.createElement(D.a,{color:"success",onClick:o},r.createElement(M.z,null)," Rest")):void 0;case On.Evolving:return e?r.createElement(P.a,{className:"w-100"},r.createElement(D.a,{color:"success",onClick:i},r.createElement(M.b,null))):void 0}})();return c?r.createElement("div",{id:"bottom-middle"},c):r.createElement("h1",null,t)}function Rn({happening:e,snapshots:t}){switch(e){case On.Developing:case On.Running:case On.Resting:return r.createElement("div",null);case On.Evolving:return r.createElement("div",{id:"evolution-stats"},t.length>0?r.createElement(Cn,{snapshots:t}):r.createElement("h2",{className:"p-2"},"First round, please wait"))}}!function(e){e[e.Developing=0]="Developing",e[e.Resting=1]="Resting",e[e.Running=2]="Running",e[e.Evolving=3]="Evolving"}(On||(On={}));const Tn=[{name:"Phi",spin:_.LeftRight,postGrowthOp:we.NoOp,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["()"]},{name:"One",spin:_.Left,postGrowthOp:we.NoOp,surfaceCharacter:i.SurfaceCharacter.Bouncy,code:["(1)"],jobs:[{age:3e4,todo:"pretensing"}],featureValues:{[i.WorldFeature.IterationsPerFrame]:300}},{name:"Axoneme",spin:_.Left,surfaceCharacter:i.SurfaceCharacter.Frozen,postGrowthOp:we.Bowtie,code:["(30,S95)"]},{name:"Knee",spin:_.Left,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(3,b3)"]},{name:"Jack",spin:_.LeftRight,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(a2,b2,c2,d2)"]},{name:"Star",spin:_.LeftRight,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(a(15,S90),b(15,S90),c(15,S90),d(15,S90))"]},{name:"Tripod with Knees",spin:_.RightLeft,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(A5,B(7,c(5,S90),S90),C(7,c(5,S90),S90),D(7,c(5,S90),S90))"]},{name:"Zigzag",spin:_.LeftRight,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(c(3,MA1),d(7,b(7,c(7,d(7,c(7,d(3,MA1)))))))"],markDefStrings:{1:"join"}},{name:"Diamond",spin:_.RightLeft,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(","   a(5,","      b(5,b(5,b(2,MA3)),c(5,c(2,MA4))),","      c(5,b(5,b(2,MA1)),c(5,c(2,MA5))),","      d(5,b(5,b(2,MA6)),c(5,c(2,MA2)))","   )","   b(5,b(5,b(2,MA5)),c(5,c(2,MA3))),","   c(5,b(5,b(2,MA2)),c(5,c(2,MA1))),","   d(5,b(5,b(2,MA4)),c(5,c(2,MA6)))",")"],markDefStrings:{1:"join",2:"join",3:"join",4:"join",5:"join",6:"join"}},{name:"Composed Tree",spin:_.Left,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(6,b(4,MA1),c(4,MA1),d(4,MA1))"],markDefStrings:{1:"subtree(b5,c5,d5)"}},{name:"Equus Lunae",spin:_.LeftRight,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(","  A(16,S95,Md0),","  b(16,S95,Md0),","  a(16,S95,Md0),","  B(16,S95,Md0)",")"],markDefStrings:{0:"shaping-distance-60"}},{name:"Runner",spin:_.LeftRight,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Bouncy,code:["(A1,B(5,S90),C(5,S90),D(5,S90))"]},{name:"Infinity",spin:_.LeftRight,postGrowthOp:3,surfaceCharacter:2,code:["(","A(11,S88,MA1),b(11,S88,MA1),","a(11,S88,MA2),B(11,S88,MA2)",")"],featureValues:{},markDefStrings:{1:"join",2:"join"}},{name:"Propellor Tree",spin:_.LeftRight,postGrowthOp:3,surfaceCharacter:2,code:["(","  a(5,S110),","  B(11,S90,MA3),","  b(11,S90,MA1),","  C(11,S90,MA2),","  c(11,S90,MA3),","  D(11,S90,MA1),","  d(11,S90,MA2),",")"],featureValues:{},markDefStrings:{1:"join",2:"join",3:"join",4:"join"}},{name:"Halo by Crane",spin:_.Left,scale:100,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(5,S92,b(12,S92,MA1),d(11,S92,MA1))"],markDefStrings:{1:"join"},jobs:[{age:6e4,todo:"pretensing"}],featureValues:{[i.WorldFeature.Gravity]:50}},{name:"Convergence",spin:_.LeftRight,scale:125,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(a2,b(8,S90,MA1),c(8,S90,MA1),d(8,S90,MA1))"],markDefStrings:{1:"join"},jobs:[{age:6e4,todo:"pretensing"}],featureValues:{[i.WorldFeature.VisualStrain]:0,[i.WorldFeature.PushOverPull]:2e3,[i.WorldFeature.IterationsPerFrame]:200}},{name:"Headless Hug",spin:_.LeftRight,scale:105,postGrowthOp:we.BowtieFaces,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(","A(OOOOXOO,S95,MA0),","b(OOOOXOO,S95,MA0),","a(3,C(XOOOXOO,S93,MA3),S90,MA2),","B(3,C(XOOOXOO,S93,MA3),S90,MA2)",")"],markDefStrings:{0:"shaping-distance-5",2:"shaping-distance-7",3:"shaping-distance-5"},featureValues:{[i.WorldFeature.IterationsPerFrame]:100,[i.WorldFeature.PushOverPull]:400},jobs:[{age:1e5,todo:"pretensing"},{age:11e4,todo:"conflict"},{age:12e4,todo:"orient-0"}]},{name:"Triped",spin:_.LeftRight,scale:100,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Bouncy,code:["(B(9,S90,MA1),C(9,S90,MA1),D(9,S90,MA1))"],markDefStrings:{1:"shaping-distance-25"},featureValues:{[i.WorldFeature.PushOverPull]:1e3},jobs:[{age:8e4,todo:"pretensing"}]},{name:"Glass Tower",spin:_.Left,scale:500,postGrowthOp:we.Bowtie,surfaceCharacter:i.SurfaceCharacter.Frozen,code:["(A(2,MA0),a(1,MA0))"],markDefStrings:{0:"pretenst-distance-60"},featureValues:{[i.WorldFeature.VisualStrain]:0,[i.WorldFeature.PushOverPull]:1e3,[i.WorldFeature.StiffnessFactor]:500,[i.WorldFeature.IterationsPerFrame]:500},jobs:[{age:13e3,todo:"pretensing"},{age:15e3,todo:"remove-faces"}]}].map(e=>(Re(e,t=>{throw new Error('Bootstrap compile error in "'.concat(e,'"! ').concat(t))}),e)),Pn=Tn.filter(({scale:e})=>void 0!==e),Dn={tag:"push",push:!0,length:8,stiffness:1},Ln={tag:"pull",push:!1,length:1,stiffness:1};class Mn{constructor(e,t,n){if(this.width=e,this.height=t,this.shift=n,this.tensegrity=void 0,t%2===0)throw new Error("Even height not allowed")}operateOn(e){this.tensegrity=e}finished(){return this.tensegrity.joints.length>0}work(){for(let n=0;n<this.width*this.height/2;n++)this.randomJoint();this.tensegrity.instance.refreshFloatView();const e=(e,t,n,r)=>this.tensegrity.createInterval(e,t,n,r,100),t=(e,t,n)=>this.tensegrity.instance.fabric.create_face(e.index,t.index,n.index);for(let n=0;n<this.height;n++){const r=Z();for(let a=0;a<this.width;a++)if((a+n)%2===0){const o=this.kleinJoint(a,n),s=this.kleinJoint(a-1,n+1),i=this.kleinJoint(a+1,n+1),c=this.kleinJoint(a,n+2),l=this.kleinJoint(a-1,n+3),u=this.kleinJoint(a+1,n+3);e(o,s,Ln,r),e(o,i,Ln,r),e(o,c,Ln,r),e(o,l,Dn,r),e(o,u,Dn,r),e(l,u,Dn,r),t(o,s,c),t(o,i,c)}}}randomJoint(){const e=new s.Vector3(100);for(;e.lengthSq()>1;)e.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1);this.tensegrity.createJoint(e)}kleinJoint(e,t){const n=Math.floor(t/this.height)%2===1?this.shift-1-e:e,r=(2*this.width+n)%this.width,a=t%this.height,o=Math.floor((a*this.width+r)/2);return this.tensegrity.joints[o]}}var _n=n(103),Nn=n(99),Bn=n(100),In=n(101),zn=n(102);const Gn=new s.MeshLambertMaterial({color:"#FFFFFF",side:s.DoubleSide});function Wn({createKlein:e}){const[t,n]=Object(r.useState)("31"),[a,s]=Object(r.useState)("10"),[c,l]=Object(r.useState)(!1),[h,d]=Object(r.useState)(!0),m=()=>e(Un(a,18),Un(t,41),0),[f,g]=Object(o.useRecoilState)($e),[p,b]=Object(r.useState)(m);return Object(r.useEffect)(()=>{if(p){const e=i.WorldFeature.ShapingDrag,t=h?1e3:0,n=u(e).percentToValue(t);p.instance.applyFeature({feature:e,percent:t,value:n},!1)}},[h,p]),r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},r.createElement("div",{id:"bottom-right"},r.createElement(P.a,null,r.createElement(D.a,{color:f?"warning":"secondary",onClick:()=>g(!f)},r.createElement(M.y,null)),r.createElement(D.a,{color:"warning",onClick:()=>v(w.Choice)},r.createElement(M.v,null)))),r.createElement("div",{id:"top-left"},r.createElement(Nn.a,{style:{width:"9em",backgroundColor:"white",margin:"1em",padding:"1em",borderRadius:"1em"},onSubmit:e=>{e.preventDefault(),b(()=>m()),l(!1)}},r.createElement(Bn.a,null,r.createElement(In.a,{for:"height"},"Height(odd)"),r.createElement(zn.a,{id:"height",value:t,valid:qn(t),invalid:!qn(t),onChange:({target:e})=>{console.log("set height",e.value),n(e.value)}})),r.createElement(Bn.a,null,r.createElement(In.a,{for:"width"},"Width(even)"),r.createElement(zn.a,{id:"width",value:a,valid:Hn(a),invalid:!Hn(a),onChange:({target:e})=>s(e.value)})),r.createElement(D.a,{color:"success",className:"w-100 my-1",type:"submit"},"Generate!"),r.createElement("hr",null),r.createElement(D.a,{color:c?"warning":"secondary",className:"w-100 my-1",onClick:()=>l(!c)},c?"Unfreeze":"Freeze"),r.createElement(D.a,{color:h?"warning":"secondary",className:"w-100 my-1",onClick:()=>d(!h)},h?"Free":"Drag"))),r.createElement(L.a,{style:{backgroundColor:"black"}},p?r.createElement(Jn,{klein:p,frozen:c,rotating:f}):r.createElement("h1",null,"No Klein")))}function Jn({klein:e,frozen:t,rotating:n}){const[a,o]=Object(r.useState)(new s.Vector3);return Object(L.b)(n=>{const{camera:r,clock:i}=n;i.elapsedTime<.01&&r.position.set(50,0,0),t||e.iterate();const c=(new s.Vector3).subVectors(e.instance.midpoint,a).multiplyScalar(.001);o((new s.Vector3).copy(a).add(c))}),r.createElement("group",null,r.createElement(ut.a,{target:a,autoRotate:n,maxDistance:200,zoomSpeed:.3}),r.createElement("scene",null,t?r.createElement("mesh",{geometry:e.instance.floatView.faceGeometry,material:Gn,matrixAutoUpdate:!1}):r.createElement("lineSegments",{geometry:e.instance.floatView.lineGeometry,material:mt,onUpdate:e=>e.geometry.computeBoundingSphere()}),r.createElement(_n.a,{makeDefault:!0},r.createElement("pointLight",{color:new s.Color("#4fa903"),position:new s.Vector3(0,100,0)}),r.createElement("pointLight",{color:new s.Color("#043eb7"),position:new s.Vector3(0,-10,100)}),r.createElement("pointLight",{color:new s.Color("#f60606"),position:new s.Vector3(0,-10,-100)}))))}function Un(e,t){const n=parseInt(e,10);return isNaN(n)?t:n}function Hn(e){const t=parseInt(e,10);return!isNaN(t)&&t%2===0}function qn(e){const t=parseInt(e,10);return!isNaN(t)&&t%2===1}const $n={tag:"push",push:!0,length:3,stiffness:1},Qn={tag:"pull-width",push:!1,length:1,stiffness:1},Kn={tag:"pull-length",push:!1,length:.4,stiffness:1};class Xn{constructor(e){this.radius=void 0,this.jointCount=void 0,this.tensegrity=void 0,this.jointCount=2*e+1,this.radius=this.jointCount*Kn.length*.17}operateOn(e){this.tensegrity=e}finished(){return this.tensegrity.joints.length>0}work(){const e=(e,t)=>{const n=new s.Vector3(Math.cos(t)*this.radius,0,Math.sin(t)*this.radius),r=(new s.Vector3).copy(n).normalize(),a=new s.Vector3(0,1,0),o=(new s.Vector3).addVectors(r.multiplyScalar(Math.sin(t/2)),a.multiplyScalar(Math.cos(t/2))).multiplyScalar(e?-.5:.5);return n.add(o)};for(let n=0;n<this.jointCount;n++){const t=n/this.jointCount*Math.PI*2;this.tensegrity.createJoint(e(n%2===0,t))}this.tensegrity.instance.refreshFloatView();const t=(e,t,n)=>this.tensegrity.createInterval(e,t,n,Z(),1e3);for(let n=0;n<this.jointCount;n++){const e=e=>this.tensegrity.joints[(2*n+e)%this.tensegrity.joints.length];t(e(0),e(2),Kn),t(e(0),e(1),Qn),t(e(0),e(3),$n),this.tensegrity.instance.fabric.create_face(e(0).index,e(1).index,e(2).index)}}}const Zn=new s.MeshLambertMaterial({color:"#FFFFFF",side:s.DoubleSide});function Yn({createMobius:e}){const[t]=Object(r.useState)(()=>{const t=e(60);return t.iterate(),t}),[n]=Object(r.useState)(()=>{const e=t.intervals.filter(({role:e})=>"pull-length"===e.tag),n=e.filter(({},e)=>e%2===0),r=e.filter(({},e)=>e%2===1);return n.concat(r)}),a=Object(o.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},r.createElement("div",{id:"bottom-right"},r.createElement(P.a,null,r.createElement(D.a,{color:"warning",onClick:()=>v(w.Choice)},r.createElement(M.v,null)))),r.createElement(L.a,{style:{backgroundColor:"black"}},r.createElement(a,null,t?r.createElement(er,{mobius:t,muscles:n}):r.createElement("h1",null,"No Mobius"))))}function er({mobius:e,muscles:t}){const[n,a]=Object(r.useState)(new s.Vector3),[o,i]=Object(r.useState)(0),[c,l]=Object(r.useState)(2e4);return Object(L.b)(r=>{const{camera:u,clock:h}=r;if(h.elapsedTime<.01){const t=e.joints.reduce((t,n)=>Math.max(t,e.instance.jointLocation(n).length()),0),n=e.joints.reduce((t,n)=>Math.max(t,e.instance.jointLocation(n).y),0);u.position.set(1.5*t,2*n,0)}e.iterate();if(e.instance.fabric.age>c){const n=t[o];e.instance.fabric.twitch_interval(n.index,5e4,5e4,.9),i(e=>e===t.length-1?0:e+1),l(e=>e+1e4)}const d=(new s.Vector3).subVectors(e.instance.midpoint,n).multiplyScalar(.1);a((new s.Vector3).copy(n).add(d))}),r.createElement("group",null,r.createElement(ut.a,{target:n,maxDistance:200}),r.createElement("scene",null,r.createElement("mesh",{geometry:e.instance.floatView.faceGeometry,material:Zn,matrixAutoUpdate:!1}),r.createElement(ht.a,{radius:300}),r.createElement("ambientLight",{color:new s.Color("white"),intensity:.1}),r.createElement("pointLight",{color:new s.Color("#4fa903"),position:new s.Vector3(0,100,0)}),r.createElement("pointLight",{color:new s.Color("#043eb7"),position:new s.Vector3(0,-10,100)}),r.createElement("pointLight",{color:new s.Color("#f60606"),position:new s.Vector3(0,-10,-100)})))}class tr{constructor(e,t){if(this.frequency=e,this.radius=t,this.vertices=[],rr.forEach(e=>this.vertexAt(e)),1===e)ar.forEach(e=>{cr(this.vertices[e[0]],this.vertices[e[1]])});else if(2===e){const e=ar.map(e=>{const t=this.vertices[e[0]],n=this.vertices[e[1]],r=this.vertexBetween(t,n);return cr(t,r),cr(r,n),r});sr.forEach(t=>{const n=e[t[0]],r=e[t[1]],a=e[t[2]];cr(n,r),cr(r,a),cr(a,n)})}else this.buildFaces(this.buildEdgeVertices());this.vertices.forEach(lr)}buildEdgeVertices(){const e=[];return ar.forEach(t=>{const n=[];let r,a;e.push(n);for(let e=0;e<this.frequency-1;e++){a=r;const o=this.vertices[t[0]],i=this.vertices[t[1]],c=o.location,l=i.location,u=(new s.Vector3).lerpVectors(c,l,(e+1)/this.frequency);r=this.vertexAt(u),n.push(r),a?(cr(r,a),e===this.frequency-2&&cr(r,i)):cr(r,o)}}),e}buildFaces(e){const t=[];or.forEach((n,r)=>{const a=e=>this.vertices[n[e]],o=a(0).location;for(let e=1;e<this.frequency-1;e++){const n=a(1),r=(new s.Vector3).lerpVectors(o,n.location,e/this.frequency);r.sub(o),t[e-1]=[];for(let i=1;i<this.frequency-e;i++){const n=a(2),c=(new s.Vector3).lerpVectors(o,n.location,i/this.frequency);c.sub(o);const l=(new s.Vector3).copy(o);l.add(r),l.add(c),t[e-1].push(this.vertexAt(l))}}for(let e=0;e<t.length;e++)for(let n=0;n<t[e].length;n++)if(n<t[e].length-1&&cr(t[e][n],t[e][n+1]),e>0){const r=t[e][n];cr(r,t[e-1][n]),cr(r,t[e-1][n+1])}const i=[[],[],[]];for(let e=0;e<this.frequency-2;e++){const n=t.length-e-1;i[0].push(t[e][0]),i[1].push(t[n][t[n].length-1]),i[2].push(t[0][e])}for(let s=0;s<i.length;s++){const n=sr[r],a=e[n[s]];for(let e=0;e<t.length;e++){const t=i[s][e];cr(t,a[e]),cr(t,a[e+1])}}}),ir.forEach(t=>{for(let n=0;n<t.length;n++){const r=(n+1)%t.length,a=t[n].front?0:this.frequency-2,o=t[r].front?0:this.frequency-2;cr(e[t[n].edge][a],e[t[r].edge][o])}})}vertexBetween(e,t){const n=(new s.Vector3).copy(e.location).lerp(t.location,.5);return this.vertexAt(n)}vertexAt(e){const t=e.length();e.multiplyScalar(this.radius/t);const n={index:this.vertices.length,location:e,adjacent:[]};return this.vertices.push(n),n}}const nr=.5257311121191336,rr=[new s.Vector3(+nr,0,.85065080835204),new s.Vector3(+nr,0,-.85065080835204),new s.Vector3(.85065080835204,+nr,0),new s.Vector3(-.85065080835204,+nr,0),new s.Vector3(0,.85065080835204,+nr),new s.Vector3(0,-.85065080835204,+nr),new s.Vector3(-nr,0,-.85065080835204),new s.Vector3(-nr,0,.85065080835204),new s.Vector3(-.85065080835204,-nr,0),new s.Vector3(.85065080835204,-nr,0),new s.Vector3(0,-.85065080835204,-nr),new s.Vector3(0,.85065080835204,-nr)],ar=[[0,2],[0,4],[0,5],[0,7],[0,9],[1,10],[1,11],[1,2],[1,6],[1,9],[2,11],[2,4],[2,9],[3,11],[3,4],[3,6],[3,7],[3,8],[4,11],[4,7],[5,10],[5,7],[5,8],[5,9],[6,10],[6,11],[6,8],[7,8],[8,10],[9,10]],or=[[0,2,4],[0,2,9],[0,4,7],[0,5,7],[0,5,9],[1,2,11],[1,2,9],[1,6,10],[1,6,11],[1,9,10],[2,4,11],[3,4,11],[3,4,7],[3,6,11],[3,6,8],[3,7,8],[5,7,8],[5,8,10],[5,9,10],[6,8,10]],sr=[[0,11,1],[0,12,4],[1,19,3],[2,21,3],[2,23,4],[7,10,6],[7,12,9],[8,24,5],[8,25,6],[9,29,5],[11,18,10],[14,18,13],[14,19,16],[15,25,13],[15,26,17],[16,27,17],[21,27,22],[22,28,20],[23,29,20],[26,28,24]],ir=[[{edge:0,front:!0},{edge:1,front:!0},{edge:3,front:!0},{edge:2,front:!0},{edge:4,front:!0}],[{edge:7,front:!0},{edge:6,front:!0},{edge:8,front:!0},{edge:5,front:!0},{edge:9,front:!0}],[{edge:10,front:!0},{edge:11,front:!0},{edge:0,front:!1},{edge:12,front:!0},{edge:7,front:!1}],[{edge:14,front:!0},{edge:13,front:!0},{edge:15,front:!0},{edge:17,front:!0},{edge:16,front:!0}],[{edge:18,front:!0},{edge:11,front:!1},{edge:1,front:!1},{edge:19,front:!0},{edge:14,front:!1}],[{edge:21,front:!0},{edge:22,front:!0},{edge:20,front:!0},{edge:23,front:!0},{edge:2,front:!1}],[{edge:26,front:!0},{edge:24,front:!0},{edge:8,front:!1},{edge:25,front:!0},{edge:15,front:!1}],[{edge:27,front:!0},{edge:16,front:!1},{edge:19,front:!1},{edge:3,front:!1},{edge:21,front:!1}],[{edge:28,front:!0},{edge:22,front:!1},{edge:27,front:!1},{edge:17,front:!1},{edge:26,front:!1}],[{edge:4,front:!1},{edge:23,front:!1},{edge:29,front:!0},{edge:9,front:!1},{edge:12,front:!1}],[{edge:28,front:!1},{edge:20,front:!1},{edge:29,front:!1},{edge:5,front:!1},{edge:24,front:!1}],[{edge:6,front:!1},{edge:10,front:!1},{edge:18,front:!1},{edge:13,front:!1},{edge:25,front:!1}]];function cr(e,t){e.adjacent.push(t),t.adjacent.push(e)}function lr(e){const t=(new s.Vector3).copy(e.location).normalize(),n=e.adjacent.pop();if(!n)throw new Error("No first to pop!");const r=[n],a=({location:t})=>(new s.Vector3).subVectors(t,e.location).normalize();for(;e.adjacent.length>0;){const n=r[r.length-1],o=e.adjacent.find(e=>{const r=a(e),o=a(n);return!(r.dot(o)<.25)&&(new s.Vector3).crossVectors(o,r).dot(t)>0});if(!o)throw new Error("No next found");r.push(o),e.adjacent=e.adjacent.filter(e=>e.index!==o.index)}e.adjacent=r}const ur={tag:"push",push:!0,length:1,stiffness:1},hr={tag:"pull",push:!1,length:1,stiffness:1};class dr{constructor(e,t,n,r){this.location=e,this.frequency=t,this.radius=n,this.useCurves=r,this.scaffold=void 0,this.hubs=void 0,this.tensegrity=void 0,this.scaffold=new tr(t,n),this.hubs=this.scaffold.vertices.map(e=>({vertex:e,spokes:[]}))}operateOn(e){this.tensegrity=e}finished(){return this.tensegrity.joints.length>0}work(){const e={};this.hubs.forEach(({vertex:t,spokes:n})=>t.adjacent.forEach(r=>{const a=e["".concat(r.index,"-").concat(t.index)],o=[this.hubs[t.index],this.hubs[r.index]];if(a){const{push:e}=a,t=this.useCurves?[e[1].omega,e[0].omega,e[1].alpha,e[0].alpha]:[e[0].omega,e[0].alpha];n.push({push:e,hubs:o,joints:t})}else{const a=this.useCurves?this.createCurve(t,r):this.createPush(t,r),s={push:a,hubs:o,joints:this.useCurves?[a[0].alpha,a[1].alpha,a[0].omega,a[1].omega]:[a[0].alpha,a[0].omega]};e["".concat(t.index,"-").concat(r.index)]=s,n.push(s)}})),this.instance.refreshFloatView();const t=this.averageIntervalLength/3,n={};this.hubs.forEach(e=>e.spokes.forEach(r=>this.pullsForSpoke(e,r,t,n))),this.tensegrity.toDo={age:2e4,todo:e=>{e.stage=i.Stage.Slack,e.fabric.set_altitude(this.location.y),e.stage=i.Stage.Pretensing}}}createPush(e,t){const n=(new s.Vector3).addVectors(e.location,t.location).normalize(),r=(new s.Quaternion).setFromAxisAngle(n,.52),a=(new s.Vector3).copy(e.location).applyQuaternion(r),o=(new s.Vector3).copy(t.location).applyQuaternion(r),i=ee(e.location.distanceTo(t.location)),c=this.tensegrity.createJoint(a),l=this.tensegrity.createJoint(o);return this.instance.refreshFloatView(),[this.tensegrity.createInterval(c,l,ur,i)]}createCurve(e,t){const n=(new s.Vector3).addVectors(e.location,t.location).normalize(),r=(new s.Quaternion).setFromAxisAngle(n,.52),a=(new s.Vector3).copy(e.location).applyQuaternion(r),o=(new s.Vector3).copy(t.location).applyQuaternion(r),i=this.tensegrity.createJoint(a),c=this.tensegrity.createJoint((new s.Vector3).lerpVectors(a,o,1/3)),l=this.tensegrity.createJoint((new s.Vector3).lerpVectors(a,o,2/3)),u=this.tensegrity.createJoint(o);this.instance.refreshFloatView();const h=ee(2*e.location.distanceTo(t.location)/3),d=this.tensegrity.createInterval(i,l,ur,h),m=this.tensegrity.createInterval(c,u,ur,h),f=ee(e.location.distanceTo(t.location)/6);return this.tensegrity.createInterval(i,c,hr,f),this.tensegrity.createInterval(c,l,hr,f),this.tensegrity.createInterval(l,u,hr,f),[d,m]}pullsForSpoke(e,t,n,r){const a=(e,t,n)=>{const a=t.index>e.index?"".concat(e.index,"-").concat(t.index):"".concat(t.index,"-").concat(e.index);r[a]||(r[a]=this.tensegrity.createInterval(e,t,hr,ee(n)))};if(this.useCurves)a(t.joints[0],mr(e,t).joints[1],n/5);else{const r=mr(e,t);a(t.joints[0],r.joints[0],n);const o=mr(t.hubs[1],t).joints[0],s=this.instance.intervalLength(t.push[0]);a(r.joints[0],o,s-2*n)}}get averageIntervalLength(){const e=e=>this.instance.intervalLength(e);return this.intervals.reduce((t,n)=>t+e(n),0)/this.intervals.length}get instance(){return this.tensegrity.instance}get intervals(){return this.tensegrity.intervals}}function mr(e,t){const n=e.spokes.findIndex(({push:e})=>e[0].index===t.push[0].index);if(n<0)throw new Error("Cannot find current spoke when looking for next");return e.spokes[(n+1)%e.spokes.length]}function fr(e){const t=new s.Color(e);return new s.MeshLambertMaterial({color:t})}const gr=fr("#011884"),pr=fr("#a80000"),wr=[1,2,3,4,5],br=Object(o.atom)({key:"show push",default:!0}),yr=Object(o.atom)({key:"show pull",default:!0}),Er=Object(o.atom)({key:"frozen",default:!1}),vr=Object(o.atom)({key:"gravity",default:2}),Sr=Object(o.atom)({key:"useCurves",default:!1});function jr({frequencyParam:e,createSphere:t}){const n=Object(r.useMemo)(()=>{const t=void 0===e?1:parseInt(e,10),n=wr.findIndex(e=>e===t);return n>=0?n:0},[]),[a,s]=Object(o.useRecoilState)(Er),[i,c]=Object(o.useRecoilState)(br),[l,u]=Object(o.useRecoilState)(yr),[h,d]=Object(o.useRecoilState)(vr),[m]=Object(o.useRecoilState)(Sr),[f,g]=Object(r.useState)(()=>t(wr[n],h,m));Object(r.useEffect)(()=>{s(!1),g(t(wr[n],h,m))},[h,n,m]),Object(r.useEffect)(()=>{i||l||(c(!0),u(!0))},[i,l]);const p=Object(o.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},r.createElement("div",{id:"bottom-right"},r.createElement(P.a,null,r.createElement(D.a,{onClick:()=>ct(it(f,!1))},r.createElement(M.j,null)),r.createElement(D.a,{color:"warning",onClick:()=>v(w.Choice)},r.createElement(M.v,null)))),r.createElement("div",{id:"top-left"},r.createElement(P.a,null,wr.map((e,t)=>r.createElement(D.a,{key:"Freq".concat(e),onClick:()=>v(w.Sphere,e.toFixed(0)),color:t===n?"success":"secondary"},e)))),r.createElement("div",{id:"top-right"},r.createElement(P.a,null,r.createElement(D.a,{color:2===h?"success":"secondary",onClick:()=>d(2)},"Heavy Gravity"),r.createElement(D.a,{color:1===h?"success":"secondary",onClick:()=>d(1)},"Light Gravity"),r.createElement(D.a,{color:0===h?"success":"secondary",onClick:()=>d(0)},"Space"))),r.createElement("div",{id:"bottom-left"},r.createElement(P.a,null,r.createElement(D.a,{color:a?"success":"secondary",onClick:()=>s(!a)},r.createElement(M.x,null)),r.createElement(D.a,{color:i?"success":"secondary",disabled:!a,onClick:()=>c(!i)},"C"),r.createElement(D.a,{color:l?"success":"secondary",disabled:!a,onClick:()=>u(!l)},"T"))),r.createElement(L.a,{style:{backgroundColor:"black"}},r.createElement(p,null,f?r.createElement(xr,{sphere:f}):r.createElement("h1",null,"No Sphere"))))}function xr({sphere:e}){const[t,n]=Object(r.useState)(new s.Vector3),[a]=Object(o.useRecoilState)(Er);return Object(L.b)(r=>{const{camera:o,clock:i}=r;if(i.elapsedTime<.01&&o.position.set(0,15,54),!a){e.iterate();const r=(new s.Vector3).subVectors(e.instance.midpoint,t).multiplyScalar(.1);n((new s.Vector3).copy(t).add(r))}}),r.createElement("group",null,r.createElement(ut.a,{target:t,maxDistance:200}),r.createElement("scene",null,a?r.createElement(Cr,{sphere:e}):r.createElement("lineSegments",{key:"lines",geometry:e.instance.floatView.lineGeometry,material:mt,onUpdate:e=>e.geometry.computeBoundingSphere()}),r.createElement(Ct,null),r.createElement(ht.a,{radius:300}),r.createElement("ambientLight",{color:new s.Color("white"),intensity:.8}),r.createElement("directionalLight",{color:new s.Color("#FFFFFF"),intensity:2})))}const kr=new s.CylinderGeometry(1,1,1,12,1,!1);function Cr({sphere:e}){const[t]=Object(o.useRecoilState)(br),[n]=Object(o.useRecoilState)(yr),a=e.instance;return r.createElement("group",null,n?e.intervals.filter(({role:e})=>!e.push).map(e=>{const t=q(a.unitVector(e.index)),n=a.jointDistance(e.alpha,e.omega),o=new s.Vector3(.03,n,.03);return r.createElement("mesh",{key:"T".concat(e.index),geometry:kr,position:a.intervalLocation(e),rotation:(new s.Euler).setFromQuaternion(t),scale:o,material:pr,matrixWorldNeedsUpdate:!0})}):void 0,t?e.intervals.filter(({role:e})=>e.push).map(e=>{const t=q(a.unitVector(e.index)),n=a.jointDistance(e.alpha,e.omega),o=new s.Vector3(.06,n,.06);return r.createElement("mesh",{key:"C".concat(e.index),geometry:kr,position:a.intervalLocation(e),rotation:(new s.Euler).setFromQuaternion(t),scale:o,material:gr,matrixWorldNeedsUpdate:!0})}):void 0)}var Fr=n(110),Or=n(111),Vr=n(112),Ar=n(104),Rr=n(94);const Tr=[0,1e5];function Pr({mapping:e,percentAtom:t,apply:n}){const{name:a,nuanceToPercent:s,percentToNuance:i,percentToValue:c}=e,l=e=>[Math.floor(1e5*i(e))],[u,h]=Object(o.useRecoilState)(t),[d,m]=Object(r.useState)(l(u));return Object(r.useEffect)(()=>{h(Math.round(s(d[0]/1e5)))},[d]),Object(r.useEffect)(()=>n(e.feature,u,c(u)),[u]),Object(r.useEffect)(()=>{m(l(u))},[e,u]),r.createElement("div",{className:"slider"},r.createElement("div",{className:"float-right mr-4"},r.createElement(M.c,{onClick:()=>m(l(100))})),r.createElement("div",{className:"ml-2 small my-1"},a," = ",function(e){return e<=100?"".concat(e.toFixed(0),"%"):"".concat((e/100).toFixed(1),"x")}(u)," (",function(e){const t=e.toExponential(3),n=t.indexOf("e+0");return n>0?t.substring(0,n):Math.max(t.indexOf("e-1"),t.indexOf("e-2"))>0?e.toFixed(3):Math.max(t.indexOf("e+1"),t.indexOf("e+2"),t.indexOf("e+3"))>0?e.toFixed(1):t}(c(u)),")"),r.createElement(Rr.c,{mode:1,step:1,domain:Tr,rootStyle:Mr,values:d,onChange:e=>m(e)},r.createElement(Rr.b,null,({getRailProps:e})=>r.createElement("div",Object.assign({className:"slider-rail"},e()))),r.createElement(Rr.a,null,({handles:e,getHandleProps:t})=>r.createElement("div",{className:"slider-handles"},e.map((e,n)=>r.createElement(Dr,{key:e.id,handle:e,getHandleProps:t})))),r.createElement(Rr.d,{right:!1},({tracks:e,getTrackProps:t})=>r.createElement("div",{className:"slider-tracks"},e.map(({id:e,source:n,target:a},o)=>r.createElement(Lr,{key:e,source:n,target:a,getTrackProps:t}))))))}function Dr({handle:e,getHandleProps:t}){const n=Tr[0],a=Tr[1],{id:o,value:s,percent:i}=e;return r.createElement("div",Object.assign({role:"slider",className:"slider-handle",style:{left:"".concat(i,"%")},"aria-valuemin":n,"aria-valuemax":a,"aria-valuenow":s},t(o)))}function Lr({source:e,target:t,getTrackProps:n}){return r.createElement("div",Object.assign({className:"slider-track",style:{left:"".concat(e.percent,"%"),width:"".concat(t.percent-e.percent,"%")}},n()))}const Mr={margin:"1%",position:"relative",width:"98%"};function _r({tensegrity:e}){const[t,n]=Object(r.useState)(!1),[a,s]=Object(o.useRecoilState)(qe),[i,c]=Object(r.useState)(Ze[a]);return r.createElement("div",{className:"w-100 d-flex"},r.createElement(Fr.a,{isOpen:t,toggle:()=>n(!t)},r.createElement(Or.a,null,"Choose"),r.createElement(Vr.a,null,Ze.filter(e=>!e.mapping.name.startsWith("-")).map(e=>r.createElement(Ar.a,{key:"fitem-".concat(e.mapping.feature),onClick:()=>{s(e.mapping.feature),c(e)}},e.mapping.name)))),r.createElement(Pr,{mapping:i.mapping,percentAtom:i.percentAtom,apply:(t,n,r)=>{e.instance.applyFeature({feature:t,percent:n,value:r},!1)}}))}const Nr=new s.Color("#ffffff");function Br({tensegrity:e,clickDetails:t}){const[n]=Object(o.useRecoilState)(Xe),[a]=Object(o.useRecoilState)($e),[c]=Object(o.useRecoilState)(Ye),[l,u]=Object(r.useState)(new s.Vector3(0,1,0)),[h,d]=Object(r.useState)(e.stage$.getValue());return Object(r.useEffect)(()=>{const t=e.stage$.subscribe(d);return()=>t.unsubscribe()},[e]),Object(L.b)(t=>{n===Ke.Time&&e.iterate();const r=c?e.instance.twistLocation(c):e.instance.midpoint;if(u((new s.Vector3).subVectors(r,l).multiplyScalar(.01).add(l)),h===i.Stage.Growing){t.camera.position.y+=.01*(r.y-t.camera.position.y);const n=t.camera.position.distanceTo(r)-2.5*e.instance.view.radius(),a=(new s.Vector3).subVectors(r,t.camera.position).normalize().multiplyScalar(.01*n);t.camera.position.add(a)}else t.camera.position.y<0&&(t.camera.position.y-=.01*t.camera.position.y*20)}),r.createElement("group",null,r.createElement(ut.a,{target:l,autoRotate:a,enablePan:!1,maxDistance:200,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.8*Math.PI,zoomSpeed:.5}),r.createElement("scene",null,n===Ke.Time?r.createElement(wt,{tensegrity:e}):n===Ke.Select?r.createElement(St,{tensegrity:e,clickDetails:t}):r.createElement(bt,{tensegrity:e}),r.createElement(Ct,null),r.createElement(ht.a,{radius:300}),r.createElement("ambientLight",{color:Nr,intensity:.8}),r.createElement("directionalLight",{color:new s.Color("#FFFFFF"),intensity:2})))}function Ir({runTenscript:e}){const[t,n]=Object(o.useRecoilState)(He),[a]=Object(o.useRecoilState)(Je),[s,i]=Object(r.useState)(""),[c,l]=Object(r.useState)(""),u=()=>JSON.stringify(t,void 0,2);return Object(r.useEffect)(()=>{i(t?u():"")},[t]),r.createElement("div",{id:"tenscript-panel",style:{flexDirection:"column",position:"relative",backgroundColor:"rgba(0,0,0,1)",height:"100%"}},r.createElement("div",null,r.createElement("h6",{className:"w-100 text-center"},r.createElement(M.u,null)," Tenscript"),r.createElement("div",{id:"code-and-run",style:{flexDirection:"column",height:"available"}},r.createElement(zn.a,{style:{borderRadius:"1em",height:"22em",marginBottom:"0.5em"},type:"textarea",id:"tenscript",value:s,onChange:e=>i(e.target.value)}),r.createElement(P.a,{vertical:!0,className:"w-100 my-2"},0===c.length?void 0:r.createElement(D.a,{className:"my-2",color:"warning",onClick:()=>{i(u()),l("")}},r.createElement(M.d,null),r.createElement("hr",null),c),r.createElement(D.a,{color:"success",onClick:()=>function(){try{const t=JSON.parse(s);Re(t,l)&&(l(""),t.postGrowthOp=a,n(t),e(t,l))}catch(t){l(t.toString())}}()},"Try it out!")))))}let zr;!function(e){e[e.CaptureLengthsToSlack=0]="CaptureLengthsToSlack",e[e.SlackToPretensing=1]="SlackToPretensing",e[e.CapturePretenstToSlack=2]="CapturePretenstToSlack",e[e.CaptureStrainForStiffness=3]="CaptureStrainForStiffness"}(zr||(zr={}));const Gr=Object.keys(zr).filter(e=>isNaN(parseInt(e,10))).map(e=>zr[e]);function Wr({tensegrity:e,stageTransition:t,disabled:n}){const[a,o]=Object(r.useState)(e.stage);function s(e){return!(!n&&a!==i.Stage.Pretensing)||a!==e}function c(t){e.toDo={todo:t}}switch(Object(r.useEffect)(()=>{const t=e.stage$.subscribe(o);return()=>t.unsubscribe()},[e]),t){case zr.CaptureLengthsToSlack:return r.createElement(D.a,{disabled:s(i.Stage.Shaping),onClick:()=>c(e=>e.stage=i.Stage.Slack)},r.createElement(M.e,null),r.createElement(M.a,null),r.createElement(Jr,{stage:i.Stage.Slack}));case zr.SlackToPretensing:return r.createElement(D.a,{disabled:s(i.Stage.Slack),onClick:()=>c(e=>e.stage=i.Stage.Pretensing)},r.createElement(Jr,{stage:i.Stage.Slack}),r.createElement(M.a,null),r.createElement(Jr,{stage:i.Stage.Pretenst}));case zr.CapturePretenstToSlack:return r.createElement(D.a,{disabled:s(i.Stage.Pretenst),onClick:()=>c(e=>e.stage=i.Stage.Slack)},r.createElement(Jr,{stage:i.Stage.Pretenst}),r.createElement(M.a,null),r.createElement(Jr,{stage:i.Stage.Slack}));case zr.CaptureStrainForStiffness:return r.createElement(D.a,{disabled:s(i.Stage.Pretenst),onClick:()=>c(e=>{e.stage=i.Stage.Slack,e.strainToStiffness()})},r.createElement(Jr,{stage:i.Stage.Pretenst}),r.createElement(M.a,null),r.createElement(Jr,{stage:i.Stage.Slack}),r.createElement(M.f,null))}}function Jr({stage:e}){switch(e){case i.Stage.Growing:return r.createElement(M.u,null);case i.Stage.Shaping:return r.createElement(M.w,null);case i.Stage.Slack:return r.createElement(M.z,null);case i.Stage.Pretensing:return r.createElement(M.g,null);case i.Stage.Pretenst:return r.createElement(M.o,null);default:throw new Error("Stage?")}}function Ur({tensegrity:e,runTenscript:t}){const[n]=Object(o.useRecoilState)(Xe),a=Object(o.useSetRecoilState)(Ue),[s,i]=Object(o.useRecoilState)(He),[c,l]=Object(o.useRecoilState)(Je),[u,h]=Object(r.useState)(!1),[d,m]=Object(r.useState)(!1),f=e=>{if(s)if(l(e),s.postGrowthOp===e)t(s,e=>console.error(e));else{const n={...s,postGrowthOp:e};i(n),t(n,e=>console.error(e))}},g=e=>c===e?"success":"secondary";return r.createElement(r.Fragment,null,r.createElement(P.a,null,Gr.map(t=>r.createElement(Wr,{key:"strans-".concat(t),tensegrity:e,stageTransition:t,disabled:n===Ke.Look}))),r.createElement("br",null),r.createElement(P.a,{className:"my-1"},r.createElement(D.a,{onClick:()=>f(we.NoOp),color:g(we.NoOp)},"0"),r.createElement(D.a,{onClick:()=>f(we.Faces),color:g(we.Faces)},"\u25b5"),r.createElement(D.a,{onClick:()=>f(we.Snelson),color:g(we.Snelson)},"S\u25b5"),r.createElement(D.a,{onClick:()=>f(we.Bowtie),color:g(we.Bowtie)},"\u22c8"),r.createElement(D.a,{onClick:()=>f(we.BowtieFaces),color:g(we.BowtieFaces)},"\u22c8 ",r.createElement("strong",null,"\u25b5"))),r.createElement("br",null),r.createElement(P.a,null,r.createElement(Fr.a,{isOpen:d,toggle:()=>m(!d)},r.createElement(Or.a,null,r.createElement(M.p,null)),r.createElement(Vr.a,null,Tn.map((e,n)=>r.createElement(Ar.a,{key:"Boot".concat(n),onClick:()=>{a(n),t(e,()=>console.error("impossible"))}},e.name)))),r.createElement(D.a,{color:u?"warning":"secondary",onClick:()=>h(!u)},r.createElement(M.k,null))),u?r.createElement(Ir,{runTenscript:t}):void 0)}function Hr({tensegrity:e}){const[t,n]=Object(r.useState)(e.stage$.getValue());return Object(r.useEffect)(()=>{const t=e.stage$.subscribe(n);return()=>t.unsubscribe()},[e]),r.createElement("div",null,r.createElement("span",null,p(t)," ",r.createElement("i",null,'"',e.name,'"')))}function qr({createInstance:e}){const t=Object(r.useMemo)(()=>e({}),[]),n=Ze.map(({percentAtom:e})=>Object(o.useRecoilState)(e)),[a,c]=Object(o.useRecoilState)(He),[l]=Object(o.useRecoilState)(Ue),h=Object(o.useSetRecoilState)(Je),[d,m]=Object(o.useRecoilState)(Xe),[f,p]=Object(r.useState)(),[w,b]=Object(o.useRecoilState)(Ye),[y,E]=Object(o.useRecoilState)(et);Object(r.useEffect)(()=>{f&&E(w?w.pushes.map(e=>f.getIntervalDetails(e)):[])},[w]);const v=e=>console.error("tensegrity view",e),S=(e,r)=>{try{const a=Re(e,r);if(!a)return!1;m(Ke.Time),b(void 0);const o=e.featureValues,l=o?o[i.WorldFeature.IntervalCountdown]:void 0,d=void 0===l?Object(i.default_world_feature)(i.WorldFeature.IntervalCountdown):l;c(e),g.map(e=>{const r=i.WorldFeature[e],{percentToValue:a}=u(r),s=o?o[e]:void 0;void 0!==s&&(n[r][1](s),t.applyFeature({feature:r,percent:s,value:a(s)},!0))}),h(e.postGrowthOp);const f=new Te(new s.Vector3,e,a);p(new Ce(t,d,f))}catch(a){return console.log("Problem running",a),S(Tn[l],v)}return!0};Object(r.useEffect)(()=>{Object.keys(localStorage).filter(e=>"pretenst-2022-04-06"!==e).forEach(e=>localStorage.removeItem(e)),S(a||Tn[l],v)},[]);const j=Object(o.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return r.createElement("div",null,r.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},f?r.createElement("div",{className:"h-100"},r.createElement(L.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:d!==Ke.Time?"#f0ad4e":"black",cursor:d===Ke.Select?"pointer":"default",borderWidth:"2px"}},r.createElement(j,null,r.createElement(Br,{tensegrity:f,clickDetails:({interval:e})=>{w&&f&&(1===y.length||e.role.push?E(ae(f,w).map(e=>f.getIntervalDetails(e))):E(y.filter(t=>t.interval.index===e.index)))}}))),r.createElement("div",{id:"top-left"},r.createElement(Ur,{tensegrity:f,runTenscript:S})),r.createElement("div",{id:"bottom-left"},r.createElement(tt,null)),r.createElement("div",{id:"bottom-middle",style:{width:"60%"}},r.createElement(_r,{tensegrity:f})),r.createElement("div",{id:"top-middle"},r.createElement(Hr,{tensegrity:f})),r.createElement("div",{id:"bottom-right"},r.createElement(lt,{tensegrity:f}))):r.createElement("div",{className:"h-100"},r.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},r.createElement("h1",null,r.createElement(M.s,null))))))}function $r({createInstance:e}){const[t]=Object(o.useRecoilState)(Qe);switch(Object(r.useEffect)(()=>{const{mode:e,param:n}=E();e!==t.mode&&v(e,n)},[]),t.mode){case w.Design:return r.createElement(qr,{createInstance:e});case w.Construction:const n=Pn.find(({name:e})=>y(e)===t.param);return n?r.createElement(Ot,{tenscript:n,createInstance:e}):(v(w.Choice),r.createElement("div",null));case w.Evolution:return r.createElement(Vn,{createBodyInstance:e});case w.Sphere:return r.createElement(jr,{frequencyParam:t.param,createSphere:(t,n,r)=>{const a=e({[i.WorldFeature.IterationsPerFrame]:200,[i.WorldFeature.Gravity]:(()=>{switch(n){case 0:return 0;case 1:return 25;default:return 1500}})(),[i.WorldFeature.ShapingStiffnessFactor]:600,[i.WorldFeature.ShapingDrag]:300,[i.WorldFeature.Drag]:0,[i.WorldFeature.VisualStrain]:0,[i.WorldFeature.StiffnessFactor]:800}),o=new dr(new s.Vector3(0,60,0),t,15,r);return new Ce(a,100,o)}});case w.Mobius:return r.createElement(Yn,{createMobius:t=>{const n=e({[i.WorldFeature.IterationsPerFrame]:1e3,[i.WorldFeature.Gravity]:0,[i.WorldFeature.ShapingDrag]:10,[i.WorldFeature.ShapingStiffnessFactor]:1e3,[i.WorldFeature.VisualStrain]:0}),r=new Xn(t);return new Ce(n,100,r)}});case w.Klein:return r.createElement(Wn,{createKlein:(t,n,r)=>{const a=e({[i.WorldFeature.IterationsPerFrame]:100,[i.WorldFeature.Gravity]:0,[i.WorldFeature.ShapingDrag]:10,[i.WorldFeature.ShapingStiffnessFactor]:5e3,[i.WorldFeature.VisualStrain]:0});a.world.set_push_and_pull(!0);const o=new Mn(t,n,r);return new Ce(a,10,o)}});default:return r.createElement(A.a,{id:"choice-menu"},r.createElement(R.a,null,r.createElement(T.a,null,r.createElement("h3",{className:"mb-2"},"Pretenst App"))),r.createElement(R.a,null,r.createElement(T.a,null,r.createElement("h6",null,"Projects"),r.createElement(P.a,{className:"choice-menu-group",vertical:!0},Tn.map(({scale:e,name:t})=>{if(void 0!==e)return r.createElement(D.a,{color:"info",key:t,onClick:()=>v(w.Construction,y(t))},'"',t,'"')}))),r.createElement(T.a,null,r.createElement("h6",null,"Modes"),r.createElement(P.a,{className:"choice-menu-group",vertical:!0},r.createElement(D.a,{color:"info",onClick:()=>v(w.Klein)},"Klein Shape"),r.createElement(D.a,{color:"info",onClick:()=>v(w.Mobius)},"M\xf6bius Band"),r.createElement(D.a,{color:"info",onClick:()=>v(w.Sphere)},"Tensegrity Spheres"),r.createElement(D.a,{color:"info",onClick:()=>v(w.Design)},"Design Mode"),r.createElement(D.a,{color:"info",onClick:()=>v(w.Evolution)},"Evolution Experiment")))))}}async function Qr(e,t){!function(e){const t=document.getElementById("root");a.render(e,t)}(r.createElement(o.RecoilRoot,null,r.createElement($r,{createInstance:(n,r)=>new C(e,n,2e3,t,r)}))),O()}n.d(t,"startReact",(function(){return Qr}))}}]);
//# sourceMappingURL=4.f1795133.chunk.js.map