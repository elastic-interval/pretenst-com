(window.webpackJsonppretenst=window.webpackJsonppretenst||[]).push([[5],{8:function(e,t,n){"use strict";n.r(t);var r,a=n(0),i=n.n(a),c=n(1),o=n(10),s=n(43),u=n(56),l=n(14),h=n(206),f=n(29),d=n(7),m=new l.Vector3(1,0,0),g=new l.Vector3(0,0,1),p=new l.Vector3(0,1,0);!function(e){e[e.Push=0]="Push",e[e.Pull=1]="Pull",e[e.PhiPush=2]="PhiPush",e[e.RootPush=3]="RootPush",e[e.TipPush=4]="TipPush",e[e.PhiTriangle=5]="PhiTriangle",e[e.Twist=6]="Twist",e[e.InterTwist=7]="InterTwist",e[e.Ring=8]="Ring",e[e.Cross=9]="Cross",e[e.TipInner=10]="TipInner",e[e.TipOuter=11]="TipOuter",e[e.InterTip=12]="InterTip",e[e.RadialPull=13]="RadialPull",e[e.ConnectorPull=14]="ConnectorPull",e[e.Distancer=15]="Distancer"}(r||(r={}));var v=1.618033988749895;function b(e){var t=Math.sqrt(2-2*Math.sqrt(2/3));switch(e){case r.Push:case r.Pull:return 1;case r.PhiPush:return v;case r.RootPush:case r.TipPush:return 1.414213562373095;case r.PhiTriangle:case r.Twist:case r.TipOuter:case r.InterTwist:case r.InterTip:return 1;case r.TipInner:case r.Ring:return t;case r.Cross:return Math.sqrt(1.2301705239829062);case r.Distancer:return 1;default:throw new Error("Role ".concat(r[e],"?"))}}var y=Object.keys(d.WorldFeature).filter((function(e){return isNaN(parseInt(e,10))})).map((function(e){return d.WorldFeature[e]}));function w(e,t){switch(e){case r.Push:return t?"Push":"+";case r.Pull:return t?"Pull":"-";case r.PhiPush:return t?"Phi-Push":"PP";case r.RootPush:return t?"Root-Push":"RP";case r.TipPush:return t?"Tip-Push":"TP";case r.PhiTriangle:return t?"Phi Triangle":"PT";case r.Ring:return t?"Ring":"RI";case r.Twist:return t?"Twist":"TW";case r.TipInner:return t?"Tip-Inner":"TI";case r.TipOuter:return t?"Tip-Outer":"TO";case r.InterTwist:return t?"Inter-Twist":"IT";case r.Cross:return t?"Cross":"CR";case r.InterTip:return t?"Inter-Tip":"TT";case r.Distancer:return t?"Distancer":"DI";default:return"?"}}var E,S,k,x=Object.keys(r).filter((function(e){switch(r[e]){case r.PhiPush:case r.RootPush:case r.TipPush:case r.PhiTriangle:case r.Twist:case r.TipOuter:case r.TipInner:case r.InterTip:case r.InterTwist:case r.Ring:case r.Cross:case r.Distancer:return!0;default:return!1}})).map((function(e){return r[e]}));function j(e){switch(e){case r.Push:case r.PhiPush:case r.RootPush:case r.TipPush:return!0}return!1}function O(e){switch(e){case d.Stage.Growing:return"Growing";case d.Stage.Shaping:return"Shaping";case d.Stage.Slack:return"Slack";case d.Stage.Pretensing:return"Pretensing";default:return"Pretenst"}}function P(){var e=location.hash;return"#bridge"===e?E.Bridge:"#gotchi"===e?E.Gotchi:e.startsWith("#sphere")?E.Sphere:E.Design}function F(e){location.hash=e,location.reload()}function C(e){var t=e.toExponential(5),n=t.indexOf("e+0");return n>0?t.substring(0,n):Math.max(t.indexOf("e-1"),t.indexOf("e-2"))>0?e.toFixed(5):Math.max(t.indexOf("e+1"),t.indexOf("e+2"))>0?e.toFixed(1):t}function T(e,t){return(new l.Vector3).subVectors(e,t).normalize()}function V(e,t){return(new l.Vector3).addVectors(e,t).normalize()}function R(e){var t=new l.Vector3;return e.forEach((function(e){return t.add(e)})),t.multiplyScalar(1/e.length)}function M(e){for(var t=R(e),n=e.map((function(e){return(new l.Vector3).copy(e).sub(t)})),r=new l.Vector3,a=0;a<n.length;a++){var i=n[a],c=n[(a+1)%n.length];r.add((new l.Vector3).crossVectors(i,c).normalize())}return r.normalize()}function A(e,t,n){var r=3*t;return n?(n.set(e[r],e[r+1],e[r+2]),n):new l.Vector3(e[r],e[r+1],e[r+2])}function L(e){switch(e){case S.Left:return S.Right;case S.Right:return S.Left;case S.LeftRight:return S.RightLeft;case S.RightLeft:return S.LeftRight}}!function(e){e.Design="design",e.Gotchi="gotchi",e.Bridge="bridge",e.Sphere="sphere"}(E||(E={})),function(e){e[e.Left=0]="Left",e[e.Right=1]="Right",e[e.LeftRight=2]="LeftRight",e[e.RightLeft=3]="RightLeft"}(S||(S={})),function(e){e[e.a=0]="a",e[e.B=1]="B",e[e.C=2]="C",e[e.D=3]="D",e[e.b=4]="b",e[e.c=5]="c",e[e.d=6]="d",e[e.A=7]="A"}(k||(k={}));var I,D=[k.a,k.B,k.C,k.D,k.b,k.c,k.d,k.A];function _(e){return"aBCDbcdA".indexOf(e)>=0}function N(e){var t="aBCDbcdA".indexOf(e);if(t<0)throw new Error("[".concat(e,"] is not a face name"));return D[t]}function B(e){var t=e.push;if(!t)throw new Error("Expected push");return t}function W(e){var t=e.instance,n=e.index;return t.jointLocation(n)}function z(e,t){return W(e).distanceTo(W(t))}function G(e){var t=e.alpha,n=e.omega;return W(t).add(W(n)).multiplyScalar(.5)}function $(e){return z(e.alpha,e.omega)}function J(e,t,n){var r=e.alpha.instance.floatView,a={stiffness:r.stiffnesses[e.index]*(j(e.intervalRole)?t:1),strain:r.strains[e.index],length:$(e),idealLength:r.idealLengths[e.index]*(j(e.intervalRole)?1+n:1),linearDensity:r.linearDensities[e.index]};return e.stats=a,a}function U(e){var t=e.stats;if(!t)throw new Error;return t}function q(e,t){return function(n){var r=n.alpha,a=n.omega;return r.index===e.index&&a.index===t.index||a.index===e.index&&r.index===t.index}}function H(e){if(!e.push)throw new Error("No push");var t=e.push;if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("Big problem")}function Q(e,t){if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("No other joint")}function K(e){return R(e.ends.map(W))}function X(e){return e.reduce((function(e,t){return e.add(K(t))}),new l.Vector3).multiplyScalar(1/e.length)}function Y(e){return e||{_:100}}function Z(e){return e._/100}function ee(e){return{_:100*e}}function te(e,t){switch(e.faces.length){case 2:switch(t){case k.a:return e.faces[0];case k.A:return e.faces[1]}break;case 8:switch(t){case k.a:return e.faces[0];case k.B:return e.faces[2];case k.C:return e.faces[1];case k.D:return e.faces[3];case k.b:return e.faces[4];case k.c:return e.faces[5];case k.d:return e.faces[6];case k.A:return e.faces[7]}}throw new Error("Face ".concat(k[t]," not found in twist with ").concat(e.faces.length," faces"))}function ne(){return{faces:[],intervals:[],joints:[]}}!function(e){e.None="None",e.Face="Face",e.Pulls="Pulls",e.Pushes="Pushes",e.Both="Both"}(I||(I={}));var re;function ae(){return"'Melkvonder Ulft':("+" A(".concat(4,",MA0),")+" b(".concat(4,",MA1),")+" a(".concat(4,",MA3),")+" B(".concat(4,",MA2)")+")"+":0=anchor-(".concat(25,",").concat(9,")-").concat(5,"-").concat(110)+":1=anchor-(".concat(25,",-").concat(9,")-").concat(5,"-").concat(110)+":2=anchor-(-".concat(25,",").concat(9,")-").concat(5,"-").concat(110)+":3=anchor-(-".concat(25,",-").concat(9,")-").concat(5,"-").concat(110)}function ie(e,t){switch(e){case d.WorldFeature.IntervalCountdown:return t;case d.WorldFeature.Gravity:return.03*t;case d.WorldFeature.Drag:return 2*t;case d.WorldFeature.PretensingCountdown:return 3*t;case d.WorldFeature.VisualStrain:return t;case d.WorldFeature.PretenstFactor:return 5*t;case d.WorldFeature.PushOverPull:return 4;default:return t}}function ce(e){for(var t=b(r.Cross),n=b(r.Cross),a=function(t,r){var a=n*(r?-.5:.5),i=new l.Vector3(t,7,a),c={index:e.createJoint(i).index,instance:e.instance};return e.joints.push(c),c},i=function(t,n,r){var a=Y();return e.createInterval(t,n,r,a)},c=a(0,!0),o=a(0,!1),s=[[c],[o],[c],[o]],u=1;u<7;u++){var d=u*t;s[re.FrontLeft].push(a(d,!0)),s[re.FrontRight].push(a(d,!1)),s[re.BackLeft].push(a(-d,!0)),s[re.BackRight].push(a(-d,!1))}e.instance.refreshFloatView(),i(c,o,r.Pull);for(var m=function(e){return[s[0][e],s[1][e],s[2][e],s[3][e]]},g=1;g<7;g++){var p=m(g-1),v=m(g);i(v[0],v[1],r.Pull),i(v[2],v[3],r.Pull);for(var y=0;y<4;y++)i(p[y],v[y],r.Pull)}i(s[re.FrontLeft][1],s[re.BackRight][1],r.Push),i(s[re.FrontRight][1],s[re.BackLeft][1],r.Push);for(var w=2;w<7;w++){var E=m(w-2),S=m(w);i(E[0],S[1],r.Push),i(E[1],S[0],r.Push),i(E[2],S[3],r.Push),i(E[3],S[2],r.Push)}for(var x=function(e,t){var n=[[],[],[],[]];e.faces.forEach((function(e){var t=[],r=re.FrontRight,a=t.shift();if(!a)throw new Error("no top!");var i=t.length;e.ends.forEach((function(t,c){Object(h.a)(t);var o="[".concat(r,"]:[").concat(i,":").concat(k[a],"]:J").concat(c);n[r].push({face:e,name:o,arch:r,distance:i,jointIndex:c})}))}));var r=function(e){return!(e.distance>t)},a=function(e,t){var n=W(e.face.ends[e.jointIndex]),r=W(t.face.ends[t.jointIndex]);return n.lengthSq()-r.lengthSq()};return[n[re.FrontLeft].filter(r).sort(a),n[re.FrontRight].filter(r).sort(a),n[re.BackLeft].filter(r).sort(a),n[re.BackRight].filter(r).sort(a)]}(e,6),j=function(t,n){var a=r.Pull,i=ee(z(t,n));return e.createInterval(t,n,a,i)},O=function(e){Object(f.a)(x[e]).forEach((function(t,n){if(0!==n){var r=s[e][1+Math.floor(n/3)],a=t.face.ends[t.jointIndex];j(r,a)}}))},P=0;P<4;P++)O(P);return j(s[re.FrontRight][0],e.joints[11]),j(s[re.FrontLeft][0],e.joints[10]),j(s[re.FrontRight][0],e.joints[9]),j(s[re.FrontLeft][0],e.joints[8]),x}!function(e){e[e.FrontLeft=0]="FrontLeft",e[e.FrontRight=1]="FrontRight",e[e.BackLeft=2]="BackLeft",e[e.BackRight=3]="BackRight"}(re||(re={}));var oe=n(17),se=n(593),ue=n(592),le=n(31),he=n(580),fe=n(541),de=n(531),me=n(532),ge=n.n(me);function pe(e){return e.toFixed(5).replace(/[.]/,",")}function ve(){return(new Date).toISOString().replace(/[.].*/,"").replace(/[:T_]/g,"-")}function be(e){var t=new ge.a;t.file("joints.csv",function(e){var t=[];return t.push(["index","x","y","z"]),e.joints.forEach((function(e){return t.push([(e.index+1).toFixed(0),pe(e.x),pe(e.y),pe(e.z)])})),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.file("intervals.csv",function(e){var t=[];return t.push(["joints","type","strain","stiffness","linear density","role","length"]),e.intervals.forEach((function(e){t.push(['"=""'.concat(e.joints.map((function(e){return(e+1).toFixed(0)})),'"""'),e.type,pe(e.strain),pe(e.stiffness),pe(e.linearDensity),e.role,e.length.toFixed(8)])})),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.file("submerged.csv",function(e){var t=[];return t.push(["joints"]),t.map((function(e){return e.join(";")})).join("\n")}()),t.generateAsync({type:"blob",mimeType:"application/zip"}).then((function(e){de.saveAs(e,"pretenst-".concat(ve(),".zip"))}))}function ye(e){var t=new ge.a;t.file("pretenst-".concat(ve(),".json"),JSON.stringify(e,void 0,2)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then((function(e){de.saveAs(e,"pretenst-".concat(ve(),".zip"))}))}var we=["#fd0000","#c94f00","#d58e1c","#897c00","#6c8901","#1d6c01","#0e4e00","#007f67","#01808b","#005da3","#0015c7","#0000ff"].reverse().map((function(e){return(new l.Color).setHex(parseInt("".concat(e.substring(1)),16))})),Ee=new l.LineBasicMaterial({vertexColors:!0}),Se=new l.MeshBasicMaterial({color:new l.Color("#ffdf00"),side:l.DoubleSide,transparent:!0,opacity:.25,depthTest:!1});we.map((function(e){return new l.MeshLambertMaterial({color:e})}));function ke(e){switch(e){case r.PhiPush:return"#281a4c";case r.TipPush:case r.RootPush:return"#0d1147";case r.PhiTriangle:return"#938b12";case r.Twist:case r.TipOuter:return"#6d6c6c";case r.InterTwist:return"#45400d";case r.Ring:case r.TipInner:return"#a71313";case r.Cross:return"#1b9a32";case r.InterTip:return"#4393b3";case r.Distancer:case r.ConnectorPull:case r.RadialPull:return"#f3f3e6";default:return}}function xe(e){var t=function(e){return new l.Color(ke(e))}(e);return new l.MeshLambertMaterial({color:t})}var je=new l.MeshPhongMaterial({color:new l.Color("#101010"),side:l.DoubleSide,transparent:!0,opacity:.5}),Oe=[new l.Vector3(0,0,-20),new l.Vector3(-17.32,0,-10),new l.Vector3(-17.32,0,10),new l.Vector3(0,0,20),new l.Vector3(17.32,0,10),new l.Vector3(17.32,0,-10)],Pe=new l.Color("tan"),Fe=new l.Vector3(0,1,0);function Ce(){var e=Object(o.useMemo)((function(){return function(){var e=new l.Geometry;return function(e,t){e.push.apply(e,Object(f.a)(Oe.map((function(e){return new l.Vector3(e.x,e.y,e.z)})))),e.push(new l.Vector3);for(var n=0;n<6;n++){var r=(n+1)%6,a=[Fe,(new l.Vector3).add(Fe).addScaledVector(Oe[n],.01).normalize(),(new l.Vector3).add(Fe).addScaledVector(Oe[r],.01).normalize()];t.push(new l.Face3(6,n,r,a,Pe))}}(e.vertices,e.faces),e.vertices.forEach((function(e){return e.sub(new l.Vector3(0,.01,0))})),e}()}),[]);return o.createElement("mesh",{name:"Patches",geometry:e,material:je})}function Te(e){var t=e.tensegrity,n=Object(o.useState)(t.stage$.getValue()),r=Object(oe.a)(n,2),a=r[0],i=r[1];function c(){return t.getFabricOutput(.012,.005,.015)}return Object(o.useEffect)((function(){var e=t.stage$.subscribe(i);return function(){return e.unsubscribe()}}),[t]),o.createElement("div",{id:"view-container",style:{position:"absolute",left:0,right:0,height:"100%"}},o.createElement("div",{id:"top-middle"},O(a)),o.createElement("div",{id:"bottom-right"},o.createElement(he.a,{vertical:!1},o.createElement(fe.a,{onClick:function(){return be(c())}},o.createElement(ue.n,null),o.createElement(ue.r,null)),o.createElement(fe.a,{onClick:function(){return ye(c())}},o.createElement(ue.n,null)," ",o.createElement(ue.q,null)),o.createElement(fe.a,{onClick:function(){return F(E.Design)}},o.createElement(ue.G,null)))),o.createElement(le.a,{style:{backgroundColor:"black"}},o.createElement(Ae,null),t?o.createElement(Ve,{tensegrity:t,stage:a}):o.createElement("h1",null,"No bridge")))}function Ve(e){var t=e.tensegrity,n=e.stage,r=Object(o.useState)(!0),a=Object(oe.a)(r,1)[0],i=Object(o.useState)(0),c=Object(oe.a)(i,2),s=c[0],u=c[1],h=Object(o.useState)(!1),f=Object(oe.a)(h,2),m=f[0],g=f[1],p=Object(o.useState)([]),v=Object(oe.a)(p,2),b=v[0],y=v[1];return Object(le.b)((function(){switch(d.Stage.Slack){case d.Stage.Growing:u(s+1);break;case d.Stage.Shaping:if(n===d.Stage.Growing){u(0);break}if(s<1e3){u(s+1);break}1e3===s&&(console.log("Ribbon!"),y(ce(t)),u(0));break;case d.Stage.Slack:u(0);break;case d.Stage.Pretensing:u(s+1);break;case d.Stage.Pretenst:if(n===d.Stage.Pretensing){u(0);break}200===s&&(m||(g(!0),console.log("strain to stiffness",m))),u(s+1);break;default:u(s+1)}})),o.createElement("group",null,o.createElement(se.a,{onPointerMissed:void 0,target:t.instance.midpoint}),o.createElement("scene",null,a?o.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:Ee}):o.createElement(o.Fragment,null,t.intervals.map((function(e){return o.createElement(Re,{key:"I".concat(e.index),tensegrity:t,interval:e})})),b.map((function(e){return e.map((function(e){return o.createElement(Me,{key:e.name,hook:e})}))}))),o.createElement(Ce,null),o.createElement("ambientLight",{color:new l.Color("white"),intensity:.8}),o.createElement("directionalLight",{color:new l.Color("#FFFFFF"),intensity:2})))}function Re(e){var t=e.tensegrity,n=e.interval,r=e.onPointerDown,a=t.instance.unitVector(n.index),i=(new l.Quaternion).setFromUnitVectors(new l.Vector3(0,1,0),a),c=$(n),s=j(n.intervalRole),u=s?.012:.005,h=new l.Vector3(u,c+(s?-.03:0),u),f=new l.Vector3(.015,.015,.015);return o.createElement(o.Fragment,null,s?o.createElement(o.Fragment,null,o.createElement("mesh",{position:G(n),rotation:(new l.Euler).setFromQuaternion(i),scale:h,onPointerDown:r},o.createElement("meshLambertMaterial",{attach:"material",color:new l.Color("#bd7b14")}),o.createElement("cylinderGeometry",{attach:"geometry",args:[.5,.5,1,6,1]})),o.createElement("mesh",{position:G(n),rotation:(new l.Euler).setFromQuaternion(i),scale:h,matrixWorldNeedsUpdate:!0,onPointerDown:r},o.createElement("meshLambertMaterial",{attach:"material",color:new l.Color("#ec8700")}),o.createElement("cylinderGeometry",{attach:"geometry",args:[1,1,.85,12,1]})),o.createElement("mesh",{position:W(n.alpha),scale:f,onPointerDown:r},o.createElement("sphereGeometry",{attach:"geometry",args:[1,32,8]}),o.createElement("meshPhongMaterial",{attach:"material",color:new l.Color("#2bc19d")})),o.createElement("mesh",{position:W(n.omega),scale:f,onPointerDown:r},o.createElement("sphereGeometry",{attach:"geometry",args:[1,32,8]}),o.createElement("meshPhongMaterial",{attach:"material",color:new l.Color("#2bc19d")}))):o.createElement("mesh",{position:G(n),rotation:(new l.Euler).setFromQuaternion(i),scale:h,onPointerDown:r},o.createElement("meshLambertMaterial",{attach:"material",color:new l.Color("#faf8f8")}),o.createElement("cylinderGeometry",{attach:"geometry",args:[1,1,1,6,1]})))}function Me(e){var t=e.hook,n=new l.Vector3(.04,.04,.04),r=t.face;return o.createElement(o.Fragment,null,r.ends.map((function(e){return o.createElement("mesh",{key:"hook-".concat(e.index),position:W(e),scale:n,matrixWorldNeedsUpdate:!0},o.createElement("sphereGeometry",{attach:"geometry",args:[1,32,8]}),o.createElement("meshPhongMaterial",{attach:"material",color:new l.Color("#43d903")}))})))}function Ae(e){var t=Object(o.useRef)(),n=Object(le.c)().setDefaultCamera;return Object(o.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(35,10,30),n(e)}),[]),Object(le.b)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),o.createElement("perspectiveCamera",Object.assign({ref:t},e))}var Le=n(19),Ie=n(20),De=function(){function e(t,n,r,a){var i=this;Object(Le.a)(this,e),this.fabric=void 0,this.world=void 0,this.view=void 0,this.floatView=function(){var e=new Float32Array(0);return{jointCount:0,intervalCount:0,faceCount:0,lineGeometry:new l.BufferGeometry,faceGeometry:new l.BufferGeometry,jointLocations:e,unitVectors:e,idealLengths:e,strains:e,strainLimits:new Float32Array(4),strainNuances:e,stiffnesses:e,linearDensities:e}}(),this.adoptFabric=void 0,this.midpoint=new l.Vector3(0,0,0),this.forward=new l.Vector3(1,0,0),this.right=new l.Vector3(0,0,1),this.left=new l.Vector3(0,0,-1),this.featuresToApply=[],this.fabricBackup=void 0,this.world=r,this.adoptFabric=function(e){return i.free(),i.fabric=e,i.view=t.View.on_fabric(e),i},this.adoptFabric(a||t.Fabric.new(n))}return Object(Ie.a)(e,[{key:"iterate",value:function(){var e=this.fabric.iterate(this.world);this.refreshFloatView();var t=this.featuresToApply.shift();return t&&this.world.set_float_value(t.worldFeature,t.numeric),e}},{key:"showFrozen",value:function(e){this.updateFloatView(!0,e)}},{key:"snapshot",value:function(){console.log("snapshot"),this.fabricBackup=this.fabricClone}},{key:"restoreSnapshot",value:function(){console.log("restoreSnapshot");var e=this.fabricBackup;if(!e)throw new Error("Missing backup");this.adoptFabric(e.clone())}},{key:"refreshFloatView",value:function(){this.view.render(this.fabric,this.world),this.midpoint.set(this.view.midpoint_x(),this.view.midpoint_y(),this.view.midpoint_z()),this.updateFloatView(!1,!1)}},{key:"clear",value:function(){return this.fabric.clear(),this.refreshFloatView(),this}},{key:"applyFeature",value:function(e){this.featuresToApply.push(e)}},{key:"jointLocation",value:function(e){return A(this.floatView.jointLocations,e)}},{key:"apply",value:function(e){this.fabric.apply_matrix4(new Float32Array(e.toArray())),this.refreshFloatView()}},{key:"unitVector",value:function(e){return A(this.floatView.unitVectors,e)}},{key:"free",value:function(){var e=this.fabric;e&&e.free();var t=this.view;t&&t.free()}},{key:"updateFloatView",value:function(e,t){var n=this.fabric,r=this.view,a=n.get_joint_count(),i=n.get_interval_count(),c=n.get_face_count(),o=this.floatView;if(o.jointCount!==a||o.intervalCount!==i||o.faceCount!==c){o.jointCount=a,o.intervalCount=i,o.faceCount=c,o.lineGeometry.dispose(),o.lineGeometry=new l.BufferGeometry;var s=new Float32Array(3*i*2);r.copy_line_locations_to(s),o.lineGeometry.setAttribute("position",new l.Float32BufferAttribute(s,3));var u=new Float32Array(3*i*2);if(e)if(t){u.fill(0);for(var h=1;h<u.length;h+=3)u[h]=1}else u.fill(1);else r.copy_line_colors_to(u);o.lineGeometry.setAttribute("color",new l.Float32BufferAttribute(u,3)),o.faceGeometry.dispose(),o.faceGeometry=new l.BufferGeometry;var f=new Float32Array(3*c*3);r.copy_face_vertex_locations_to(f),o.faceGeometry.setAttribute("position",new l.Float32BufferAttribute(f,3));var d=new Float32Array(3*c*3);r.copy_face_normals_to(d),o.faceGeometry.setAttribute("normal",new l.Float32BufferAttribute(d,3)),o.jointLocations=new Float32Array(3*a),o.unitVectors=new Float32Array(3*i),o.idealLengths=new Float32Array(i),o.strains=new Float32Array(i),o.strainNuances=new Float32Array(i),o.stiffnesses=new Float32Array(i),o.linearDensities=new Float32Array(i)}else{var m=this.floatView.lineGeometry.attributes,g=this.floatView.faceGeometry.attributes;if(m.position){var v=m.position;r.copy_line_locations_to(v.array),v.needsUpdate=!0;var b=m.color,y=b.array;if(e)if(t){y.fill(0);for(var w=1;w<y.length;w+=3)y[w]=1}else y.fill(1);else r.copy_line_colors_to(y);b.needsUpdate=!0;var E=g.position;r.copy_face_vertex_locations_to(E.array),E.needsUpdate=!0;var S=g.normal;r.copy_face_normals_to(S.array),S.needsUpdate=!0}}r.copy_joint_locations_to(o.jointLocations),r.copy_unit_vectors_to(o.unitVectors),r.copy_ideal_lengths_to(o.idealLengths),r.copy_strains_to(o.strains),r.copy_strain_limits_to(o.strainLimits),r.copy_strain_nuances_to(o.strainNuances),r.copy_stiffnesses_to(o.stiffnesses),r.copy_linear_densities_to(o.linearDensities);var k=o.jointLocations;!function(e,t,n){var r=3*e,a=3*t;n.set(k[a]-k[r],k[a+1]-k[r+1],k[a+2]-k[r+2])}(2,1,this.forward),this.forward.y=0,this.forward.normalize(),this.right.crossVectors(this.forward,p).normalize(),this.left.set(0,0,0).sub(this.right)}},{key:"stage",get:function(){return this.fabric.get_stage()},set:function(e){this.fabric.request_stage(e,this.world)||console.error("Could not move to stage ".concat(e,"!"))}},{key:"fabricClone",get:function(){return this.fabric.clone()}}]),e}();var _e,Ne=n(42);!function(e){e.Script="Script",e.Phase="Phase",e.Shape="Shape",e.Live="Live",e.Frozen="Frozen"}(_e||(_e={}));var Be;function We(e,t){var n=e.getValue();return e.next(Object(Ne.a)(Object(Ne.a)({},n),{},{nonce:n.nonce+1},t))}function ze(e,t,n){var a=y.map(e).reduce((function(e,n){return e[n.feature]={percent:100,numeric:t(n.feature)},e}),{});return{version:"2020-11-03",nonce:0,surfaceCharacter:d.SurfaceCharacter.Frozen,featureValues:a,controlTab:_e.Script,demoCount:n,fullScreen:!0,viewMode:Be.Lines,rotating:!0,visibleRoles:x,currentRole:r.PhiPush,pushBottom:0,pushTop:1,pullBottom:0,pullTop:1}}!function(e){e.Lines="Lines",e.Selecting="Selecting",e.Frozen="Frozen"}(Be||(Be={}));function Ge(e){localStorage.setItem("State",JSON.stringify(e))}function $e(e,t){var n=localStorage.getItem("State");if(n){var r=JSON.parse(n);if("2020-11-03"===r.version)return 0===r.demoCount?ze(e,t,r.demoCount):r}return ze(e,t,0)}function Je(e){switch(e){case d.WorldFeature.Gravity:return{feature:e,name:"Gravity",percents:[0,10,25,50,100,200,500,1e3]};case d.WorldFeature.Antigravity:return{feature:e,name:"Antigravity",percents:[5,25,50,100,150,200,500]};case d.WorldFeature.ShapingDrag:return{feature:e,name:"Shaping Drag",percents:[0,10,50,100,200,500]};case d.WorldFeature.ShapingStiffnessFactor:return{feature:e,name:"Shaping Stiffness",percents:[10,50,100,200,300,500,1e3]};case d.WorldFeature.Drag:return{feature:e,name:"Drag",percents:[0,10,50,100,150,200,500,1e3]};case d.WorldFeature.ShapingPretenstFactor:return{feature:e,name:"Shaping Pretenst factor",percents:[0,5,25,50,100,200,500,1e3]};case d.WorldFeature.PretenstFactor:return{feature:e,name:"Pretenst",percents:[0,50,90,100,125,150,200,300,500]};case d.WorldFeature.StiffnessFactor:return{feature:e,name:"Stiffness",percents:[1,10,50,100,250,500,1e3,2500,5e3]};case d.WorldFeature.IterationsPerFrame:return{feature:e,name:"Iterations per frame",percents:[2,10,25,50,100,200,300,500]};case d.WorldFeature.IntervalCountdown:return{feature:e,name:"Interval Countdown",percents:[10,20,30,100,150,400,1e3]};case d.WorldFeature.PretensingCountdown:return{feature:e,name:"Slack to Pretenst countdown",percents:[50,75,90,100,125,150,200]};case d.WorldFeature.VisualStrain:return{feature:e,name:"Visual Strain",percents:[0,10,50,100,200,300,500,1e3]};case d.WorldFeature.PushOverPull:return{feature:e,name:"Compression/Tension",percents:[10,25,50,100,200,300,400,500,600,700]};default:throw new Error("Feature?")}}var Ue=function(){function e(t,n,r){Object(Le.a)(this,e),this.config=t,this.defaultValue=n,this.value$=void 0;var a=r.getValue().featureValues[t.feature],i=void 0!==a?a:{numeric:this.defaultValue,percent:100};this.value$=new u.BehaviorSubject(i),this.value$.subscribe((function(e){var n=r.getValue(),a=Object(Ne.a)({},n.featureValues);a[t.feature]=e,We(r,{featureValues:a})}))}return Object(Ie.a)(e,[{key:"value",get:function(){return this.value$.getValue()}},{key:"title",get:function(){return this.config.name}},{key:"percentChoices",get:function(){return this.config.percents}},{key:"numeric",get:function(){return this.value$.getValue().numeric}},{key:"formatted",get:function(){return C(this.numeric)}},{key:"percent",get:function(){return this.value$.getValue().percent},set:function(e){this.value$.next({numeric:this.defaultValue*e/100,percent:e})}},{key:"observable",get:function(){return this.value$}},{key:"worldFeature",get:function(){return this.config.feature}}]),e}();function qe(e,t){var n={};return y.map(Je).forEach((function(r){n[r.feature]=new Ue(r,t(r.feature),e)})),n}var He,Qe=function(){function e(t,n,r,a){Object(Le.a)(this,e),this.forward=t,this.scale=n,this.subtrees=r,this.marks=a,this.root=void 0}return Object(Ie.a)(e,[{key:"subtree",value:function(e){return this.subtrees[e]}},{key:"faceMarks",value:function(e){return this.marks[e]}},{key:"deleteMark",value:function(e){delete this.marks[e]}},{key:"nonEmpty",get:function(){return-1===this.forward&&0===this.subtreeCode.length&&0===this.markCode.length?void 0:this}},{key:"decremented",get:function(){return this.forward>0?new e(this.forward-1,this.scale,this.subtrees,this.marks):this}},{key:"needsOmniTwist",get:function(){var e=this,t=D.filter((function(e){return e!==k.A&&e!==k.a}));return t.some((function(t){return e.subtrees[t]}))||t.some((function(t){return e.marks[t]}))}},{key:"code",get:function(){var e=this.forward>0,t=100!==this.scale._,n=this.subtreeCode,r=this.markCode;if(!this.root&&e&&!t&&0===n.length&&0===r.length)return this.forward.toString();var a=[];return e&&a.push(this.forward.toString()),t&&a.push("S".concat(this.scale._)),a.push.apply(a,Object(f.a)(n)),a.push.apply(a,Object(f.a)(r)),"(".concat(a.join(","),")")}},{key:"subtreeCode",get:function(){return Object.entries(this.subtrees).map((function(e){var t=Object(oe.a)(e,2),n=t[0],r=t[1];return"".concat("aBCDbcdA"[n]).concat(r.code)}))}},{key:"markCode",get:function(){return Object.entries(this.marks).map((function(e){var t=Object(oe.a)(e,2),n=t[0];return t[1].map((function(e){return"M".concat("aBCDbcdA"[n]).concat(e._)}))})).flat()}}]),e}();function Ke(e,t,n,r,a,i){var c=n>3?n.toFixed(0):"",o=function(e){switch(e){case S.Left:return"L";case S.Right:return"R";case S.LeftRight:return"LR";case S.RightLeft:return"RL"}}(t)+c+r.code,s=[];Object.entries(a).forEach((function(e){var t=Object(oe.a)(e,2),n=t[0],r=t[1],a="-1"===n?"*":n;switch(r.action){case He.Subtree:var i=r.tree;if(!i)throw new Error("Missing tree");s.push("".concat(a,"=subtree").concat(i.code));break;case He.Base:s.push("".concat(a,"=base"));break;case He.Join:s.push("".concat(a,"=join"));break;case He.Distance:if(!r.scale)throw new Error("Missing scale");s.push("".concat(a,"=distance-").concat(r.scale._));break;case He.Tip:s.push("".concat(a,"=tip"));break;case He.Anchor:var c=r.point,o=r.scale;if(!c||!o)throw new Error("Bad anchor");var u=function(e){return e.toFixed(1)};s.push("".concat(a,"=anchor-(").concat(u(c.x),",").concat(u(c.z),")-").concat(-c.y,"-").concat(o._))}}));var u=s.length>0?":".concat(s.join(":")):"";return{name:e,tree:r,spin:t,pushesPerTwist:n,marks:a,fromUrl:i,code:"'".concat(e,"':").concat(o).concat(u)}}function Xe(e){return"0123456789".indexOf(e)>=0}function Ye(e){if(!e.match(/^\d*$/))throw new Error("Not a number: ".concat(e));return 0===e.length?0:parseInt(e,10)}!function(e){e[e.Subtree=0]="Subtree",e[e.Base=1]="Base",e[e.Join=2]="Join",e[e.Distance=3]="Distance",e[e.Tip=4]="Tip",e[e.Anchor=5]="Anchor",e[e.None=6]="None"}(He||(He={}));var Ze=/([LR]*)(\d*)(\(.*\))/;function et(e){var t=Ze.exec(e);if(!t)throw new Error("Couldn't parse");var n=function(e){switch(e){case"L":return S.Left;case"R":return S.Right;case"LR":return S.LeftRight;default:return S.RightLeft}}(t[1]),r=0===t[2].length?3:parseInt(t[2],10);return{mainCode:t[3],spin:n,pushesPerTwist:r}}function tt(e,t){var n=e.indexOf(","),r=n>=0;if("("!==e.charAt(0))return r?{content:e.substring(0,n),skip:n}:{content:e,skip:e.length};var a=function(e){if("("!==e.charAt(0))throw new Error('Code must start with "(": '.concat(e," ").concat(e.charAt(0)));for(var t=0,n=0;n<e.length;n++){var r=e.charAt(n);if("("===r)t++;else if(")"===r&&0===--t)return n}throw new Error("No matching end bracket: |".concat(e,"|"))}(e),i=t?e.substring(1,a):e.substring(0,a+1);return{content:i.length>0?i:"0",skip:a+1}}function nt(e,t,n){function r(e){var t=tt(e,!0).content,n=-1,a=Y(),i={},c={};function o(e){var n=tt(t.substring(e),!1),a=n.content,i=n.skip;return{codeTree:r(a),skip:i}}function s(e,t){var n=c[e],r={_:t};n?n.push(r):c[e]=[r]}for(var u=0;u<t.length;u++){var l=t.charAt(u);if(_(l)){var h=o(u+1),f=h.codeTree;if(!f)throw new Error("No subtree: ".concat(t.substring(u)));i[N(l)]=f,u+=h.skip}else if(Xe(l)){var d=tt(t,!1);n=Ye(d.content),u+=d.skip}else switch(l){case"S":var m=tt(t.substring(u+1),!0);a={_:Ye(m.content)},u+=m.skip;break;case"M":var g=t.charAt(u+1),p=tt(t.substring(u+2),!0);s(N(g),Ye(p.content)),u+=p.skip+1;break;case",":case" ":break;default:throw new Error("Unexpected character: ".concat(l))}}return new Qe(n,a,i,c).nonEmpty}try{if(!n||0===n.length)return void e("No code to parse");var a=function(e){var t=e.replace(/[\n\r\t]/g,"").split(":"),n=t.find((function(e){return e.startsWith("'")&&e.endsWith("'")})),r=et(t.find((function(e){return Ze.test(e)}))||"LR()"),a=r.mainCode,i=r.spin,c=r.pushesPerTwist,o={};return t.filter((function(e){return e.match(/^(\d+|\*)=.*$/)})).forEach((function(e){var t=e.indexOf("="),n=e.substring(0,t),r="*"===n?-1:Number(n);o[r]=e.substring(t+1)})),{name:n?n.replace(/'/g,""):"",spin:i,pushesPerTwist:c,mainCode:a,markCode:o}}(n),i=a.name,c=a.spin,o=a.pushesPerTwist,s=a.mainCode,u=a.markCode;if(!i.length)return void e("No name");var h=r(s);if(!h)return;h.root=!0;var f={};return Object.keys(u).forEach((function(e){var t=u[e];if(t.startsWith("subtree")){var n=r(t.substring("subtree".length));f[e]={action:He.Subtree,tree:n}}else if(t.startsWith("base"))f[e]={action:He.Base};else if(t.startsWith("tip"))f[e]={action:He.Tip};else if(t.startsWith("join"))f[e]={action:He.Join};else if(t.startsWith("distance-")){var a={_:parseInt(t.split("-")[1],10)};f[e]={action:He.Distance,scale:a}}else if(t.startsWith("anchor")){var i=t.match(/anchor-\(([0-9.-]*),([0-9.-]*)\)-(\d*)-(\d*)/);if(!i)throw new Error("Unrecognized mark code: [".concat(t,"]"));var c=parseFloat(i[1]),o=parseFloat(i[2]),s=parseFloat(i[3]),h={_:parseInt(i[4],10)},d=new l.Vector3(c,-s,o);f[e]={action:He.Anchor,point:d,scale:h}}})),Ke(i,c,o,h,f,t)}catch(d){return console.error("err",d),void e(d.message)}}var rt=["'Phi':LR()","'One':L(1)","'Tips':L(a(3,MA1,MA2),A(3,MA1,MA2)):1=tip:2=distance-80","'Axoneme':L(30,S95)","'Knee':L(3,b3)","'Snelson Star':LR(a(15,S90,MA1),b(15,S90,MA1),c(15,S90,MA1),d(15,S90,MA1)):1=tip","'Tripod with Knees':RL(A5,B(7,c(5,S90),S90),C(7,c(5,S90),S90),D(7,c(5,S90),S90))","'Pretenst Lander':LR(B(15,S90),C(15,S90),D(15,S90))","'Zig Zag Loop':LR(d(3,MA1),c(7,b(7,d(7,d(7,d(7,d(3,MA1))))))):1=join","'Bulge Ring':L(A(15,S90,MA1), a(16,S90,MA1)):1=join","'Ring':L(A(19,MA1),a(18,MA1)):1=join","'Convergence':LR(a1,b(15,S92,MA1),c(15,S92,MA1),d(15,S92,MA1)):1=join","'Halo by Crane':L(5,S92,b(12,S92,MA1),d(11,S92,MA1)):1=join","'Thick Tripod':LR(A3,B(8,MA1),C(8,MA1),D(8,MA1)):1=distance-35","'Diamond':RL(a(5,b(5,c(5,c(2,MA3)),d(5,b(2,MA4))),c(5,d(5,b(2,MA5)),c(5,c(2,MA1))),d(5,c(5,c(2,MA6)),d(5,b(2,MA2)))),b(5,b(5,d(2,MA3)),c(5,c(2,MA2))),c(5,b(5,d(2,MA6)),c(5,c(2,MA5))),d(5,c(5,c(2,MA4)),b(5,d(2,MA1)))):*=join","'Composed':L(6,b(4,MA1),c(4,MA1),d(4,MA1)):1=subtree(b5,c5,d5)","'Equus Lunae':LR(A(16,S95,Mb0,MA1),b(16,S95,Md0,MA1),a(16,S95,Md0,MA1),B(16,Mb0,MA1,S95)):0=distance-60:1=tip","'Infinity':LR(a(16,S90,MA1),b(16,S90,MA2),B(16,S90,MA1),A(16,S90,MA2)):*=join","'Binfinity':LR(d(16,S90,MA4),C(16,S90,MA4),c(16,S90,MA3),D(16,S90,MA3),a(16,S90,MA1),b(16,S90,MA2),B(16,S90,MA1),A(16,S90,MA2)):*=join","'Mobiosity':LR(d(16,S90,MA4),C(16,S90,MA4),c(16,S90,MA3),D(16,S90,MA2),a(16,S90,MA1),b(16,S90,MA2),B(16,S90,MA1),A(16,S90,MA3)):*=join","'Cup':L24(15,S105)","'Torus':L24(A(13,S95,MA1),a(14,S95,MA1)):1=join","'Pretenst Squared':L(a(3,MA1),A(2,MA1)):1=distance-70"].map((function(e){var t=nt((function(t){throw new Error('Bootstrap parse error in "'.concat(e,'"! ').concat(t))}),!1,e);if(!t)throw new Error("Unable to parse [".concat(e,"]"));return t}));function at(e,t,n,r,a){var i,c,o=e.builder,s=e.twist,u=e.marks,l=te(s,n),h=o.createTwistOn(l,a,r);return 0===t.forward&&(i=h,c=t,D.forEach((function(e){var t,n=c.faceMarks(e);n&&(t=te(i,e).marks).push.apply(t,Object(f.a)(n))}))),{tree:t,twist:h,builder:o,marks:u,reorient:!1}}function it(e){var t=[];return e.forEach((function(e){var n=e.tree,r=e.marks,a=e.builder,i=e.reorient;if(n.forward>0){var c=n.decremented,o=n.needsOmniTwist&&0===c.forward;t.push(at(e,c,k.A,o,n.scale))}else{if(i)if(![k.A,k.a,k.B,k.b].some((function(e){return!n.subtree(e)}))){var s=a.tensegrity.joints.map(W);a.tensegrity.instance.apply(function(e,t){var n=T(e[0],e[1]),r=T(e[3],e[2]),a=T(e[5],e[4]),i=e.reduce((function(e,t){return e.add(t)}),new l.Vector3).multiplyScalar(1/e.length),c=(new l.Matrix4).makeBasis(n,r,a).setPosition(i),o=(new l.Matrix4).makeRotationX(-.27*Math.PI),s=(new l.Matrix4).makeRotationY(-t*Math.PI/3);return c.multiply(o).multiply(s).invert()}(s,0))}D.forEach((function(a){var i=n.subtree(a);if(i){var c=i.decremented,o=i.needsOmniTwist&&0===i.forward;t.push(at(e,c,a,o,i.scale))}else{var s=n.faceMarks(a);s&&s.forEach((function(i){var c=r[i._],o=c||r[-1];if(o.action===He.Subtree){var s=o.tree;if(!s)throw new Error("Missing subtree");n.deleteMark(a);var u=s.needsOmniTwist;t.push(at(e,s,a,u,Y(s.scale)))}}))}}))}})),t}var ct=function(){function e(t){Object(Le.a)(this,e),this.tensegrity=t}return Object(Ie.a)(e,[{key:"createBud",value:function(e,t){var n=e.spin,r=e.tree,a=e.marks,i=-1===r.forward,c=t||new l.Vector3;return{builder:this,tree:r,twist:this.createTwistAt(c,n,Y()),marks:a,reorient:i}}},{key:"createTwistOn",value:function(e,t,n){var a=Z(e.scale),i=ee(Z(t)*a);if(n){var c=r.PhiPush,o=r.PhiTriangle,s=this.createTwist(ut(e,i),i,L(e.spin),c,o),u=te(s,k.A),l=this.createTwist(ut(u,i),i,L(u.spin),c,o),h=this.createOmniTwist(s,l);return this.connect(e,te(h,k.a),ot(e.omni,!0)),h}var f=ut(e,i),d=this.createTwist(f,i,L(e.spin),r.RootPush,r.InterTwist);return this.connect(e,te(d,k.a),ot(e.omni,!1)),d}},{key:"createTipOn",value:function(e){var t=this,n=function(e){var t=e.ends.map(W).reverse(),n=R(t),a=M(t),i=Z(e.scale)*b(r.TipPush),c=(new l.Vector3).copy(n).addScaledVector(a,.1*i),o=(new l.Vector3).copy(n).addScaledVector(a,-.1*i);return{alpha:c,omega:o}}(e),a=this.tensegrity.createJoint(n.alpha),i=this.tensegrity.createJoint(n.omega);this.tensegrity.instance.refreshFloatView();var c={push:this.tensegrity.createInterval(a,i,r.TipPush,e.scale),innerPulls:[],outerPulls:[]};return e.ends.forEach((function(n){c.innerPulls.push(t.tensegrity.createInterval(n,a,r.TipInner,e.scale)),c.outerPulls.push(t.tensegrity.createInterval(n,i,r.TipOuter,e.scale))})),e.pulls.forEach((function(e){return t.tensegrity.removeInterval(e)})),e.tip=c,c}},{key:"createInterTip",value:function(e,t,n){var a=e.push.alpha,i=t.push.alpha,c=z(a,i),o=ee(Z(n)*c);return this.tensegrity.createInterval(a,i,r.InterTip,o)}},{key:"faceToOrigin",value:function(e){var t=this.tensegrity.instance;t.apply(function(e){var t=e.ends.map(W),n=R(t),r=(new l.Vector3).subVectors(t[1],n).normalize(),a=(new l.Vector3).subVectors(t[0],n).normalize(),i=(new l.Vector3).crossVectors(r,a).normalize();return a.crossVectors(r,i).normalize(),(new l.Matrix4).makeBasis(r,i,a).setPosition(n).invert()}(e)),t.refreshFloatView()}},{key:"createRadialPulls",value:function(e,t,n){var r=this,a=function(){var t=ee(function(e){return e.reduce((function(e,t){return e+Z(t.scale)}),0)/e.length}(e)),n=X(e),a=r.createTwistAt(n,S.LeftRight,t);return r.tensegrity.instance.refreshFloatView(),e.map((function(e){var t=a.faces.filter((function(t){var n=t.spin;return t.pulls.length>0&&n!==e.spin})),n=K(e),i=t.reduce((function(e,t){return K(e).distanceTo(n)<K(t).distanceTo(n)?e:t}));return r.tensegrity.createRadialPull(i,e)}))};switch(t){case He.Distance:var i=n||ee(.75);if(!i)throw new Error("Missing pull scale");e.forEach((function(t,n){e.forEach((function(e,a){n<=a||r.tensegrity.createRadialPull(t,e,i)}))}));break;case He.Join:switch(e.length){case 2:e[0].spin===e[1].spin?a():this.tensegrity.createRadialPull(e[0],e[1]);break;case 3:a()}}t===He.Distance||He.Join}},{key:"checkConnectors",value:function(e,t){var n=this;if(0===e.length)return e;var a=function(e,t){!function(e,t){for(var n=Object(f.a)(e.ends).reverse(),r=t.ends,a=[],i=0;i<n.length;i++){for(var c=0,o=0;o<n.length;o++){var s=(o+i)%n.length;c+=z(n[o],r[s]),c+=z(r[s],n[(o+1)%n.length])}a.push(c)}var u=0,l=a[u];a.forEach((function(e,t){e<l&&(u=t,l=e)})),u>0&&(t.ends=t.ends.map((function(e,n){return Object(h.a)(e),t.ends[(n+u)%t.ends.length]})))}(e,t),n.connect(e,t,ot(e.omni,t.omni))};return e.filter((function(e){var n=e.axis,i=e.alpha,c=e.omega,o=e.alphaRays,s=e.omegaRays;if(n.intervalRole===r.ConnectorPull&&z(n.alpha,n.omega)<=.05)return a(i,c),t(n),o.forEach(t),s.forEach(t),!1;return!0}))}},{key:"createTwistAt",value:function(e,t,n){var a=this.tensegrity.pushesPerTwist;if(function(e){switch(e){case S.LeftRight:case S.RightLeft:return!0}return!1}(t)){var i=r.PhiPush,c=r.PhiTriangle,o=t===S.LeftRight?S.Left:S.Right,s=this.createTwist(st(e,a,o,n),n,o,i,c),u=te(s,k.A),l=this.createTwist(ut(u,n),n,L(u.spin),i,c);return this.createOmniTwist(s,l)}return this.createTwist(st(e,a,t,n),n,t,r.RootPush,r.InterTwist)}},{key:"createOmniTwist",value:function(e,t){var n=this,r=t.faces[1],a=e.faces[0],i=function(e){return!(r.ends.some((function(t){return e.index===t.index}))||a.ends.some((function(t){return e.index===t.index})))},c=this.connect(e.faces[1],t.faces[0],ot(!0,!0)),o=[].concat(Object(f.a)(e.pushes),Object(f.a)(t.pushes)),s=[].concat(Object(f.a)(e.pulls.filter((function(e){return!e.removed}))),Object(f.a)(t.pulls.filter((function(e){return!e.removed}))),Object(f.a)(c)),u=e.scale,l=function(e,t){var r=s.filter((function(t){var n=t.alpha,r=t.omega;return e.index===n.index||e.index===r.index})),a=r.map((function(t){return Q(e,t)})).filter(i),c=s.find((function(e){var t=e.alpha,n=e.omega;return t.index===a[0].index&&n.index===a[1].index})),o=s.find((function(e){var t=e.alpha,n=e.omega;return t.index===a[1].index&&n.index===a[0].index}));if(a.push(e),t===S.Left&&a.reverse(),c)r.push(c);else{if(!o)throw new Error("Interval not found");r.push(o)}return n.tensegrity.createFace(a,!0,t,u)},h=r.ends.map((function(e){return l(e,L(r.spin))})),d=a.ends.map((function(e){return l(e,L(a.spin))}));a.omni=r.omni=!0;var m=[a].concat(Object(f.a)(d),Object(f.a)(h),[r]);return{scale:u,pushes:o,pulls:s,faces:m}}},{key:"connect",value:function(e,t,n){for(var a=Object(f.a)(e.ends).reverse(),i=t.ends,c=a.map(H),o=a,s=i,u=i.map(H),l=ee((Z(e.scale)+Z(t.scale))/2),h=[],d=0;d<o.length;d++){var m=o[d],g=o[(d+1)%o.length],p=s[d];h.push(this.tensegrity.createInterval(m,p,n.ring,l)),h.push(this.tensegrity.createInterval(p,g,n.ring,l))}if(!this.tensegrity.minimal||n.ring===n.up)for(var v=0;v<o.length;v++){var b=c[v],y=c[(v+1)%c.length],w=o[v],E=o[(v+1)%o.length],k=s[v],x=u[v];e.spin===S.Left?h.push(this.tensegrity.createInterval(k,y,n.down,l)):h.push(this.tensegrity.createInterval(k,b,n.down,l)),t.spin===S.Left?h.push(this.tensegrity.createInterval(E,x,n.up,l)):h.push(this.tensegrity.createInterval(w,x,n.up,l))}if(n.ring===r.Ring)for(var j=ee((Z(e.scale)+Z(t.scale))/2),O=0;O<o.length;O++){var P=c[O],F=c[(O+1)%c.length],C=o[O],T=o[(O+1)%o.length],V=s[O],R=s[(O+1)%s.length],M=s[(O+s.length-1)%s.length],A=u[O];e.spin===S.Left?this.tensegrity.createFace([V,F,C],!1,L(e.spin),j):this.tensegrity.createFace([V,T,P],!1,L(e.spin),j),t.spin===S.Left?this.tensegrity.createFace([T,A,R],!1,L(t.spin),j):this.tensegrity.createFace([C,M,A],!1,L(t.spin),j)}return this.tensegrity.removeFace(t),this.tensegrity.removeFace(e),h}},{key:"createTwist",value:function(e,t,n,r,a){var i,c,o=this,s={scale:t,pushes:[],pulls:[],faces:[]},u=e.map((function(e){var t=e.alpha,n=e.omega;return{alpha:o.tensegrity.createJoint(t),omega:o.tensegrity.createJoint(n)}}));this.tensegrity.instance.refreshFloatView(),u.forEach((function(e){var n=e.alpha,a=e.omega,i=o.tensegrity.createInterval(n,a,r,t);s.pushes.push(i),n.push=a.push=i}));var l=u.map((function(e){return e.alpha})),h=u.map((function(e){return e.omega})).reverse();return(i=s.pulls).push.apply(i,Object(f.a)(l.map((function(e,n){return o.tensegrity.createInterval(e,l[(n+1)%l.length],a,t)})))),s.faces.push(this.tensegrity.createFace(l,!1,n,t)),(c=s.pulls).push.apply(c,Object(f.a)(h.map((function(e,n){return o.tensegrity.createInterval(e,h[(n+1)%h.length],a,t)})))),s.faces.push(this.tensegrity.createFace(h,!1,n,t)),u.forEach((function(e,r){var i=e.alpha,c=n===S.Left?u.length-1:1,l=u[(r+c)%u.length].omega;s.pulls.push(o.tensegrity.createInterval(i,l,a,t))})),s}}]),e}();function ot(e,t){return e||t?e&&!t?{ring:r.Ring,up:r.Cross,down:r.InterTwist}:!e&&t?{ring:r.Ring,up:r.InterTwist,down:r.Cross}:{ring:r.PhiTriangle,down:r.PhiTriangle,up:r.PhiTriangle}:{ring:r.Ring,up:r.InterTwist,down:r.InterTwist}}function st(e,t,n,r){for(var a=[],i=0;i<t;i++){var c=i*Math.PI*2/t,o=Math.cos(c),s=Math.sin(c);a.push(new l.Vector3(o,0,s).add(e))}return lt(a,n,r)}function ut(e,t){return lt(e.ends.map(W).reverse(),L(e.spin),t)}function lt(e,t,n){for(var a=b(r.PhiTriangle)*Z(n)/Math.sqrt(3),i=a*e.length/3/Math.sqrt(3),c=[],o=R(e),s=M(e).multiplyScalar(-a),u=0;u<e.length;u++){var h=T(e[(u+e.length-1)%e.length],o),f=T(e[u],o),d=T(e[(u+1)%e.length],o),m=T(e[(u+2)%e.length],o),g=V(f,d),p=V(d,m),v=V(f,h),y=(new l.Vector3).copy(o),w=(new l.Vector3).copy(o).add(s);t===S.Left?(y.addScaledVector(g,i),w.addScaledVector(p,i)):(y.addScaledVector(g,i),w.addScaledVector(v,i)),c.push({alpha:y,omega:w})}return c}var ht=function(){function e(t,n,r,a,i,c){Object(Le.a)(this,e),this.location=t,this.scale=n,this.minimal=r,this.numericFeature=a,this.instance=i,this.tenscript=c,this.stage$=void 0,this.joints=[],this.intervals=[],this.connectors=[],this.distancers=[],this.faces=[],this.pushesPerTwist=void 0,this.builder=void 0,this.jobs=[],this.buds=void 0,this.instance.clear(),this.stage$=new u.BehaviorSubject(this.fabric.get_stage()),this.pushesPerTwist=this.tenscript.pushesPerTwist,this.builder=new ct(this),this.buds=[this.builder.createBud(this.tenscript)]}return Object(Ie.a)(e,[{key:"createJoint",value:function(e){var t={index:this.fabric.create_joint(e.x,e.y,e.z),instance:this.instance};return this.joints.push(t),t}},{key:"createRadialPull",value:function(e,t,n){var a=this,i=this.createJoint(K(e)),c=this.createJoint(K(t));this.instance.refreshFloatView();var o=this.creatAxis(i,c,n),s=e.ends.reduce((function(e,t){return e+z(i,t)}),0)/e.ends.length,u=t.ends.reduce((function(e,t){return e+z(c,t)}),0)/t.ends.length,l=e.ends.map((function(e){return a.createRay(i,e,s)})),h=t.ends.map((function(e){return a.createRay(c,e,u)})),f={alpha:e,omega:t,axis:o,alphaRays:l,omegaRays:h};switch(o.intervalRole){case r.ConnectorPull:this.connectors.push(f);break;case r.Distancer:this.distancers.push(f)}return f}},{key:"createInterval",value:function(e,t,n,r){var a=b(n)*Z(r),i=z(e,t),c=this.numericFeature(d.WorldFeature.IntervalCountdown)*Math.abs(a-i),o={index:this.fabric.create_interval(e.index,t.index,j(n),i,a,c),intervalRole:n,scale:r,alpha:e,omega:t,removed:!1};return this.intervals.push(o),o}},{key:"changeIntervalScale",value:function(e,t){e.scale=ee(Z(e.scale)*t),this.fabric.multiply_rest_length(e.index,t,100)}},{key:"removeInterval",value:function(e){this.intervals=this.intervals.filter((function(t){return t.index!==e.index})),this.eliminateInterval(e.index),e.removed=!0}},{key:"createFace",value:function(e,t,n,r){var a=this,i=e[0],c=e[Math.floor(2*e.length/3)],o=e[Math.floor(e.length/3)],s=this.fabric.create_face(i.index,o.index,c.index),u=[[i,c],[c,o],[o,i]].reduce((function(e,t){var n=a.intervals.find(q(t[0],t[1]));return n?[].concat(Object(f.a)(e),[n]):e}),[]),l=I.None,h={index:s,omni:t,spin:n,scale:r,ends:e,pushes:[B(i),B(c),B(o)],pulls:u,faceSelection:l,marks:[]};return this.faces.push(h),h}},{key:"removeFace",value:function(e){var t=this;e.pulls.forEach((function(e){return t.removeInterval(e)})),e.pulls=[],this.fabric.remove_face(e.index),this.faces=this.faces.filter((function(t){return t.index!==e.index})),this.faces.forEach((function(t){t.index>e.index&&t.index--}))}},{key:"do",value:function(e){this.jobs.push(e)}},{key:"iterate",value:function(){var e=this,t=this.instance.iterate();if(t)return t;var n=this.jobs.shift();if(n)return n(this),!0;if(this.stage===d.Stage.Growing){if(this.buds.length>0)return this.buds=it(this.buds),0===this.buds.length&&function(e,t,n){var r={};return e.forEach((function(e){e.marks.forEach((function(t){var n=r[t._];n?n.push(e):r[t._]=[e]}))})),Object.entries(r).map((function(e){var a=Object(oe.a)(e,2),i=a[0],c=(a[1],t[i]||t[-1]),o=c||He.None;return new dt(r[i],o,n)}))}(this.faces,this.tenscript.marks,this.builder).forEach((function(e){return e.execute()})),!1;if(this.connectors.length>0)return this.connectors=this.builder.checkConnectors(this.connectors,(function(t){return e.removeInterval(t)})),!1;this.stage=d.Stage.Shaping}return!1}},{key:"strainToStiffness",value:function(){var e=this.instance.floatView,t=this.intervals.filter((function(e){return!j(e.intervalRole)&&(W(e.alpha).y>=0||W(e.omega).y>=0)})),n=e.strains,r=t.reduce((function(e,t){return e+n[t.index]}),0)/t.length,a=new Float32Array(e.stiffnesses);t.forEach((function(e){var t=(n[e.index]-r)/r;a[e.index]*=1+t})),this.instance.restoreSnapshot(),this.fabric.copy_stiffnesses(a)}},{key:"findInterval",value:function(e,t){return this.intervals.find(q(e,t))}},{key:"getFabricOutput",value:function(e,t,n){var r=this;this.instance.refreshFloatView();var a=this.instance.floatView.idealLengths,i=this.instance.floatView.strains,c=this.instance.floatView.stiffnesses,o=this.instance.floatView.linearDensities;return{name:this.tenscript.name,joints:this.joints.map((function(e){var t=W(e),a=function(e,t){var n=t.filter((function(t){return t.alpha.index===e.index||t.omega.index===e.index})),r=n.find((function(e){return j(e.intervalRole)}));if(!r)return[];var a=function(t){return(new l.Vector3).subVectors(W(Q(e,t)),W(e)).normalize()},i=a(r),c=n.map((function(t){return{interval:t,unit:a(t),hole:{index:0,interval:t.index,role:w(t.intervalRole),oppositeJoint:Q(e,t).index,chords:[]}}})).sort((function(e,t){var n=e.unit.dot(i),r=t.unit.dot(i);return n<r?1:n>r?-1:0}));return c.forEach((function(e,t){return e.hole.index=t})),c.forEach((function(e){var t;c.filter((function(t){return t.hole.index!==e.hole.index})).sort((t=e.unit,function(e,n){var r=e.unit.dot(t),a=n.unit.dot(t);return r<a?1:r>a?-1:0})).forEach((function(t){var n=Math.acos(e.unit.dot(t.unit)),r=2*Math.sin(n/2)*.015;e.hole.chords.push({holeIndex:t.hole.index,length:r})}))})),c.map((function(e){return e.hole}))}(e,r.intervals);return{index:e.index,radius:n,x:t.x,y:t.z,z:t.y,anchor:!1,holes:a}})),intervals:this.intervals.map((function(n){var s=j(n.intervalRole),u=s?e:t,l=$(n),h=n.alpha.index,f=n.omega.index;if(h>=r.joints.length||f>=r.joints.length)throw new Error("Joint not found ".concat(w(n.intervalRole),":").concat(h,",").concat(f,":").concat(r.joints.length));return{index:n.index,joints:[h,f],type:s?"Push":"Pull",strain:i[n.index],stiffness:c[n.index],linearDensity:o[n.index],role:w(n.intervalRole),scale:n.scale._,idealLength:a[n.index],isPush:s,length:l,radius:u}}))}}},{key:"creatAxis",value:function(e,t,n){var a=z(e,t),i=n?r.Distancer:r.ConnectorPull,c=n?Z(n)*a:.025,o=Y(),s=this.numericFeature(d.WorldFeature.IntervalCountdown)*Math.abs(c-a),u={index:this.fabric.create_interval(e.index,t.index,!1,a,c,s),alpha:e,omega:t,intervalRole:i,scale:o,removed:!1};return this.intervals.push(u),u}},{key:"createRay",value:function(e,t,n){var a=z(e,t),i=r.RadialPull,c=ee(n),o=this.numericFeature(d.WorldFeature.IntervalCountdown)*Math.abs(n-a),s={index:this.fabric.create_interval(e.index,t.index,!1,a,n,o),alpha:e,omega:t,intervalRole:i,scale:c,removed:!1};return this.intervals.push(s),s}},{key:"eliminateInterval",value:function(e){this.fabric.remove_interval(e),this.intervals.forEach((function(t){t.index>e&&t.index--}))}},{key:"fabric",get:function(){return this.instance.fabric}},{key:"intervalsWithStats",get:function(){return this.intervals.filter((function(e){return e.stats}))}},{key:"stage",get:function(){return this.stage$.getValue()},set:function(e){var t=this;this.instance.stage=e,e===d.Stage.Slack&&(this.distancers.forEach((function(e){var n=e.axis,r=e.alphaRays,a=e.omegaRays;[n].concat(Object(f.a)(r),Object(f.a)(a)).forEach((function(e){return t.removeInterval(e)}))})),this.distancers=[],this.instance.snapshot()),this.stage$.next(e)}}]),e}();var ft,dt=function(){function e(t,n,r){Object(Le.a)(this,e),this.faces=t,this.mark=n,this.builder=r}return Object(Ie.a)(e,[{key:"execute",value:function(){var e=this;switch(this.mark.action){case He.Base:this.builder.faceToOrigin(this.faces[0]);break;case He.Join:this.builder.createRadialPulls(this.faces,this.mark.action,this.mark.scale);break;case He.Distance:2===this.faces.length&&this.faces[0].tip&&this.faces[1].tip&&this.mark.scale?this.builder.createInterTip(this.faces[0].tip,this.faces[1].tip,this.mark.scale):this.builder.createRadialPulls(this.faces,this.mark.action,this.mark.scale);break;case He.Tip:this.faces.forEach((function(t){return e.builder.createTipOn(t)}));break;case He.Anchor:}}}]),e}();!function(e){e.Forward="Forward",e.Left="Left",e.Right="Right",e.MusclePeriod="Attack",e.AttackPeriod="Attack",e.DecayPeriod="Decay",e.TwitchNuance="TwitchNuance",e.TicksPerSlice="TicksPerSlice"}(ft||(ft={}));var mt=Object.keys(ft).filter((function(e){return function(e){switch(e){case ft.Forward:case ft.Left:case ft.Right:return!1;case ft.MusclePeriod:case ft.AttackPeriod:case ft.DecayPeriod:case ft.TwitchNuance:case ft.TicksPerSlice:return!0}}(ft[e])})).map((function(e){return ft[e]}));function gt(){return new bt(xt,[])}function pt(e){if(0===e.length)return gt();var t=e.map((function(e){var t=e.geneName,n=e.tosses,r=e.geneString;return{geneName:t,tosses:n,dice:r.split("").map((function(e){return wt[e]})).filter((function(e){return!!e}))}}));return new bt(xt,t)}function vt(e,t){var n=t.find((function(t){var n=t.geneName;return e===n}));if(n)return n;var r={geneName:e,tosses:0,dice:[]};return t.push(r),r}var bt=function(){function e(t,n){Object(Le.a)(this,e),this.roll=t,this.genes=n}return Object(Ie.a)(e,[{key:"createReader",value:function(e){return new kt(vt(e,this.genes),this.roll)}},{key:"withMutations",value:function(t,n){var r=this,a=this.genes.map((function(e){return{geneName:e.geneName,tosses:e.tosses,dice:e.dice.slice()}}));(t.forEach((function(e){!function(e,t){if(0===t.dice.length)t.dice.push(e());else for(var n=Math.floor(Math.random()*t.dice.length),r=t.dice[n];t.dice[n]===r;)t.dice[n]=e();t.tosses++}((function(){return r.roll()}),vt(e,a))})),n)&&vt(n,a).tosses++;return new e(this.roll,a)}},{key:"toString",value:function(){return this.genes.map((function(e){return"(".concat(e.geneName,":").concat(e.tosses,")")})).join(", ")}},{key:"totalTwitches",get:function(){var e=this.genes.reduce((function(e,t){var n=t.tosses;return Math.max(e,n)}),0);return Math.floor(Math.pow(e,.66))+2}},{key:"geneData",get:function(){return this.genes.map((function(e){return{geneName:e.geneName,tosses:e.tosses,geneString:function(e){return e.map((function(e){return e.symbol})).join("")}(e.dice)}}))}},{key:"tosses",get:function(){return this.genes.reduce((function(e,t){return e+t.tosses}),0)}}]),e}(),yt=[{index:0,numeral:"1",symbol:"\u2680",featureDelta:1/1.1/1.1/1.1},{index:1,numeral:"2",symbol:"\u2681",featureDelta:1/1.1/1.1},{index:2,numeral:"3",symbol:"\u2682",featureDelta:1/1.1},{index:3,numeral:"4",symbol:"\u2683",featureDelta:1.1},{index:4,numeral:"5",symbol:"\u2684",featureDelta:1.1*1.1},{index:5,numeral:"6",symbol:"\u2685",featureDelta:1.1*1.1*1.1}],wt=function(){var e={};return yt.forEach((function(t){e[t.numeral]=t,e[t.symbol]=t})),e}();function Et(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Math.floor(jt(n)*e)}function St(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return jt(n)*e}var kt=function(){function e(t,n){Object(Le.a)(this,e),this.gene=t,this.roll=n,this.cursor=0}return Object(Ie.a)(e,[{key:"readMuscleTwitch",value:function(e,t,n,r){var a=Et(2*e.length,this.next(),this.next(),this.next()),i=a%2===0,c=e[Math.floor(a/2)];return{when:Et(36,this.next(),this.next()),muscle:c,alternating:i,attack:(2+St(6,this.next()))*t,decay:(2+St(6,this.next()))*n,twitchNuance:r}}},{key:"modifyFeature",value:function(e){var t=e;0===this.gene.tosses&&this.gene.tosses++;for(var n=0;n<this.gene.tosses;n++)t*=.5*this.next().featureDelta+.5;return t}},{key:"next",value:function(){for(;this.gene.dice.length<this.cursor+1;)this.gene.dice.push(this.roll());return this.gene.dice[this.cursor++]}},{key:"length",get:function(){return this.gene.dice.length}}]),e}();function xt(){return yt[Math.floor(Math.random()*yt.length)]}function jt(e){if(0===e.length)throw new Error("No dice!");return e.reduce((function(e,t){return 6*e+t.index}),0)/Math.pow(6,e.length)}var Ot,Pt=function(){function e(t){var n=this;Object(Le.a)(this,e),this.state=t,this.cycleCount=0,this.twitchCount=0,this.config=void 0,this.ticks=0,this.twitchCycles={};var r=this.state.genome;this.config=function(e){var t=e.createReader(ft.MusclePeriod).modifyFeature(600);return{ticksPerSlice:e.createReader(ft.TicksPerSlice).modifyFeature(4),twitchNuance:e.createReader(ft.TwitchNuance).modifyFeature(.3),musclePeriod:t,attackPeriod:e.createReader(ft.AttackPeriod).modifyFeature(t),decayPeriod:e.createReader(ft.DecayPeriod).modifyFeature(t)}}(r);var a=r.totalTwitches;Rt.filter((function(e){return e!==Ot.Rest})).forEach((function(e){var i=Mt(e),c=r.createReader(i);n.twitchCycles[e]=new Ft(c,n.config,t.muscles,a)}))}return Object(Ie.a)(e,[{key:"toString",value:function(){var e=this,t=Object.keys(this.twitchCycles).map((function(t){return e.twitchCycles[t]})).map((function(e){return e.toString()})).join("\n");return"Twitcher(".concat(t,")")}},{key:"tick",value:function(e){if(this.ticks--,this.ticks<0){this.ticks=this.config.ticksPerSlice;var t=this.state;if(t.timeSlice++,t.timeSlice>=36)return t.timeSlice=0,this.cycleCount++,!0;var n=this.twitchCycles[t.direction];n&&(this.twitchCount+=n.activate(t.timeSlice,e))}return!1}}]),e}(),Ft=function(){function e(t,n,r,a){Object(Le.a)(this,e),this.slices={};for(var i=Object(f.a)(r),c=function(e){i=i.filter((function(t){var n=t.faceIndex;return e.faceIndex!==n}))};a-- >0;){var o=n.attackPeriod,s=n.decayPeriod,u=n.twitchNuance,l=t.readMuscleTwitch(i,o,s,u);this.addTwitch(l.when,l),c(l.muscle);var h=It(l.muscle,i),d=l.alternating?(l.when+18)%36:l.when;this.addTwitch(d,Object(Ne.a)(Object(Ne.a)({},l),{},{muscle:h,when:d})),c(h)}}return Object(Ie.a)(e,[{key:"toString",value:function(){var e=this,t=Object.keys(this.slices).map((function(t){return e.slices[t]})).map((function(e){return e.map((function(e){return"".concat(e.when,":").concat(e.muscle.faceIndex)})).join(";")})).join(",");return"Cycle(".concat(t,")")}},{key:"activate",value:function(e,t){var n=this.slices[e];return n?(n.forEach((function(e){var n=e.muscle,r=e.attack,a=e.decay,i=e.twitchNuance;return t(n,r,a,i)})),n.length):0}},{key:"addTwitch",value:function(e,t){var n=this.slices[e];n?n.push(t):this.slices[e]=[t]}}]),e}(),Ct="'Gorillagotchi':(A(4,S80,Mb0),b(4,S80,Mb0),a(2,S70,Md0),B(2,Md0,S70)):0=distance-60",Tt="'Satoshi Tree':(2,S85,b(4,S85,MA0),c(4,S85,MA0),d(4,S85,MA0)):0=subtree(b(3, S85),c(3, S85),d(3, S85))";!function(e){e.Rest="Rest",e.Forward="Forward",e.Left="Left",e.Right="Right"}(Ot||(Ot={}));var Vt,Rt=Object.keys(Ot).map((function(e){return Ot[e]}));function Mt(e){switch(e){case Ot.Forward:return ft.Forward;case Ot.Left:return ft.Left;case Ot.Right:return ft.Right;default:throw new Error("No gene for direction ".concat(e))}}function At(e,t,n){return{patch:e,targetPatch:e.adjacent[e.rotation],instance:t,muscles:[],extremities:[],genome:n,direction:Ot.Rest,directionHistory:[],autopilot:!1,timeSlice:0,reachedTarget:!1,twitchesPerCycle:30}}!function(e){e.FrontLeft="front-left",e.FrontRight="front-right",e.BackLeft="back-left",e.BackRight="back-right"}(Vt||(Vt={}));var Lt=function(){function e(t,n){Object(Le.a)(this,e),this.state=t,this.embryo=n,this.twitcher=void 0,n||(this.twitcher=new Pt(this.state))}return Object(Ie.a)(e,[{key:"snapshot",value:function(){this.state.instance.snapshot()}},{key:"recycled",value:function(t,n){var r=pt(n||this.patch.storedGenes[0]);return new e(Object(Ne.a)(Object(Ne.a)({},this.state),{},{instance:t,genome:r,directionHistory:[]}))}},{key:"getCycleCount",value:function(e){return this.twitcher?e?Math.floor(this.twitcher.twitchCount/this.state.twitchesPerCycle):this.twitcher.cycleCount:0}},{key:"adoptFabric",value:function(e){return this.state.instance.adoptFabric(e)}},{key:"getExtremity",value:function(e){var t=this.state.extremities.find((function(t){return t.limb===e}));if(!t)throw new Error("No extremity found");return t}},{key:"mutatedGeneData",value:function(){var e=this,t=Rt.map((function(t){var n=e.state.directionHistory.filter((function(e){return e===t})).length;return{dir:t,count:n}})).filter((function(e){return e.count>0})).map((function(e){return e.dir})).map(Mt),n=Math.random()>.95?mt[Math.floor(Math.random()*mt.length)]:void 0;return this.state.genome.withMutations(t,n).geneData}},{key:"getMidpoint",value:function(e){e||(e=new l.Vector3);var t=this.state.instance.view;return e.set(t.midpoint_x(),t.midpoint_y(),t.midpoint_z()),e}},{key:"iterate",value:function(e){var t=this,n=this.state.instance.view;if(e&&e.set(n.midpoint_x(),n.midpoint_y(),n.midpoint_z()),this.embryo)return!0;if(this.twitcher){this.twitcher.tick((function(e,n,r,a){return t.twitch(e,n,r,a)}))&&this.state.autopilot&&(this.reachedTarget?this.direction=Ot.Rest:this.checkDirection())}return!0}},{key:"showFrozen",value:function(){this.instance.showFrozen(this.reachedTarget)}},{key:"checkDirection",value:function(){var e=this.state;this.reachedTarget?this.direction=Ot.Rest:(e.direction=this.directionToTarget,e.directionHistory.push(e.direction))}},{key:"twitch",value:function(e,t,n,r){this.state.instance.fabric.twitch_face(e.faceIndex,t,n,r)}},{key:"quaternionForDirection",value:function(e){var t=this;return(new l.Quaternion).setFromUnitVectors(m,function(){var n=t.state.instance;switch(e){case Ot.Rest:case Ot.Forward:return n.forward;case Ot.Left:return n.left;case Ot.Right:return n.right}}())}},{key:"twitcherString",get:function(){return this.twitcher?this.twitcher.toString():"no twitcher"}},{key:"growing",get:function(){return!!this.embryo}},{key:"genome",get:function(){return this.state.genome},set:function(e){this.state.genome=e}},{key:"patch",get:function(){return this.state.patch}},{key:"instance",get:function(){return this.state.instance}},{key:"autopilot",get:function(){return this.state.autopilot},set:function(e){this.state.autopilot=e,e&&this.checkDirection()}},{key:"direction",get:function(){return this.state.direction},set:function(e){this.state.direction=e,this.autopilot=!1}},{key:"fabricClone",get:function(){return this.state.instance.fabricClone}},{key:"view",get:function(){return this.state.instance.view}},{key:"age",get:function(){return this.state.instance.fabric.age}},{key:"distanceFromTarget",get:function(){return this.getMidpoint().distanceTo(this.target)}},{key:"target",get:function(){return this.state.targetPatch.center}},{key:"showDirection",get:function(){return this.state.direction!==Ot.Rest}},{key:"directionQuaternion",get:function(){return this.quaternionForDirection(this.state.direction)}},{key:"reachedTarget",get:function(){return this.distanceFromTarget<4}},{key:"topJointLocation",get:function(){var e=this.state.instance.floatView.jointLocations;return new l.Vector3(e[9],e[10],e[11])}},{key:"directionToTarget",get:function(){var e=this.toTarget,t=this.state.instance;t.refreshFloatView();var n=e.dot(t.forward),r=e.dot(t.right);return r>0?n>r?Ot.Forward:Ot.Right:n>-r?Ot.Forward:Ot.Left}},{key:"toTarget",get:function(){var e=new l.Vector3,t=this.state.instance.view,n=new l.Vector3(t.midpoint_x(),t.midpoint_y(),t.midpoint_z());return e.subVectors(this.target,n),e.y=0,e.normalize(),e}}]),e}();function It(e,t){var n=e.name,r=e.limb,a=e.distance,i=k.a,c=function(e){switch(e){case Vt.BackRight:return Vt.BackLeft;case Vt.BackLeft:return Vt.BackRight;case Vt.FrontRight:return Vt.FrontLeft;case Vt.FrontLeft:return Vt.FrontRight;default:throw new Error("Strange limb")}}(r),o=t.find((function(e){return e.limb===c&&e.distance===a&&e.faceName===i}));if(!o)throw new Error("Unable to find opposite muscle to ".concat(n));return o}function Dt(e,t){switch(e){case d.WorldFeature.IterationsPerFrame:return 2*t;case d.WorldFeature.Gravity:return t;case d.WorldFeature.Drag:return 5*t;case d.WorldFeature.PretensingCountdown:return.5*t;case d.WorldFeature.PretenstFactor:return t;case d.WorldFeature.PushOverPull:return.25;default:return t}}function _t(e,t){switch(e){case d.WorldFeature.Gravity:return 5*t;case d.WorldFeature.IntervalCountdown:return.1*t;case d.WorldFeature.Antigravity:return.3*t;case d.WorldFeature.Drag:return 0;case d.WorldFeature.PretenstFactor:return 5*t;case d.WorldFeature.PretensingCountdown:return.02*t;default:return t}}var Nt,Bt=[5,6,7,8,9,10],Wt=8,zt=8;!function(e){e.WinnersRun="Winners run",e.ChallengersBorn="Challengers born",e.ChallengersReborn="Challengers reborn",e.ChallengersRun="Challengers run",e.WinnersStored="Winners stored",e.EvolutionAdvance="Evolution advance",e.EvolutionDone="Evolution done",e.EvolutionHarder="Evolution harder"}(Nt||(Nt={}));var Gt=function(){function e(t,n,r,a){if(Object(Le.a)(this,e),this.evolvingGotchi=t,this.createInstance=n,this.useTwitches=r,this.cyclePattern=a,this.snapshotsSubject=new u.BehaviorSubject([]),this.winners=[],this.challengersVisible=!1,this.challengers=[],this.phase=Nt.WinnersRun,this.cyclePatternIndex=void 0,this.currentCycle=0,this.currentMaxCycles=void 0,this.gotchiMidpoint=new l.Vector3,t.embryo)throw new Error("Cannot create evolution from gotchi which is not pretenst");t.checkDirection(),this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex=0];for(var i=[],c=t.patch.storedGenes;i.length<Wt;)i.push(this.createAutoGotchi(pt(c[i.length%c.length])));this.winners=i.map((function(e,t){return{gotchi:e,name:Ut(t),proximityHistory:[],persisted:!0}}))}return Object(Ie.a)(e,[{key:"iterate",value:function(){var e=this;switch(this.phase){case Nt.WinnersRun:var t=0,n=!1;if(this.winners.forEach((function(r){var a=r.gotchi,i=a.getCycleCount(e.useTwitches);i>t&&(t=i),i<e.currentMaxCycles&&(a.iterate(),n=!0)})),t>this.currentCycle&&($t(this.winners,this.currentCycle),this.currentCycle=t),!n)!this.winners.find((function(e){return!e.gotchi.reachedTarget}))?this.phase=Nt.EvolutionDone:(this.winners.forEach((function(e){return e.gotchi.showFrozen()})),this.phase=0===this.challengers.length?Nt.ChallengersBorn:Nt.ChallengersReborn,this.currentCycle=0);break;case Nt.ChallengersBorn:for(var r=[];r.length<zt;){var a=pt(this.winners[r.length%this.winners.length].gotchi.genome.geneData);r.push(this.createAutoGotchi(a.withMutations([Mt(this.evolvingGotchi.direction)])))}this.challengers=r.map((function(t,n){return t.autopilot=!0,{gotchi:t,name:"".concat(Ut(n+e.winners.length)).concat(Ut(n%e.winners.length)),proximityHistory:[],persisted:!1}})),this.phase=Nt.ChallengersRun;break;case Nt.ChallengersReborn:var i=0;this.challengers=this.challengers.map((function(t,n){var r=i++%e.winners.length,a=e.winners[r],c=t.gotchi.adoptFabric(e.evolvingGotchi.fabricClone),o=t.gotchi.recycled(c,a.gotchi.mutatedGeneData()),s="".concat(a.name).concat(Ut(n));return o.autopilot=!0,{gotchi:o,name:s,proximityHistory:[],persisted:!1}})),this.phase=Nt.ChallengersRun;break;case Nt.ChallengersRun:this.challengersVisible=!0;var c=!1,o=0;if(this.challengers.forEach((function(t){var n=t.gotchi,r=(t.name,n.getCycleCount(e.useTwitches));r>o&&(o=r),r<e.currentMaxCycles&&(n.iterate(),c=!0)})),o>this.currentCycle){var s=[].concat(Object(f.a)(this.winners),Object(f.a)(this.challengers));$t(s,this.currentCycle),this.broadcastSnapshot(s.map((function(t){return Jt(t,e.currentCycle)}))),this.currentCycle=o}c||(this.phase=Nt.WinnersStored);break;case Nt.WinnersStored:var u=this.splitEvolvers(this.currentCycle),l=u.winners,h=u.losers;this.evolvingGotchi.patch.storedGenes=l.map((function(e){return e.gotchi.genome.geneData})),l.forEach((function(e){return e.persisted=!0})),h.forEach((function(e){return e.persisted=!1})),this.broadcastSnapshot(l.map((function(t){return Jt(t,e.currentCycle)}))),this.winners=l,this.challengers=h,this.challengersVisible=!1,this.phase=Nt.EvolutionAdvance;break;case Nt.EvolutionAdvance:if(this.cyclePatternIndex===this.cyclePattern.length-1){var d=!this.winners.find((function(e){return!e.gotchi.reachedTarget}));this.phase=d?Nt.EvolutionHarder:Nt.EvolutionDone}else this.cyclePatternIndex++,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex],this.currentCycle=0,this.phase=Nt.WinnersRun;break;case Nt.EvolutionDone:case Nt.EvolutionHarder:}return this.phase}},{key:"getMidpoint",value:function(e){var t=this;return this.winners.forEach((function(n){var r=n.gotchi;return e.add(r.getMidpoint(t.gotchiMidpoint))})),e.multiplyScalar(1/this.winners.length),e}},{key:"splitEvolvers",value:function(e){var t=[],n=[],r=[].concat(Object(f.a)(this.winners),Object(f.a)(this.challengers));return $t(r,e),r.forEach((function(e,r){r<Wt?t.push(e):n.push(e)})),{cycleCount:e,winners:t,losers:n}}},{key:"broadcastSnapshot",value:function(e){var t=this.currentCycle,n=this.cyclePatternIndex,r={cycle:t,cyclePattern:this.cyclePattern,cycleIndex:n,evolverSnapshots:e},a=this.snapshotsSubject.getValue(),i=a.findIndex((function(e){return r.cycleIndex===e.cycleIndex}));if(i<0)this.snapshotsSubject.next([].concat(Object(f.a)(a),[r]));else if(i===a.length-1){var c=Object(f.a)(a);c[i]=r,this.snapshotsSubject.next(c)}else this.snapshotsSubject.next([r])}},{key:"createAutoGotchi",value:function(e){var t=this.createInstance(!1,this.evolvingGotchi.fabricClone),n=this.evolvingGotchi.recycled(t,e.geneData);return n.autopilot=!0,n}},{key:"withReducedCyclePattern",get:function(){var t=Object(f.a)(this.cyclePattern);if(t.pop(),!(t.length<3))return new e(this.evolvingGotchi,this.createInstance,this.useTwitches,t)}},{key:"target",get:function(){return this.evolvingGotchi.target}}]),e}();function $t(e,t){e.forEach((function(e){e.proximityHistory.length===t&&e.proximityHistory.push(e.gotchi.distanceFromTarget)})),e.sort((function(e,n){return e.proximityHistory[t]-n.proximityHistory[t]}))}function Jt(e,t){var n=e.gotchi,r=e.proximityHistory,a=e.persisted,i=e.name,c=r[t];if(void 0===c)throw new Error("Cannot snapshot");var o=n.genome.tosses;return{name:i,proximity:c,reachedTarget:n.reachedTarget,tosses:o,persisted:a}}function Ut(e){return String.fromCharCode(65+e)}function qt(e){var t=e.snapshots;return o.createElement("div",{className:"text-monospace d-inline-flex"},t.map((function(e){return o.createElement("div",{key:e.cycleIndex,className:"float-left p-1 m-1",style:{borderStyle:"solid",borderWidth:"2px"}},o.createElement(Ht,{snapshot:e}),o.createElement("div",{className:"m-2"},e.evolverSnapshots.map((function(e,t){for(var n=e.name,r=e.reachedTarget,a=e.persisted,i=e.proximity,c=e.tosses,s=[],u=n.length-1;u>0;)s.push(o.createElement(ue.m,{key:"".concat(n,"-").concat(u)})),u--;var l=r?o.createElement(ue.L,null):void 0;return o.createElement("div",{key:"competitor-".concat(t),style:{color:a?r?"#ffffff":"#2cd710":"#c2c2c2",backgroundColor:a?r?"#b1b1b1":"#848383":"#555454",borderRadius:"0.2em",marginBottom:"1px",padding:"2px",display:"block",whiteSpace:"nowrap"}},"".concat(Ut(t)," ").concat(i.toFixed(3)," ").concat(n).concat(c),"\xa0",s,l)}))))})))}function Ht(e){var t=e.snapshot,n=t.cyclePattern,r=t.cycleIndex,a=t.cycle;return o.createElement("div",{className:"p-1 my-2 w-100 text-center"},n.map((function(e,t){return o.createElement("span",{key:"cycle-".concat(t),style:{color:"black",backgroundColor:t===r?"#24f00f":"#cbc7c7",margin:"0.1em",padding:"0.2em",borderRadius:"0.3em",borderStyle:"solid",borderWidth:"1px"}},t===r&&a<n[r]?"".concat(a+1,"/").concat(e):e)})))}var Qt=[{x:0,y:0},{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1},{x:4,y:0},{x:3,y:-1},{x:2,y:-2},{x:0,y:-2},{x:-2,y:-2},{x:-3,y:-1},{x:-4,y:0},{x:-3,y:1},{x:-2,y:2},{x:0,y:2},{x:2,y:2},{x:3,y:1},{x:6,y:0},{x:5,y:-1},{x:4,y:-2},{x:3,y:-3},{x:1,y:-3},{x:-1,y:-3},{x:-3,y:-3},{x:-4,y:-2},{x:-5,y:-1},{x:-6,y:0},{x:-5,y:1},{x:-4,y:2},{x:-3,y:3},{x:-1,y:3},{x:1,y:3},{x:3,y:3},{x:4,y:2},{x:5,y:1}],Kt=[{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1}],Xt=Math.sin(60*Math.PI/180),Yt=12.5/Xt,Zt=Yt*Xt,en=1.5*Yt,tn=[new l.Vector3(0,0,-Yt),new l.Vector3(-Xt*Yt,0,-Yt/2),new l.Vector3(-Xt*Yt,0,Yt/2),new l.Vector3(0,0,Yt),new l.Vector3(Xt*Yt,0,Yt/2),new l.Vector3(Xt*Yt,0,-Yt/2)],nn=new l.Color("#4b4b4b"),rn=new l.Color("#59431e"),an=new l.Vector3(0,1,0),cn=new l.Vector3(0,500,0),on=new l.Color("#fff1d1");var sn,un=function(){var e=new l.Geometry;return e.vertices=function(){var e=function(){return new l.Vector3(0,0,0)},t=e(),n=e().addScaledVector(g,1.5*-.2).addScaledVector(m,3),r=e().addScaledVector(g,-.2).addScaledVector(m,3),a=e().addScaledVector(g,.2).addScaledVector(m,3),i=e().addScaledVector(g,.2*1.5).addScaledVector(m,3),c=e().addScaledVector(m,3*1.3);return[t,r,t,a,i,c,n,c,i,a,n,r]}(),e}(),ln=function(){function e(t,n,r){Object(Le.a)(this,e),this.island=t,this.coords=n,this.patchCharacter=r,this.gotchi=void 0,this.satoshiTree=void 0,this.center=void 0,this.name=void 0,this.adjacent=[],this.rotation=0,this.center=new l.Vector3(n.x*Zt,0,n.y*en),this.name="(".concat(n.x,",").concat(n.y,")")}return Object(Ie.a)(e,[{key:"createGotchi",value:function(e){var t=this.island.source.newGotchi(this,e,pt(this.storedGenes[0]));return this.gotchi=t,t}},{key:"createNewSatoshiTree",value:function(e){var t=this.island.source.newSatoshiTree(this,e);return this.satoshiTree=t,t}},{key:"onClick",get:function(){var e=this;return function(){e.satoshiTree?(e.satoshiTree.removeRandomInterval(),console.log("remove",e.name)):(e.rotation=(e.rotation+1)%6,console.log("rotate",e.name,e.rotation))}}},{key:"storedGenes",get:function(){var e=localStorage.getItem(this.name);return e?JSON.parse(e):[gt().geneData]},set:function(e){localStorage.setItem(this.name,JSON.stringify(e))}},{key:"positionArray",get:function(){for(var e=this,t=new Float32Array(54),n=0,r=function(r){var a=(new l.Vector3).copy(e.center).addScaledVector(r,.99),i=a.x,c=a.y,o=a.z;t[n++]=i,t[n++]=c,t[n++]=o},a=0;a<6;a++){var i=(a+1)%6;r(new l.Vector3),r(tn[a]),r(tn[i])}return t}},{key:"normalArray",get:function(){for(var e=new Float32Array(54),t=0,n=function(n){var r=n.x,a=n.y,i=n.z;e[t++]=r,e[t++]=a,e[t++]=i},r=0;r<6;r++){var a=(r+1)%6;n(an),n((new l.Vector3).add(an).addScaledVector(tn[r],.9/25).normalize()),n((new l.Vector3).add(an).addScaledVector(tn[a],.9/25).normalize())}return e}}]),e}();!function(e){e.FaunaPatch="Fauna",e.FloraPatch="Flora"}(sn||(sn={}));var hn,fn=function(){function e(t,n,r){Object(Le.a)(this,e),this.source=t,this.name=n,this.patches=[],this._seed=void 0,this._seed=r%2147483647,this.fill()}return Object(Ie.a)(e,[{key:"findPatch",value:function(e){return this.patches.find((function(t){return n=t.coords,r=e,n.x===r.x&&n.y===r.y;var n,r}))}},{key:"fill",value:function(){var e=this;this.createSurroundedPatch({x:0,y:0}),this.patches.forEach((function(t){var n=t.coords;Kt.forEach((function(r){var a=r.x,i=r.y;t.adjacent.push(e.findPatch({x:a+n.x,y:i+n.y}))}))}))}},{key:"createSurroundedPatch",value:function(e){var t=this,n=this.getOrCreatePatch(e);return Qt.map((function(n){return t.getOrCreatePatch((a=e,{x:(r=n).x+a.x,y:r.y+a.y}));var r,a})),n}},{key:"getOrCreatePatch",value:function(e){var t=this.findPatch(e);if(t)return t;var n=this.next()>.5?sn.FaunaPatch:sn.FloraPatch,r=new ln(this,e,n);return this.patches.push(r),r}},{key:"next",value:function(){return this._seed=16807*this._seed%2147483647,(this._seed-1)/2147483646}},{key:"midpoint",get:function(){return this.patches.reduce((function(e,t){return e.add(t.center)}),new l.Vector3).multiplyScalar(1/this.patches.length)}}]),e}();function dn(e){var t=e.island,n=e.satoshiTrees,r=e.happening,a=e.gotchi,i=e.evolution,c=(e.evolutionPhase,e.countdownToEvolution),s=(e.stopEvolution,Object(o.useState)(Date.now())),u=Object(oe.a)(s,2),l=u[0],h=u[1],f=Object(o.useState)(Date.now()),d=Object(oe.a)(f,2),m=d[0],g=d[1];return Object(le.b)((function(){var e=Math.floor(Math.random()*n.length);n[e].iterate();var t=Math.floor((m-l)/1e3),a=Date.now();g(a);var i=Math.floor((a-l)/1e3);r===hn.Resting&&t<i&&c(20-i)})),Object(o.useEffect)((function(){h(Date.now()),g(Date.now())}),[r]),o.createElement("group",null,o.createElement(se.a,{onPointerMissed:void 0}),o.createElement("scene",null,i&&r===hn.Evolving?o.createElement(mn,{evolution:i}):a?o.createElement(gn,{gotchi:a,faces:!0}):void 0,t.patches.map((function(e){var t=e.positionArray,n=e.normalArray;return o.createElement("mesh",{key:"patch-".concat(e.name),onClick:e.onClick},o.createElement("meshPhongMaterial",{attach:"material",color:e.patchCharacter===sn.FaunaPatch?nn:rn}),o.createElement("bufferGeometry",{attach:"geometry"},o.createElement("bufferAttribute",{attachObject:["attributes","position"],array:t,count:t.length/3,itemSize:3}),o.createElement("bufferAttribute",{attachObject:["attributes","normal"],array:n,count:n.length/3,itemSize:3})))})),n.map((function(e){return o.createElement(pn,{key:"tree-".concat(e.name),satoshiTree:e})})),o.createElement("pointLight",{distance:1e3,decay:.1,position:cn}),o.createElement("hemisphereLight",{name:"Hemi",color:on})))}function mn(e){var t=e.evolution,n=new l.Vector3;t.getMidpoint(n);var r=t.target;return o.createElement("group",null,t.winners.map((function(e,t){var n=e.gotchi;return o.createElement(gn,{key:"evolving-".concat(t),gotchi:n,faces:!1})})),t.challengersVisible?t.challengers.map((function(e,n){var r=e.gotchi;return o.createElement(gn,{key:"evolving-".concat(n+t.winners.length),gotchi:r,faces:!1})})):void 0,o.createElement("lineSegments",null,o.createElement("bufferGeometry",{attach:"geometry"},o.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([n.x,0,n.z,n.x,6,n.z,n.x,6,n.z,r.x,6,r.z,r.x,6,r.z,r.x,0,r.z]),count:6,itemSize:3,onUpdate:function(e){return e.needsUpdate=!0}})),o.createElement("lineBasicMaterial",{attach:"material",color:"#cace02"})))}function gn(e){var t=e.gotchi,n=e.faces,r=t.topJointLocation,a=t.target,i=t.state,c=t.showDirection,s=i.instance.floatView;return o.createElement("group",null,o.createElement("lineSegments",{geometry:s.lineGeometry,onUpdate:function(e){return e.geometry.computeBoundingSphere()}},o.createElement("lineBasicMaterial",{attach:"material",vertexColors:!0})),n?o.createElement("mesh",{geometry:s.faceGeometry,onUpdate:function(e){return e.geometry.computeBoundingSphere()}},o.createElement("meshPhongMaterial",{attach:"material",transparent:!0,side:l.DoubleSide,opacity:.6,color:"white"})):void 0,c?o.createElement("group",null,o.createElement("lineSegments",null,o.createElement("bufferGeometry",{attach:"geometry"},o.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([r.x,r.y,r.z,a.x,r.y,a.z]),count:2,itemSize:3,onUpdate:function(e){return e.needsUpdate=!0}})),o.createElement("lineBasicMaterial",{attach:"material",color:"#cecb05"})),o.createElement("lineSegments",{geometry:un,quaternion:t.directionQuaternion,position:t.topJointLocation},o.createElement("lineBasicMaterial",{attach:"material",color:"#05cec0"}))):void 0)}function pn(e){var t=e.satoshiTree.instance.floatView;return o.createElement("mesh",{geometry:t.faceGeometry},o.createElement("meshPhongMaterial",{attach:"material",side:l.DoubleSide,color:"green"}))}function vn(e){var t=e.island,n=e.homePatch,r=e.createInstance,a=Object(o.useState)((function(){return t.patches.filter((function(e){return e.patchCharacter===sn.FloraPatch})).map((function(e){return e.createNewSatoshiTree(r(!0))}))})),i=Object(oe.a)(a,1)[0],c=Object(o.useState)((function(){return n.createGotchi(r(!1))})),s=Object(oe.a)(c,2),u=s[0],l=s[1],h=Object(o.useState)(hn.Developing),f=Object(oe.a)(h,2),m=f[0],g=f[1],p=Object(o.useState)(!0),v=Object(oe.a)(p,2),b=v[0],y=v[1],w=Object(o.useState)([]),S=Object(oe.a)(w,2),k=S[0],x=S[1],j=Object(o.useState)(-1),P=Object(oe.a)(j,2),C=P[0],T=P[1],V=Object(o.useState)(void 0),R=Object(oe.a)(V,2),M=R[0],A=R[1],L=Object(o.useState)(Nt.WinnersRun),I=Object(oe.a)(L,2),D=I[0],_=I[1],N=Object(o.useState)(void 0),B=Object(oe.a)(N,2),W=B[0],z=B[1];Object(o.useEffect)((function(){if(u&&u.embryo){g(hn.Developing);var e=u.embryo.stage$.subscribe((function(e){W===d.Stage.Pretenst&&g(hn.Resting),z(e)}));return function(){return e.unsubscribe()}}z(void 0)}),[u]),Object(o.useEffect)((function(){if(M){var e=M.snapshotsSubject.subscribe(x);return function(){return e.unsubscribe()}}}),[M]);var G=function(e,t){A(M?M.withReducedCyclePattern:new Gt(e,r,!1,t)),g(hn.Evolving)};return o.createElement("div",{id:"view-container",style:{position:"absolute",left:0,right:0,height:"100%"}},o.createElement(le.a,{key:t.name,style:{backgroundColor:"black"}},o.createElement(wn,null),o.createElement(dn,{island:t,satoshiTrees:i,happening:m,gotchi:u,evolution:M,evolutionPhase:function(e){e!==D&&_(e)},countdownToEvolution:function(e){T(e),u&&0===e&&G(u,Bt)},stopEvolution:function(e){A(e),e||(l(n.createGotchi(r(!1))),g(hn.Developing))}})),u?m===hn.Developing?W?o.createElement("div",{id:"bottom-middle"},o.createElement("div",{className:"py-2 px-3 text-center"},o.createElement(ue.f,null)," ",O(W))):o.createElement("h1",null,"nothing"):o.createElement(bn,{gotchi:u,happening:m,evolutionCountdown:C,evoDetails:b,toRunning:function(){g(hn.Running),u.autopilot=!0},toEvolving:function(){g(hn.Evolving),T(-1),G(u,Bt)},toRebirth:function(){l(n.createGotchi(r(!1))),g(hn.Developing)},toRest:function(){g(hn.Resting),u.direction=Ot.Rest},toggleEvoDetails:function(){return y(!b)}}):o.createElement("h1",null,"no gotchi"),M?o.createElement(o.Fragment,null,o.createElement("div",{id:"top-middle"},k.length<=0||b?o.createElement("strong",{className:"p-2"},D):o.createElement(Ht,{snapshot:k[k.length-1]})),o.createElement(yn,{happening:m,evolution:M,snapshots:k,evoDetails:b})):void 0,o.createElement("div",{id:"bottom-right"},o.createElement(he.a,{vertical:!1,className:"w-100"},o.createElement(fe.a,{onClick:function(){return F(E.Design)}},o.createElement(ue.G,null)))))}function bn(e){var t=e.gotchi,n=e.happening,r=e.evoDetails,a=e.evolutionCountdown,i=e.toRunning,c=e.toRest,s=e.toEvolving,u=e.toRebirth,l=e.toggleEvoDetails,h=function(){switch(n){case hn.Developing:return o.createElement("h1",null,"developing");case hn.Resting:return t?o.createElement(he.a,{className:"w-100"},o.createElement(fe.a,{color:"success",onClick:i},o.createElement(ue.E,null)),o.createElement(fe.a,{color:"success",onClick:s},o.createElement(ue.m,null)," ",a>=0?a:""),o.createElement(fe.a,{color:"success",onClick:u},o.createElement(ue.f,null))):void 0;case hn.Running:return t?o.createElement(he.a,{className:"w-100"},o.createElement(fe.a,{color:"success",onClick:c},o.createElement(ue.L,null)," Rest")):void 0;case hn.Evolving:return t?o.createElement(he.a,{className:"w-100"},o.createElement(fe.a,{color:"success",onClick:u},o.createElement(ue.f,null)),o.createElement(fe.a,{color:r?"success":"secondary",onClick:l},o.createElement(ue.m,null),"\xa0",r?o.createElement(ue.o,null):o.createElement(ue.p,null))):void 0}}();return h?o.createElement("div",{id:"bottom-middle"},h):o.createElement("h1",null,n)}function yn(e){var t=e.happening,n=e.evolution,r=e.snapshots,a=e.evoDetails;switch(t){case hn.Developing:case hn.Running:case hn.Resting:return o.createElement("div",null);case hn.Evolving:return n&&r.length>0&&a?o.createElement("div",{id:"evolution-stats"},o.createElement(qt,{snapshots:r})):o.createElement("div",null)}}function wn(e){var t=Object(o.useRef)(),n=Object(le.c)().setDefaultCamera;return Object(o.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(10,10,10),n(e)}),[]),Object(le.b)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),o.createElement("perspectiveCamera",Object.assign({ref:t},e))}!function(e){e[e.Developing=0]="Developing",e[e.Resting=1]="Resting",e[e.Running=2]="Running",e[e.Evolving=3]="Evolving"}(hn||(hn={}));var En=function(){function e(t,n){Object(Le.a)(this,e),this.name=t,this.tensegrity=n,this.shapingTime=60,this.deadInterval=void 0}return Object(Ie.a)(e,[{key:"removeRandomInterval",value:function(){this.deadInterval||this.tensegrity.stage$.getValue()!==d.Stage.Pretenst||(this.deadInterval=this.tensegrity.intervals[Math.floor(Math.random()*this.tensegrity.intervals.length)])}},{key:"iterate",value:function(){var e=this.tensegrity.stage$.getValue();this.tensegrity.iterate();var t=d.Stage.Slack;switch(e===d.Stage.Pretensing&&t===d.Stage.Pretenst||void 0!==t&&t!==e&&d.Stage.Pretensing,this.deadInterval&&(this.tensegrity.removeInterval(this.deadInterval),this.deadInterval=void 0),t){case d.Stage.Shaping:return this.shapingTime<=0||this.shapingTime--,!1;case d.Stage.Pretensing:case d.Stage.Pretenst:return!0;default:return!1}}},{key:"instance",get:function(){return this.tensegrity.instance}}]),e}(),Sn=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function kn(){if("serviceWorker"in navigator){if(new URL("/app",window.location.toString()).origin!==window.location.origin)return;window.addEventListener("load",(function(){var e="".concat("/app","/service-worker.js");Sn?(!function(e){fetch(e).then((function(t){404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then((function(e){e.unregister().then((function(){window.location.reload()}))})):xn(e)})).catch((function(){console.log("No internet connection found. App is running in offline mode.")}))}(e),navigator.serviceWorker.ready.then((function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")}))):xn(e)}))}}function xn(e){navigator.serviceWorker.register(e).then((function(e){e.onupdatefound=function(){var t=e.installing;t&&(t.onstatechange=function(){"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))})}})).catch((function(e){console.error("Error during service worker registration:",e)}))}var jn=function(){function e(t){Object(Le.a)(this,e),this.sphere=t}return Object(Ie.a)(e,[{key:"build",value:function(){var e=this;switch(Pn.forEach((function(t){return e.sphere.hubAt(new l.Vector3(t[0],t[1],t[2]))})),this.edgeVertexCount){case 0:this.build30Edges();break;case 1:var t=this.build60Edges();this.buildSmallFaces(t);break;default:var n=this.buildEdges();this.buildFaces(n)}var r=this.sphere.hubs[0].spokes[0].push,a=.28*z(r.alpha,r.omega);return this.sphere.hubs.forEach((function(t){return t.spokes.forEach((function(n){return e.sphere.pullsForSpoke(t,n,a)}))})),this.sphere.fabric.set_altitude(this.sphere.location.y),this.sphere}},{key:"push",value:function(e,t,n){if(n){var r=(new l.Vector3).copy(e.location).lerp(t.location,.5),a=this.sphere.hubAt(r);return this.sphere.pushBetween(e,a),this.sphere.pushBetween(a,t),{hubA:e,hubB:t,hubMid:a}}return this.sphere.pushBetween(e,t),{hubA:e,hubB:t}}},{key:"build60Edges",value:function(){var e=this,t=[];return Fn.forEach((function(n){var r=e.push(e.vertices[n[0]],e.vertices[n[1]],!0).hubMid;r&&t.push(r)})),t}},{key:"build30Edges",value:function(){var e=this;Fn.forEach((function(t){return e.push(e.vertices[t[0]],e.vertices[t[1]])}))}},{key:"buildEdges",value:function(){var e=this,t=[];return Fn.forEach((function(n){var r,a,i=[];t.push(i);for(var c=0;c<e.edgeVertexCount;c++){a=r;var o=e.vertices[n[0]],s=e.vertices[n[1]],u=o.location,h=s.location,f=(new l.Vector3).lerpVectors(u,h,(c+1)/e.sphere.frequency);r=e.sphere.hubAt(f),i.push(r),a?(e.push(r,a),c===e.edgeVertexCount-1&&e.push(r,s)):e.push(r,o)}})),Vn.forEach((function(n){for(var r=0;r<n.length;r++){var a=(r+1)%n.length,i=1===n[r][1]?0:e.edgeVertexCount-1,c=1===n[a][1]?0:e.edgeVertexCount-1,o=t[n[r][0]][i],s=t[n[a][0]][c];e.push(o,s)}})),t}},{key:"buildSmallFaces",value:function(e){var t=this;Tn.forEach((function(n){var r=e[Math.abs(n[0])],a=e[Math.abs(n[1])],i=e[Math.abs(n[2])];t.push(r,a),t.push(a,i),t.push(i,r)}))}},{key:"buildFaces",value:function(e){for(var t=[],n=0;n<this.edgeVertexCount-1;n++)t.push([]);for(var r=new l.Vector3,a=new l.Vector3,i=0;i<Cn.length;i++){for(var c=this.vertices[Cn[i][0]].location,o=1;o<this.edgeVertexCount;o++){var s=this.vertices[Cn[i][1]];r.lerpVectors(c,s.location,o/this.sphere.frequency),r.sub(c),t[o-1]=[];for(var u=1;u<this.edgeVertexCount-o+1;u++){var h=this.vertices[Cn[i][2]];a.lerpVectors(c,h.location,u/this.sphere.frequency),a.sub(c);var f=(new l.Vector3).copy(c);f.add(r),f.add(a),t[o-1].push(this.sphere.hubAt(f))}}for(var d=0;d<t.length;d++)for(var m=0;m<t[d].length;m++)if(m<t[d].length-1&&this.push(t[d][m],t[d][m+1]),d>0){var g=t[d][m];this.push(g,t[d-1][m]),this.push(g,t[d-1][m+1])}for(var p=[],v=[],b=[],y=0;y<this.edgeVertexCount-1;y++){var w=t.length-y-1;p.push(t[Tn[i][0]>=0?y:w][0]);var E=t[Tn[i][1]<0?y:w];v.push(E[E.length-1]),b.push(t[0][Tn[i][2]<0?y:w])}var S=[];S.push(p),S.push(v),S.push(b);for(var k=0;k<S.length;k++)for(var x=e[Math.abs(Tn[i][k])],j=0;j<t.length;j++){var O=S[k][j];this.push(O,x[j]),this.push(O,x[j+1])}}}},{key:"vertices",get:function(){return this.sphere.hubs}},{key:"edgeVertexCount",get:function(){return this.sphere.frequency-1}}]),e}(),On=.5257311121191336,Pn=[[+On,0,.85065080835204],[+On,0,-.85065080835204],[.85065080835204,+On,0],[-.85065080835204,+On,0],[0,.85065080835204,+On],[0,-.85065080835204,+On],[-On,0,-.85065080835204],[-On,0,.85065080835204],[-.85065080835204,-On,0],[.85065080835204,-On,0],[0,-.85065080835204,-On],[0,.85065080835204,-On]],Fn=[[0,2],[0,4],[0,5],[0,7],[0,9],[1,10],[1,11],[1,2],[1,6],[1,9],[2,11],[2,4],[2,9],[3,11],[3,4],[3,6],[3,7],[3,8],[4,11],[4,7],[5,10],[5,7],[5,8],[5,9],[6,10],[6,11],[6,8],[7,8],[8,10],[9,10]],Cn=[[0,2,4],[0,2,9],[0,4,7],[0,5,7],[0,5,9],[1,2,11],[1,2,9],[1,6,10],[1,6,11],[1,9,10],[2,4,11],[3,4,11],[3,4,7],[3,6,11],[3,6,8],[3,7,8],[5,7,8],[5,8,10],[5,9,10],[6,8,10]],Tn=[[0,11,-1],[0,12,-4],[1,19,-3],[2,21,-3],[2,23,-4],[7,10,-6],[7,12,-9],[8,24,-5],[8,25,-6],[9,29,-5],[11,18,-10],[14,18,-13],[14,19,-16],[15,25,-13],[15,26,-17],[16,27,-17],[21,27,-22],[22,28,-20],[23,29,-20],[26,28,-24]],Vn=[[[0,1],[1,1],[3,1],[2,1],[4,1]],[[7,1],[6,1],[8,1],[5,1],[9,1]],[[10,1],[11,1],[0,-1],[12,1],[7,-1]],[[14,1],[13,1],[15,1],[17,1],[16,1]],[[18,1],[11,-1],[1,-1],[19,1],[14,-1]],[[21,1],[22,1],[20,1],[23,1],[2,-1]],[[26,1],[24,1],[8,-1],[25,1],[15,-1]],[[27,1],[16,-1],[19,-1],[3,-1],[21,-1]],[[28,1],[22,-1],[27,-1],[17,-1],[26,-1]],[[4,-1],[23,-1],[29,1],[9,-1],[12,-1]],[[28,-1],[20,-1],[29,-1],[5,-1],[24,-1]],[[6,-1],[10,-1],[18,-1],[13,-1],[25,-1]]];function Rn(e,t){switch(e){case d.WorldFeature.Drag:case d.WorldFeature.VisualStrain:return 0;default:return t}}var Mn=[1,2,3,4,5,6,7,8];function An(e){var t=e.createSphere,n=Object(o.useState)(!1),r=Object(oe.a)(n,2),a=r[0],i=r[1],c=Object(o.useState)((function(){if(location.hash.startsWith("#sphere-")){var e=parseInt(location.hash.substring("#sphere-".length),10);if(Mn.find((function(t){return t===e})))return e}return 1})),s=Object(oe.a)(c,2),u=s[0],l=s[1],h=Object(o.useState)((function(){return t(u)})),f=Object(oe.a)(h,2),d=f[0],m=f[1];return Object(o.useEffect)((function(){location.hash="sphere-".concat(d.frequency)}),[d]),Object(o.useEffect)((function(){m(t(u))}),[u]),o.createElement("div",{id:"view-container",style:{position:"absolute",left:0,right:0,height:"100%"}},o.createElement("div",{id:"bottom-middle"},o.createElement(he.a,null,Mn.map((function(e){return o.createElement(fe.a,{color:"info",key:"Frequency".concat(e),disabled:e===u,onClick:function(){return l(e)}},e)})))),o.createElement("div",{id:"bottom-right"},o.createElement(he.a,null,o.createElement(fe.a,{onClick:function(){return ye(d.fabricOutput)}},o.createElement(ue.n,null)),o.createElement(fe.a,{onClick:function(){return i(!a)}},o.createElement(ue.h,null)),o.createElement(fe.a,{onClick:function(){return F(E.Design)}},o.createElement(ue.G,null)))),o.createElement(le.a,{style:{backgroundColor:"black"}},o.createElement(_n,null),d?o.createElement(Ln,{sphere:d,polygons:a}):o.createElement("h1",null,"No Sphere")))}function Ln(e){var t=e.sphere,n=e.polygons,r=Object(o.useState)(0),a=Object(oe.a)(r,2),i=a[0],c=a[1];return Object(le.b)((function(){n||t.iterate(),c(i+1)})),o.createElement("group",null,o.createElement(se.a,{onPointerMissed:void 0}),o.createElement("scene",null,n?o.createElement(Dn,{sphere:t}):o.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:Ee,onUpdate:function(e){return e.geometry.computeBoundingSphere()}}),o.createElement(Ce,null),o.createElement("ambientLight",{color:new l.Color("white"),intensity:.8}),o.createElement("directionalLight",{color:new l.Color("#FFFFFF"),intensity:2})))}var In=new l.CylinderGeometry(1,1,1,12,1,!1);function Dn(e){var t=e.sphere;return o.createElement("group",null,t.pulls.map((function(e){var n=t.instance.unitVector(e.index),a=(new l.Quaternion).setFromUnitVectors(p,n),i=z(e.alpha,e.omega),c=new l.Vector3(.005,i,.005);return o.createElement("mesh",{key:"T".concat(e.index),geometry:In,position:e.location(),rotation:(new l.Euler).setFromQuaternion(a),scale:c,material:xe(r.PhiTriangle),matrixWorldNeedsUpdate:!0})})),"}",t.pushes.map((function(e){var n=t.instance.unitVector(e.index),a=(new l.Quaternion).setFromUnitVectors(p,n),i=z(e.alpha,e.omega),c=new l.Vector3(.012,i,.012);return o.createElement("mesh",{key:"C".concat(e.index),geometry:In,position:e.location(),rotation:(new l.Euler).setFromQuaternion(a),scale:c,material:xe(r.RootPush),matrixWorldNeedsUpdate:!0})})),"}")}function _n(e){var t=Object(o.useRef)(),n=Object(le.c)().setDefaultCamera;return Object(o.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(0,4,2.5),n(e)}),[]),Object(le.b)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),o.createElement("perspectiveCamera",Object.assign({ref:t},e))}function Nn(e){var t=e.push;return e.reverse?t.omega:t.alpha}function Bn(e){var t=e.push;return e.reverse?t.alphaHub:t.omegaHub}var Wn=function(){function e(t,n,r,a,i,c){Object(Le.a)(this,e),this.location=t,this.radius=n,this.frequency=r,this.twist=a,this.numericFeature=i,this.instance=c,this.joints=[],this.pushes=[],this.pulls=[],this.hubs=[],this.instance.clear()}return Object(Ie.a)(e,[{key:"hubAt",value:function(e){e.normalize().multiplyScalar(this.radius);var t={index:this.hubs.length,location:e,spokes:[]};return this.hubs.push(t),t}},{key:"pushBetween",value:function(e,t){var n=this,r=(new l.Vector3).addVectors(e.location,t.location).normalize(),a=(new l.Quaternion).setFromAxisAngle(r,this.twist),i=(new l.Vector3).copy(e.location).applyQuaternion(a),c=(new l.Vector3).copy(t.location).applyQuaternion(a),o=e.location.distanceTo(t.location),s=this.createJoint(i),u=this.createJoint(c),h={index:this.fabric.create_interval(s.index,u.index,!0,o,o,0),alpha:s,omega:u,alphaHub:e,omegaHub:t,location:function(){return(new l.Vector3).addVectors(n.instance.jointLocation(s.index),n.instance.jointLocation(u.index)).multiplyScalar(.5)}};return this.pushes.push(h),e.spokes.push({reverse:!1,push:h}),t.spokes.push({reverse:!0,push:h}),h}},{key:"pullsForSpoke",value:function(e,t,n){var r=this,a=[],i=function(e,t,n){if(!r.pullExists(e,t)){var i=z(e,t),c={index:r.fabric.create_interval(e.index,t.index,!1,i,n,100),alpha:e,omega:t,location:function(){return(new l.Vector3).addVectors(r.instance.jointLocation(e.index),r.instance.jointLocation(t.index)).multiplyScalar(.5)}};a.push(c),r.pulls.push(c)}},c=Nn(this.nextSpoke(e,t,!1)),o=this.nextSpoke(Bn(t),t,!1);return i(Nn(t),c,n),i(c,Nn(o),function(e){var t=e.push;return t.omegaHub.location.distanceTo(t.alphaHub.location)}(t)-2*n),a}},{key:"iterate",value:function(){if(!this.instance.iterate())switch(this.instance.stage){case d.Stage.Growing:new jn(this).build(),this.instance.stage=d.Stage.Shaping;break;case d.Stage.Shaping:this.fabric.age>8e3&&(this.instance.stage=d.Stage.Slack);break;case d.Stage.Slack:this.instance.stage=d.Stage.Pretensing;break;case d.Stage.Pretensing:}}},{key:"createJoint",value:function(e){var t={index:this.fabric.create_joint(e.x,e.y,e.z),instance:this.instance};return this.joints.push(t),this.instance.refreshFloatView(),t}},{key:"nextSpoke",value:function(e,t,n){var r=t.push,a=e.spokes.find((function(e){return e.push.index===r.index}));if(!a)throw new Error("Cannot find current spoke when looking for next");var i=Bn(a).location,c=T(i,e.location),o=(new l.Vector3).crossVectors(e.location,c).normalize();this.twist<0!==n&&o.multiplyScalar(-1);var s=e.spokes.filter((function(e){return e.push.index!==a.push.index}));if(e.spokes.length!==s.length+1)throw new Error("Did not delete");var u=s.filter((function(t){return T(Bn(t).location,e.location).dot(o)>0})).sort((function(e,t){var n=Bn(e).location.distanceToSquared(i);return Bn(t).location.distanceToSquared(i)-n})).pop();if(!u)throw new Error("Couldn't find closest!");return u}},{key:"pullExists",value:function(e,t){return!!this.pulls.find((function(n){return n.alpha.index===e.index&&n.omega.index===t.index||n.alpha.index===t.index&&n.omega.index===e.index}))}},{key:"fabric",get:function(){return this.instance.fabric}},{key:"fabricOutput",get:function(){var e=this;this.instance.refreshFloatView();var t=this.instance.floatView.idealLengths,n=this.instance.floatView.strains,a=this.instance.floatView.stiffnesses,i=this.instance.floatView.linearDensities;return{name:"sphere",joints:this.joints.map((function(e){var t=W(e);return{index:e.index,x:t.x,y:t.z,z:t.y}})),intervals:[].concat(Object(f.a)(this.pushes.map((function(c){var o=.012/e.frequency,s=.015*o/.012,u=z(c.alpha,c.omega)-2*s,l=c.alpha.index,h=c.omega.index;if(l>=e.joints.length||h>=e.joints.length)throw new Error("Joint not found ".concat(l,",").concat(h,":").concat(e.joints.length));return{index:c.index,joints:[l,h],type:"Push",strain:n[c.index],stiffness:a[c.index],linearDensity:i[c.index],role:w(r.Push),scale:1,idealLength:t[c.index],isPush:!0,length:u,radius:o,jointRadius:s}}))),Object(f.a)(this.pulls.map((function(c){var o=.005/e.frequency,s=z(c.alpha,c.omega)+.03,u=c.alpha.index,l=c.omega.index;if(u>=e.joints.length||l>=e.joints.length)throw new Error("Joint not found ".concat(u,",").concat(l,":").concat(e.joints.length));return{index:c.index,joints:[u,l],type:"Pull",strain:n[c.index],stiffness:a[c.index],linearDensity:i[c.index],role:w(r.Push),scale:1,idealLength:t[c.index],isPush:!1,length:s,radius:o,jointRadius:.015}}))))}}}]),e}(),zn=n(583),Gn=n(584),$n=n(597),Jn=n(585),Un=n(586),qn=n(587),Hn=n(578);function Qn(e){var t=e.tensegrity,n=(e.worldFeatures,e.storedState$),r=Object(o.useState)(n.getValue().viewMode),a=Object(oe.a)(r,2),i=a[0],c=a[1],s=Object(o.useState)(n.getValue().visibleRoles),u=Object(oe.a)(s,2),l=u[0],h=u[1];function d(){if(!t)throw new Error("No tensegrity");return t.getFabricOutput(.012,.005,.015)}Object(o.useEffect)((function(){var e=n.subscribe((function(e){c(e.viewMode),h(e.visibleRoles)}));return function(){return e.unsubscribe()}}),[]);var m=i!==Be.Frozen;return o.createElement(o.Fragment,null,o.createElement(wr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(ue.o,null)," Show/Hide"),o.createElement("div",null,"Roles"),o.createElement(he.a,{size:"sm",className:"w-100 my-2"},x.map((function(e){return o.createElement(fe.a,{key:"viz".concat(e),style:{backgroundColor:l.indexOf(e)>=0?ke(e):"#747474"},disabled:i!==Be.Frozen,onClick:function(){l.indexOf(e)<0?We(n,{visibleRoles:[].concat(Object(f.a)(l),[e])}):We(n,{visibleRoles:l.filter((function(t){return t!==e}))})}},w(e))}))),t?o.createElement(o.Fragment,null,o.createElement(Kn,{push:!0,disabled:m,storedState$:n,strainLimits:t.instance.floatView.strainLimits}),o.createElement(Kn,{push:!1,disabled:m,storedState$:n,strainLimits:t.instance.floatView.strainLimits})):void 0),t?o.createElement(wr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(ue.E,null)," Take"),o.createElement(he.a,{vertical:!1,className:"w-100 my-2"},o.createElement(fe.a,{onClick:function(){return be(d())},disabled:m},o.createElement(ue.n,null)," Download CSV ",o.createElement(ue.r,null)),o.createElement(fe.a,{onClick:function(){return ye(d())},disabled:m},o.createElement(ue.n,null)," Download JSON ",o.createElement(ue.q,null)))):void 0)}function Kn(e){var t=e.push,n=e.disabled,r=e.strainLimits,a=e.storedState$,i=[0,1e3],c=Object(o.useState)([1e3*(t?a.getValue().pushBottom:a.getValue().pullBottom),1e3*(t?a.getValue().pushTop:a.getValue().pullTop)]),s=Object(oe.a)(c,2),u=s[0],l=s[1],h=Object(o.useState)(0),f=Object(oe.a)(h,2),d=f[0],m=f[1],g=Object(o.useState)(0),p=Object(oe.a)(g,2),v=p[0],b=p[1];return Object(o.useEffect)((function(){function e(e){var n=t?r[1]:r[2];return n+e*((t?r[0]:r[3])-n)}if(t){var n=u[0]/1e3;m(e(n));var i=u[1]/1e3;b(e(i)),a.next(Object(Ne.a)(Object(Ne.a)({},a.getValue()),{},{pushBottom:n,pushTop:i}))}else{var c=u[0]/1e3;m(e(c));var o=u[1]/1e3;b(e(o)),a.next(Object(Ne.a)(Object(Ne.a)({},a.getValue()),{},{pullBottom:c,pullTop:o}))}}),[u]),o.createElement("div",{style:{height:"4em",width:"100%"},className:"my-2"},o.createElement("div",{className:"float-right",style:{color:n?"gray":"white"}},"".concat(C(d)," ").concat(C(v))),o.createElement("div",null,t?"Push":"Pull"," Strain"),o.createElement(Hn.c,{disabled:n,mode:1,step:1,domain:i,rootStyle:ar,onChange:function(e){return l(e)},values:u},o.createElement(Hn.b,null,(function(e){var t=e.getRailProps;return o.createElement("div",Object.assign({style:{position:"absolute",width:"100%",height:14,borderRadius:7,cursor:"pointer",backgroundColor:n?er:Zn}},t()))})),o.createElement(Hn.a,null,(function(e){var t=e.handles,n=e.getHandleProps;return o.createElement("div",{className:"slider-handles"},t.map((function(e,t){return o.createElement(Xn,{key:e.id,handle:e,domain:i,getHandleProps:n,top:1===t})})))})),o.createElement(Hn.d,{right:!1},(function(e){var t=e.tracks,r=e.getTrackProps;return o.createElement("div",{className:"slider-tracks"},t.map((function(e,t){var a=e.id,i=e.source,c=e.target;return o.createElement(Yn,{key:a,source:i,target:c,getTrackProps:r,color:nr(t,n)})})))}))))}function Xn(e){var t=e.domain,n=e.handle,r=e.getHandleProps,a=e.top,i=t[0],c=t[1],s=n.id,u=n.value,l=n.percent;return o.createElement("div",Object.assign({role:"slider","aria-valuemin":i,"aria-valuemax":c,"aria-valuenow":u,style:{left:"".concat(l,"%"),position:"absolute",marginLeft:"-11px",marginTop:"-6px",zIndex:2,width:24,height:24,cursor:"pointer",borderRadius:2,boxShadow:"1px 1px 1px 1px rgba(0, 0, 0, 0.2)",backgroundColor:tr(a)}},r(s)))}function Yn(e){var t=e.source,n=e.target,r=e.getTrackProps,a=e.color;return o.createElement("div",Object.assign({style:{position:"absolute",height:14,zIndex:1,backgroundColor:a,borderRadius:2,cursor:"pointer",left:"".concat(t.percent,"%"),width:"".concat(n.percent-t.percent,"%")}},r()))}var Zn="#9B9B9B",er="#767676";function tr(e){return e?"#c6161690":"#597fe790"}function nr(e,t){return t?er:0===e?Zn:"white"}var rr,ar={margin:"4%",position:"relative",width:"92%"};function ir(e){var t=e.feature,n=e.disabled,r=Object(o.useState)((function(){return t.percent})),a=Object(oe.a)(r,2),i=a[0],c=a[1];return Object(o.useEffect)((function(){var e=t.observable.subscribe((function(e){var t=e.percent;return c(t)}));return function(){return e.unsubscribe()}}),[]),o.createElement("div",{className:"my-2"},o.createElement("div",{className:"float-right",style:{color:n?"gray":"white"}},t.formatted),o.createElement("div",null,t.config.name),o.createElement(he.a,{className:"w-100"},t.percentChoices.map((function(e){var r=i===e?"#000000":"#919191";return o.createElement(fe.a,{disabled:n,size:"sm",style:{color:"white",backgroundColor:r},key:"".concat(t.config.name,":").concat(e),onClick:function(){return t.percent=e}},function(e){return e<=100?"".concat(e,"%"):"".concat(e/100,"x")}(e))}))))}function cr(e){var t=e.worldFeatures,n=e.tensegrity,r=(e.storedState$,Object(o.useState)(n.stage$.getValue())),a=Object(oe.a)(r,2),i=a[0],c=a[1];return Object(o.useEffect)((function(){var e=n.stage$.subscribe(c);return function(){return e.unsubscribe()}}),[n]),o.createElement("div",null,o.createElement(wr,null,o.createElement(ir,{feature:t[d.WorldFeature.IterationsPerFrame]}),o.createElement(ir,{feature:t[d.WorldFeature.IntervalCountdown]}),o.createElement(ir,{feature:t[d.WorldFeature.PushOverPull]})),i<d.Stage.Slack?o.createElement(wr,null,o.createElement(ir,{feature:t[d.WorldFeature.ShapingPretenstFactor]}),o.createElement(ir,{feature:t[d.WorldFeature.ShapingDrag]}),o.createElement(ir,{feature:t[d.WorldFeature.ShapingStiffnessFactor]}),o.createElement(he.a,{className:"w-100 my-3"},o.createElement(fe.a,{disabled:i!==d.Stage.Shaping,onClick:function(){return n.fabric.centralize()}},o.createElement(ue.l,null)," Centralize"))):i>d.Stage.Slack?o.createElement(wr,null,o.createElement(ir,{feature:t[d.WorldFeature.PretenstFactor]}),o.createElement(ir,{feature:t[d.WorldFeature.StiffnessFactor]}),o.createElement(ir,{feature:t[d.WorldFeature.Gravity]}),o.createElement(ir,{feature:t[d.WorldFeature.Drag]}),o.createElement(he.a,{className:"w-100 my-3"},o.createElement(fe.a,{disabled:i!==d.Stage.Pretenst,onClick:function(){return n.fabric.set_altitude(1)}},o.createElement(ue.u,null)," Nudge"),o.createElement(fe.a,{disabled:i!==d.Stage.Pretenst,onClick:function(){return n.fabric.set_altitude(10)}},o.createElement(ue.A,null)," Drop"))):void 0)}function or(e){var t=e.tensegrity,n=e.stageTransition,r=e.disabled,a=Object(o.useState)(t.stage),i=Object(oe.a)(a,2),c=i[0],s=i[1];function u(e){return!(!r&&c!==d.Stage.Pretensing)||c!==e}switch(Object(o.useEffect)((function(){var e=t.stage$.subscribe(s);return function(){return e.unsubscribe()}}),[t]),n){case rr.CaptureLengthsToSlack:return o.createElement(fe.a,{className:"my-1 w-100",disabled:u(d.Stage.Shaping),onClick:function(){return t.do((function(e){return e.stage=d.Stage.Slack}))}},"Capture Lengths ",o.createElement(ue.h,null),"( ",o.createElement(sr,{stage:d.Stage.Shaping})," )",o.createElement(ue.c,null),"( ",o.createElement(ue.f,null),o.createElement(sr,{stage:d.Stage.Slack})," ) New Slack");case rr.SlackToPretensing:return o.createElement(fe.a,{className:"my-1 w-100",disabled:u(d.Stage.Slack),onClick:function(){return t.do((function(e){return e.stage=d.Stage.Pretensing}))}},"Slack ",o.createElement(sr,{stage:d.Stage.Slack})," ",o.createElement(ue.c,null)," ",o.createElement(sr,{stage:d.Stage.Pretenst})," Pretenst");case rr.SlackToShaping:return o.createElement(he.a,{vertical:!0,className:"w-100 my-1"},o.createElement(fe.a,{className:"my-1 w-100",disabled:u(d.Stage.Slack),onClick:function(){return t.do((function(e){return e.stage=d.Stage.Shaping}))}},"Slack ",o.createElement(sr,{stage:d.Stage.Slack})," ",o.createElement(ue.c,null)," ",o.createElement(sr,{stage:d.Stage.Shaping})," Shaping"));case rr.CapturePretenstToSlack:return o.createElement(fe.a,{className:"my-1 w-100",disabled:u(d.Stage.Pretenst),onClick:function(){return t.do((function(e){return e.stage=d.Stage.Slack}))}},"Capture pretenst ",o.createElement(ue.h,null)," ( ",o.createElement(sr,{stage:d.Stage.Pretenst})," ) ",o.createElement(ue.c,null)," ( ",o.createElement(ue.f,null),o.createElement(sr,{stage:d.Stage.Slack})," ) New Slack");case rr.CaptureStrainForStiffness:return o.createElement(fe.a,{className:"my-1 w-100",disabled:u(d.Stage.Pretenst),onClick:function(){return t.do((function(e){e.stage=d.Stage.Slack,e.strainToStiffness()}))}},"Capture Strain ",o.createElement(ue.h,null)," ( ",o.createElement(sr,{stage:d.Stage.Pretenst})," ",o.createElement(ue.x,null)," ) ",o.createElement(ue.c,null),"( ",o.createElement(sr,{stage:d.Stage.Slack})," ",o.createElement(ue.j,null)," ) Slack Stiffness")}}function sr(e){switch(e.stage){case d.Stage.Growing:return o.createElement(ue.F,null);case d.Stage.Shaping:return o.createElement(ue.H,null);case d.Stage.Slack:return o.createElement(ue.L,null);case d.Stage.Pretensing:return o.createElement(ue.k,null);case d.Stage.Pretenst:return o.createElement(ue.v,null);default:throw new Error("Stage?")}}function ur(e){var t=e.worldFeatures,n=e.tensegrity,r=e.storedState$,a=Object(o.useState)(n.stage),i=Object(oe.a)(a,2),c=i[0],s=i[1];Object(o.useEffect)((function(){var e=n.stage$.subscribe(s);return function(){return e.unsubscribe()}}),[n]);var u=Object(o.useState)(r.getValue()),l=Object(oe.a)(u,2),h=l[0],f=l[1],m=Object(o.useState)(r.getValue().viewMode),g=Object(oe.a)(m,2),p=g[0],v=g[1];Object(o.useEffect)((function(){var e=[r.subscribe((function(e){v(e.viewMode),f(e)}))];return function(){return e.forEach((function(e){return e.unsubscribe()}))}}),[]);var b=p===Be.Frozen;return o.createElement("div",null,o.createElement(wr,null,o.createElement(or,{tensegrity:n,stageTransition:rr.CaptureLengthsToSlack,disabled:b}),o.createElement(or,{tensegrity:n,stageTransition:rr.SlackToShaping,disabled:b})),o.createElement(wr,null,o.createElement(ir,{key:"pc",feature:t[d.WorldFeature.PretensingCountdown],disabled:c!==d.Stage.Slack}),o.createElement("div",null,"Surface"),o.createElement(he.a,{size:"sm",className:"w-100 my-2"},Object.keys(d.SurfaceCharacter).map((function(e){return o.createElement(fe.a,{key:"SurfaceCharacter[".concat(e,"]"),disabled:c!==d.Stage.Slack,active:h.surfaceCharacter===d.SurfaceCharacter[e],onClick:function(){return We(r,{surfaceCharacter:d.SurfaceCharacter[e]})}},e)}))),o.createElement(or,{tensegrity:n,stageTransition:rr.SlackToPretensing,disabled:b})),o.createElement(wr,null,o.createElement(or,{tensegrity:n,stageTransition:rr.CapturePretenstToSlack,disabled:b}),o.createElement(or,{tensegrity:n,stageTransition:rr.CaptureStrainForStiffness,disabled:b})))}!function(e){e[e.CaptureLengthsToSlack=0]="CaptureLengthsToSlack",e[e.SlackToPretensing=1]="SlackToPretensing",e[e.SlackToShaping=2]="SlackToShaping",e[e.CapturePretenstToSlack=3]="CapturePretenstToSlack",e[e.CaptureStrainForStiffness=4]="CaptureStrainForStiffness"}(rr||(rr={}));var lr=n(594),hr=n(595),fr=n(596),dr=n(581),mr=n(582);function gr(e){e.worldFeatures;var t=e.rootTenscript,n=e.tensegrity,r=e.runTenscript,a=e.storedState$,i=Object(o.useState)(n&&!n.tenscript.fromUrl?n.tenscript:t),c=Object(oe.a)(i,2),s=c[0],u=c[1],l=Object(o.useState)(""),h=Object(oe.a)(l,2),f=h[0],d=h[1],m=Object(o.useState)(!1),g=Object(oe.a)(m,2),p=g[0],v=g[1];return o.createElement("div",{id:"tenscript-panel",style:{flexDirection:"column",position:"relative",backgroundColor:"rgba(0,0,0,1)",height:"100%"}},o.createElement(wr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(ue.F,null)," Tenscript"),o.createElement("div",{id:"code-and-run",style:{flexDirection:"column",height:"available"}},o.createElement(pr,{tenscript:s,setTenscript:u,error:f,setError:d}),o.createElement(he.a,{className:"w-100 my-2"},o.createElement(fe.a,{color:f.length>0?"warning":"success",disabled:f.length>0,onClick:function(){return r(s)}},0===f.length?o.createElement("span",null,"Grow ",o.createElement(ue.i,null)," tensegrity"):o.createElement("span",null,o.createElement(ue.g,null)," ",f)))),o.createElement(lr.a,{className:"w-100 my-2",isOpen:p,toggle:function(){return v(!p)}},o.createElement(hr.a,{color:"info",style:{borderRadius:"1.078em"}},"Explore ",o.createElement(ue.w,null)," existing designs"),o.createElement(fr.a,null,rt.map((function(e,t){return o.createElement(dr.a,{key:"Boot".concat(t),onClick:function(){return r(e)}},e.name)}))))),o.createElement(wr,null,o.createElement("h6",{className:"w-100 text-center"},"Special ",o.createElement(ue.D,null)," versions"),o.createElement(he.a,{vertical:!1,className:"w-100"},o.createElement(fe.a,{onClick:function(){return F(E.Sphere)}},o.createElement(ue.s,null)," Spheres"),o.createElement(fe.a,{onClick:function(){We(a,{demoCount:0,fullScreen:!0,rotating:!0}),r(rt[0])}},o.createElement(ue.B,null)," Demo"))))}function pr(e){var t=e.tenscript,n=e.setTenscript,r=e.error,a=e.setError,i=Object(o.useState)(""),c=Object(oe.a)(i,2),s=c[0],u=c[1];function l(e){u(e),function(e){var t=nt(a,!1,e);t&&(a(""),n(t))}(e)}return Object(o.useEffect)((function(){return u(t.code)}),[]),o.createElement("div",{className:"my-2 p-2 w-100",style:{backgroundColor:"#757575",color:"#ffffff",borderStyle:"solid",borderRadius:"1em",borderColor:0===r.length?"black":"#f0ad4e",borderWidth:"2px"}},o.createElement("h6",{className:"w-100 text-center"},o.createElement("i",null,'"',t.name,'"')),o.createElement(mr.a,{style:{borderRadius:"1em",height:"17em"},type:"textarea",id:"tenscript",value:s,onChange:function(e){return l(e.target.value)}}))}function vr(e){var t=e.tensegrity,n=e.selection,r=e.storedState$,a=Object(o.useState)(r.getValue().currentRole),i=Object(oe.a)(a,2),c=i[0],s=i[1];Object(o.useEffect)((function(){var e=r.subscribe((function(e){return s(e.currentRole)}));return function(){return e.unsubscribe()}}),[]);var u=function(e){return function(){n.intervals.forEach((function(n){t.changeIntervalScale(n,e?1.03:1/1.03)}))}};return o.createElement("div",null,o.createElement(wr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(ue.t,null)," Manual"),o.createElement(he.a,{size:"sm",className:"w-100 my-2"},o.createElement(fe.a,{disabled:0===n.intervals.length,onClick:u(!0)},o.createElement(ue.d,null)," Lengthen"),o.createElement(fe.a,{disabled:0===n.intervals.length,onClick:u(!1)},o.createElement(ue.a,null)," Shorten")),o.createElement(he.a,{size:"sm",className:"w-100 my-2"},o.createElement(fe.a,{onClick:function(){return t.do((function(e){return n.faces.filter((function(e){return e.faceSelection===I.Face})).forEach((function(t){return e.builder.createTipOn(t)}))}))}},o.createElement("span",null,"Tip")),o.createElement(fe.a,{onClick:function(){return t.do((function(e){var t=n.faces.filter((function(e){return e.faceSelection===I.Face}));return e.builder.createRadialPulls(t,He.Distance,ee(.75))}))}},o.createElement("span",null,"Distance-75")))),o.createElement(wr,null,o.createElement("h6",{className:"w-100 text-center"},o.createElement(ue.x,null)," Interval Groups"),o.createElement(he.a,{className:"my-2 w-100"},x.map((function(e,t){return o.createElement(fe.a,{size:"sm",key:"IntervalRole[".concat(t,"]"),onClick:function(){return We(r,{currentRole:e})},color:c===e?"success":"secondary"},w(e))}))),o.createElement(br,{tensegrity:t,intervalRole:c})))}function br(e){var t=e.tensegrity,n=e.intervalRole,r=e.disabled;var a=function(e,r){return function(){t.intervals.filter((function(e){return e.intervalRole===n})).forEach((function(n){return t.changeIntervalScale(n,function(){var t=r?1.01:1.05;return e?t:1/t}())}))}};return o.createElement("div",{className:"my-2"},o.createElement("div",{className:"float-right",style:{color:r?"gray":"white"}},"[",C(b(n)),"]"),o.createElement("div",null,w(n,!0)),o.createElement(he.a,{className:"w-100"},o.createElement(fe.a,{disabled:r,onClick:a(!0,!1)},o.createElement(ue.C,null),o.createElement(ue.C,null)),o.createElement(fe.a,{disabled:r,onClick:a(!0,!0)},o.createElement(ue.C,null)),o.createElement(fe.a,{disabled:r,onClick:a(!1,!0)},o.createElement(ue.y,null)),o.createElement(fe.a,{disabled:r,onClick:a(!1,!1)},o.createElement(ue.y,null),o.createElement(ue.y,null))))}function yr(e){var t=e.worldFeatures,n=e.rootTenscript,r=e.selection,a=e.tensegrity,i=e.runTenscript,c=e.toFullScreen,s=e.storedState$,u=Object(o.useState)(s.getValue().controlTab),l=Object(oe.a)(u,2),h=l[0],f=l[1];function d(e){var t=e.tab;return o.createElement(zn.a,null,o.createElement(Gn.a,{active:h===t,onClick:function(){return We(s,{controlTab:t})}},t))}function m(e){var c=e.tab,u=o.createElement($n.a,{color:"warning"},"No fabric");function l(){switch(c){case _e.Script:return o.createElement(gr,{worldFeatures:t,rootTenscript:n,tensegrity:a,runTenscript:i,storedState$:s});case _e.Phase:return a?o.createElement(ur,{worldFeatures:t,tensegrity:a,storedState$:s}):u;case _e.Shape:return a?o.createElement(vr,{tensegrity:a,selection:r,storedState$:s}):u;case _e.Live:return a?o.createElement(cr,{worldFeatures:t,tensegrity:a,storedState$:s}):u;case _e.Frozen:return a?o.createElement(Qn,{tensegrity:a,worldFeatures:t,storedState$:s}):u}}return o.createElement(Jn.a,{id:"tab-pane",style:{height:"100%"},tabId:c},o.createElement(l,null))}function g(){return o.createElement(fe.a,{style:{padding:0,margin:0,borderRadius:0,width:"1em"},className:"w-100 h-100",color:"dark",onClick:c},o.createElement(ue.b,null))}return Object(o.useEffect)((function(){var e=s.subscribe((function(e){return f(e.controlTab)}));return function(){return e.unsubscribe()}}),[]),o.createElement("div",{className:"h-100"},o.createElement(Un.a,{tabs:!0,style:{backgroundColor:"#b2b2b2"}},Object.keys(_e).map((function(e){return o.createElement(d,{key:"T".concat(e),tab:_e[e]})}))),o.createElement(qn.a,{style:{flex:1,flexFlow:"auto",height:"100%"},id:"tab-content",activeTab:h},Object.keys(_e).map((function(e){return o.createElement(m,{key:e,tab:_e[e]})}))),o.createElement("div",{style:{position:"absolute",top:0,height:"100%",left:"25em",zIndex:10,width:"1em"}},o.createElement(g,null)))}function wr(e){var t=e.children,n=e.height;return o.createElement("div",{className:"m-3 p-2",style:{height:n,borderRadius:"1em",borderStyle:"solid",borderWidth:"0.1em",borderColor:"#45782e"}},t)}var Er=n(590),Sr=n(591),kr=n(579),xr=n(588),jr=n(589);function Or(e){var t=e.interval,n=t.alpha,r=t.omega,a=t.intervalRole,i=U(t);return o.createElement(xr.a,{className:"interval-stats",style:{width:"10em"},position:G(t)},o.createElement("div",{style:{position:"absolute",top:"0",left:"0",color:"red"}},o.createElement(ue.z,null)),o.createElement(jr.a,{onClick:function(e){e.stopPropagation(),t.stats=void 0}},o.createElement("thead",null,o.createElement("tr",null,o.createElement("th",{colSpan:2},"(",n.index," ",o.createElement(ue.e,null)," ",r.index,"): ",w(a,!0)))),o.createElement("tbody",null,o.createElement("tr",null,o.createElement("td",{className:"text-right"},"Stiffness:"),o.createElement("td",null,i.stiffness.toFixed(8))),o.createElement("tr",null,o.createElement("td",{className:"text-right"},"Strain:"),o.createElement("td",null,i.strain.toFixed(8))),o.createElement("tr",null,o.createElement("td",{className:"text-right"},"Length:"),o.createElement("td",null,i.length.toFixed(8))),o.createElement("tr",null,o.createElement("td",{className:"text-right"},"Ideal Length:"),o.createElement("td",null,i.idealLength.toFixed(8))),o.createElement("tr",null,o.createElement("td",{className:"text-right"},"Linear Density:"),o.createElement("td",null,i.linearDensity.toFixed(8))))))}function Pr(e){var t=e.interval,n=e.pushOverPull,r=e.pretenst,a=Object(o.useState)(U(t)),i=Object(oe.a)(a,2),c=i[0],s=i[1];return Object(le.b)((function(){return s(J(t,n,r))})),o.createElement(xr.a,{className:"interval-stats",style:{fontFamily:"fixed",padding:"0.1em",width:"7em",textAlign:"center"},position:G(t)},o.createElement("div",{onClick:function(e){e.stopPropagation(),t.stats=void 0}},c.strain.toFixed(8)))}var Fr=new l.CylinderGeometry(1,1,1,12,1,!1),Cr=new l.Color("#ffffff");function Tr(e){var t=e.worldFeatures,n=e.tensegrity,r=e.selection,a=e.setSelection,i=e.storedState$,c=e.viewMode,s=t[d.WorldFeature.PushOverPull],u=t[d.WorldFeature.VisualStrain],h=Object(o.useState)(0),m=Object(oe.a)(h,2),g=m[0],p=m[1],v=Object(o.useState)(n.stage$.getValue()),b=Object(oe.a)(v,2),y=b[0],w=b[1],E=Object(o.useState)(n.instance),S=Object(oe.a)(E,2),k=S[0],x=S[1];Object(o.useEffect)((function(){p(y<d.Stage.Pretenst?t[d.WorldFeature.ShapingPretenstFactor].numeric:t[d.WorldFeature.PretenstFactor].numeric)}),[y]),Object(o.useEffect)((function(){var e=n.stage$.subscribe(w);return x(n.instance),function(){return e.unsubscribe()}}),[n]);var O=Object(o.useState)(i.getValue()),P=Object(oe.a)(O,2),F=P[0],C=P[1];function T(e){var t=e.reduce((function(e,t){var n=function(t){return e[t.index]=t};switch(t.faceSelection){case I.Pulls:t.pulls.forEach(n);break;case I.Pushes:t.pushes.forEach(n);break;case I.Both:t.pulls.forEach(n),t.pushes.forEach(n)}return e}),{}),n=e.reduce((function(e,t){return t.ends.forEach((function(t){return e[t.index]=t})),e}),{}),r=Object.keys(t).map((function(e){return t[e]})),i=Object.keys(n).map((function(e){return n[e]}));a({faces:e,intervals:r,joints:i})}Object(o.useEffect)((function(){var e=z.current;if(e){var t=i.subscribe((function(e){return C(e)}));return e.position.set(0,1,2*k.view.radius()),function(){return t.unsubscribe()}}}),[]);var V=Object(o.useState)(new l.Vector3(0,1,0)),R=Object(oe.a)(V,2),M=R[0],A=R[1],L=Object(o.useState)(0),D=Object(oe.a)(L,2),_=D[0],N=D[1];function B(e){e.stats?e.stats=void 0:J(e,s.numeric,g)}Object(le.b)((function(){var e=z.current;if(e){var t,a=k.view,o=r.faces.length>0?X(r.faces):r.joints.length>0?(t=r.joints).reduce((function(e,t){return e.add(W(t))}),new l.Vector3).multiplyScalar(1/t.length):new l.Vector3(a.midpoint_x(),a.midpoint_y(),a.midpoint_z());if(A((new l.Vector3).subVectors(o,M).multiplyScalar(.01).add(M)),F.demoCount>=0){var s=e.position;s.y+=.01*(o.y-s.y);var u=s.distanceTo(o)-2*a.radius(),h=(new l.Vector3).subVectors(o,s).normalize().multiplyScalar(.01*u);s.add(h)}if(c!==Be.Frozen){if(n.iterate())return;if(F.demoCount>=0)switch(y){case d.Stage.Shaping:50===_?(n.stage=d.Stage.Slack,N(0)):N(_+1);break;case d.Stage.Slack:10===_?(n.stage=d.Stage.Pretensing,We(i,{rotating:!1}),N(0)):N(_+1);break;case d.Stage.Pretenst:100===_?(We(i,{demoCount:F.demoCount+1,rotating:!0}),N(0)):N(_+1)}y===d.Stage.Pretensing&&(n.stage=d.Stage.Pretenst)}}}));var z=Object(o.useRef)();return o.createElement("group",null,o.createElement(Er.a,{ref:z,makeDefault:!0,onPointerMissed:void 0}),o.createElement(se.a,{target:M,autoRotate:F.rotating,enableKeys:!1,enablePan:!1,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.8*Math.PI,onPointerMissed:void 0}),o.createElement("scene",null,c===Be.Frozen?o.createElement("group",null,n.intervals.filter((function(e){return function(e,t){if(void 0===t.visibleRoles.find((function(t){return t===e.intervalRole})))return!1;var n=function(e){var t=e.alpha,n=e.index;return t.instance.floatView.strainNuances[n]}(e);return j(e.intervalRole)?n>=t.pushBottom&&n<=t.pushTop:n>=t.pullBottom&&n<=t.pullTop}(e,F)})).map((function(e){return o.createElement(Rr,{key:"I".concat(e.index),pushOverPull:s.numeric,visualStrain:u.numeric,pretenstFactor:g,tensegrity:n,interval:e,selected:!1,onPointerDown:function(t){t.stopPropagation(),B(e)}})})),"}"):o.createElement(o.Fragment,null,o.createElement("lineSegments",{geometry:n.instance.floatView.lineGeometry,material:Ee,onUpdate:function(e){return e.geometry.computeBoundingSphere()}})),c!==Be.Selecting?void 0:o.createElement(Mr,{tensegrity:n,stage:y,clickFace:function(e){return function(e){switch(e.faceSelection){case I.None:e.faceSelection=I.Face,T([].concat(Object(f.a)(r.faces),[e]));break;case I.Face:e.faceSelection=I.Pulls,T(r.faces);break;case I.Pulls:e.faceSelection=I.Pushes,T(r.faces);break;case I.Pushes:e.faceSelection=I.Both,T(r.faces);break;case I.Both:e.faceSelection=I.None,T(r.faces.filter((function(t){return t.index!==e.index})))}}(e)}}),r.intervals.map((function(e){return o.createElement(Rr,{key:"SI".concat(e.index),pushOverPull:s.numeric,visualStrain:u.numeric,pretenstFactor:g,tensegrity:n,interval:e,selected:!0,onPointerDown:function(t){t.stopPropagation(),B(e)}})})),c===Be.Frozen?n.intervalsWithStats.map((function(e){return o.createElement(Or,{key:"S".concat(e.index),interval:e})})):n.intervalsWithStats.map((function(e){return o.createElement(Pr,{key:"SL".concat(e.index),interval:e,pushOverPull:s.numeric,pretenst:g})})),r.faces.filter((function(e){return e.faceSelection===I.Face})).map((function(e){var t=new l.Geometry;return t.vertices=e.ends.map(W),t.faces.push(new l.Face3(0,1,2)),o.createElement("mesh",{key:"SJ".concat(e.index),geometry:t,material:Se})})),c===Be.Frozen?void 0:r.joints.map((function(e){var t="".concat(e.index);return o.createElement(Vr,{key:t,position:W(e),text:t})})),o.createElement(Ce,null),o.createElement(Sr.a,null),o.createElement("ambientLight",{color:Cr,intensity:.8}),o.createElement("directionalLight",{color:new l.Color("#FFFFFF"),intensity:2})))}function Vr(e){var t=e.position,n=e.text,r=Object(le.c)().camera,a=Object(o.useRef)();return Object(le.b)((function(){a.current&&a.current.quaternion.copy(r.quaternion)})),o.createElement(kr.a,{ref:a,fontSize:.1,position:t,anchorY:"middle",anchorX:"center",onPointerMissed:void 0},n)}function Rr(e){var t=e.pushOverPull,n=e.visualStrain,r=e.pretenstFactor,a=e.tensegrity,i=e.interval,c=e.selected,s=e.onPointerDown,u=c?Se:xe(i.intervalRole),h=a.instance.floatView.stiffnesses[i.index]*(j(i.intervalRole)?t:1),f=.01*Math.sqrt(h)*(c?1.5:1),d=a.instance.unitVector(i.index),m=(new l.Quaternion).setFromUnitVectors(p,d),g=a.instance.floatView.strains[i.index],v=1+(j(i.intervalRole)?r:0),b=a.instance.floatView.idealLengths[i.index]*v,y=b+g*b*(1-n),w=new l.Vector3(f,y<0?.01:y,f);return o.createElement("mesh",{geometry:Fr,position:G(i),rotation:(new l.Euler).setFromQuaternion(m),scale:w,material:u,matrixWorldNeedsUpdate:!0,onPointerDown:s})}function Mr(e){var t=e.tensegrity,n=e.stage,r=e.clickFace,a=Object(le.c)().raycaster,i=Object(o.useRef)(),c=Object(o.useState)(),s=Object(oe.a)(c,2),u=s[0],h=s[1];return o.createElement("mesh",{key:"faces",ref:i,onPointerDown:function(e){e.stopPropagation(),h(e)},onPointerUp:function(e){e.stopPropagation();var c=i.current;if(!function(e){return e===d.Stage.Growing||e===d.Stage.Slack}(n)&&u&&c){var o=u.clientX-e.clientX,s=u.clientY-e.clientY;if(!(o*o+s*s>36)){var l=a.intersectObjects([c],!0).map((function(e){return e.faceIndex})).map((function(e){if(void 0!==e)return t.faces[e]})).reverse().pop();h(void 0),l&&r(l)}}},geometry:t.instance.floatView.faceGeometry},o.createElement("meshPhongMaterial",{attach:"material",transparent:!0,side:l.FrontSide,depthTest:!1,opacity:.2,color:"white"}))}function Ar(e){if(P()!==E.Design)F(P());else{var t=function(){var e=location.hash.substring(1);try{return nt((function(e){return console.error("code from URL",e)}),!0,decodeURIComponent(e))}catch(t){console.error("Code error",t)}}();if(t)return t;if(e.demoCount>=0)return rt[e.demoCount%rt.length]}}function Lr(e){var t=e.createInstance,n=e.worldFeatures,r=e.storedState$,a=Object(o.useMemo)((function(){return t(!1)}),[]),i=Object(o.useState)(),c=Object(oe.a)(i,2),s=c[0],u=c[1],h=Object(o.useState)(ne),f=Object(oe.a)(h,2),m=f[0],g=f[1],p=Object(o.useState)((function(){var e=Ar(r.getValue());return e||(We(r,{demoCount:0,fullScreen:!0,rotating:!0}),rt[0])})),v=Object(oe.a)(p,2),b=v[0],y=v[1];Object(o.useEffect)((function(){location.hash.startsWith("#`")||(location.hash=b.code)}),[b]);var w=Object(o.useState)(r.getValue().rotating),E=Object(oe.a)(w,2),S=E[0],k=E[1],x=Object(o.useState)(r.getValue().fullScreen),j=Object(oe.a)(x,2),O=j[0],P=j[1],F=Object(o.useState)(r.getValue().demoCount),C=Object(oe.a)(F,2),T=C[0],V=C[1],R=Object(o.useState)(r.getValue().viewMode),M=Object(oe.a)(R,2),A=M[0],L=M[1];function I(e){if(a){location.hash=e.code,We(r,{viewMode:Be.Lines}),g(ne);u(new ht(new l.Vector3,Y(),!1,(function(e){return r.getValue().featureValues[e].numeric}),a,e))}}function D(e){We(r,{fullScreen:e})}return Object(o.useEffect)((function(){var e=r.subscribe((function(e){P(e.fullScreen),e.demoCount<0?V(e.demoCount):e.demoCount>T&&(T+1===rt.length?(y(rt[0]),setTimeout((function(){We(r,{demoCount:-1,fullScreen:!1,rotating:!1})}),200)):(V(e.demoCount),y(rt[e.demoCount]))),L(e.viewMode),k(e.rotating),a.world.set_surface_character(e.surfaceCharacter)}));return function(){return e.unsubscribe()}}),[s]),Object(o.useEffect)((function(){var e=Object.keys(n).map((function(e){return n[e]})).map((function(e){return e.observable.subscribe((function(){s&&s.instance.applyFeature(e)}))}));return function(){return e.forEach((function(e){return e.unsubscribe()}))}}),[s]),Object(o.useEffect)((function(){var e=setTimeout((function(){return I(b)}),200);return function(){return clearTimeout(e)}}),[b]),o.createElement(o.Fragment,null,O?T>=0?void 0:o.createElement(fe.a,{id:"to-full-screen",color:"dark",onClick:function(){return D(!1)}},o.createElement(ue.c,null),o.createElement("br",null),o.createElement(ue.K,null),o.createElement("br",null),o.createElement(ue.c,null)):o.createElement("div",{id:"left-side",style:{visibility:O?"collapse":"visible",width:"25em"}},o.createElement(yr,{worldFeatures:n,rootTenscript:b,tensegrity:s,selection:m,runTenscript:I,toFullScreen:function(){return D(!0)},storedState$:r})),o.createElement("div",{style:{position:"absolute",left:O?0:"26em",right:0,height:"100%"}},s?o.createElement("div",{className:"h-100"},o.createElement(Ir,{tensegrity:s}),T>=0?o.createElement("div",{id:"bottom-right"},o.createElement(he.a,null,o.createElement(fe.a,{color:"success",onClick:function(){We(r,{demoCount:-1,fullScreen:!1,rotating:!1})}},o.createElement(ue.G,null)," Exit demo"))):o.createElement("div",null,o.createElement("div",{id:"bottom-right"},o.createElement(he.a,null,o.createElement(fe.a,{color:S?"warning":"secondary",onClick:function(){return We(r,{rotating:!S})}},o.createElement(ue.J,null)))),o.createElement("div",{id:"bottom-middle"},o.createElement(ir,{feature:n[d.WorldFeature.VisualStrain]})),o.createElement("div",{id:"bottom-left"},o.createElement(he.a,null,o.createElement(Dr,{item:Be.Lines,storedState$:r,click:function(){return g(function(e){return{faces:[],intervals:[],joints:e.joints}}(m))}},o.createElement(ue.B,null)),o.createElement(Dr,{item:Be.Selecting,storedState$:r},o.createElement(ue.t,null)),o.createElement(Dr,{item:Be.Frozen,storedState$:r},o.createElement(ue.I,null))))),o.createElement("div",{id:"view-container",className:"h-100"},o.createElement(le.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:A===Be.Frozen?"#f0ad4e":"black",cursor:A===Be.Selecting?"pointer":"default",borderWidth:"2px"}},o.createElement(Tr,{worldFeatures:n,tensegrity:s,selection:m,setSelection:g,viewMode:A,storedState$:r})))):o.createElement("div",{id:"tensegrity-view",className:"h-100"},o.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},o.createElement(fe.a,{onClick:function(){return I(b)}},o.createElement("h6",null,b.name),o.createElement("h1",null,o.createElement(ue.B,null)))))))}function Ir(e){var t=e.tensegrity,n=Object(o.useState)(t.stage$.getValue()),r=Object(oe.a)(n,2),a=r[0],i=r[1];return Object(o.useEffect)((function(){var e=t.stage$.subscribe(i);return function(){return e.unsubscribe()}}),[t]),o.createElement("div",{id:"top-middle"},o.createElement("span",null,O(a))," ",o.createElement("i",null,'"',t.tenscript.name,'"'))}function Dr(e){var t=e.item,n=e.storedState$,r=e.children,a=e.click,i=n.getValue().viewMode;return o.createElement(fe.a,{disabled:t===i,color:t===i?"success":"secondary",onClick:function(){We(n,{viewMode:t}),a&&a()}},r)}n.d(t,"startReact",(function(){return Wr}));var _r=function(e){throw new Error("Unable to compile: ".concat(e))},Nr=function(e){var t=nt(_r,!1,e);if(!t)throw new Error("Unable to build body");return t};function Br(e){var t=document.getElementById("root");s.render(e,t)}function Wr(e,t,n){return zr.apply(this,arguments)}function zr(){return(zr=Object(c.a)(i.a.mark((function e(t,n,r){var a,c,s,h,f,d,m,g,p,v,b,w,S;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=function(e,a){return new De(t,200,e?r:n,a)},e.t0=P(),e.next=e.t0===E.Gotchi?4:e.t0===E.Bridge?10:e.t0===E.Sphere?19:24;break;case 4:return location.hash="gotchi",c=function(e,t,n,r){return y.forEach((function(n){return e.world.set_float_value(n,t(n))})),new ht(n,Y(),!1,t,e,Nr(r))},s=new fn({newGotchi:function(e,n,r){var a=At(e,n,r);return new Lt(a,0!==n.fabric.age?void 0:c(n,(function(e){return Dt(e,t.default_world_feature(e))}),e.center,Ct))},newSatoshiTree:function(e,n){return new En(e.name,c(n,(function(e){return _t(e,t.default_world_feature(e))}),e.center,Tt))}},"Pretenst Island",1001010),Br(o.createElement(vn,{island:s,homePatch:s.patches[0],createInstance:a})),e.abrupt("break",29);case 10:return location.hash="bridge",h=function(e){return ie(e,t.default_world_feature(e))},f=a(!0),y.forEach((function(e){return f.world.set_float_value(e,h(e))})),d=Nr(ae()),m=ee(3.5),g=new ht(new l.Vector3,m,!1,h,f,d),Br(o.createElement(Te,{tensegrity:g})),e.abrupt("break",29);case 19:return p=function(e){return Rn(e,t.default_world_feature(e))},v=new l.Vector3(0,3,0),b=function(e){var t=a(!1);return y.forEach((function(e){return t.world.set_float_value(e,p(e))})),new Wn(v,.7,e,.52,p,t)},Br(o.createElement(An,{createSphere:b})),e.abrupt("break",29);case 24:return(w=new u.BehaviorSubject($e(Je,t.default_world_feature))).subscribe((function(e){return Ge(e)})),S=qe(w,t.default_world_feature),Br(o.createElement(Lr,{createInstance:a,worldFeatures:S,storedState$:w})),e.abrupt("break",29);case 29:kn();case 30:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}}]);
//# sourceMappingURL=5.981010ae.chunk.js.map