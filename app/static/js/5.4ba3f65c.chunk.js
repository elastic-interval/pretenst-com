(window.webpackJsonppretenst=window.webpackJsonppretenst||[]).push([[5],{8:function(e,t,n){"use strict";n.r(t);var r,a=n(0),i=n.n(a),o=n(1),c=n(9),s=n(31),u=n(12),l=n(13),h=n(14),f=n(10),d=n(7),m=new f.Vector3(1,0,0),p=new f.Vector3(0,0,1),v=new f.Vector3(0,1,0),g=new f.Vector3(0,-1,0);!function(e){e[e.PushA=0]="PushA",e[e.PushB=1]="PushB",e[e.PullA=2]="PullA",e[e.PullB=3]="PullB",e[e.PullAA=4]="PullAA",e[e.PullBB=5]="PullBB",e[e.Conflict=6]="Conflict",e[e.Radial=7]="Radial",e[e.Connector=8]="Connector",e[e.Distancer=9]="Distancer"}(r||(r={}));Object.keys(r).filter((function(e){return isNaN(parseInt(e,10))})).map((function(e){return r[e]}));function b(e){switch(e){case r.PushA:return 2.44948974278;case r.PushB:return 2.8025170768881464;case r.PullA:return 1;case r.PullB:return 1.732050807568877;case r.PullAA:return.5*b(r.PullA);case r.PullBB:return.5*b(r.PullB);case r.Conflict:return.01;default:throw new Error("Length for Role ".concat(r[e],"?"))}}var y=Object.keys(d.WorldFeature);function w(e){switch(e){case r.PushA:return"[A]";case r.PushB:return"[B]";case r.PullA:return"(a)";case r.PullB:return"(b)";case r.PullAA:return"(aa)";case r.PullBB:return"(bb)";default:return"?"}}var E,S=Object.keys(r).filter((function(e){switch(r[e]){case r.PushA:case r.PushB:case r.PullA:case r.PullB:case r.PullAA:case r.PullBB:return!0;default:return!1}})).map((function(e){return r[e]}));function j(e){switch(e){case r.PushA:case r.PushB:return!0}return!1}function k(e){switch(e){case d.Stage.Growing:return"Growing";case d.Stage.Shaping:return"Shaping";case d.Stage.Slack:return"Slack";case d.Stage.Pretensing:return"Pretensing";default:return"Pretenst"}}!function(e){e.Design="design",e.Demo="demo",e.Sphere="sphere",e.Evolution="evolution",e.Halo="halo",e.Convergence="convergence",e.HeadlessHug="headlesshug",e.Triped="triped"}(E||(E={}));var O=Object.keys(E).map((function(e){return E[e]}));function x(){var e=location.hash.substring(1),t=O.find((function(t){return t===e}));return t||C(E.Demo)}function C(e){return location.hash=e,location.reload(),e}function A(e){var t=e.toExponential(3),n=t.indexOf("e+0");return n>0?t.substring(0,n):Math.max(t.indexOf("e-1"),t.indexOf("e-2"))>0?e.toFixed(3):Math.max(t.indexOf("e+1"),t.indexOf("e+2"),t.indexOf("e+3"))>0?e.toFixed(1):t}function P(e,t){return(new f.Vector3).subVectors(e,t).normalize()}function F(e){var t=new f.Vector3;return e.forEach((function(e){return t.add(e)})),t.multiplyScalar(1/e.length)}function V(e){for(var t=F(e),n=e.map((function(e){return(new f.Vector3).copy(e).sub(t)})),r=new f.Vector3,a=0;a<n.length;a++){var i=n[a],o=n[(a+1)%n.length];r.add((new f.Vector3).crossVectors(i,o).normalize())}return r.normalize()}function R(e,t,n){var r=3*t;return n?(n.set(e[r],e[r+1],e[r+2]),n):new f.Vector3(e[r],e[r+1],e[r+2])}var D=function(){function e(t,n,r,a){var i=this;Object(l.a)(this,e),this.fabric=void 0,this.world=void 0,this.view=void 0,this.floatView=function(){var e=new Float32Array(0);return{jointCount:0,intervalCount:0,faceCount:0,lineGeometry:new f.BufferGeometry,faceGeometry:new f.BufferGeometry,jointLocations:e,unitVectors:e,idealLengths:e,strains:e,strainLimits:new Float32Array(4),strainNuances:e,stiffnesses:e,linearDensities:e}}(),this.adoptFabric=void 0,this.midpoint=new f.Vector3(0,0,0),this.valuesToApply=[],this.fabricBackup=void 0,this.world=r,this.adoptFabric=function(e){return i.free(),i.fabric=e,i.view=t.View.on_fabric(e),i},this.adoptFabric(a||t.Fabric.new(n))}return Object(h.a)(e,[{key:"iterate",value:function(){var e=this.fabric.iterate(this.world);this.refreshFloatView();var t=this.valuesToApply.shift();return t&&this.world.set_float_value(t.feature,t.value),e}},{key:"stage",get:function(){return this.fabric.get_stage()},set:function(e){this.fabric.request_stage(e,this.world)||console.error("Could not move to stage ".concat(e,"!"))}},{key:"showFrozen",value:function(e){this.updateFloatView(!0,e)}},{key:"fabricClone",get:function(){return this.fabric.clone()}},{key:"snapshot",value:function(){console.log("snapshot"),this.fabricBackup=this.fabricClone}},{key:"restoreSnapshot",value:function(){console.log("restoreSnapshot");var e=this.fabricBackup;if(!e)throw new Error("Missing backup");this.adoptFabric(e.clone())}},{key:"refreshFloatView",value:function(){this.view.render(this.fabric,this.world),this.midpoint.set(this.view.midpoint_x(),this.view.midpoint_y(),this.view.midpoint_z()),this.updateFloatView(!1,!1)}},{key:"clear",value:function(){return this.fabric.clear(),this.refreshFloatView(),this}},{key:"applyFeature",value:function(e,t,n){this.valuesToApply.push({feature:e,percent:t,value:n})}},{key:"jointLocation",value:function(e){return R(this.floatView.jointLocations,e.index)}},{key:"averageJointLocation",value:function(e){var t=this;return e.reduce((function(e,n){return e.add(t.jointLocation(n))}),new f.Vector3).multiplyScalar(1/e.length)}},{key:"jointDistance",value:function(e,t){return this.jointLocation(e).distanceTo(this.jointLocation(t))}},{key:"intervalLocation",value:function(e){var t=e.alpha,n=e.omega;return this.jointLocation(t).add(this.jointLocation(n)).multiplyScalar(.5)}},{key:"intervalLength",value:function(e){var t=e.alpha,n=e.omega;return this.jointDistance(t,n)}},{key:"faceLocation",value:function(e){var t=this;return F(e.ends.map((function(e){return t.jointLocation(e)})))}},{key:"averageFaceLocation",value:function(e){var t=this;return e.reduce((function(e,n){return e.add(t.faceLocation(n))}),new f.Vector3).multiplyScalar(1/e.length)}},{key:"apply",value:function(e){this.fabric.apply_matrix4(new Float32Array(e.toArray())),this.refreshFloatView()}},{key:"unitVector",value:function(e){return R(this.floatView.unitVectors,e)}},{key:"free",value:function(){var e=this.fabric;e&&e.free();var t=this.view;t&&t.free()}},{key:"updateFloatView",value:function(e,t){var n=this.fabric,r=this.view,a=n.get_joint_count(),i=n.get_interval_count(),o=n.get_face_count(),c=this.floatView;if(c.jointCount!==a||c.intervalCount!==i||c.faceCount!==o){c.jointCount=a,c.intervalCount=i,c.faceCount=o,c.lineGeometry.dispose(),c.lineGeometry=new f.BufferGeometry;var s=new Float32Array(3*i*2);r.copy_line_locations_to(s),c.lineGeometry.setAttribute("position",new f.Float32BufferAttribute(s,3));var u=new Float32Array(3*i*2);if(e)if(t){u.fill(0);for(var l=1;l<u.length;l+=3)u[l]=1}else u.fill(1);else r.copy_line_colors_to(u);c.lineGeometry.setAttribute("color",new f.Float32BufferAttribute(u,3)),c.faceGeometry.dispose(),c.faceGeometry=new f.BufferGeometry;var h=new Float32Array(3*o*3);r.copy_face_vertex_locations_to(h),c.faceGeometry.setAttribute("position",new f.Float32BufferAttribute(h,3));var d=new Float32Array(3*o*3);r.copy_face_normals_to(d),c.faceGeometry.setAttribute("normal",new f.Float32BufferAttribute(d,3)),c.jointLocations=new Float32Array(3*a),c.unitVectors=new Float32Array(3*i),c.idealLengths=new Float32Array(i),c.strains=new Float32Array(i),c.strainNuances=new Float32Array(i),c.stiffnesses=new Float32Array(i),c.linearDensities=new Float32Array(i)}else{var m=this.floatView.lineGeometry.attributes,p=this.floatView.faceGeometry.attributes;if(m.position){var v=m.position;r.copy_line_locations_to(v.array),v.needsUpdate=!0;var g=m.color,b=g.array;if(e)if(t){b.fill(0);for(var y=1;y<b.length;y+=3)b[y]=1}else b.fill(1);else r.copy_line_colors_to(b);g.needsUpdate=!0;var w=p.position;r.copy_face_vertex_locations_to(w.array),w.needsUpdate=!0;var E=p.normal;r.copy_face_normals_to(E.array),E.needsUpdate=!0}}r.copy_joint_locations_to(c.jointLocations),r.copy_unit_vectors_to(c.unitVectors),r.copy_ideal_lengths_to(c.idealLengths),r.copy_strains_to(c.strains),r.copy_strain_limits_to(c.strainLimits),r.copy_strain_nuances_to(c.strainNuances),r.copy_stiffnesses_to(c.stiffnesses),r.copy_linear_densities_to(c.linearDensities)}}]),e}();var L=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function B(){if("serviceWorker"in navigator){if(new URL("/app",window.location.toString()).origin!==window.location.origin)return;window.addEventListener("load",(function(){var e="".concat("/app","/service-worker.js");L?(!function(e){fetch(e).then((function(t){404===t.status||-1===t.headers.get("content-type").indexOf("javascript")?navigator.serviceWorker.ready.then((function(e){e.unregister().then((function(){window.location.reload()}))})):T(e)})).catch((function(){console.log("No internet connection found. App is running in offline mode.")}))}(e),navigator.serviceWorker.ready.then((function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://goo.gl/SC7cgQ")}))):T(e)}))}}function T(e){navigator.serviceWorker.register(e).then((function(e){e.onupdatefound=function(){var t=e.installing;t&&(t.onstatechange=function(){"installed"===t.state&&(navigator.serviceWorker.controller?console.log("New content is available; please refresh."):console.log("Content is cached for offline use."))})}})).catch((function(e){console.error("Error during service worker registration:",e)}))}var M,_=n(28),N=n(11),z=n(132),I=n(20),G=n(17),W=n(79);!function(e){e.Left="Left",e.Right="Right",e.LeftRight="Left-Right",e.RightLeft="Right-Left"}(M||(M={}));var H;M.Left,M.Right,M.LeftRight,M.RightLeft;function J(e,t,n){if(t)switch(e){case M.Left:return n?M.RightLeft:M.Right;case M.Right:return n?M.LeftRight:M.Left;case M.LeftRight:return M.RightLeft;case M.RightLeft:return M.LeftRight}else switch(e){case M.Left:return n?M.LeftRight:e;case M.Right:return n?M.RightLeft:e;case M.LeftRight:case M.RightLeft:return e}throw new Error("Spin?")}!function(e){e[e.a=0]="a",e[e.B=1]="B",e[e.C=2]="C",e[e.D=3]="D",e[e.b=4]="b",e[e.c=5]="c",e[e.d=6]="d",e[e.A=7]="A"}(H||(H={}));var U=[H.a,H.B,H.C,H.D,H.b,H.c,H.d,H.A];function q(e){return"aBCDbcdA".indexOf(e)>=0}function $(e){var t="aBCDbcdA".indexOf(e);if(t<0)throw new Error("[".concat(e,"] is not a face name"));return U[t]}function Q(e){var t=e.push;if(!t)throw new Error("Expected push");return t}function X(e){var t=e.pulls;if(!t)throw new Error("no pulls");return t}function K(e,t){return n=e.index,r=t.index,n<r?"(".concat(n,",").concat(r,")"):"(".concat(r,",").concat(n,")");var n,r}function Z(e){return K(e.alpha,e.omega)}function Y(e){var t=v.dot(e);return(new f.Quaternion).setFromUnitVectors(t>0?v:g,e)}function ee(e,t){return e.alpha.index===t.alpha.index||e.omega.index===t.omega.index||e.alpha.index===t.omega.index||e.omega.index===t.alpha.index}function te(e){return function(t){return t.intervalRole===e}}function ne(e,t){return function(n){var r=n.alpha,a=n.omega;return r.index===e.index&&a.index===t.index||a.index===e.index&&r.index===t.index}}function re(e){if(!e.push)throw new Error("No push");var t=e.push;if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("Big problem")}function ae(e,t){if(t.alpha.index===e.index)return t.omega;if(t.omega.index===e.index)return t.alpha;throw new Error("No other joint")}function ie(e){return e||{_:100}}function oe(e){return e._/100}function ce(e){return{_:100*e}}var se,ue=function(){function e(t,n,r,a){Object(l.a)(this,e),this.forward=t,this.scale=n,this.subtrees=r,this.markNumbers=a,this.root=void 0}return Object(h.a)(e,[{key:"nonEmpty",get:function(){return void 0===this.forward&&0===this.subtreeCode.length&&0===this.markCode.length?void 0:this}},{key:"decremented",get:function(){if(this.forward&&this.forward.length>0){var t=this.forward.substring(0,1);return{afterNode:new e(this.forward.substring(1),this.scale,this.subtrees,this.markNumbers),action:t}}return{afterNode:this,action:""}}},{key:"subtree",value:function(e){return this.subtrees[e]}},{key:"faceMarks",value:function(e){return this.markNumbers[e]}},{key:"deleteMark",value:function(e){delete this.markNumbers[e]}},{key:"needsOmniTwist",get:function(){var e=this,t=U.filter((function(e){return e!==H.A&&e!==H.a}));return t.some((function(t){return e.subtrees[t]}))||t.some((function(t){return e.markNumbers[t]}))}},{key:"code",get:function(){var e=100!==this.scale._,t=this.subtreeCode,n=this.markCode;if(!this.root&&this.forward&&this.forward.length>0&&!e&&0===t.length&&0===n.length)return this.forward.toString();var r=[];return this.forward&&this.forward.length>0&&r.push(this.forward.toString()),e&&r.push("S".concat(this.scale._)),r.push.apply(r,Object(G.a)(t)),r.push.apply(r,Object(G.a)(n)),"(".concat(r.join(","),")")}},{key:"subtreeCode",get:function(){return Object.entries(this.subtrees).map((function(e){var t=Object(N.a)(e,2),n=t[0],r=t[1];return"".concat("aBCDbcdA"[n]).concat(r.code)}))}},{key:"markCode",get:function(){return Object.entries(this.markNumbers).map((function(e){var t=Object(N.a)(e,2),n=t[0];return t[1].map((function(e){return"M".concat("aBCDbcdA"[n]).concat(e._)}))})).flat()}}]),e}();function le(e,t){try{var n=de(e.code.join());return n?(n.root=!0,n):void t("Nothing to compile")}catch(r){return void t(r.message)}}function he(e,t,n,r){var a=void 0===r.forward,i=n.spin,o=n.markDefStrings;return{tree:r,twist:e.createTwist(i,ie(),[t]),markActions:fe(o),reorient:a}}function fe(e){var t={};return e&&Object.keys(e).forEach((function(n){var r=e[n];if(r.startsWith("subtree")){var a=de(r.substring("subtree".length));t[n]={action:se.Subtree,tree:a}}else if(r.startsWith("join"))t[n]={action:se.Join};else if(r.startsWith("distance-")){var i={_:parseInt(r.split("-")[1],10)};t[n]={action:se.Distance,scale:i}}})),t}function de(e){var t,n=be(e,!0).content,r=ie(),a={},i={};function o(e){var t=be(n.substring(e),!1),r=t.content,a=t.skip;return{codeTree:de(r),skip:a}}function c(e,t){var n=i[e],r={_:t};n?n.push(r):i[e]=[r]}for(var s=0;s<n.length;s++){var u=n.charAt(s);if(q(u)){var l=o(s+1),h=l.codeTree;if(!h)throw new Error("No subtree: ".concat(n.substring(s)));a[$(u)]=h,s+=l.skip}else if(ve(u)){var f=be(n,!1),d=ge(f.content);t="X".repeat(d),s+=f.skip}else if("X"===u||"O"===u){var m=be(n,!1);t=m.content,s+=m.skip}else switch(u){case"S":var p=be(n.substring(s+1),!0);r={_:ge(p.content)},s+=p.skip;break;case"M":var v=n.charAt(s+1),g=be(n.substring(s+2),!0);c($(v),ge(g.content)),s+=g.skip+1;break;case",":case" ":case"\n":break;default:throw new Error("Unexpected character: ".concat(u))}}return new ue(t,r,a,i).nonEmpty}function me(e,t,n,r,a,i){var o,c,s=e.twist,u=e.markActions,l=s.face(r),h=function(){switch(t){case"X":return J(l.spin,!0,a);case"O":return J(l.spin,!1,a);default:throw new Error("Action can only be X or O but it was [".concat(t,"]"))}}(),f=ce(oe(l.scale)*oe(i)),d=s.tensegrity.createTwistOn(l,h,f);return""===n.forward&&(o=d,c=n,U.forEach((function(e){var t,n=c.faceMarks(e);n&&(t=o.face(e).markNumbers).push.apply(t,Object(G.a)(n))}))),{tree:n,twist:d,markActions:u,reorient:!1}}function pe(e){var t=[];return e.forEach((function(e){var n=e.tree,r=e.markActions,a=e.reorient,i=e.twist;if(void 0!==n.forward&&n.forward.length>0){var o=n.decremented,c=o.afterNode,s=o.action,u=n.needsOmniTwist&&void 0!==c.forward&&0===c.forward.length;t.push(me(e,s,c,H.A,u,n.scale))}else{if(a)if(![H.A,H.a,H.B,H.b].some((function(e){return!n.subtree(e)}))){var l=i.tensegrity.joints.map((function(e){return i.tensegrity.instance.jointLocation(e)}));i.tensegrity.instance.apply(function(e,t){var n=P(e[0],e[1]),r=P(e[3],e[2]),a=P(e[5],e[4]),i=e.reduce((function(e,t){return e.add(t)}),new f.Vector3).multiplyScalar(1/e.length),o=(new f.Matrix4).makeBasis(n,r,a).setPosition(i),c=(new f.Matrix4).makeRotationZ(-.24*Math.PI),s=(new f.Matrix4).makeRotationY(-Math.PI/2-t*Math.PI/3);return o.multiply(c).multiply(s).invert()}(l,0))}U.forEach((function(a){var i=n.subtree(a);if(i){var o=i.decremented,c=o.afterNode,s=o.action,u=i.needsOmniTwist&&""===i.forward;t.push(me(e,s,c,a,u,i.scale))}else{var l=n.faceMarks(a);l&&l.forEach((function(i){var o=r[i._];if(o&&o.action===se.Subtree){var c=o.tree;if(!c)throw new Error("Missing subtree");n.deleteMark(a);var s=c.needsOmniTwist;t.push(me(e,"",c,a,s,ie(c.scale)))}}))}}))}})),t}function ve(e){return"0123456789".indexOf(e)>=0}function ge(e){if(!e.match(/^\d*$/))throw new Error("Not a number: ".concat(e));return 0===e.length?0:parseInt(e,10)}function be(e,t){var n=e.indexOf(","),r=n>=0;if("("!==e.charAt(0))return r?{content:e.substring(0,n),skip:n}:{content:e,skip:e.length};var a=function(e){if("("!==e.charAt(0))throw new Error('Code must start with "(": '.concat(e," ").concat(e.charAt(0)));for(var t=0,n=0;n<e.length;n++){var r=e.charAt(n);if("("===r)t++;else if(")"===r&&0===--t)return n}throw new Error("No matching end bracket: |".concat(e,"|"))}(e),i=t?e.substring(1,a):e.substring(0,a+1);return{content:i.length>0?i:"0",skip:a+1}}!function(e){e[e.Subtree=0]="Subtree",e[e.Join=1]="Join",e[e.Distance=2]="Distance",e[e.None=3]="None"}(se||(se={}));var ye=n(131);function we(e){var t=[],n=te(r.PullA),a=te(r.PullB),i=function(e,t){return function(e,t){return e.find((function(e){return t.find((function(t){return e.index===t.index}))}))}(X(e).filter(n).map((function(t){return ae(e,t)})),X(t).filter(n).map((function(e){return ae(t,e)})))},o=e.instance;return e.withPulls((function(c){var s=function(e){var n=Z(e);c[n]||(t.push(e),c[n]=e)},u=function(e){var t=function(e){var t=X(e).filter(a)[0],n=ae(e,t),o=re(e),c=ae(o,X(o).filter(a)[0]),s=i(e,c),u=i(n,o);if(s&&u){if(s.push&&!u.push){var l=re(n);if(!X(l).some(ne(s,l)))return}else if(u.push&&!s.push){var h=re(e);if(!X(h).some(ne(u,h)))return}return{alpha:s.push?s:e,omega:u.push?u:n,scale:t.scale,intervalRole:s.push&&u.push?r.PullBB:r.PullB}}}(e);t&&s(t)};e.intervals.filter(te(r.PullB)).forEach((function(e){var t=e.alpha,n=e.omega;u(t),u(n)})),e.joints.filter((function(e){return e.push&&3===X(e).filter(n).length})).forEach((function(e){var t=X(e).filter(n).find((function(t){return!ae(e,t).push}));if(!t)throw new Error("no-push not found");var a=ae(e,t),i=X(e).filter(n).map((function(t){return ae(e,t)})).map((function(t){return{end:t,outwards:(new f.Vector3).subVectors(o.jointLocation(t),o.jointLocation(e)).normalize()}})),c=X(a).filter(n).map((function(e){return ae(a,e)})).map((function(t){return{end:t,outwards:(new f.Vector3).subVectors(o.jointLocation(t),o.jointLocation(e)).normalize()}}));i.map((function(e){var n=c.sort((function(t,n){return e.outwards.dot(n.outwards)-e.outwards.dot(t.outwards)}))[0],a=r.PullAA,i=t.scale,o={alpha:e.end,omega:n.end,scale:i,intervalRole:a};s(o)}))}))})),t}function Ee(e,t){var n=function(e){return{age:t,todo:e}};switch(e){case"orient":return n((function(e){var t=e.faces.filter((function(e){return e.markNumbers.find((function(e){return 0===e._}))}));if(0===t.length)throw new Error("No faces marked zero");var n=e.instance,r=t.reduce((function(e,t){var r=t.ends;return e.add(F(r.map((function(e){return n.jointLocation(e)}))))}),new f.Vector3).multiplyScalar(1/t.length),a=function(e){var t=e.x,n=e.y,r=e.z,a=t*t+n*n,i=n*n+r*r,o=r*r+t*t,c=new f.Vector3;return a>i&&a>o?c.set(-n,t,0).normalize():i>a&&i>o?c.set(0,-r,n).normalize():c.set(-r,0,t).normalize(),{b1:c,up:e,b2:(new f.Vector3).crossVectors(e,c).normalize()}}(t.reduce((function(e,t){var r=t.ends;return e.sub(V(r.map((function(e){return n.jointLocation(e)}))))}),new f.Vector3).normalize()),i=a.b1,o=a.up,c=a.b2;e.instance.apply((new f.Matrix4).makeBasis(i,o,c).setPosition(r).invert()),e.fabric.set_altitude(5)}));case"conflict":return n((function(e){(function(e){var t=[],n=e.instance,r=function(e,t){var r=n.jointLocation(e).sub(n.jointLocation(t.alpha)).normalize(),a=n.jointLocation(e).sub(n.jointLocation(t.omega)).normalize();return r.dot(a)<0};return e.joints.forEach((function(a,i){var o=a.push;o&&e.joints.forEach((function(e,c){if(!(c<=i)){var s=e.push;if(s){var u=ae(a,o),l=ae(e,s);if(6*n.jointDistance(a,e)>n.jointDistance(u,l))return;r(a,s)&&r(e,o)&&t.push({jointA:a,jointB:e})}}}))})),t})(e).forEach((function(t){var n=t.jointA,a=t.jointB;e.createInterval(n,a,r.Conflict,ie())}))}));case"pretensing":return n((function(e){e.stage=d.Stage.Slack,e.stage=d.Stage.Pretensing}));case"age":return n((function(e){console.log("age exceeds ".concat(e.name," @ ").concat(t),e.fabric.age)}));default:throw new Error("No job named ".concat(e))}}function Se(e){return function(t){return ee(e,t)}}var je,ke,Oe=function(){function e(t,n,r,a){Object(l.a)(this,e),this.tensegrity=t,this.spin=n,this.scale=r,this.faces=[],this.pushes=[],this.pulls=[];var i=a?3===a.length?a:Ce(a[0],3):Ce(new f.Vector3,3);switch(this.spin){case M.Left:this.createSingle(i,!0);break;case M.Right:this.createSingle(i,!1);break;case M.LeftRight:this.createDouble(i,!0);break;case M.RightLeft:this.createDouble(i,!1);break;default:throw new Error("Spin?")}}return Object(h.a)(e,[{key:"face",value:function(e){switch(this.faces.length){case 2:switch(e){case H.a:return this.faces[0];case H.A:return this.faces[1]}break;case 8:switch(e){case H.a:return this.faces[0];case H.B:return this.faces[2];case H.C:return this.faces[1];case H.D:return this.faces[3];case H.b:return this.faces[4];case H.c:return this.faces[5];case H.d:return this.faces[6];case H.A:return this.faces[7]}}throw new Error("Face ".concat(H[e]," not found in twist with ").concat(this.faces.length," faces"))}},{key:"createSingle",value:function(e,t){var n=this,a=xe(e,this.scale,t),i=a.map((function(e){var t=e.alpha,r=e.omega;return{alpha:n.tensegrity.createJoint(t),omega:n.tensegrity.createJoint(r)}})),o=this.tensegrity.createJoint(F(a.map((function(e){return e.alpha})))),c=this.tensegrity.createJoint(F(a.map((function(e){return e.omega}))));this.tensegrity.instance.refreshFloatView(),i.forEach((function(e){var t=e.alpha,a=e.omega,i=n.tensegrity.createInterval(t,a,r.PushA,n.scale);n.pushes.push(i),t.push=a.push=i}));var s=function(e,t){var a,i=e.map((function(e){return n.tensegrity.createInterval(e,t,r.PullA,n.scale)}));(a=n.pulls).push.apply(a,Object(G.a)(i)),n.faces.push(n.tensegrity.createFace(n,e,i,n.spin,n.scale,t))};s(i.map((function(e){return e.alpha})),o),s(i.map((function(e){return e.omega})).reverse(),c),i.forEach((function(e,a){var o=e.alpha,c=i[(i.length+a+(t?-1:1))%i.length].omega;n.pulls.push(n.tensegrity.createInterval(o,c,r.PullB,n.scale))}))}},{key:"createDouble",value:function(e,t){var n=this,a=xe(e,this.scale,t),i=xe(a.map((function(e){return e.omega})),this.scale,!t),o=a.map((function(e){var t=e.alpha,r=e.omega;return{alpha:n.tensegrity.createJoint(t),omega:n.tensegrity.createJoint(r)}})),c=i.map((function(e){var t=e.alpha,r=e.omega;return{alpha:n.tensegrity.createJoint(t),omega:n.tensegrity.createJoint(r)}}));this.tensegrity.instance.refreshFloatView(),[].concat(Object(G.a)(o),Object(G.a)(c)).forEach((function(e){var t=e.alpha,a=e.omega,i=n.tensegrity.createInterval(t,a,r.PushB,n.scale);n.pushes.push(i),t.push=a.push=i}));var s=t?[[o[0].alpha,o[1].alpha,o[2].alpha],[o[2].alpha,o[1].omega,c[1].alpha],[o[0].alpha,o[2].omega,c[2].alpha],[o[1].alpha,o[0].omega,c[0].alpha],[c[1].omega,c[0].alpha,o[1].omega].reverse(),[c[0].omega,c[2].alpha,o[0].omega].reverse(),[c[2].omega,c[1].alpha,o[2].omega].reverse(),[c[0].omega,c[1].omega,c[2].omega].reverse()]:[[o[0].alpha,o[1].alpha,o[2].alpha],[o[2].alpha,o[0].omega,c[2].alpha].reverse(),[o[0].alpha,o[1].omega,c[0].alpha].reverse(),[o[1].alpha,o[2].omega,c[1].alpha].reverse(),[c[1].omega,c[2].alpha,o[2].omega],[c[2].omega,c[0].alpha,o[0].omega],[c[0].omega,c[1].alpha,o[1].omega],[c[0].omega,c[1].omega,c[2].omega].reverse()],u=function(e){return n.tensegrity.instance.jointLocation(e)},l=s.map((function(e){return n.tensegrity.createJoint(F(e.map(u)))}));this.tensegrity.instance.refreshFloatView(),s.forEach((function(e,a){var i,o=l[a],c=e.map((function(e){return n.tensegrity.createInterval(e,o,r.PullA,n.scale)}));(i=n.pulls).push.apply(i,Object(G.a)(c));var s=t===[0,4,5,6].some((function(e){return e===a}))?M.Left:M.Right;n.faces.push(n.tensegrity.createFace(n,e,c,s,n.scale,o))}))}}]),e}();function xe(e,t,n){for(var r=[],a=F(e),i=function(){return(new f.Vector3).copy(a)},o=oe(t),c=V(e).multiplyScalar(-o),s=function(t){var s=function(n){return P(e[(t+e.length+n)%e.length],a)},u=function(e,t){return n=s(e),r=s(t),(new f.Vector3).addVectors(n,r).normalize();var n,r},l=i().addScaledVector(u(0,1),o),h=i().add(c).addScaledVector(n?u(1,2):u(-1,0),o);r.push({alpha:l,omega:h})},u=0;u<e.length;u++)s(u);return r}function Ce(e,t){for(var n=[],r=0;r<t;r++){var a=r*Math.PI*2/t,i=Math.cos(a),o=Math.sin(a);n.push(new f.Vector3(i,0,o).add(e))}return n}!function(e){e[e.NoOp=0]="NoOp",e[e.Faces=1]="Faces",e[e.Snelson=2]="Snelson",e[e.Bowtie=3]="Bowtie",e[e.BowtieFaces=4]="BowtieFaces"}(je||(je={})),function(e){e[e.Bowtie=0]="Bowtie",e[e.Snelson=1]="Snelson"}(ke||(ke={}));var Ae=-1,Pe=function(){function e(t,n,r,a,i){var o=this;Object(l.a)(this,e),this.location=t,this.instance=n,this.countdown=r,this.tenscript=a,this.name=void 0,this.stage$=void 0,this.joints=[],this.intervals=[],this.loops=[],this.faces=[],this.connectors=[],this.distancers=[],this.pretenstAge=-1,this.jobs=[],this.buds=void 0,this.markDefStrings={},this.instance.clear(),this.stage$=new ye.a(this.fabric.get_stage()),this.markDefStrings=a.markDefStrings?a.markDefStrings:{},a.jobs&&a.jobs.forEach((function(e){var t=e.todo,n=e.age;o.toDo=Ee(t,n)})),this.name=a.name,this.toDo=function(e){var t=Ae,n=function(e){return{age:t,todo:e}};switch(e){case je.Faces:return n((function(e){e.triangleFaces()}));case je.Snelson:return n((function(e){e.createPulls(ke.Snelson),e.triangleFaces()}));case je.Bowtie:return n((function(e){e.createPulls(ke.Bowtie)}));case je.BowtieFaces:return n((function(e){e.createPulls(ke.Bowtie),e.triangleFaces()}));default:return n((function(){}))}}(a.postGrowthOp),this.buds=[he(this,t,a,i)],this.instance.world.set_surface_character(this.tenscript.surfaceCharacter)}return Object(h.a)(e,[{key:"fabric",get:function(){return this.instance.fabric}},{key:"createJoint",value:function(e){var t={index:this.fabric.create_joint(e.x,e.y,e.z)};return this.joints.push(t),t}},{key:"removeJoint",value:function(e){var t=e.index;this.fabric.remove_joint(t),this.joints=this.joints.filter((function(e){return e.index!==t})),e.index=-t,this.joints.forEach((function(e){return e.index=e.index>t?e.index-1:e.index})),this.instance.refreshFloatView()}},{key:"createRadialPull",value:function(e,t,n){var a=this,i=this.instance,o=this.createJoint(i.faceLocation(e)),c=this.createJoint(i.faceLocation(t));i.refreshFloatView();var s=this.creatAxis(o,c,n),u=e.ends.reduce((function(e,t){return e+i.jointDistance(o,t)}),0)/e.ends.length,l=t.ends.reduce((function(e,t){return e+i.jointDistance(c,t)}),0)/t.ends.length,h=e.ends.map((function(e){return a.createRay(o,e,u)})),f=t.ends.map((function(e){return a.createRay(c,e,l)})),d={alpha:e,omega:t,axis:s,alphaRays:h,omegaRays:f};switch(s.intervalRole){case r.Connector:this.connectors.push(d);break;case r.Distancer:this.distancers.push(d)}return d}},{key:"createInterval",value:function(e,t,n,a,i){var o=j(n),c=b(n)*oe(a),s=function(e){switch(e){case r.PushA:case r.PushB:case r.PullA:case r.PullB:case r.Conflict:return 1;case r.PullAA:case r.PullBB:return.4;default:throw new Error("Stiffness for Role ".concat(r[e],"?"))}}(n),u=0===c?0:this.instance.jointDistance(e,t),l=void 0===i?1:i,h=this.countdown*Math.abs(c-u)*l,f=h<=0?0:1/h,d={index:this.fabric.create_interval(e.index,t.index,o,u,c,s,f),intervalRole:n,scale:a,alpha:e,omega:t,removed:!1};return this.intervals.push(d),d}},{key:"changeIntervalScale",value:function(e,t){e.scale=ce(oe(e.scale)*t),this.fabric.multiply_rest_length(e.index,t,100)}},{key:"removeInterval",value:function(e){var t=e.index;this.intervals=this.intervals.filter((function(e){return e.index!==t})),this.fabric.remove_interval(t),this.intervals.forEach((function(e){e.index>t&&e.index--})),e.removed=!0}},{key:"createFace",value:function(e,t,n,r,a,i){var o=t[0],c=t[2],s=t[1],u={twist:e,index:this.fabric.create_face(o.index,s.index,c.index),spin:r,scale:a,ends:t,pushes:[Q(o),Q(c),Q(s)],pulls:n,markNumbers:[],joint:i};return this.faces.push(u),u}},{key:"removeFace",value:function(e){var t=this;e.pulls.forEach((function(e){return t.removeInterval(e)})),e.pulls=[],e.joint&&this.removeJoint(e.joint),this.fabric.remove_face(e.index),this.faces=this.faces.filter((function(t){return t.index!==e.index})),this.faces.forEach((function(t){t.index>e.index&&t.index--})),e.index=-1}},{key:"faceToTriangle",value:function(e){var t=this;e.pulls.forEach((function(e){return t.removeInterval(e)})),e.pulls=[],e.joint&&this.removeJoint(e.joint);for(var n=0;n<e.ends.length;n++){var a=e.ends[n],i=e.ends[(n+1)%e.ends.length];e.pulls.push(this.createInterval(a,i,r.PullB,e.scale))}}},{key:"triangleFaces",value:function(){var e=this;this.faces.forEach((function(t){return e.faceToTriangle(t)}))}},{key:"withPulls",value:function(e){var t=function(e,t){e.pulls?e.pulls.push(t):e.pulls=[t]};this.intervals.filter((function(e){return!j(e.intervalRole)})).forEach((function(e){t(e.alpha,e),t(e.omega,e)}));var n={};this.intervals.forEach((function(e){return n[(r=e,K(r.alpha,r.omega))]={alpha:(t=e).alpha,omega:t.omega,scale:t.scale,intervalRole:t.intervalRole};var t,r})),e(n),this.joints.forEach((function(e){return e.pulls=void 0}))}},{key:"createPulls",value:function(e){var t=this;(function(){switch(e){case ke.Bowtie:return we(t);case ke.Snelson:return function(e){var t=[],n=function(e,t){var n=re(e),a=ae(e,t);if(n.push&&a.push){var i=X(n).filter(te(r.PullA)).map((function(e){return ae(n,e)})),o=X(a).filter(te(r.PullA)).map((function(e){return ae(a,e)})),c=i.find((function(e){return!!o.find((function(t){return e.index===t.index}))}));if(c&&c.push)return{alpha:e,omega:c,intervalRole:r.PullB,scale:t.scale}}};return e.withPulls((function(a){e.intervals.filter(te(r.PullB)).forEach((function(e){var r=n(e.alpha,e);r&&(a[Z(r)]||t.push(r));var i=n(e.omega,e);i&&(a[Z(i)]||t.push(i))}))})),t}(t);default:throw new Error}})().forEach((function(e){var n=e.alpha,r=e.omega,a=e.intervalRole,i=e.scale;t.createInterval(n,r,a,i,5)}))}},{key:"removeSlackPulls",value:function(){var e=this;this.intervals.filter((function(e){return e.intervalRole===r.PullAA})).filter((function(t){return 0===e.instance.floatView.strains[t.index]})).forEach((function(t){return e.removeInterval(t)}))}},{key:"createTwist",value:function(e,t,n){return new Oe(this,e,t,n)}},{key:"createTwistOn",value:function(e,t,n){var r=this,a=this.createTwist(t,n,e.ends.map((function(e){return r.instance.jointLocation(e)})).reverse());return this.createLoop(e,a.face(H.a)),a}},{key:"stage",get:function(){return this.stage$.getValue()},set:function(e){var t=this;this.instance.stage=e,e===d.Stage.Slack&&(this.distancers.forEach((function(e){var n=e.axis,r=e.alphaRays,a=e.omegaRays;[n].concat(Object(G.a)(r),Object(G.a)(a)).forEach((function(e){return t.removeInterval(e)}))})),this.distancers=[],this.instance.snapshot()),this.stage$.next(e)}},{key:"toDo",set:function(e){this.jobs.push(e)}},{key:"iterate",value:function(){var e=this,t=this.instance.iterate();if(t)return t;var n=this.jobs.length;if(n){var r=this.instance.fabric.age;if(this.jobs=this.jobs.filter((function(t){var n=t.todo,a=t.age;return void 0!==a&&(a<0||a>r)||(n(e),!1)})),this.jobs.length<n)return!0}if(this.stage===d.Stage.Growing){if(this.buds.length>0)return this.buds=pe(this.buds),0===this.buds.length&&function(e,t,n){var r=fe(n),a={};return t.forEach((function(e){e.markNumbers.forEach((function(t){var n=a[t._];n?n.push(e):a[t._]=[e]}))})),Object.entries(a).map((function(t){var n=Object(N.a)(t,1)[0],i=r[n]||r[-1],o=i||se.None;return new Ve(e,a[n],o)}))}(this,this.faces,this.markDefStrings).forEach((function(e){return e.execute()})),!1;if(this.connectors.length>0)return this.connectors=this.checkConnectors(),!1;this.stage=d.Stage.Shaping,this.jobs=this.jobs.filter((function(t){var n=t.todo;return t.age!==Ae||(n(e),!1)}))}else this.stage===d.Stage.Pretenst&&this.pretenstAge<0&&(this.pretenstAge=this.fabric.age);return!1}},{key:"strainToStiffness",value:function(){var e=this.instance,t=e.floatView,n=this.intervals.filter((function(t){return!j(t.intervalRole)&&(e.jointLocation(t.alpha).y>=0||e.jointLocation(t.omega).y>=0)})),r=t.strains,a=n.reduce((function(e,t){return e+r[t.index]}),0)/n.length,i=new Float32Array(t.stiffnesses);n.forEach((function(e){var t=(r[e.index]-a)/a;i[e.index]*=1+t})),e.restoreSnapshot(),this.fabric.copy_stiffnesses(i)}},{key:"findInterval",value:function(e,t){return this.intervals.find(ne(e,t))}},{key:"createRadialPulls",value:function(e,t,n){var r=this,a=function(e){return r.instance.faceLocation(e)},i=function(){var t=r.createTwist(M.LeftRight,ce(function(e){return e.reduce((function(e,t){return e+oe(t.scale)}),0)/e.length}(e)),[r.instance.averageFaceLocation(e)]);return r.instance.refreshFloatView(),e.map((function(e){var n=t.faces.filter((function(t){var n=t.spin;return t.pulls.length>0&&n!==e.spin})),i=a(e),o=n.reduce((function(e,t){return a(e).distanceTo(i)<a(t).distanceTo(i)?e:t}));return r.createRadialPull(o,e)}))};switch(t){case se.Distance:var o=n||ce(.75);if(!o)throw new Error("Missing pull scale");e.forEach((function(t,n){e.forEach((function(e,a){n<=a||r.createRadialPull(t,e,o)}))}));break;case se.Join:switch(e.length){case 2:e[0].spin===e[1].spin?i():this.createRadialPull(e[0],e[1]);break;case 3:i()}}}},{key:"checkConnectors",value:function(){var e=this;if(0===this.connectors.length)return this.connectors;var t=function(t,n){!function(e,t,n){for(var r=Object(G.a)(t.ends).reverse(),a=n.ends,i=[],o=0;o<r.length;o++){for(var c=0,s=0;s<r.length;s++){var u=(s+o)%r.length;c+=e.jointDistance(r[s],a[u]),c+=e.jointDistance(a[u],r[(s+1)%r.length])}i.push(c)}var l=0,h=i[l];i.forEach((function(e,t){e<h&&(l=t,h=e)})),l>0&&(n.ends=n.ends.map((function(e,t){return Object(W.a)(e),n.ends[(t+l)%n.ends.length]})))}(e.instance,t,n),e.createLoop(t,n)};return this.connectors.filter((function(n){var a=n.axis,i=n.alpha,o=n.omega,c=n.alphaRays,s=n.omegaRays;if(a.intervalRole===r.Connector&&e.instance.jointDistance(a.alpha,a.omega)<=.05)return t(i,o),e.removeInterval(a),c.forEach((function(t){return e.removeInterval(t)})),s.forEach((function(t){return e.removeInterval(t)})),!1;return!0}))}},{key:"getIntervalDetails",value:function(e){var t=this.instance,n=t.floatView,r=t.world.get_float_value(d.WorldFeature.PushOverPull),a=t.world.get_float_value(d.WorldFeature.PretenstFactor),i=n.stiffnesses[e.index]*(j(e.intervalRole)?r:1),o=n.strains[e.index],c=this.tenscript.scale?this.tenscript.scale:1;return{interval:e,stiffness:i,strain:o,length:t.intervalLength(e)*c,idealLength:n.idealLengths[e.index]*(j(e.intervalRole)?1+a:1)*c,linearDensity:n.linearDensities[e.index],height:t.intervalLocation(e).y*c}}},{key:"createLoop",value:function(e,t){for(var n=Object(G.a)(e.ends).reverse(),a=t.ends,i=ce((oe(e.scale)+oe(t.scale))/2),o=[],c=0;c<n.length;c++){var s=n[c],u=n[(c+1)%n.length],l=a[c];o.push(this.createInterval(s,l,r.PullA,i)),o.push(this.createInterval(l,u,r.PullA,i))}this.removeFace(t),this.removeFace(e),this.loops.push(o)}},{key:"creatAxis",value:function(e,t,n){var a=this.instance.jointDistance(e,t),i=n?r.Distancer:r.Connector,o=n?oe(n)*a:.025,c=ie(),s=1/(this.countdown*Math.abs(o-a)),u={index:this.fabric.create_interval(e.index,t.index,!1,a,o,1,s),alpha:e,omega:t,intervalRole:i,scale:c,removed:!1};return this.intervals.push(u),u}},{key:"createRay",value:function(e,t,n){var a=this.instance.jointDistance(e,t),i=r.Radial,o=ce(n),c=1/(this.countdown*Math.abs(n-a)),s={index:this.fabric.create_interval(e.index,t.index,!1,a,n,1,c),alpha:e,omega:t,intervalRole:i,scale:o,removed:!1};return this.intervals.push(s),s}}]),e}();var Fe,Ve=function(){function e(t,n,r){Object(l.a)(this,e),this.tensegrity=t,this.faces=n,this.markAction=r}return Object(h.a)(e,[{key:"execute",value:function(){switch(this.markAction.action){case se.Join:case se.Distance:this.tensegrity.createRadialPulls(this.faces,this.markAction.action,this.markAction.scale)}}}]),e}(),Re=[{name:"Phi",spin:M.LeftRight,postGrowthOp:je.NoOp,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["()"]},{name:"One",spin:M.Left,postGrowthOp:je.Snelson,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(1)"]},{name:"Axoneme",spin:M.Left,surfaceCharacter:d.SurfaceCharacter.Frozen,postGrowthOp:je.Bowtie,code:["(30,S95)"]},{name:"Knee",spin:M.Left,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(3,b3)"]},{name:"Jack",spin:M.LeftRight,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(a2,b2,c2,d2)"]},{name:"Star",spin:M.LeftRight,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(a(15,S90),b(15,S90),c(15,S90),d(15,S90))"]},{name:"Tripod with Knees",spin:M.RightLeft,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(A5,B(7,c(5,S90),S90),C(7,c(5,S90),S90),D(7,c(5,S90),S90))"]},{name:"Triped",spin:M.LeftRight,scale:100,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Bouncy,code:["(B(9,S90,MA1),C(9,S90,MA1),D(9,S90,MA1))"],markDefStrings:{1:"distance-25"},featureValues:{IterationsPerFrame:1e3,PushOverPull:1e3},jobs:[{age:8e4,todo:"pretensing"}]},{name:"Zigzag",spin:M.LeftRight,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(c(3,MA1),d(7,b(7,c(7,d(7,c(7,d(3,MA1)))))))"],markDefStrings:{1:"join"}},{name:"Magnet",spin:M.Left,postGrowthOp:je.NoOp,surfaceCharacter:d.SurfaceCharacter.Bouncy,code:["(A(9,S80,MA1), a(9,S80,MA1))"],markDefStrings:{1:"distance-5"},featureValues:{Gravity:0,StiffnessFactor:25,Drag:1e3}},{name:"Diamond",spin:M.RightLeft,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(","   a(5,","      b(5,b(5,b(2,MA3)),c(5,c(2,MA4))),","      c(5,b(5,b(2,MA1)),c(5,c(2,MA5))),","      d(5,b(5,b(2,MA6)),c(5,c(2,MA2)))","   )","   b(5,b(5,b(2,MA5)),c(5,c(2,MA3))),","   c(5,b(5,b(2,MA2)),c(5,c(2,MA1))),","   d(5,b(5,b(2,MA4)),c(5,c(2,MA6)))",")"],markDefStrings:{1:"join",2:"join",3:"join",4:"join",5:"join",6:"join"}},{name:"Composed Tree",spin:M.Left,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(6,b(4,MA1),c(4,MA1),d(4,MA1))"],markDefStrings:{1:"subtree(b5,c5,d5)"}},{name:"Equus Lunae",spin:M.LeftRight,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(","  A(16,S95,Md0),","  b(16,S95,Md0),","  a(16,S95,Md0),","  B(16,S95,Md0)",")"],markDefStrings:{0:"distance-60"}},{name:"Runner",spin:M.LeftRight,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Bouncy,code:["(A1,B(5,S90),C(5,S90),D(5,S90))"]},{name:"Infinity",spin:M.LeftRight,postGrowthOp:3,surfaceCharacter:2,code:["(","A(11,S88,MA1),b(11,S88,MA1),","a(11,S88,MA2),B(11,S88,MA2)",")"],featureValues:{},markDefStrings:{1:"join",2:"join"}},{name:"Propellor Tree",spin:M.LeftRight,postGrowthOp:3,surfaceCharacter:2,code:["(","  a(5,S110),","  B(11,S90,MA3),","  b(11,S90,MA1),","  C(11,S90,MA2),","  c(11,S90,MA3),","  D(11,S90,MA1),","  d(11,S90,MA2),",")"],featureValues:{},markDefStrings:{1:"join",2:"join",3:"join",4:"join"}},{name:"Halo by Crane",spin:M.Left,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(5,S92,b(12,S92,MA1),d(11,S92,MA1))"],markDefStrings:{1:"join"},jobs:[{age:6e4,todo:"pretensing"}],featureValues:{Gravity:50,IterationsPerFrame:1e3}},{name:"Convergence",spin:M.LeftRight,postGrowthOp:je.Bowtie,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(a2,b(10,S90,MA1),c(10,S90,MA1),d(10,S90,MA1))"],markDefStrings:{1:"join"},jobs:[{age:6e4,todo:"pretensing"}],featureValues:{IterationsPerFrame:1e3}},{name:"Headless Hug",spin:M.LeftRight,scale:105,postGrowthOp:je.BowtieFaces,surfaceCharacter:d.SurfaceCharacter.Frozen,code:["(","A(OOOOXOO,S95,MA0),","b(OOOOXOO,S95,MA0),","a(3,C(XOOOXOO,S93,MA3),S90,MA2),","B(3,C(XOOOXOO,S93,MA3),S90,MA2)",")"],markDefStrings:{0:"distance-5",2:"distance-7",3:"distance-5"},featureValues:{IterationsPerFrame:1e3,PushOverPull:400},jobs:[{age:1e5,todo:"pretensing"},{age:11e4,todo:"conflict"},{age:12e4,todo:"orient"}]}].map((function(e){return le(e,(function(t){throw new Error('Bootstrap compile error in "'.concat(e,'"! ').concat(t))})),e})),De=n(80);function Le(e,t,n,r,a){return{feature:e,name:t,featureStage:n,nuanceToPercent:function(e){return r*(1-e)+a*e},percentToNuance:function(e){return(e-r)/(a-r)},percentToValue:function(t){return Object(d.default_world_feature)(e)*t/100},valueToPercent:function(t){return t/Object(d.default_world_feature)(e)*100}}}function Be(e){switch(e){case d.WorldFeature.Gravity:return Le(e,"Gravity",Fe.Postslack,0,1e3);case d.WorldFeature.Antigravity:return Le(e,"-Antigravity",Fe.All,5,500);case d.WorldFeature.ShapingDrag:return Le(e,"Shaping Drag",Fe.Preslack,0,500);case d.WorldFeature.ShapingStiffnessFactor:return Le(e,"Shaping Stiffness",Fe.Preslack,10,1e3);case d.WorldFeature.Drag:return Le(e,"Drag",Fe.Postslack,0,1e3);case d.WorldFeature.ShapingPretenstFactor:return Le(e,"Shaping Pretenst",Fe.Preslack,0,1e3);case d.WorldFeature.PretenstFactor:return Le(e,"Pretenst Factor",Fe.Postslack,0,500);case d.WorldFeature.StiffnessFactor:return Le(e,"Stiffness",Fe.Postslack,1,300);case d.WorldFeature.IterationsPerFrame:return Le(e,"Iterations/frame",Fe.All,2,500);case d.WorldFeature.IntervalCountdown:return Le(e,"-Interval Countdown",Fe.Preslack,10,1e3);case d.WorldFeature.PretensingCountdown:return Le(e,"-Pretenst countdown",Fe.All,50,200);case d.WorldFeature.VisualStrain:return Le(e,"Visual strain",Fe.All,0,300);case d.WorldFeature.PushOverPull:return Le(e,"Push/Pull",Fe.All,10,700);default:throw new Error("Feature?")}}!function(e){e[e.Preslack=0]="Preslack",e[e.Postslack=1]="Postslack",e[e.All=2]="All"}(Fe||(Fe={}));var Te=[Object(De.recoilPersist)({key:"pretenst-2021-07-29a",storage:localStorage}).persistAtom],Me=Object(u.atom)({key:"postGrowth",default:je.NoOp,effects_UNSTABLE:Te}),_e=Object(u.atom)({key:"bootstrapIndex",default:0,effects_UNSTABLE:Te}),Ne=Object(u.atom)({key:"tenscript",default:void 0,effects_UNSTABLE:Te}),ze=Object(u.atom)({key:"currentFeature",default:d.WorldFeature.VisualStrain,effects_UNSTABLE:Te});var Ie,Ge=Object(u.atom)({key:"rotating",default:!1}),We=Object(u.atom)({key:"globalMode",default:x()});!function(e){e.Lines="Lines",e.Selecting="Selecting",e.Frozen="Frozen"}(Ie||(Ie={}));var He=Object(u.atom)({key:"viewMode",default:Ie.Lines}),Je=(Object(u.atom)({key:"surfaceCharacter",default:d.SurfaceCharacter.Frozen}),Object(u.atom)({key:"visibleRoles",default:S})),Ue=y.map((function(e){var t=Be(d.WorldFeature[e]);return{mapping:t,percentAtom:Object(u.atom)({key:t.name,default:100,effects_UNSTABLE:Te})}})),qe=n(82),$e=n(124);function Qe(){var e=Object(u.useRecoilState)(We),t=Object(N.a)(e,1)[0],n=Object(u.useRecoilState)(He),r=Object(N.a)(n,2),a=r[0],i=r[1];function o(e){var n=e.item,r=e.children;return t===E.Demo?c.createElement("div",null):c.createElement(qe.a,{disabled:n===a,color:n===a?"success":"secondary",onClick:function(){return i(n)}},r)}return c.createElement($e.a,null,c.createElement(o,{item:Ie.Lines},c.createElement(z.w,null)),c.createElement(o,{item:Ie.Selecting},c.createElement(z.q,null)),c.createElement(o,{item:Ie.Frozen},c.createElement(z.C,null)))}var Xe=n(85),Ke=n(86),Ze=n.n(Ke);function Ye(e){return e.toFixed(5).replace(/[.]/,",")}function et(){return(new Date).toISOString().replace(/[.].*/,"").replace(/[:T_]/g,"-")}function tt(e,t,n,r){var a=e.name,i=e.instance,o=e.joints,c=e.intervals;i.refreshFloatView();var s=i.floatView.idealLengths,u=i.floatView.strains,l=i.floatView.stiffnesses,h=i.floatView.linearDensities;return{name:a,joints:o.map((function(e){var t=i.jointLocation(e);return{index:e.index,radius:r,x:t.x,y:t.z,z:t.y,anchor:!1}})),intervals:c.map((function(e){var r=j(e.intervalRole),a=r?t:n,c=i.intervalLength(e),f=e.alpha.index,d=e.omega.index;if(f>=o.length||d>=o.length)throw new Error("Joint not found ".concat(w(e.intervalRole),":").concat(f,",").concat(d,":").concat(o.length));return{index:e.index,joints:[f,d],type:r?"Push":"Pull",strain:u[e.index],stiffness:l[e.index],linearDensity:h[e.index],role:w(e.intervalRole),scale:e.scale._,idealLength:s[e.index],isPush:r,length:c,radius:a}}))}}function nt(e){var t=new Ze.a;t.file("joints.csv",function(e){var t=[];return t.push(["index","x","y","z"]),e.joints.forEach((function(e){return t.push([(e.index+1).toFixed(0),Ye(e.x),Ye(e.y),Ye(e.z)])})),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.file("intervals.csv",function(e){var t=[];return t.push(["joints","type","strain","stiffness","linear density","role","length","ideal length"]),e.intervals.forEach((function(e){t.push(['"=""'.concat(e.joints.map((function(e){return(e+1).toFixed(0)})),'"""'),e.type,Ye(e.strain),Ye(e.stiffness),Ye(e.linearDensity),e.role,Ye(e.length),Ye(e.idealLength)])})),t.map((function(e){return e.join(";")})).join("\n")}(e)),t.file("submerged.csv",function(e){var t=[];return t.push(["joints"]),t.map((function(e){return e.join(";")})).join("\n")}()),t.generateAsync({type:"blob",mimeType:"application/zip"}).then((function(e){Xe.saveAs(e,"pretenst-".concat(et(),".zip"))}))}function rt(e){var t=e.tensegrity,n=Object(c.useState)(t.stage$.getValue()),r=Object(N.a)(n,2),a=r[0],i=r[1];Object(c.useEffect)((function(){var e=t.stage$.subscribe(i);return function(){return e.unsubscribe()}}),[t]);var o=Object(u.useRecoilState)(He),s=Object(N.a)(o,1)[0],l=Object(u.useRecoilState)(We),h=Object(N.a)(l,1)[0],f=Object(u.useRecoilState)(Ge),m=Object(N.a)(f,2),p=m[0],v=m[1];return h===E.Demo?c.createElement($e.a,null,c.createElement(qe.a,{color:"success",onClick:function(){return C(E.Design)}},c.createElement(z.A,null)," Exit demo")):c.createElement("div",{className:"text-right"},c.createElement($e.a,null,s===Ie.Frozen?c.createElement(c.Fragment,null,c.createElement(qe.a,{onClick:function(){return nt(tt(t,.012,.005,.015))}},c.createElement(z.l,null),c.createElement(z.o,null)),c.createElement(qe.a,{onClick:function(){return function(e){var t=new Ze.a;t.file("pretenst-".concat(et(),".json"),JSON.stringify(e,void 0,2)),t.generateAsync({type:"blob",mimeType:"application/zip"}).then((function(e){Xe.saveAs(e,"pretenst-".concat(et(),".zip"))}))}(tt(t,.012,.005,.015))}},c.createElement(z.l,null),c.createElement(z.n,null))):a>d.Stage.Slack?c.createElement(c.Fragment,null,c.createElement(qe.a,{disabled:a!==d.Stage.Pretenst,onClick:function(){return t.removeSlackPulls()}},c.createElement(z.E,null)),c.createElement(qe.a,{disabled:a!==d.Stage.Pretenst,onClick:function(){return t.fabric.set_altitude(10)}},c.createElement(z.v,null))):void 0,c.createElement(qe.a,{onClick:function(){return t.fabric.centralize()}},c.createElement(z.j,null)),c.createElement(qe.a,{color:p?"warning":"secondary",onClick:function(){return v(!p)}},c.createElement(z.D,null))),c.createElement("br",null),c.createElement($e.a,{className:"my-1"},c.createElement(qe.a,{onClick:function(){x()!==E.Design?C(E.Design):C(E.Demo)}},c.createElement(z.w,null)),c.createElement(qe.a,{onClick:function(){C(E.Sphere)}},c.createElement(z.p,null)),c.createElement(qe.a,{onClick:function(){C(E.Evolution)}},c.createElement(z.k,null))))}var at=n(133),it=n(127);function ot(e){return e.shiftKey||e.altKey||e.metaKey||e.ctrlKey}var ct=n(125),st=n(126);function ut(e){var t=e.instance,n=e.details,r=e.selectDetails,a=n.interval,i=a.alpha,o=a.omega,s=a.intervalRole;return c.createElement(ct.a,{className:"interval-details",style:{width:"10em",userSelect:"none",zIndex:100},position:t.intervalLocation(n.interval)},c.createElement("div",{onMouseDown:function(e){return r(n)}},c.createElement("div",{style:{position:"absolute",top:"0",left:"0",color:"red"}},c.createElement(z.u,null)),c.createElement(st.a,null,c.createElement("thead",null,c.createElement("tr",null,c.createElement("th",{colSpan:2},"(",i.index+1," ",c.createElement(z.b,null)," ",o.index+1,"): ",w(s)))),c.createElement("tbody",null,c.createElement("tr",null,c.createElement("td",{className:"text-right"},"Length:"),c.createElement("td",{className:"text-center"},n.length.toFixed(1))),c.createElement("tr",null,c.createElement("td",{className:"text-right"},"Ideal Length:"),c.createElement("td",{className:"text-center"},n.idealLength.toFixed(1))),c.createElement("tr",null,c.createElement("td",{className:"text-right"},"Height:"),c.createElement("td",{className:"text-center"},n.height.toFixed(1)))))))}var lt=["#fd0000","#c94f00","#d58e1c","#897c00","#6c8901","#1d6c01","#0e4e00","#007f67","#01808b","#005da3","#0015c7","#0000ff"].reverse().map((function(e){return(new f.Color).setHex(parseInt("".concat(e.substring(1)),16))})),ht=new f.LineBasicMaterial({vertexColors:!0});new f.MeshBasicMaterial({color:new f.Color("#ffdf00"),side:f.DoubleSide,transparent:!0,opacity:.25,depthTest:!1}),lt.map((function(e){return new f.MeshLambertMaterial({color:e})}));function ft(e){switch(e){case r.PushA:return"#191f86";case r.PushB:return"#5739a0";case r.PullA:return"#ce1d1d";case r.PullB:return"#d44e4e";case r.PullAA:return"#13f3f3";case r.PullBB:return"#59ee37";default:return"#FFFFFF"}}function dt(e){var t=function(e){return new f.Color(ft(e))}(e);return new f.MeshLambertMaterial({color:t})}var mt=new f.MeshPhongMaterial({color:new f.Color("#070707"),specular:new f.Color("#110404"),side:f.FrontSide}),pt=[new f.Vector3(0,0,-20),new f.Vector3(-17.32,0,-10),new f.Vector3(-17.32,0,10),new f.Vector3(0,0,20),new f.Vector3(17.32,0,10),new f.Vector3(17.32,0,-10),new f.Vector3],vt=[6,0,1,6,1,2,6,2,3,6,3,4,6,4,5,6,5,0].map((function(e){return pt[e]}));function gt(){var e=Object(c.useMemo)((function(){return function(){var e=new f.BufferGeometry,t=new Float32Array(3*vt.length),n=new Float32Array(3*vt.length);return vt.forEach((function(e,r){var a=3*r;t[a]=e.x,t[a+1]=e.y-.01,t[a+2]=e.z;var i=new f.Vector3(0,300,0).add(e).normalize();n[a]=i.x,n[a+1]=i.y,n[a+2]=i.z})),e.setAttribute("position",new f.BufferAttribute(t,3)),e.setAttribute("normal",new f.BufferAttribute(n,3)),e}()}),[]);return c.createElement("mesh",{name:"Patches",geometry:e,material:mt})}function bt(e){var t=e.tensegrity,n=e.selected,r=e.setSelected,a=e.details,i=e.selectDetails,o=Object(u.useRecoilState)(He),s=Object(N.a)(o,2),l=s[0],h=s[1],m=Object(c.useState)(new f.Vector3),p=Object(N.a)(m,2),v=p[0],g=p[1],b=Object(u.useRecoilState)(Ge),y=Object(N.a)(b,1)[0];Object(I.b)((function(){l===Ie.Lines&&(t.iterate()||t.stage!==d.Stage.Pretensing||(t.stage=d.Stage.Pretenst));var e=n?t.instance.intervalLocation(n):t.instance.midpoint,r=(new f.Vector3).subVectors(e,v).multiplyScalar(.1);(l===Ie.Lines||r.lengthSq()>.001)&&g((new f.Vector3).copy(v).add(r))}));var w=t.instance,E=function(){switch(l){case Ie.Lines:return c.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:ht,onUpdate:function(e){return e.geometry.computeBoundingSphere()}});case Ie.Selecting:return c.createElement(yt,{tensegrity:t,selected:n,setSelected:r,details:a,selectDetails:i});case Ie.Frozen:return c.createElement("group",null,t.intervals.map((function(e){var t=Y(w.unitVector(e.index)),n=w.jointDistance(e.alpha,e.omega),a=wt(e),i=new f.Vector3(a,n,a);return c.createElement("mesh",{key:"T".concat(e.index),geometry:Et,position:w.intervalLocation(e),rotation:(new f.Euler).setFromQuaternion(t),scale:i,material:dt(e.intervalRole),matrixWorldNeedsUpdate:!0,onClick:function(t){ot(t)&&(r(e),h(Ie.Selecting))}})})),"}")}};return c.createElement("group",null,c.createElement(at.a,{onPointerMissed:void 0,autoRotate:y,target:v,zoomSpeed:.5}),c.createElement("scene",null,c.createElement(E,null),c.createElement(gt,null),c.createElement(it.a,null),c.createElement("ambientLight",{color:new f.Color("white"),intensity:.8}),c.createElement("directionalLight",{color:new f.Color("#FFFFFF"),intensity:2})))}function yt(e){var t=e.tensegrity,n=e.selected,r=e.setSelected,a=e.details,i=e.selectDetails,o=t.instance;return c.createElement("group",null,t.intervals.map((function(e){if(!j(e.intervalRole)){if(!n)return;if(j(n.intervalRole)){if(!ee(n,e))return}else if(n.index!==e.index)return;if(!ee(n,e))return}var t=Y(o.unitVector(e.index)),a=o.jointDistance(e.alpha,e.omega),i=wt(e),s=new f.Vector3(i,a,i);return c.createElement("mesh",{key:"T".concat(e.index),geometry:Et,position:o.intervalLocation(e),rotation:(new f.Euler).setFromQuaternion(t),scale:s,material:dt(e.intervalRole),matrixWorldNeedsUpdate:!0,onPointerDown:function(t){t.stopPropagation(),ot(t)&&j(e.intervalRole)&&function(e){n&&n.index===e.index?r(void 0):r(e)}(e)}})})),"}",a.map((function(e){return c.createElement(ut,{key:"deets-".concat(e.interval.index),instance:t.instance,details:e,selectDetails:i})})))}function wt(e){return 8*(j(e.intervalRole)?.003:.0015)}var Et=new f.CylinderGeometry(1,1,1,12,1,!1);function St(e){var t=e.globalMode,n=e.createInstance,r=Object(c.useMemo)((function(){return n(kt(t).featureValues)}),[]),a=Object(c.useState)(),i=Object(N.a)(a,2),o=i[0],s=i[1],l=Object(u.useRecoilState)(He),h=Object(N.a)(l,2),m=h[0],p=h[1],v=Object(c.useState)(),g=Object(N.a)(v,2),b=g[0],w=g[1],E=Object(c.useState)([]),S=Object(N.a)(E,2),j=S[0],k=S[1],O=Object(u.useSetRecoilState)(Me),x=function(e){return console.error("build view",e)},C=function(e,t){return k(t.intervals.filter(Se(e)).map((function(e){return t.getIntervalDetails(e)})))};Object(c.useEffect)((function(){!function(e,t){try{var n=le(e,t);if(!n)return!1;p(Ie.Lines),O(e.postGrowthOp);var a=e.featureValues;y.map((function(e){var t=d.WorldFeature[e],n=Be(t).percentToValue,i=a?a[e]:void 0;void 0!==i&&r.applyFeature(t,i,n(i))}));var i=a?a[d.WorldFeature.IntervalCountdown]:void 0,o=void 0===i?Object(d.default_world_feature)(d.WorldFeature.IntervalCountdown):i;s(new Pe(new f.Vector3,r,o,e,n))}catch(c){throw new Error("Problem running")}}(kt(t),x)}),[]),Object(c.useEffect)((function(){o&&(b?C(b,o):k([]))}),[b]);var A=Object(u.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return c.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},o?c.createElement("div",{className:"h-100"},c.createElement(I.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:m!==Ie.Lines?"#f0ad4e":"black",cursor:m===Ie.Selecting?"pointer":"default",borderWidth:"2px"}},c.createElement(jt,null),c.createElement(A,null,c.createElement(bt,{tensegrity:o,selected:b,setSelected:w,details:j,selectDetails:function(e){var t=e.interval;1===j.length&&b&&o?C(b,o):k(j.filter((function(e){return e.interval.index===t.index})))}}))),c.createElement("div",{id:"bottom-left"},c.createElement(Qe,null)),c.createElement("div",{id:"bottom-right"},c.createElement(rt,{tensegrity:o}))):c.createElement("div",{className:"h-100"},c.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},c.createElement("h1",null,c.createElement(z.w,null)))))}function jt(e){var t=Object(c.useRef)(),n=Object(I.c)().setDefaultCamera;return Object(c.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(0,6,18),n(e)}),[]),Object(I.b)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),c.createElement("perspectiveCamera",Object.assign({ref:t},e))}function kt(e){var t=function(e){var t=Re.find((function(t){return t.name===e}));if(!t)throw new Error("No bootstrap for ".concat(e));return t};switch(e){case E.Halo:return t("Halo by Crane");case E.Convergence:return t("Convergence");case E.HeadlessHug:return t("Headless Hug");case E.Triped:return t("Triped");default:throw new Error("tenscript?")}}var Ot=[{x:0,y:0},{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1},{x:4,y:0},{x:3,y:-1},{x:2,y:-2},{x:0,y:-2},{x:-2,y:-2},{x:-3,y:-1},{x:-4,y:0},{x:-3,y:1},{x:-2,y:2},{x:0,y:2},{x:2,y:2},{x:3,y:1},{x:6,y:0},{x:5,y:-1},{x:4,y:-2},{x:3,y:-3},{x:1,y:-3},{x:-1,y:-3},{x:-3,y:-3},{x:-4,y:-2},{x:-5,y:-1},{x:-6,y:0},{x:-5,y:1},{x:-4,y:2},{x:-3,y:3},{x:-1,y:3},{x:1,y:3},{x:3,y:3},{x:4,y:2},{x:5,y:1}],xt=[{x:2,y:0},{x:1,y:-1},{x:-1,y:-1},{x:-2,y:0},{x:-1,y:1},{x:1,y:1}],Ct=Math.sin(60*Math.PI/180),At=17.5/Ct,Pt=At*Ct,Ft=1.5*At,Vt=[new f.Vector3(0,0,-At),new f.Vector3(-Ct*At,0,-At/2),new f.Vector3(-Ct*At,0,At/2),new f.Vector3(0,0,At),new f.Vector3(Ct*At,0,At/2),new f.Vector3(Ct*At,0,-At/2)],Rt=new f.Color("#091009"),Dt=new f.Color("#100902"),Lt=new f.Vector3(0,1,0),Bt=new f.Vector3(0,500,0);var Tt,Mt=function(){var e=new f.Geometry;return e.vertices=function(){var e=function(){return new f.Vector3(0,0,0)},t=e(),n=e().addScaledVector(p,1.5*-.2).addScaledVector(m,5),r=e().addScaledVector(p,-.2).addScaledVector(m,5),a=e().addScaledVector(p,.2).addScaledVector(m,5),i=e().addScaledVector(p,.2*1.5).addScaledVector(m,5),o=e().addScaledVector(m,6.5);return[t,r,t,a,i,o,n,o,i,a,n,r]}(),e}(),_t=function(){function e(t,n){Object(l.a)(this,e),this.roll=t,this.genes=n}return Object(h.a)(e,[{key:"createReader",value:function(e){return new Nt(Qt(e,this.genes),this.roll)}},{key:"totalTwitches",get:function(){return 16}},{key:"withMutations",value:function(t,n){var r=this,a=this.genes.map((function(e){return{geneName:e.geneName,tosses:e.tosses,dice:e.dice.slice()}}));if(t.forEach((function(e){Ht((function(){return r.roll()}),Qt(e,a))})),n){var i=Qt(Tt.TwitchConfig,a);Ht((function(){return r.roll()}),i),i.tosses++}return new e(this.roll,a)}},{key:"geneData",get:function(){return this.genes.map((function(e){return{geneName:e.geneName,tosses:e.tosses,geneString:function(e){return e.map((function(e){return e.symbol})).join("")}(e.dice)}}))}},{key:"tosses",get:function(){return this.genes.reduce((function(e,t){return e+t.tosses}),0)}},{key:"toString",value:function(){return this.genes.map((function(e){return"(".concat(e.geneName,":").concat(e.tosses,")")})).join(", ")}}]),e}(),Nt=function(){function e(t,n){Object(l.a)(this,e),this.gene=t,this.roll=n,this.cursor=0}return Object(h.a)(e,[{key:"chooseFrom",value:function(e){return Math.floor(e*Ut(this.nextDie(),this.nextDie()))}},{key:"readMuscleTwitch",value:function(e,t){var n=t.attackPeriod,r=t.decayPeriod,a=t.twitchNuance;return{muscle:e[this.nextDie().index],twitchNuance:a,when:Gt(36,this.nextDie(),this.nextDie()),attack:(2+Wt(6,this.nextDie()))*n,decay:(2+Wt(6,this.nextDie()))*r}}},{key:"readFeatureValue",value:function(e,t){var n=Ut(this.nextDie(),this.nextDie(),this.nextDie());return e*n+t*(1-n)}},{key:"length",get:function(){return this.gene.dice.length}},{key:"nextDie",value:function(){for(;this.gene.dice.length<this.cursor+1;)this.gene.dice.push(this.roll());return this.gene.dice[this.cursor++]}}]),e}(),zt=[{index:0,numeral:"1",symbol:"\u2680"},{index:1,numeral:"2",symbol:"\u2681"},{index:2,numeral:"3",symbol:"\u2682"},{index:3,numeral:"4",symbol:"\u2683"},{index:4,numeral:"5",symbol:"\u2684"},{index:5,numeral:"6",symbol:"\u2685"}],It=function(){var e={};return zt.forEach((function(t){e[t.numeral]=t,e[t.symbol]=t})),e}();function Gt(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Math.floor(Ut.apply(void 0,n)*e)}function Wt(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Ut.apply(void 0,n)*e}function Ht(e,t){if(0===t.dice.length)t.dice.push(e());else for(var n=Math.floor(Math.random()*t.dice.length),r=t.dice[n];t.dice[n]===r;)t.dice[n]=e();t.tosses++}function Jt(){return zt[Math.floor(Math.random()*zt.length)]}function Ut(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(0===t.length)throw new Error("No dice!");var r=t.reduce((function(e,t){return 6*e+t.index}),0);return r/Math.pow(6,t.length)}function qt(){return new _t(Jt,[])}function $t(e){if(0===e.length)return qt();var t=e.map((function(e){var t=e.geneName,n=e.tosses,r=e.geneString;return{geneName:t,tosses:n,dice:r.split("").map((function(e){return It[e]})).filter((function(e){return!!e}))}}));return new _t(Jt,t)}function Qt(e,t){var n=t.find((function(t){var n=t.geneName;return e===n}));if(n)return n;var r={geneName:e,tosses:0,dice:[]};return t.push(r),r}!function(e){e.ToA="ToA",e.ToB="ToB",e.ToC="ToC",e.TwitchConfig="TwitchConfig"}(Tt||(Tt={}));var Xt,Kt=function(){function e(t,n,r){Object(l.a)(this,e),this.island=t,this.coords=n,this.patchCharacter=r,this.runner=void 0,this.flora=void 0,this.center=void 0,this.name=void 0,this.adjacent=[],this.center=new f.Vector3(n.x*Pt,0,n.y*Ft),this.name="(".concat(n.x,",").concat(n.y,")")}return Object(h.a)(e,[{key:"storedGenes",get:function(){var e=localStorage.getItem(this.name);return e?JSON.parse(e):[qt().geneData]},set:function(e){localStorage.setItem(this.name,JSON.stringify(e))}},{key:"positionArray",get:function(){for(var e=this,t=new Float32Array(54),n=0,r=function(r){var a=(new f.Vector3).copy(e.center).addScaledVector(r,.99),i=a.x,o=a.y,c=a.z;t[n++]=i,t[n++]=o,t[n++]=c},a=0;a<6;a++){var i=(a+1)%6;r(new f.Vector3),r(Vt[a]),r(Vt[i])}return t}},{key:"normalArray",get:function(){for(var e=new Float32Array(54),t=0,n=function(n){var r=n.x,a=n.y,i=n.z;e[t++]=r,e[t++]=a,e[t++]=i},r=0;r<6;r++){var a=(r+1)%6;n(Lt),n((new f.Vector3).add(Lt).addScaledVector(Vt[r],.9/35).normalize()),n((new f.Vector3).add(Lt).addScaledVector(Vt[a],.9/35).normalize())}return e}}]),e}();!function(e){e.FaunaPatch="Fauna",e.FloraPatch="Flora"}(Xt||(Xt={}));var Zt,Yt,en=function(){function e(t,n){Object(l.a)(this,e),this.name=t,this.patches=[],this._seed=void 0,this._seed=n%2147483647,this.fill()}return Object(h.a)(e,[{key:"midpoint",get:function(){return this.patches.reduce((function(e,t){return e.add(t.center)}),new f.Vector3).multiplyScalar(1/this.patches.length)}},{key:"findPatch",value:function(e){return this.patches.find((function(t){return n=t.coords,r=e,n.x===r.x&&n.y===r.y;var n,r}))}},{key:"fill",value:function(){var e=this;this.createSurroundedPatch({x:0,y:0}),this.patches.forEach((function(t){var n=t.coords;xt.forEach((function(r){var a=r.x,i=r.y;t.adjacent.push(e.findPatch({x:a+n.x,y:i+n.y}))}))}))}},{key:"createSurroundedPatch",value:function(e){var t=this,n=this.getOrCreatePatch(e);return Ot.map((function(n){return t.getOrCreatePatch((a=e,{x:(r=n).x+a.x,y:r.y+a.y}));var r,a})),n}},{key:"getOrCreatePatch",value:function(e){var t=this.findPatch(e);if(t)return t;var n=this.next()>.5?Xt.FaunaPatch:Xt.FloraPatch,r=new Kt(this,e,n);return this.patches.push(r),r}},{key:"next",value:function(){return this._seed=16807*this._seed%2147483647,(this._seed-1)/2147483646}}]),e}(),tn={name:"Runner",spin:M.LeftRight,code:["(A1,B(".concat(5,",S").concat(90,"),C(").concat(5,",S").concat(90,"),D(").concat(5,",S").concat(90,"))")],postGrowthOp:je.Bowtie,markDefStrings:{},surfaceCharacter:d.SurfaceCharacter.Bouncy,featureValues:(Zt={},Object(_.a)(Zt,d.WorldFeature.IterationsPerFrame,300),Object(_.a)(Zt,d.WorldFeature.Drag,200),Object(_.a)(Zt,d.WorldFeature.StiffnessFactor,150),Object(_.a)(Zt,d.WorldFeature.Gravity,500),Zt)},nn=(je.Bowtie,M.Left,d.SurfaceCharacter.Frozen,Object(u.atom)({key:"island",default:new en("galapagos",383)})),rn=Object(u.selector)({key:"MySelector",get:function(e){return(0,e.get)(nn).patches[0]}}),an=Object(u.atom)({key:"destination",default:0}),on=Object(u.atom)({key:"showDetails",default:!1}),cn=n(134);!function(e){e.Rest="Rest",e.ToA="ToA",e.ToB="ToB",e.ToC="ToC"}(Yt||(Yt={}));var sn=Object.keys(Yt).map((function(e){return Yt[e]}));function un(e){switch(e){case Yt.ToA:return Tt.ToA;case Yt.ToB:return Tt.ToB;case Yt.ToC:return Tt.ToC;default:throw new Error("No gene for direction ".concat(e))}}function ln(e,t,n,r,a){if(a){var i=a.joint;if(i){var o=e.floatView.jointLocations,c=function(e,t,n){var r=3*e.index,a=3*t.index;n.set(o[a]-o[r],0,o[a+2]-o[r+2]),n.normalize()};c(i,a.ends[0],t),c(i,a.ends[1],n),c(i,a.ends[2],r)}}}var hn,fn=[4,5,6,7,8,9],dn=8,mn=8;!function(e){e.SurvivorsAdvance="Survivors advance",e.ChallengersBorn="Challengers born",e.ChallengersReborn="Challengers reborn",e.ChallengersOvertake="Challengers try to overtake",e.SurvivorsStored="Survivors stored",e.EvolutionAdvance="Evolution advance",e.EvolutionDone="Evolution done",e.EvolutionHarder="Evolution harder"}(hn||(hn={}));var pn=function(){function e(t,n,r,a){if(Object(l.a)(this,e),this.ancestor=t,this.createInstance=n,this.useTwitches=r,this.cyclePattern=a,this.snapshotsSubject=new ye.a([]),this.winners=[],this.midpoint=void 0,this.challengersVisible=!1,this.challengers=[],this.phase=hn.SurvivorsAdvance,this.cyclePatternIndex=void 0,this.currentCycle=0,this.currentMaxCycles=void 0,t.embryo)throw new Error("Cannot create evolution from runner which is not pretenst");this.midpoint=t.state.midpoint,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex=0];for(var i=[],o=t.state.patch.storedGenes;i.length<dn;)i.push(this.createAutoRunner($t(o[i.length%o.length])));this.winners=i.map((function(e,t){return{runner:e,name:bn(t),proximityHistory:[],persisted:!0}}))}return Object(h.a)(e,[{key:"withReducedCyclePattern",get:function(){var t=Object(G.a)(this.cyclePattern);if(t.pop(),!(t.length<3))return new e(this.ancestor,this.createInstance,this.useTwitches,t)}},{key:"iterate",value:function(){var e=this;switch(this.phase){case hn.SurvivorsAdvance:var t=0,n=!1;if(this.winners.forEach((function(r){var a=r.runner,i=a.getCycleCount(e.useTwitches);i>t&&(t=i),i<e.currentMaxCycles&&(a.iterate(),n=!0)})),t>this.currentCycle&&(vn(this.winners,this.currentCycle),this.currentCycle=t),!n)!this.winners.find((function(e){return!e.runner.reachedTarget}))?this.phase=hn.EvolutionDone:(this.winners.forEach((function(e){return e.runner.showFrozen()})),this.phase=0===this.challengers.length?hn.ChallengersBorn:hn.ChallengersReborn,this.currentCycle=0);break;case hn.ChallengersBorn:for(var r=[];r.length<mn;){var a=$t(this.winners[r.length%this.winners.length].runner.state.genome.geneData);r.push(this.createAutoRunner(a.withMutations([un(this.ancestor.direction)],!1)))}this.challengers=r.map((function(t,n){return t.autopilot=!0,{runner:t,name:"".concat(bn(n+e.winners.length)).concat(bn(n%e.winners.length)),proximityHistory:[],persisted:!1}})),this.phase=hn.ChallengersOvertake;break;case hn.ChallengersReborn:var i=0;this.challengers=this.challengers.map((function(t,n){var r=i++%e.winners.length,a=e.winners[r],o=t.runner.adoptFabric(e.ancestor.state.instance.fabricClone),c=t.runner.recycled(o,a.runner.mutatedGeneData()),s="".concat(a.name).concat(bn(n));return c.autopilot=!0,{runner:c,name:s,proximityHistory:[],persisted:!1}})),this.phase=hn.ChallengersOvertake;break;case hn.ChallengersOvertake:this.challengersVisible=!0;var o=!1,c=0;if(this.challengers.forEach((function(t){var n=t.runner,r=(t.name,n.getCycleCount(e.useTwitches));r>c&&(c=r),r<e.currentMaxCycles&&(n.iterate(),o=!0)})),c>this.currentCycle){var s=[].concat(Object(G.a)(this.winners),Object(G.a)(this.challengers));vn(s,this.currentCycle),this.broadcastSnapshot(s.map((function(t){return gn(t,e.currentCycle)}))),this.currentCycle=c}o||(this.phase=hn.SurvivorsStored);break;case hn.SurvivorsStored:var u=this.splitEvolvers(this.currentCycle),l=u.winners,h=u.losers;this.ancestor.state.patch.storedGenes=l.map((function(e){return e.runner.state.genome.geneData})),l.forEach((function(e){return e.persisted=!0})),h.forEach((function(e){return e.persisted=!1})),this.broadcastSnapshot(l.map((function(t){return gn(t,e.currentCycle)}))),this.winners=l,this.challengers=h,this.challengersVisible=!1,this.phase=hn.EvolutionAdvance;break;case hn.EvolutionAdvance:if(this.cyclePatternIndex===this.cyclePattern.length-1){var f=!this.winners.find((function(e){return!e.runner.reachedTarget}));this.phase=f?hn.EvolutionHarder:hn.EvolutionDone}else this.cyclePatternIndex++,this.currentMaxCycles=this.cyclePattern[this.cyclePatternIndex],this.currentCycle=0,this.phase=hn.SurvivorsAdvance;break;case hn.EvolutionDone:case hn.EvolutionHarder:}return this.midpoint.set(0,0,0),this.winners.forEach((function(t){var n=t.runner;return e.midpoint.add(n.state.midpoint)})),this.challengers.forEach((function(t){var n=t.runner;return e.midpoint.add(n.state.midpoint)})),this.midpoint.multiplyScalar(1/(this.winners.length+this.challengers.length)),this.phase}},{key:"target",get:function(){return this.ancestor.target}},{key:"splitEvolvers",value:function(e){var t=[],n=[],r=[].concat(Object(G.a)(this.winners),Object(G.a)(this.challengers));return vn(r,e),r.forEach((function(e,r){r<dn?t.push(e):n.push(e)})),{cycleCount:e,winners:t,losers:n}}},{key:"broadcastSnapshot",value:function(e){var t=this.currentCycle,n=this.cyclePatternIndex,r={cycle:t,cyclePattern:this.cyclePattern,cycleIndex:n,evolverSnapshots:e},a=this.snapshotsSubject.getValue(),i=a.findIndex((function(e){return r.cycleIndex===e.cycleIndex}));if(i<0)this.snapshotsSubject.next([].concat(Object(G.a)(a),[r]));else if(i===a.length-1){var o=Object(G.a)(a);o[i]=r,this.snapshotsSubject.next(o)}else this.snapshotsSubject.next([r])}},{key:"createAutoRunner",value:function(e){var t=this.createInstance(tn.featureValues,this.ancestor.state.instance.fabricClone),n=this.ancestor.recycled(t,e.geneData);return n.autopilot=!0,n}}]),e}();function vn(e,t){e.forEach((function(e){if(e.proximityHistory.length===t){var n=e.runner.distanceFromTarget;e.proximityHistory.push(n)}})),e.sort((function(e,n){return e.proximityHistory[t]-n.proximityHistory[t]}))}function gn(e,t){var n=e.runner,r=e.proximityHistory,a=e.persisted,i=e.name,o=r[t];if(void 0===o)throw new Error("Cannot snapshot");var c=n.state.genome.tosses;return{name:i,proximity:o,reachedTarget:n.reachedTarget,tosses:c,persisted:a}}function bn(e){return String.fromCharCode(65+e)}function yn(e){var t=e.runner,n=t.topFaceLocation,r=t.target,a=t.state,i=t.showDirection,o=a.instance.floatView;return c.createElement("group",null,c.createElement("lineSegments",{geometry:o.lineGeometry,onUpdate:function(e){return e.geometry.computeBoundingSphere()}},c.createElement("lineBasicMaterial",{attach:"material",vertexColors:!0})),i&&n?c.createElement("group",null,c.createElement("lineSegments",null,c.createElement("bufferGeometry",{attach:"geometry"},c.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([n.x,n.y,n.z,r.x,n.y,r.z]),count:2,itemSize:3,onUpdate:function(e){return e.needsUpdate=!0}})),c.createElement("lineBasicMaterial",{attach:"material",color:"#FFFFFF"})),c.createElement("lineSegments",{geometry:Mt,quaternion:t.directionQuaternion,position:n},c.createElement("lineBasicMaterial",{attach:"material",color:"#0afdeb"}))):void 0)}function wn(e){var t=e.population,n=t.midpoint,r=t.target;return c.createElement("group",null,t.winners.map((function(e,t){var n=e.runner;return c.createElement(yn,{key:"evolving-".concat(t),runner:n})})),t.challengersVisible?t.challengers.map((function(e,n){var r=e.runner;return c.createElement(yn,{key:"evolving-".concat(n+t.winners.length),runner:r})})):void 0,c.createElement("lineSegments",null,c.createElement("bufferGeometry",{attach:"geometry"},c.createElement("bufferAttribute",{attachObject:["attributes","position"],array:new Float32Array([n.x,0,n.z,n.x,6,n.z,n.x,6,n.z,r.x,6,r.z,r.x,6,r.z,r.x,0,r.z]),count:6,itemSize:3,onUpdate:function(e){return e.needsUpdate=!0}})),c.createElement("lineBasicMaterial",{attach:"material",color:"#ffffff"})))}function En(e){var t=e.island,n=e.happening,r=e.runner,a=e.population,i=e.evolutionPhase,o=e.countdownToEvo,s=e.stopEvo,l=Object(c.useState)(!1),h=Object(N.a)(l,2),d=h[0],m=h[1],p=Object(u.useRecoilState)(an),v=Object(N.a)(p,2),g=v[0],b=v[1],y=Object(c.useState)(Date.now()),w=Object(N.a)(y,2),E=w[0],S=w[1],j=Object(c.useState)(Date.now()),k=Object(N.a)(j,2),O=k[0],x=k[1],C=Object(c.useState)(new f.Vector3(0,1,0)),A=Object(N.a)(C,2),P=A[0],F=A[1],V=Object(c.useState)(new f.Vector3(0,1,10)),R=Object(N.a)(V,2),D=R[0],L=R[1];function B(e){F((new f.Vector3).subVectors(e,P).multiplyScalar(.05).add(P))}return Object(I.b)((function(){var e=function(e){var t=(new f.Vector3).subVectors(D,P),n=e-t.length();t.normalize(),D.y+=.01*(3-D.y),L(D.add(t.multiplyScalar(.003*n)))};switch(n){case Sn.Developing:r&&(r.iterate(),B(r.state.midpoint),e(6));break;case Sn.Resting:r&&(r.iterate(),B(r.state.midpoint),e(8));break;case Sn.Running:r&&(r.iterate(),B(r.state.midpoint),e(6));break;case Sn.Evolving:if(a){switch(a.iterate()){case hn.EvolutionDone:console.log("Evolution DONE"),s();break;case hn.EvolutionHarder:console.log("Evolution advance..."),s(a.withReducedCyclePattern)}B(a.midpoint),e(15),i(a.phase)}}var t=Math.floor((O-E)/1e3),c=Date.now();x(c);var u=Math.floor((c-E)/1e3);n===Sn.Resting&&t<u&&o(5-u)})),Object(c.useEffect)((function(){S(Date.now()),x(Date.now()),m(n===Sn.Evolving)}),[n]),c.createElement("group",null,c.createElement(at.a,{target:P,autoRotate:d,enableKeys:!1,enablePan:!1,position:D,autoRotateSpeed:.6,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.8*Math.PI,onPointerMissed:void 0}),c.createElement("scene",null,a&&n===Sn.Evolving?c.createElement(wn,{population:a}):r?c.createElement(yn,{runner:r}):void 0,t.patches.map((function(e){var t=e.positionArray,n=e.normalArray;return c.createElement("mesh",{key:"patch-".concat(e.name),onClick:function(){return function(e){e.flora?(e.flora.removeRandomInterval(),console.log("remove",e.name)):r&&r.direction===Yt.Rest&&b((g+1)%6)}(e)}},c.createElement("meshPhongMaterial",{attach:"material",side:f.DoubleSide,color:e.patchCharacter===Xt.FaunaPatch?Rt:Dt}),c.createElement("bufferGeometry",{attach:"geometry"},c.createElement("bufferAttribute",{attachObject:["attributes","position"],array:t,count:t.length/3,itemSize:3}),c.createElement("bufferAttribute",{attachObject:["attributes","normal"],array:n,count:n.length/3,itemSize:3})))})),c.createElement(cn.a,{distance:1e6,rayleigh:3,inclination:.505,mieCoefficient:.001,mieDirectionalG:.93,turbidity:7.5}),c.createElement("pointLight",{distance:1e3,decay:.1,position:Bt}),c.createElement("hemisphereLight",{name:"Hemi"})))}var Sn,jn=n(33),kn=function(){function e(t){var n=this;Object(l.a)(this,e),this.state=t,this.cycleCount=0,this.twitchCount=0,this.config=void 0,this.twitchCycles={};var r=this.state.genome;this.config=function(){var e=r.createReader(Tt.TwitchConfig),t=e.readFeatureValue(800,1200);return{twitchNuance:e.readFeatureValue(.1,.3),musclePeriod:t,attackPeriod:e.readFeatureValue(.5,1)*t,decayPeriod:e.readFeatureValue(.5,1)*t}}();var a=r.totalTwitches;sn.filter((function(e){return e!==Yt.Rest})).forEach((function(e){var t=un(e),i=r.createReader(t);n.twitchCycles[e]=new On(i,n.config,n.state.loopMuscles,a)}))}return Object(h.a)(e,[{key:"toString",value:function(){var e=this,t=Object.keys(this.twitchCycles).map((function(t){return e.twitchCycles[t]})).map((function(e){return e.toString()})).join("\n");return"Twitcher(".concat(t,")")}},{key:"tick",value:function(e){var t=this.state;if(t.timeSlice++,t.timeSlice>=36)return t.timeSlice=0,this.cycleCount++,!0;var n=this.twitchCycles[t.direction];return n&&(this.twitchCount+=n.activate(t.timeSlice,e)),!1}}]),e}(),On=function(){function e(t,n,r,a){Object(l.a)(this,e),this.slices={};for(var i=Object(G.a)(r);a-- >0;){var o=t.chooseFrom(i.length),c=t.readMuscleTwitch(i[o],n);i.splice(o,1),this.addTwitch(c.when,c)}}return Object(h.a)(e,[{key:"toString",value:function(){var e=this,t=Object.keys(this.slices).map((function(t){return e.slices[t]})).map((function(e){return e.map((function(e){return"".concat(e.when,":").concat(e.muscle.interval.index)})).join(";")})).join(",");return"Cycle(".concat(t,")")}},{key:"activate",value:function(e,t){var n=this.slices[e];return n?(n.forEach((function(e){var n=e.muscle,r=e.attack,a=e.decay,i=e.twitchNuance;return t(n,r,a,i)})),n.length):0}},{key:"addTwitch",value:function(e,t){var n=this.slices[e];n?n.push(t):this.slices[e]=[t]}}]),e}(),xn=function(){function e(t,n){Object(l.a)(this,e),this.state=t,this.embryo=n,this.toA=new f.Vector3(1,0,0),this.toB=new f.Vector3(0,0,1),this.toC=new f.Vector3(0,0,-1),this.shapingTime=150,this.twitcher=void 0,this.topFace=void 0,this.currentTwitchAge=0,n||(this.twitcher=new kn(this.state)),this.currentTwitchAge=this.twitchAge}return Object(h.a)(e,[{key:"growing",get:function(){return!!this.embryo}},{key:"recycled",value:function(t,n){var r=$t(n||this.state.patch.storedGenes[0]),a=(new f.Vector3).copy(this.state.midpoint),i=new e(Object(jn.a)(Object(jn.a)({},this.state),{},{instance:t,midpoint:a,genome:r,directionHistory:[]}));return i.topFace=this.topFace,ln(i.state.instance,i.toA,i.toB,i.toC,this.topFace),i}},{key:"getCycleCount",value:function(e){return this.twitcher?e?Math.floor(this.twitcher.twitchCount/this.state.twitchesPerCycle):this.twitcher.cycleCount:0}},{key:"autopilot",get:function(){return this.state.autopilot},set:function(e){this.state.autopilot=e}},{key:"direction",get:function(){return this.state.direction},set:function(e){this.state.direction=e,this.autopilot=!1}},{key:"adoptFabric",value:function(e){return this.state.instance.adoptFabric(e)}},{key:"mutatedGeneData",value:function(){var e=this,t=sn.map((function(t){var n=e.state.directionHistory.filter((function(e){return e===t})).length;return{dir:t,count:n}})).filter((function(e){return e.count>0})).map((function(e){return e.dir})).map(un);return this.state.genome.withMutations(t,Math.random()>.9).geneData}},{key:"age",get:function(){return this.state.instance.fabric.age}},{key:"distanceFromTarget",get:function(){return this.state.midpoint.distanceTo(this.target)}},{key:"iterate",value:function(){var e=this,t=this.state.instance.view;this.state.midpoint.set(t.midpoint_x(),t.midpoint_y(),t.midpoint_z());var n=this.embryo;if(!n){if(this.state.instance.iterate(),this.twitcher){var a=this.twitchAge;if(a<=this.currentTwitchAge)return!0;this.currentTwitchAge=a;this.state.autopilot&&this.twitcher.tick((function(t,n,r,a){var i=function(t){t&&e.state.instance.fabric.twitch_interval(t.index,n,r,a)};i(t.alphaInterval),i(t.omegaInterval)}))&&(this.reachedTarget?this.direction=Yt.Rest:this.checkDirection())}return!0}if(n.iterate())return!0;switch(n.stage$.getValue()){case d.Stage.Shaping:return this.shapingTime<=0?n.stage=d.Stage.Slack:this.shapingTime--,!1;case d.Stage.Slack:return this.topFace=function(e){var t=e.faces.sort((function(t,n){var r=t.joint,a=n.joint;if(!r||!a)throw new Error("faces without joints");var i=e.instance.jointLocation(r),o=e.instance.jointLocation(a);return i.y-o.y})),n=t.pop();if(t.forEach((function(t){return e.faceToTriangle(t)})),!n)throw new Error("no top face");return n}(n),n.stage=d.Stage.Pretensing,!1;case d.Stage.Pretensing:return n.stage=d.Stage.Pretenst,!1;case d.Stage.Pretenst:return this.state.loopMuscles=function(e){var t=[];return e.withPulls((function(){e.loops.forEach((function(e){return t.push(e.map((function(e){var t=e.alpha.pulls,n=e.omega.pulls;if(!t||!n)throw new Error("missing pulls");var a=function(e){var t=e.intervalRole;return t===r.PullAA||t===r.PullBB},i=t.find(a),o=n.find(a);if(!i&&!o)throw new Error("cannot find any intervals");return{interval:e,alphaInterval:i,omegaInterval:o}})))}))})),t}(n),this.state.instance.refreshFloatView(),ln(this.state.instance,this.toA,this.toB,this.toC,this.topFace),this.checkDirection(),this.twitcher=new kn(this.state),this.embryo=void 0,!0;default:return!1}}},{key:"showFrozen",value:function(){this.state.instance.showFrozen(this.reachedTarget)}},{key:"topFaceLocation",get:function(){var e=this.topFace;if(e){var t=e.joint;if(t)return this.state.instance.jointLocation(t)}}},{key:"target",get:function(){return this.state.targetPatch.center}},{key:"showDirection",get:function(){return this.state.direction!==Yt.Rest}},{key:"directionQuaternion",get:function(){return this.quaternionForDirection(this.state.direction)}},{key:"reachedTarget",get:function(){return this.distanceFromTarget<4}},{key:"checkDirection",value:function(){var e=this.state;if(this.reachedTarget)this.direction=Yt.Rest;else{if(e.direction=this.directionToTarget,e.direction===Yt.Rest)return void console.error("direction is REST??");e.directionHistory.push(e.direction),e.directionHistory.length>20&&e.directionHistory.shift()}}},{key:"twitchAge",get:function(){return this.state.instance.fabric.age/600}},{key:"quaternionForDirection",value:function(e){var t=this;return(new f.Quaternion).setFromUnitVectors(m,function(){switch(e){case Yt.Rest:case Yt.ToA:return t.toA;case Yt.ToB:return t.toB;case Yt.ToC:return t.toC}}())}},{key:"directionToTarget",get:function(){var e=this.toTarget;ln(this.state.instance,this.toA,this.toB,this.toC,this.topFace);var t=e.dot(this.toA),n=e.dot(this.toB),r=e.dot(this.toC);return t>n&&t>r?Yt.ToA:n>t&&n>r?Yt.ToB:r>t&&r>n?Yt.ToC:Yt.Rest}},{key:"toTarget",get:function(){var e=new f.Vector3;return e.subVectors(this.target,this.state.midpoint),e.y=0,e.normalize(),e}}]),e}();function Cn(e){var t=e.snapshots,n=Object(u.useSetRecoilState)(on);return c.createElement("div",{className:"text-monospace d-inline-flex",onClick:function(){return n(!1)}},t.map((function(e){return c.createElement("div",{key:e.cycleIndex,className:"float-left p-1 m-1",style:{borderStyle:"solid",borderWidth:"2px"}},c.createElement(An,{snapshot:e}),c.createElement("div",{className:"m-2"},e.evolverSnapshots.map((function(e,t){for(var n=e.name,r=e.reachedTarget,a=e.persisted,i=e.proximity,o=e.tosses,s=[],u=n.length-1;u>0;)s.push(c.createElement(z.k,{key:"".concat(n,"-").concat(u)})),u--;var l=r?c.createElement(z.F,null):void 0;return c.createElement("div",{key:"competitor-".concat(t),style:{color:a?r?"#ffffff":"#2cd710":"#c2c2c2",backgroundColor:a?r?"#b1b1b1":"#848383":"#555454",borderRadius:"0.2em",marginBottom:"1px",padding:"2px",display:"block",whiteSpace:"nowrap"}},"".concat(bn(t)," ").concat(i.toFixed(3)," ").concat(n).concat(o),"\xa0",s,l)}))))})))}function An(e){var t=e.snapshot,n=t.cyclePattern,r=t.cycleIndex,a=t.cycle,i=Object(u.useSetRecoilState)(on);return c.createElement("div",{className:"p-1 my-2 w-100 text-center",onClick:function(){return i(!1)}},n.map((function(e,t){return c.createElement("span",{key:"cycle-".concat(t),style:{color:"black",backgroundColor:t===r?"#24f00f":"#cbc7c7",margin:"0.1em",padding:"0.2em",borderRadius:"0.3em",borderStyle:"solid",borderWidth:"1px"}},t===r&&a<n[r]?"".concat(a+1,"/").concat(e):e)})))}function Pn(e){var t=e.createBodyInstance,n=Object(u.useRecoilState)(nn),r=Object(N.a)(n,1)[0],a=Object(u.useRecoilValue)(rn),i=Object(u.useRecoilValue)(an),o=Object(u.useRecoilState)(on),s=Object(N.a)(o,2),l=s[0],h=s[1],m=Object(c.useState)((function(){return $(a)})),p=Object(N.a)(m,2),v=p[0],g=p[1],b=Object(c.useState)(Sn.Developing),y=Object(N.a)(b,2),w=y[0],S=y[1],j=Object(c.useState)([]),O=Object(N.a)(j,2),x=O[0],A=O[1],P=Object(c.useState)(-1),F=Object(N.a)(P,2),V=F[0],R=F[1],D=Object(c.useState)(void 0),L=Object(N.a)(D,2),B=L[0],T=L[1],M=Object(c.useState)(hn.SurvivorsAdvance),_=Object(N.a)(M,2),G=_[0],W=_[1],H=Object(c.useState)(void 0),J=Object(N.a)(H,2),U=J[0],q=J[1];function $(e){var n=e.adjacent[0];if(!n)throw new Error("No adjacent");var r=e.storedGenes[0],a=r?$t(r):qt(),i=t(tn.featureValues);i.world.set_surface_character(d.SurfaceCharacter.Sticky);var o={patch:e,targetPatch:n,instance:i,midpoint:(new f.Vector3).copy(e.center),genome:a,loopMuscles:[],direction:Yt.ToA,directionHistory:[],autopilot:!1,timeSlice:10,twitchesPerCycle:10},c=le(tn,(function(e){throw new Error("unable to compile runner: "+e)}));if(!c)throw new Error("no tree");var s=new Pe(e.center,i,1e3,tn,c);return new xn(o,s)}Object(c.useEffect)((function(){if(v){var e=v.state.patch.adjacent[i];e&&(v.state.targetPatch=e)}}),[i]),Object(c.useEffect)((function(){if(v&&v.embryo){var e=v.embryo.stage$.subscribe((function(e){e===d.Stage.Pretenst&&S(Sn.Resting),q(e)}));return function(){return e.unsubscribe()}}q(void 0)}),[v]),Object(c.useEffect)((function(){if(B){var e=B.snapshotsSubject.subscribe(A);return function(){return e.unsubscribe()}}}),[B]);var Q=function(e,n){T(B?B.withReducedCyclePattern:new pn(e,t,!1,n)),S(Sn.Evolving)},X=Object(u.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return c.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},c.createElement(I.a,{key:r.name,style:{backgroundColor:"black"}},c.createElement(Rn,null),c.createElement(X,null,c.createElement(En,{island:r,happening:w,runner:v,population:B,evolutionPhase:function(e){e!==G&&W(e)},countdownToEvo:function(e){R(e),v&&0===e&&Q(v,fn)},stopEvo:function(e){T(e),e||(g($(a)),S(Sn.Developing))}}))),v?w===Sn.Developing?U?c.createElement("div",{id:"bottom-middle"},c.createElement("div",{className:"py-2 px-3 text-center"},c.createElement(z.c,null)," ",k(U))):c.createElement("h1",null,"nothing"):c.createElement(Fn,{runner:v,happening:w,evoCountdown:V,toRunning:function(){S(Sn.Running),v.autopilot=!0},toEvolving:function(){S(Sn.Evolving),R(-1),Q(v,fn)},toRebirth:function(){g($(a)),S(Sn.Developing)},toRest:function(){S(Sn.Resting),v.direction=Yt.Rest}}):c.createElement("h1",null,"no runner"),B?c.createElement(c.Fragment,null,c.createElement("div",{id:"top-middle"},l?void 0:c.createElement(qe.a,{color:"info",onClick:function(){return h(!0)}},"Phase: ",G,c.createElement("br",null),0===x.length?void 0:c.createElement(An,{snapshot:x[x.length-1]}))),l?c.createElement(Vn,{happening:w,snapshots:x}):void 0):void 0,c.createElement("div",{id:"bottom-right"},c.createElement($e.a,{vertical:!1,className:"w-100"},c.createElement(qe.a,{onClick:function(){return C(E.Design)}},c.createElement(z.A,null)))))}function Fn(e){var t=e.runner,n=e.happening,r=e.evoCountdown,a=e.toRunning,i=e.toRest,o=e.toEvolving,s=e.toRebirth,u=function(){switch(n){case Sn.Developing:return c.createElement("h1",null,"developing");case Sn.Resting:return t?c.createElement($e.a,{className:"w-100"},c.createElement(qe.a,{color:"success",onClick:a},c.createElement(z.y,null)),c.createElement(qe.a,{color:"success",onClick:o},c.createElement(z.k,null)," ",r>=0?r:""),c.createElement(qe.a,{color:"success",onClick:s},c.createElement(z.c,null))):void 0;case Sn.Running:return t?c.createElement($e.a,{className:"w-100"},c.createElement(qe.a,{color:"success",onClick:i},c.createElement(z.F,null)," Rest")):void 0;case Sn.Evolving:return t?c.createElement($e.a,{className:"w-100"},c.createElement(qe.a,{color:"success",onClick:s},c.createElement(z.c,null))):void 0}}();return u?c.createElement("div",{id:"bottom-middle"},u):c.createElement("h1",null,n)}function Vn(e){var t=e.happening,n=e.snapshots;switch(t){case Sn.Developing:case Sn.Running:case Sn.Resting:return c.createElement("div",null);case Sn.Evolving:return c.createElement("div",{id:"evolution-stats"},n.length>0?c.createElement(Cn,{snapshots:n}):c.createElement("h2",{className:"p-2"},"First round, please wait"))}}function Rn(e){var t=Object(c.useRef)(),n=Object(I.c)().setDefaultCamera;return Object(c.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(-4,5,10),n(e)}),[]),Object(I.b)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),c.createElement("perspectiveCamera",Object.assign({ref:t},e))}!function(e){e[e.Developing=0]="Developing",e[e.Resting=1]="Resting",e[e.Running=2]="Running",e[e.Evolving=3]="Evolving"}(Sn||(Sn={}));function Dn(e){var t=new f.Color(e);return new f.MeshLambertMaterial({color:t})}var Ln=Dn("#011884"),Bn=Dn("#a80000"),Tn=[1,2,3,4,5],Mn=Object(u.atom)({key:"show push",default:!0}),_n=Object(u.atom)({key:"show pull",default:!0}),Nn=Object(u.atom)({key:"frozen",default:!1}),zn=Object(u.atom)({key:"useGravity",default:!0});function In(e){var t=e.createSphere,n=Object(u.useRecoilState)(Nn),r=Object(N.a)(n,2),a=r[0],i=r[1],o=Object(u.useRecoilState)(Mn),s=Object(N.a)(o,2),l=s[0],h=s[1],f=Object(u.useRecoilState)(_n),d=Object(N.a)(f,2),m=d[0],p=d[1],v=Object(u.useRecoilState)(zn),g=Object(N.a)(v,2),b=g[0],y=g[1],w=Object(c.useState)(1),S=Object(N.a)(w,2),j=S[0],k=S[1],O=Object(c.useState)((function(){return t(Tn[j],b)})),x=Object(N.a)(O,2),A=x[0],P=x[1];Object(c.useEffect)((function(){i(!1),P(t(Tn[j],b))}),[b]),Object(c.useEffect)((function(){l||m||(h(!0),p(!0))}),[l,m]);var F=Object(u.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return c.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},c.createElement("div",{id:"bottom-right"},c.createElement($e.a,null,c.createElement(qe.a,{onClick:function(){return nt(A.fabricOutput)}},c.createElement(z.l,null)),c.createElement(qe.a,{onClick:function(){return C(E.Design)}},c.createElement(z.A,null)))),c.createElement("div",{id:"top-left"},c.createElement($e.a,null,Tn.map((function(e,n){return c.createElement(qe.a,{key:"Freq".concat(e),onClick:function(){return e=n,i(!1),k(e),void P(t(Tn[e],b));var e},color:n===j?"success":"secondary"},e)})))),c.createElement("div",{id:"top-right"},c.createElement($e.a,null,c.createElement(qe.a,{color:b?"success":"secondary",onClick:function(){return y(!0)}},"Gravity"),c.createElement(qe.a,{color:b?"secondary":"success",onClick:function(){return y(!1)}},"Space"))),c.createElement("div",{id:"bottom-left"},c.createElement($e.a,null,c.createElement(qe.a,{color:a?"success":"secondary",onClick:function(){return i(!a)}},c.createElement(z.C,null)),c.createElement(qe.a,{color:l?"success":"secondary",disabled:!a,onClick:function(){return h(!l)}},"C"),c.createElement(qe.a,{color:m?"success":"secondary",disabled:!a,onClick:function(){return p(!m)}},"T"))),c.createElement(I.a,{style:{backgroundColor:"black"}},c.createElement(Jn,null),c.createElement(F,null,A?c.createElement(Gn,{sphere:A}):c.createElement("h1",null,"No Sphere"))))}function Gn(e){var t=e.sphere,n=Object(c.useState)(new f.Vector3),r=Object(N.a)(n,2),a=r[0],i=r[1],o=Object(u.useRecoilState)(Nn),s=Object(N.a)(o,2),l=s[0],h=s[1];return Object(I.b)((function(){if(!l){t.iterate((function(){return setTimeout((function(){return h(!0)}),0)}));var e=(new f.Vector3).subVectors(t.instance.midpoint,a).multiplyScalar(.1);i((new f.Vector3).copy(a).add(e))}})),c.createElement("group",null,c.createElement(at.a,{onPointerMissed:void 0,target:a}),c.createElement("scene",null,l?c.createElement(Hn,{sphere:t}):c.createElement("lineSegments",{key:"lines",geometry:t.instance.floatView.lineGeometry,material:ht,onUpdate:function(e){return e.geometry.computeBoundingSphere()}}),c.createElement(gt,null),c.createElement(it.a,null),c.createElement("ambientLight",{color:new f.Color("white"),intensity:.8}),c.createElement("directionalLight",{color:new f.Color("#FFFFFF"),intensity:2})))}var Wn=new f.CylinderGeometry(1,1,1,12,1,!1);function Hn(e){var t=e.sphere,n=Object(u.useRecoilState)(Mn),r=Object(N.a)(n,1)[0],a=Object(u.useRecoilState)(_n),i=Object(N.a)(a,1)[0],o=t.instance;return c.createElement("group",null,i?t.pulls.map((function(e){var t=Y(o.unitVector(e.index)),n=o.jointDistance(e.alpha,e.omega),r=new f.Vector3(.03,n,.03);return c.createElement("mesh",{key:"T".concat(e.index),geometry:Wn,position:e.location(),rotation:(new f.Euler).setFromQuaternion(t),scale:r,material:Bn,matrixWorldNeedsUpdate:!0})})):void 0,"}",r?t.pushes.map((function(e){var t=Y(o.unitVector(e.index)),n=o.jointDistance(e.alpha,e.omega),r=new f.Vector3(.06,n,.06);return c.createElement("mesh",{key:"C".concat(e.index),geometry:Wn,position:e.location(),rotation:(new f.Euler).setFromQuaternion(t),scale:r,material:Ln,matrixWorldNeedsUpdate:!0})})):void 0,"}")}function Jn(e){var t=Object(c.useRef)(),n=Object(I.c)().setDefaultCamera;return Object(c.useEffect)((function(){var e=t.current;if(!e)throw new Error("No camera");e.fov=50,e.position.set(0,15,39),n(e)}),[]),Object(I.b)((function(){var e=t.current;if(!e)throw new Error("No camera");e.updateMatrixWorld()})),c.createElement("perspectiveCamera",Object.assign({ref:t},e))}var Un=function(){function e(t){Object(l.a)(this,e),this.sphere=t}return Object(h.a)(e,[{key:"build",value:function(){var e=this;switch($n.forEach((function(t){return e.sphere.hubAt(new f.Vector3(t[0],t[1],t[2]))})),this.edgeVertexCount){case 0:this.build30Edges();break;case 1:var t=this.build60Edges();this.buildSmallFaces(t);break;default:var n=this.buildEdges();this.buildFaces(n)}var r=this.sphere.instance;r.refreshFloatView();var a=this.sphere.pushes,i=a.reduce((function(e,t){return e+r.jointDistance(t.alpha,t.omega)}),0)/a.length,o=this.sphere.segmentSize*i;return this.sphere.hubs.forEach((function(t){return t.spokes.forEach((function(n){return e.sphere.pullsForSpoke(t,n,o)}))})),this.sphere.fabric.set_altitude(this.sphere.location.y),this.sphere}},{key:"push",value:function(e,t,n){if(n){var r=(new f.Vector3).copy(e.location).lerp(t.location,.5),a=this.sphere.hubAt(r);return this.sphere.pushBetween(e,a),this.sphere.pushBetween(a,t),{hubA:e,hubB:t,hubMid:a}}return this.sphere.pushBetween(e,t),{hubA:e,hubB:t}}},{key:"build60Edges",value:function(){var e=this,t=[];return Qn.forEach((function(n){var r=e.push(e.vertices[n[0]],e.vertices[n[1]],!0).hubMid;r&&t.push(r)})),t}},{key:"build30Edges",value:function(){var e=this;Qn.forEach((function(t){return e.push(e.vertices[t[0]],e.vertices[t[1]])}))}},{key:"buildEdges",value:function(){var e=this,t=[];return Qn.forEach((function(n){var r,a,i=[];t.push(i);for(var o=0;o<e.edgeVertexCount;o++){a=r;var c=e.vertices[n[0]],s=e.vertices[n[1]],u=c.location,l=s.location,h=(new f.Vector3).lerpVectors(u,l,(o+1)/e.sphere.frequency);r=e.sphere.hubAt(h),i.push(r),a?(e.push(r,a),o===e.edgeVertexCount-1&&e.push(r,s)):e.push(r,c)}})),Zn.forEach((function(n){for(var r=0;r<n.length;r++){var a=(r+1)%n.length,i=1===n[r][1]?0:e.edgeVertexCount-1,o=1===n[a][1]?0:e.edgeVertexCount-1,c=t[n[r][0]][i],s=t[n[a][0]][o];e.push(c,s)}})),t}},{key:"buildSmallFaces",value:function(e){var t=this;Kn.forEach((function(n){var r=e[Math.abs(n[0])],a=e[Math.abs(n[1])],i=e[Math.abs(n[2])];t.push(r,a),t.push(a,i),t.push(i,r)}))}},{key:"buildFaces",value:function(e){for(var t=[],n=0;n<this.edgeVertexCount-1;n++)t.push([]);for(var r=new f.Vector3,a=new f.Vector3,i=0;i<Xn.length;i++){for(var o=this.vertices[Xn[i][0]].location,c=1;c<this.edgeVertexCount;c++){var s=this.vertices[Xn[i][1]];r.lerpVectors(o,s.location,c/this.sphere.frequency),r.sub(o),t[c-1]=[];for(var u=1;u<this.edgeVertexCount-c+1;u++){var l=this.vertices[Xn[i][2]];a.lerpVectors(o,l.location,u/this.sphere.frequency),a.sub(o);var h=(new f.Vector3).copy(o);h.add(r),h.add(a),t[c-1].push(this.sphere.hubAt(h))}}for(var d=0;d<t.length;d++)for(var m=0;m<t[d].length;m++)if(m<t[d].length-1&&this.push(t[d][m],t[d][m+1]),d>0){var p=t[d][m];this.push(p,t[d-1][m]),this.push(p,t[d-1][m+1])}for(var v=[],g=[],b=[],y=0;y<this.edgeVertexCount-1;y++){var w=t.length-y-1;v.push(t[Kn[i][0]>=0?y:w][0]);var E=t[Kn[i][1]<0?y:w];g.push(E[E.length-1]),b.push(t[0][Kn[i][2]<0?y:w])}var S=[];S.push(v),S.push(g),S.push(b);for(var j=0;j<S.length;j++)for(var k=e[Math.abs(Kn[i][j])],O=0;O<t.length;O++){var x=S[j][O];this.push(x,k[O]),this.push(x,k[O+1])}}}},{key:"vertices",get:function(){return this.sphere.hubs}},{key:"edgeVertexCount",get:function(){return this.sphere.frequency-1}}]),e}(),qn=.5257311121191336,$n=[[+qn,0,.85065080835204],[+qn,0,-.85065080835204],[.85065080835204,+qn,0],[-.85065080835204,+qn,0],[0,.85065080835204,+qn],[0,-.85065080835204,+qn],[-qn,0,-.85065080835204],[-qn,0,.85065080835204],[-.85065080835204,-qn,0],[.85065080835204,-qn,0],[0,-.85065080835204,-qn],[0,.85065080835204,-qn]],Qn=[[0,2],[0,4],[0,5],[0,7],[0,9],[1,10],[1,11],[1,2],[1,6],[1,9],[2,11],[2,4],[2,9],[3,11],[3,4],[3,6],[3,7],[3,8],[4,11],[4,7],[5,10],[5,7],[5,8],[5,9],[6,10],[6,11],[6,8],[7,8],[8,10],[9,10]],Xn=[[0,2,4],[0,2,9],[0,4,7],[0,5,7],[0,5,9],[1,2,11],[1,2,9],[1,6,10],[1,6,11],[1,9,10],[2,4,11],[3,4,11],[3,4,7],[3,6,11],[3,6,8],[3,7,8],[5,7,8],[5,8,10],[5,9,10],[6,8,10]],Kn=[[0,11,-1],[0,12,-4],[1,19,-3],[2,21,-3],[2,23,-4],[7,10,-6],[7,12,-9],[8,24,-5],[8,25,-6],[9,29,-5],[11,18,-10],[14,18,-13],[14,19,-16],[15,25,-13],[15,26,-17],[16,27,-17],[21,27,-22],[22,28,-20],[23,29,-20],[26,28,-24]],Zn=[[[0,1],[1,1],[3,1],[2,1],[4,1]],[[7,1],[6,1],[8,1],[5,1],[9,1]],[[10,1],[11,1],[0,-1],[12,1],[7,-1]],[[14,1],[13,1],[15,1],[17,1],[16,1]],[[18,1],[11,-1],[1,-1],[19,1],[14,-1]],[[21,1],[22,1],[20,1],[23,1],[2,-1]],[[26,1],[24,1],[8,-1],[25,1],[15,-1]],[[27,1],[16,-1],[19,-1],[3,-1],[21,-1]],[[28,1],[22,-1],[27,-1],[17,-1],[26,-1]],[[4,-1],[23,-1],[29,1],[9,-1],[12,-1]],[[28,-1],[20,-1],[29,-1],[5,-1],[24,-1]],[[6,-1],[10,-1],[18,-1],[13,-1],[25,-1]]];function Yn(e){var t=e.push;return e.reverse?t.omega:t.alpha}function er(e){var t=e.push;return e.reverse?t.alphaHub:t.omegaHub}var tr=function(){function e(t,n,r,a,i,o){Object(l.a)(this,e),this.location=t,this.radius=n,this.frequency=r,this.segmentSize=a,this.useGravity=i,this.instance=o,this.joints=[],this.pushes=[],this.pulls=[],this.hubs=[],this.instance.clear()}return Object(h.a)(e,[{key:"fabric",get:function(){return this.instance.fabric}},{key:"hubAt",value:function(e){e.normalize().multiplyScalar(this.radius);var t={index:this.hubs.length,location:e,spokes:[]};return this.hubs.push(t),t}},{key:"pushBetween",value:function(e,t){var n=this.instance,r=(new f.Vector3).addVectors(e.location,t.location).normalize(),a=(new f.Quaternion).setFromAxisAngle(r,.52),i=(new f.Vector3).copy(e.location).applyQuaternion(a),o=(new f.Vector3).copy(t.location).applyQuaternion(a),c=e.location.distanceTo(t.location),s=c,u=this.createJoint(i),l=this.createJoint(o),h={index:this.fabric.create_interval(u.index,l.index,!0,c,s,1,0),alpha:u,omega:l,alphaHub:e,omegaHub:t,idealLength:s,location:function(){return(new f.Vector3).addVectors(n.jointLocation(u),n.jointLocation(l)).multiplyScalar(.5)}};return this.pushes.push(h),e.spokes.push({reverse:!1,push:h}),t.spokes.push({reverse:!0,push:h}),h}},{key:"pullsForSpoke",value:function(e,t,n){var r=this,a=[],i=this.instance,o=function(e,t,n,o){if(!r.pullExists(e,t)){var c=i.jointDistance(e,t),s={index:r.fabric.create_interval(e.index,t.index,!1,c,n,1,1e-4),alpha:e,omega:t,segment:o,idealLength:n,location:function(){return(new f.Vector3).addVectors(i.jointLocation(e),i.jointLocation(t)).multiplyScalar(.5)}};a.push(s),r.pulls.push(s)}},c=Yn(this.nextSpoke(e,t,!1)),s=this.nextSpoke(er(t),t,!1);return o(Yn(t),c,n,!0),o(c,Yn(s),function(e){var t=e.push;return t.omegaHub.location.distanceTo(t.alphaHub.location)}(t)-2*n,!1),a}},{key:"iterate",value:function(e){if(this.instance.iterate())return!0;switch(this.instance.stage){case d.Stage.Growing:new Un(this).build(),this.instance.stage=d.Stage.Shaping;break;case d.Stage.Shaping:25e3===this.instance.fabric.age&&(this.useGravity?this.instance.stage=d.Stage.Slack:e());break;case d.Stage.Slack:this.instance.stage=d.Stage.Pretensing;break;case d.Stage.Pretensing:this.instance.stage=d.Stage.Pretenst;break;case d.Stage.Pretenst:this.instance.fabric.age>1e5&&e()}return!1}},{key:"fabricOutput",get:function(){var e=this;this.instance.refreshFloatView();var t=this.instance.floatView.idealLengths,n=this.instance.floatView.strains,a=this.instance.floatView.stiffnesses,i=this.instance.floatView.linearDensities;return{name:"sphere",joints:this.joints.map((function(t){var n=e.instance.jointLocation(t);return{index:t.index,x:n.x,y:n.z,z:n.y}})),intervals:[].concat(Object(G.a)(this.pushes.map((function(o){var c=.012/e.frequency,s=e.instance.jointDistance(o.alpha,o.omega),u=o.alpha.index,l=o.omega.index;if(u>=e.joints.length||l>=e.joints.length)throw new Error("Joint not found ".concat(u,",").concat(l,":").concat(e.joints.length));return{index:o.index,joints:[u,l],type:"Push",strain:n[o.index],stiffness:a[o.index],linearDensity:i[o.index],role:w(r.PushA),scale:1,idealLength:t[o.index],isPush:!0,length:s,radius:c}}))),Object(G.a)(this.pulls.map((function(o){var c=.005/e.frequency,s=e.instance.jointDistance(o.alpha,o.omega),u=o.alpha.index,l=o.omega.index;if(u>=e.joints.length||l>=e.joints.length)throw new Error("Joint not found ".concat(u,",").concat(l,":").concat(e.joints.length));return{index:o.index,joints:[u,l],type:"Pull",strain:n[o.index],stiffness:a[o.index],linearDensity:i[o.index],role:w(r.PushA),scale:1,idealLength:t[o.index],isPush:!1,length:s,radius:c}}))))}}},{key:"createJoint",value:function(e){var t={index:this.fabric.create_joint(e.x,e.y,e.z)};return this.joints.push(t),this.instance.refreshFloatView(),t}},{key:"nextSpoke",value:function(e,t,n){var r=t.push,a=e.spokes.find((function(e){return e.push.index===r.index}));if(!a)throw new Error("Cannot find current spoke when looking for next");var i=er(a).location,o=P(i,e.location),c=(new f.Vector3).crossVectors(e.location,o).normalize();!1!==n&&c.multiplyScalar(-1);var s=e.spokes.filter((function(e){return e.push.index!==a.push.index}));if(e.spokes.length!==s.length+1)throw new Error("Did not delete");var u=s.filter((function(t){return P(er(t).location,e.location).dot(c)>0})).sort((function(e,t){var n=er(e).location.distanceToSquared(i);return er(t).location.distanceToSquared(i)-n})).pop();if(!u)throw new Error("Couldn't find closest!");return u}},{key:"pullExists",value:function(e,t){return!!this.pulls.find((function(n){return n.alpha.index===e.index&&n.omega.index===t.index||n.alpha.index===t.index&&n.omega.index===e.index}))}}]),e}(),nr=n(135),rr=n(136),ar=n(137),ir=n(128),or=n(121),cr=[0,1e5];function sr(e){var t=e.mapping,n=e.percentAtom,r=e.apply,a=t.name,i=t.nuanceToPercent,o=t.percentToNuance,s=t.percentToValue,l=function(e){return[Math.floor(1e5*o(e))]},h=Object(u.useRecoilState)(n),f=Object(N.a)(h,2),d=f[0],m=f[1],p=Object(c.useState)(l(d)),v=Object(N.a)(p,2),g=v[0],b=v[1];return Object(c.useEffect)((function(){m(Math.round(i(g[0]/1e5)))}),[g]),Object(c.useEffect)((function(){return r(t.feature,d,s(d))}),[d]),Object(c.useEffect)((function(){b(l(d))}),[t,d]),c.createElement("div",{className:"slider"},c.createElement("div",{className:"float-right mr-4"},c.createElement(z.d,{onClick:function(){return b(l(100))}})),c.createElement("div",{className:"ml-2 small my-1"},a," = ",function(e){return e<=100?"".concat(e.toFixed(0),"%"):"".concat((e/100).toFixed(1),"x")}(d)," (",A(s(d)),")"),c.createElement(or.c,{mode:1,step:1,domain:cr,rootStyle:hr,values:g,onChange:function(e){return b(e)}},c.createElement(or.b,null,(function(e){var t=e.getRailProps;return c.createElement("div",Object.assign({className:"slider-rail"},t()))})),c.createElement(or.a,null,(function(e){var t=e.handles,n=e.getHandleProps;return c.createElement("div",{className:"slider-handles"},t.map((function(e,t){return c.createElement(ur,{key:e.id,handle:e,getHandleProps:n})})))})),c.createElement(or.d,{right:!1},(function(e){var t=e.tracks,n=e.getTrackProps;return c.createElement("div",{className:"slider-tracks"},t.map((function(e,t){var r=e.id,a=e.source,i=e.target;return c.createElement(lr,{key:r,source:a,target:i,getTrackProps:n})})))}))))}function ur(e){var t=e.handle,n=e.getHandleProps,r=cr[0],a=cr[1],i=t.id,o=t.value,s=t.percent;return c.createElement("div",Object.assign({role:"slider",className:"slider-handle",style:{left:"".concat(s,"%")},"aria-valuemin":r,"aria-valuemax":a,"aria-valuenow":o},n(i)))}function lr(e){var t=e.source,n=e.target,r=e.getTrackProps;return c.createElement("div",Object.assign({className:"slider-track",style:{left:"".concat(t.percent,"%"),width:"".concat(n.percent-t.percent,"%")}},r()))}var hr={margin:"1%",position:"relative",width:"98%"};function fr(e){var t=e.tensegrity,n=Object(c.useState)(!1),r=Object(N.a)(n,2),a=r[0],i=r[1],o=Object(u.useRecoilState)(ze),s=Object(N.a)(o,2),l=s[0],h=s[1],f=Object(c.useState)(Ue[l]),d=Object(N.a)(f,2),m=d[0],p=d[1];return c.createElement("div",{className:"w-100 d-flex"},c.createElement(nr.a,{isOpen:a,toggle:function(){return i(!a)}},c.createElement(rr.a,null,"Choose"),c.createElement(ar.a,null,Ue.filter((function(e){return!e.mapping.name.startsWith("-")})).map((function(e){return c.createElement(ir.a,{key:"fitem-".concat(e.mapping.feature),onClick:function(){h(e.mapping.feature),p(e)}},e.mapping.name)})))),c.createElement(sr,{mapping:m.mapping,percentAtom:m.percentAtom,apply:function(e,n,r){t.instance.applyFeature(e,n,r)}}))}var dr=n(129),mr=new f.CylinderGeometry(1,1,1,12,1,!1),pr=new f.Color("#ffffff");function vr(e){var t=e.tensegrity,n=e.runTenscript,r=e.selected,a=e.setSelected,i=e.details,o=e.selectDetails,s=Object(u.useRecoilState)(Je),l=Object(N.a)(s,1)[0],h=Object(u.useRecoilState)(Ue[d.WorldFeature.VisualStrain].percentAtom),m=Object(N.a)(h,1)[0],p=Object(u.useRecoilState)(We),v=Object(N.a)(p,1)[0],g=Object(u.useRecoilState)(_e),b=Object(N.a)(g,2),y=b[0],w=b[1],S=Object(u.useRecoilState)(He),j=Object(N.a)(S,2),k=j[0],O=j[1],x=Object(u.useRecoilState)(Ge),A=Object(N.a)(x,2),P=A[0],F=A[1],V=Object(c.useState)(0),R=Object(N.a)(V,2),D=R[0],L=R[1],B=Object(c.useState)(new f.Vector3(0,1,0)),T=Object(N.a)(B,2),M=T[0],_=T[1],z=Object(c.useState)(t.stage$.getValue()),G=Object(N.a)(z,2),W=G[0],H=G[1];Object(c.useEffect)((function(){w(0),L(0)}),[v]),Object(c.useEffect)((function(){var e=t.stage$.subscribe(H);return function(){return e.unsubscribe()}}),[t]),Object(c.useEffect)((function(){var e=U.current;e&&t&&e.position.set(0,5,5*t.instance.view.radius())}),[]);var J=function(e){return console.error("tensegrity view",e)};Object(I.b)((function(){var e=U.current;if(e&&t&&k===Ie.Lines){var a=t.iterate(),i=t.instance.view,o=r?t.instance.intervalLocation(r):new f.Vector3(i.midpoint_x(),i.midpoint_y(),i.midpoint_z());_((new f.Vector3).subVectors(o,M).multiplyScalar(.01).add(M));var c=e.position;if(v===E.Demo||W===d.Stage.Growing){c.y+=.01*(o.y-c.y);var s=c.distanceTo(o)-2.5*i.radius(),u=(new f.Vector3).subVectors(o,c).normalize().multiplyScalar(.01*s);c.add(u)}else c.y<0&&(c.y-=.01*c.y*20);if(a)return;if(v===E.Demo)switch(W){case d.Stage.Shaping:200===D?(t.stage=d.Stage.Slack,L(0)):L(D+1);break;case d.Stage.Slack:30===D?(t.stage=d.Stage.Pretensing,F(!1),L(0)):L(D+1);break;case d.Stage.Pretenst:if(200===D){var l=y+1;l===Re.length?(w(0),C(E.Design),F(!1),n(Re[0],J)):(w(l),F(!0),L(0),n(Re[l],J))}else L(D+1)}W===d.Stage.Pretensing&&(t.stage=d.Stage.Pretenst)}}));var U=Object(c.useRef)(),q=t.instance.world.get_float_value(d.WorldFeature.PushOverPull);return c.createElement("group",null,c.createElement(dr.a,{ref:U,makeDefault:!0,onPointerMissed:void 0}),c.createElement(at.a,{target:M,autoRotate:P,enableKeys:!1,enablePan:!1,enableDamping:!1,minPolarAngle:.1*Math.PI,maxPolarAngle:.8*Math.PI,onPointerMissed:void 0,zoomSpeed:.5}),c.createElement("scene",null,k===Ie.Selecting?c.createElement(Sr,{tensegrity:t,details:i,selectDetails:o,selected:r,setSelected:a}):k===Ie.Frozen?c.createElement("group",null,t.intervals.filter((function(e){return l.some((function(t){return t===e.intervalRole}))})).map((function(e){return c.createElement(gr,{key:"I".concat(e.index),pushOverPull:q,visualStrain:Ue[d.WorldFeature.VisualStrain].mapping.percentToValue(m),tensegrity:t,interval:e,selected:!1,onPointerDown:function(t){t.stopPropagation(),ot(t)&&function(e){r&&r.index===e.index?a(void 0):a(e),O(Ie.Selecting)}(e)}})})),"}"):c.createElement("lineSegments",{geometry:t.instance.floatView.lineGeometry,material:ht,onUpdate:function(e){return e.geometry.computeBoundingSphere()}}),c.createElement(gt,null),c.createElement(it.a,null),c.createElement("ambientLight",{color:pr,intensity:.8}),c.createElement("directionalLight",{color:new f.Color("#FFFFFF"),intensity:2})))}function gr(e){var t=e.pushOverPull,n=e.visualStrain,r=e.tensegrity,a=e.interval,i=e.selected,o=e.onPointerDown,s=i?yr:dt(a.intervalRole),u=j(a.intervalRole),l=r.instance,h=l.floatView.stiffnesses[a.index]*(u?t:1),d=.01*Math.sqrt(h)*(i?1.5:1),m=Y(l.unitVector(a.index)),p=l.floatView.strains[a.index],v=l.floatView.idealLengths[a.index],g=0===p?l.intervalLength(a):v+p*v*(1-n),b=new f.Vector3(d,g<0?.01:g,d);return c.createElement("mesh",{geometry:mr,position:l.intervalLocation(a),rotation:(new f.Euler).setFromQuaternion(m),scale:b,material:s,matrixWorldNeedsUpdate:!0,onPointerDown:o})}function br(e){var t=new f.Color(e);return new f.MeshLambertMaterial({color:t})}var yr=br("#ffdd00"),wr=br("#384780"),Er=br("#a80000");function Sr(e){var t=e.tensegrity,n=e.selected,r=e.setSelected,a=e.details,i=e.selectDetails,o=t.instance;return c.createElement("group",null,t.intervals.map((function(e){var t=j(e.intervalRole);if(!t){if(!n)return;if(j(n.intervalRole)){if(!ee(n,e))return}else if(n.index!==e.index)return;if(!ee(n,e))return}var a=Y(o.unitVector(e.index)),i=o.jointDistance(e.alpha,e.omega),s=(t?.032:.016)*(n&&n.index===e.index?2:1),u=new f.Vector3(s,i,s);return c.createElement("mesh",{key:"T".concat(e.index),geometry:mr,position:o.intervalLocation(e),rotation:(new f.Euler).setFromQuaternion(a),scale:u,material:t?wr:Er,matrixWorldNeedsUpdate:!0,onPointerDown:function(t){t.stopPropagation(),ot(t)&&function(e){n&&n.index===e.index?r(void 0):r(e)}(e)}})})),"}",a.map((function(e){return c.createElement(ut,{key:"deets-".concat(e.interval.index),instance:t.instance,details:e,selectDetails:i})})))}var jr,kr=n(130);function Or(e){var t=e.runTenscript,n=Object(u.useRecoilState)(Ne),r=Object(N.a)(n,2),a=r[0],i=r[1],o=Object(u.useRecoilState)(Me),s=Object(N.a)(o,1)[0],l=Object(c.useState)(""),h=Object(N.a)(l,2),f=h[0],d=h[1],m=Object(c.useState)(""),p=Object(N.a)(m,2),v=p[0],g=p[1],b=function(){return JSON.stringify(a,void 0,2)};return Object(c.useEffect)((function(){d(a?b():"")}),[a]),c.createElement("div",{id:"tenscript-panel",style:{flexDirection:"column",position:"relative",backgroundColor:"rgba(0,0,0,1)",height:"100%"}},c.createElement("div",null,c.createElement("h6",{className:"w-100 text-center"},c.createElement(z.z,null)," Tenscript"),c.createElement("div",{id:"code-and-run",style:{flexDirection:"column",height:"available"}},c.createElement(kr.a,{style:{borderRadius:"1em",height:"22em",marginBottom:"0.5em"},type:"textarea",id:"tenscript",value:f,onChange:function(e){return d(e.target.value)}}),c.createElement($e.a,{vertical:!0,className:"w-100 my-2"},0===v.length?void 0:c.createElement(qe.a,{className:"my-2",color:"warning",onClick:function(){d(b()),g("")}},c.createElement(z.e,null),c.createElement("hr",null),v),c.createElement(qe.a,{color:"success",onClick:function(){return function(){try{var e=JSON.parse(f);le(e,g)&&(g(""),e.postGrowthOp=s,i(e),t(e,g))}catch(n){g(n.toString())}}()}},"Try it out!")))))}!function(e){e[e.CaptureLengthsToSlack=0]="CaptureLengthsToSlack",e[e.SlackToPretensing=1]="SlackToPretensing",e[e.CapturePretenstToSlack=2]="CapturePretenstToSlack",e[e.CaptureStrainForStiffness=3]="CaptureStrainForStiffness"}(jr||(jr={}));var xr=Object.keys(jr).filter((function(e){return isNaN(parseInt(e,10))})).map((function(e){return jr[e]}));function Cr(e){var t=e.tensegrity,n=e.stageTransition,r=e.disabled,a=Object(c.useState)(t.stage),i=Object(N.a)(a,2),o=i[0],s=i[1];function u(e){return!(!r&&o!==d.Stage.Pretensing)||o!==e}function l(e){t.toDo={todo:e}}switch(Object(c.useEffect)((function(){var e=t.stage$.subscribe(s);return function(){return e.unsubscribe()}}),[t]),n){case jr.CaptureLengthsToSlack:return c.createElement(qe.a,{disabled:u(d.Stage.Shaping),onClick:function(){return l((function(e){return e.stage=d.Stage.Slack}))}},c.createElement(z.f,null),c.createElement(z.a,null),c.createElement(Ar,{stage:d.Stage.Slack}));case jr.SlackToPretensing:return c.createElement(qe.a,{disabled:u(d.Stage.Slack),onClick:function(){return l((function(e){return e.stage=d.Stage.Pretensing}))}},c.createElement(Ar,{stage:d.Stage.Slack}),c.createElement(z.a,null),c.createElement(Ar,{stage:d.Stage.Pretenst}));case jr.CapturePretenstToSlack:return c.createElement(qe.a,{disabled:u(d.Stage.Pretenst),onClick:function(){return l((function(e){return e.stage=d.Stage.Slack}))}},c.createElement(Ar,{stage:d.Stage.Pretenst}),c.createElement(z.a,null),c.createElement(Ar,{stage:d.Stage.Slack}));case jr.CaptureStrainForStiffness:return c.createElement(qe.a,{disabled:u(d.Stage.Pretenst),onClick:function(){return l((function(e){e.stage=d.Stage.Slack,e.strainToStiffness()}))}},c.createElement(Ar,{stage:d.Stage.Pretenst}),c.createElement(z.a,null),c.createElement(Ar,{stage:d.Stage.Slack}),c.createElement(z.g,null))}}function Ar(e){switch(e.stage){case d.Stage.Growing:return c.createElement(z.z,null);case d.Stage.Shaping:return c.createElement(z.B,null);case d.Stage.Slack:return c.createElement(z.F,null);case d.Stage.Pretensing:return c.createElement(z.i,null);case d.Stage.Pretenst:return c.createElement(z.r,null);default:throw new Error("Stage?")}}function Pr(e){var t=e.tensegrity,n=e.runTenscript,r=Object(u.useRecoilState)(He),a=Object(N.a)(r,1)[0],i=Object(u.useSetRecoilState)(_e),o=Object(u.useRecoilState)(Ne),s=Object(N.a)(o,2),l=s[0],h=s[1],f=Object(u.useRecoilState)(Me),d=Object(N.a)(f,2),m=d[0],p=d[1],v=Object(c.useState)(!1),g=Object(N.a)(v,2),b=g[0],y=g[1],w=Object(c.useState)(!1),E=Object(N.a)(w,2),S=E[0],j=E[1],k=function(e){if(l)if(p(e),l.postGrowthOp===e)n(l,(function(e){return console.error(e)}));else{var t=Object(jn.a)(Object(jn.a)({},l),{},{postGrowthOp:e});h(t),n(t,(function(e){return console.error(e)}))}},O=function(e){return m===e?"success":"secondary"};return c.createElement(c.Fragment,null,c.createElement($e.a,null,xr.map((function(e){return c.createElement(Cr,{key:"strans-".concat(e),tensegrity:t,stageTransition:e,disabled:a===Ie.Frozen})}))),c.createElement("br",null),c.createElement($e.a,{className:"my-1"},c.createElement(qe.a,{onClick:function(){return k(je.NoOp)},color:O(je.NoOp)},"0"),c.createElement(qe.a,{onClick:function(){return k(je.Faces)},color:O(je.Faces)},"\u25b5"),c.createElement(qe.a,{onClick:function(){return k(je.Snelson)},color:O(je.Snelson)},"S\u25b5"),c.createElement(qe.a,{onClick:function(){return k(je.Bowtie)},color:O(je.Bowtie)},"\u22c8"),c.createElement(qe.a,{onClick:function(){return k(je.BowtieFaces)},color:O(je.BowtieFaces)},"\u22c8 ",c.createElement("strong",null,"\u25b5"))),c.createElement("br",null),c.createElement($e.a,null,c.createElement(nr.a,{isOpen:S,toggle:function(){return j(!S)}},c.createElement(rr.a,null,c.createElement(z.s,null)),c.createElement(ar.a,null,Re.map((function(e,t){return c.createElement(ir.a,{key:"Boot".concat(t),onClick:function(){i(t),n(e,(function(){return console.error("impossible")}))}},e.name)})))),c.createElement(qe.a,{color:b?"warning":"secondary",onClick:function(){return y(!b)}},c.createElement(z.m,null))),b?c.createElement(Or,{runTenscript:n}):void 0)}function Fr(e){var t=e.tensegrity,n=Object(c.useState)(t.stage$.getValue()),r=Object(N.a)(n,2),a=r[0],i=r[1];return Object(c.useEffect)((function(){var e=t.stage$.subscribe(i);return function(){return e.unsubscribe()}}),[t]),c.createElement("div",null,c.createElement("span",null,k(a))," ",c.createElement("i",null,'"',t.name,'"'))}function Vr(e){var t=e.tensegrity,n=e.selected,a=Object(u.useRecoilState)(He),i=Object(N.a)(a,1)[0],o=Object(u.useRecoilState)(Je),s=Object(N.a)(o,2),l=s[0],h=s[1],f=Object(c.useState)(r.PullA),d=Object(N.a)(f,2),m=d[0],p=d[1],v=function(e){return function(){n&&t.changeIntervalScale(n,e?1.03:1/1.03)}};switch(i){case Ie.Lines:return c.createElement(c.Fragment,null,c.createElement($e.a,null,S.map((function(e,t){return c.createElement(qe.a,{key:"IntervalRole[".concat(t,"]"),onClick:function(){return p(e)},color:m===e?"success":"secondary"},w(e))}))),c.createElement(Rr,{tensegrity:t,intervalRole:m}));case Ie.Selecting:return c.createElement($e.a,null,c.createElement(qe.a,{onClick:v(!0)},c.createElement(z.x,null)),c.createElement(qe.a,{onClick:v(!1)},c.createElement(z.t,null)));case Ie.Frozen:return c.createElement($e.a,null,S.map((function(e){return c.createElement(qe.a,{key:"viz".concat(e),onClick:function(){if(l.indexOf(e)<0)h([].concat(Object(G.a)(l),[e]));else{var t=l.filter((function(t){return t!==e}));h(t.length>0?t:S)}},color:l.some((function(t){return t===e}))?"success":"secondary"},w(e),c.createElement(z.h,{style:{color:ft(e)}}))})));default:return c.createElement("span",null,"?")}}function Rr(e){var t=e.tensegrity,n=e.intervalRole,r=e.disabled;var a=function(e,r){return function(){t.intervals.filter((function(e){return e.intervalRole===n})).forEach((function(n){return t.changeIntervalScale(n,function(){var t=r?1.01:1.05;return e?t:1/t}())}))}};return c.createElement("div",{className:"text-right"},c.createElement($e.a,{className:"my-1"},c.createElement(qe.a,{disabled:r,onClick:a(!0,!1)},c.createElement(z.x,null),c.createElement(z.x,null)),c.createElement(qe.a,{disabled:r,onClick:a(!0,!0)},c.createElement(z.x,null)),c.createElement(qe.a,{disabled:r,onClick:a(!1,!0)},c.createElement(z.t,null)),c.createElement(qe.a,{disabled:r,onClick:a(!1,!1)},c.createElement(z.t,null),c.createElement(z.t,null))),c.createElement("br",null),c.createElement($e.a,null,c.createElement(qe.a,null,w(n)," = [",A(b(n)),"]")))}function Dr(e){var t=e.createInstance,n=Object(c.useMemo)((function(){return t({})}),[]),r=Ue.map((function(e){var t=e.percentAtom;return Object(u.useRecoilState)(t)})),a=Object(u.useRecoilState)(Ne),i=Object(N.a)(a,2),o=i[0],s=i[1],l=Object(u.useRecoilState)(_e),h=Object(N.a)(l,1)[0],m=Object(u.useSetRecoilState)(Me),p=Object(u.useRecoilState)(He),v=Object(N.a)(p,2),g=v[0],b=v[1],w=Object(u.useRecoilState)(We),S=Object(N.a)(w,1)[0],j=Object(c.useState)(),k=Object(N.a)(j,2),O=k[0],x=k[1],C=Object(c.useState)(),A=Object(N.a)(C,2),P=A[0],F=A[1],V=Object(c.useState)([]),R=Object(N.a)(V,2),D=R[0],L=R[1];Object(c.useEffect)((function(){O&&L(P?O.intervals.filter(Se(P)).map((function(e){return O.getIntervalDetails(e)})):[])}),[P]);var B=function(e){return console.error("tensegrity view",e)},T=function e(t,a){try{var i=le(t,a);if(!i)return!1;b(Ie.Lines),F(void 0);var o=t.featureValues,c=o?o[d.WorldFeature.IntervalCountdown]:void 0,u=void 0===c?Object(d.default_world_feature)(d.WorldFeature.IntervalCountdown):c;s(t),y.map((function(e){var t=d.WorldFeature[e],a=Be(t).percentToValue,i=o?o[e]:void 0;void 0!==i&&(r[t][1](i),n.applyFeature(t,i,a(i)))})),m(t.postGrowthOp),x(new Pe(new f.Vector3,n,u,t,i))}catch(l){return console.log("Problem running",l),e(Re[h],B)}return!0};Object(c.useEffect)((function(){Object.keys(localStorage).filter((function(e){return"pretenst-2021-07-29a"!==e})).forEach((function(e){return localStorage.removeItem(e)})),T(o||Re[h],B)}),[]);var M=Object(u.useRecoilBridgeAcrossReactRoots_UNSTABLE)();return c.createElement("div",null,c.createElement("div",{style:{position:"absolute",left:0,right:0,height:"100%"}},O?c.createElement("div",{className:"h-100"},c.createElement(I.a,{style:{backgroundColor:"black",borderStyle:"solid",borderColor:g!==Ie.Lines?"#f0ad4e":"black",cursor:g===Ie.Selecting?"pointer":"default",borderWidth:"2px"}},c.createElement(M,null,c.createElement(vr,{tensegrity:O,runTenscript:T,selected:P,setSelected:F,details:D,selectDetails:function(e){var t,n,r=e.interval;1===D.length&&P&&O?(t=P,L((n=O).intervals.filter(Se(t)).map((function(e){return n.getIntervalDetails(e)})))):L(D.filter((function(e){return e.interval.index===r.index}))),L(D.filter((function(e){return r.index===e.interval.index})))}}))),S===E.Demo?void 0:c.createElement(c.Fragment,null,c.createElement("div",{id:"top-left"},c.createElement(Pr,{tensegrity:O,runTenscript:T})),c.createElement("div",{id:"top-right"},c.createElement(Vr,{tensegrity:O,selected:P})),c.createElement("div",{id:"bottom-left"},c.createElement(Qe,null)),c.createElement("div",{id:"bottom-middle",style:{width:"60%"}},c.createElement(fr,{tensegrity:O}))),c.createElement("div",{id:"top-middle"},c.createElement(Fr,{tensegrity:O})),c.createElement("div",{id:"bottom-right"},c.createElement(rt,{tensegrity:O}))):c.createElement("div",{className:"h-100"},c.createElement("div",{style:{position:"relative",top:"50%",left:"50%"}},c.createElement("h1",null,c.createElement(z.w,null))))))}function Lr(e){var t=e.createInstance,n=Object(u.useRecoilState)(We),r=Object(N.a)(n,1)[0];switch(Object(c.useEffect)((function(){var e=x();e!==r&&C(e)}),[]),r){case E.Halo:case E.Convergence:case E.HeadlessHug:case E.Triped:return c.createElement(St,{globalMode:r,createInstance:t});case E.Evolution:return c.createElement(Pn,{createBodyInstance:t});case E.Sphere:return c.createElement(In,{createSphere:function(e,n){var r,a=t((r={},Object(_.a)(r,d.WorldFeature.IterationsPerFrame,200),Object(_.a)(r,d.WorldFeature.Gravity,1e3),Object(_.a)(r,d.WorldFeature.VisualStrain,0),Object(_.a)(r,d.WorldFeature.StiffnessFactor,800),r));return new tr(new f.Vector3(0,3,0),15,e,.3333,n,a)}});default:return c.createElement(Dr,{createInstance:t})}}function Br(e){var t=document.getElementById("root");s.render(e,t)}function Tr(e,t){return Mr.apply(this,arguments)}function Mr(){return(Mr=Object(o.a)(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:Br(c.createElement(u.RecoilRoot,null,c.createElement(Lr,{createInstance:function(e,r){return new D(t,2e3,n,r)}}))),B();case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}n.d(t,"startReact",(function(){return Tr}))}}]);
//# sourceMappingURL=5.4ba3f65c.chunk.js.map